<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¡Œç¨‹è¦åŠƒ</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>



/* 1. Header (æœ€ä¸Šå±¤) */
#header { 
    z-index: 100 !important; 
    height: 64px;
}

/* é¸å–æ‰€æœ‰ä»¥ -modal çµå°¾çš„ ID */
[id$="-modal"] {
    z-index: 9999 !important; /* ç¢ºä¿æ‰€æœ‰æ¨¡æ…‹æ¡†éƒ½åœ¨æœ€é ‚å±¤ */
}

/* ä¿®æ­£ï¼šå¦‚æœ Day Page æœ‰è¨­å®š fixed æˆ–é«˜å±¤ç´šï¼Œåœ¨æ­¤è™•å£“ä½ */
#day-content-itinerary, #magazine-view {
    position: relative;
    z-index: 10;
}

    /* 1. å°‡ @import è¦å‰‡ç§»åˆ°æœ€é ‚éƒ¨ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    /* 2. è®Šæ•¸è²æ˜å¿…é ˆåœ¨è¦å‰‡ä¹‹å‰ï¼Œä½†å¯ä»¥æ”¾åœ¨ @import ä¹‹å¾Œ */
    :root {
        --color-primary: #e91e63; /* ç«ç‘°ç²‰ (é è¨­) */
        
        /* è¼”åŠ©è®Šæ•¸ï¼šä¸»é¡Œè‰²æ··åˆè‰² (10% ä¸»è‰²) */
        --color-bg-light-mixed: rgba(233, 30, 99, 0.1); 
        --color-border-light-mixed: rgba(233, 30, 99, 0.4); 
        
        /* è©³ç´°å…§å®¹: ä½¿ç”¨ä¸»é¡Œè‰²ä½œç‚ºå·¦å´é‚Šæ¡†å’Œæ¥µæ·ºèƒŒæ™¯ */
        --color-note-border: var(--color-primary);
        --color-note-bg: rgba(233, 30, 99, 0.05); /* 5% ä¸»é¡Œè‰² */
        
        /* é›¨å¤©å‚™æ¡ˆ: ä½¿ç”¨è—è‰²ä½œç‚ºå·¦å´é‚Šæ¡†å’Œæ·ºè—èƒŒæ™¯ */
        --color-rain-bg: rgba(59, 130, 246, 0.05); /* 5% è—è‰² */
        --color-rain-border: #3b82f6; /* blue-500 */

	/* è®“å…¥å¢ƒ/é›¢å¢ƒçš„é‚Šæ¡†èˆ‡ä¸»é¡Œè‰²åŒæ­¥ */
    	--color-arrival-border: var(--color-primary); 
    	--color-departure-border: var(--color-primary);

  	 /* è®“èƒŒæ™¯è‰²ä¹Ÿéš¨ä¸»é¡Œè‰²è®Šæ·¡ (10% é€æ˜åº¦) */
  	 --color-arrival-bg: var(--color-bg-light-mixed);
 	 --color-departure-bg: var(--color-bg-light-mixed);

        /* è²»ç”¨é¡åˆ¥é¡è‰² (ä½¿ç”¨ 500-600 ç´šåˆ¥çš„é¡è‰²ä½œç‚ºä¸»è‰²) */
        --color-expense-lodging: #f59e0b; /* amber-500 */
        --color-expense-transport: #3b82f6; /* blue-500 */
        --color-expense-food: #10b981; /* emerald-500 */
        --color-expense-activity: #6366f1; /* indigo-500 */
        --color-expense-shopping: var(--color-primary); /* ä½¿ç”¨ä¸»é¡Œè‰² */
        
        /* è²»ç”¨é¡åˆ¥èƒŒæ™¯è‰² (ä½¿ç”¨ 10% çš„é€æ˜åº¦æ··åˆè‰²) */
        --color-bg-lodging: rgba(245, 158, 11, 0.1); 
        --color-bg-transport: rgba(59, 130, 246, 0.1); 
        --color-bg-food: rgba(16, 185, 129, 0.1); 
        --color-bg-activity: rgba(99, 102, 241, 0.1);
        --color-bg-shopping: var(--color-bg-light-mixed); /* Uses primary color's 10% mix */
        
        /* AI PLUS é¡è‰² (é’è‰²) */
        --color-ai-plus: #07b6d5;
    }

/* é¡æ©Ÿç¥¨å°å¡æ¨£å¼ */
.boarding-pass {
    position: relative;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.boarding-pass::before, .boarding-pass::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 20px;
    height: 20px;
    background-color: #f8f8f8; /* èˆ‡ body èƒŒæ™¯è‰²ä¸€è‡´ */
    border-radius: 50%;
    transform: translateY(-50%);
    z-index: 10;
    border: 1px solid #e5e7eb;
}

.boarding-pass::before { left: -11px; }
.boarding-pass::after { right: -11px; }

.ticket-divider {
    border-top: 2px dashed #e5e7eb;
    margin: 0 10px;
    position: relative;
}

.airport-code {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1f2937;
    letter-spacing: -0.025em;
}

/* ç¸®å°æ¨™ç±¤å­—é«”é˜²æ­¢åœ¨ Grid ä¸­æ’é–‹ */
.ticket-label {
    font-size: 13px;
    line-height: 1;
    color: #5e5a54;
}

/* ç¢ºä¿å¼·åˆ¶çš„ä¸¦åˆ—ä¸æœƒæº¢å‡º */
#day-content-itinerary .grid-cols-2 {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    align-items: stretch; /* è®“å·¦å³å…©å¼µå¡ç‰‡é«˜åº¦å¼·è¿«å°é½Š */
}

    /* 3. æ‰€æœ‰å…¶ä»– CSS è¦å‰‡å¾é€™è£¡é–‹å§‹ */

    /* 1. AI PLUS Tag / AI Base Tag çš„é¡è‰²çµ±ä¸€ */
    .ai-tag-base, .ai-tag-shopping {
        background-color: var(--color-primary); /* ä½¿ç”¨ä¸»é¡Œè‰² */
    }

    /* 2. æ•…äº‹å…§å®¹: ç¨ç«‹çš„æ·±ç°è‰²/æ·ºç°è‰²æ¡†æ¶ (æ ¹æ“šè¦æ±‚) */
    .schedule-story {
    background-color: #f3f4f6;
    border-radius: 0.5rem;
    padding: 0.75rem;
    color: #374151;
    border-left: 4px solid #6b7280;
    margin-top: 0.5rem;
    /* ä¸è¦æ–œé«”  åŠ å…¥ä¸‹é¢é€™ä¸€è¡Œ */
    font-style: normal !important; 
    }

    /* 3. ç¢ºä¿ AI PLUS çš„æ¨™ç±¤æ˜¯ AI+ï¼Œä¸¦ä½¿ç”¨é’è‰² */
    .ai-tag-plus {
        background-color: var(--color-ai-plus); /* #07B6D5 */
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f8f8; /* æ·ºç°è‰²èƒŒæ™¯ */
    }

    /* æ ¹æ“šä¸»é¡Œè‰²è®Šæ•¸å‹•æ…‹ç”Ÿæˆ CSS é¡åˆ¥ */
    .theme-pink { background-color: var(--color-primary); } 
    .theme-text-pink { color: var(--color-primary); } 
    .theme-border-pink { border-color: var(--color-primary); } 
    .theme-bg-light { background-color: var(--color-bg-light-mixed); } 
    .theme-border-light { border-color: var(--color-border-light-mixed); } 

/* æé†’å°è¦–çª—ï¼šç¢ºä¿å±¤ç´šé«˜æ–¼æ‰€æœ‰ sticky å…ƒç´  (å¦‚ Header å’Œ Day Tabs) */
#app-message {
    position: fixed;
    top: 80px; /* æ ¹æ“šæ‚¨çš„ Header é«˜åº¦èª¿æ•´ï¼Œé¿é–‹æœ€é ‚éƒ¨ */
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000 !important; /* å¿…é ˆé«˜æ–¼æ¨¡æ…‹æ¡†çš„ 9999 æˆ– Day Tabs çš„ 90 */
    min-width: 200px;
    text-align: center;
    pointer-events: none; /* é¿å…æ“‹ä½ä¸‹æ–¹çš„é»æ“Šæ“ä½œ */
    padding: 12px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

    /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ - ç¾åœ¨ä½¿ç”¨ä¸»é¡Œè‰²è®Šæ•¸ */
    .schedule-card-themed {
        border-color: var(--color-border-light-mixed); 
        border-width: 1px;
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        background-color: white;
        padding: 1rem;
        border-left-width: 1px; /* åŸºç¤é‚Šæ¡†å¯¬åº¦ */
        transition: all 0.2s ease;
    }
    
    /* ** é¸ä¸­æŒ‰éˆ•æ¨£å¼ - éš¨è‘—ä¸»é¡Œè‰²è®Šæ› ** */
    .tool-link.active {
        background-color: var(--color-bg-light-mixed); /* ä½¿ç”¨ä¸»é¡Œè‰² 10% çš„æ·ºè‰²ä½œç‚ºèƒŒæ™¯ */
        border-color: var(--color-primary); /* ä½¿ç”¨ä¸»é¡Œè‰²ä½œç‚ºé‚Šæ¡† */
        color: var(--color-primary); /* ä½¿ç”¨ä¸»é¡Œè‰²ä½œç‚ºæ–‡å­—é¡è‰² */
        font-weight: 600; /* font-semibold */
    }
    
    /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥ */
    .hidden-file-input {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        position: absolute;
        z-index: -1;
    }

    /* è¦†å¯« Tailwind è®“å®¹å™¨åœ¨è¡Œå‹•è£ç½®ä¸Šæ›´åƒ App */
    #app {
        /* èª¿æ•´ä¸»å®¹å™¨æœ€å¤§å¯¬åº¦ä»¥é©æ‡‰å¯¬è¢å¹• */
        max-width: 800px; 
        min-height: 100vh;
        margin: 0 auto;
        background-color: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative; /* ç¢ºä¿æ¨¡æ…‹æ¡†åœ¨å…§éƒ¨å®šä½ */
    }


/* ç«ç‘°ç²‰ç›¸é—œé…è‰² (Rose Pink) */
.bg-rose-pink {
    background-color: #f43f5e; /* Tailwind rose-500 */
}
.text-rose-pink {
    color: #f43f5e;
}
.border-rose-pink {
    border-color: #fb7185; /* Tailwind rose-400 */

/* æ´»å‹•ç´°é …æ¨™ç±¤æ¨£å¼ */
.category-badge-activity {
    background-color: #fff1f2; /* rose-50 */
    color: #e11d48; /* rose-600 */
    border: 1px solid #fda4af; /* rose-300 */
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
}

#app {
    position: relative;
    z-index: 1; /* åŸºç¤å±¤ */
}
    }

/* ç¢ºä¿å·¥å…·åˆ—æŒ‰éˆ•æ–‡å­—ä¸æ›è¡Œä¸”ä¸è¢«åˆ‡æ‰ */
.tool-link {
    white-space: nowrap !important; /* å¼·åˆ¶ä¸æ›è¡Œ */
    min-width: fit-content !important; /* æ ¹æ“šå…§å®¹è‡ªå‹•æ’é–‹ */
    padding-left: 8px !important;
    padding-right: 8px !important;
}

/* ä¿®æ­£å°è¦½åˆ— Gridï¼Œé¿å…å›ºå®š 9 æ¬„å°è‡´ç©ºé–“ä¸è¶³ */
#header + div .grid-cols-9 {
    display: flex !important;
    overflow-x: auto;
    gap: 4px;
    scrollbar-width: none; /* éš±è—æ²è»¸ */
}
#header + div .grid-cols-9::-webkit-scrollbar {
    display: none;
}


    /* 1. è©³ç´°å…§å®¹/AI å…§å®¹: ä¸»é¡Œè‰²å·¦é‚Šæ¡†, ç§»é™¤æ¨™é¡Œæ–‡å­— */
    .schedule-note {
        background-color: var(--color-note-bg);
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.75rem; /* p-3 */
        color: #374151; /* text-gray-700 */
        border-left: 4px solid var(--color-note-border); /* ä¸»é¡Œè‰²å·¦é‚Šæ¡† */
    }
    
    /* 2. é›¨å¤©å‚™æ¡ˆ: è—è‰²å·¦é‚Šæ¡† */
    .schedule-rain-plan {
        background-color: var(--color-rain-bg);
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.75rem; /* p-3 */
        color: #1d4ed8; /* text-blue-700 */
        border-left: 4px solid var(--color-rain-border); /* è—è‰²å·¦é‚Šæ¡† */
    }

    /* 3. è²»ç”¨é¡è‰² - ä½¿ç”¨ä¸»é¡Œè‰² */
    .cost-symbol {
        color: var(--color-primary); /* é‡‘éŒ¢ç¬¦è™Ÿé¡è‰²ä½¿ç”¨ä¸»é¡Œè‰² */
        font-weight: 700;
    }
    
    /* 4. æ’ç¨‹é¢¨æ ¼é¡è‰² - ä½¿ç”¨ä¸»é¡Œè‰² */
    .style-symbol {
        color: var(--color-primary); /* åœ–é‡˜ç¬¦è™Ÿé¡è‰²ä½¿ç”¨ä¸»é¡Œè‰² */
    }

    /* 5. åœ°å€è¶…é€£çµæ¨£å¼ */
    .address-link {
        text-decoration: underline;
        color: var(--color-primary); /* ä½¿ç”¨ä¸»é¡Œè‰²ä½œç‚ºé€£çµé¡è‰² */
    }
    .address-link:hover {
        opacity: 0.8;
    }

    /* AI ç·¨è¼¯æŒ‰éˆ•æ¨£å¼ - çµ±ä¸€ç‚ºä¸»é¡Œè‰² */
    .ai-edit-icon {
        font-size: 1.25rem;
        line-height: 1;
        padding: 4px;
        -webkit-text-fill-color: var(--color-primary); 
        color: var(--color-primary);
    }

.boarding-pass .airport-code, 
.day-boundary-card.lodging div {
    word-break: break-all; /* é˜²æ­¢é•·å–®å­—æ’ç ´æ¡† */
    white-space: normal;  /* å…è¨±åœ¨å¿…è¦æ™‚æ›è¡Œ */
}


    /* Day Tabs å®¹å™¨çš„å›ºå®šå¯¬åº¦å’Œæ»‘è»¸æ¨£å¼ */
    #day-tabs-container button {
        min-width: 6rem; /* ç¢ºä¿æŒ‰éˆ•æœ‰è¶³å¤ çš„æœ€å°å¯¬åº¦ */
        flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«å£“ç¸® */
    }

    /* é‚Šç•Œè³‡è¨Šå¡ç‰‡æ¨£å¼ */
    .day-boundary-card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .day-boundary-card.arrival {
        background-color: var(--color-arrival-bg);
        border-left: 4px solid var(--color-arrival-border);
    }
    .day-boundary-card.departure {
        background-color: var(--color-departure-bg);
        border-left: 4px solid var(--color-departure-border);
    }
    .day-boundary-card.lodging {
        background-color: #fffbeb; /* yellow-50 */
        border-left: 4px solid #f59e0b; /* amber-500 */
    }

    /* ä½å®¿æ¸…å–®æŒ‰éˆ•æ¨£å¼ */
    .load-list-btn {
        @apply bg-yellow-400 text-white rounded-full w-7 h-7 flex items-center justify-center text-lg hover:bg-yellow-500 transition shadow-md;
    }

    /* AI æ•…äº‹/å¼·åŒ–å…§å®¹çš„å°ˆç”¨æ¨£å¼ */
    .ai-content-card {
        background-color: var(--color-note-bg); 
        border-left: 4px solid var(--color-note-border); 
        color: #374151; /* text-gray-700 */
        @apply text-sm p-3 rounded-lg mt-2 space-y-1;
    }
    /* AI+ å°ˆç”¨æ¨£å¼ */
    .ai-tag-plus {
        background-color: var(--color-ai-plus); /* #07B6D5 */
    }
    /* AI å°ˆç”¨æ¨£å¼ (èˆ‡ä¸»é¡Œè‰²ç›¸åŒ) */
    .ai-tag-base {
        background-color: var(--color-primary);
    }
    .ai-tag {
        font-size: 0.7rem; /* text-xs */
        font-weight: 700; /* font-bold */
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem; /* rounded */
        color: white;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    /* é–‹éŠ·ç´°é …å°å¡çš„CSS */

	.expense-category-card {
	    /* ç§»é™¤ p-6 (å¤ªå¯¬)ï¼Œæ”¹ç”¨ p-4 é”åˆ°å››å‘¨ç­‰è· */
 	   @apply mb-0 p-4 rounded-xl border-2; 
  	  background-color: white;
 	   transition: all 0.2s ease;
 	   box-shadow: 0 6px 8px rgba(0, 0, 0, 0.04);
 	   display: flex;
  	  flex-direction: column;
  	  aspect-ratio: 2 / 0.8; /* è®“å¡ç‰‡å½¢ç‹€å›ºå®šï¼Œçœ‹èµ·ä¾†æ›´æ•´é½Š */
	border-radius: 6px;
    	overflow: hidden; /* é—œéµï¼ç¢ºä¿å…§éƒ¨çš„åœ–ç‰‡æˆ–èƒŒæ™¯ä¸æœƒè¶…å‡ºåœ“è§’ */
	border: 1px solid #e5e7eb;
	}

	.expense-category-card:hover {
 	   transform: translateY(-2px);
	    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}
    
    /* NEW: Solid Dot for Expense Category (Smaller size) */
	.expense-dot {
	    width: 6px;
	    height: 6px;
	    border-radius: 50%;
	    margin-right: 6px;
	    flex-shrink: 0;
}

    /* NEW: Final Summary Card Style */
    .final-summary-card {
        @apply p-4 rounded-xl border border-gray-300 shadow-md mt-4;
    }
    
    /* Total Budget Card Styling (Always Light Mode) */
    #total-budget-card {
        background-color: white; /* ç¸½æ˜¯ç™½è‰²åº•è‰² */
        border-color: #d1d5db; /* é è¨­ç°é‚Šæ¡† (gray-300) */
    }
    
    /* Edit Budget Button */
    #edit-budget-btn {
        @apply px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-xs font-semibold hover:bg-gray-200 transition;
    }
    
    /* Daily Progress Bar Styling */
    .daily-progress-bar {
        height: 6px;
        border-radius: 3px;
        background-color: var(--color-primary);
        transition: width 0.5s ease-in-out;
    }
    .daily-progress-bg {
        @apply h-2 rounded-full bg-gray-200 overflow-hidden;
    }
    /* Daily card border */
    .daily-expense-card {
        @apply p-3 border border-gray-300 rounded-xl bg-white shadow-sm;
    }
    /* Text size adjustments for expense categories */
    /* åˆ†é¡é‡‘é¡å¤§å°èª¿æ•´ç‚º text-base (1rem) */
   /* .expense-category-card .text-base-modified { 
 /*       font-size: 1rem; /* text-base */
   /* }

    
    /* Custom Ruby Tag Styling */
    ruby {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
    }

    rt {
        font-size: 0.65rem; /* Smaller font for furigana */
        line-height: 1;
        height: 0.8rem;
        color: #6b7280; /* Gray color for furigana */
        font-weight: normal;
    }
    
    /* NEW: Shopping List Item Styles */
    .shopping-item-card {
        @apply flex flex-col border border-gray-200 rounded-lg p-3 bg-white shadow-sm transition;
    }

    /* AI æ¨™ç±¤ in Shopping List */
    .ai-tag-shopping {
        background-color: var(--color-primary);
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem;
        line-height: 1;
        margin-right: 8px;
        flex-shrink: 0;
        align-self: center;
    }
    /* NEW: ç‚ºäº†ç·Šæ€¥è¯çµ¡é é¢æ–°å¢çš„æ¨£å¼ */
    .emergency-card {
        @apply p-4 rounded-xl shadow-md border border-gray-200 bg-white;
    }

/* --- é›œèªŒé¢¨æ ¼ï¼šä¸­è»¸ç·šèˆ‡é‚Šæ¡†å„ªåŒ–ç‰ˆ --- */
.magazine-photo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    opacity: 0; /* åˆå§‹éš±è—ï¼Œè¼‰å…¥å®Œæˆæ·¡å…¥ */
    transition: opacity 0.8s ease-in-out, transform 1s ease-out;
    /* é€™è£¡ä½¿ç”¨ grayscale è®“æ‰€æœ‰éš¨æ©Ÿåœ–è‰²èª¿çµ±ä¸€ï¼Œæ›´æœ‰é›œèªŒæ’ç‰ˆæ„Ÿ */
    filter: grayscale(1) contrast(1.1); 
}

.magazine-photo[src] {
    opacity: 1;
}

.magazine-photo:hover {
    filter: grayscale(0) contrast(1.1); /* æ‡¸åœæ¢å¾©å½©è‰² */
    transform: scale(1.05);
}

.magazine-container {
    background-color: #ffffff;
    padding-bottom: 50px;
}

/* é‡æ–°å°å…¥ä¸­è»¸ç·š */
.magazine-timeline-line { 
    position: absolute; 
    left: 50%; 
    top: 250px; /* é¿é–‹å¤§æ¨™é¡Œ */
    bottom: 50px; 
    width: 1px; 
    background: #e5e7eb; /* æ·ºç°è‰²ç·šæ¢ */
    transform: translateX(-50%); 
    z-index: 0; 
}

/* ç¢ºä¿é›œèªŒé ä½ˆå±€å°ç¨±æ€§ */
.magazine-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 120px;
    width: 100%;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
    position: relative;
    z-index: 1;
}
.magazine-item:nth-child(odd) { flex-direction: row; }
.magazine-item:nth-child(even) { flex-direction: row-reverse; }

.magazine-media { width: 35%; flex-shrink: 0; position: relative; }
.magazine-info { width: 60%; padding: 0 20px; }


/* åœ–ç‰‡å€ (30%) */
.magazine-photo-wrapper {
    position: relative;
    aspect-ratio: 4 / 5; /* é›œèªŒå¸¸ç”¨çš„é»ƒé‡‘æ¯”ä¾‹ï¼Œæ¯” 1:1 æ›´æœ‰è¨­è¨ˆæ„Ÿ */
    background-color: #f8f9fa;
    border-radius: 2px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
}

/* ä¸­é–“é» (Pin) ä½æ–¼è»¸ç·šä¸Š */
.magazine-pin { 
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 14px; 
    height: 14px; 
    background: var(--color-primary); 
    border: 3px solid white;
    border-radius: 50%; 
    z-index: 10; 
    box-shadow: 0 0 0 1px var(--color-primary);
}

/* æ™‚é–“æ¨™ç±¤ (ä¸»é¡Œè‰²) */
.magazine-time { 
    position: absolute; 
    top: -28px; 
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px; 
    font-weight: 800; 
    color: var(--color-primary); 
    white-space: nowrap; 
    font-family: 'Inter', sans-serif;
    letter-spacing: 1px;
}


.magazine-info {
    width: 65%; /* é¡¯è‘—å¢åŠ æ–‡å­—å€åŸŸçš„å¯¬åº¦ */
    padding: 30px; /* å¢åŠ å…§è·ï¼Œè®“æ–‡å­—æ›´æœ‰å‘¼å¸æ„Ÿ */
    background: #ffffff; /* æ”¹ç‚ºç´”ç™½ï¼Œèˆ‡èƒŒæ™¯èåˆä½†å¸¶æœ‰ç´°å¾®é™°å½± */
    border: 1px solid #f3f4f6; 
    border-radius: 4px;
    box-shadow: 10px 10px 0px rgba(0,0,0,0.02); /* åŠ å…¥ä¸€é»é›œèªŒå±¤æ¬¡æ„Ÿçš„ç¡¬é™°å½± */
}


.magazine-info h3 {
    font-size: 28px; /* ç¨å¾®æ”¾å¤§æ¨™é¡Œ */
    margin-bottom: 16px;
}

.magazine-desc-text {
    font-size: 16px; /* å¢åŠ é–±è®€èˆ’é©åº¦ */
    line-height: 1.9; /* æ‹‰é«˜è¡Œé«˜ï¼Œæ›´æœ‰é«˜ç«¯é›œèªŒæ„Ÿ */
    color: #374151;
}

.magazine-category-tag {
    color: var(--color-primary);
    font-size: 10px;
    font-weight: bold;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 5px;
    display: block;
}

/* æ–‡å­—é›²è—è¡“é¢¨æ ¼æ¿¾é¡ï¼šæ”¹ç”¨ç´” CSS æ¿¾é¡é¿å… CORS éŒ¯èª¤ */
.magazine-photo.user-uploaded {
    filter: grayscale(1) contrast(1.3) brightness(1.1) sepia(0.2);
    /* è—è¡“åŒ–è™•ç†ï¼šè®“ç…§ç‰‡çœ‹èµ·ä¾†åƒå°åœ¨é›œèªŒä¸Šçš„é«˜å°æ¯”å¢¨æ°´æ„Ÿ */
    object-fit: cover;
}

/* ç¢ºä¿ä¸Šå‚³æŒ‰éˆ•æµ®å‹•åœ¨åœ–ç‰‡ä¸Šæ–¹ï¼Œä¸å½±éŸ¿ flex ä½ˆå±€ */
.photo-upload-overlay {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 50;
    cursor: pointer;
}

.magazine-photo-wrapper {
    position: relative; /* é€™æ˜¯é—œéµï¼Œè®“æŒ‰éˆ•ç›¸å°æ–¼åœ–ç‰‡å®¹å™¨å®šä½ */
    aspect-ratio: 4 / 5;
    background-color: #f8f9fa;
    border-radius: 2px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
}


/* éš±è—çš„å£“ç¸®ç•«æ¿ */
#image-compressor { display: none; }

.photo-upload-label {
    @apply absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full cursor-pointer hover:bg-black/70 transition z-30 opacity-0 group-hover:opacity-100;
}

/* é›œèªŒé å¯ç·¨è¼¯æ–‡å­—çš„æ¨£å¼ */
[contenteditable="true"]:hover {
    outline: 1px dashed var(--color-primary);
    background-color: rgba(233, 30, 99, 0.05);
    cursor: text;
}
[contenteditable="true"]:focus {
    outline: 2px solid var(--color-primary);
    background-color: white;
}

/* AI+ å…§å®¹å°ˆç”¨é…è‰²æ¡†æ¶ (é’è‰²ç³»åˆ—) */
.ai-plus-content-frame {
    background-color: rgba(7, 182, 213, 0.05); /* 5% é’è‰² */
    border-left: 4px solid var(--color-ai-plus); /* é’è‰²å·¦é‚Šæ¡† */
    border-radius: 0.5rem;
    padding: 0.75rem;
    color: #374151;
    margin-top: 0.5rem;
}

/* AI æ•…äº‹æ¡†æ¶ */
.schedule-story-frame {
    background-color: #f9fafb; /* æ·ºç°èƒŒæ™¯ */
    border-left: 3px solid #d1d5db; /* ç°è‰²å·¦é‚Šæ¡† */
    padding: 0.75rem;
    border-radius: 0.5rem;
    margin-top: 0.75rem;
    border-bottom: 1px solid #f3f4f6;
    font-family: inherit;
}

.transport-divider {
    position: relative;
    padding: 1.5rem 0 1rem 0; /* å¢åŠ ä¸Šæ–¹å…§è·ï¼Œé˜²æ­¢æ¨™ç±¤é®è“‹ */
    margin-left: 2.25rem;
    display: block; 
    height: auto !important;
    max-width: calc(100% - 2.5rem); /* é™åˆ¶å¯¬åº¦é˜²æ­¢çªç ´å³é‚Šç•Œ */
}

/* å‚ç›´é€£æ¥ä¸­è»¸ç·š (æ·ºç°è‰²) */
.transport-divider::before {
    content: '';
    position: absolute;
    left: -1.05rem; /* åœ–ç¤ºä¸­å¿ƒé» */
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: #e5e7eb;
    z-index: 0;
}

/* å·¦å´åœ“å½¢åœ–ç¤º */
.transport-icon-wrap {
    position: absolute;
    left: -2rem; /* èª¿æ•´è®“åœ–ç¤ºä¸­å¿ƒå°æº–ä¸­è»¸ç·š */
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}

/* äº¤é€šå¡ç‰‡ä¸»é«” */
.transport-card-body {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    width: 100%;
    box-sizing: border-box; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* å¹³æ»‘éæ¸¡ */
    cursor: pointer;
}

/* æ¸¸æ¨™ç§»å…¥æ™‚çš„æµ®å‡ºèˆ‡é™°å½±æ•ˆæœ */
.transport-divider:hover .transport-card-body {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-color: #07b6d5; /* æ‡¸åœæ™‚é‚Šæ¡†å¾®äº® */
}

.expand-wrapper {
    display: grid !important;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.5s ease;
    overflow: hidden;
}

.expand-wrapper.active {
    grid-template-rows: 1fr !important;
}

.expand-content {
    min-height: 0;
    transition: opacity 0.3s ease;
}

.expand-wrapper.active .expand-content {
    visibility: visible;
    opacity: 1;
}


.stations-list-container {
    position: relative;
    z-index: 1;
}

.station-item {
    position: relative;
    padding-left: 25px;
    padding-bottom: 10px;
    display: flex;
    align-items: center;
}

.station-item:last-child {
    padding-bottom: 0;
}



/* é ‚éƒ¨ Metadata è† å›Šèˆ‡æ™‚é–“ */
.transport-meta-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.transport-duration-badge {
    background-color: #f3f4f6;
    color: #6b7280;
    padding: 1px 8px;
    border-radius: 999px;
    font-size: 10px;
    font-weight: 700;
}

.transport-time-range {
    font-size: 11px;
    color: #9ca3af;
    font-family: monospace;
}

/* --- AI è¼‰å…¥å‹•ç•«ç‰¹æ•ˆ --- */

/* é£›æ©Ÿä¸Šä¸‹æµ®å‹• */
@keyframes plane-float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}

/* é›²æœµç”±å³å‘å·¦ç§»å‹• */
@keyframes cloud-move {
    0% { transform: translateX(150px); opacity: 0; }
    10% { opacity: 0.8; }
    90% { opacity: 0.8; }
    100% { transform: translateX(-150px); opacity: 0; }
}

/* --- é«˜ç´š AI è¼‰å…¥ç‰¹æ•ˆ --- */

/* é£›æ©Ÿå¹³æ»‘æµ®å‹• */
@keyframes plane-float-refined {
    0%, 100% { transform: translateY(0) rotate(2deg); }
    50% { transform: translateY(-20px) rotate(-2deg); }
}

/* é›²æœµéš¨æ©Ÿæ¼‚æµ® (å¤šå±¤æ¬¡) */
@keyframes cloud-drift {
    0% { transform: translateX(180px); opacity: 0; }
    15% { opacity: 0.4; }
    85% { opacity: 0.4; }
    100% { transform: translateX(-180px); opacity: 0; }
}

/* æ–‡å­—å¾®å…‰æƒææ•ˆæœ */
@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.shimmer-text {
    background: linear-gradient(90deg, #07b6d5 25%, #ffffff 50%, #07b6d5 75%);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 2s infinite linear;
    font-weight: 800;
}

.ai-loader-box {
    position: relative;
    width: 100%;
    height: 180px;
    background: radial-gradient(circle at center, rgba(7, 182, 213, 0.05) 0%, transparent 70%);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    border-radius: 2rem;
}

.refined-plane {
    font-size: 3.5rem;
    filter: drop-shadow(0 10px 15px rgba(7, 182, 213, 0.3));
    animation: plane-float-refined 2.5s ease-in-out infinite;
    z-index: 20;
}

.refined-cloud {
    position: absolute;
    color: #e2e8f0;
    font-size: 1.8rem;
    z-index: 10;
    opacity: 0;
}

.ai-loading-container {
    position: relative;
    width: 200px;
    height: 120px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.floating-plane {
    font-size: 3rem;
    z-index: 20;
    animation: plane-float 2s ease-in-out infinite;
}

.cloud {
    position: absolute;
    color: #e5e7eb;
    font-size: 1.5rem;
    z-index: 10;
    opacity: 0;
}

/* é»æ“Šæ¨™ç±¤æ™‚çš„æˆåŠŸéœ‡å‹• */
.ai-shopping-tag.added {
    animation: success-pop 0.4s ease-out;
    background-color: #f0fdf4 !important;
    border-color: #bbf7d0 !important;
}

@keyframes success-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* è¨­å®šä¸åŒé›²æœµçš„å‹•ç•«æ™‚é–“èˆ‡å»¶é²ï¼Œå¢åŠ éš¨æ©Ÿæ„Ÿ */
.cloud-1 { top: 20%; animation: cloud-move 3s linear infinite; }
.cloud-2 { top: 50%; animation: cloud-move 4s linear infinite 1s; }
.cloud-3 { top: 80%; animation: cloud-move 2.5s linear infinite 0.5s; }

@keyframes metal-shine {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* AI+ éŠ€ç™½é–ƒäº®æ¨™ç±¤æ¨£å¼ */
.ai-plus-tag-shiny {
    background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 40%, #ffffff 50%, #e2e8f0 60%, #ffffff 100%);
    background-size: 200% 200%;
    color: #475569;
    border: 1px solid #cbd5e1;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), inset 0 0 4px rgba(255, 255, 255, 0.5);
    animation: shine-sweep 4s infinite linear;
    font-weight: 800;
padding: 3px 10px;
    border-radius: 6px;
    font-size: 10px;
    display: inline-flex;
    align-items: center;
cursor: pointer;
}

@keyframes shine-sweep {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* å¼·åŒ–å¾Œçš„é’è‰²åœ°åœ–é‡˜ (Pin) */
.pin-cyan { color: #07b6d5 !important; }
.pin-border-cyan { border-color: #07b6d5 !important; }


/* è¼”åŠ©é¡è‰² */
.bg-silver-100 { background-color: #f3f4f6; }
.ring-silver-200 { --tw-ring-color: #e5e7eb; }

/* æ­·å²è¨˜éŒ„å‚ç›´ç·šè£é£¾ */
.history-item {
    border-left: 2px solid #f1f5f9;
    padding-left: 1.25rem;
    position: relative;
}

/* æ­·å²ç¯€é»åœ“é» */
.history-item::before {
    content: '';
    position: absolute;
    left: -5px;
    top: 4px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #cbd5e1;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #f1f5f9;
}

/* ç¬¬ä¸€å€‹é …ç›®ï¼ˆæœ€æ–°ç‰ˆï¼‰é¡¯ç¤ºé’è‰²åœ“é» */
.history-item:first-child::before {
    background: #07b6d5;
    box-shadow: 0 0 8px rgba(7, 182, 213, 0.4);
}

/* ç°¡ç´„ç‰ˆæ»¾å‹•æ¢ */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #f1f1f1;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #e5e5e5;
}

/* å±•é–‹å‹•ç•« */
.animate-in {
    animation-duration: 0.3s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
}

/* çµ±ä¸€è¦–åœ–å®¹å™¨å¯¬åº¦æ¨™æº– */
#content-container {
    width: 100%;
    max-width: 800px; /* ç¢ºä¿èˆ‡ App ä¸»å®¹å™¨ä¸€è‡´ */
    margin: 0 auto;
    box-sizing: border-box;
}

/* ç¢ºä¿æ‰€æœ‰ view æ¨™ç±¤å…§å®¹å¡«æ»¿å¯¬åº¦ */
[id$="-view"] .bg-white {
    width: 100% !important;
    max-width: none !important; /* ç¢ºä¿ä¸è¢« Tailwind é è¨­çš„å¯¬åº¦é™åˆ¶ */
    border-radius: 0.75rem; /* èˆ‡è¡Œç¨‹å¡ç‰‡åœ“è§’ä¸€è‡´ */
}

/* ç¢ºä¿è¡Œç¨‹åˆ†é å®¹å™¨ä¹Ÿæ˜¯æ»¿å¯¬ */
#day-content-itinerary {
    width: 100%;
}

/* ç•¶ view è¢«åˆ‡æ›ç‚ºééš±è—æ™‚ï¼Œå¼·åˆ¶ä½ˆå±€ */
[id$="-view"]:not(.hidden) {
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* çµ±ä¸€å…§éƒ¨å¡ç‰‡çš„æœ€å¤§å¯¬åº¦æ„Ÿ */
.view-card-wrap {
    width: 100%;
    padding: 1rem; /* çµ±ä¸€é–“è· */
    box-sizing: border-box;
}

/* å¼·åˆ¶æ’é–‹åŸæœ¬è¢«ç¸®å°çš„å€å¡Š */
#settings-view .bg-white, 
#data-view .bg-white,
#expense-view .bg-white,
#emergency-view .bg-white,
#shopping-view .bg-white,
#translate-view .bg-white {
    width: 100% !important;
    max-width: 100% !important; /* ç§»é™¤ max-w-sm æˆ– max-w-md çš„å½±éŸ¿ */
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f8f8f8;
    margin: 0;
    padding: 0;
    display: block !important; /* å¾¹åº•ç§»é™¤ flex ç½®ä¸­å°è‡´çš„å£“ç¸® */
}

/* é‡å°æ›´æ–°æ—¥èªŒæ¨¡æ…‹æ¡†çš„æ¡†æ¶å„ªåŒ– - v1.2.6 */
#version-history-modal .bg-white {
    width: 90% !important;
    max-width: 400px !important; /* å°‡å¯¬åº¦é™åˆ¶åœ¨è¼ƒçª„çš„ç¯„åœï¼Œå‘ˆç¾ç²¾ç·»æ„Ÿ */
    margin: auto;
    border-radius: 1.5rem !important;
}

#version-history-body {
    padding: 1rem !important;
}

/* v1.2.7 äº¤é€šåœ–ç¤ºèˆ‡ç´°ç¯€æ“´å…… */
.transport-icon-active {
    @apply text-lg flex items-center justify-center bg-white border-2 border-blue-400 rounded-full w-8 h-8 shadow-sm;
}

.transport-details-toggle {
    @apply text-[10px] font-extrabold text-blue-500 mt-2 flex items-center cursor-pointer hover:text-blue-700 transition-all;
}

.stations-list {
    @apply mt-2 pl-3 border-l-2 border-blue-200 space-y-1 overflow-hidden transition-all duration-300 bg-gray-50/50 rounded-r-md;
}

.station-item {
    @apply text-[11px] text-gray-500 flex items-center py-0.5;
}


.station-item.endpoint {
    @apply text-gray-800 font-black;
}

.station-item.endpoint::before {
    content: 'â—';
    @apply text-blue-500;
}

/* v1.2.8 å…¨çƒäº¤é€šé€šç”¨æ¨£å¼ */
.transport-details-box {
    @apply mt-3 border-t border-gray-100 pt-3 transition-all duration-500 ease-in-out;
}

/* å‚ç›´å°èˆªç·š */
.nav-timeline {
    @apply absolute left-[15px] top-4 bottom-4 w-[2px] bg-gradient-to-b from-blue-400 via-blue-200 to-blue-400;
}

.nav-node {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}

.nav-node-major { background: #3b82f6; border: 2px solid #eff6ff; box-shadow: 0 0 0 3px #dbeafe; }
.nav-node-minor { background: #fff; border: 2px solid #93c5fd; }

/* ä¼¸å±•å‹•ç•«ï¼šæ”¯æŒå„ç¨®é•·åº¦çš„å…§å®¹ */
.expand-content {
    max-height: 0;
    opacity: 0;
    visibility: hidden;
    overflow: hidden;
    /* ä½¿ç”¨ transform-origin è®“å‹•ç•«å¾é ‚éƒ¨é–‹å§‹ */
    transform-origin: top;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease,
                padding 0.3s ease;
}

.expand-content.active {
max-height: 2000px; /* çµ¦äºˆè¶³å¤ å¤§çš„ä¸Šé™å€¼ */
    opacity: 1;
    visibility: visible;
    padding-top: 0.5rem;
    margin-top: 0.5rem;
}

/* å‚ç›´æ™‚é–“è»¸ */
.nav-timeline {
    position: absolute;
    left: 8px; /* é…åˆ node ä½ç½® */
    top: 10px;
    bottom: 10px;
    width: 2px;
    background: #dbeafe; /* blue-100 */
}

/* éŠ€ç™½é–ƒäº®äº¤é€šæ¨™ç±¤ */
/* é–ƒäº®äº®çš„æ¨™ç±¤ */
.ai-plus-route-tag {
    background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 40%, #ffffff 50%, #e2e8f0 60%, #ffffff 100%);
    background-size: 200% 200%;
    color: #475569;
    border: 1px solid #cbd5e1;
    animation: shine-sweep 4s infinite linear;
    font-weight: 900;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 9px;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 20;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* äº¤é€šå¡ç‰‡å·¦ä¸‹è§’çš„ AI Plus æ–‡å­—æŒ‰éˆ• */
.transport-ai-plus-btn {
    font-size: 11px;
    font-weight: 800;
    color: #07b6d5; /* AI Plus é’è‰² */
    cursor: pointer;
    transition: all 0.2s;
}
.transport-ai-plus-btn:hover {
    opacity: 0.7;
    text-decoration: underline;
}

.status-pill:hover { transform: scale(1.1); }

/* å‚™é¸å¡ç‰‡å…§çš„åœ°é»æ¨™ç±¤æ¨£å¼ */
.bucket-tag-info {
    font-size: 10px;
    background: #f8fafc; /* æ›´æ·¡çš„è—ç°è‰² */
    color: #94a3b8;      /* æŸ”å’Œçš„è—ç°è‰²æ–‡å­— */
    padding: 1px 6px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    margin-bottom: 6px;
    font-family: monospace;
}

// CSS æ¨£å¼è£œå…… (åŠ å…¥åˆ° <style> å€å¡Š)
/* æ¨™è¨˜ç‹€æ…‹å°åœ–ç¤ºå‹•ç•« */
.status-pill {
    transition: all 0.2s ease;
    cursor: pointer;
}
.status-pill:hover { transform: scale(1.1); }

/* å·¥åŠæ¨¡å¼ä¸‹çš„æ’ç¨‹å¡ç‰‡æ¨£å¼ */
.workshop-mode .schedule-card {
    border-style: dashed !important;
    border-color: #3b82f6 !important; /* Blue 500 */
    background-color: #eff6ff !important; /* Blue 50 */
    position: relative;
}

.workshop-mode .schedule-card::after {
    content: "DRAFT";
    position: absolute;
    top: 5px;
    right: 10px;
    font-size: 8px;
    font-weight: 900;
    color: #3b82f6;
    opacity: 0.3;
}

/* å·¥åŠæ¨¡å¼ä¸‹çš„æ’ç¨‹å¡ç‰‡å¤–è§€ */
.workshop-mode .schedule-item-card {
    border: 2px dashed #3b82f6 !important; /* è—è‰²è™›ç·š */
    background-color: #f0f7ff !important; /* æ·¡æ·¡çš„æ·ºè—èƒŒæ™¯ */
    opacity: 0.9;
}

/* è®“ä¸‹æ‹‰é¸å–®åœ¨å°è¦½åˆ—ä¸Šæ–¹æ­£ç¢ºé¡¯ç¤º */
.group:hover .group-hover\:block {
    display: block !important;
}

/* æ¨¡å¼åˆ‡æ›æŒ‰éˆ•åŸºç¤æ¨£å¼ */
.mode-toggle-btn {
    padding: 0.4rem 1rem;
    border-radius: 0.75rem;
    font-size: 0.75rem;
    font-weight: 900;
    transition: all 0.2s ease;
    color: #64748b; /* é è¨­ç°è‰² */
}

/* æ­£å¼æ’ç¨‹æŒ‰éˆ•ï¼šé¸ä¸­æ…‹ */
.mode-toggle-btn.active-theme {
    background-color: white !important;
    /* å„ªå…ˆä½¿ç”¨ JS å‹•æ…‹æ³¨å…¥çš„ä¸»é¡Œè‰²è®Šæ•¸ */
    color: var(--theme-primary, var(--color-primary, #FF69B4)) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* è¦åŠƒå·¥åŠæŒ‰éˆ•ï¼šé¸ä¸­æ…‹ */
.mode-toggle-btn.active-workshop {
    background-color: #2563eb !important; /* å›ºå®šå°ˆæ¥­è— */
    color: white !important;
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

/* ç¢ºä¿ CSS è®Šæ•¸åœ¨ root æˆ– applyTheme æ™‚æ›´æ–° */
:root {
    --theme-primary: #FF69B4; /* é è¨­å€¼ï¼Œæœƒè¢« applyTheme æ›´æ–° */
}

/* ç•¶åœ¨å·¥åŠæ¨¡å¼æ™‚ï¼Œè®“å°è¦½åˆ—çš„è¡Œç¨‹æŒ‰éˆ•å¾®äº®è—å…‰ */
[id="itinerary-btn-text"]:not(:empty) {
    transition: color 0.3s ease;
}

/* è®“å°è¦½åˆ—æŒ‰éˆ•èˆ‡é¸å–®ä¹‹é–“æ²’æœ‰ç‰©ç†ç©ºéš™ */
.relative.group {
    position: relative;
}

/* å»ºç«‹ä¸€å€‹é€æ˜æ©‹æ¥å™¨ï¼Œç¢ºä¿æ»‘é¼ ç§»å‹•æ™‚ group ç‹€æ…‹ä¸ä¸­æ–· */
.relative.group::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 15px; /* æ©‹æ¥ç©ºéš™é«˜åº¦ */
    background: transparent;
    z-index: 1;
}

/* é¸å–®æœ¬èº« */
.group-hover\:block {
    top: 100%;
    margin-top: -2px; /* å‘ä¸Šå¾®èª¿èˆ‡æŒ‰éˆ•é‡ç–Š 2pxï¼Œæ¶ˆé™¤ç¸«éš™ */
}

/* éš±è—å·¥åŠæ¨™ç±¤åˆ—çš„æ²è»¸ */
.no-scrollbar::-webkit-scrollbar {
    display: none;
}
.no-scrollbar {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
-webkit-overflow-scrolling: touch; /* è®“ iOS æ²å‹•æ›´æ»‘é † */
}

/* PC ç«¯è—åœ–æ»‘è»Œç¾åŒ–ï¼šå¼·åˆ¶é¡¯ç¤ºç²¾ç·»æ²è»¸ä»¥ä¾¿æ“ä½œ */
#workshop-version-slider .overflow-x-auto::-webkit-scrollbar {
    height: 6px; /* æ²è»¸é«˜åº¦ */
    display: block; /* ç¢ºä¿ PC ç«¯é¡¯ç¤º */
}
#workshop-version-slider .overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f5f9; /* è»Œé“é¡è‰² */
    border-radius: 10px;
}
#workshop-version-slider .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1; /* æ»‘å¡Šé¡è‰² (æ·ºç°è‰²) */
    border-radius: 10px;
}
#workshop-version-slider .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #3b82f6; /* æ‡¸åœæ™‚è®Šè—è‰² */
}


/* å°æ­£ PC ç«¯ç„¡æ³•æ©«ç§»è—åœ–åˆ—çš„å•é¡Œ */
@media (pointer: fine) { /* åµæ¸¬æ˜¯å¦ç‚ºæ»‘é¼ æ“ä½œ */
    #workshop-version-slider, 
    .no-scrollbar {
        overflow-x: auto !important;
        scrollbar-width: thin !important; /* Firefox */
        scrollbar-color: #cbd5e1 transparent !important;
    }

    #workshop-version-slider::-webkit-scrollbar,
    .no-scrollbar::-webkit-scrollbar {
        height: 6px !important;
        display: block !important; /* å¼·åˆ¶ Chrome é¡¯ç¤º */
    }

    #workshop-version-slider::-webkit-scrollbar-thumb,
    .no-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 10px;
    }
    
    #workshop-version-slider::-webkit-scrollbar-thumb:hover {
        background-color: #3b82f6;
    }
}

/* ä¿®æ­£æŒ‰éˆ•è¢«åˆ‡æ‰ */
.tool-link, .mode-toggle-btn {
    white-space: nowrap !important;
    flex-shrink: 0 !important;
}

#workshop-version-slider {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch; /* å¢åŠ è¡Œå‹•ç«¯æ»‘å‹•æµæš¢åº¦ */
    display: block;
    width: 100%;
    padding-bottom: 8px;
    padding-top: 4px;
    overflow-x: auto;
}

/* ä¿®å¾© PC ç«¯æ²è»¸é®æ“‹æ–‡å­—å•é¡Œ */
#workshop-version-slider::-webkit-scrollbar {
    height: 4px;
}

/* ç¢ºä¿å…§éƒ¨ flex å®¹å™¨ä¸æœƒç¸®å°å…§å®¹ */
#workshop-version-slider > div {
    display: flex;
    flex-wrap: nowrap;
}

/* è¡Œç¨‹é é ‚éƒ¨å‡çµå±¤ */
#itinerary-view > div:first-child {
    background-color: #ffffff !important;
    position: sticky;
    top: 112px;
    z-index: 50 !important;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    height: auto !important; /* è®“é«˜åº¦è‡ªå‹•é©æ‡‰å…§å®¹ */
    overflow: visible !important; /* ç¢ºä¿æŒ‰éˆ•æŠ•å½±é¡¯ç¤º */
}

/* é‡å°ç¬¬äºŒè¡Œå·¥å…·åˆ—çš„é–“è·èª¿æ•´ */
#workshop-toolbar {
    padding-top: 4px;
    padding-bottom: 8px; /* å¢åŠ åº•éƒ¨å…§è·é˜²æ­¢åˆ‡é‚Š */
}

/* ç¢ºä¿æ©«å‘æ»‘è»Œå…§çš„æ–¹æ¡ˆæŒ‰éˆ•é«˜åº¦å°é½Š */
.ws-tab-btn {
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}


/* ç¢ºä¿æ»‘è»Œåœ¨æ©«å‘æ²å‹•æ™‚ï¼ŒæŒ‰éˆ•ä¸‹æ–¹çš„é™°å½±æœ‰ç©ºé–“é¡¯ç¤ºï¼Œä¸è¢«åº•éƒ¨é‚Šæ¡†åˆ‡æ–· */
#workshop-version-slider {
    padding-bottom: 4px;
    display: flex;
    align-items: center;
}

/* ç¢ºä¿æ¨™ç±¤å…§çš„å­—é«”åœ¨ä»»ä½•æƒ…æ³ä¸‹éƒ½ä¸æœƒæ¶ˆå¤± */
#mode-status-indicator {
    min-height: 24px;
    display: flex !important;
    align-items: center;
    opacity: 1 !important;
    visibility: visible !important;
}

#mode-status-indicator {
    min-width: 130px !important;
    display: flex !important;
    align-items: center !important;
}

/* ç¢ºä¿é–ƒçˆæ–‡å­—ä½¿ç”¨ä¸»é¡Œç«ç‘°ç²‰ */
.bg-pink-500 {
    background-color: #e91e63 !important; 
}

/* é˜²æ­¢å·¥åŠæ»‘è»Œæ’ç ´é é¢é‚Šç•Œ */
#workshop-tools-wrap {
    min-width: 0; /* Flexbox é˜²æ­¢æº¢å‡ºçš„é—œéµ */
    max-width: calc(100% - 150px); /* æ‰£æ‰å·¦å´æ¨™ç±¤å¯¬åº¦ */
}



/* é˜²æ­¢ Day Page è¢«è£åˆ‡ï¼šæ˜ç¢ºæŒ‡å®šå„å±¤ Sticky é«˜åº¦ */
#day-tabs-container { top: 64px !important; }
#mode-frozen-bar { top: 106px !important; }

/* æ¨™ç±¤å­—æ¨£å¼·åˆ¶å¯è¦‹ */
#mode-status-indicator span {
    display: inline-flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* æ–¹æ¡ˆæ»‘è»Œé˜²æº¢å‡ºèˆ‡ PC æ©«ç§» */
#workshop-version-slider {
    scrollbar-width: none;
    -ms-overflow-style: none;
    -webkit-overflow-scrolling: touch;
}
#workshop-version-slider::-webkit-scrollbar { display: none; }

/* æ­£å¼è¡Œç¨‹é–ƒçˆè£œä¸ */
.bg-pink-500.animate-pulse {
    background-color: #e91e63 !important; /* ç«ç‘°ç²‰ */
    color: white !important;
    animation: master-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
}

@keyframes master-pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(0.96); }
}

/* èª¿æ•´ Tab æŒ‰éˆ•å…§çš„æ–‡å­—é–“è· */
#day-tabs-container button {
    min-width: 5.5rem; /* ç¨å¾®ç¸®çª„å¯¬åº¦ */
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    font-size: 12px; /* ç¸®å°å­—é«” */
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.2;
}

/* ä¿®æ­£ Sticky Top çš„åç§»é‡ */
/* åŸæœ¬æ˜¯ top-16 (64px)ï¼Œå¦‚æœ Header é«˜åº¦ä¸è®Šï¼Œå‰‡ç¶­æŒ */
.sticky.top-16 {
    top: 64px !important;
}

/* ä¸‹æ–¹çš„ Sticky Bar (æŒ‡ç¤ºåˆ—) ä¹Ÿè¦è·Ÿè‘—å¾€ä¸Šæ */
/* åŸæœ¬æ˜¯ 112px (64+48)ï¼Œç¾åœ¨æ”¹ç‚º 106px (64+42) */
#itinerary-view > div:first-child {
    top: 106px !important; 
}

/* ç¢ºä¿æ©«å‘æ²å‹•æ™‚ä¸æœƒå‡ºç¾å¤šé¤˜çš„å‚ç›´æ²è»¸ */
.no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
}
.no-scrollbar::-webkit-scrollbar {
    display: none;
}

/* è‡ªå®šç¾©é–ƒçˆå‹•ç•« (æ›´æŸ”å’Œ) */
@keyframes pulse-soft {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(0.98); }
}

/* å¼·åˆ¶ä¿®æ­£ï¼šé–ƒçˆèˆ‡ç¸®æ”¾å‹•ç•« */
.animate-pulse {
    animation: pulse-active 2s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
}

@keyframes pulse-active {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(0.96); }
}

/* é˜²æ­¢æ»‘è»Œæº¢å‡ºä¸¦å…è¨±æ²å‹• */
#workshop-version-slider {
    display: flex;
    align-items: center;
    gap: 8px;
    overflow-x: auto;
    padding: 4px 0;
    max-width: 100%;
}


/* è®“ Bar æ°¸é é‡˜åœ¨å¤©æ•¸åˆ—ä¸‹æ–¹ï¼Œä¸è¢«è£åˆ‡ */
#mode-frozen-bar {
    position: sticky;
    top: 106px !important; /* Header 64 + DayTabs 42 */
    z-index: 85 !important;
    background-color: #ffffff !important;
    box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    height: 52px;
    overflow: visible !important;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #f3f4f6;
}

/* å¼·åˆ¶æ­£å¼è¡Œç¨‹é–ƒçˆæ¨™ç±¤çš„å‹•ç•«æ•ˆæœ */
.theme-pink.animate-pulse {
    animation: master-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes master-pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(0.97); }
}

/* æ­£å¼è¡Œç¨‹å°ˆå±¬é–ƒçˆå‹•ç•« */
.bg-pink-500.animate-pulse {
    background-color: #e91e63 !important; /* å¼·åˆ¶ä½¿ç”¨æ‚¨çš„ç«ç‘°ç²‰ä¸»è‰² */
    animation: master-pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
    color: white !important;
}

/* å¼·åˆ¶ä¿®æ­£ï¼šæ­£å¼è¡Œç¨‹æ¨™ç±¤æ¨£å¼ */
#mode-status-indicator .bg-pink-500 {
    background-color: #e91e63 !important; /* æ‰‹å‹•å¼·åˆ¶æŒ‡å®šç«ç‘°ç²‰è‰² */
    color: #ffffff !important;
    display: inline-flex !important;
    align-items: center;
}

/* ---------------------------------- */
/* âœ¨ é«˜ç´šå‘¼å¸ç‡ˆæ ¸å¿ƒ - æ·±åº¦è¦–è¦ºå¢å¼·ç‰ˆ */
/* ---------------------------------- */
@keyframes high-end-breath {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0px rgba(var(--breath-rgb), 0);
        filter: brightness(1);
    }
    50% { 
        transform: scale(1.02); /* å¾®å¾®æ”¾å¤§å¢åŠ ç”Ÿå‘½æ„Ÿ */
        box-shadow: 0 0 15px rgba(var(--breath-rgb), 0.6); /* ç”¢ç”ŸåŠé€æ˜å…‰æšˆ */
        filter: brightness(1.1); /* å‘¼å¸æ™‚ç¨å¾®ç™¼äº® */
    }
}

/* å·¥åŠæ¨¡å¼ï¼šå°ˆæ¥­è—å‘¼å¸ç‡ˆ */
.breath-workshop {
    --breath-rgb: 37, 99, 235; /* Blue 600 */
    animation: high-end-breath 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
}

/* æ­£å¼è¡Œç¨‹ï¼šç«ç‘°ç²‰å‘¼å¸ç‡ˆ */
.breath-master {
    --breath-rgb: 233, 30, 99; /* Primary Pink */
    animation: high-end-breath 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
}

/* å…§éƒ¨çš„ç‹€æ…‹æŒ‡ç¤ºåœ“é» (æ°´æ³¢ç´‹æ•ˆæœ) */
.dot-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: white;
    position: relative;
    display: inline-block;
    margin-right: 6px;
}

.dot-indicator::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    background-color: white;
    animation: dot-ripple 2s infinite;
}

@keyframes dot-ripple {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(3.5); opacity: 0; }
}

#day-tabs-container {
    display: flex !important; /* ç¢ºä¿ Flex ä½ˆå±€å¼·åˆ¶ç”Ÿæ•ˆ */
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    min-height: 42px; /* çµ¦äºˆå›ºå®šé«˜åº¦é˜²æ­¢å¡Œé™· */
}

/* å¼·åˆ¶é‡ç¹ªæ™‚çš„å‹•ç•«ï¼šç•¶å…§å®¹æ›´æ–°æ™‚é–ƒçˆä¸€ä¸‹ï¼Œè¦–è¦ºä¸Šç¢ºèªæ•¸æ“šè®Šå‹• */
#day-tabs-container, #day-content-itinerary {
    animation: domReflow 0.1s ease-out;
}

@keyframes domReflow {
    from { opacity: 0.99; }
    to { opacity: 1; }
}

/* ç¢ºä¿ Tab å®¹å™¨åœ¨é‡ç¹ªæ™‚ä¸æœƒå› ç‚º Flex å¯¬åº¦å¿«å–è€Œæ’é–‹ */
#day-tabs-container > button {
    contain: content; /* æŒ‡ç¤ºç€è¦½å™¨æ­¤æŒ‰éˆ•èˆ‡å¤–éƒ¨å¸ƒå±€è§£è€¦ï¼ŒåŠ é€Ÿé‡ç•« */
}

/* äº¤é€šåœ–ç¤ºå®¹å™¨ */
.transport-icon-wrap {
    position: absolute;
    left: -2.15rem; /* å°ä½ä¸­è»¸ç·š */
    top: 1rem;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

/* å‚ç›´é€£æ¥ç·š */
.transport-divider::before {
    content: '';
    position: absolute;
    left: -1.05rem;
    top: 0;
    bottom: -1.5rem; /* å»¶ä¼¸åˆ°ä¸‹ä¸€å€‹å¡ç‰‡ */
    width: 2px;
    background-color: #f3f4f6; /* æ·ºç°è‰²ç·šæ¢ */
    z-index: 0;
}

/* æœ€å¾Œä¸€å¼µäº¤é€šå¡ä¸å»¶ä¼¸é€£ç·š */
#day-content-itinerary .transport-divider:last-child::before {
    bottom: 2rem;
}

/* äº¤é€šå¡ç‰‡ä¸»é«” */
.transport-card-body {
    background-color: #ffffff;
    border: 1px solid #f3f4f6;
    border-radius: 1rem;
    padding: 1.25rem;
    margin-left: 0.5rem;
    position: relative;
    z-index: 5;
}

/* å‚ç›´é€£æ¥ä¸­è»¸ç·š */
.transport-divider::before {
    content: '';
    position: absolute;
    left: -1.05rem; /* å¿…é ˆç²¾æº–å°ä½ */
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: #e5e7eb;
    z-index: 0;
}

/* å·¦å´åœ“å½¢åœ–ç¤ºå®šä½ */
.transport-icon-wrap {
    position: absolute;
    left: -2rem; /* å¿…é ˆè®“ä¸­å¿ƒå°æº–é€£ç·š */
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
}

/* å¡ç‰‡ä¸»é«” */
.transport-card-body {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    width: 100%;
}

/* âœ¨ æ¨¡æ…‹æ¡†å…§å®¹å€æ»‘è»¸å„ªåŒ– */
.modal-scroll-area {
    max-height: 60vh; /* é™åˆ¶é«˜åº¦ç‚ºè¢å¹•çš„ 60% */
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px; /* ç‚ºæ²è»¸é ç•™å¾®å°ç©ºé–“ */
    scrollbar-width: thin; /* Firefox çª„æ²è»¸ */
/* ç¾åŒ–æ²è»¸ (iOS/Chrome) */
    -webkit-overflow-scrolling: touch;
}

/* Chrome, Safari æ²è»¸ç¾åŒ– */
.modal-scroll-area::-webkit-scrollbar {
    width: 5px;
}
.modal-scroll-area::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}
.modal-scroll-area::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}
.modal-scroll-area::-webkit-scrollbar-thumb:hover {
    background: var(--color-primary);
}

/* ç¢ºä¿å½ˆçª—ä¸»é«”åœ¨å°è¢å¹•ä¹Ÿèƒ½æ­£å¸¸é¡¯ç¤º */
[id$="-modal"] > div {
    max-height: 90vh;
}

/* å¾®å‹é›·é”è„ˆè¡å‹•ç•« */
.mini-radar-ping {
    position: relative;
    display: inline-flex;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #ec4899; /* æ¡ƒç´…è‰²ï¼Œå°æ‡‰æ­£å¼è¡Œç¨‹è‰² */
}
.mini-radar-ping::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: inherit;
    animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
}
@keyframes ping {
    75%, 100% { transform: scale(3); opacity: 0; }
}

/* æ¨™ç±¤æŒ‰éˆ•åŸºç¤æ¨£å¼å¼·åŒ– */
.preview-tag-btn {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    user-select: none;
}

/* é»æ“Šæ™‚çš„ç¸®æ”¾å›é¥‹ */
.preview-tag-btn:active {
    transform: scale(0.92);
}

/* å¼·åˆ¶è¦†è“‹åç™½é¡è‰² (ç¢ºä¿èˆ‡ä¸»é¡Œè‰²ä¸€è‡´) */
.bg-pink-500 {
    background-color: #ff4d8d !important; /* é€™æ˜¯æ‚¨çš„ä¸»é¡Œç²‰ç´…è‰² */
}


/* ğŸ› ï¸ é ‚éƒ¨å·¥å…·åˆ—ï¼šåŸºç¤æŒ‰éˆ•å„ªåŒ– */
.tool-link {
    @apply transition-all duration-200 ease-in-out border border-transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    padding: 6px 4px;
}

.tool-link:hover {
    @apply bg-white shadow-sm border-gray-200;
    transform: translateY(-1px); /* å¾®å°æµ®å‹•æ„Ÿ */
}

.tool-link:active {
    transform: translateY(0) scale(0.95); /* é»æ“ŠæŒ‰ä¸‹æ„Ÿ */
}

/* ğŸ“… è¡Œç¨‹èˆ‡å‚™é¸ï¼šä¸‹æ‹‰é¸å–®çµ²æ»‘åŒ– */
.group .group-hover\:block {
    display: none; /* é è¨­éš±è— */
}

.relative.group:hover > div[class*="absolute"] {
    display: block !important;
    animation: menuSlideIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    transform-origin: top left;
}

/* ğŸ¢ ä¸‹æ‹‰å‹•ç•«è»Œè·¡ */
@keyframes menuSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ğŸ’ ä¸‹æ‹‰é¸å–®å…§éƒ¨æŒ‰éˆ• */
.group-hover\:block button {
    @apply transition-colors duration-150;
    position: relative;
    overflow: hidden;
}

/* ğŸ§¬ è¡Œç¨‹ç¶­åº¦è‘—è‰²å¢å¼· */
.hover\:bg-pink-50:hover { color: #ec4899 !important; }  /* æ­£å¼ */
.hover\:bg-blue-50:hover { color: #3b82f6 !important; }  /* å·¥åŠ */
.hover\:bg-purple-50:hover { color: #8b5cf6 !important; } /* é›œèªŒ */
.hover\:bg-green-50:hover { color: #10b981 !important; }  /* é–‹éŠ· */

/* ğŸ“± æ‰‹æ©Ÿç«¯é»æ“Šè£œå¼·ï¼šé˜²æ­¢é¸å–®ç¬é–“æ¶ˆå¤± */
@media (max-width: 640px) {
    .tool-link {
        font-size: 11px; /* å¾®èª¿æ‰‹æ©Ÿå­—ç´š */
    }
    /* ä¸‹æ‹‰é¸å–®åŠ å¤§é»æ“Šå€åŸŸ */
    .absolute div button {
        padding-top: 12px;
        padding-bottom: 12px;
    }
}

/* ğŸš¨ æå‡æç¤ºè¨Šæ¯å±¤ç´šï¼Œè§£æ±º Navbar é®æ“‹å•é¡Œ */
#message-toast {
    z-index: 100000 !important; /* è³¦äºˆè¶…è¶Š Navbar çš„æœ€é«˜å±¤ç´š */
    top: 20px !important;       /* ç¨å¾®å‘ä¸‹ç§»å‹•ï¼Œé¿é–‹ Navbar æœ€åšçš„åœ°æ–¹ */
    backdrop-filter: blur(10px); /* å¢åŠ èƒŒæ™¯ç£¨ç ‚è³ªæ„Ÿï¼Œè®“æ–‡å­—æ›´æ¸…æ™° */
    border: 2px solid #fce7f3;  /* å¢åŠ æ·¡ç²‰è‰²é‚Šæ¡†å¢å¼·è¾¨è­˜åº¦ */
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); /* å¢å¼·é™°å½± */
}

/* âœ¨ ç‡ƒæ–™çµäººå°ˆå±¬ï¼šä»»å‹™ä¸­å¿ƒé«˜äº® */
#quest-center-btn {
    @apply animate-pulse;
    border: 1px solid rgba(245, 158, 11, 0.3);
}


</style>
</head>
<body>

    <div id="app">

<header id="header" class="sticky top-0 z-[100] theme-pink text-white shadow-md p-4 flex justify-between items-center h-16">
    <div class="flex items-center">
        <button id="back-btn" 
                class="text-2xl hidden mr-3 focus:outline-none hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center transition" 
                onclick="switchView('list')">
            â†
        </button>
        
        <div class="flex flex-col">
            <h1 id="header-title" class="text-xl font-black tracking-tight">æˆ‘çš„è¡Œç¨‹</h1>
            <span id="header-subtitle" class="text-[10px] opacity-70 font-medium tracking-wider uppercase leading-none">Travel Planner</span>
        </div>
    </div>

    <div class="flex items-center">
<span id="app-version-tag" 
      class="ai-plus-tag-shiny active:scale-95 transition-transform cursor-pointer select-none" 
      onclick="showVersionHistory()">
    v1.2.9
</span>
    </div>
</header>

        <div id="app-message" class="hidden fixed top-20 left-1/2 -translate-x-1/2 px-4 py-2 text-white rounded-lg shadow-xl z-30 transition duration-300"></div>

        <main id="content-container" class="p-4"></main>
    </div>

    <div id="modal-container">

<div id="version-history-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'version-history-modal') toggleModal('version-history-modal')">
    <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh] overflow-hidden animate-in fade-in zoom-in duration-300">
        
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
            <h3 class="text-lg font-black text-gray-800 flex items-center">
                <span class="ai-plus-tag-shiny mr-2 text-[10px] py-0.5 px-2">History</span> æ›´æ–°æ—¥èªŒ
            </h3>
            <button onclick="toggleModal('version-history-modal')" class="text-gray-400 p-1.5 hover:bg-gray-100 rounded-full transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        
        <div id="version-history-body" class="overflow-y-auto flex-grow bg-white p-2">
            <div class="space-y-2" id="version-accordion">
                <div class="group border border-gray-50 rounded-xl overflow-hidden">
                    <div class="p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center transition" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span class="font-bold text-gray-700 text-sm">v1.1.2 <span class="ml-2 text-[10px] text-blue-500 font-normal">Latest</span></span>
                        <svg class="w-4 h-4 text-gray-300 group-hover:text-gray-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="p-4 pt-0 text-xs text-gray-500 leading-relaxed space-y-2 border-t border-gray-50 hidden bg-gray-50/30">
                        <p>â€¢ ğŸ¨ æ”¹è‰¯æ›´æ–°æ—¥èªŒ UI ç‚ºç°¡ç´„ç¾ä»£é¢¨æ ¼ã€‚</p>
                        <p>â€¢ ğŸ› ï¸ å¼·åŒ–æ¨™ç±¤é»æ“Šèˆ‡è³‡æ–™å¯«å…¥ç©©å®šæ€§ã€‚</p>
                    </div>
                </div>

                <div class="group border border-gray-50 rounded-xl overflow-hidden">
                    <div class="p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center transition" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span class="font-bold text-gray-700 text-sm text-opacity-60">v1.1.1</span>
                        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="p-4 pt-0 text-xs text-gray-400 leading-relaxed border-t border-gray-50 hidden">
                        <p>â€¢ âœ¨ å°å…¥ AI PLUS æ·±åº¦æ”»ç•¥åŠŸèƒ½ã€‚</p>
                        <p>â€¢ ğŸ›’ å¯¦ä½œå»ºè­°è³¼è²·æ¸…å–®äº’å‹•æ©Ÿåˆ¶ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-center">
            <button onclick="toggleModal('version-history-modal')" class="px-10 py-2 bg-gray-800 text-white rounded-full text-xs font-bold hover:bg-gray-700 active:scale-95 transition shadow-sm">
                é—œé–‰è¦–çª—
            </button>
        </div>
    </div>
</div>

<div id="ai-plus-modal" class="hidden fixed inset-0 z-[10000] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'ai-plus-modal') toggleModal('ai-plus-modal')">
    <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
        
        <div class="p-6 flex justify-between items-center" style="background-color: var(--color-ai-plus);">
            <h3 class="font-black flex items-center text-white">
                <span class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 bg-white/20 shadow-inner">âœ¨</span>
                <span id="aiplus-modal-title" class="text-lg tracking-tight">æ·±åº¦æ”»ç•¥</span>
            </h3>
            <button onclick="toggleModal('ai-plus-modal')" class="text-white/80 hover:text-white p-2 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="h-px w-full bg-gray-200 shadow-[0_2px_4px_rgba(0,0,0,0.1)] relative z-10"></div>
        
        <div id="aiplus-modal-body" class="p-8 max-h-[60vh] overflow-y-auto text-gray-700 leading-relaxed text-base bg-white">
            </div>

        <div class="p-4 bg-gray-50 flex justify-center border-t border-gray-100">
            <button onclick="toggleModal('ai-plus-modal')" 
                    class="px-10 py-2.5 text-white rounded-full text-sm font-bold shadow-lg transition-all active:scale-95 hover:brightness-110"
                    style="background-color: var(--color-ai-plus);">
                å·²é–±è®€
            </button>
        </div>
    </div>
</div>

        <div id="add-trip-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'add-trip-modal') toggleModal('add-trip-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 theme-text-pink">æ–°å¢è¡Œç¨‹</h3>
                <input type="text" id="new-trip-name" placeholder="è¡Œç¨‹åç¨± (ä¾‹å¦‚ï¼šå®œè˜­å…©æ—¥éŠ)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 mb-4">
                <div class="flex justify-end space-x-2">
                    <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('add-trip-modal')">å–æ¶ˆ</button>
                    <button class="px-4 py-2 theme-pink text-white rounded-lg hover:bg-pink-600 transition" onclick="addNewTrip()">æ–°å¢</button>
                </div>
            </div>
        </div>


        <div id="add-schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'add-schedule-modal') toggleModal('add-schedule-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 theme-text-pink">æ–°å¢/ç·¨è¼¯æ™¯é»æ’ç¨‹</h3>
                <form id="schedule-form" onsubmit="handleScheduleSubmit(event)">
                    <input type="hidden" id="schedule-id">
                    
                    <div class="mb-3">
                        <label for="schedule-name" class="block text-sm font-medium text-gray-700">æ’ç¨‹åç¨±</label>
                        <input type="text" id="schedule-name" required placeholder="ä¾‹å¦‚ï¼šè Ÿè—è Ÿç­†åŸå ¡" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="mb-3">
                        <label for="schedule-address" class="block text-sm font-medium text-gray-700">æ™¯é»æˆ–åœ°å€ (éå¿…å¡«)</label>
                        <input type="text" id="schedule-address" placeholder="ä¾‹å¦‚ï¼šå®œè˜­ç¸£è˜‡æ¾³é®æµ·å±±è¥¿è·¯500è™Ÿ" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="mb-3">
                        <label for="schedule-notes" class="block text-sm font-medium text-gray-700">è©³ç´°å…§å®¹</label>
                        <textarea id="schedule-notes" placeholder="ä¾‹å¦‚ï¼šå¯„æ”¾è¡Œæ/é è¨‚æ™šé¤" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="schedule-rain-plan" class="block text-sm font-medium text-gray-700">é›¨å¤©å‚™æ¡ˆ (éå¿…å¡«)</label>
                        <input type="text" id="schedule-rain-plan" placeholder="ä¾‹å¦‚ï¼šæ”¹å»å®œè˜­å‚³è—ä¸­å¿ƒ" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

                    <div class="flex space-x-4 mb-3">
                        <div class="flex-1">
                            <label for="schedule-start-time" class="block text-sm font-medium text-gray-700">é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="schedule-start-time" required class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex-1">
                            <label for="schedule-duration" class="block text-sm font-medium text-gray-700">åœç•™æ™‚é–“ (å°æ™‚)</label>
                            <input type="number" id="schedule-duration" min="0.1" step="0.1" required value="1" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="schedule-cost" class="block text-sm font-medium text-gray-700">è²»ç”¨ (åƒ…æ•¸å­—ï¼Œä¾‹å¦‚ï¼š500)</label>
                        <input type="text" id="schedule-cost" placeholder="ä¾‹å¦‚ï¼š250" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

                    <div class="mb-4">
                        <label for="schedule-style" class="block text-sm font-medium text-gray-700">æ’ç¨‹é¢¨æ ¼</label>
                        <select id="schedule-style" class="w-full p-3 border border-gray-300 rounded-lg" onchange="toggleCustomStyleInput(this.value)">
			    <option value="transport">äº¤é€šç§»å‹• (è‡ªå‹•ç”Ÿæˆç«™é»æ¸…å–®)</option>
                            <option value="cultural">æ–‡åŒ–æ­·å²å°å‘ (åƒè§€åšç‰©é¤¨ã€å¤è¹Ÿ)</option>
                            <option value="food">ç¾é£Ÿæ¢éšª (å°‹è¨ªç•¶åœ°ç‰¹è‰²å°åƒã€ååº—)</option>
                            <option value="nature">è‡ªç„¶æˆ¶å¤–æ´»å‹• (ç™»å±±ã€æµ·é‚Šã€å…¬åœ’)</option>
                            <option value="shopping">è³¼ç‰©ä¼‘é–’ (ç™¾è²¨å…¬å¸ã€ç‰¹è‰²å¸‚é›†)</option>
                            <option value="anime">äºŒæ¬¡å…ƒæ–‡åŒ– (å‹•æ¼«ã€éŠæˆ²ã€æ¬¡æ–‡åŒ–)</option>
                            <option value="nightlife">å¤œé–“æ´»å‹•å°å‘ (é…’å§ã€å¤œæ™¯ã€å¤œå¸‚)</option>
     			    <option value="description">ğŸ“ æè¿°æŒ‡å¼• (ç´”æ–‡å­—ã€æ¨™ç±¤å †ç–Šã€è½‰ä¹˜èªªæ˜)</option>
                            <option value="other">å…¶ä»– (è«‹è‡ªè¨‚)</option>
                        </select>
                    </div>

                    <div id="custom-style-group" class="mb-4 hidden">
                        <label for="schedule-custom-style" class="block text-sm font-medium text-gray-700">è‡ªè¨‚é¢¨æ ¼åç¨±</label>
                        <input type="text" id="schedule-custom-style" placeholder="è¼¸å…¥æ‚¨çš„è‡ªè¨‚é¢¨æ ¼åç¨±" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

<div id="transport-ai-panel" class="hidden mt-4 p-4 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 animate-in fade-in slide-in-from-top-2">
    <div class="flex items-center justify-between mb-3">
        <span class="text-[11px] font-black text-slate-500 uppercase tracking-widest flex items-center">
            <span class="mr-1.5">ğŸ¤–</span> AI äº¤é€šæ™ºæ…§åŠ©æ‰‹
        </span>
        <span class="text-[9px] bg-slate-400 text-white px-1.5 py-0.5 rounded font-bold">PRO</span>
    </div>
    
    <input type="text" id="ai-transport-query" 
           placeholder="ç¯„ä¾‹ï¼šåšå¤šåˆ°å°å€‰ï¼Œæ­JRï¼Œ10:00å‡ºç™¼" 
           class="w-full p-3 text-sm bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-400 transition-all mb-3">

    <div class="grid grid-cols-2 gap-3">
        <button type="button" onclick="runAIEnhancement()" 
                class="flex flex-col items-center justify-center p-3 bg-white border border-slate-200 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition-all group">
            <span class="text-lg mb-1">âœ¨</span>
            <span class="text-[11px] font-black text-gray-700">AI+ æ¨™ç±¤å¼·åŒ–</span>
            <span class="text-[9px] text-gray-400">å„ªåŒ–ç¾æœ‰æ¨™ç±¤æ ¼å¼</span>
        </button>

        <button type="button" onclick="runTransportGenerator()" 
                class="flex flex-col items-center justify-center p-3 bg-white border border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
            <span class="text-lg mb-1">ğŸšŒ</span>
            <span class="text-[11px] font-black text-gray-700">äº¤é€šå°å¡ä»£å¯«</span>
            <span class="text-[9px] text-gray-400">å…¨æ–°è¦åŠƒä¸¦å¡«è¡¨</span>
        </button>
    </div>

    <div id="ai-conflict-warning" class="mt-3 hidden animate-bounce">
        <div class="p-2 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2">
            <span class="text-amber-500">âš ï¸</span>
            <p id="conflict-text" class="text-[10px] text-amber-700 font-bold leading-tight"></p>
        </div>
    </div>
</div>
                    
                    <div class="flex justify-end space-x-2">
                        <button type="button" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('add-schedule-modal')">å–æ¶ˆ</button>
                        <button type="submit" class="px-4 py-2 theme-pink text-white rounded-lg hover:bg-pink-600 transition">å„²å­˜æ’ç¨‹</button>
                    </div>
                </form>
            </div>
        </div>



<div id="ai-schedule-form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="handleModalBackdropClick(event, 'ai-schedule-form-modal')">
    <div id="ai-schedule-form-content-area" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 text-blue-600" id="ai-schedule-modal-title">âœ¨ AI PLUS è¡Œç¨‹å¼·åŒ–</h3>
                <form id="ai-schedule-form" onsubmit="handleAIPerScheduleSubmit(event)">
                    <input type="hidden" id="ai-schedule-id-target">
                    
                    <div class="mb-3">
                        <label for="ai-schedule-name" class="block text-sm font-medium text-gray-700">æ’ç¨‹åç¨±</label>
                        <input type="text" id="ai-schedule-name" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="mb-3">
                        <label for="ai-schedule-address" class="block text-sm font-medium text-gray-700">æ™¯é»æˆ–åœ°å€ (éå¿…å¡«)</label>
                        <input type="text" id="ai-schedule-address" placeholder="ä¾‹å¦‚ï¼š270 å®œè˜­ç¸£è˜‡æ¾³é®æµ·å±±è¥¿è·¯500è™Ÿ" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="mb-3">
                        <label for="ai-schedule-notes-input" class="block text-sm font-medium text-gray-700">è©³ç´°å…§å®¹ (ç”¨æˆ¶è¼¸å…¥)</label>
                        <textarea id="ai-schedule-notes-input" placeholder="ä¾‹å¦‚ï¼šå¯„æ”¾è¡Œæ/é è¨‚æ™šé¤" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ai-schedule-rain-plan-input" class="block text-sm font-medium text-gray-700">é›¨å¤©å‚™æ¡ˆ (éå¿…å¡«)</label>
                        <input type="text" id="ai-schedule-rain-plan-input" placeholder="ä¾‹å¦‚ï¼šæ”¹å»å®œè˜­å‚³è—ä¸­å¿ƒ" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

                    <div class="flex space-x-4 mb-3">
                        <div class="flex-1">
                            <label for="ai-schedule-start-time" class="block text-sm font-medium text-gray-700">é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="ai-schedule-start-time" required class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex-1">
                            <label for="ai-schedule-duration" class="block text-sm font-medium text-gray-700">åœç•™æ™‚é–“ (å°æ™‚)</label>
                            <input type="number" id="ai-schedule-duration" min="0.1" step="0.1" required value="1" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ai-schedule-cost-input" class="block text-sm font-medium text-gray-700">è²»ç”¨ (åƒ…æ•¸å­—ï¼Œä¾‹å¦‚ï¼š500)</label>
                        <input type="text" id="ai-schedule-cost-input" placeholder="ä¾‹å¦‚ï¼š250" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>

                    <div class="mb-4">
                        <label for="ai-schedule-transport-mode" class="block text-sm font-medium text-gray-700">ä¸»è¦äº¤é€šæ–¹å¼ (AI å»ºè­°/å„ªåŒ–)</label>
                        <select id="ai-schedule-transport-mode" class="w-full p-3 border border-gray-300 rounded-lg" onchange="toggleCustomAITransportInput(this.value, 'ai-schedule-custom-transport-group', 'ai-schedule-custom-transport')">
                            <option value="none">ä¸è¨ˆç®—äº¤é€šï¼ˆé è¨­ï¼‰</option>
                            <option value="train">é«˜éµ / æ–°å¹¹ç·š</option>
                            <option value="subway">ç«è»Š / åœ°éµ</option>
                            <option value="bus">å·´å£« / å…¬è»Š</option>
                            <option value="taxi">è¨ˆç¨‹è»Š</option>
                            <option value="other">å…¶å®ƒ</option>
                        </select>
                        <div id="ai-schedule-custom-transport-group" class="mb-3 hidden mt-2">
                            <label for="ai-schedule-custom-transport" class="block text-sm font-medium text-gray-700">è‡ªè¨‚äº¤é€šæ–¹å¼åç¨±</label>
                            <input type="text" id="ai-schedule-custom-transport" placeholder="ä¾‹å¦‚ï¼šé£¯åº—æ¥é§è»Š" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="ai-schedule-style-input" class="block text-sm font-medium text-gray-700">æ’ç¨‹é¢¨æ ¼</label>
                        <select id="ai-schedule-style-input" class="w-full p-3 border border-gray-300 rounded-lg" onchange="toggleCustomStyleInput(this.value, 'ai-schedule-custom-style-input', 'ai-schedule-custom-style-group')">
                            <option value="cultural">æ–‡åŒ–æ­·å²å°å‘ (åƒè§€åšç‰©é¤¨ã€å¤è¹Ÿ)</option>
                            <option value="food">ç¾é£Ÿæ¢éšª (å°‹è¨ªç•¶åœ°ç‰¹è‰²å°åƒã€ååº—)</option>
                            <option value="nature">è‡ªç„¶æˆ¶å¤–æ´»å‹• (ç™»å±±ã€æµ·é‚Šã€å…¬åœ’)</option>
                            <option value="shopping">è³¼ç‰©ä¼‘é–’ (ç™¾è²¨å…¬å¸ã€ç‰¹è‰²å¸‚é›†)</option>
                            <option value="anime">äºŒæ¬¡å…ƒæ–‡åŒ– (å‹•æ¼«ã€éŠæˆ²ã€æ¬¡æ–‡åŒ–)</option>
                            <option value="nightlife">å¤œé–“æ´»å‹•å°å‘ (é…’å§ã€å¤œæ™¯ã€å¤œå¸‚)</option>
			    <option value="description">ğŸ“ æè¿°æŒ‡å¼• (ç´”æ–‡å­—ã€æ¨™ç±¤å †ç–Šã€è½‰ä¹˜èªªæ˜)</option>
                            <option value="other">å…¶ä»– (è«‹è‡ªè¨‚)</option>
                        </select>
                        <div id="ai-schedule-custom-style-group" class="mb-4 hidden">
                            <label for="ai-schedule-custom-style-input" class="block text-sm font-medium text-gray-700">è‡ªè¨‚é¢¨æ ¼åç¨±</label>
                            <input type="text" id="ai-schedule-custom-style-input" placeholder="è¼¸å…¥æ‚¨çš„è‡ªè¨‚é¢¨æ ¼åç¨±" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button type="button" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('ai-schedule-form-modal')">å–æ¶ˆ</button>
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-bold">
                            ğŸ¤– AI å¼·åŒ–æ­¤æ’ç¨‹
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="trip-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'trip-edit-modal') toggleModal('trip-edit-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 theme-text-pink">è¡Œç¨‹æ“ä½œ</h3>
                <div class="mb-4">
                    <label for="edit-trip-name" class="block text-sm font-medium text-gray-700">è¡Œç¨‹åç¨±</label>
                    <input type="text" id="edit-trip-name" class="w-full p-3 border border-gray-300 rounded-lg" value="">
                    <input type="hidden" id="current-trip-id-for-edit">
                </div>
                <div class="flex justify-between space-x-2">
                    <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" onclick="deleteCurrentTrip()">åˆªé™¤è¡Œç¨‹</button>
                    <div>
                        <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('trip-edit-modal')">å–æ¶ˆ</button>
                        <button class="px-4 py-2 theme-pink text-white rounded-lg hover:bg-pink-600 transition" onclick="saveTripNameEdit()">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="schedule-actions-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'schedule-actions-modal') toggleModal('schedule-actions-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 theme-text-pink" id="schedule-action-name">æ™¯é»åç¨±</h3>
                <input type="hidden" id="current-schedule-id-for-action">
                <div class="space-y-3">
                    <button class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold" onclick="triggerEditFromActions()">
                        ç·¨è¼¯æ’ç¨‹
                    </button>
                    <button class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold" onclick="triggerDeleteFromActions()">
                        åˆªé™¤æ’ç¨‹
                    </button>
                    <button class="w-full px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('schedule-actions-modal')">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <div id="confirm-delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'confirm-delete-modal') toggleModal('confirm-delete-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs">
                <h3 class="text-xl font-bold mb-4 text-red-600">ç¢ºèªåˆªé™¤</h3>
                <p id="confirm-delete-message" class="mb-6 text-gray-700"></p>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('confirm-delete-modal')">å–æ¶ˆ</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">ç¢ºå®šåˆªé™¤</button>
                </div>
            </div>
        </div>

<div id="edit-day-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'edit-day-modal') toggleModal('edit-day-modal')">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
        
        <div class="p-6 overflow-y-auto flex-grow">
            <h3 class="text-xl font-bold mb-4 theme-text-pink" id="edit-day-modal-title">ç·¨è¼¯ ç¬¬ N å¤©è¡Œç¨‹</h3>
            
            <form id="day-edit-form" onsubmit="event.preventDefault();">
                <input type="hidden" id="edit-day-index">

                <div class="mb-6 space-y-3">
                    <label class="block text-xs font-bold text-gray-500 uppercase">åŸºæœ¬è³‡è¨Š</label>
                    <input type="date" id="edit-day-date" required class="w-full p-3 border border-gray-300 rounded-lg mb-2 focus:ring-2 theme-border-pink outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-400 ml-1">å‡ºç™¼æ™‚é–“</label>
                            <input type="time" id="edit-day-start-time" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 theme-border-pink outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 ml-1">çµæŸæ™‚é–“</label>
                            <input type="time" id="edit-day-end-time" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 theme-border-pink outline-none">
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-bold text-gray-700">åŸå¸‚/åœ°å€</label>
                        <button type="button" onclick="addCityInput('city-inputs-container')" class="text-white theme-pink w-6 h-6 rounded-full flex items-center justify-center shadow-md">+</button>
                    </div>
                    <div id="city-inputs-container" class="space-y-2"></div>
                </div>

                <div id="arrival-info-group" class="mb-6 border border-blue-200 p-4 rounded-xl bg-blue-50 hidden">
                    <h4 class="font-bold text-blue-600 mb-3 flex items-center"><span class="mr-2">âœˆï¸</span> å…¥å¢ƒèˆªç­è³‡è¨Š</h4>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="ticket-label">Departure Airport</label>
                            <input type="text" id="arrival-departure-airport" placeholder="æ¡ƒåœ’ TPE" class="w-full p-2 border rounded-lg text-sm outline-none">
                            <input type="time" id="arrival-departure-time" class="w-full p-2 border rounded-lg text-sm mt-1">
                        </div>
                        <div>
                            <label class="ticket-label">Arrival Airport</label>
                            <input type="text" id="arrival-airport" placeholder="æŠµé”æ©Ÿå ´" class="w-full p-2 border rounded-lg text-sm outline-none">
                            <input type="time" id="arrival-time" class="w-full p-2 border rounded-lg text-sm mt-1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="ticket-label">Flight Number</label>
                        <input type="text" id="arrival-flight" placeholder="CI102" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="ticket-label">ä¸»è¦äº¤é€š (æ©Ÿå ´åˆ°å¸‚å€)</label>
                        <select id="arrival-transport-mode" class="w-full p-2 border rounded-lg text-sm bg-white" onchange="toggleCustomAITransportInput(this.value, 'custom-arrival-transport-group', 'custom-arrival-transport')">
                            <option value="train">é«˜éµ / æ–°å¹¹ç·š</option>
                            <option value="subway">ç«è»Š / åœ°éµ</option>
                            <option value="bus">å·´å£« / å…¬è»Š</option>
                            <option value="taxi">è¨ˆç¨‹è»Š</option>
                            <option value="other">å…¶å®ƒ</option>
                        </select>
                        <div id="custom-arrival-transport-group" class="hidden mt-2">
                            <input type="text" id="custom-arrival-transport" placeholder="è«‹è¼¸å…¥äº¤é€šæ–¹å¼" class="w-full p-2 border border-blue-300 rounded text-sm bg-white">
                        </div>
                    </div>
                </div>

                <div id="lodging-info-group" class="mb-6 border border-yellow-300 p-4 rounded-xl bg-yellow-50">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-yellow-700 flex items-center"><span class="mr-2">ğŸ¨</span> ä½å®¿è³‡è¨Š</h4>
                        <div class="flex space-x-2">
                            <button type="button" class="bg-blue-500 text-white rounded px-3 py-1 text-xs font-bold" onclick="showLodgingList('lodging-')">è¼‰å…¥</button>
                            <button type="button" class="bg-red-100 text-red-600 rounded px-3 py-1 text-xs font-bold border border-red-200" onclick="clearLodgingInfo('lodging-')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <input type="text" id="lodging-name" placeholder="æ—…é¤¨åç¨±" class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="lodging-address" placeholder="æ—…é¤¨åœ°å€" class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="lodging-phone" placeholder="è¯çµ¡é›»è©±" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div class="mt-4 p-3 bg-white rounded-lg border border-yellow-200">
                        <h5 class="text-[10px] font-bold text-yellow-700 mb-2 uppercase text-center">ä½å®¿ç‹€æ…‹ (å½±éŸ¿æ˜æ—¥è³‡è¨Š)</h5>
                        <div class="flex justify-around">
                            <label class="flex items-center cursor-pointer text-sm"><input type="radio" name="lodging-status" id="lodging-status-stay" value="stay" class="mr-2">çºŒä½</label>
                            <label class="flex items-center cursor-pointer text-sm"><input type="radio" name="lodging-status" id="lodging-status-check-out" value="check-out" class="mr-2 text-red-500">é€€æˆ¿</label>
                        </div>
                    </div>
                </div>

                <div id="departure-info-group" class="mb-6 border border-red-200 p-4 rounded-xl bg-red-50 hidden">
                    <h4 class="font-bold text-red-600 mb-3 flex items-center"><span class="mr-2">ğŸ›«</span> é›¢å¢ƒèˆªç­è³‡è¨Š</h4>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="ticket-label">Departure Airport</label>
                            <input type="text" id="departure-airport" placeholder="æˆç”° NRT" class="w-full p-2 border rounded-lg text-sm outline-none">
                            <input type="time" id="departure-time" class="w-full p-2 border rounded-lg text-sm mt-1">
                        </div>
                        <div>
                            <label class="ticket-label">Return Home Airport</label>
                            <input type="text" id="departure-arrival-airport" placeholder="æ¡ƒåœ’ TPE" class="w-full p-2 border rounded-lg text-sm outline-none">
                            <input type="time" id="departure-arrival-time" class="w-full p-2 border rounded-lg text-sm mt-1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="ticket-label">Flight Number</label>
                        <input type="text" id="departure-flight" placeholder="BR189" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="ticket-label">å‰å¾€æ©Ÿå ´äº¤é€š</label>
                        <select id="departure-transport-mode" class="w-full p-2 border rounded-lg text-sm bg-white" onchange="toggleCustomAITransportInput(this.value, 'custom-departure-transport-group', 'custom-departure-transport-input')">
                            <option value="train">é«˜éµ / æ–°å¹¹ç·š</option>
                            <option value="subway">ç«è»Š / åœ°éµ</option>
                            <option value="bus">å·´å£« / å…¬è»Š</option>
                            <option value="taxi">è¨ˆç¨‹è»Š</option>
                            <option value="other">å…¶å®ƒ</option>
                        </select>
                        <div id="custom-departure-transport-group" class="hidden mt-2">
                            <input type="text" id="custom-departure-transport-input" placeholder="è«‹è¼¸å…¥äº¤é€šæ–¹å¼" class="w-full p-2 border border-red-300 rounded text-sm bg-white">
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="p-4 border-t bg-gray-50 flex justify-end space-x-3 rounded-b-xl flex-shrink-0">
            <button type="button" class="px-5 py-2.5 text-gray-500 font-semibold hover:bg-gray-100 rounded-lg transition" onclick="toggleModal('edit-day-modal')">å–æ¶ˆ</button>
            <button type="button" class="px-5 py-2.5 theme-pink text-white font-bold rounded-lg shadow-md hover:opacity-90 transition" onclick="saveDayEdit(event)">å„²å­˜ç•¶æ—¥è¡Œç¨‹</button>
        </div>
    </div>
</div>

<div id="ai-loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm flex flex-col items-center border border-blue-100">
        
        <div class="ai-loading-container mb-4">
            <div class="cloud cloud-1">â˜ï¸</div>
            <div class="cloud cloud-2">â˜ï¸</div>
            <div class="cloud cloud-3">â˜ï¸</div>
            <div class="floating-plane">âœˆï¸</div>
        </div>

        <h3 class="text-2xl font-black text-gray-800 mb-2 tracking-tight">AI é ˜èˆªå“¡è¦åŠƒä¸­</h3>
        
        <div class="flex items-center space-x-2">
            <span class="flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-blue-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
            </span>
            <p id="ai-loading-message" class="text-blue-600 font-bold text-sm">æ­£åœ¨å„ªåŒ–æ‚¨çš„å®Œç¾è¡Œç¨‹...</p>
        </div>
        
        <p class="text-gray-400 text-[10px] mt-6 uppercase tracking-widest font-bold">Please wait a moment</p>
    </div>
</div>
        
        <div id="lodging-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'lodging-list-modal') toggleModal('lodging-list-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 text-yellow-700">è¼‰å…¥ä½å®¿è³‡è¨Š</h3>
                <input type="hidden" id="lodging-prefix-for-load">
                <div id="lodging-list-container" class="space-y-3">
                    <p class="text-gray-500 text-sm">è«‹å…ˆåœ¨ä»»ä¸€å¤©çš„ç·¨è¼¯ä¸­è¼¸å…¥ä½å®¿è³‡è¨Šã€‚</p>
                </div>
                <div class="flex justify-end mt-4">
                    <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('lodging-list-modal')">é—œé–‰</button>
                </div>
            </div>
        </div>
        
        <div id="edit-budget-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'edit-budget-modal') toggleModal('edit-budget-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 theme-text-pink">ä¿®æ”¹ç¸½é ç®—èˆ‡å¹£åˆ¥</h3>
                <form onsubmit="saveTotalBudget(event)">
                    <div class="mb-4">
                        <label for="modal-total-budget" class="block text-sm font-medium text-gray-700">ç¸½é ç®— (åƒ…æ•¸å­—)</label>
                        <input type="number" id="modal-total-budget" step="100" min="0" placeholder="ä¾‹å¦‚: 50000" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label for="modal-currency" class="block text-sm font-medium text-gray-700">å¹£åˆ¥</label>
                        <select id="modal-currency" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="NTD">æ–°å°å¹£ (NTD)</option>
                            <option value="JPY">æ—¥åœ“ (JPY)</option>
                            <option value="USD">ç¾å…ƒ (USD)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                            <option value="HKD">æ¸¯å¹£ (HKD)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('edit-budget-modal')">å–æ¶ˆ</button>
                        <button type="submit" class="px-4 py-2 theme-pink text-white rounded-lg hover:bg-pink-600 transition">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="expense-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'expense-detail-modal') toggleModal('expense-detail-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 theme-text-pink" id="expense-modal-title"></h3>
                
                <div id="expense-modal-content">
                    </div>

                <div class="flex justify-end mt-4">
                    <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('expense-detail-modal')">é—œé–‰</button>
                </div>
            </div>
        </div>
        
        <div id="add-to-schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'add-to-schedule-modal') toggleModal('add-to-schedule-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 theme-text-pink">å°‡é …ç›®åŠ å…¥è¡Œç¨‹</h3>
                <input type="hidden" id="item-id-for-schedule">
                <p id="item-name-for-schedule" class="text-gray-700 mb-4 font-semibold"></p>
                <div class="mb-4">
                    <label for="schedule-day-select" class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡è¦åŠ å…¥çš„æ—¥æœŸ</label>
                    <select id="schedule-day-select" class="w-full p-3 border border-gray-300 rounded-lg">
                        </select>
                </div>
                
                <div class="flex justify-end space-x-2 mt-4">
                    <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('add-to-schedule-modal')">å–æ¶ˆ</button>
                    <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition" onclick="submitAddToSchedule()">ç¢ºå®šåŠ å…¥</button>
                </div>
            </div>
        </div>

        <div id="ai-shopping-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'ai-shopping-settings-modal') toggleModal('ai-shopping-settings-modal')">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 theme-text-pink">ğŸ¤– AI è³¼ç‰©ä»£å°‹</h3>
                <form onsubmit="initiateAIShoppingSearch(event)">
                    <div class="mb-4">
                        <label for="ai-search-item" class="block text-sm font-medium text-gray-700">æƒ³è³¼è²·çš„ç‰©å“/é¡å‹ (ä¾‹å¦‚: çŸ¥åé³³æ¢¨é…¥æˆ–ç•¶åœ°ç‰¹è‰²)</label>
                        <input type="text" id="ai-search-item" placeholder="ä¾‹å¦‚ï¼šçŸ¥åé³³æ¢¨é…¥æˆ–ç•¶åœ°ç‰¹ç”¢" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label for="ai-search-city" class="block text-sm font-medium text-gray-700">ç›®æ¨™åŸå¸‚/åœ°å€</label>
                        <input type="text" id="ai-search-city" placeholder="ä¾‹å¦‚ï¼šå°åŒ—æˆ–åšå¤š" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label for="ai-search-currency" class="block text-sm font-medium text-gray-700">é ä¼°å¹£åˆ¥</label>
                        <select id="ai-search-currency" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="NTD">æ–°å°å¹£ (NTD)</option>
                            <option value="JPY">æ—¥åœ“ (JPY)</option>
                            <option value="USD">ç¾å…ƒ (USD)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                            <option value="HKD">æ¸¯å¹£ (HKD)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100" onclick="toggleModal('ai-shopping-settings-modal')">å–æ¶ˆ</button>
                        <button type="submit" class="px-4 py-2 theme-pink text-white rounded-lg hover:bg-pink-600 transition">
                            é–‹å§‹ AI ä»£å°‹
                        </button>
                    </div>
                </form>
            </div>
        </div>

        </div>


 <div id="embassy-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'embassy-edit-modal') toggleModal('embassy-edit-modal')">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
        <h3 class="text-xl font-bold mb-4 theme-text-pink">ğŸ‡¹ğŸ‡¼ ç·¨è¼¯é§å¤–ä»£è¡¨è™•</h3>
        <input type="hidden" id="edit-embassy-id">
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">å¤§ä½¿é¤¨åç¨±</label>
                <input type="text" id="edit-embassy-name" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">å¤§ä½¿é¤¨åœ°å€</label>
                <input type="text" id="edit-embassy-address" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">é›»è©±</label>
                <input type="tel" id="edit-embassy-phone" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">æ€¥é›£æ•‘åŠ©</label>
                <input type="tel" id="edit-embassy-rescue" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6">
            <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 text-sm" onclick="toggleModal('embassy-edit-modal')">å–æ¶ˆ</button>
            <button class="px-4 py-2 theme-pink text-white rounded-lg hover:opacity-90 transition text-sm font-semibold" onclick="saveEmbassyEdit()">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="medical-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" onclick="if(event.target.id === 'medical-edit-modal') toggleModal('medical-edit-modal')">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
        <h3 class="text-xl font-bold mb-4 theme-text-pink">ğŸ¥ ç·¨è¼¯é†«ç™‚å”åŠ©è³‡æº</h3>
        <input type="hidden" id="edit-medical-id">
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">å–®ä½åç¨±</label>
                <input type="text" id="edit-medical-name" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">èªªæ˜</label>
                <input type="text" id="edit-medical-info" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none" placeholder="ä¾‹å¦‚ï¼šæœ‰ä¸­æ–‡é–€è¨º">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">åœ°å€</label>
                <input type="text" id="edit-medical-address" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">é›»è©±</label>
                <input type="tel" id="edit-medical-phone" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 theme-border-pink outline-none">
            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6">
            <button class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 text-sm" onclick="toggleModal('medical-edit-modal')">å–æ¶ˆ</button>
            <button class="px-4 py-2 theme-pink text-white rounded-lg hover:opacity-90 transition text-sm font-semibold" onclick="saveMedicalEdit()">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="smart-import-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] flex items-center justify-center p-4" onclick="if(event.target.id === 'smart-import-modal') toggleModal('smart-import-modal')">
    <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300 flex flex-col max-h-[90vh]">
        
        <div class="p-6 theme-pink text-white flex justify-between items-center flex-shrink-0">
            <h3 class="font-black flex items-center">
                <span class="mr-3 text-xl">ğŸ§ </span>
                <span class="text-lg tracking-tight">è¦åŠƒå·¥åŠï¼šæ™ºæ…§åŒ¯å…¥é è¦½</span>
            </h3>
            <button onclick="toggleModal('smart-import-modal')" class="text-white/80 hover:text-white transition">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg>
            </button>
        </div>

        <div class="px-6 py-4 bg-gray-50 border-b border-gray-100 flex-shrink-0">
            <div class="relative mb-3">
                <input type="text" id="preview-search-input" oninput="filterPreviewItems()" 
                       placeholder="ğŸ” æœå°‹åº—åã€åœ°å€æˆ–ç‰¹è‰²é—œéµå­—..." 
                       class="w-full p-3 pl-10 bg-white border border-gray-200 rounded-2xl text-sm focus:ring-2 theme-border-pink outline-none shadow-sm transition-all">
            </div>
            <div id="preview-tag-cloud" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto no-scrollbar"></div>
        </div>

        <div class="p-6 overflow-y-auto bg-white flex-grow">
            <p class="text-[11px] font-black text-gray-400 uppercase tracking-widest mb-4 flex justify-between">
                <span>æª¢è¦–è¾¨è­˜çµæœ</span>
                <span id="preview-count-tag">åµæ¸¬åˆ° 0 ç­†</span>
            </p>
            <div id="import-preview-list" class="space-y-4">
                </div>
        </div>

        <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end space-x-3 flex-shrink-0">
            <button onclick="toggleModal('smart-import-modal')" class="px-6 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-full transition">å–æ¶ˆ</button>
            <button onclick="confirmAndMoveToPrivate()" class="px-8 py-2 theme-pink text-white rounded-full font-bold shadow-lg active:scale-95 transition-all">ç¢ºèªåŒ¯å…¥ç§æœ‰åº«</button>
        </div>
    </div>
</div>


<div id="dictionary-manager-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] flex items-center justify-center p-4" onclick="if(event.target.id === 'dictionary-manager-modal') toggleModal('dictionary-manager-modal')">
    <div class="bg-white rounded-3xl w-full max-w-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300 flex flex-col max-h-[85vh]">
        
        <div class="p-6 bg-slate-800 text-white flex justify-between items-center">
            <h3 class="font-black flex items-center">
                <span class="mr-3 text-xl">ğŸ“–</span>
                <span class="text-lg tracking-tight">å…¨çƒèªæ„æ¨™ç±¤å­—å…¸</span>
            </h3>
            <button onclick="toggleModal('dictionary-manager-modal')" class="text-white/80 hover:text-white transition">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg>
            </button>
        </div>

        <div class="p-6 overflow-y-auto bg-gray-50 flex-grow">
            <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm mb-6">
                <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">æ–°å¢è‡ªå®šç¾©æ¨™ç±¤</h4>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="new-tag-name" placeholder="æ¨™ç±¤åç¨± (å¦‚: å±…é…’å±‹)" class="p-2 border border-gray-200 rounded-xl text-sm focus:ring-2 theme-border-pink outline-none">
                    <select id="new-tag-parent" class="p-2 border border-gray-200 rounded-xl text-sm">
                        <option value="é£Ÿ">ğŸ² å¤§é¡ï¼šé£Ÿ</option>
                        <option value="è¡£">ğŸ›ï¸ å¤§é¡ï¼šè¡£</option>
                        <option value="ä½">ğŸ¨ å¤§é¡ï¼šä½</option>
                        <option value="è¡Œ">ğŸšŒ å¤§é¡ï¼šè¡Œ</option>
                        <option value="è‚²">ğŸ›ï¸ å¤§é¡ï¼šè‚²</option>
                        <option value="æ¨‚">ğŸŒ³ å¤§é¡ï¼šæ¨‚</option>
                    </select>
                </div>
                <input type="text" id="new-tag-keywords" placeholder="è¾¨è­˜é—œéµå­— (ç”¨é€—è™Ÿéš”é–‹ï¼Œå¦‚: é…’å ´, ä¸²ç‡’, BAR)" class="w-full p-2 border border-gray-200 rounded-xl text-sm mb-3 focus:ring-2 theme-border-pink outline-none">
                <button onclick="addNewTagToDict()" class="w-full py-2 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-black transition">å„²å­˜è‡³å­—å…¸åº«</button>
            </div>

            <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3 px-1">ç¾æœ‰è¾¨è­˜è¦å‰‡</h4>
            <div id="dict-list-container" class="space-y-2"></div>
        </div>
    </div>
</div>


<div id="smart-diff-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[10001] flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden animate-in zoom-in-95 flex flex-col max-h-[90vh]">
        
        <div class="p-6 bg-slate-900 text-white flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div>
                    <h3 class="font-black text-lg leading-none">æ•¸ä½åŒ…è£¹è§£æ</h3>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-bold">Smart Data Compare</p>
                </div>
            </div>
            <button onclick="toggleModal('smart-diff-modal')" class="text-slate-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round"/></svg>
            </button>
        </div>

        <div class="px-6 py-2 bg-blue-50 border-b border-blue-100 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="flex h-2 w-2 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                </span>
                <p class="text-[10px] text-blue-700 font-bold uppercase tracking-wider">æ­£åœ¨æª¢ç´¢é ç«¯æ•¸æ“šæŒ‡ç´‹...</p>
            </div>
            <span class="text-[9px] text-blue-400 font-mono">READY</span>
        </div>

        <div class="bg-slate-50 p-6 overflow-hidden flex flex-col flex-grow">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <p class="text-xs text-slate-500 font-bold">åµæ¸¬åˆ°èˆ‡æœ¬æ©Ÿè³‡æ–™çš„å·®ç•°ï¼š</p>
                <div class="flex gap-3">
                    <button onclick="toggleAllDiffs(true)" class="text-[10px] theme-text-pink font-black hover:underline">å…¨é¸</button>
                    <button onclick="toggleAllDiffs(false)" class="text-[10px] text-slate-400 font-black hover:underline">å–æ¶ˆ</button>
                </div>
            </div>
            
            <div id="diff-list-container" class="modal-scroll-area space-y-3 flex-grow overflow-y-auto pr-1">
                </div>
        </div>

        <div class="p-6 bg-white border-t border-slate-100 flex-shrink-0">
            <div class="flex gap-3">
                <button onclick="toggleModal('smart-diff-modal')" 
                        class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold text-xs hover:bg-slate-200 transition-all active:scale-95">
                    æ”¾æ£„åŒ¯å…¥
                </button>
                <button onclick="applySmartMerge()" 
                        class="flex-[1.5] py-4 theme-pink text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all">
                    å¥—ç”¨é¸å–è®Šå‹•
                </button>
            </div>
            <p class="text-center text-[9px] text-slate-300 mt-4 uppercase tracking-tighter">ç›¸åŒé …ç›®èˆ‡ç„¡æ•ˆæ•¸æ“šå·²è¢«è‡ªå‹•å¿½ç•¥</p>
        </div>
    </div>
</div>

<div id="transport-hub-modal" class="fixed inset-0 z-[10000] hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="toggleModal('transport-hub-modal')"></div>
    
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-2xl bg-white rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        
        <div class="p-6 bg-slate-900 text-white flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <span class="text-2xl">ğŸš‰</span>
                </div>
                <div>
                    <h3 class="text-lg font-black leading-none">äº¤é€šè·¯ç¶²ä¸­å¿ƒ</h3>
                    <p class="text-[10px] text-blue-400 mt-1 uppercase tracking-widest font-bold">Network Management Engine</p>
                </div>
            </div>
            <button onclick="toggleModal('transport-hub-modal')" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition-all text-xl">&times;</button>
        </div>

        <div class="flex-grow overflow-y-auto p-6 space-y-6 bg-slate-50">
            
            <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-tighter">ğŸš€ ç‡ƒæ–™åŒ…æ³¨å…¥</h4>
                    <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-bold uppercase">JSON Standard</span>
                </div>
                <textarea id="transport-import-input" 
                    class="w-full h-24 p-4 text-xs font-mono bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none"
                    placeholder='è²¼å…¥ AI ç”Ÿæˆçš„ JSON äº¤é€šæ•¸æ“š...'></textarea>
                <button onclick="importTransportFuel()" 
                    class="w-full mt-3 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                    âš¡ æ³¨å…¥è·¯ç¶²æ•¸æ“š
                </button>
            </div>

            <div class="space-y-4">
                <div class="flex flex-col gap-3 px-1">
                    <div class="flex justify-between items-center">
                        <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-1 h-3 bg-emerald-500 rounded-full"></span>
                            ç¾å½¹è·¯ç¶²è³‡ç”¢
                        </h4>
                        <div class="text-[10px] font-bold text-slate-400" id="transport-count-tag">0 æ¢ç·šè·¯</div>
                    </div>
                    
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <input type="text" id="transport-search" oninput="renderTransportHub()" 
                                placeholder="æœå°‹æ¥­è€…æˆ–ç·šè·¯ç·¨è™Ÿ..." 
                                class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                            <span class="absolute left-3 top-2.5 opacity-30 text-xs">ğŸ”</span>
                        </div>
                        <select id="transport-filter-op" onchange="renderTransportHub()" 
                            class="bg-white border border-slate-200 rounded-xl text-[10px] px-3 outline-none font-black text-slate-600 cursor-pointer">
                            <option value="all">æ‰€æœ‰æ¥­è€…</option>
                        </select>
                    </div>
                </div>

                <div id="transport-vault-list" class="grid grid-cols-1 gap-2">
                    <div class="p-12 text-center bg-white rounded-[2rem] border-2 border-dashed border-slate-200 text-slate-400 text-xs italic">
                        ç›®å‰è·¯ç¶²ç©ºç„¡ä¸€ç‰©ï¼Œè«‹ç”±ä¸Šæ–¹å°å…¥è³‡æ–™åŒ…
                    </div>
                </div>
            </div>

        </div>

        <div class="p-5 bg-white border-t border-slate-100 flex gap-3 flex-shrink-0">
            <button onclick="clearTransportVault()" class="flex-1 py-3 text-[11px] font-black text-red-500 hover:bg-red-50 rounded-2xl transition-all border border-transparent hover:border-red-100">
                ğŸ—‘ï¸ æ¸…ç©ºå…¨åŸŸè·¯ç¶²
            </button>
            <button onclick="toggleModal('transport-hub-modal')" class="flex-[1.5] py-3 text-[11px] font-black text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-2xl transition-all">
                é—œé–‰ç®¡ç†ä¸­å¿ƒ
            </button>
        </div>
    </div>
</div>


<div id="export-wizard-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-[10000] flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden animate-in zoom-in-95 flex flex-col max-h-[90vh]">
        
        <div class="p-6 bg-slate-900 text-white flex justify-between items-center shadow-lg relative z-20 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-pink-500 rounded-2xl flex items-center justify-center shadow-lg shadow-pink-500/30">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div>
                    <h3 class="font-black text-lg leading-none">æ™ºæ…§åŒ¯å‡º</h3>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-bold">Smart Export Wizard</p>
                </div>
            </div>
            <button onclick="toggleModal('export-wizard-modal')" class="opacity-70 hover:opacity-100 p-2 transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round"/></svg>
            </button>
        </div>
        
        <div class="modal-scroll-area p-6 space-y-6 bg-slate-50/50 flex-grow">
            
            <section>
                <div class="flex justify-between items-center mb-3 px-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">1. é¸æ“‡è¦åŒ¯å‡ºçš„è¡Œç¨‹</label>
                    <button onclick="toggleSelectAllTrips()" class="text-[10px] theme-text-pink font-black hover:underline">å…¨é¸ / å–æ¶ˆ</button>
                </div>
                <div id="export-trip-options" class="space-y-2">
                    </div>
            </section>

            <section class="border-t border-gray-200 pt-5">
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">2. å…§å®¹éæ¿¾èˆ‡çµ„ä»¶</label>
                
                <div class="grid grid-cols-1 gap-2 mb-4">
                    <label class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-2xl cursor-pointer hover:border-pink-300 transition-all shadow-sm">
                        <span class="text-xs font-bold text-gray-700">âœï¸ åŒ…å«æ™¯é»è©³ç´°ç­†è¨˜</span>
                        <input type="checkbox" id="share-notes" checked class="w-5 h-5 rounded-full text-pink-500 border-gray-300 focus:ring-pink-500">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-2xl cursor-pointer hover:border-pink-300 transition-all shadow-sm">
                        <span class="text-xs font-bold text-gray-700">ğŸšŒ åŒ…å«äº¤é€šè½‰ä¹˜ç´°ç¯€</span>
                        <input type="checkbox" id="share-transport" checked class="w-5 h-5 rounded-full text-pink-500 border-gray-300 focus:ring-pink-500">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-2xl cursor-pointer hover:border-pink-300 transition-all shadow-sm">
                        <span class="text-xs font-bold text-gray-700">ğŸ’° åŒ…å«é ç®—æ”¯å‡ºæ˜ç´°</span>
                        <input type="checkbox" id="share-expenses" class="w-5 h-5 rounded-full text-pink-500 border-gray-300 focus:ring-pink-500">
                    </label>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <label class="flex flex-col items-center gap-1 p-2 bg-blue-50 border border-blue-100 rounded-xl cursor-pointer">
                        <input type="checkbox" id="exp-inc-bucket" checked class="w-4 h-4 rounded text-blue-500">
                        <span class="text-[9px] font-black text-blue-700">å‚™é¸æ¸…å–®</span>
                    </label>
                    <label class="flex flex-col items-center gap-1 p-2 bg-blue-50 border border-blue-100 rounded-xl cursor-pointer">
                        <input type="checkbox" id="exp-inc-dict" checked class="w-4 h-4 rounded text-blue-500">
                        <span class="text-[9px] font-black text-blue-700">è¾¨è­˜å­—å…¸</span>
                    </label>
                    <label class="flex flex-col items-center gap-1 p-2 bg-indigo-50 border border-indigo-100 rounded-xl cursor-pointer">
                        <input type="checkbox" id="exp-inc-workshop" checked class="w-4 h-4 rounded text-indigo-500">
                        <span class="text-[9px] font-black text-indigo-700">å·¥åŠè—åœ–</span>
                    </label>
                </div>
            </section>

            <section class="border-t border-gray-200 pt-5 pb-2">
                <label class="text-[10px] font-black text-amber-600 uppercase tracking-widest block mb-3">ğŸ”’ å®‰å…¨èˆ‡éš±ç§ä¿è­·</label>
                <div class="space-y-2">
                    <label class="flex justify-between items-center p-3 bg-amber-50/50 border border-amber-100 rounded-2xl cursor-pointer">
                        <span class="text-xs text-amber-900 font-bold">éš±è—å…¨åŸŸ API Key</span>
                        <input type="checkbox" id="exp-sec-api" checked class="w-4 h-4 text-amber-600 border-gray-300">
                    </label>
                    <label class="flex justify-between items-center p-3 bg-amber-50/50 border border-amber-100 rounded-2xl cursor-pointer">
                        <span class="text-xs text-amber-900 font-bold">é®è”½ä½å®¿é›»è©±èˆ‡åœ°å€</span>
                        <input type="checkbox" id="exp-sec-phone" checked class="w-4 h-4 text-amber-600 border-gray-300">
                    </label>
                </div>
            </section>
        </div>

        <div class="p-6 bg-white border-t border-gray-100 grid grid-cols-2 gap-3 flex-shrink-0 relative z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button onclick="startSmartExport('share')" class="py-4 bg-white border-2 theme-border-pink theme-text-pink rounded-2xl font-black text-xs hover:bg-pink-50 transition-all active:scale-95">
                ğŸ”— ç”Ÿæˆåˆ†äº«é€£çµ
            </button>
            <button onclick="startSmartExport('file')" class="py-4 theme-pink text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all">
                ğŸ’¾ å„²å­˜ JSON æª”
            </button>
        </div>
    </div>
</div>
   
<script>

/** ğŸ›¡ï¸ IndexedDB æ ¸å¿ƒç®¡ç†æ¨¡çµ„ (v3.3.0 å¤§ä¸€çµ±æ“´å»ºç‰ˆ)
 * æ•´åˆï¼šå…¨æ¨¡çµ„ç‰©ç†æˆ¿é–“å»ºç«‹ã€æ”¯æŒé…ç½®/åœ–ç¤º/åœ°ç†/çŸ©é™£/è·¯ç¶²çš„è³‡æ–™åº«åŒ–
 * æˆ°ç•¥ç›®çš„ï¼šå»ºç«‹ Single Source of Truthï¼Œç¢ºä¿æ‰€æœ‰ç‡ƒæ–™åº«å…±ç”¨å¯¦é«”ç©ºé–“
 */
const dbManager = {
    dbName: 'TravelAppDB',
    // ğŸš€ æŒ‡æ®å®˜ï¼šç‰ˆæœ¬é–å®šç‚º 8ï¼Œç¢ºä¿è§¸ç™¼æ‰€æœ‰å…±ç”¨æˆ¿é–“çš„ç‰©ç†å»ºç½®
    dbVersion: 8, 
    db: null,

    async init() {
        return new Promise((resolve, reject) => {
            console.log(`ğŸ“¡ [ç‰©ç†å°ä½] æ­£åœ¨é–‹å•Ÿè³‡æ–™åº«: ${this.dbName} (ç‰ˆæœ¬ ${this.dbVersion})...`);
            const request = indexedDB.open(this.dbName, this.dbVersion);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                console.log(`ğŸ› ï¸ [ç‰©ç†æ“´å»º] åµæ¸¬åˆ°æ¶æ§‹æ›´æ–°: ${event.oldVersion} -> ${event.newVersion}`);
                
                /** * ğŸ“Š æˆ°ç•¥æˆ¿é–“æ¸…å–®ï¼šå®šç¾©æ‰€æœ‰å…±ç”¨ç‡ƒæ–™åº«çš„ç‰©ç†åˆ†é 
                 * æ¯å€‹æˆ¿é–“æ ¹æ“šå…¶ã€Œå–®ä¸€äº‹å¯¦ä¾†æºã€çš„éœ€æ±‚è¨­å®šå°æ‡‰çš„ä¸»éµ (keyPath)
                 */
                const stores = [
                    { name: 'private_store', key: 'id' },          // ä¸»å¿«ç…§ (main_state) èˆ‡è¡Œç¨‹è³‡ç”¢
                    { name: 'public_store', key: 'id' },           // å…¬é–‹åˆ†äº«æ•¸æ“šç©ºé–“
                    { name: 'staging_store', key: 'id' },          // è‡ªå‹•å‚™ä»½èˆ‡æ­·å²é‚„åŸé»
                    { name: 'dictionary_store', key: 'tag' },      // AI èªæ„è¾¨è­˜å­—å…¸ (Key: æ¨™ç±¤å)
                    { name: 'translations_store', key: 'id' },     // ç¿»è­¯æ”¶è—åŒ£å°ˆå±¬åº«
                    { name: 'transport_store', key: 'id' },        // ğŸš‰ äº¤é€šè·¯ç¶²ä¸­å¿ƒ (Key: æ¥­è€…_ç·šè·¯ID)
                    { name: 'matrix_store', key: 'routeKey' },     // â³ ç§»å‹•æ¬Šé‡çŸ©é™£ (Key: èµ·é»-çµ‚é»)
                    { name: 'config_store', key: 'id' },           // å…¨åŸŸ UI é…ç½® (é…è‰²ã€é ç®—åˆ†é¡)
                    { name: 'icon_store', key: 'keyword' },        // ğŸ¨ äº¤é€šå·¥å…·åœ–ç¤ºæ˜ å°„ (Key: é—œéµå­—)
                    { name: 'geo_regions_store', key: 'regionName' } // ğŸŒ åœ°ç†æŒ‡ç´‹å€åŸŸ (Key: æ¨™æº–å€å)
                ];

                stores.forEach(s => {
                    if (!db.objectStoreNames.contains(s.name)) {
                        db.createObjectStore(s.name, { keyPath: s.key });
                        console.log(`âœ… [DBæˆ¿é–“å»ºç«‹] ${s.name} å·²é–å®šç‰©ç†ç£å€`);
                    }
                });
            };

            request.onsuccess = (event) => {
                this.db = event.target.result;
                console.log(`âœ… IndexedDB ç‰©ç†åˆ†é å…¨æ•¸é–å®šå®Œæˆ (v${this.db.version})`);
                resolve(this.db);
            };

            request.onerror = (event) => {
                console.error("âŒ è³‡æ–™åº«æ ¸å¿ƒå•Ÿå‹•å¤±æ•—:", event.target.error);
                reject(event.target.error);
            };

            request.onblocked = () => {
                console.warn("ğŸš¨ åˆ†é è¡çªï¼è«‹é—œé–‰å…¶ä»–æ‰€æœ‰æ¨™ç±¤é ä»¥å¥—ç”¨å…¨åŸŸè³‡æ–™åº«å‡ç´šã€‚");
                alert("ğŸš¨ ç³»çµ±æª¢æ¸¬åˆ°ç‰©ç†æ¶æ§‹æ›´æ–°ï¼Œè«‹é—œé–‰å…¶ä»–åˆ†é ä»¥å®Œæˆå…±ç”¨è³‡æ–™åº«å»ºç½®ï¼");
            };
        });
    },

    /** ğŸ’‰ å¼·æ¬Šå¯«å…¥ï¼šç›´æ¥å°ç‰©ç†æˆ¿é–“é€²è¡Œæ•¸æ“šæ³¨å…¥ */
    save(storeName, data) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("è³‡æ–™åº«æœªå°±ç·’");
            try {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(true);
                request.onerror = (event) => reject(event.target.error);
            } catch (e) {
                console.error(`âŒ [ç‰©ç†å¯«å…¥å¤±æ•—] ${storeName}:`, e);
                reject(e);
            }
        });
    },

    /** ğŸ” ç‰©ç†æ¢é‡ï¼šè®€å–ç‰¹å®šåˆ†é çš„æ‰€æœ‰è³‡æ–™ */
    getAll(storeName) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("è³‡æ–™åº«æœªå°±ç·’");
            try {
                if (!this.db.objectStoreNames.contains(storeName)) return resolve([]);
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            } catch (e) {
                resolve([]);
            }
        });
    },

    /** ğŸ¯ ç²¾æº–æå–ï¼šè®€å–å–®ä¸€ç‰©ç†ä¸»éµè³‡æ–™ */
    get(storeName, id) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("è³‡æ–™åº«æœªå°±ç·’");
            try {
                if (!this.db.objectStoreNames.contains(storeName)) return resolve(null);
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            } catch (e) {
                resolve(null);
            }
        });
    },

    /** ğŸ—‘ï¸ åŸå­æ¸…ç©ºï¼šç‰©ç†æ’¤ç·¨ç‰¹å®šåˆ†é  */
    clear(storeName) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("è³‡æ–™åº«æœªå°±ç·’");
            try {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve(true);
                request.onerror = (event) => reject(event.target.error);
            } catch (e) {
                reject(e);
            }
        });
    }
};

/** ğŸŒ ä¹å·åœ°ç†çœŸç†é‡é‘„å¼•æ“ (v4.9 æ•´åˆç‰ˆ)
 * æˆ°ç•¥ç›®çš„ï¼šå¼·åˆ¶æ ¡æº– IndexedDB å…§çš„åœ°ç†æŒ‡ç´‹ï¼Œç¢ºä¿ç¶“ç·¯åº¦èˆ‡åˆ¥åæ ¼å¼ 100% å°ä½ã€‚
 */
async function rebuildGeoStructure() {
    console.log("%cğŸ“¡ å•Ÿå‹•åœ°ç†çµæ§‹é‡é‘„ç¨‹åº...", "color: #3b82f6; font-weight: bold;");

    // 1. å®šç¾© 16 ç­†çœŸç†åº§æ¨™çŸ©é™£ (ä¹å·æ ¸å¿ƒ + å¸¸ç”¨ç¯€é»)
    const GEO_REPAIR_KIT = {
        "ç¦å²¡": { lng: 130.4017, lat: 33.5902, aliases: ["Fukuoka", "ç¦å´—"] },
        "åšå¤š": { lng: 130.4206, lat: 33.5897, aliases: ["Hakata"] },
        "ç”±å¸ƒé™¢": { lng: 131.3562, lat: 33.2625, aliases: ["Yufuin"] },
        "é˜¿è˜‡": { lng: 131.0811, lat: 32.9375, aliases: ["Aso"] },
        "ç†Šæœ¬": { lng: 130.7079, lat: 32.7898, aliases: ["Kumamoto"] },
        "åˆ¥åºœ": { lng: 131.4912, lat: 33.2845, aliases: ["Beppu"] },
        "å°å€‰": { lng: 130.8815, lat: 33.8814, aliases: ["Kokura"] },
        "é–€å¸æ¸¯": { lng: 130.9622, lat: 33.9454, aliases: ["Mojiko"] },
        "ä½ä¸–ä¿": { lng: 129.7151, lat: 33.1799, aliases: ["Sasebo"] },
        "å®®å´": { lng: 131.4239, lat: 31.9077, aliases: ["Miyazaki"] },
        "å®®å³¶": { lng: 132.3200, lat: 34.2975, aliases: ["Miyajima"] },
        "å®®å³¶å£": { lng: 132.3100, lat: 34.3100, aliases: ["Miyajimaguchi"] },
        "æ±äº¬": { lng: 139.6917, lat: 35.6895, aliases: ["Tokyo"] },
        "é•·å´": { lng: 129.8773, lat: 32.7503, aliases: ["Nagasaki"] },
        "é¹¿å…’å³¶": { lng: 130.5571, lat: 31.5966, aliases: ["Kagoshima"] },
        "å°åŒ—": { lng: 121.5644, lat: 25.0330, aliases: ["Taipei"] }
    };

    try {
        // 2. ç‰©ç†ç£å€å¤§æƒé™¤ (æ¸…ç©ºèˆŠæœ‰æå£æŒ‡ç´‹)
        if (dbManager.db) {
            await dbManager.clear('geo_regions_store');
            console.log("ğŸ§¹ èˆŠæœ‰åœ°ç†ç£å€å·²æ¸…ç©ºã€‚");
            
            // 3. é€ç­†å›ºåŒ–æ­£ç¢ºæ•¸æ“š
            for (const [name, data] of Object.entries(GEO_REPAIR_KIT)) {
                await dbManager.save('geo_regions_store', {
                    regionName: name,
                    aliases: data.aliases || [], // ğŸŒŸ è§£æ±º .some() å ±éŒ¯çš„æ ¸å¿ƒï¼šå¼·åˆ¶ Array
                    lng: data.lng,
                    lat: data.lat,
                    zoom: 12
                });
            }
            console.log(`âœ… å·²å®Œæˆ ${Object.keys(GEO_REPAIR_KIT).length} ç­†ç‰©ç†æŒ‡ç´‹å›ºåŒ–ã€‚`);
            
            // 4. ç«‹å³åŒæ­¥å›è¨˜æ†¶é«” (window.GEO_REGIONS)
            if (typeof syncGeoRegionsToMemory === 'function') {
                await syncGeoRegionsToMemory();
            }
            
            // 5. å°‡ä¿®æ­£å¾Œçš„çµæœå¯«å…¥å¿«ç…§ï¼Œé˜²æ­¢è¢«èˆŠæ•¸æ“šè¦†è“‹
            await saveData(true);
        }
    } catch (e) {
        console.error("âŒ ç‰©ç†é‡é‘„å¤±æ•—:", e);
    }
}

/** ğŸ§  å…¨æ¨¡çµ„é…ç½®å›å¡« (v1.1.0)
 * ä½œç”¨ï¼šå¾ç‰©ç†æˆ¿é–“æå–é…è‰²ã€åœ–ç¤ºã€åœ°ç†æŒ‡ç´‹èˆ‡çŸ©é™£ï¼Œé‡å»ºå…¨åŸŸå¤§è…¦é…ç½®ã€‚
 * ç‰¹è‰²ï¼šç‰©ç†å„ªå…ˆï¼Œè‹¥è³‡æ–™åº«ç‚ºç©ºå‰‡ä¿ç•™é è¨­å€¼ã€‚
 */
async function loadDefinitions() {
    console.log("ğŸ“¡ å•Ÿå‹•å…¨ç³»çµ±é…ç½®å›å¡« (ä»²è£æ¨¡å¼)...");

    try {
        // 1. å›å¡«åœ°ç†æŒ‡ç´‹ (F & GEO_REGIONS)
        // å¾ geo_regions_store æå–å€åŸŸåˆ¥åèˆ‡æŒ‡ç´‹
        const geoData = await dbManager.getAll('geo_regions_store');
        if (geoData && geoData.length > 0) {
            window.GEO_REGIONS = geoData.reduce((acc, curr) => {
                acc[curr.regionName] = curr.aliases;
                return acc;
            }, {});
            console.log(`ğŸŒ åœ°ç†æŒ‡ç´‹ç‰©ç†åŒ–ï¼šå·²è¼‰å…¥ ${geoData.length} ç­†å€åŸŸ`);
        }

        // 2. å›å¡«åœ–ç¤ºæ˜ å°„ (C - TRANSPORT_ICONS)
        // ç¢ºä¿ä¸åŒäº¤é€šå·¥å…·çš„ Emoji å°ä½
        const iconData = await dbManager.getAll('icon_store');
        if (iconData && iconData.length > 0) {
            window.TRANSPORT_ICONS = iconData.reduce((acc, curr) => {
                acc[curr.keyword] = curr.icon;
                return acc;
            }, {});
            console.log(`ğŸ¨ äº¤é€šåœ–ç¤ºç‰©ç†åŒ–ï¼šå·²è¼‰å…¥ ${iconData.length} ç­†æ˜ å°„`);
        }

        // 3. å›å¡«æ™‚é–“æ¬Šé‡çŸ©é™£ (TRAVEL_TIME_MATRIX)
        // æ ¸å¿ƒï¼šè¨ºæ–·å¤§è…¦è¨ˆç®—è·¨å€è¡çªçš„åŸºæº–æ•¸æ“š
        const matrixData = await dbManager.getAll('matrix_store');
        if (matrixData && matrixData.length > 0) {
            window.TRAVEL_TIME_MATRIX = matrixData.reduce((acc, curr) => {
                acc[curr.routeKey] = curr.time;
                return acc;
            }, {});
            console.log(`â³ ç§»å‹•çŸ©é™£ç‰©ç†åŒ–ï¼šå·²è¼‰å…¥ ${matrixData.length} ç­†æ¬Šå¨æ¬Šé‡`);
        }

        // 4. å›å¡« UI é…ç½® (A, B, E, G)
        // åŒ…æ‹¬ THEME_COLORS, MASTER_CATEGORIES, TRANSPORT_OPERATOR_CONFIG
        const configs = await dbManager.getAll('config_store');
        if (configs && configs.length > 0) {
            configs.forEach(conf => {
                if (conf.id) {
                    window[conf.id] = conf.data;
                    console.log(`âš™ï¸ é…ç½®é … [${conf.id}] å·²å›å¡«è¨˜æ†¶é«”`);
                }
            });
        }

        // ğŸŒŸ 5. è·¯ç¶²ä¸­å¿ƒè¨˜æ†¶é«”å°ç„¦
        // ç¢ºä¿ window.state.transportVault èˆ‡å¯¦é«”æˆ¿é–“å…§å®¹åŒæ­¥
        const transportData = await dbManager.getAll('transport_store');
        if (transportData && transportData.length > 0) {
            if (!window.state) window.state = {};
            window.state.transportVault = transportData;
            console.log(`ğŸš‰ å¯¦é«”è·¯ç¶²é–å®šï¼šå·²è¼‰å…¥ ${transportData.length} æ¢ç·šè·¯è³‡ç”¢`);
        }

        console.log(`âœ… [å¤§ä¸€çµ±å›å¡«å®Œæˆ] ç³»çµ±å®šç¾©å·²é‡æ•´ | åœ°ç†: ${Object.keys(window.GEO_REGIONS || {}).length} | çŸ©é™£: ${Object.keys(window.TRAVEL_TIME_MATRIX || {}).length}`);
        
    } catch (e) {
        console.error("âŒ å…¨æ¨¡çµ„å›å¡«å¤±æ•—:", e);
    }
}

/** ğŸšš æ——è‰¦ç§»æ°‘å®˜ (v1.2.1)
 * ä½œç”¨ï¼šå°‡éœæ…‹å®šç¾©æ¬ç§»è‡³ IndexedDB ç‰©ç†ç£å€ã€‚
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [å¼·åŒ–] åœ–ç¤ºç§»æ°‘ï¼šæ¯”å° TRANSPORT_ICONS æ•¸é‡ï¼Œç¢ºä¿æŒ‡ç´‹ 100% è½åœ°ã€‚
 * 2. [å¼·åŒ–] çŸ©é™£ç§»æ°‘ï¼šç¢ºä¿ 21 ç­†æ¬Šå¨æ¬Šé‡åŒæ­¥ï¼Œæ”¯æ´è·¨å€æ™‚é–“è¨ºæ–·ã€‚
 * 3. [ç²¾æº–æ ¡æº–] åœ°ç†ç§»æ°‘ï¼šä¿®æ­£åŸæœ¬ coords:null éŒ¯èª¤ï¼ŒåŒæ­¥æ¬é‹ lng/lat å¯¦é«”åº§æ¨™ã€‚
 * 4. [æ·±åº¦ä»²è£] é…ç½®ç§»æ°‘ï¼šç¢ºä¿ THEME_COLORS ç­‰ UI æ ¸å¿ƒé…ç½®ä¸å› è³‡æ–™åº«æ®˜ç¼ºè€Œéºå¤±ã€‚
 */
async function migrateDefinitionsToDB() {
    console.log("%cğŸ“¡ å•Ÿå‹•å…¨ç³»çµ±é…ç½®ç‰©ç†ç§»æ°‘ç¨‹åº...", "color: #3b82f6; font-weight: bold;");

    try {
        // --- 1. é·ç§»äº¤é€šåœ–ç¤º (icon_store) ---
        const existingIcons = await dbManager.getAll('icon_store');
        const constantIcons = Object.entries(window.TRANSPORT_ICONS || {});
        
        if (existingIcons.length < constantIcons.length) {
            console.log(`ğŸ¨ åµæ¸¬åˆ°åœ–ç¤ºç£å€ç¼ºå£ (${existingIcons.length} < ${constantIcons.length})ï¼Œå•Ÿå‹•æŒ‡ç´‹è£œçµ¦...`);
            for (const [key, icon] of constantIcons) {
                await dbManager.save('icon_store', { keyword: key, icon: icon });
            }
            console.log("âœ… [ç§»æ°‘] äº¤é€šåœ–ç¤ºæ˜ å°„å·²å®Œæˆç‰©ç†é–å®š");
        }

        // --- 2. é·ç§»æ™‚é–“æ¬Šé‡çŸ©é™£ (matrix_store) ---
        const existingMatrix = await dbManager.getAll('matrix_store');
        const constantMatrix = Object.entries(window.TRAVEL_TIME_MATRIX || {});
        
        if (existingMatrix.length < constantMatrix.length) {
            console.log(`â³ åµæ¸¬åˆ°çŸ©é™£ç£å€ç¼ºå£ï¼Œæ­£åœ¨å¯«å…¥ ${constantMatrix.length} ç­†æ¬Šå¨æ¬Šé‡...`);
            for (const [route, time] of constantMatrix) {
                await dbManager.save('matrix_store', { routeKey: route, time: time });
            }
            console.log("âœ… [ç§»æ°‘] ç§»å‹•æ¬Šé‡çŸ©é™£å·²å®Œæˆç‰©ç†é–å®š");
        }

        // --- 3. é·ç§»åœ°ç†æŒ‡ç´‹ (geo_regions_store) ---
        // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šç¢ºä¿ä¸åƒ…é·ç§»åˆ¥åï¼Œä¹Ÿé·ç§»åº§æ¨™å¯¦é«” (lng/lat)
        const existingGeo = await dbManager.getAll('geo_regions_store');
        const targetGeoKeys = Object.keys(window.GEO_REGIONS || {}).filter(k => !k.endsWith('_coords'));

        if (existingGeo.length < targetGeoKeys.length) {
            console.log("ğŸŒ åµæ¸¬åˆ°åœ°ç†ç£å€ç¼ºå£ï¼Œå•Ÿå‹•ç²¾æº–åº§æ¨™ç§»æ°‘...");
            for (const name of targetGeoKeys) {
                const data = window.GEO_REGIONS[name];
                const coords = window.GEO_REGIONS[name + "_coords"] || {};
                
                await dbManager.save('geo_regions_store', { 
                    regionName: name, 
                    aliases: Array.isArray(data) ? data : (data.aliases || []), 
                    // å„ªå…ˆæå– _coords çµæ§‹ï¼Œè‹¥ç„¡å‰‡å˜—è©¦å¾ data æœ¬é«”æå–ï¼Œæœ€å¾Œä¿åº•ç‚º 0
                    lng: coords.lng || (typeof data === 'object' ? data.lng : 0),
                    lat: coords.lat || (typeof data === 'object' ? data.lat : 0),
                    zoom: coords.zoom || (typeof data === 'object' ? data.zoom : 11)
                });
            }
            console.log("âœ… [ç§»æ°‘] åœ°ç†æŒ‡ç´‹å€åŸŸåŠå…¶ç‰©ç†åº§æ¨™å·²å¯¦é«”åŒ–");
        }

        // --- 4. é·ç§» UI é…ç½® (config_store) ---
        const standardThemes = {
            "å¤§åœ°ç¶ ": "#2D5A27",
            "å¤©ç©ºè—": "#3A86FF",
            "å¤•é™½æ©™": "#FB5607",
            "ç«ç‘°ç²‰": "#FF006E",
            "è–°è¡£ç´«": "#8338EC",
            "æœˆå¤œç°": "#4A4E69"
        };

        const configTargets = [
            { id: 'THEME_COLORS', default: standardThemes },
            { id: 'MASTER_CATEGORIES', default: window.MASTER_CATEGORIES },
            { id: 'TRANSPORT_OPERATOR_CONFIG', default: window.TRANSPORT_OPERATOR_CONFIG }
        ];

        for (const target of configTargets) {
            const existingConfig = await dbManager.get('config_store', target.id);
            
            // ğŸŒŸ æ•¸é‡ä»²è£ï¼šè‹¥é…ç½®ä¸å­˜åœ¨æˆ– THEME_COLORS å°‘æ–¼ 6 ç¨®ï¼ŒåŸ·è¡Œå°ä½è¦†å¯«
            if (!existingConfig || (target.id === 'THEME_COLORS' && Object.keys(existingConfig.data || {}).length < 6)) {
                await dbManager.save('config_store', { 
                    id: target.id, 
                    data: target.default || window[target.id] 
                });
                console.log(`âš™ï¸ é…ç½®é … [${target.id}] å·²åŸ·è¡Œç‰©ç†å°ä½`);
            }
        }

        console.log("%cğŸ ç‰©ç†ç§»æ°‘ç¨‹åºåŸ·è¡Œå®Œç•¢ï¼Œç³»çµ±å·²é”æˆç‰©ç†å¤§ä¸€çµ±ã€‚", "color: #10b981; font-weight: bold;");
    } catch (e) {
        console.error("âŒ ç§»æ°‘ç¨‹åºç™¼ç”Ÿå´©æ½°:", e);
    }
}


// ==============================================================
// =================== ğŸ§  æ™ºæ…§èªæ„åœ°ç†è¾¨è­˜æ¨¡çµ„===================
// ==============================================================


// ç¬¬ä¸€çµ„ï¼šç”Ÿç”¢è€… (Dictionary Management)

// seedDictionary()ï¼šåˆå§‹åŒ–é è¨­å­—å…¸ã€‚
/** 1. [ç”Ÿç”¢è€…] å­—å…¸åˆå§‹åŒ–ï¼šç¢ºä¿è³‡æ–™åº«ä¸­æœ‰åŸºç¤è¾¨è­˜è¦å‰‡èˆ‡åœ°ç†æ¬„ä½ */
async function seedDictionary() {
    try {
        const existing = await dbManager.getAll('dictionary_store');
        if (existing.length === 0) {
            console.log("ğŸŒ± æ­£åœ¨åˆå§‹åŒ–å…¨çƒèªæ„åœ°ç†å­—å…¸...");
            for (const item of DEFAULT_DICTIONARY) {
                const enhancedItem = {
                    ...item,
                    area: item.area || "",
                    coords: item.coords || { lat: null, lng: null }
                };
                await dbManager.save('dictionary_store', enhancedItem);
            }
        }
        window.GLOBAL_DICT = await dbManager.getAll('dictionary_store');
    } catch (e) {
        console.error("å­—å…¸åˆå§‹åŒ–å¤±æ•—:", e);
    }
}

// addNewTagToDict()ï¼šæ‰‹å‹•å¢åŠ æ–°è¦å‰‡ï¼ˆå«åœ°ç†éŒ¨é»é ç•™ï¼‰ã€‚
/** 2. [ç”Ÿç”¢è€…] æ‰‹å‹•æ–°å¢å­—å…¸æ¨™ç±¤ï¼šå»ºç«‹è¾¨è­˜è¦å‰‡ä¸¦é ç•™åœ°ç†éŒ¨é» */
async function addNewTagToDict() {
    const name = document.getElementById('new-tag-name').value.trim();
    const parent = document.getElementById('new-tag-parent').value;
    const keywordsRaw = document.getElementById('new-tag-keywords').value.trim();

    if (!name || !keywordsRaw) {
        showMessage('è«‹å¡«å¯«å®Œæ•´æ¨™ç±¤èˆ‡é—œéµå­—', 'error');
        return;
    }

    const newEntry = {
        tag: name,
        parent: parent,
        keywords: keywordsRaw.split(/[,ï¼Œ]+/).map(k => k.trim().toUpperCase()),
        area: "", 
        coords: { lat: null, lng: null }
    };

    await dbManager.save('dictionary_store', newEntry);
    document.getElementById('new-tag-name').value = '';
    document.getElementById('new-tag-keywords').value = '';
    await renderDictList();
    showMessage(`æ¨™ç±¤ [${name}] å·²å­˜å…¥è¬èƒ½å­—å…¸`, 'success');
}

/** 3. [ç”Ÿç”¢è€…] æ¸²æŸ“å­—å…¸åˆ—è¡¨ - æ”¯æ´é»é–±ã€ç·¨è¼¯èˆ‡åˆªé™¤ */
async function renderDictList() {
    const container = document.getElementById('dict-list-container');
    if (!container) return;

    // ğŸŒŸ åŒæ­¥æ•¸æ“šï¼šå¾è³‡æ–™åº«è®€å–ä¸¦é–å®šè‡³å…¨åŸŸè¨˜æ†¶é«”
    const dict = await dbManager.getAll('dictionary_store');
    window.GLOBAL_DICT = dict; 

    if (dict.length === 0) {
        container.innerHTML = `
            <div class="text-center py-10 bg-white rounded-3xl border-2 border-dashed border-gray-100">
                <p class="text-gray-400 text-xs italic">å°šæœªå»ºç«‹è‡ªå®šç¾©è¾¨è­˜è¦å‰‡</p>
            </div>`;
        return;
    }

    // ğŸŒŸ åŸ·è¡Œå¡ç‰‡æ¸²æŸ“
    container.innerHTML = dict.map(item => `
        <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center group hover:border-pink-200 transition-all">
            <div class="flex items-center gap-4 min-w-0">
                <div class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center text-lg shadow-inner">
                    ${MASTER_CATEGORIES[item.parent]?.icon || 'ğŸ“'}
                </div>
                <div class="min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-black text-pink-500 bg-pink-50 px-1.5 py-0.5 rounded uppercase tracking-tighter">${item.parent}</span>
                        <h5 class="text-sm font-black text-slate-800">${item.tag}</h5>
                    </div>
                    <p class="text-[10px] text-slate-400 truncate mt-0.5">é—œéµå­—: ${item.keywords.join(', ')}</p>
                </div>
            </div>
            
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                <button onclick="editDictRule('${item.tag}')" class="p-2 text-slate-300 hover:text-blue-500 transition-colors" title="ç·¨è¼¯è¦å‰‡">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button onclick="deleteTagFromDict('${item.tag}')" class="p-2 text-slate-300 hover:text-red-500 transition-colors" title="åˆªé™¤è¦å‰‡">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

/** â• æ–°å¢æˆ–ã€Œæ›´æ–°ã€è¾¨è­˜è¦å‰‡ (ç‰©ç†åŒæ­¥ç‰ˆ) */
async function addNewDictRule() {
    const nameInput = document.getElementById('dict-new-tag'); // å°ä½æ‚¨çš„ HTML ID
    const parentSelect = document.getElementById('dict-new-parent'); // å°ä½æ‚¨çš„ HTML ID
    const keywordsInput = document.getElementById('dict-new-keywords'); // å°ä½æ‚¨çš„ HTML ID

    // æ³¨æ„ï¼šå¦‚æœæ‚¨çš„ HTML ID ä¸åŒï¼Œè«‹æ ¹æ“šæ‚¨æä¾›çš„åŸç¢¼ä¿®æ­£ï¼š
    // æ‚¨åŸç¢¼ä¸­çš„ ID åˆ†åˆ¥æ˜¯ï¼šdict-new-tag, dict-new-parent, dict-new-keywords
    
    const tag = nameInput.value.trim();
    const parent = parentSelect.value;
    const keywordsRaw = keywordsInput.value.trim();

    if (!tag || !keywordsRaw) {
        showMessage('è«‹å¡«å¯«å®Œæ•´æ¨™ç±¤åç¨±èˆ‡è¾¨è­˜é—œéµå­—', 'error');
        return;
    }

    // è™•ç†é—œéµå­—ï¼šæ”¯æ´å¤šç¨®åˆ†éš”ç¬¦ï¼Œè½‰ç‚ºå¤§å¯«é™£åˆ—
    const keywords = keywordsRaw.split(/[,ï¼Œ/ã€]+/).map(k => k.trim().toUpperCase()).filter(k => k);

    const newRule = { 
        tag, 
        parent, 
        keywords,
        lastUpdated: new Date().toISOString()
    };

    // 1. åŒæ­¥å…¨åŸŸè¨˜æ†¶é«”å¿«ç…§
    const existingIdx = window.GLOBAL_DICT.findIndex(d => d.tag === tag);
    if (existingIdx > -1) window.GLOBAL_DICT[existingIdx] = newRule;
    else window.GLOBAL_DICT.push(newRule);

    // 2. ç‰©ç†å¯«å…¥è³‡æ–™åº«å°ˆå±¬æˆ¿é–“ (dictionary_store)
    if (window.dbManager) {
        await dbManager.save('dictionary_store', newRule);
    }

    // 3. UI æ¸…ç†èˆ‡é‡ç¹ª
    nameInput.value = "";
    keywordsInput.value = "";
    renderDictList();
    
    // 4. è§¸ç™¼å…¨é‡å‚™ä»½å­˜æª”
    if (typeof saveData === 'function') await saveData();
    
    showMessage(`âœ… èªç¾©å¤§è…¦å·²æ›´æ–°è¦å‰‡ [${tag}]`, 'success');
}

/** âœï¸ ç·¨è¼¯é»é–±ï¼šå°‡è³‡æ–™å›å¡«è‡³ Modal é ‚éƒ¨çš„ç·¨è¼¯å€ */
function editDictRule(tagName) {
    const rule = window.GLOBAL_DICT.find(d => d.tag === tagName);
    if (rule) {
        // å°ä½æ‚¨çš„åŸç¢¼ ID
        document.getElementById('dict-new-tag').value = rule.tag;
        document.getElementById('dict-new-parent').value = rule.parent;
        document.getElementById('dict-new-keywords').value = rule.keywords.join(', ');
        
        // è¦–è¦ºå¼•å°ï¼šèšç„¦ä¸¦æ»¾å‹•åˆ°é ‚éƒ¨ç·¨è¼¯å€
        document.getElementById('dict-new-tag').focus();
        const scrollArea = document.getElementById('dictionary-manager-modal').querySelector('.overflow-y-auto');
        if (scrollArea) scrollArea.scrollTo({ top: 0, behavior: 'smooth' });
        
        showMessage(`æ­£åœ¨ç·¨è¼¯è¦å‰‡: ${tagName}`, 'info');
    }
}

/** ğŸ—‘ï¸ ç‰©ç†åˆªé™¤è¾¨è­˜è¦å‰‡ */
async function deleteDictRule(tagName) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ [${tagName}] è¦å‰‡å—ï¼Ÿ\nåˆªé™¤å¾Œï¼ŒåŒ¯å…¥æ­¤é—œéµå­—åœ°é»å°‡ä¸å†è‡ªå‹•æ­¸é¡ã€‚`)) return;

    try {
        // 1. å¾è³‡æ–™åº«å¯¦é«”ç§»é™¤
        if (window.dbManager && window.dbManager.db) {
            const tx = dbManager.db.transaction(['dictionary_store'], 'readwrite');
            const store = tx.objectStore('dictionary_store');
            store.delete(tagName);
            
            tx.oncomplete = async () => {
                // 2. æ›´æ–°è¨˜æ†¶é«”ç‹€æ…‹
                window.GLOBAL_DICT = window.GLOBAL_DICT.filter(d => d.tag !== tagName);
                
                // 3. åˆ·æ–°åˆ—è¡¨èˆ‡åŒæ­¥å­˜æª”
                renderDictList();
                if (typeof saveData === 'function') await saveData();
                showMessage('è¾¨è­˜è¦å‰‡å·²ç§»é™¤', 'info');
            };
        }
    } catch (e) {
        console.error("å­—å…¸ç‰©ç†åˆªé™¤å¤±æ•—:", e);
        showMessage("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£ç·š", "error");
    }
}

// deleteTagFromDict()ï¼šç§»é™¤ä¸å†éœ€è¦çš„è¦å‰‡ã€‚
/**  4. [ç”Ÿç”¢è€…] åˆªé™¤æ¨™ç±¤ */
async function deleteTagFromDict(tag) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¾¨è­˜è¦å‰‡ [${tag}] å—ï¼Ÿ`)) return;
    
    // IndexedDB åˆªé™¤é‚è¼¯
    const tx = dbManager.db.transaction(['dictionary_store'], 'readwrite');
    tx.objectStore('dictionary_store').delete(tag);
    
    tx.oncomplete = async () => {
        await renderDictList();
        showMessage('è¦å‰‡å·²ç§»é™¤', 'info');
    };
}


/** ğŸ§  æ™ºæ…§èªæ„è¾¨è­˜æ ¸å¿ƒ (v5.0 æ——è‰¦å°ä½ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. [æ¥µé€Ÿå°ä½]ï¼šå„ªå…ˆåˆ©ç”¨é è™•ç†çš„ searchFingerprint é€²è¡Œ O(1) æˆ– O(n) çš„å¿«é€Ÿæƒæã€‚
 * 2. [åº§æ¨™æ›è¼‰]ï¼šç¢ºä¿æ•‘å›çš„ 279 ç­†è³‡ç”¢ç¶“ç·¯åº¦èƒ½ç‰©ç†é–å®šã€‚
 * 3. [é‚è¼¯è§£è€¦]ï¼šå°‡äº¤é€š (è¡Œ) èˆ‡ä¸€èˆ¬æ™¯é» (é£Ÿç©è³¼) çš„åˆ¤å®šæ¬Šé™åˆ†é–‹ã€‚
 */
function recognizeSemantic(name, tags = [], notes = "") {
    if (!name) return { tag: 'ä¸€èˆ¬', parent: 'é£Ÿ', style: 'food', area: "", location: { lat: null, lng: null }, notes: "" };
    
    const upperName = name.trim().toUpperCase();
    const vault = window.state?.transportVault || [];
    const bucket = window.state?.bucketList || []; 
    const dict = window.GLOBAL_DICT || [];
    
    // ğŸ“¡ 1. æ ¸å¿ƒæ„Ÿæ‡‰çŸ©é™£ (å…­å¤§éµå¾‹ç¶­è­·)
    const autoSenseMap = {
        'è¡Œ': ["æ–°å¹¹ç·š", "ç‰¹æ€¥", "JR", "åœ°éµ", "å·´å£«", "BUS", "é§…", "è»Šç«™", "ç©ºæ¸¯", "èˆªç«™", "èˆ¹", "èµ°è·¯", "æ­¥è¡Œ"],
        'é†«': ["é†«é™¢", "ç—…é™¢", "HOSPITAL", "è¨ºæ‰€", "è—¥å±€", "è—¥å¦", "æ•‘æ€¥"],
        'é£Ÿ': ["æ‹‰éºµ", "ç‡’è‚‰", "å£½å¸", "å…§è‡Ÿé‹", "å±‹å°", "å®šé£Ÿ", "CAFÃ‰", "å’–å•¡", "ç‡’é³¥", "å±…é…’å±‹"],
        'ä½': ["é£¯åº—", "HOTEL", "æ°‘å®¿", "STAY", "INN", "æº«æ³‰æ—…é¤¨"],
        'ç©': ["å…¬åœ’", "ç¥ç¤¾", "å®®", "å¯º", "åŸ", "å±•æœ›å°", "æ™¯é»", "ä¸»é¡Œæ¨‚åœ’", "æº«æ³‰"],
        'è³¼': ["ç™¾è²¨", "MALL", "OUTLET", "è¶…å¸‚", "å”å‰è¨¶å¾·", "å•†åº—è¡—", "LOFT", "PARCO"]
    };

    // ğŸš€ Step 0. äº¤é€šè·¯ç¶²å„ªå…ˆå°ä½ (Vault-Match)
    const matchedRoute = vault.find(r => 
        upperName.includes(r.operator_id?.toUpperCase()) && 
        upperName.includes(r.line_id?.toUpperCase())
    );

    if (matchedRoute) {
        return {
            tag: `${matchedRoute.operator_id} ${matchedRoute.line_id}`,
            parent: 'è¡Œ',
            style: 'transport',
            area: matchedRoute.meta?.type || "äº¤é€š",
            location: { lat: null, lng: null },
            notes: matchedRoute.meta?.guide || notes || "",
            isVaultMatch: true 
        };
    }

    // ğŸš€ Step 1. é æ„Ÿæ‡‰åˆ†é¡ (Pre-Sense)
    let sensedParent = null;
    for (const [parent, keywords] of Object.entries(autoSenseMap)) {
        if (keywords.some(k => upperName.includes(k.toUpperCase()))) {
            sensedParent = parent;
            break; 
        }
    }

    // ğŸš€ Step 2. ç‰©ç†è³‡ç”¢æŒ‡ç´‹æƒæ (å„ªå…ˆæ¬Šï¼šBucketList > GlobalDict)
    // é€™è£¡ä½¿ç”¨æœå°‹æŒ‡ç´‹é€²è¡Œæ¯”å°ï¼Œç¢ºä¿ 279 ç­†è³‡ç”¢æ„Ÿæ‡‰ç²¾æº–
    const fullDict = [...bucket, ...dict];
    const match = fullDict.find(entry => {
        const nameMatch = entry.name && upperName.includes(entry.name.toUpperCase());
        const fingerprintMatch = entry.searchFingerprint && upperName.includes(entry.searchFingerprint.toUpperCase());
        return nameMatch || fingerprintMatch;
    });

    if (match) {
        let finalParent = match.parent || match.category || sensedParent;
        
        // éµå¾‹å¼·åˆ¶æ¨™æº–åŒ–
        if (['äº¤', 'äº¤é€š', 'è¡Œ'].includes(finalParent)) finalParent = 'è¡Œ';
        if (['é†«', 'è—¥'].includes(finalParent)) finalParent = 'é†«';
        if (['ç©', 'æ™¯', 'éŠ'].includes(finalParent)) finalParent = 'ç©';
        if (['è³¼', 'è²·'].includes(finalParent)) finalParent = 'è³¼';
        if (!finalParent) finalParent = sensedParent || 'é£Ÿ';

        const master = (typeof MASTER_CATEGORIES !== 'undefined') ? MASTER_CATEGORIES[finalParent] : null;

        return { 
            tag: match.name || match.tag, 
            parent: finalParent, 
            style: finalParent === 'è¡Œ' ? 'transport' : (match.style || master?.theme || 'food'),
            area: match.area || match.location || "",
            // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šåº§æ¨™è‡ªç™’åŒæ­¥
            location: match.coords || match.location || { lat: null, lng: null },
            notes: match.notes || notes || ""
        };
    }

    // ğŸš€ Step 3. ä¿åº•æ©Ÿåˆ¶
    if (sensedParent) {
        return { 
            tag: sensedParent, 
            parent: sensedParent, 
            style: sensedParent === 'è¡Œ' ? 'transport' : 'food', 
            area: "", 
            location: { lat: null, lng: null }, 
            notes: notes || "" 
        };
    }

    // çµ‚æ¥µå›é€€
    return { tag: 'ä¸€èˆ¬', parent: 'é£Ÿ', style: 'food', area: "", location: { lat: null, lng: null }, notes: notes || "" };
}


/** ğŸ”„ åŒæ­¥ç‰©ç†å­—å…¸è‡³å…¨åŸŸæ„Ÿæ‡‰å™¨ (v4.5 æ——è‰¦åˆ†é å°ä½ç‰ˆ)
 * ä½œç”¨ï¼šå°‡å…¨é‡ BucketList è³‡ç”¢é€²è¡Œã€Œèªæ„å°ä½ã€ï¼Œä¸¦ç¢ºä¿æœå°‹èˆ‡åˆ†é å¼•æ“åŒæ­¥ã€‚
 * ä¿®æ­£ï¼š
 * 1. [æœå°‹å„ªåŒ–]ï¼šç”Ÿæˆæ‰å¹³åŒ–æœå°‹ç‰¹å¾µå­—ä¸²ï¼Œæå‡ 279 ç­†è³‡ç”¢çš„æª¢ç´¢é€Ÿåº¦ã€‚
 * 2. [åˆ†é è¯å‹•]ï¼šåŒæ­¥å¾Œé‡ç½®é ç¢¼ï¼Œé˜²æ­¢åˆ†é é¡¯ç¤ºç•°å¸¸ã€‚
 * 3. [è‡ªç™’å°ä½]ï¼šæ“´å¤§å…­å¤§éµå¾‹çš„æ„Ÿæ‡‰ç¯„ç–‡ã€‚
 */
async function syncBucketToGlobalDict() {
    console.log("ğŸ“¡ [Vault-Sync] å•Ÿå‹•å­—å…¸ç‰©ç†æŒ‡ç´‹åŒæ­¥...");
    
    // 1. å®‰å…¨é‚Šç•Œæª¢æŸ¥
    if (!state.bucketList || state.bucketList.length === 0) {
        console.warn("âš ï¸ [Vault-Sync] ç‰©ç†æ¸…å–®ç‚ºç©ºï¼Œè·³éåŒæ­¥ã€‚");
        return;
    }

    // 2. æ¨™ç±¤æ¨™æº–åŒ–èˆ‡æ·±åº¦èªæ„å°ä½
    const normalizedBucket = state.bucketList.map(item => {
        // æå–åˆ†é¡æŒ‡ç´‹ (å„ªå…ˆé †åºï¼šcategory > customStyle > é è¨­)
        let parent = item.category || item.parent || (item.tags && item.tags[0]) || 'ç©';
        
        // ğŸŒŸ ç‰©ç†å°ä½ï¼šæ ¡æº–å…­å¤§éµå¾‹ (ä¿®æ­£æ¨™ç±¤èˆ‡ UI è† å›Šçš„ä¸€è‡´æ€§)
        if (['äº¤', 'äº¤é€š', 'è¡Œ', 'é‹', 'ç«™', 'è»Š'].includes(parent)) parent = 'è¡Œ';
        if (['é†«', 'é†«ç™‚', 'æ€¥', 'æ•‘', 'è—¥'].includes(parent)) parent = 'é†«';
        if (['æ™¯', 'è‚²', 'ç©', 'éŠ', 'ç¥ç¤¾', 'å¯º'].includes(parent)) parent = 'ç©';
        if (['è³¼', 'è²·', 'åº—', 'è¶…å•†', 'mall'].includes(parent)) parent = 'è³¼';
        if (['é£Ÿ', 'é¤', 'é£²', 'å’–', 'æ‹‰éºµ', 'å±‹å°'].includes(parent)) parent = 'é£Ÿ';
        if (['ä½', 'å®¿', 'åº—', 'é£¯åº—'].includes(parent)) parent = 'ä½';

        // ç”Ÿæˆæ‰å¹³åŒ–æœå°‹æŒ‡ç´‹ (å¤§å¹…æå‡æœå°‹å¼•æ“éˆæ•åº¦)
        const searchFingerprint = [
            item.name,
            item.location || item.area || "",
            item.notes || "",
            item.customStyle || "",
            parent
        ].join(' ').toLowerCase();

        return {
            ...item,
            parent: parent,
            category: parent, // é›™é‡é–å®šåˆ†é¡å±¬æ€§
            searchFingerprint: searchFingerprint // é è™•ç†æœå°‹å­—ä¸²
        };
    });

    // 3. åŸ·è¡Œç‹€æ…‹æ›´æ–°èˆ‡åˆ†é é‡ç½®
    state.bucketList = normalizedBucket;
    
    // ğŸŒŸ é—œéµä¿®æ­£ï¼šåŒæ­¥å¾Œé‡ç½®åˆ†é è‡³ç¬¬ä¸€é ï¼Œç¢ºä¿é¡¯ç¤ºä¸€è‡´æ€§
    if (window.bucketPagination) {
        window.bucketPagination.currentPage = 1;
    }
    
    try {
        // ğŸŒŸ ä½¿ç”¨ true å¼·æ¬Šå¯«å…¥ IndexedDB
        await saveData(true); 
        console.log(`âœ… [Vault-Sync] åŒæ­¥æˆåŠŸï¼š${normalizedBucket.length} ç­†è³‡ç”¢å·²å°ä½ã€‚`);
        
        // 4. UI åˆ·æ–°è¯å‹•
        if (state.currentSubView === 'bucket' && typeof renderBucketItems === 'function') {
            renderBucketItems(true); // é‡ç¹ª UI
        }
    } catch (e) {
        console.error("âŒ [Vault-Sync] ç‰©ç†åŒæ­¥å¤±æ•—", e);
    }
}


// ç¬¬ä¸‰çµ„ï¼šæ¶ˆè²»è€… (Import Engine)

/**
 * æ™ºæ…§åŒ¯å…¥è§£æå™¨ 3.8ï¼šè‡ªå‹•æŠ•æ”¾èˆ‡ç‹€æ…‹è‡ªç™’ç‰ˆ
 * ä¿®æ­£ï¼š
 * 1. [è‡ªå‹•æŠ•æ”¾]ï¼šæ”¯æ´è­˜åˆ¥ JSON å…§çš„ "day" æ¬„ä½æˆ– notes ä¸­çš„ "@DayN" æ¨™è¨˜ã€‚
 * 2. [æŒ‰éˆ•è‡ªç™’]ï¼šè§£æ±ºå¾ä¸åŒåˆ†é åˆ‡æ›å¾Œï¼ŒåŒ¯å…¥æŒ‰éˆ•åŠŸèƒ½ä¸å°ä½å…ƒçš„å•é¡Œã€‚
 * 3. [ä¸€ç«™å°é€š]ï¼šåŒ¯å…¥æ™‚è‹¥å¸¶æœ‰å¤©æ•¸ï¼Œå°‡è‡ªå‹•æ¨™è¨˜ targetDay ä¾›å¾ŒçºŒåŸ·è¡Œã€‚
 */
async function processBucketImport() {
    const inputEl = document.getElementById('bucket-raw-input');
    const rawText = inputEl.value.trim();
    if (!rawText) return;

    let itemsToPreview = [];

    // --- 1. JSON æ ¼å¼åµæ¸¬èˆ‡æå– ---
    const jsonMatch = rawText.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
    
    if (jsonMatch) {
        try {
            const cleanJson = jsonMatch[0].replace(/```json|```/g, '').trim();
            const data = JSON.parse(cleanJson);
            
            // A. æ¨™ç±¤åº« (Dictionary) è‡ªå‹•å­˜å„²
            if (data.dictionary && Array.isArray(data.dictionary)) {
                for (const d of data.dictionary) {
                    await dbManager.save('dictionary_store', d);
                }
                window.GLOBAL_DICT = await dbManager.getAll('dictionary_store');
                console.log("âœ… æ¨™ç±¤åº«å·²å‹•æ…‹æ›´æ–°");
            }

            // B. æ•¸æ“šæºåµæ¸¬
            let list = data.bucketList || data.semanticDictionary || data.items || 
                       (Array.isArray(data) ? data : Object.values(data).find(v => Array.isArray(v)));
            
            if (!list && data.name) list = [data];

            if (list) {
                itemsToPreview = list.map(item => {
                    const name = item.name || item.tag || item.keyword || item.brand || "æœªå‘½ååœ°é»";
                    const semantic = recognizeSemantic(name, []);
                    
                    // ğŸŒŸ [ç‰©ç†å°ä½]ï¼šåµæ¸¬å¤©æ•¸æ¨™è¨˜ (å„ªå…ˆè®€å– JSON çš„ day å±¬æ€§ï¼Œå…¶æ¬¡å¾ notes æŠ“å– @Day)
                    const dayInNotes = (item.notes || "").match(/@Day\s*(\d+)/i);
                    const targetDay = item.day || (dayInNotes ? parseInt(dayInNotes[1]) : null);

                    return {
                        id: 'staging-' + generateUUID(),
                        name: name,
                        location: item.area || item.location || semantic.area || "",
                        coords: item.coords || item.location || semantic.location || { lat: null, lng: null },
                        style: semantic.style || 'food',
                        customStyle: item.tag || item.keyword || semantic.tag || 'åº—å®¶',
                        notes: (item.notes || item.defaultNotes || semantic.notes || "").replace(/@Day\s*\d+/i, '').trim(),
                        schedule: item.schedule || { open: "00:00", close: "23:59", offDays: [], notes: "" },
                        targetDay: targetDay, // ç‰©ç†ç›®æ¨™å¤©æ•¸å‚³é
                        selected: true,
                        raw: item 
                    };
                });
            }
        } catch (e) {
            console.warn("JSON è§£æå¤±æ•—ï¼Œè½‰å…¥ç´”æ–‡å­—æ¨¡å¼...", e);
        }
    }

    // --- 2. ç´”æ–‡å­—æ­£å‰‡è¾¨è­˜ ---
    if (itemsToPreview.length === 0) {
        const lines = rawText.split(/[\n;ï¼›]+/)
                      .map(l => l.trim())
                      .filter(l => l && !l.startsWith('//') && !['{','}','[',']'].includes(l));
                      
        itemsToPreview = lines.map(line => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const tagRegex = /\[(.*?)\]/g;
            const dayRegex = /@Day\s*(\d+)/i; // åµæ¸¬ @Day1
            
            let txt = line;
            
            // ğŸŒŸ æå–å¤©æ•¸æ¨™ç±¤
            const dayMatch = txt.match(dayRegex);
            const targetDay = dayMatch ? parseInt(dayMatch[1]) : null;
            txt = txt.replace(dayRegex, '').trim();

            const url = (txt.match(urlRegex) || [""])[0];
            txt = txt.replace(urlRegex, '').trim();
            
            let tags = [];
            let match;
            while ((match = tagRegex.exec(txt)) !== null) { tags.push(match[1]); }
            const name = txt.replace(tagRegex, '').trim() || "æœªå‘½ååœ°é»";

            const semantic = recognizeSemantic(name, tags);

            return {
                id: 'staging-' + generateUUID(),
                name: name,
                location: semantic.area || tags.join(' | '),
                coords: semantic.location || { lat: null, lng: null },
                style: semantic.style,
                customStyle: semantic.tag,
                notes: (semantic.notes ? `${semantic.notes}\n` : '') + (url ? `ğŸ”— ${url}` : ''),
                schedule: { open: "00:00", close: "23:59", offDays: [], notes: "" },
                targetDay: targetDay, // ç‰©ç†ç›®æ¨™å¤©æ•¸å‚³é
                selected: true,
                raw: { name }
            };
        });
    }

    // --- ğŸš¨ 3. âœ¨ æ ¸å¿ƒä¿®å¾©ï¼šæŒ‰éˆ•è¡Œç‚ºèˆ‡æ¨¡å¼åˆ¤å®š ---
    const modal = document.getElementById('smart-import-modal');
    const confirmBtn = modal?.querySelector('button[onclick*="confirmAndMoveToPrivate"], button[onclick*="executeBatchInsertToDay"]');
    
    // æª¢æŸ¥æœ¬æ¬¡åŒ¯å…¥æ˜¯å¦åŒ…å«ã€Œç›´æ¥æŒ‡å®šæ—¥æœŸã€çš„é …ç›®
    const hasTargetDays = itemsToPreview.some(it => it.targetDay !== null);

    if (confirmBtn) {
        if (hasTargetDays) {
            // æ¨¡å¼ Aï¼šåµæ¸¬åˆ°æ—¥æœŸæ¨™ç±¤ -> å•Ÿå‹•ã€Œæ™ºæ…§åˆ†ç™¼åŒ¯å…¥ã€
            confirmBtn.setAttribute('onclick', 'confirmAndAutoDistribute()');
            confirmBtn.innerText = 'ç¢ºèªä¸¦è‡ªå‹•æŠ•æ”¾æ—¥æœŸ';
            confirmBtn.className = "px-8 py-2 bg-blue-600 text-white rounded-full font-bold shadow-lg active:scale-95 transition-all";
        } else if (!window.currentDay || state.currentSubView !== 'itinerary') {
            // æ¨¡å¼ Bï¼šç´”å£è¢‹åŒ¯å…¥
            confirmBtn.setAttribute('onclick', 'confirmAndMoveToPrivate()');
            confirmBtn.innerText = 'ç¢ºèªåŒ¯å…¥ç§æœ‰åº«';
            confirmBtn.className = "px-8 py-2 theme-pink text-white rounded-full font-bold shadow-lg active:scale-95 transition-all";
            window.currentDay = null; 
        }
    }

    // --- 4. æ›´æ–°èˆ‡é è¦½ ---
    window.currentStagingItems = itemsToPreview;
    if (typeof renderImportPreview === 'function') {
        renderImportPreview(itemsToPreview);
    }
    toggleModal('smart-import-modal');
    inputEl.value = '';
}


/** ğŸ§ª å…¨æ–°å…¥å£ï¼šå¾é¸å–®é–‹å•Ÿæ™‚å¼·åˆ¶æ¸…ç† UI æ®˜ç•™ */
function openGlobalPocket() {
    // 1. å¼·åˆ¶è®“ç³»çµ±å¿˜è¨˜ã€Œå‰›æ‰åœ¨çœ‹å“ªä¸€å¤©ã€ï¼Œé˜²æ­¢åŒ¯å…¥æ™‚äº‚å•
    window.currentDay = null; 

    // 2. ç‰©ç†éš±è— Day Page è¦–åœ– (è«‹ä¾æ‚¨çš„ ID èª¿æ•´)
    const dayPageView = document.getElementById('day-page-view'); 
    const dayHeader = document.querySelector('.day-header'); 
    
    if (dayPageView) dayPageView.classList.add('hidden'); // éš±è—å–®æ—¥è¦–åœ–å…§å®¹
    if (dayHeader) dayHeader.style.display = 'none';    // éš±è—é‚£å€‹å¡åœ¨é ‚éƒ¨çš„æ¨™é¡Œ
    
    // 3. å›åˆ°ä¸»åˆ—è¡¨è¦–åœ– (å¦‚æœæœ‰çš„è©±)
    const mainDashboard = document.getElementById('main-dashboard');
    if (mainDashboard) mainDashboard.classList.remove('hidden');

    // 4. é–‹å•ŸåŒ¯å…¥è¦–çª—
    toggleModal('smart-import-modal');
    
    console.log("ğŸ“¡ ç³»çµ±å ±å‘Šï¼šUI æ®˜ç•™å·²æ¸…é™¤ï¼Œé€²å…¥å…¨åŸŸå‚™é¸æ¨¡å¼ã€‚");
}


/** * è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å…©å€‹æ™‚é–“é»ä¹‹é–“çš„åˆ†é˜æ•¸ (æ”¯æ´è·¨åˆå¤œ)
 * ç¯„ä¾‹ï¼šcalculateGap("23:00", "01:00") -> 120
 */
function calculateGap(startTime, endTime) {
    if (!startTime || !endTime) return 0;
    
    const toMin = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    };

    let gap = toMin(endTime) - toMin(startTime);
    
    // å¦‚æœçµæœæ˜¯è² æ•¸ï¼Œä»£è¡¨è·¨éäº†åˆå¤œ (åŠ ä¸Šä¸€æ•´å¤© 1440 åˆ†é˜)
    if (gap < 0) gap += 1440; 
    
    return gap;
}



/**
 * ğŸš€ æ™ºæ…§åŒ¯å…¥é è¦½å¼•æ“ 3.2 - ä¿®æ­£åˆ†é å ±éŒ¯èˆ‡è‡ªå‹•åˆ†ç™¼ç‰ˆ
 * ä¿®æ­£ï¼š
 * 1. [å…§ç½®åˆ†é ]ï¼šå°‡ renderPagination é‚è¼¯ç›´æ¥å¯«å…¥ï¼Œå¾¹åº•è§£æ±º ReferenceError å´©æ½°ã€‚
 * 2. [è‡ªå‹•æŠ•æ”¾]ï¼šåœ¨å¡ç‰‡å³å´åŠ å…¥ Day é¸æ“‡å™¨ï¼Œæ”¯æ´åŒ¯å…¥æ™‚ç›´æ¥æŒ‡å®šå¤©æ•¸ã€‚
 * 3. [ç‹€æ…‹åŒæ­¥]ï¼šé€é updateStagingTargetDay ç¢ºä¿ UI ä¿®æ”¹èƒ½å³æ™‚é–å®šå›æ•¸æ“šå±¤ã€‚
 */
function renderImportPreview(items) {
    const container = document.getElementById('import-preview-list');
    const countTag = document.getElementById('preview-count-tag');
    if (!container) return;

    // --- ğŸŒŸ 1. æ•¸æ“šåˆå§‹åŒ– ---
    window.currentStagingItems = typeof checkDuplicates === 'function' ? checkDuplicates(items) : items;

    // --- ğŸŒŸ 2. åˆ†é ç‹€æ…‹ç®¡ç† ---
    if (!window.stagingPagination) {
        window.stagingPagination = { currentPage: 1, pageSize: 10 };
    }
    window.stagingPagination.currentPage = 1; 

    // --- ğŸŒŸ 3. éˆæ•æœå°‹é‚è¼¯ ---
    const getFilteredItems = () => {
        const input = document.getElementById('preview-search-input');
        const term = input ? input.value.trim().toLowerCase() : "";
        if (!term) return window.currentStagingItems;

        const keywords = term.split(/\s+/).filter(k => k.length > 0);
        return window.currentStagingItems.filter(it => {
            const searchFingerprint = [
                it.name, it.location, it.area, it.customStyle, 
                it.notes, it.category, it.description, it.parent
            ].map(v => (v ? String(v).toLowerCase() : '')).join(' ');

            return keywords.every(kw => searchFingerprint.includes(kw));
        });
    };

    // ğŸŒŸ [åˆ†ç™¼åŠŸèƒ½]ï¼šæ›´æ–°ç‰¹å®šæš«å­˜é …ç›®çš„ç›®æ¨™å¤©æ•¸
    window.updateStagingTargetDay = function(id, dayValue) {
        const item = window.currentStagingItems.find(it => it.id === id);
        if (item) {
            item.targetDay = dayValue ? parseInt(dayValue) : null;
            console.log(`ğŸ¯ [Auto-Distribute] é …ç›® ${item.name} ç›®æ¨™å·²è¨­å®šç‚º Day ${item.targetDay || 'å¾…å‘½'}`);
        }
    };

    // ğŸŒŸ [åˆ†é æ¸²æŸ“è¼”åŠ©å‡½æ•¸]ï¼šç›´æ¥å…§ç½®é˜²æ­¢ ReferenceError
    const internalRenderPagination = (totalPages, current) => {
        if (totalPages <= 1) return "";
        return `
            <div class="flex items-center justify-center gap-6 mt-4 py-4 border-t border-gray-100">
                <button onclick="changeStagingPage(${current - 1})" 
                        class="p-2 bg-slate-50 rounded-xl hover:bg-pink-50 ${current === 1 ? 'opacity-20 cursor-not-allowed' : 'active:scale-90'}">â¬…ï¸</button>
                <span class="text-xs font-black text-slate-500 uppercase tracking-widest">Page ${current} / ${totalPages}</span>
                <button onclick="changeStagingPage(${current + 1})" 
                        class="p-2 bg-slate-50 rounded-xl hover:bg-pink-50 ${current === totalPages ? 'opacity-20 cursor-not-allowed' : 'active:scale-90'}">â¡ï¸</button>
            </div>`;
    };

    // --- ğŸŒŸ 4. UI æ¸²æŸ“åŸ·è¡Œå®˜ ---
    window.updatePreviewListUI = function() {
        const filteredItems = getFilteredItems();
        const p = window.stagingPagination;
        const totalItems = filteredItems.length;
        const totalPages = Math.ceil(totalItems / p.pageSize);
        
        if (p.currentPage > totalPages && totalPages > 0) p.currentPage = totalPages;
        const start = (p.currentPage - 1) * p.pageSize;
        const pagedItems = filteredItems.slice(start, start + p.pageSize);

        // å–å¾—ç•¶å‰è¡Œç¨‹çš„å¤©æ•¸é¸é …ä¾›ä¸‹æ‹‰é¸å–®ä½¿ç”¨
        const trip = getCurrentTrip();
        const dayOptionsHtml = trip ? trip.days.map(d => `<option value="${d.dayNum}">è‡³ Day ${d.dayNum}</option>`).join('') : '';

        if (totalItems === 0) {
            container.innerHTML = `
                <div class="py-16 text-center animate-in fade-in">
                    <div class="text-4xl mb-4 opacity-20">ğŸ”</div>
                    <p class="text-gray-400 italic text-sm font-black uppercase tracking-widest">No matching results</p>
                </div>`;
            if (countTag) countTag.innerText = `åµæ¸¬åˆ° 0 ç­†è³‡ç”¢`;
            return;
        }

        container.innerHTML = pagedItems.map(item => {
            const isDup = item.isDuplicate;
            const borderClass = isDup ? 'border-amber-400 bg-amber-50/30' : 'border-gray-100 bg-white';
            const warningTag = isDup ? `<span class="text-[8px] bg-amber-500 text-white px-1 py-0.5 rounded ml-1 font-black">å·²åœ¨åº«</span>` : '';
            const categoryKey = item.parent || item.category || item.style || 'é£Ÿ';
            const icon = (typeof MASTER_CATEGORIES !== 'undefined' && MASTER_CATEGORIES[categoryKey]) ? MASTER_CATEGORIES[categoryKey].icon : 'ğŸ“';
            
            // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå‹•æ…‹ç”Ÿæˆå¤©æ•¸é¸æ“‡é¸å–®
            const daySelector = `
                <select onchange="window.updateStagingTargetDay('${item.id}', this.value)" 
                        class="text-[10px] font-black bg-slate-50 border-slate-200 rounded-lg px-2 py-1 outline-none focus:ring-2 theme-border-pink appearance-none cursor-pointer hover:bg-slate-100 transition-colors">
                    <option value="">å¾…å‘½</option>
                    ${dayOptionsHtml.replace(`value="${item.targetDay}"`, `value="${item.targetDay}" selected`)}
                </select>
            `;

            return `
                <div class="p-4 rounded-2xl border-2 ${borderClass} shadow-sm flex items-center gap-3 transition-all hover:border-pink-200 mb-3 animate-in fade-in group">
                    <input type="checkbox" ${item.selected ? 'checked' : ''} 
                           onchange="updateStagingSelection('${item.id}', this.checked)"
                           class="w-5 h-5 rounded text-pink-500 focus:ring-pink-500 border-gray-300 cursor-pointer">
                    
                    <div class="flex-grow min-w-0 flex items-center gap-3 cursor-pointer" onclick="editStagingItem('${item.id}')">
                        <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-lg bg-gray-50 group-hover:bg-white transition-colors">
                            ${icon}
                        </div>
                        <div class="flex-grow min-w-0 text-left">
                            <div class="flex items-center flex-wrap gap-1">
                                <span class="text-[9px] px-2 py-0.5 rounded-full bg-gray-200 text-gray-600 font-black uppercase">${item.customStyle || 'ç‡ƒæ–™'}</span>
                                <span class="font-bold text-gray-800 text-sm truncate max-w-[120px]">${item.name}</span>
                                ${warningTag}
                            </div>
                            <div class="text-[10px] text-gray-400 truncate mt-1">
                                ğŸ“ ${item.notes || item.area || 'é»æ“Šç€è¦½è©³ç´°å…§å®¹...'}
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-end gap-1">
                        ${daySelector}
                        <button onclick="removeStagingItem('${item.id}'); event.stopPropagation();" 
                                class="text-gray-300 hover:text-red-500 p-1 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M6 18L18 6M6 6l12 12" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('') + internalRenderPagination(totalPages, p.currentPage); // ğŸŒŸ ä½¿ç”¨å…§ç½®çš„åˆ†é æ¸²æŸ“

        if (countTag) countTag.innerText = `åµæ¸¬åˆ° ${totalItems} ç­†ç‡ƒæ–™è³‡ç”¢ (å…± ${totalPages} é )`;
    };

    // --- ğŸŒŸ 5. å•Ÿå‹•æ¸²æŸ“ ---
    window.updatePreviewListUI();
}


/** ğŸ§  å£è¢‹ç«¯ï¼šæ ¹æ“š ID é–‹å•Ÿä¸¦å„²å­˜ */
window.openEditModalById = function(id) {
    const trip = getCurrentTrip();
    const combinedList = [...(state.privateData || []), ...(trip?.bucketList || [])];
    const item = combinedList.find(it => it.id === id);

    if (!item) return console.error("âŒ æ‰¾ä¸åˆ°è³‡ç”¢ ID:", id);

    openMobileFriendlyEditor(item, (updatedData) => {
        // 1. å›å¯«è¨˜æ†¶é«”
        Object.assign(item, updatedData);
        
        // 2. è§¸ç™¼ç‰©ç†å­˜æª” (IndexedDB)
        if (typeof saveData === 'function') saveData();
        
        // 3. åˆ·æ–°å£è¢‹ UI (ä¸é‡æ•´ Tab ä¿æŒåˆ†é )
        if (typeof renderBucketItems === 'function') renderBucketItems(false);
        console.log("ğŸ’¾ ç‰©ç†ç£å€è³‡æ–™å·²å›ºåŒ–");
    });
};

/**
 * [é˜²ç«ç‰†æ¨¡çµ„] é‡è¤‡åµæ¸¬å¼•æ“ (v9.2 å»£åŸŸå°ä½ç‰ˆ)
 * ç”¨é€”ï¼šåœ¨åŒ¯å…¥å‰åµæ¸¬ Staging é …ç›®æ˜¯å¦å·²å­˜åœ¨æ–¼å£è¢‹åå–®æˆ–è¡Œç¨‹ä¸­ã€‚
 * ä¿®æ­£ï¼šå¼·åŒ–å‘½åç›¸å®¹æ€§ï¼Œç¢ºä¿æœå°‹èˆ‡æŸ¥é‡é‚è¼¯åŒæ­¥ã€‚
 */
function checkDuplicates(stagingItems) {
    const trip = getCurrentTrip();
    
    // ğŸ›¡ï¸ é‚Šç•Œé˜²ç¦¦ï¼šè‹¥ç„¡è¡Œç¨‹è³‡æ–™ï¼Œè¦–ç‚ºå…¨æ–°å“é …
    if (!trip) {
        return stagingItems.map(it => ({ 
            ...it, 
            isDuplicate: false, 
            selected: true 
        }));
    }

    // 1. ğŸŒŸ å»ºç«‹å…¨åŸŸå·²å­˜åœ¨åç¨±ç´¢å¼• (å¤§ä¸€çµ±æƒæ)
    // åŒ…å«ï¼š1.å‚™é¸æ¡¶(bucketList) 2.æ‰€æœ‰å¤©æ•¸çš„è¡Œç¨‹(schedules/itinerary)
    const existingNames = new Set();

    // A. æƒæå‚™é¸æ¡¶
    (trip.bucketList || []).forEach(item => {
        if (item.name) existingNames.add(item.name.trim().toLowerCase());
    });

    // B. æƒææ‰€æœ‰å¤©æ•¸çš„è¡Œç¨‹è¡¨ (é›™è·¯å¾‘å…¼å®¹)
    (trip.days || []).forEach(day => {
        const dayItems = [
            ...(day.schedules || []),
            ...(day.itinerary || [])
        ];
        dayItems.forEach(s => {
            if (s.name) existingNames.add(s.name.trim().toLowerCase());
        });
    });

    // 2. ğŸŒŸ åŸ·è¡Œäº¤å‰æ¯”å°ä¸¦æ¨™è¨˜ç‹€æ…‹
    return stagingItems.map(item => {
        const itemNameLower = (item.name || "").trim().toLowerCase();
        
        // å¦‚æœåç¨±å®Œå…¨ä¸€è‡´ï¼ˆå¿½ç•¥å¤§å°å¯«èˆ‡ç©ºæ ¼ï¼‰ï¼Œåˆ¤å®šç‚ºé‡è¤‡
        const isDup = existingNames.has(itemNameLower);
        
        return { 
            ...item, 
            isDuplicate: isDup,
            // æˆ°è¡“é‚è¼¯ï¼šé‡è¤‡é …ä¸é é¸(selected: false)ï¼Œé¿å…æ‰‹æ®˜é‡è¤‡åŒ¯å…¥
            selected: !isDup 
        };
    });
}



// updateStagingSelection(), updateStagingItem(), removeStagingItem()ï¼šé è¦½è¦–çª—çš„å°åŠ©æ‰‹ã€‚

/** * 1. æ›´æ–°æš«å­˜é …ç›®çš„é¸å–ç‹€æ…‹ 
 * ä¿®æ­£ï¼šåŠ å…¥ç‹€æ…‹ä¸€è‡´æ€§ä¿è­·ï¼Œç¢ºä¿å…¨é¸/å…¨ä¸é¸é‚è¼¯æ­£ç¢ºã€‚
 */
function updateStagingSelection(id, isSelected) {
    const item = (window.currentStagingItems || []).find(it => it.id === id);
    if (item) {
        item.selected = isSelected;
        console.log(`å–®å‘é–å®šï¼š[${item.name}] é¸å–ç‹€æ…‹ -> ${isSelected}`);
    }
}

/** * 2. æ›´æ–°æš«å­˜é …ç›®çš„å…§å®¹ (è®“ä½¿ç”¨è€…ç›´æ¥åœ¨å½ˆçª—ä¿®æ­£) 
 * ä¿®æ­£ï¼šå¢åŠ å°æ·±å±¤æ¬„ä½ (å¦‚ location) çš„å¯«å…¥æ”¯æŒï¼Œä¸¦é˜²æ­¢ç©ºå€¼ã€‚
 */
function updateStagingItem(id, field, value) {
    const item = (window.currentStagingItems || []).find(it => it.id === id);
    if (item) {
        // ç¢ºä¿åŸºæœ¬æ¬„ä½ä¸è¢«æ”¹ç‚ºç©ºå­—ä¸²ï¼Œç¶­æŒæœå°‹éˆæ•åº¦
        if (field === 'name' && !value.trim()) return;
        
        item[field] = value;
        console.log(`æ•¸æ“šä¿®æ­£ï¼š[${id}] çš„ ${field} å·²æ›´æ–°ç‚º ${value}`);
    }
}

/** * 3. å¾é è¦½æ¸…å–®ç§»é™¤é …ç›® 
 * ä¿®æ­£ï¼šç§»é™¤å¾Œè‡ªå‹•èª¿ç”¨ filterPreviewItems è€Œé renderImportPreviewï¼Œ
 * ç¢ºä¿å¦‚æœä½¿ç”¨è€…åœ¨ã€Œæœå°‹ç‹€æ…‹ä¸‹ã€åˆªé™¤é …ç›®ï¼Œæœå°‹çµæœèƒ½å³æ™‚ä¿æŒåŒæ­¥ã€‚
 */
function removeStagingItem(id) {
    if (!window.currentStagingItems) return;

    // åŸ·è¡Œç‰©ç†ç§»é™¤
    window.currentStagingItems = window.currentStagingItems.filter(it => it.id !== id);
    
    // ğŸŒŸ æ™ºæ…§åˆ·æ–°ï¼šå„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰æœå°‹é—œéµå­—ï¼Œä¿æŒæœå°‹çµæœçš„æ­£ç¢ºé¡¯ç¤º
    const searchInput = document.getElementById('preview-search-input');
    if (searchInput && searchInput.value.trim()) {
        window.filterPreviewItems(); // ä¿æŒæœå°‹éæ¿¾ç‹€æ…‹ä¸‹çš„åˆ·æ–°
    } else {
        // è‹¥ç„¡æœå°‹ï¼Œå‰‡é€²è¡Œå…¨é‡é‡ç¹ª
        if (typeof renderImportPreview === 'function') {
            renderImportPreview(window.currentStagingItems);
        }
    }
    
    console.log(`é …ç›®ç§»é™¤ï¼šID ${id} å·²æ’¤é›¢æš«å­˜å€`);
}

// confirmAndMoveToPrivate()ï¼šæœ€å¾Œçš„æ¬é‹å·¥ï¼Œå°‡å‹¾é¸çš„è³‡æ–™æ­£å¼å­˜å…¥è³‡æ–™åº«ã€‚


/** ğŸš€ æœ€çµ‚åŸ·è¡Œæ™ºæ…§åŒ¯å…¥ (v4.7 æ™ºæ…§åˆ†ç™¼èˆ‡è‡ªå‹•æŠ•æ”¾ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [è³‡ç”¢ç¹¼æ‰¿]ï¼šç¢ºä¿åŒ¯å…¥æ™‚èƒ½æ‰¿æ¥ photo æ¬„ä½ï¼Œè®“æè¿°å°å¡åœ–ç‰‡åŠŸèƒ½å°é€šã€‚
 * 2. [ä¸€ç«™å¼æŠ•æ”¾]ï¼šç²¾æº–è­˜åˆ¥ targetDayï¼Œç›´æ¥ç©ºæŠ•è‡³æŒ‡å®šå¤©æ•¸æ’ç¨‹æœ«ç«¯ã€‚
 * 3. [è‡ªç™’åˆ·æ–°]ï¼šåŸ·è¡Œå¾Œè‡ªå‹•æ ¡æº–å—å½±éŸ¿å¤©æ•¸çš„æ™‚é–“è»¸ï¼Œä¸¦é‡æ•´èªæ„å­—å…¸ã€‚
 */
async function confirmAndAutoDistribute() {
    const trip = getCurrentTrip();
    if (!trip) return;

    // 1. æå–æ‰€æœ‰å‹¾é¸é …ç›®
    const itemsToProcess = (window.currentStagingItems || []).filter(it => it.selected);
    if (itemsToProcess.length === 0) {
        showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®åŒ¯å…¥', 'info');
        return;
    }

    let autoInsertCount = 0;
    let bucketOnlyCount = 0;

    // 2. æ ¸å¿ƒåˆ†ç™¼è¿´åœˆ
    for (const it of itemsToProcess) {
        const commonId = 'bucket-' + generateUUID();
        
        // å°è£å‚™é¸å£è¢‹è³‡ç”¢ (ç¢ºä¿ç¹¼æ‰¿ photo, notes ç­‰é—œéµå±¬æ€§)
        const bucketEntry = { 
            ...it, 
            id: commonId, 
            isVerified: true, 
            isAdded: it.targetDay ? true : false, 
            lastUpdate: new Date().toISOString()
        };

        // A. å¯«å…¥å£è¢‹åå–® (Source of Truth)
        if (!trip.bucketList) trip.bucketList = [];
        trip.bucketList.push(bucketEntry);

        // B. ğŸŒŸ åŸ·è¡Œè‡ªå‹•æŠ•æ”¾ (ç©ºæŠ•è‡³æŒ‡å®šå¤©æ•¸)
        if (it.targetDay) {
            const targetDay = trip.days.find(d => d.dayNum == it.targetDay);
            if (targetDay) {
                // è¨ˆç®—æ¥çºŒæ™‚é–“ (è‡ªå‹•å°ä½æœ€å¾Œä¸€å€‹è¡Œç¨‹)
                let nextStart = targetDay.startTime || "09:00";
                if (targetDay.schedules && targetDay.schedules.length > 0) {
                    const last = targetDay.schedules[targetDay.schedules.length - 1];
                    nextStart = calculateEndTime(last.startTime, last.durationHours);
                }

                // å»ºç«‹æ­£å¼è¡Œç¨‹ç‰©ä»¶
                const scheduleEntry = {
                    ...bucketEntry,
                    id: 'trip-' + generateUUID(),
                    startTime: nextStart,
                    // ğŸŒŸ ç‰©ç†é–å®šï¼šæè¿°å°å¡ç¶­æŒ 0.1hr ä»¥é¿é–‹æ™‚é–“è»¸ä½”ä½
                    durationHours: it.style === 'description' ? 0.1 : (parseFloat(it.durationHours) || 1.0),
                    fromBucketId: commonId // é—œéµç‰©ç†éˆçµï¼Œç”¨æ–¼æ—¥å¾Œåˆªé™¤æ™‚å›æ”¶ç‹€æ…‹
                };

                if (!targetDay.schedules) targetDay.schedules = [];
                targetDay.schedules.push(scheduleEntry);
                
                // é‡æ–°æ ¡æº–è©²å¤©æ™‚é–“è»¸
                recalculateScheduleTimes(targetDay);
                autoInsertCount++;
            } else {
                bucketOnlyCount++;
            }
        } else {
            bucketOnlyCount++;
        }
    }

    // 3. ğŸ’¾ ç‰©ç†è½åœ°èˆ‡èªæ„åŒæ­¥ (ä½¿ç”¨ Force Mode ç©¿é€åŸå­é–)
    state.bucketList = trip.bucketList;
    await saveData(true); 

    if (typeof syncBucketToGlobalDict === 'function') {
        await syncBucketToGlobalDict();
    }

    // 4. ğŸ§¹ è¦–åœ–è‡ªç™’åˆ·æ–°
    toggleModal('smart-import-modal');
    
    // æ¸…é™¤æœå°‹èˆ‡åˆ†é¡éæ¿¾ç‹€æ…‹ï¼Œç¢ºä¿æ–°è³‡æ–™åœ¨æ‰€æœ‰è¦–åœ–éƒ½èƒ½é¡¯å½±
    state.bucketSearchTerm = '';
    state.activeParentTab = 'å…¨éƒ¨';

    // æ ¹æ“šç•¶å‰æ‰€åœ¨è¦–åœ–åŸ·è¡Œé‡ç¹ª
    if (state.currentSubView === 'bucket') {
        renderBucketView();
        renderBucketItems();
    } else {
        renderDayContent();
    }

    // å¼·åˆ¶é‡æ•´æ¨™ç±¤é›² (å°ä½æ–°åŒ¯å…¥çš„è‡ªå®šç¾©é¢¨æ ¼)
    if (typeof renderBucketTabs === 'function') renderBucketTabs();

    // 5. æˆ°å ±å›é¥‹
    const finalMsg = `âœ¨ åŒ¯å…¥å®Œæˆï¼è‡ªå‹•æŠ•æ”¾: ${autoInsertCount} ç­† | å­˜å…¥å£è¢‹: ${bucketOnlyCount} ç­†`;
    showMessage(finalMsg, 'success');
    
    // ğŸ›¡ï¸ æ¸…ç†ç‹€æ…‹ï¼šé‡‹æ”¾è¨˜æ†¶é«”æŒ‡ç´‹
    window.currentStagingItems = [];
    window.currentDay = null; 
}

/** ğŸš€ æˆ°ç•¥æ ¸å¿ƒï¼šå…¨èªæ„ç©¿é€åµæ¸¬å¼•æ“ (v9.0 éˆæ•ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. [å¤šè©æ”¯æ´]ï¼šæ”¯æ´ç©ºæ ¼åˆ‡åˆ†é—œéµå­— (ä¾‹å¦‚ï¼šæœå°‹ "åšå¤š ç‡’è‚‰")ã€‚
 * 2. [å…¨æ¬„ä½æƒæ]ï¼šå°‡æœå°‹ç¯„åœæ“´å¤§è‡³æ‰€æœ‰éš±è—å±¬æ€§ï¼ŒåŒ…å«å‚™è¨»èˆ‡ç‰¹è‰²ã€‚
 * 3. [é™ç´šæª¢ç´¢]ï¼šè‹¥åŸå¸‚æ¯”å°ç„¡çµæœï¼Œè‡ªå‹•å˜—è©¦æœå°‹æ¡†çš„å»£åŸŸé—œéµå­—ã€‚
 */
function smartImportByDayCity() {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    
    // 1. ğŸŒŸ å¤§ä¸€çµ±æ•¸æ“šæº (ç©¿é€æ‰€æœ‰å­¤å³¶)
    const rawData = [
        ...(trip?.bucketList || []),
        ...(state.privateData || []),
        ...(state.bucketList || [])
    ];
    const uniqueVault = Array.from(new Map(rawData.map(it => [it.id, it])).values());

    if (uniqueVault.length === 0) {
        showMessage("å‚™é¸æ¸…å–®æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåŒ¯å…¥ç‡ƒæ–™åŒ…ï¼", "info");
        return;
    }

    // 2. ğŸŒŸ æ™ºæ…§ç²å–é—œéµå­— (æ”¯æ´å¤šé‡è¼¸å…¥æº)
    const currentCities = (Array.isArray(day.city) ? day.city : [day.city || ""])
                          .map(c => c.trim().toUpperCase())
                          .filter(c => c !== "");
    
    const fallbackSearch = (state.bucketSearchTerm || "").toUpperCase();
    
    // ç²å–æ‰€æœ‰æ½›åœ¨é—œéµå­—ä¸¦åˆ‡åˆ†ç‚ºç¨ç«‹å–®å­—
    let searchTerms = currentCities.length > 0 ? currentCities : (fallbackSearch ? [fallbackSearch] : []);
    
    if (searchTerms.length === 0) {
        showMessage("è«‹å…ˆè¨­å®šã€ŒåŸå¸‚/åœ°å€ã€æˆ–åœ¨æœå°‹æ¡†è¼¸å…¥é—œéµå­—", "warning");
        return;
    }

    // å°‡é—œéµå­—é€²ä¸€æ­¥æ‹†è§£ç‚ºå–®è© (è™•ç†ç©ºæ ¼)
    const keywords = searchTerms.flatMap(s => s.split(/\s+/)).filter(k => k.length > 0);

    // 3. ğŸŒŸ å…¨ç¶­åº¦éˆæ•æ¯”å°
    const filteredItems = uniqueVault.filter(item => {
        // æ”¤å¹³æ‰€æœ‰è³‡è¨Šç‚ºä¸€å€‹ã€Œç‰¹å¾µå­—å…¸ã€
        const searchable = [
            item.name,
            item.location || item.area,
            item.customStyle,
            item.notes,
            item.category,
            item.meta?.specialty
        ].join(' # ').toUpperCase();
        
        // éˆæ•åˆ¤æ–·ï¼šæ‰€æœ‰é—œéµå­—å–®è©éƒ½å¿…é ˆå‡ºç¾åœ¨ç‰¹å¾µå­—å…¸ä¸­ (AND é‚è¼¯)
        return keywords.every(key => searchable.includes(key));
    });

    if (filteredItems.length === 0) {
        showMessage(`ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆã€Œ${keywords.join(' + ')}ã€çš„é …ç›®`, "info");
        return;
    }

    // 4. æº–å‚™ Staging æ•¸æ“šä¸¦æ¨™è¨˜é‡è¤‡
    window.currentStagingItems = (typeof checkDuplicates === 'function') ? 
        checkDuplicates(filteredItems) : 
        filteredItems.map(it => ({ ...it, selected: true }));

    // å¼·åˆ¶ç‚ºæ¯å€‹ Staging é …ç›®åˆ†é…è‡¨æ™‚ ID
    window.currentStagingItems = window.currentStagingItems.map(it => ({
        ...it,
        id: 'staging-' + Math.random().toString(36).substr(2, 9),
        rawId: it.rawId || it.id
    }));

    // 5. æ¸²æŸ“é è¦½
    if (typeof renderImportPreview === 'function') {
        renderImportPreview(window.currentStagingItems);
        
        // å°ä½ç¢ºèªæŒ‰éˆ•
        const modal = document.getElementById('smart-import-modal');
        const confirmBtn = modal?.querySelector('button[onclick*="confirm"], button.theme-pink');
        if (confirmBtn) {
            confirmBtn.setAttribute('onclick', `executeBatchInsertToDay(${day.dayNum})`);
            confirmBtn.innerText = `ç¢ºèªåŒ¯å…¥ ${filteredItems.length} ç­†è‡³ Day ${day.dayNum}`;
        }
        toggleModal('smart-import-modal');
    }
}


/** ğŸ­ åŸ·è¡Œæ‰¹é‡å®‰æ’ (v8.5 åŸå­åŒ–å°ä½ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. [æ•ˆèƒ½å„ªåŒ–]ï¼šå°‡é‡ç¹ªé‚è¼¯ç§»å‡ºè¿´åœˆï¼Œé¿å…é€£çºŒè§¸ç™¼è¨ºæ–·å¤§è…¦å°è‡´é–ƒçˆã€‚
 * 2. [é‚è¼¯å¼·åŒ–]ï¼šç¢ºä¿å¾ Staging å€æ­£ç¢ºé‚„åŸåŸå§‹ ID ä¸¦åŒæ­¥ isAdded ç‹€æ…‹ã€‚
 * 3. [è‡ªç™’åˆ·æ–°]ï¼šå®‰æ’å¾Œè‡ªå‹•é‡æ•´æœå°‹è¦–åœ–ï¼Œç¢ºä¿ã€Œå·²åŠ å…¥ã€çš„é …ç›®è®Šæ›´ç‚ºåŠé€æ˜ã€‚
 */
async function executeBatchInsertToDay(dayNum) {
    const selected = (window.currentStagingItems || []).filter(it => it.selected);
    
    if (selected.length === 0) {
        showMessage("æœªé¸å–ä»»ä½•é …ç›®", "warning");
        return;
    }

    console.log(`ğŸš€ å•Ÿå‹•æ‰¹é‡æŠ•å½ˆï¼šå°‡ ${selected.length} å€‹é …ç›®å®‰æ’è‡³ Day ${dayNum}`);

    // ğŸŒŸ 1. æ‰¹æ¬¡è™•ç†é‚è¼¯ (ä¸è§¸ç™¼ UI é‡ç¹ªçš„éœé»˜æ¨¡å¼)
    for (const item of selected) {
        // ä½¿ç”¨åŸå§‹ ID (rawId) é€²è¡Œå®‰æ’ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨ç¾æœ‰ ID
        const targetId = item.rawId || item.id;
        
        // å‘¼å«åº•å±¤å®‰æ’é‚è¼¯ï¼Œä½†å‚³å…¥ silent åƒæ•¸é˜²æ­¢é‡è¤‡é‡ç¹ª (è‹¥æ‚¨çš„ insertBucketToDay æ”¯æ´)
        await insertBucketToDay(targetId, dayNum, { silent: true });
    }

    // ğŸŒŸ 2. ç‰©ç†ç‹€æ…‹åŒæ­¥
    // å¼·åˆ¶æ¨™è¨˜é€™äº›é …ç›®åœ¨æœå°‹æ¸…å–®ä¸­ç‚ºã€Œå·²åŠ å…¥ã€
    selected.forEach(s => {
        const vaultItem = (state.privateData || []).find(p => p.id === (s.rawId || s.id));
        if (vaultItem) vaultItem.isAdded = true;
    });

    // ğŸŒŸ 3. å…¨ç³»çµ±ä¸€æ¬¡æ€§é‡ç¹ª
    toggleModal('smart-import-modal');
    
    // åˆ·æ–°è¡Œç¨‹è¡¨èˆ‡å‚™é¸æ¸…å–®
    if (typeof renderItinerary === 'function') renderItinerary();
    if (typeof renderBucketItems === 'function') renderBucketItems(false);

    showMessage(`âœ… å·²å®Œæˆ ${selected.length} ç­†é …ç›®ã€Œç²¾æº–æŠ•æ”¾ã€è‡³ç¬¬ ${dayNum} å¤©`, "success");
    
    // æ¸…ç©ºæš«å­˜
    window.currentStagingItems = [];
}



    // 1. å…ˆå®šç¾©å·¥å…·å‡½æ•¸ï¼Œç¢ºä¿ state åˆå§‹åŒ–æ™‚èƒ½å‘¼å«
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

/**
 * è¨ˆç®—çµæŸæ™‚é–“ (v1.1.3 æ——è‰¦ç‰ˆ)
 * ä¿®æ­£ï¼šå¼·åŒ–æµ®é»æ•¸è¨ˆç®—ç²¾åº¦ï¼Œç¢ºä¿è·¨æ—¥èˆ‡è£œé›¶é‚è¼¯ï¼Œèˆ‡è¨ºæ–·å¤§è…¦ v5.7 å®Œå…¨å°é½Š
 */
function calculateEndTime(startTime, durationHours) {
    // 1. å®‰å…¨æª¢æŸ¥ï¼šè‹¥ç„¡èµ·å§‹æ™‚é–“ï¼Œé è¨­å›å‚³ 09:00 æˆ–åŸå§‹æ™‚é–“
    if (!startTime || !startTime.includes(':')) return startTime || "09:00";

    // 2. è§£ææ™‚åˆ†
    const [hours, minutes] = startTime.split(':').map(Number);
    
    // 3. è¨ˆç®—ç¸½åˆ†é˜æ•¸ (ä½¿ç”¨ Math.round é˜²æ­¢ 0.1+0.2 çš„æµ®é»æ•¸èª¤å·®)
    // ç¢ºä¿ durationHours å³ä½¿æ˜¯å­—ä¸²ä¹Ÿèƒ½æ­£ç¢ºè½‰æ›ï¼Œé è¨­å€¼ç‚º 1 å°æ™‚
    const durationMin = Math.round((parseFloat(durationHours) || 0) * 60);
    const totalMinutes = hours * 60 + minutes + durationMin;

    // 4. 24 å°æ™‚åˆ¶é€²ä½è™•ç†
    const endHours = Math.floor(totalMinutes / 60) % 24;
    const endMinutes = totalMinutes % 60;

    // 5. è£œé›¶è¼¸å‡ºæ ¼å¼ (HH:mm)
    return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
}

// ==========================================
// 1. å¸¸é‡å®šç¾©å€ (Constants)
// ==========================================

// A. åŸºç¤é…è‰²åº« (ç¢ºä¿æ’åœ¨ state ä¹‹å‰)
    const THEME_COLORS = {
        'å¤§åœ°ç¶ ': '#10b981',
        'å¤©ç©ºè—': '#3b82f6',
        'å¤•é™½æ©™': '#f97316',
        'è–°è¡£ç´«': '#a855f7',
        'ç«ç‘°ç²‰': '#e91e63',
        'æœˆå¤œç°': '#6b7280',
    };

// B. è¦–è¦ºåˆ†é¡å®šç¾© (å°é½Š renderBucketTabs æ‰€éœ€åç¨±)
const MASTER_CATEGORIES = {
    'é£Ÿ': { icon: 'ğŸ±', color: 'emerald', theme: 'green' },
    'é†«': { icon: 'ğŸ¥', color: 'red', theme: 'red' },
    'è¡Œ': { icon: 'ğŸš—', color: 'blue', theme: 'blue' },
    'ä½': { icon: 'ğŸ¨', color: 'indigo', theme: 'indigo' },
    'ç©': { icon: 'ğŸ¡', color: 'purple', theme: 'purple' },
    'è³¼': { icon: 'ğŸ›ï¸', color: 'amber', theme: 'amber' }
};


// D. åˆå§‹ AI æ¨™ç±¤åº«ï¼šåŒ…å«é¤å»³ç´°é …èˆ‡æ ¸å¿ƒåˆ†é¡
const DEFAULT_DICTIONARY = [
    // é£Ÿ (15ç¨®ç´°é …ç¯„ä¾‹)
    { tag: 'æ‹‰éºµ', parent: 'é£Ÿ', keywords: ['æ‹‰éºµ', 'RAMEN', 'ãƒ©ãƒ¼ãƒ¡ãƒ³'] },
    { tag: 'ç‡’è‚‰', parent: 'é£Ÿ', keywords: ['ç‡’è‚‰', 'YAKINIKU', 'å’Œç‰›', 'çƒ¤è‚‰'] },
    { tag: 'æ°´ç‚Šé‹', parent: 'é£Ÿ', keywords: ['æ°´ç‚Š', 'é›è‚‰é‹'] },
    { tag: 'å…§è‡Ÿé‹', parent: 'é£Ÿ', keywords: ['å…§è‡Ÿé‹', 'ç‰›è…¸é‹', 'ã‚‚ã¤é‹'] },
    { tag: 'å’–å•¡åº—', parent: 'é£Ÿ', keywords: ['CAFE', 'å’–å•¡', 'çˆç²', 'COFFEE'] },
    { tag: 'ç”œé»', parent: 'é£Ÿ', keywords: ['ç”œé»', 'è›‹ç³•', 'DESSERT', 'SWEETS'] },
    { tag: 'å±…é…’å±‹', parent: 'é£Ÿ', keywords: ['å±…é…’å±‹', 'é…’å ´', 'IZAKAYA'] },
    { tag: 'å£½å¸', parent: 'é£Ÿ', keywords: ['å£½å¸', 'SUSHI', 'é®¨'] },
    { tag: 'å¤©å©¦ç¾…', parent: 'é£Ÿ', keywords: ['å¤©å©¦ç¾…', 'å¤©ã·ã‚‰'] },
    { tag: 'é°»é­šé£¯', parent: 'é£Ÿ', keywords: ['é°»', 'UNAGI'] },
    { tag: 'çƒé¾éºµ', parent: 'é£Ÿ', keywords: ['çƒé¾', 'UDON', 'ã†ã©ã‚“'] },
    { tag: 'ä¸²ç‚¸', parent: 'é£Ÿ', keywords: ['ä¸²ç‚¸', 'ä¸²ã‚«ãƒ„'] },
    { tag: 'å’–å“©', parent: 'é£Ÿ', keywords: ['å’–å“©', 'CURRY', 'ã‚«ãƒ¬ãƒ¼'] },
    { tag: 'çƒ˜ç„™', parent: 'é£Ÿ', keywords: ['çƒ˜ç„™', 'éºµåŒ…', 'BAKERY'] },
    { tag: 'å±‹å°', parent: 'é£Ÿ', keywords: ['å±‹å°', 'YATAI'] },
    
    // è¡£ä½è¡Œè‚²æ¨‚æ ¸å¿ƒæ¨™ç±¤
    { tag: 'ç™¾è²¨', parent: 'è¡£', keywords: ['MALL', 'ç™¾è²¨', 'PARCO', 'OUTLET'] },
    { tag: 'é£¯åº—', parent: 'ä½', keywords: ['HOTEL', 'STAY', 'æ°‘å®¿', 'å®¿'] },
    { tag: 'è»Šç«™', parent: 'è¡Œ', keywords: ['ç«™', 'STATION', 'ç©ºæ¸¯', 'TERMINAL'] },
    { tag: 'ç¥ç¤¾', parent: 'è‚²', keywords: ['ç¥ç¤¾', 'å¤§ç¤¾', 'å®®', 'å¯º'] },
    { tag: 'å…¬åœ’', parent: 'æ¨‚', keywords: ['å…¬åœ’', 'æ™¯é»', 'PARK', 'æ™¯è§€'] }
];

// E. é–‹éŠ·é¡åˆ¥æ¨£å¼
const EXPENSE_CATEGORIES = {
    'ä½å®¿': { color: '#8B5CF6', border: '#C4B5FD', bg: 'rgba(139, 92, 246, 0.1)' },
    'äº¤é€š': { color: '#3B82F6', border: '#93C5FD', bg: 'rgba(59, 130, 246, 0.1)' },
    'é¤é£²': { color: '#10B981', border: '#6EE7B7', bg: 'rgba(16, 185, 129, 0.1)' },
    'æ´»å‹•': { color: '#F43F5E', border: '#FDA4AF', bg: 'rgba(244, 63, 94, 0.1)' },
    'è³¼ç‰©': { color: '#F59E0B', border: '#FCD34D', bg: 'rgba(245, 158, 11, 0.1)' }
};



/** ğŸ“– è¬èƒ½å­—å…¸å¢è£œï¼šé†«ç™‚èˆ‡æ€¥é›£å°ˆæ¥­é … (2026 æ·±åº¦å°ä½ç‰ˆ) 
 * æ•´åˆï¼šæ—¥æœ¬æ¼¢å­—ã€ç‰‡å‡åã€æ€¥é›£ä»£è™Ÿã€æ¬Šé‡è£œå¼·
 */
const MEDICAL_EXTENSIONS = [
    // ğŸ¥ é†«ç™‚æ ¸å¿ƒè¨­æ–½
    { tag: 'ç¶œåˆé†«é™¢', parent: 'é†«', keywords: ['é†«é™¢', 'ç—…é™¢', 'HOSPITAL', 'ç¶œåˆç—…é™¢', 'CENTER'] },
    { tag: 'è¨ºæ‰€/å°å…’ç§‘', parent: 'é†«', keywords: ['è¨ºæ‰€', 'è¨ºç™‚', 'CLINIC', 'ã‚¯ãƒªãƒ‹ãƒƒã‚¯', 'å°å…’', 'PEDIATRICS', 'å°å…ç§‘', 'å…§ç§‘', 'å¤–ç§‘'] },
    { tag: 'ç‰™é†«/é½’ç§‘', parent: 'é†«', keywords: ['ç‰™é†«', 'é½’ç§‘', 'DENTAL', 'æ­¯ç§‘'] },
    
    // ğŸš¨ æ€¥é›£èˆ‡ç·Šæ€¥æ•‘åŠ©
    { tag: 'æ€¥è¨ºä¸­å¿ƒ', parent: 'é†«', keywords: ['æ€¥', 'æ€¥è¨º', 'æ•‘æ€¥', 'ER', 'EMERGENCY', 'æ€¥æ‚£', 'å¤œé–“'] },
    { tag: 'è­¦å¯Ÿ/äº¤ç•ª', parent: 'é†«', keywords: ['è­¦å¯Ÿ', 'POLICE', 'äº¤ç•ª', 'KOBAN', 'ç½²', 'å ±æ¡ˆ'] },
    { tag: 'é§å¤–é ˜äº‹é¤¨', parent: 'é†«', keywords: ['ä»£è¡¨è™•', 'å¤§ä½¿é¤¨', 'EMBASSY', 'CONSULATE', 'é ˜äº‹é¤¨', 'è¾¦äº‹è™•'] },
    
    // ğŸ’Š é†«è—¥æ¡è²·
    { tag: 'å°ˆæ¥­è—¥å±€', parent: 'é†«', keywords: ['è—¥å±€', 'èª¿åŠ‘', 'PHARMACY', 'è—¥åº—', 'è™•æ–¹', 'èª¿å‰¤'] },
    { tag: 'è—¥å¦/è—¥åº—', parent: 'è³¼', keywords: ['è—¥å¦', 'DRUGSTORE', 'æ¾æœ¬æ¸…', 'å¤§åœ‹', 'OS DRUG', 'è—¥åº—'] } 
    // è¨»ï¼šè—¥å¦åº—åˆ†é¡ç‚ºã€Œè³¼ã€ï¼Œä½†åŒ…å«ã€Œè—¥ã€å­—é—œéµå­—ï¼Œç”±é›·é”å„ªå…ˆç´šæ±ºå®šã€‚
];

/** ğŸ“– ç¿»è­¯å­—å…¸å¢è£œï¼šæƒ…å¢ƒèªå¥èˆ‡æºé€šé …
 * æ•´åˆï¼šå ´æ™¯åˆ†é¡ã€é—œéµå­—ã€ä»¥åŠèªéŸ³å°ä½åƒæ•¸
 */
const TRANSLATION_EXTENSIONS = [
    // ğŸš‰ äº¤é€š/è½‰ä¹˜ (CATEGORY: äº¤é€š)
    { tag: 'åœ°éµ/éµé“', parent: 'è­¯', keywords: ['ç«™', 'é›»è»Š', 'åœ°éµ', 'æœˆå°', 'è½‰ä¹˜', 'å‡ºå£', 'æ”¹æœ­'] },
    { tag: 'å·´å£«/è¨ˆç¨‹è»Š', parent: 'è­¯', keywords: ['å…¬è»Š', 'å·´å£«', 'é‹è³ƒ', 'æ‹›å‘¼ç«™', 'å¾Œè»Šç®±', 'åœ°é»'] },
    
    // ğŸ± é¤å»³/é»é¤ (CATEGORY: ç”¨é¤)
    { tag: 'é»é¤/çµå¸³', parent: 'è­¯', keywords: ['èœå–®', 'æ¨è–¦', 'çµå¸³', 'è²·å–®', 'æœƒè¨ˆ', 'é»é¤', 'å¤–å¸¶'] },
    { tag: 'é£²é£Ÿé™åˆ¶', parent: 'è­¯', keywords: ['éæ•', 'å»è”¥', 'å»å†°', 'ç´ é£Ÿ', 'è¾£', 'ç‰›è‚‰', 'è±¬è‚‰', 'ä¸åŠ '] },

    // ğŸ›ï¸ è³¼ç‰©/é€€ç¨… (CATEGORY: è³¼ç‰©)
    { tag: 'å°ºå¯¸/åº«å­˜', parent: 'è­¯', keywords: ['è©¦ç©¿', 'é¡è‰²', 'å°ºå¯¸', 'åº«å­˜', 'æ–°å“', 'å±•ç¤ºå“', 'æ‹¿æ–°çš„'] },
    { tag: 'å…ç¨…/åŒ…è£', parent: 'è­¯', keywords: ['é€€ç¨…', 'å…ç¨…', 'TAX FREE', 'è­·ç…§', 'åˆ†é–‹åŒ…è£', 'è¢‹å­'] },

    // ğŸ¥ é†«ç™‚/æ‡‰æ€¥ (CATEGORY: é†«è—¥)
    { tag: 'ç—‡ç‹€æè¿°', parent: 'è­¯', keywords: ['ç—›', 'ç™¼ç‡’', 'é ­æšˆ', 'è—¥å±€', 'æ„Ÿå†’', 'éæ•', 'å—å‚·', 'è¨ºæ–·'] },
    { tag: 'ä½ç½®è©¢å•', parent: 'è­¯', keywords: ['å»æ‰€', 'å“ªè£¡', 'é™„è¿‘', 'æ´—æ‰‹é–“', 'åœ¨å“ª', 'è·é›¢'] }
];


// G. äº¤é€šæ¥­è€…è¦æ ¼å®šç¾© (å°ä½ï¼šæ–¹æ¡ˆäºŒ - æ¥­è€…+ç·¨è™Ÿ)
// ç¢ºä¿æ¸²æŸ“æ™‚èƒ½è‡ªå‹•æŠ“å–ä»£è¡¨è‰²ã€æ¥­è€…æ•™å­¸èˆ‡é è¨­åœ–ç¤º
const TRANSPORT_OPERATOR_CONFIG = {
    'è¥¿éµå·´å£«': { 
        color: '#FF5722', 
        icon: 'ğŸšŒ', 
        guide: 'å¾Œé–€ä¸Šè»ŠæŠ½æ•´ç†åˆ¸ï¼Œå‰é–€åˆ·å¡/æŠ•å¹£ä¸‹è»Šã€‚',
        official_site: 'https://www.nishitetsu.jp/zh_tw/bus/'
    },
    'äº¬éƒ½å¸‚ç‡Ÿå·´å£«': { 
        color: '#008b4b', 
        icon: 'ğŸšŒ', 
        guide: 'å‡ä¸€ç¥¨åƒ¹å€æ®µè«‹å¾å¾Œé–€ä¸Šè»Šï¼Œå‰é–€ä»˜è²»ä¸‹è»Šã€‚',
        official_site: 'https://www.city.kyoto.lg.jp/kotsu/'
    },
    'ç¦å²¡åœ°ä¸‹éµ': { 
        color: '#00a0e9', 
        icon: 'ğŸš‡', 
        guide: 'æ”¯æ´å…¨æ—¥æœ¬ IC å¡ï¼Œåˆ·å¡é€²å‡ºé–˜é–€ã€‚',
        official_site: 'https://subway.city.fukuoka.lg.jp/'
    },
    'JRä¹å·': { 
        color: '#f62e36', 
        icon: 'ğŸš†', 
        guide: 'ç‰¹æ€¥åˆ—è»Šéœ€é¡å¤–è³¼è²·ã€Œç‰¹æ€¥åˆ¸ã€ã€‚',
        official_site: 'https://www.jrkyushu.co.jp/'
    }
};

// ==========================================
// 2. äº¤é€šè¡Œç‚ºèˆ‡å­—å…¸å¢è£œ (UI æ¸²æŸ“èˆ‡æ¨¡ç³Šå°ä½ç”¨)
// ==========================================

// H. äº¤é€šè¡Œç‚ºé—œéµå­—è­˜åˆ¥
const TRANSPORT_ACTION_MAP = [
    { key: 'ä¹˜è»Š', icon: 'ğŸ›«', hint: 'è«‹æå‰ 10 åˆ†é˜æŠµé”å€™è»Šå€' },
    { key: 'è½‰ä¹˜', icon: 'ğŸ”„', hint: 'æ³¨æ„è½‰ä¹˜æ™‚é–“ï¼Œå»ºè­°ç¢ºèªæœˆå°ç·¨è™Ÿ' },
    { key: 'é ç´„', icon: 'ğŸŸï¸', hint: 'æ­¤æ®µè·¯ç¨‹å»ºè­°/å¼·åˆ¶é ç´„åˆ¶' },
    { key: 'æ­¥è¡Œ', icon: 'ğŸš¶', hint: 'å°èˆªæ¨¡å¼å•Ÿå‹•ï¼Œè«‹æ³¨æ„è·¯æ¨™' },
    { key: 'æŠµé”', icon: 'ğŸ“', hint: 'å·²åˆ°é”ç›®çš„åœ°é™„è¿‘' }
];

// I. äº¤é€šå­—å…¸å¢è£œ
const TRANSPORT_EXTENSIONS = [
    { tag: 'å·´å£«/å…¬è»Š', parent: 'è¡Œ', keywords: ['å·´å£«', 'BUS', 'å…¬è»Š', 'æ•´ç†åˆ¸', 'é‹è³ƒ'] },
    { tag: 'éµé“/åœ°éµ', parent: 'è¡Œ', keywords: ['JR', 'åœ°éµ', 'åœ°ä¸‹éµ', 'æ–°å¹¹ç·š', 'ç‰¹æ€¥', 'å¿«é€Ÿ'] },
    { tag: 'è½‰ä¹˜/å€™è»Š', parent: 'è¡Œ', keywords: ['æœˆå°', 'æ¡ˆå…§', 'æ”¹æœ­', 'è½‰ä¹˜', 'æ›ä¹˜'] },
    { tag: 'æ”¯ä»˜/ç¥¨åˆ¸', parent: 'è¡Œ', keywords: ['ICå¡', 'SUICA', 'SUGOCA', 'ç‰¹æ€¥åˆ¸', 'ä¸€æ—¥åˆ¸', 'ç²¾ç®—'] }
];

/** ğŸ”„ è‡ªå‹•åŒ–å­—å…¸åˆä½µå¼•æ“ */
(function initializeTransportDict() {
    if (typeof window.GLOBAL_DICT === 'undefined') {
        window.GLOBAL_DICT = []; // è‹¥å°šæœªå®šç¾©å‰‡åˆå§‹åŒ–
    }

    // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆä½µéï¼Œé¿å…é‡è¤‡æ³¨å…¥
    const hasTransport = window.GLOBAL_DICT.some(item => item.parent === 'è¡Œ');
    
    if (!hasTransport && typeof TRANSPORT_EXTENSIONS !== 'undefined') {
        console.log("ğŸ“¡ æ­£åœ¨åŸ·è¡Œäº¤é€šå­—å…¸å¢è£œ...");
        window.GLOBAL_DICT.push(...TRANSPORT_EXTENSIONS);
        console.log(`âœ… å­—å…¸åŒæ­¥å®Œæˆï¼šå·²å¢è£œ ${TRANSPORT_EXTENSIONS.length} çµ„äº¤é€šé—œéµå­—æŒ‡ç´‹ã€‚`);
    }
})();


/** ğŸ¯ èªå¥ç¯„ä¾‹ï¼šç”¨æ–¼ç”Ÿæˆ AI æŒ‡ä»¤æˆ–ç›´æ¥å°å…¥ç‡ƒæ–™åŒ… */
const TRANSLATION_SAMPLE_FUEL = [
    {
        "type": "translation",
        "category": "ç”¨é¤",
        "q": "æœ‰è‹±æ–‡æˆ–ä¸­æ–‡èœå–®å—ï¼Ÿ",
        "a": "è‹±èªã‹ä¸­å›½èªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
        "romaji": "Eigo ka chÅ«gokugo no menyÅ« wa arimasu ka?"
    },
    {
        "type": "translation",
        "category": "äº¤é€š",
        "q": "é€™å°é›»è»Šæœ‰åˆ°åšå¤šå—ï¼Ÿ",
        "a": "ã“ã®é›»è»Šã¯åšå¤šã«è¡Œãã¾ã™ã‹ï¼Ÿ",
        "romaji": "Kono densha wa Hakata ni ikimasu ka?"
    },
    {
        "type": "translation",
        "category": "è³¼ç‰©",
        "q": "è«‹å•å¯ä»¥é€€ç¨…å—ï¼Ÿ",
        "a": "å…ç¨ã®æ‰‹ç¶šãã¯ã§ãã¾ã™ã‹ï¼Ÿ",
        "romaji": "Menzei no tetsuzuki wa dekimasu ka?"
    }
];

const APP_ID = 'MY_TRIP_PLANNER_DATA_V3';
const SUB_VIEWS = ['settings', 'itinerary', 'bucket', 'magazine', 'translate', 'expense', 'shopping', 'emergency', 'data'];

// 2. å”¯ä¸€å…¨åŸŸç‹€æ…‹å®£å‘Š (v3.0.0 äº¤é€šè·¯ç¶²ä¸­å¿ƒå¯¦é«”åŒ–)
let state = {
    version: '3.0.0', // âœ¨ å‡ç´šè‡³ 3.0.0ï¼šå°å…¥ç¨ç«‹äº¤é€šè·¯ç¶²èˆ‡è§¸ç™¼è¨»è§£é«”ç³»
    
    // --- è¨ˆç•«æ¨¡å¼ç‹€æ…‹ (è¦åŠƒå·¥åŠ) ---
    planViewMode: 'master', // 'master' æˆ– 'workshop'
    shadowItineraries: {},  // å­˜æ”¾å·¥åŠæš«å­˜æ•¸æ“š
    
    // --- æ•¸æ“šçµ±è¨ˆèˆ‡åŸºç¤è³‡è¨Š ---
    apiTotalCostNTD: 0,
    currentTripId: null,
    currentDayIndex: 0,
    currentSubView: 'itinerary',
    totalBudget: 50000,
    currency: 'JPY',
    travelers: 2,
    currentWorkshopId: null, 
    workshops: [],

    // --- ğŸ† æˆ°ç•¥ç·¨å¹´å²ï¼šé–‹ç™¼æ—¥èªŒæ•¸æ“š ---
    versionGroups: [
        {
            major: '3.0',
            title: 'äº¤é€šè·¯ç¶²ä¸­å¿ƒèˆ‡è§¸ç™¼å¼è¨»è§£é«”ç³»',
            versions: [
                {
                    v: '3.0.0',
                    date: '2026-01-16',
                    logs: [
                        'ğŸš‰ å¯¦ä½œã€Œäº¤é€šè·¯ç¶²ä¸­å¿ƒ (transportVault)ã€ï¼Œå»ºç«‹æ¥­è€…ã€è·¯ç·šåºåˆ—èˆ‡ç«™é»ä¸‰å±¤æ¶æ§‹ã€‚',
                        'ğŸ’¡ å°å…¥ã€Œè§¸ç™¼å¼è¨»è§£ (dynamic_notes)ã€ï¼Œé”æˆç‰¹å®šèµ·é»æˆ–è·¯æ®µè‡ªå‹•å™´å‡ºæˆ°è¡“æŒ‡å¼•ã€‚',
                        'ğŸ¯ ç¢ºç«‹ã€Œæ–¹æ¡ˆäºŒï¼šè¦æ ¼åŒ–è¼¸å…¥ã€ï¼Œç¢ºä¿äº¤é€šå°å¡èˆ‡è³‡æ–™åº«ç´¢å¼• 100% ç²¾æº–å°ä½ã€‚'
                    ]
                }
            ]
        },
        {
            major: '2.5',
            title: 'æ•¸æ“šè‡ªç™’èˆ‡ç¿»è­¯ç¨ç«‹åŒ–é«”ç³»',
            versions: [
                {
                    v: '2.5.5',
                    date: '2026-01-16',
                    logs: [
                        'ğŸ—£ï¸ å¯¦ä½œã€Œç¿»è­¯å°ˆå±¬åº« (translationVault)ã€ï¼Œé”æˆç¿»è­¯èªå¥èˆ‡å£è¢‹åå–®æ•¸æ“šå¾¹åº•éš”é›¢ã€‚',
                        'â›½ å°å…¥ã€Œç¿»è­¯å¿«é€Ÿç‡ƒæ–™åŒ…ã€æ©Ÿåˆ¶ï¼Œæ”¯æ´æ—¥èªç™¼éŸ³ã€ç¾…é¦¬æ‹¼éŸ³èˆ‡å ´æ™¯åˆ†é¡åŒæ­¥å°å…¥ã€‚'
                    ]
                }
            ]
        }
    ],

    // --- ğŸ“‚ æˆ°ç•¥å­˜å„²åˆ†æµå°ˆå€ ---
    bucketList: [],           // æ™¯é»èˆ‡ç¾é£Ÿ (æ ¸å¿ƒå£è¢‹åå–®)
    translationVault: [],     // ç¿»è­¯ä¿éšªç®±ï¼šå­˜æ”¾å°ˆæ¥­ç¿»è­¯èªå¥
    
    // âœ¨ ğŸš‰ äº¤é€šè·¯ç¶²ä¸­å¿ƒï¼šå­˜æ”¾æ¥­è€…ã€è·¯ç·šåºåˆ—èˆ‡è§¸ç™¼å¼è¨»è§£
    transportVault: [],       

    // --- æˆ°ç•¥å­˜å„²å¯¦é«”å…§å®¹ ---
    trips: [],
    shoppingList: [
        { id: generateUUID(), name: 'ç•¶åœ°ç‰¹è‰²é¤…è“‹', quantity: 5, price: 120, store: 'è€è¡—ç‰¹ç”¢åº—', checked: false, isAI: false },
        { id: generateUUID(), name: 'æ–°æ‰‹æ©Ÿå……é›»ç·š', quantity: 1, price: 350, store: 'é›»å­è³£å ´', checked: true, isAI: false }
    ],

    // --- ğŸš¨ ç·Šæ€¥æ•‘è­·èˆ‡è³‡æ´ (å·²æ•´åˆé è¨­æ•¸æ“š) ---
    emergencyContacts: {
        embassies: [
            { id: generateUUID(), name: 'é§æ—¥æœ¬è‡ºåŒ—ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•', address: 'æ±äº¬éƒ½æ¸¯å€ç™½é‡‘å°5ä¸ç›®20-2', phone: '+81-3-3280-7800', rescuePhone: '+81-80-6065-2747', isAI: false }
        ],
        medical: [
            { id: generateUUID(), name: 'æ±äº¬æ…ˆæƒ æœƒé†«ç§‘å¤§å­¸é™„å±¬é†«é™¢', info: 'æä¾›ä¸­æ–‡å£è­¯æœå‹™', address: 'æ±äº¬éƒ½æ¸¯å€è¥¿æ–°æ©‹3-25-8', phone: '+81-3-3433-1111', isAI: false }
        ]
    },

    // --- ğŸ¤– AI é…ç½®ç‹€æ…‹ ---
    aiDayConfig: { 
        preferredTransport: 'train', 
        customPreferredTransport: '',
        // âœ¨ æ–°å¢ï¼šäº¤é€šè·¯ç¶²å°ä½åå¥½ (ç¢ºä¿ AI ç”Ÿæˆæ ¼å¼ç¬¦åˆè¦æ ¼åŒ–æ¨™æº–)
        useStrictTransportDict: true 
    },
    aiShoppingConfig: { city: 'å°åŒ—', currency: 'NTD' },
    aiEmergencySearchResults: { city: '', embassies: [], medical: [] },

    // --- å…¶ä»– UI ç‹€æ…‹ ---
    expandedCategory: null,
    theme: {
        primary: THEME_COLORS['ç«ç‘°ç²‰'],
        geminiKey: '',
        aiPenStyle: 'theme-text-pink'
    }
}; // ğŸ¯ æ­£ç¢ºé–‰åˆå…¨åŸŸç‹€æ…‹ state


// ğŸŒŸ å»ºè­°åœ¨æ­¤è™•æ’å…¥ï¼šåˆ†é æ§åˆ¶å™¨
window.stagingPagination = {
    currentPage: 1,
    pageSize: 10,
    get totalPages() {
        return Math.ceil((window.currentStagingItems?.length || 0) / this.pageSize);
    }
};


// å°‡åŸæœ‰çš„ aiCache çµ±ä¸€æ”¹åç‚º aiContentCache
let aiContentCache = JSON.parse(localStorage.getItem('my_trip_ai_cache') || '{}');

// function importData(event) { ... } // æª”æ¡ˆè®€å–å…¥å£
let pendingMergeData = [];

/** å¸¶æœ‰å¿«å–æ©Ÿåˆ¶çš„ AI è«‹æ±‚å‡½æ•¸ */
async function getAIPlusWithCache(itemName, currentNotes) {
    const cacheKey = `${itemName}_${currentNotes}`.trim();

    // 1. æª¢æŸ¥å¿«å–æ˜¯å¦å­˜åœ¨
    if (aiCache[cacheKey]) {
        console.log("â™»ï¸ åµæ¸¬åˆ°ç›¸åŒå…§å®¹ï¼Œå¾å¿«å–è®€å–ä»¥ç¯€çœ API é¡åº¦");
        return aiCache[cacheKey];
    }

    // 2. å¦‚æœæ²’æœ‰å¿«å–ï¼Œæ‰åŸ·è¡ŒåŸæœ¬çš„ API å‘¼å« (é€™éƒ¨åˆ†ç¶­æŒæ‚¨åŸæœ‰çš„ fetch é‚è¼¯)
    // å‡è¨­åŸæœ¬çš„ callGeminiApi æ˜¯æ‚¨ç™¼é€è«‹æ±‚çš„å‡½æ•¸
    const result = await callGeminiApi(itemName, currentNotes); 

    // 3. å­˜å…¥å¿«å–ä¸¦é™åˆ¶å¿«å–å¤§å° (é¿å… localStorage çˆ†æ‰)
    aiCache[cacheKey] = result;
    if (Object.keys(aiCache).length > 100) { // åªä¿ç•™æœ€è¿‘ 100 ç­†
        const firstKey = Object.keys(aiCache)[0];
        delete aiCache[firstKey];
    }
    localStorage.setItem('trip_ai_cache', JSON.stringify(aiCache));

    return result;
}



// âœ¨ é‡è¦ä¿®æ­£ï¼šå°‡å­—å…¸åˆå§‹åŒ–ç¨ç«‹ç§»å‡ºï¼Œä¸æ”¾åœ¨ state ç‰©ä»¶å…§
window.GLOBAL_DICT = JSON.parse(localStorage.getItem('my_trip_dict')) || DEFAULT_DICTIONARY;

/**
 * é¡¯ç¤ºç‰ˆæœ¬æ­·å²æ¨¡æ…‹æ¡† (v1.2.0 åˆ†çµ„éšå±¤ç‰ˆ)
 */
function showVersionHistory() {
    const bodyEl = document.getElementById('version-history-body');
    if (!bodyEl) return;
    
    let html = `<div class="space-y-6">`;
    
    state.versionGroups.forEach((group, gIndex) => {
        const isLatestGroup = gIndex === 0;
        
        html += `
            <div class="version-group border-l-4 border-slate-200 pl-4 mb-8">
                <div class="flex items-center mb-4">
                    <span class="bg-slate-800 text-white text-[10px] font-black px-2 py-0.5 rounded-md mr-2">MAJOR ${group.major}</span>
                    <h4 class="text-sm font-black text-gray-700">${group.title}</h4>
                </div>
                
                <div class="space-y-4">`;
        
        group.versions.forEach((item, vIndex) => {
            const isLatestVersion = isLatestGroup && vIndex === 0;
            const dotColor = isLatestVersion ? 'bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.6)]' : 'bg-slate-300';

            html += `
                <details class="group/v border-b border-gray-50 pb-2" ${isLatestVersion ? 'open' : ''}>
                    <summary class="flex items-center justify-between cursor-pointer list-none">
                        <div class="flex items-center space-x-2">
                            <div class="w-1.5 h-1.5 rounded-full ${dotColor}"></div>
                            <span class="font-bold text-gray-700 text-xs">v${item.v}</span>
                            <span class="text-[8px] text-gray-400 font-mono">${item.date}</span>
                        </div>
                        <div class="text-gray-300 group-open/v:rotate-180 transition-transform scale-75">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </summary>
                    <div class="pl-4 pt-2 animate-in slide-in-from-top-1 duration-200">
                        <ul class="text-[11px] text-gray-500 space-y-1.5 border-l border-slate-100 pl-3">
                            ${item.logs.map(log => `<li class="leading-relaxed flex items-start"><span class="text-cyan-400 mr-1.5">â—</span>${log}</li>`).join('')}
                        </ul>
                    </div>
                </details>`;
        });

        html += `</div></div>`;
    });
    
    html += `</div>`;
    
    bodyEl.innerHTML = html;
    toggleModal('version-history-modal');
}

/** ğŸŒ åœ°ç†æŒ‡ç´‹ç‰©ç†åŒ–å›å¡« (v4.8 æ——è‰¦å›å¡«ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [ç‰©ç†æ¸…å ´] å›å¡«å‰å¼·åˆ¶åˆ·æ–° window.GEO_REGIONSï¼Œé˜²æ­¢èˆŠå€åŸŸæ±¡æŸ“ã€‚
 * 2. [é˜²ç¦¦æ€§å€¼] ç¢ºä¿ lng/lat çµ•é undefinedï¼Œè‹¥ç‚º 0 å‰‡åœ¨ Console å ±è­¦ã€‚
 * 3. [é›™è»Œæ”¯æ´] ç¢ºä¿å…¨åŸŸè®Šæ•¸èˆ‡ state åŒæ­¥ã€‚
 */
async function syncGeoRegionsToMemory() {
    const physGeo = await dbManager.getAll('geo_regions_store');
    
    if (physGeo && physGeo.length > 0) {
        // ğŸŒŸ 1. å¾¹åº•åˆ·æ–°è¨˜æ†¶é«”å®¹å™¨
        window.GEO_REGIONS = {}; 
        
        // ğŸŒŸ 2. ç‰©ç†è½‰è­¯ï¼šæ§‹å»ºé›™è»Œæ˜ å°„
        window.GEO_REGIONS = physGeo.reduce((acc, curr) => {
            if (curr.regionName) {
                // A. èªæ„åˆ¥åæ˜ å°„
                acc[curr.regionName] = curr.aliases || [];
                
                // B. åœ°åœ–åº§æ¨™æ˜ å°„ (ç¢ºä¿æ•¸å€¼å‹æ…‹)
                const lng = parseFloat(curr.lng) || 0;
                const lat = parseFloat(curr.lat) || 0;
                
                acc[curr.regionName + "_coords"] = { 
                    lng: lng, 
                    lat: lat, 
                    zoom: curr.zoom || 11 
                };

                // ğŸ›¡ï¸ è¨ºæ–·ï¼šè‹¥åº§æ¨™ç‚º 0 å‰‡ç™¼å‡ºç‰©ç†è­¦å ±
                if (lng === 0 && lat === 0) {
                    console.warn(`âš ï¸ [åœ°ç†å›å¡«] å€åŸŸã€Œ${curr.regionName}ã€åº§æ¨™ç¼ºå¤±ï¼Œè«‹åŸ·è¡Œç‰©ç†è£œå¼·ã€‚`);
                }
            }
            return acc;
        }, {});

        // ğŸŒŸ 3. åŒæ­¥è‡³ state ä¾› UI å…ƒä»¶è®€å– (è‹¥ state å·²å®šç¾©)
        if (window.state) {
            state.geoRegions = physGeo;
        }

        console.log(`%cğŸŒ [å¤§ä¸€çµ±å›å¡«] ç‰©ç†ç£å€ ${physGeo.length} ç­†åœ°ç†æŒ‡ç´‹å·²å…¨é€ŸåŠ è¼‰ã€‚`, "color: #10b981; font-weight: bold;");
    } else {
        console.warn("ğŸ“¡ [åœ°ç†å›å¡«] ç£å€ç„¡è³‡æ–™ï¼Œç­‰å¾…ç§»æ°‘å®˜å•Ÿå‹•...");
    }
}

// è·¯ç¶²ä¸­å¿ƒç›¸é—œå‡½æ•¸èµ·é»

/** ğŸš‰ æ¸²æŸ“äº¤é€šè·¯ç¶²ä¸­å¿ƒæ¸…å–® v3.2.4 - ç‰©ç†å°ä½èˆ‡æ¥­è€…è‡ªå‹•æ„Ÿæ‡‰ä¿®æ­£ç‰ˆ
 * ä¿®æ­£é»ï¼š
 * 1. [è‡ªå‹•è§£é–] å‹•æ…‹åµæ¸¬è³‡æ–™åº«ä¸­çš„æ¥­è€…ï¼Œè‡ªå‹•æ›´æ–°éæ¿¾ä¸‹æ‹‰é¸å–®ï¼Œè§£æ±ºæ–°æ³¨å…¥æ¥­è€…è¢«éš±è—çš„å•é¡Œã€‚
 * 2. [æ•¸æ“šæ­¸ä¸€] çµ±ä¸€æ¨™é¡Œèˆ‡æ•¸é‡çµ±è¨ˆï¼Œç¢ºä¿ã€Œç¬¦åˆæ•¸ / ç¸½æ•¸ã€æ¸…æ™°å¯è¦‹ï¼Œæ’é™¤ 14 ç­†é™åˆ¶æ„Ÿã€‚
 * 3. [ç‰©ç†å°ä½] å¼·åŒ–èˆ‡ IndexedDB çš„éˆæ¥ï¼Œç¢ºä¿è·¯ç¶²è³‡ç”¢ 100% é¡¯å½±ã€‚
 */
function renderTransportHub() {
    const listContainer = document.getElementById('transport-vault-list');
    const filterOpSelect = document.getElementById('transport-filter-op');
    const searchInput = document.getElementById('transport-search');
    
    // ğŸ›¡ï¸ å®‰å…¨å®ˆè¡›ï¼šé˜²æ­¢å®¹å™¨éºå¤±å ±éŒ¯
    if (!listContainer) return;

    // 1. å–å¾—æ¬Šå¨æ•¸æ“š (Source of Truth)
    const routes = (window.state && window.state.transportVault) ? window.state.transportVault : [];

    // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå‹•æ…‹æ›´æ–°æ¥­è€…éæ¿¾é¸å–®
    // é€™ä¸€æ­¥ç¢ºä¿ã€ŒåŒ—ä¹å·äº¤é€šã€æ³¨å…¥å¾Œï¼Œä¸‹æ‹‰é¸å–®æœƒç«‹åˆ»å‡ºç¾è©²é¸é …ï¼Œå¦å‰‡éæ¿¾å™¨æœƒå°‡å…¶åˆ¤å®šç‚ºç„¡æ•ˆ
    if (filterOpSelect) {
        const actualOpsInData = [...new Set(routes.map(r => r.operator_id))].filter(Boolean).sort();
        const currentOptions = Array.from(filterOpSelect.options).map(o => o.value);
        
        // åµæ¸¬æ˜¯å¦æœ‰è³‡æ–™åº«æœ‰çš„æ¥­è€…ï¼Œä½†é¸å–®è£¡æ²’æœ‰çš„
        const needsUpdate = actualOpsInData.some(op => !currentOptions.includes(op));

        if (needsUpdate) {
            const currentVal = filterOpSelect.value;
            filterOpSelect.innerHTML = '<option value="all">æ‰€æœ‰æ¥­è€…</option>';
            actualOpsInData.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op;
                opt.innerText = op;
                filterOpSelect.appendChild(opt);
            });
            // æ¢å¾©åŸæœ¬é¸ä¸­çš„å€¼ï¼Œè‹¥åŸæœ¬é¸çš„å·²ä¸å­˜åœ¨å‰‡è¨­å› all
            filterOpSelect.value = actualOpsInData.includes(currentVal) ? currentVal : "all";
        }
    }

    // 2. åŸ·è¡Œéæ¿¾é‚è¼¯
    const searchTerm = (searchInput?.value || "").toLowerCase().trim();
    const filterOp = filterOpSelect?.value || "all";

    const filteredRoutes = routes.filter(r => {
        const matchSearch = r.operator_id.toLowerCase().includes(searchTerm) || 
                            r.line_id.toLowerCase().includes(searchTerm) ||
                            (r.stations && r.stations.some(s => s.toLowerCase().includes(searchTerm)));
        const matchOp = (filterOp === 'all' || r.operator_id === filterOp);
        return matchSearch && matchOp;
    });

    // ğŸŒŸ 3. æ§‹é€ ã€Œå–®ä¸€æ¬Šå¨æ¨™é¡Œåˆ—ã€ (å„ªåŒ–æ•¸é‡é¡¯ç¤º)
    const globalAiCommand = `è«‹å¹«æˆ‘ç”Ÿæˆæ—…è¡Œè·¯ç¶² JSON ç‡ƒæ–™åŒ…ã€‚æ ¼å¼éœ€åŒ…å«ï¼šoperator_id, line_id, color, stations (ç«™é»åç¨±é™£åˆ—), descriptionã€‚è«‹é‡å°æ—¥æœ¬çš„äº¤é€šå·¥å…·é€²è¡Œç·¨å¯«ã€‚`;
    
    let headerHtml = `
        <div class="flex justify-between items-center mb-6 px-2">
            <div class="flex items-center gap-3">
                <div class="w-1.5 h-4 theme-pink rounded-full"></div>
                <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">ç¾å½¹è·¯ç¶²è³‡ç”¢</h4>
                <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold text-slate-400">
                    ç¬¦åˆ: ${filteredRoutes.length} / ç¸½è¨ˆ: ${routes.length}
                </span>
            </div>
            <button onclick="copyToClipboard('${globalAiCommand}', this)" 
                    class="flex items-center gap-1.5 px-4 py-2 rounded-full theme-bg-light theme-text-pink text-[11px] font-black hover:opacity-80 active:scale-95 transition-all shadow-sm">
                <span class="icon-state">âœ¨</span> <span class="text-state">æŒ‡ä»¤ç¯„æœ¬</span>
            </button>
        </div>
    `;

    // 4. è™•ç†ç©ºæ…‹è¦–åœ– (Empty State)
    if (filteredRoutes.length === 0) {
        listContainer.innerHTML = headerHtml + `
            <div class="p-12 text-center bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200 animate-in fade-in duration-500">
                <div class="text-5xl mb-4 opacity-20">ğŸš‰</div>
                <p class="text-slate-400 text-sm font-black uppercase tracking-widest">ç„¡åŒ¹é…ç·šè·¯</p>
                <p class="text-slate-300 text-[10px] mt-2 font-medium">è«‹èª¿æ•´éæ¿¾æ¢ä»¶æˆ–æ³¨å…¥ JSON ç‡ƒæ–™åŒ…</p>
            </div>
        `;
    } else {
        // 5. åŸ·è¡Œç¶²æ ¼æ¸²æŸ“
        listContainer.innerHTML = headerHtml + `
            <div class="space-y-3">
                ${filteredRoutes.map((route) => {
                    const opConfig = window.TRANSPORT_OPERATOR_CONFIG ? window.TRANSPORT_OPERATOR_CONFIG[route.operator_id] : null;
                    const themeColor = route.color || route.meta?.color || opConfig?.color || '#64748b';
                    const routeKey = route.id || `${route.operator_id}_${route.line_id}`;

                    return `
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm flex items-center justify-between group hover:border-pink-200 hover:shadow-md transition-all duration-300">
                            <div class="flex items-center gap-4 min-w-0 flex-1">
                                <div class="w-1.5 h-10 rounded-full flex-shrink-0" style="background-color: ${themeColor}"></div>
                                <div class="min-w-0 text-left">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter truncate max-w-[120px]">${route.operator_id}</span>
                                        <div class="h-1 w-1 rounded-full bg-slate-200"></div>
                                        <span class="text-sm font-black text-slate-800 truncate">${route.line_id}</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-[11px] font-bold text-slate-500 bg-slate-50 px-2 py-0.5 rounded-md italic">
                                            ğŸ“ ${route.stations?.length || 0} ç‰©ç†ç«™é»
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                                <button onclick="deleteRoute('${routeKey}')" class="p-3 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-2xl transition-all" title="ç‰©ç†æ’¤ç·¨">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
}

/** ğŸš‰ æ‰‹å‹•ç·šè·¯å»ºç«‹å™¨ (v1.0.0 ç‰©ç†é–å®šç‰ˆ)
 * ä½œç”¨ï¼šå–ä»£ prompt é›¶æ˜Ÿè¼¸å…¥ï¼Œå°‡æ–°ç·šè·¯æ­£å¼ç·¨å…¥ transport_store
 */
async function addTransportLine() {
    const operator = prompt("è«‹è¼¸å…¥æ¥­è€…åç¨± (å¦‚: JRä¹å·, è¥¿éµå·´å£«):");
    if (!operator) return;
    const lineId = prompt("è«‹è¼¸å…¥ç·šè·¯ç·¨è™Ÿ/åç¨± (å¦‚: ä¹å·æ–°å¹¹ç·š, 302):");
    if (!lineId) return;
    const stationsStr = prompt("è«‹è¼¸å…¥ç«™é» (ç”¨é€—è™Ÿéš”é–‹):", "åšå¤š, ç†Šæœ¬, é¹¿å…’å³¶ä¸­å¤®");
    if (!stationsStr) return;

    const stations = stationsStr.split(/[,ï¼Œ/ã€]+/).map(s => s.trim()).filter(s => s);
    const routeKey = `${operator}_${lineId}`;

    const newRoute = {
        id: routeKey,
        operator_id: operator,
        line_id: lineId,
        stations: stations,
        meta: {
            color: window.TRANSPORT_OPERATOR_CONFIG?.[operator]?.color || "#64748b",
            guide: "æ‰‹å‹•å»ºç«‹çš„åƒè€ƒç·šè·¯"
        },
        lastUpdated: new Date().toISOString()
    };

    // ğŸŒŸ 1. ç‰©ç†å¯«å…¥
    await dbManager.save('transport_store', newRoute);
    
    // ğŸŒŸ 2. è¨˜æ†¶é«”åŒæ­¥
    if (!window.state.transportVault) window.state.transportVault = [];
    const idx = window.state.transportVault.findIndex(r => r.id === routeKey);
    if (idx > -1) window.state.transportVault[idx] = newRoute;
    else window.state.transportVault.push(newRoute);

    // ğŸŒŸ 3. å¼·åˆ¶åŸ·è¡Œç‰©ç†å¿«ç…§ (å‚³å…¥ true ä»¥ç©¿é€åŸå­é–)
    await saveData(true);
    
    if (typeof renderTransportHub === 'function') renderTransportHub();
    showMessage(`âœ… ç·šè·¯ [${lineId}] å·²é–å®šè‡³å¯¦é«”ç£å€`, 'success');
}

/** ğŸ—‘ï¸ åˆªé™¤å–®ä¸€ç‰¹å®šè·¯ç·š (v3.9 ç‰©ç†å¤§ä¸€çµ±ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å°ä½ HTML onclick çš„åç¨± "deleteRoute"ï¼Œé”æˆ 100% å‘¼å«é€£çµã€‚
 * 2. ç‰©ç†æ’¤ç·¨ï¼šåŒæ­¥æ¸…é™¤ç£å€ (transport_store) èˆ‡ä¸»å¿«ç…§ (main_state)ã€‚
 * 3. å½±å­è‡ªç™’ï¼šè‹¥åœ¨è¦åŠƒå·¥åŠä¸­ä½¿ç”¨äº†è©²ç·šè·¯ï¼Œå¼·åˆ¶è§¸ç™¼é‡ç¹ªä»¥æ›´æ–°è¦–è¦ºã€‚
 */
async function deleteRoute(routeFullId) {
    if (!routeFullId) return;
    
    // ğŸ’¡ æˆ°è¡“æç¤ºï¼šå‘ŠçŸ¥æŒ‡æ®å®˜å—å½±éŸ¿çš„ç·šè·¯å
    const route = (state.transportVault || []).find(r => r.id === routeFullId || `${r.operator_id}_${r.line_id}` === routeFullId);
    const displayName = route ? `${route.operator_id} ${route.line_id}` : routeFullId;

    if (!confirm(`ç¢ºå®šè¦å°‡è·¯ç¶² [${displayName}] å¾ç‰©ç†æˆ¿é–“æ°¸ä¹…æ’¤ç·¨å—ï¼Ÿ\né€™å°‡åŒæ™‚ç§»é™¤èªæ„æ„Ÿæ‡‰æŒ‡ç´‹ã€‚`)) return;

    // ğŸ›¡ï¸ 1. å•Ÿå‹•åŸå­é–ï¼šé˜²æ­¢åˆªé™¤æœŸé–“èƒŒæ™¯å­˜æª”å¹²æ“¾
    window.isTransportUpdating = true;

    try {
        console.log(`ğŸ§¹ å•Ÿå‹•ç‰©ç†æ’¤ç·¨ç¨‹åº: ${routeFullId}`);

        // ğŸš€ 2. ç‰©ç†å±¤ç›´æ¥ç§»é™¤ (IndexedDB)
        if (window.dbManager && window.dbManager.db) {
            await new Promise((resolve, reject) => {
                const tx = window.dbManager.db.transaction(['transport_store'], 'readwrite');
                const store = tx.objectStore('transport_store');
                const request = store.delete(routeFullId);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(new Error("ç‰©ç†ç£å€å¯«å…¥å¤±æ•—"));
            });
        }

        // ğŸ›¡ï¸ 3. åŒæ­¥æ¸…ç†å…¨åŸŸè¨˜æ†¶é«”ç‹€æ…‹
        if (window.state && window.state.transportVault) {
            window.state.transportVault = window.state.transportVault.filter(
                r => (r.id !== routeFullId && `${r.operator_id}_${r.line_id}` !== routeFullId)
            );
        }

        // ğŸŒŸ 4. ã€æ ¸å¿ƒé—œéµã€‘åŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª” (Force Mode)
        // å‚³å…¥ true ä»¥æ“Šç©¿åŸå­é–ï¼Œè§£æ±ºã€Œ14è®Š18ã€æˆ–ã€Œåˆªé™¤å¾Œå½ˆå›ã€çš„ç£å€æ®˜ç•™ç—…ç¶ã€‚
        if (typeof saveData === 'function') {
            await saveData(true);
        }

        // ğŸ”„ 5. è·¨è¦–åœ–é‡ç¹ª
        // A. åˆ·æ–°è·¯ç¶²ç®¡ç†ä¸­å¿ƒä»‹é¢
        if (typeof renderTransportHub === 'function') {
            renderTransportHub();
        }

        // B. è‹¥ç•¶å‰æ­£åœ¨æŸ¥çœ‹è¡Œç¨‹ï¼Œå¼·åˆ¶é‡æ–°è¨ˆç®—æ™‚é–“è»¸ (é€™æœƒè®“å·²åˆªé™¤çš„è·¯ç¶²æ¨™ç±¤å¤±å»é¡è‰²)
        const trip = getCurrentTrip();
        if (trip && state.currentSubView === 'itinerary') {
            trip.days.forEach(day => recalculateScheduleTimes(day));
            renderDayContent();
        }
        
        showMessage(`âœ… è·¯ç¶²è³‡ç”¢ [${displayName}] å·²å¾ç‰©ç†æˆ¿é–“ç§»é™¤`, 'success');

    } catch (err) {
        console.error("âŒ åˆªé™¤ç¨‹åºå´©æ½°:", err);
        showMessage("æ’¤ç·¨å¤±æ•—ï¼šè³‡æ–™åº«é€£ç·šç•°å¸¸", "error");
    } finally {
        // ğŸ”“ 6. æœ€çµ‚é‡‹æ”¾æ›´æ–°é–
        window.isTransportUpdating = false;
        console.log("ğŸ”“ ç‰©ç†æ›´æ–°é–å·²é‡‹æ”¾");
    }
}


/** ğŸ§  è·¯ç¶²æŒ‡ç´‹æª¢ç´¢ (v1.1.0)
 * ä½œç”¨ï¼šä¾›è¨ºæ–·å¤§è…¦æŸ¥è©¢ç‰©ç†è·¯ç¶²å…§çš„è©³ç´°è³‡è¨Šã€‚
 * ä¿®æ­£ï¼šå°å…¥æ¨¡ç³ŠåŒ¹é…èˆ‡å®‰å…¨éˆè·¯ï¼Œç¢ºä¿å¤§è…¦ 100% è®€å–åˆ°æ³¨å…¥çš„ç‡ƒæ–™ã€‚
 */
function findTransportDescription(operatorId, lineId) {
    // 1. ç¢ºä¿æ•¸æ“šåŸºåº§å­˜åœ¨
    const vault = window.state?.transportVault || [];
    if (vault.length === 0) return null;

    // 2. åŸ·è¡Œæ­¸ä¸€åŒ–æœå°‹ (é˜²æ­¢å¤§å°å¯«æˆ–ç©ºç™½å°è‡´åŒ¹é…å¤±æ•—)
    const targetOp = String(operatorId || "").trim().toUpperCase();
    const targetLine = String(lineId || "").trim().toUpperCase();

    const route = vault.find(r => {
        const opMatch = String(r.operator_id).trim().toUpperCase() === targetOp;
        const lineMatch = String(r.line_id).trim().toUpperCase() === targetLine;
        return opMatch && lineMatch;
    });

    // 3. å›å‚³å®Œæ•´å¯¦é«”ç‰©ä»¶ (å« stations, meta, dynamic_notes)
    if (route) {
        console.log(`ğŸ¯ [æŒ‡ç´‹å‘½ä¸­] å·²æª¢ç´¢åˆ°æ¥­è€…: ${route.operator_id} | ç·šè·¯: ${route.line_id}`);
        return route;
    }

    return null;
}



/** ğŸ“‹ è¼”åŠ©å·¥å…·ï¼šè¤‡è£½èˆ‡ UI ç‹€æ…‹åé¥‹ */
function copyToClipboard(text, btnElement) {
    navigator.clipboard.writeText(text).then(() => {
        const originalHTML = btnElement.innerHTML;
        const originalClass = btnElement.className;
        
        // åˆ‡æ›è‡³æˆåŠŸç‹€æ…‹
        btnElement.innerHTML = '<span>âœ…</span> æŒ‡ä»¤å·²è¤‡è£½';
        btnElement.className = btnElement.className.replace('text-blue-500 bg-blue-50', 'text-green-600 bg-green-50');
        
        setTimeout(() => {
            btnElement.innerHTML = originalHTML;
            btnElement.className = originalClass;
        }, 2000);
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
    });
}

/** ğŸ§  æ™ºæ…§è¨ºæ–·å¤§è…¦ (é‚è¼¯ç°¡åŒ–ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. å¾¹åº•ç§»é™¤è·¨å€ç§»å‹•ã€æ–°å¹¹ç·šã€æ‰‹æ®µæ„Ÿæ‡‰ç­‰ä¸ç©©å®šæé†’æ©Ÿåˆ¶ï¼Œæ¶ˆé™¤å¹²æ“¾ã€‚
 * 2. åƒ…ä¿ç•™æ ¸å¿ƒç‰©ç†é™åˆ¶ï¼šç‡Ÿæ¥­æ™‚é–“èˆ‡å…¬ä¼‘æ—¥åˆ¤æ–·ã€‚
 */
function diagnoseTimeConflict(planDate, planTime, dbItem, prevItem = null) {
    if (!dbItem) return { status: 'ok', msg: '' };

    const schedule = dbItem.schedule || (dbItem.raw ? dbItem.raw.schedule : null) || dbItem.meta || null;
    
    const toMin = (t) => {
        if (!t || !t.includes(':')) return 0;
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    };

    // --- ğŸ” åƒ…åŸ·è¡Œç‡Ÿæ¥­æ™‚é–“èˆ‡å…¬ä¼‘æ—¥åˆ¤æ–· (ç‰©ç†ç¡¬é™åˆ¶) ---
    if (schedule && schedule.open) {
        const { open, close, offDays } = schedule;
        const dateObj = new Date(planDate);
        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });

        // 1. å…¬ä¼‘æ—¥è¨ºæ–·
        if (Array.isArray(offDays) && offDays.includes(dayName)) {
            return { 
                status: 'danger', 
                msg: `âŒ è­¦å‘Šï¼šè©²åº—æ–¼ ${dayName} å›ºå®šå…¬ä¼‘ï¼` 
            };
        }

        // 2. ç‡Ÿæ¥­æ™‚æ®µè¨ºæ–·
        const planMin = toMin(planTime);
        const openMin = toMin(open);
        const closeMin = toMin(close);
        
        // è€ƒæ…®è·¨åˆå¤œç‡Ÿæ¥­é‚è¼¯ (å¦‚ 18:00 - 02:00)
        const isOpen = (closeMin < openMin) 
            ? (planMin >= openMin || planMin <= closeMin) 
            : (planMin >= openMin && planMin <= closeMin);

        if (!isOpen) {
            return { 
                status: 'warning', 
                msg: `âš ï¸ æ™‚æ®µæé†’ï¼šé å®šæŠµé”æ™‚é–“ä¸åœ¨ç‡Ÿæ¥­æ™‚é–“å…§ (ç‡Ÿæ¥­æ™‚é–“: ${open}-${close})` 
            };
        }
    }

    // ğŸŒŸ ç§»é™¤æ‰€æœ‰ç§»å‹•ã€æ–°å¹¹ç·šã€å€åŸŸè¡çªä¹‹é‚è¼¯
    return { status: 'ok', msg: '' };
}

/** ğŸ¨ æ™ºæ…§è¨ºæ–·è­¦èªæ¸²æŸ“ (æ——è‰¦å°ä½ç‰ˆ v2.5)
 * ä¿®æ­£é»ï¼š
 * 1. æ”¯æ´ info ç­‰ç´šï¼šé‡å°å°èˆªå»ºè­°ï¼ˆå¦‚æ”¹æ­ Sonicï¼‰ä½¿ç”¨è—è‰²èª¿ï¼Œæ¸›å°‘ç„¦æ…®æ„Ÿã€‚
 * 2. æ¨™é¡Œæ™ºæ…§åŒ–ï¼šè‡ªå‹•æ ¹æ“šç­‰ç´šåˆ‡æ›ã€Œæˆ°è¡“è­¦å‘Šã€ã€ã€Œç§»å‹•æé†’ã€èˆ‡ã€Œå°èˆªå»ºè­°ã€ã€‚
 * 3. è¦–è¦ºé‚Šç•Œé–å®šï¼šå„ªåŒ–é‚Šæ¡†ç²—ç´°èˆ‡å±¤ç´šæ„Ÿï¼Œç¢ºä¿åœ¨ç™½è‰²å¡ç‰‡ä¸­å…·å‚™æ·±åº¦ã€‚
 */
function renderDiagnosisUI(diagnosis) {
    if (!diagnosis || diagnosis.status === 'ok') return '';
    
    const status = diagnosis.status; // danger, warning, info
    
    // ğŸŒŸ ç‰©ç†å±¬æ€§å°ä½çŸ©é™£
    const config = {
        'danger': {
            icon: 'ğŸš¨',
            title: 'æˆ°è¡“è­¦å‘Š',
            wrapClass: 'bg-red-50 border-red-500',
            titleClass: 'text-red-600',
            msgClass: 'text-red-700'
        },
        'warning': {
            icon: 'âš ï¸',
            title: 'ç§»å‹•æé†’',
            wrapClass: 'bg-amber-50 border-amber-400',
            titleClass: 'text-amber-600',
            msgClass: 'text-amber-800'
        },
        'info': {
            icon: 'âœ¨',
            title: 'å°èˆªå»ºè­°',
            wrapClass: 'bg-blue-50 border-blue-400',
            titleClass: 'text-blue-600',
            msgClass: 'text-blue-700'
        }
    }[status] || { 
        icon: 'â„¹ï¸', title: 'ç³»çµ±è¨Šæ¯', wrapClass: 'bg-slate-50 border-slate-300', 
        titleClass: 'text-slate-600', msgClass: 'text-slate-700' 
    };

    return `
        <div class="diagnosis-alert mt-3 p-3 rounded-2xl border-2 animate-in slide-in-from-top-1 ${config.wrapClass}">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-sm">${config.icon}</span>
                <span class="text-[10px] font-black uppercase tracking-widest ${config.titleClass}">
                    ${config.title}
                </span>
            </div>
            <p class="text-[12px] font-black leading-tight ${config.msgClass}">
                ${diagnosis.msg}
            </p>
        </div>
    `;
}


/** 4. æ¸…ç©ºå…¨åŸŸè·¯ç¶² (ç·Šæ€¥æŒ‡ä»¤) */
async function clearTransportVault() {
    if (!confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰çš„äº¤é€šè·¯ç¶²æ•¸æ“šå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•æ’¤éŠ·ã€‚")) return;
    
    window.state.transportVault = [];
    
    if (window.dbManager && window.dbManager.db) {
        const tx = window.state.dbManager?.db?.transaction(['transport_store'], 'readwrite') || 
                   window.dbManager.db.transaction(['transport_store'], 'readwrite');
        tx.objectStore('transport_store').clear();
    }
    
    await saveData();
    renderTransportHub();
    console.log("ğŸ§¹ äº¤é€šè·¯ç¶²ä¸­å¿ƒå·²æ¸…ç©ºã€‚");
}


/** ğŸ”„ å…¨é‡æ ¡æº–æ™‚é–“è»¸èˆ‡è·¯ç¶²å°ä½ (v3.7 çµæ§‹å¼·åŒ–ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. [å®¹éŒ¯ä¿è­·]ï¼šå¢åŠ å° vaultMatch åŠå…¶å…§å±¤ route ç‰©ä»¶çš„å¯¦é«”æª¢æŸ¥ï¼Œé˜²æ­¢è®€å– undefined.operator_idã€‚
 * 2. [æ¨£å¼å›æº¯]ï¼šè‹¥å°ä½å¤±æ•—ï¼Œç¢ºä¿ä¿ç•™åŸå§‹ styleï¼Œä¸å†å¼·åˆ¶é™ç¶­ï¼Œä¿è­·éäº¤é€šé¡è³‡ç”¢ã€‚
 * 3. [é è¨­é…è‰²]ï¼šç•¶åŒ¹é…æˆåŠŸä½†ç¼ºä¹é¡è‰²å®šç¾©æ™‚ï¼Œè‡ªå‹•éè£œç³»çµ±é è¨­è—è‰² (#3b82f6)ã€‚
 */
function recalculateScheduleTimes(day) {
    // ğŸ›¡ï¸ å®‰å…¨æª¢æŸ¥ï¼šè‹¥å¤©æ•¸æˆ–è¡Œç¨‹ä¸å­˜åœ¨å‰‡é€€å‡º
    if (!day || !day.schedules || !Array.isArray(day.schedules)) return;

    day.schedules.forEach((schedule) => {
        // --- 1. åŸ·è¡ŒåŸºç¤æ™‚é–“è»¸è¨ˆç®— ---
        if (typeof calculateEndTime === 'function') {
            schedule.endTime = calculateEndTime(schedule.startTime, schedule.durationHours || 1);
        }

        // --- 2. ğŸŒŸ ç‰©ç†è·¯ç¶²ä¸­å¿ƒæŒ‡ç´‹å°ä½ ---
        // å‘¼å« v4.6 ç‰ˆæœ¬çš„é˜²å½ˆ matchVaultRoute
        const vaultMatch = typeof matchVaultRoute === 'function' 
            ? matchVaultRoute(schedule.name, schedule.notes || "") 
            : null;

        // ğŸ›¡ï¸ æ ¸å¿ƒå¼·åŒ–ï¼šç¢ºä¿ vaultMatch ä¸” vaultMatch.route åŒæ™‚å­˜åœ¨
        if (vaultMatch && vaultMatch.route) {
            // âœ… [å°ä½æˆåŠŸ] æ³¨å…¥ç‰©ç†æŒ‡ç´‹
            schedule.isVaultMatched = true;
            schedule.style = 'transport'; // å•Ÿå‹•äº¤é€šæ¥­è€…æ¸²æŸ“æ¨¡å¼
            
            // å®‰å…¨è®€å–æ¥­è€… ID
            schedule.matchedOperator = vaultMatch.route.operator_id || 'unknown';
            
            // å„ªå…ˆæ¬Šï¼šè·¯ç·šæŒ‡å®šè‰² > æ¥­è€…å…ƒæ•¸æ“šé¡è‰² > ç³»çµ±é è¨­è—è‰²
            schedule.matchedColor = vaultMatch.route.color || 
                                    vaultMatch.route.meta?.color || 
                                    '#3b82f6';
            
            // åŒæ­¥ç‰©ç†ç«™é»åºåˆ—
            schedule.displayStops = vaultMatch.displayStops || [];
            
            // åŒæ­¥å‹•æ…‹æˆ°è¡“è¨»è§£ (é¸å¡«)
            if (vaultMatch.activeNotes && vaultMatch.activeNotes.length > 0) {
                schedule.routeNotes = vaultMatch.activeNotes;
            }

            console.log(`ğŸ“¡ [ç‰©ç†å°ä½æˆåŠŸ] ${schedule.name} -> ${schedule.matchedOperator} (${schedule.matchedColor})`);
        } else {
            // âŒ [å°ä½å¤±æ•—] ä¿æŒè³‡ç”¢åŸå§‹ç‹€æ…‹
            schedule.isVaultMatched = false;
            // ç§»é™¤å¯èƒ½æ®˜ç•™çš„äº¤é€šå±¬æ€§ï¼Œé˜²æ­¢ UI èª¤åˆ¤
            delete schedule.matchedOperator;
            delete schedule.matchedColor;
            delete schedule.displayStops;
        }

        // --- 3. è¨ºæ–·å¤§è…¦é ç†± ---
        // æ­¤è™• schedule å·²å¸¶æœ‰ç©©å®šç‰©ç†æŒ‡ç´‹ï¼Œä¾›å¾ŒçºŒ renderScheduleCards ä½¿ç”¨
    });
}


/** ğŸš‰ å…¨èªæ„å°ä½èˆ‡æœå°‹ä¸­å¿ƒ (v4.6 çµ‚æ¥µé˜²å½ˆç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. [ç©ºå€¼é˜²è­·]ï¼šå…¨é¢ä½¿ç”¨ (item || "") éè£œèˆ‡ toString()ï¼Œå¾¹åº•æ¶ˆæ»… toUpperCase() å ±éŒ¯ã€‚
 * 2. [é‚è¼¯éš”é›¢]ï¼šåœ¨ Step 2 å¢åŠ å¯¦é«”å­˜åœ¨æ€§æª¢æŸ¥ï¼Œé˜²æ­¢æœªå®šç¾©ç‰©ä»¶é€²å…¥æ’åºæµã€‚
 * 3. [ç²¾æº–å°ä½]ï¼šä¿®æ­£ Step 3 çš„ç«™é»ç´¢å¼•å°‹æ‰¾é‚è¼¯ï¼Œå¢åŠ å®‰å…¨æ€§ã€‚
 */
function matchVaultRoute(scheduleName, notes = "") {
    // å„ªå…ˆå¾å…¨åŸŸè¨˜æ†¶é«”æˆ–ç‹€æ…‹ä¸­æå–è³‡æ–™
    const vault = window.VAULT_DATA || window.state?.transportVault || [];
    
    // ğŸ›¡ï¸ å®‰å…¨è­·æ¬„ 1: åŸºæœ¬è¼¸å…¥æª¢æ ¸
    if (!scheduleName || vault.length === 0) return null;
    
    // å¼·åˆ¶è½‰å­—ä¸²ä¸¦è½‰å¤§å¯«ï¼Œé˜²æ­¢ scheduleName å‚³å…¥éå­—ä¸²é¡å‹
    const query = scheduleName.toString().toUpperCase();
    const safeNotes = (notes || "").toString();

    // ğŸš€ Step 1. åŸ·è¡Œå…¨èªæ„é›·é”æƒæ
    const matches = vault.filter(item => {
        if (!item) return false;
        
        const name = (item.name || "").toString().toUpperCase();
        const cat = (item.category || "").toString().toUpperCase();
        const reg = (item.region || "").toString().toUpperCase();
        const spec = (item.meta?.specialty || "").toString().toUpperCase();
        const op = (item.operator_id || "").toString().toUpperCase();
        const line = (item.line_id || "").toString().toUpperCase();

        return name.includes(query) || 
               cat.includes(query) || 
               reg.includes(query) || 
               spec.includes(query) ||
               op.includes(query) ||
               line.includes(query);
    });

    if (matches.length === 0) return null;

    // ğŸŒŸ Step 2. æ™ºæ…§æ’åº (ğŸ›¡ï¸ ä¿®æ­£é‡é»ï¼šå¢åŠ ç©ºå€¼é˜²è­·é˜²æ­¢å´©æ½°)
    const sortedMatches = matches.sort((a, b) => {
        const aName = (a.name || "").toString().toUpperCase();
        const bName = (b.name || "").toString().toUpperCase();
        
        if (aName === query) return -1;
        if (bName === query) return 1;
        return aName.length - bName.length;
    });

    const route = sortedMatches[0];

    // ğŸš€ Step 3. ç«™é»ç‰‡æ®µæˆªå–
    let displayStops = [];
    let activeNotes = [];
    
    // åˆ†å‰²ç­†è¨˜ä¸­çš„ç«™é»æ¨™è¨˜
    const stationsInNotes = safeNotes.split(/[â†’>~â€”âˆ’-]/).map(s => s.trim()).filter(s => s);

    if (route && route.stations && Array.isArray(route.stations) && stationsInNotes.length >= 2) {
        const startRaw = stationsInNotes[0].toUpperCase();
        const endRaw = stationsInNotes[stationsInNotes.length - 1].toUpperCase();

        // ğŸ›¡ï¸ å®‰å…¨å°‹æ‰¾ç´¢å¼•
        const startIndex = route.stations.findIndex(s => {
            const sName = (s || "").toString().toUpperCase();
            return sName.includes(startRaw) || startRaw.includes(sName);
        });
        
        const endIndex = route.stations.findIndex(s => {
            const sName = (s || "").toString().toUpperCase();
            return sName.includes(endRaw) || endRaw.includes(sName);
        });

        if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
            displayStops = route.stations.slice(startIndex, endIndex + 1);
            
            // è™•ç†å‹•æ…‹æˆ°è¡“è¨»è§£
            if (route.dynamic_notes && Array.isArray(route.dynamic_notes)) {
                route.dynamic_notes.forEach(dn => {
                    const trigger = (dn.trigger_station || "").toString().toUpperCase();
                    if (trigger && (startRaw.includes(trigger) || endRaw.includes(trigger))) {
                        activeNotes.push(dn.note);
                    }
                });
            }
        }
    }

    // ğŸŒŸ æœ€çµ‚å›å‚³
    return {
        route,
        displayStops,
        activeNotes: [...new Set(activeNotes)],
        allMatches: sortedMatches
    };
}


        /** è¼”åŠ©å‡½æ•¸ï¼šå°‡ Hex é¡è‰²è½‰æ›ç‚º RGBA */
        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.slice(1, 3), 16);
                g = parseInt(hex.slice(3, 5), 16);
                b = parseInt(hex.slice(5, 7), 16);
            } else {
                return `rgba(0, 0, 0, ${alpha})`; // é»˜èªé»‘è‰²
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        /** æ‡‰ç”¨è¨­å®šä¸»é¡Œé¡è‰² */
        function applyTheme() {
            const primaryColor = state.theme.primary;
            // è¨­ç½®ä¸»è‰² CSS è®Šæ•¸
            document.documentElement.style.setProperty('--color-primary', primaryColor);

// âœ¨ [æ–°å¢é …ç›®] ç‚ºæ¨¡å¼åˆ‡æ›å™¨èˆ‡å¾ŒçºŒæ–°åŠŸèƒ½æä¾›ä¸»é¡Œè‰²è®Šæ•¸
    document.documentElement.style.setProperty('--theme-primary', primaryColor);
            
            // è¨­ç½®è¼”åŠ©è‰² CSS è®Šæ•¸ (ä½¿ç”¨ RGBA æ¨¡æ“¬ mix æ•ˆæœ, 10% ä¸»è‰² + 90% ç™½)
            const lightBg = hexToRgba(primaryColor, 0.1);
            const lightBorder = hexToRgba(primaryColor, 0.1); 
            document.documentElement.style.setProperty('--color-bg-light-mixed', lightBg);
            document.documentElement.style.setProperty('--color-border-light-mixed', lightBorder);
            
            // é‡æ–°è¨ˆç®—è©³ç´°å…§å®¹èƒŒæ™¯è‰² (5% ä¸»é¡Œè‰²)
            const noteBg = hexToRgba(primaryColor, 0.05);
            document.documentElement.style.setProperty('--color-note-bg', noteBg);
            document.documentElement.style.setProperty('--color-note-border', primaryColor); // å·¦é‚Šæ¡†ä½¿ç”¨ä¸»é¡Œè‰²

            // é‡æ–°è¨ˆç®—è²»ç”¨é¡åˆ¥èƒŒæ™¯è‰² (å¿…é ˆåœ¨ primary color è¨­ç½®ä¹‹å¾ŒåŸ·è¡Œï¼Œå› ç‚º Shopping ä¾è³´å®ƒ)
            const expenseShoppingBg = hexToRgba(primaryColor, 0.1);
            document.documentElement.style.setProperty('--color-bg-shopping', expenseShoppingBg);

            
            // æ‡‰ç”¨æ·ºè‰²/æ·±è‰²æ¨¡å¼
            const app = document.getElementById('app').parentNode; // ä½œç”¨æ–¼ <body>
            app.classList.remove('dark-mode'); // ç¢ºä¿ç§»é™¤æ‰€æœ‰æ·±è‰²æ¨¡å¼é¡åˆ¥
        }
        
/** è™•ç† Gemini Key è¼¸å…¥ï¼Œéš±è—é¡¯ç¤º (v7.8 ç‰©ç†é–å®šç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. ç•°æ­¥é˜²ç¦¦ï¼šå°‡å‡½æ•¸æ”¹ç‚º asyncï¼Œç¢ºä¿ç‰©ç†å¯«å…¥å®Œæˆå¾Œæ‰ç™¼é€é€šçŸ¥ã€‚
 * 2. å¾¹åº•æ¸…ç©ºï¼šè§£æ±ºæ¸…ç©ºå¾Œè¼¸å…¥æ¡†ä»é¡¯ç¤ºå¯†ç¢¼é¡å‹çš„å•é¡Œã€‚
 * 3. å¼·æ¬Šå¯«å…¥ï¼šå‘¼å« saveData(true) æ“Šç©¿åŸå­é–ã€‚
 */
async function handleKeyInput(inputEl) {
    const key = inputEl.value.trim();
    
    // ğŸ›¡ï¸ 1. é‚è¼¯éæ¿¾ï¼šè‹¥ç‚ºé®è”½ç¬¦è™Ÿå‰‡ä¸è™•ç†ï¼Œé˜²æ­¢èª¤è§¸ç™¼å­˜æª”
    if (key === '****************') {
        inputEl.type = 'password';
        return;
    }

    // ğŸŒŸ 2. æ•¸æ“šåˆ†æµè™•ç†
    if (key.length > 0) {
        state.theme.geminiKey = key;
        // åŸ·è¡Œå¼·æ¬Šå­˜æª” (Force Mode)
        await saveData(true);
        
        // äº¤äº’å›é¥‹ï¼šç«‹å³é®è”½
        inputEl.type = 'password';
        inputEl.value = '****************';
        showMessage('API Key å·²ç‰©ç†é–å®š', 'success');
    } else {
        // å¾¹åº•æ¸…é™¤é‚è¼¯
        state.theme.geminiKey = '';
        await saveData(true);
        
        inputEl.type = 'text';
        inputEl.value = '';
        showMessage('API Key å·²å¾ç£å€æ¸…é™¤', 'info');
    }

    // ğŸ“Ÿ è¨˜éŒ„è‡³çµ‚ç«¯æ©Ÿ
    console.log(`[${new Date().toLocaleTimeString()}] ğŸ”‘ Security Gate: Key status updated.`);
}

/** æ‡‰ç”¨ AI ç­†æ¨£å¼ï¼šå…¨åŸŸé€£å‹•ç‰ˆ (v7.8) */
function applyAIPenStyle() {
    // ğŸŒŸ æ“´å¤§æƒæç¯„åœï¼šåŒ…å«å¡ç‰‡å…§çš„ AI åœ–ç¤ºã€Q&A ç‡ˆæ³¡ä»¥åŠç·¨è¼¯åœ–ç¤º
    const aiIcons = document.querySelectorAll('.ai-edit-icon, .ai-plus-tag-shiny, .theme-text-pink');
    
    aiIcons.forEach(icon => {
        // ç¢ºä¿å¼·åˆ¶æ³¨å…¥ç•¶å‰ state ä¸­çš„ä¸»é¡Œè‰² CSS è®Šæ•¸
        if (state.theme && state.theme.primary) {
            icon.style.color = state.theme.primary;
        }
        // ä¿æŒæ¨£å¼å¤§ä¸€çµ±
        icon.classList.add('transition-all', 'duration-300');
    });
}

function showMessage(message, type = 'success') {
    const el = document.getElementById('app-message');
    if (!el) return;

    el.textContent = message;
    
    // åŸºç¤çµæ§‹èˆ‡å‹•ç•«é¡åˆ¥ (Tailwind)
    el.className = 'fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 text-white rounded-xl shadow-2xl z-[10000] transition duration-300 transform scale-100';
    
    // æ ¹æ“šé¡å‹è®Šæ›´èƒŒæ™¯é¡è‰²
    if (type === 'success' || type === 'info') {
        el.style.backgroundColor = state.theme.primary; // ä½¿ç”¨æ‚¨çš„ç«ç‘°ç²‰ä¸»é¡Œè‰²
    } else if (type === 'error') {
        el.style.backgroundColor = '#ef4444'; // ç´…è‰²
    }

    el.classList.remove('hidden');
    el.classList.add('flex'); // ç¢ºä¿å…§éƒ¨æ–‡å­—ç½®ä¸­é¡¯ç¤º

    // 3ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => {
        el.classList.add('hidden');
        el.classList.remove('flex');
    }, 3000);
}


        /** è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–å°æ™‚æ•¸ */
        function formatDuration(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            if (h > 0 && m > 0) return `${h} å°æ™‚ ${m} åˆ†`;
            if (h > 0) return `${h} å°æ™‚`;
            if (m > 0) return `${m} åˆ†`;
            return '0 åˆ†';
        }

/** ğŸ›¡ï¸ è·äººè‡ªç™’ç‰ˆï¼šå…¨æ¨¡çµ„æ•¸æ“šå°è£èˆ‡æŒä¹…åŒ–ä¸­å¿ƒ (v4.7)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [ç‰©ç†æ¥å£è¯å‹•] ç¢ºä¿é€é injectGoldFuel æ³¨å…¥çš„é›™æ£²è³‡ç”¢èƒ½ 100% é€šéåŸå­é–é©—è­‰ã€‚
 * 2. [å¯†é‘°æ°¸æ†åŒ–] å¼·åŒ– geminiKey çš„ä»²è£é‚è¼¯ï¼Œé˜²æ­¢åœ¨ state æš«æ™‚ç‚ºç©ºæ™‚éºå¤± Keyã€‚
 * 3. [ID ç©©å®šå™¨] ä¿®æ­£ transport_store çš„ ID ç”¢ç”Ÿæ©Ÿåˆ¶ï¼Œå„ªå…ˆæ¡ç”¨ line_id ä½œç‚ºç´¢å¼•ã€‚
 * 4. [SSOT å¼·åŒ–] å»ºç«‹æ•¸æ“šè£œå„Ÿæ©Ÿåˆ¶ï¼Œç•¶è¨˜æ†¶é«” bucketList æå£æ™‚ï¼Œè‡ªå‹•å¾ç‰©ç†å¿«ç…§æ‰“æ’ˆä¿®å¾©ã€‚
 */
async function saveData(force = false) {
    // ğŸš€ åŸå­æ›´æ–°é–ï¼šé˜²æ­¢äº¤é€šè·¯ç¶²åŒæ­¥æˆ–åŸ·è¡Œ injectGoldFuel æ™‚ç”¢ç”Ÿè¡çª
    // åªæœ‰åœ¨æ‰‹å‹•å¼·åˆ¶åŸ·è¡Œ (force=true) æ™‚æ‰å…è¨±ç©¿é€æ›´æ–°é–
    if (window.isTransportUpdating && !force) {
        console.warn("ğŸ›¡ï¸ [saveData] åŸå­æ›´æ–°é–å®šä¸­ï¼Œè·³éå­˜æª”ã€‚");
        return;
    }

    try {
        const timestamp = new Date().toISOString();
        // å–å¾—èˆŠæœ‰ç‰©ç†å¿«ç…§ä½œç‚ºã€Œå‚™æ´çœŸç†ã€ï¼Œé˜²æ­¢æ„å¤–æ¸…ç©ºè³‡æ–™
        const dbExisting = await dbManager.get('private_store', 'main_state');

        // --- ğŸŒŸ 1. ğŸš‰ äº¤é€šç£å€å¼·åŒæ­¥ (transport_store) ---
        // é€™æ˜¯ç¢ºä¿ã€Œé«˜ç´šæ‘ºç–Šæ„Ÿã€çš„ç‰©ç†åŸºåº§
        const memoryVault = window.state.transportVault || [];
        if (memoryVault.length > 0 || force) {
            const txV = dbManager.db.transaction(['transport_store'], 'readwrite');
            const storeV = txV.objectStore('transport_store');
            
            // å°‡è¨˜æ†¶é«”ä¸­çš„è·äººè³‡ç”¢é€ä¸€ç„Šå…¥ç£å€
            memoryVault.forEach(route => {
                storeV.put({ 
                    ...route, 
                    // å„ªå…ˆä½¿ç”¨ line_idï¼Œå…¶æ¬¡ä½¿ç”¨ idï¼Œç¢ºä¿ç‰©ç†å°ä½ä¸é‡ç–Š
                    id: route.id || route.line_id || `${route.operator_id}_${Date.now()}` 
                });
            });
            await new Promise((res) => { txV.oncomplete = res; });
        }

        // --- ğŸŒŸ 2. ğŸŒ åœ°ç†æŒ‡ç´‹ç‰©ç†åŒ– ---
        let validatedGeoItems = [];
        if (window.GEO_REGIONS && Object.keys(window.GEO_REGIONS).length > 0) {
            const txG = dbManager.db.transaction(['geo_regions_store'], 'readwrite');
            const storeG = txG.objectStore('geo_regions_store');
            
            Object.entries(window.GEO_REGIONS).forEach(([name, data]) => {
                if (!name.endsWith('_coords')) {
                    const coords = window.GEO_REGIONS[name + "_coords"] || {};
                    const lng = parseFloat(coords.lng) || (typeof data === 'object' ? parseFloat(data.lng) : 0);
                    const lat = parseFloat(coords.lat) || (typeof data === 'object' ? parseFloat(data.lat) : 0);
                    
                    if (lng !== 0 || lat !== 0) {
                        const geoEntry = {
                            regionName: name,
                            aliases: Array.isArray(data) ? data : (data.aliases || []),
                            lng: lng, lat: lat,
                            zoom: coords.zoom || (typeof data === 'object' ? data.zoom : 11)
                        };
                        storeG.put(geoEntry);
                        validatedGeoItems.push(geoEntry);
                    }
                }
            });
            await new Promise((res) => { txG.oncomplete = res; });
        }

        // --- ğŸŒŸ 3. ğŸ“‹ Checklist åˆ†å€å­˜æª” ---
        if (state.checklist?.length > 0) {
            await dbManager.save('config_store', { 
                id: 'checklist_data', 
                content: state.checklist 
            });
        }

        // --- ğŸš€ æ•¸æ“šæ‰“æ’ˆèˆ‡ç‰©ç†ä»²è£ (å¾å„Storeå›æ”¶æœ€æ–°çœŸç†) ---
        const physGeoRegions = validatedGeoItems.length > 0 ? validatedGeoItems : (await dbManager.getAll('geo_regions_store'));
        const physDict = await dbManager.getAll('dictionary_store');

        // --- ğŸŒŸ 4. å°è£ã€Œå¤§ä¸€çµ±æ•¸æ“šå¿«ç…§ã€ (SSOT) ---
        const dataSnapshot = {
            id: 'main_state',
            // è¡Œç¨‹è³‡ç”¢ä»²è£ï¼šè¨˜æ†¶é«” > ç‰©ç†å¿«ç…§ > ç©ºé™£åˆ—
            trips: (state.trips?.length > 0) ? state.trips : (dbExisting?.trips || []),
            bucketList: (state.bucketList?.length > 0) ? state.bucketList : (dbExisting?.bucketList || []),
            workshops: (state.workshops?.length > 0) ? state.workshops : (dbExisting?.workshops || []),
            shadowItineraries: state.shadowItineraries || dbExisting?.shadowItineraries || {},
            
            // å¾Œå‹¤æ¨¡çµ„åŒæ­¥
            shoppingList: state.shoppingList || dbExisting?.shoppingList || [],
            translationVault: state.translationVault || dbExisting?.translationVault || [],
            emergencyContacts: state.emergencyContacts || dbExisting?.emergencyContacts || { embassies: [], medical: [] },
            checklist: (state.checklist?.length > 0) ? state.checklist : (dbExisting?.checklist || []),
            
            // ç‰©ç†åŸºåº§ (æ±ºå®šç³»çµ±å‚™ä»½é«”é‡çš„æ ¸å¿ƒ)
            dictionary: physDict.length > 0 ? physDict : (dbExisting?.dictionary || []),
            transportVault: memoryVault.length > 0 ? memoryVault : (dbExisting?.transportVault || []),
            geoRegions: physGeoRegions.length > 0 ? physGeoRegions : (dbExisting?.geoRegions || []),
            
            // ç³»çµ±ç’°å¢ƒåƒæ•¸èˆ‡ ğŸ”‘ API KEY å¼·åˆ¶é–å®š
            currentTripId: state.currentTripId || dbExisting?.currentTripId,
            currentDayIndex: state.currentDayIndex ?? 0,
            currentSubView: state.currentSubView || 'itinerary',
            theme: {
                ...state.theme,
                // ğŸ”’ çœŸç†é–å®šï¼šè‹¥ state éºå¤± Keyï¼Œå‰‡ç”±ç‰©ç†å¿«ç…§è£œå„Ÿï¼Œç¢ºä¿ä¸æœƒè®Šæˆç©ºå€¼
                geminiKey: state.theme?.geminiKey || dbExisting?.theme?.geminiKey || "" 
            },
            totalBudget: state.totalBudget,
            currency: state.currency,
            lastUpdated: timestamp
        };

        // --- ğŸŒŸ 5. åŸ·è¡Œç‰©ç†å›ºåŒ– (Private Store) ---
        await dbManager.save('private_store', dataSnapshot);

        // --- ğŸŒŸ 6. å‚™ä»½æ™‚å…‰æ©Ÿ (ä¿ç•™ 10 ç­†æ­·å²é‚„åŸé») ---
        const backupId = `backup_${Date.now()}`;
        await dbManager.save('staging_store', { ...dataSnapshot, id: backupId, backupTime: timestamp });
        
        const allStaging = await dbManager.getAll('staging_store');
        const backupList = allStaging.filter(b => b.id?.startsWith('backup_'))
                                    .sort((a, b) => new Date(a.backupTime) - new Date(b.backupTime));
        
        if (backupList.length > 10) {
            const cleanTx = dbManager.db.transaction(['staging_store'], 'readwrite');
            const cleanStore = cleanTx.objectStore('staging_store');
            backupList.slice(0, backupList.length - 10).forEach(old => {
                cleanStore.delete(old.id);
            });
        }

        console.log(`%cğŸ›¡ï¸ [Physical-Solidify] ç‰©ç†é–å®šæˆåŠŸ | é«”é‡: ${(JSON.stringify(dataSnapshot).length / 1024).toFixed(1)} KB`, "color: #10b981; font-weight: bold;");
        
    } catch (e) {
        console.error('âŒ ç‰©ç†å­˜æª”åŸ·è¡Œä¸­æ–·:', e);
    }
}

/** ğŸ›¡ï¸ æ——è‰¦è‡ªç™’ç‰ˆï¼šå¾ IndexedDB è¼‰å…¥è³‡æ–™ (v4.9 é›™æ£²å°ä½è§£å°ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [é›™æ£²è§£å°] é–‹æ©Ÿè‡ªå‹•å°‡ transport_store çš„é«˜ç´šäº¤é€šå¡æ³¨å…¥ bucketListï¼Œè§£æ±ºæœå°‹ä¸åˆ°çš„å•é¡Œã€‚
 * 2. [å¯†é‘°å¼·æ¢å¾©] ä¿®æ­£ theme æå–é‚è¼¯ï¼Œç¢ºä¿ç‰©ç†ç£å€å…§çš„ geminiKey å…·å‚™æœ€é«˜è¦†è“‹æ¬Šé™ã€‚
 * 3. [æ•¸æ“šä»²è£] å„ªå…ˆå¾å€‹åˆ¥ç£å€ (Store) æå–æœ€æ–°å¯¦é«”ï¼Œå†èˆ‡ main_state å¿«ç…§åŸ·è¡Œè£œå„Ÿåˆä½µã€‚
 * 4. [ç•°æ­¥æ¸²æŸ“å®ˆè¡›] ç¢ºä¿åœ¨ DOM å®Œå…¨ç©©å®šå¾Œï¼Œç²¾æº–æ¢å¾©ä½¿ç”¨è€…çš„ currentSubView è¦–åœ–ã€‚
 */
async function loadData() {
    try {
        console.log("%cğŸ“¡ [å•Ÿå‹•å·¡æª¢] æ­£åœ¨ç©¿é€ç‰©ç†åˆ†å±¤æå–çœŸç†...", "color: #3b82f6; font-weight: bold;");
        if (!dbManager.db) await dbManager.init();

        // ğŸŒŸ 1. åŒæ­¥åŸ·è¡Œã€Œå…¨æˆ¿é–“ç‰©ç†æ¢é‡ã€ (ç©¿é€ 7 å¤§æ ¸å¿ƒç£å€)
        const [physDict, physTrans, physTransport, physGeo, physMatrix, physIcons, physConfig] = await Promise.all([
            dbManager.getAll('dictionary_store'),
            dbManager.getAll('translations_store'),
            dbManager.getAll('transport_store'),
            dbManager.getAll('geo_regions_store'),
            dbManager.getAll('matrix_store'),
            dbManager.getAll('icon_store'),
            dbManager.getAll('config_store') 
        ]);

        // ğŸŒŸ 2. å–å¾—ä¸»ç‹€æ…‹ç‰©ç†å¿«ç…§ (Snapshot)
        const loadedState = await dbManager.get('private_store', 'main_state');
        
        if (loadedState) {
            // --- A. åŸºç¤è¡Œç¨‹æ¶æ§‹æ¢å¾© ---
            state.trips = loadedState.trips || [];
            state.workshops = loadedState.workshops || [];
            state.shadowItineraries = loadedState.shadowItineraries || {};
            
            // --- B. ğŸ”‘ å¯†é‘°èˆ‡ç¾å­¸ç‰©ç†é–å®šæ¢å¾© ---
            if (loadedState.theme) {
                state.theme = {
                    ...state.theme,      // ä¿ç•™ç•¶å‰é è¨­çµæ§‹
                    ...loadedState.theme // å¼·åˆ¶æ³¨å…¥ç£å€å…§çš„ Key èˆ‡é…è‰²
                };
                // ç¢ºä¿å¯†é‘°ä¸æœƒå› ç‚º Object Spread éºå¤±
                if (loadedState.theme.geminiKey) state.theme.geminiKey = loadedState.theme.geminiKey;
                console.log(`ğŸ”‘ [Security] API Key æ¢å¾©ç‹€æ…‹: ${state.theme.geminiKey ? 'Verified' : 'Empty'}`);
            }

            // --- C. è¦–åœ–ç’°å¢ƒç‹€æ…‹æ¢å¾© ---
            state.currentTripId = loadedState.currentTripId || (state.trips[0]?.id || null);
            state.currentDayIndex = (loadedState.currentDayIndex !== undefined) ? loadedState.currentDayIndex : 0;
            state.currentSubView = loadedState.currentSubView || 'itinerary';
            
            // --- D. å¾Œå‹¤èˆ‡æ ¸å°æ¸…å–®æ¢å¾© ---
            state.shoppingList = loadedState.shoppingList || [];
            state.emergencyContacts = loadedState.emergencyContacts || { embassies: [], medical: [] };
            
            // âœ¨ [Checklist ç‰©ç†å°ä½] å„ªå…ˆå¾å°ˆå±¬ config_store æå–
            const checklistConfig = (physConfig || []).find(c => c.id === 'checklist_data');
            state.checklist = (checklistConfig && checklistConfig.content) ? checklistConfig.content : (loadedState.checklist || []);

            // --- E. ğŸŒŸ ç‰©ç†æ¬Šå¨ä»²è£ä¸­å¿ƒ (ç‰©ç†æˆ¿é–“è³‡ç”¢å„ªå…ˆæ–¼å¿«ç…§) ---

            // 1. ğŸš‰ äº¤é€šè·¯ç¶²ä¸­å¿ƒ (SSOT å”¯ä¸€çœŸç†ä¾†æº)
            // å„ªå…ˆè®€å–ç‰©ç†åˆ†é ä¸­çš„ transport_store
            state.transportVault = (physTransport && physTransport.length > 0) ? physTransport : (loadedState.transportVault || []);
            window.state.transportVault = state.transportVault;

            // 2. ğŸ’ å£è¢‹åå–® [é›™æ£²å°ä½æ ¸å¿ƒä¿®æ­£]
            // æˆ°è¡“ï¼šåˆä½µã€Œå¿«ç…§æ¸…å–®ã€èˆ‡ã€Œè·¯ç¶²ç£å€ã€ï¼Œç¢ºä¿é«˜ç´šäº¤é€šå·¥å…·å‡ºç¾åœ¨æœå°‹çµæœ
            const baseBucket = loadedState.bucketList || [];
            const transportAsBucket = state.transportVault.map(t => ({ 
                ...t, 
                customStyle: 'äº¤é€š', 
                category: 'è¡Œ' 
            }));
            
            // ä½¿ç”¨ Map é€²è¡Œå»é‡åˆä½µ (ä»¥åç¨±ç‚ºæº–ï¼Œç‰©ç†ç£å€è³‡æ–™å…·å‚™å„ªå…ˆæ¬Š)
            const combinedMap = new Map();
            baseBucket.forEach(item => { if(item && item.name) combinedMap.set(item.name, item); });
            transportAsBucket.forEach(item => { if(item && item.name) combinedMap.set(item.name, item); });
            state.bucketList = Array.from(combinedMap.values());

            // 3. ğŸŒ åœ°ç†æŒ‡ç´‹ç‰©ç†åŒ–æ¢å¾©
            if (physGeo && physGeo.length > 0) {
                window.GEO_REGIONS = {}; 
                physGeo.forEach(curr => {
                    if (curr.regionName) {
                        window.GEO_REGIONS[curr.regionName] = curr.aliases || [];
                        window.GEO_REGIONS[curr.regionName + "_coords"] = { 
                            lng: curr.lng || 0, lat: curr.lat || 0, zoom: curr.zoom || 11 
                        };
                    }
                });
            }

            // 4. â³ çŸ©é™£èˆ‡å…¨å±€å­—å…¸åŒæ­¥
            window.GLOBAL_DICT = (physDict && physDict.length > 0) ? physDict : (loadedState.dictionary || []);
            state.translationVault = (physTrans && physTrans.length > 0) ? physTrans : (loadedState.translationVault || []);

            console.log(`%câœ… ç‰©ç†å°ä½å®Œæˆ | å¯†é‘°: ${state.theme.geminiKey ? 'ON' : 'OFF'} | ç¸½è³‡ç”¢: ${state.bucketList.length} | å€åŸŸ: ${physGeo.length}`, "color: #10b981; font-weight: bold;");
            
            // ğŸš€ è¦–åœ–ç‰©ç†æ¿€æ´» (ç¢ºä¿ DOM æº–å‚™å°±ç·’å¾ŒåŸ·è¡Œé‡ç¹ª)
            requestAnimationFrame(() => {
                if (typeof switchSubView === 'function') {
                    switchSubView(state.currentSubView);
                }
                // åŸ·è¡Œå„åˆ†é å°ˆå±¬æ¸²æŸ“
                if (state.currentSubView === 'settings' && typeof renderSettingsView === 'function') {
                    renderSettingsView();
                }
                if (state.currentSubView === 'bucket' && typeof renderBucketList === 'function') {
                    renderBucketList();
                }
            });
        }
    } catch (e) {
        console.error('âŒ æ•¸æ“šåŠ è¼‰å¼•æ“ç½é›£æ€§å¤±æ•—:', e);
    }

    // ğŸŒŸ æœ€çµ‚ç³»çµ±é…ç½®å……èƒ½ (å¥—ç”¨ä½ˆæ™¯ä¸»é¡Œèˆ‡å¤–éƒ¨å®šç¾©)
    if (typeof loadDefinitions === 'function') await loadDefinitions();
    if (typeof applyTheme === 'function') applyTheme(); 
}

/** * è¼”åŠ©å‡½æ•¸ï¼šåˆå§‹åŒ–ç¯„ä¾‹è¡Œç¨‹ (å°‡åŸæœ¬é•·ä»£ç¢¼ç§»è‡³æ­¤è™•)
 */
function initExampleTrip() {
    state.trips = [{
        id: generateUUID(),
        name: 'ç¯„ä¾‹è¡Œç¨‹ï¼šå®œè˜­å…©æ—¥éŠ',
        days: [
            {
                dayNum: 1,
                date: '2025-01-29', 
                startTime: '08:00',
                endTime: '22:00',
                city: ['å®œè˜­ç¸£'],
                arrivalInfo: {},
                lodging: {},
                departureInfo: {},
                schedules: [
                    { id: generateUUID(), startTime: '09:00', durationHours: 3, name: 'è Ÿè—è Ÿç­†åŸå ¡', address: '270 å®œè˜­ç¸£è˜‡æ¾³é®æµ·å±±è¥¿è·¯500è™Ÿ', notes: 'è³¼è²·è Ÿç­†ç´€å¿µå“', style: 'cultural' },
                    { id: generateUUID(), startTime: '12:00', durationHours: 1.5, name: 'ç•ªå‰²ç”°ç”•ç¼¸é›', address: '268 å®œè˜­ç¸£è˜‡æ¾³é®æµ·å±±è¥¿è·¯309è™Ÿ', notes: 'é è¨‚åˆé¤', style: 'food' }
                ]
            },
            {
                dayNum: 2,
                date: '2025-01-30', 
                startTime: '08:00',
                endTime: '22:00',
                city: ['å®œè˜­ç¸£'],
                arrivalInfo: {},
                lodging: { name: 'ç…™æ³¢å¤§é£¯åº—è˜‡æ¾³å››å­£é›™æ³‰é¤¨', address: '270 å®œè˜­ç¸£è˜‡æ¾³é®ä¸­æ­£è·¯38è™Ÿ' },
                departureInfo: {},
                schedules: []
            }
        ]
    }];
    
    state.shoppingList = [
        { id: generateUUID(), name: 'ç•¶åœ°ç‰¹è‰²é¤…ä¹¾', quantity: 5, price: 120, store: 'è€è¡—ç‰¹ç”¢åº—', checked: false, isAI: false },
        { id: generateUUID(), name: 'æ–°æ‰‹æ©Ÿå……é›»ç·š', quantity: 1, price: 350, store: 'é›»å­è³£å ´', checked: true, isAI: false }
    ];

    state.emergencyContacts = {
        embassies: [
            { id: generateUUID(), name: 'é§æ—¥æœ¬è‡ºåŒ—ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•', address: 'æ±äº¬éƒ½æ¸¯å€ç™½é‡‘å°5ä¸ç›®20-2', phone: '+81-3-3280-7800', rescuePhone: '+81-80-6065-2747', isAI: false }
        ],
        medical: [
            { id: generateUUID(), name: 'æ±äº¬æ…ˆæƒ æœƒé†«ç§‘å¤§å­¸é™„å±¬é†«é™¢', info: 'æä¾›ä¸­æ–‡å£è­¯', address: 'æ±äº¬éƒ½æ¸¯å€è¥¿æ–°æ©‹', phone: '+81-3-3433-1111', isAI: false }
        ]
    };

    saveData();
}

        /** å–å¾—ç•¶å‰è¡Œç¨‹ç‰©ä»¶ */
        function getCurrentTrip() { return state.trips.find(t => t.id === state.currentTripId); }

        /** å–å¾—ç•¶å‰æ’ç¨‹å¤©æ•¸ç‰©ä»¶ */
        function getCurrentDay() {
            const trip = getCurrentTrip();
            return trip ? trip.days[state.currentDayIndex] : null;
        }

        // è¼”åŠ©å‡½å¼ï¼šå–å¾—é¢¨æ ¼åç¨±
        function getStyleName(styleKey, customName) {
            const styles = {
                cultural: 'æ–‡åŒ–æ­·å²å°å‘', food: 'ç¾é£Ÿæ¢éšª', nature: 'è‡ªç„¶æˆ¶å¤–æ´»å‹•', 
                shopping: 'è³¼ç‰©ä¼‘é–’', anime: 'äºŒæ¬¡å…ƒæ–‡åŒ–', nightlife: 'å¤œé–“æ´»å‹•å°å‘', other: 'è‡ªè¨‚é¢¨æ ¼', transport: 'äº¤é€šç§»å‹•'
            };
            return styleKey === 'other' ? (customName || 'è‡ªè¨‚é¢¨æ ¼') : (styles[styleKey] || 'å…¶ä»–');
        };

/** æ¸²æŸ“ä¸»é é¢ (è¡Œç¨‹æ¸…å–®) */
function renderTripList() {
    const container = document.getElementById('content-container');
    if (!container) return; // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿å…§å®¹å®¹å™¨å­˜åœ¨

    // 1. æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨ HTML
    container.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">æ‰€æœ‰è¡Œç¨‹</h2>
            <button onclick="toggleModal('add-trip-modal')" 
                    class="w-8 h-8 theme-pink text-white rounded-full text-xl flex items-center justify-center shadow-md hover:bg-pink-600 transition">
                +
            </button>
        </div>
        
        <div id="trip-list" class="space-y-4">
            ${state.trips.map(trip => `
                <div class="bg-white p-5 border-l-4 theme-border-pink rounded-xl shadow-md hover:shadow-lg transition flex justify-between items-center">
                    <div onclick="openTripDetail('${trip.id}')" class="flex-1 cursor-pointer">
                        <h3 class="text-lg font-semibold text-gray-800">${trip.name}</h3>
                        <p class="text-sm text-gray-500">
                            ${trip.days.length} å¤©è¡Œç¨‹ (${trip.days[0].date} ~ ${trip.days.at(-1).date})
                        </p>
                    </div>
                    <button onclick="openTripEditModal('${trip.id}', '${trip.name}')" 
                            class="text-gray-400 hover:text-gray-600 ml-4 p-2 rounded-full hover:bg-gray-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>
                </div>
            `).join('')}
        </div>
        ${state.trips.length === 0 ? '<p class="text-center text-gray-500 mt-8">å°šæœªæœ‰ä»»ä½•è¡Œç¨‹ï¼Œé»æ“Šä¸Šæ–¹ "+" æ–°å¢ã€‚</p>' : ''}
    `;

    // 2. æ›´æ–° Header èˆ‡ UI ç‹€æ…‹ (åŠ å…¥å®‰å…¨æª¢æŸ¥é˜²æ­¢ classList null éŒ¯èª¤)
    const updateUI = (id, action, className) => {
        const el = document.getElementById(id);
        if (el) el.classList[action](className);
    };

    const titleEl = document.getElementById('header-title');
    if (titleEl) titleEl.textContent = 'æˆ‘çš„è¡Œç¨‹';

    updateUI('back-btn', 'add', 'hidden');
    updateUI('edit-trip-btn', 'add', 'hidden'); // é€™è£¡å¸¸æ˜¯å ±éŒ¯ä¾†æº
    
    // ç¢ºä¿å®¹å™¨é–“è·æ­£ç¢º
    container.classList.remove('p-0');
    container.classList.add('p-4');
}

        // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—äº¤é€šæ–¹å¼åç¨±
        function getTransportName(modeKey) {
            const modes = {
                train: 'é«˜éµ / æ–°å¹¹ç·š',
                bus: 'å·´å£« / å…¬è»Š',
                taxi: 'è¨ˆç¨‹è»Š',
                subway: 'åœ°éµ',
                drive: 'è‡ªé§•',
                other: 'å…¶å®ƒ'
            };
            return modes[modeKey] || 'å…¶å®ƒ';
        };


/** ğŸ¬ æ——è‰¦è‡ªç™’ç‰ˆï¼šå…¨è‡ªå‹•ç³»çµ±å•Ÿå‹•ç¨‹åº (v9.5 æ¡†æ¶é‡é‘„ç‰ˆ)
 * æˆ°ç•¥ç›®çš„ï¼šé–‹æ©Ÿå³åŸ·è¡Œã€Œç‰©ç†æƒæ -> åº§æ¨™é‡é‘„ -> è¨˜æ†¶é«”å›å¡« -> è¦–åœ–é–å®šã€
 * ä¿®æ­£ï¼šç¢ºä¿å•Ÿå‹•æ™‚é€é switchSubView å®Œæ•´æ¸²æŸ“ Day Page æ¡†æ¶
 */
async function autoStartSystem() {
    try {
        console.log("%cğŸ¬ æ——è‰¦ç‰ˆè‡ªç™’å•Ÿå‹•ç³»çµ±é»ç«...", "color: #3b82f6; font-weight: bold;");

        // 1. ç‰©ç†åŸºåº§å»ºç«‹
        await dbManager.init();

        // 2. å•Ÿå‹•ã€æ——è‰¦ç§»æ°‘å®˜ã€‘ (v1.2.1)
        await migrateDefinitionsToDB();

        // 3. åŸ·è¡Œã€æ•¸æ“šæ·±åº¦åŠ è¼‰ã€‘ (v4.7)
        await loadData();

        // 4. å•Ÿå‹•ã€åœ°ç†æŒ‡ç´‹å›å¡«èˆ‡è‡ªç™’ã€‘ (v4.8)
        await syncGeoRegionsToMemory();

        // ğŸŒŸ 5. åº§æ¨™è‡ªå‹•è£œå¼·ï¼šè‹¥åµæ¸¬åˆ°åº§æ¨™ undefinedï¼Œè‡ªå‹•åŸ·è¡Œå¼·åˆ¶çŒéŒ„
        const geoAudit = await dbManager.getAll('geo_regions_store');
        const hasBadGeo = geoAudit.some(g => !g.lng || !g.lat);
        
        if (geoAudit.length < 11 || hasBadGeo) {
            console.warn("âš ï¸ åµæ¸¬åˆ°ç‰©ç†åº§æ¨™ç¼ºå£ï¼Œå•Ÿå‹•èƒŒæ™¯è‡ªå‹•é‡é‘„...");
            if (typeof rebuildGeoStructure === 'function') {
                await rebuildGeoStructure(); 
            }
        }

        // 6. é‡‹æ”¾æ›´æ–°é–ä¸¦åŸ·è¡Œé¦–é æ¸²æŸ“
        window.isTransportUpdating = false;
        
        // æ ¹æ“šç›®å‰ state å®šä½è¦–åœ–
        if (state.currentTripId) {
            // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå»ºç«‹åŸºç¤ä½ˆå±€å¾Œï¼Œå¿…é ˆèª¿ç”¨ switchSubView
            // é€™æœƒç¢ºä¿ renderDayTabs(trip) è¢«åŸ·è¡Œï¼Œç•«å‡º Day 1 - Day N æ¨™ç±¤åˆ—
            if (typeof setupTripLayout === 'function') setupTripLayout();
            
            if (typeof switchSubView === 'function') {
                const startMode = state.currentSubView || 'itinerary';
                switchSubView(startMode);
            } else {
                // ä¿åº•æ¸²æŸ“
                if (typeof renderTripDetail === 'function') renderTripDetail();
                if (typeof renderDayContent === 'function') renderDayContent(); 
            }
        } else {
            if (typeof renderTripList === 'function') renderTripList();
        }

        console.log("%câœ… å…¨ç³»çµ±è‡ªç™’å®Œæˆï¼šç‰©ç†å¤§ä¸€çµ±å¼•æ“å·²é€²å…¥ç©©å®šé‹è¡Œæ…‹ã€‚", "color: #10b981; font-weight: bold;");

    } catch (err) {
        window.isTransportUpdating = false;
        console.error("âŒ å•Ÿå‹•éˆæ¢æ–·è£‚:", err);
    }
}


// ğŸš€ ç¶²é è¼‰å…¥å®Œæˆå¾Œç«‹å³é»ç«
window.addEventListener('DOMContentLoaded', autoStartSystem);

/** ğŸ’¡ Q&A æˆ°è¡“å…¥å£æ¸²æŸ“å™¨ (v6.3)
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†æ„Ÿæ‡‰ï¼šè‹¥ dayData.faqs æœ‰è³‡æ–™ï¼Œç‡ˆæ³¡æŒ‰éˆ•è‡ªå‹•æ¿€æ´»ç¥ç€å…‰æšˆã€‚
 * 2. äº¤äº’ä¸€è‡´ï¼šçµ±ä¸€è§¸æ§ä½ç§»å›é¥‹ï¼Œç¢ºä¿ window å…¨åŸŸå‡½æ•¸éˆæ¥ã€‚
 * 3. è¦–è¦ºå°ç„¦ï¼šå¾®èª¿é‚Šæ¡†é€æ˜åº¦ï¼Œå¼·åŒ–åœ¨ä¸åŒèƒŒæ™¯ä¸‹çš„æµ®å‹•æ„Ÿã€‚
 */
function renderTacticalQA(dayData) {
    // ğŸŒŸ åµæ¸¬æœ‰ç„¡ Q&A ç‡ƒæ–™ï¼Œæ±ºå®šç‡ˆæ³¡æ˜¯å¦ã€Œäº®èµ·ã€
    const hasData = dayData.faqs && dayData.faqs.length > 0;
    
    return `
        <div class="flex items-center justify-between px-5 py-3 mb-6 bg-white/70 backdrop-blur-md rounded-[2.2rem] border border-white/40 shadow-sm animate-in fade-in duration-500">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-amber-50 flex items-center justify-center text-base shadow-inner border border-amber-100/50">ğŸ’¡</div>
                <div>
                    <h4 class="text-[13px] font-black text-slate-800 leading-none">Q&A</h4>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Tactical Guide</p>
                </div>
            </div>

            <div class="flex items-center gap-1.5 bg-slate-200/40 p-1.5 rounded-full border border-slate-100">
                <button onclick="window.openQAViewer()" 
                        style="${hasData ? 'box-shadow: 0 0 12px rgba(245, 158, 11, 0.4); border-color: rgba(245, 158, 11, 0.2);' : ''}"
                        class="w-9 h-9 rounded-full bg-white shadow-sm flex items-center justify-center hover:scale-105 active:translate-y-0.5 transition-all text-sm">
                    <span class="${hasData ? 'animate-pulse' : 'opacity-60'}">ğŸ’¡</span>
                </button>
                
                <button onclick="window.smartImportByDayCity()" 
                        class="w-9 h-9 rounded-full bg-pink-100 shadow-sm flex items-center justify-center hover:scale-105 active:translate-y-0.5 transition-all text-sm">
                    <span class="text-lg">ğŸ’</span>
                </button>

                <div class="flex gap-1 ml-1 pl-1 border-l border-slate-300/40">
                    <button onclick="window.openAddScheduleModal()" 
                            class="w-9 h-9 rounded-full bg-white/80 flex items-center justify-center text-slate-400 text-xl font-bold hover:text-pink-500 active:translate-y-0.5 transition-all">+</button>
                    <button onclick="window.openDayEditModal()" 
                            class="w-9 h-9 rounded-full bg-white/80 flex items-center justify-center text-slate-400 hover:text-blue-500 active:translate-y-0.5 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `;
}

/** ğŸ”„ æ¸²æŸ“å–®æ—¥æ’ç¨‹å…§å®¹ (v2.9.0 äº¤äº’å„ªåŒ–ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. ã€è§£é–æ‹–ç§»ã€‘ç§»é™¤å°å¡ä¸»é«”çš„ openAIPlusModalï¼Œå¾¹åº•è§£æ±ºæ‹–æ‹½èˆ‡å½ˆçª—çš„è¡çªã€‚
 * 2. ã€çµæ§‹é–å®šã€‘å¼·åˆ¶å»ºç«‹ itinerary-list-container å®¹å™¨ï¼Œä¾› SortableJS ç©©å®šæ›è¼‰ã€‚
 * 3. ã€AI+ å…¥å£é·ç§»ã€‘å°‡ AI å»ºè­°åŠŸèƒ½ç§»è‡³å°å¡å·¦å´ Iconï¼Œé»æ“Š Icon æ‰æœƒè§¸ç™¼ã€‚
 */
function renderDayContent() {
    // ğŸŒŸ 1. ç‰©ç†åº§æ¨™è‡ªç™’
    if (!state.currentTripId && state.trips && state.trips.length > 0) {
        state.currentTripId = state.trips[0].id;
        console.log("ğŸ“¡ [Render-AutoFix] å·²è‡ªå‹•å°ç„¦è‡³é¦–å€‹è¡Œç¨‹ ID:", state.currentTripId);
    }

    // ğŸŒŸ 2. å–å¾—æœ€æ–°å¯¦é«”è¡Œç¨‹æ•¸æ“š
    const trip = typeof getCurrentTrip === 'function' 
                 ? getCurrentTrip() 
                 : state.trips?.find(t => t.id === state.currentTripId);
    
    // ğŸŒŸ 3. å¤©æ•¸ç´¢å¼•æ ¡æº–
    if (state.currentDayIndex === undefined || state.currentDayIndex === null) {
        state.currentDayIndex = 0;
    }

    const day = trip?.days ? trip.days[state.currentDayIndex] : null;
    
    if (!day || !trip) {
        console.warn("ğŸ“¡ [Render-Safe] å¤©æ•¸åº§æ¨™æœªé–å®šï¼Œç•¥éæ¸²æŸ“æµç¨‹ã€‚");
        return;
    }

    const dayContent = document.getElementById('day-content-itinerary');
    if (!dayContent) return;

    // A. è™•ç†æ•¸æ“šåˆ†æµ (æ­£å¼ vs å·¥åŠ)
    let displaySchedules = [];
    let workshopUIHtml = ""; 

    if (window.state.planViewMode === 'workshop') {
        const workshopKey = `${trip.id}_day${day.dayNum}`;
        if (!window.state.shadowItineraries[workshopKey]) {
            window.state.shadowItineraries[workshopKey] = JSON.parse(JSON.stringify(day.schedules || []));
        }
        displaySchedules = window.state.shadowItineraries[workshopKey];

        workshopUIHtml = `
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg flex items-center justify-between shadow-sm mb-6 animate-in fade-in">
                <div>
                    <p class="text-blue-800 font-black text-xs leading-tight">ğŸ› ï¸ è¦åŠƒå·¥åŠæ¨¡å¼</p>
                    <p class="text-blue-600 text-[10px] mt-1">è®Šæ›´åƒ…æš«å­˜æ–¼è—åœ–ï¼Œä¸å½±éŸ¿æ­£å¼è¡Œç¨‹ã€‚</p>
                </div>
                <button onclick="publishWorkshop()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-black shadow-md hover:bg-blue-700 active:scale-95 transition-all">
                    ğŸš€ ç¢ºå®šç™¼ä½ˆ
                </button>
            </div>`;
    } else {
        displaySchedules = day.schedules || [];
    }

    const context = { trip, day, schedules: displaySchedules };

    // B. UI æ ¸å¿ƒçµ„ä»¶æ¸²æŸ“
    // ğŸŒŸ ç‰©ç†å°ä½ï¼šé€é div å®¹å™¨åŒ…è£¹ renderScheduleCardsï¼Œç¢ºä¿ SortableJS æŠ“å–ç›®æ¨™ç©©å®š
    dayContent.innerHTML = `
        ${workshopUIHtml}
        ${typeof renderDayHeader === 'function' ? renderDayHeader(context) : ''}
        ${typeof renderDynamicCards === 'function' ? renderDynamicCards(context) : ''}
        ${typeof renderVisualTimeline === 'function' ? renderVisualTimeline(context) : ''}
        
        <div id="itinerary-list-container" class="space-y-6 min-h-[100px]">
            ${typeof renderScheduleCards === 'function' ? renderScheduleCards(context) : ''}
        </div>
        
        <div id="itinerary-bottom-anchor" class="h-20 w-full"></div>
    `;

    // C. æˆ°æƒ…å®¤å³æ™‚è¯å‹•
    const alertBox = document.getElementById('sidebar-alerts-container');
    if (alertBox && typeof renderDailyAlertSidebar === 'function') {
        alertBox.innerHTML = renderDailyAlertSidebar(displaySchedules, day.date);
    }

    // D. ğŸŒŸ ç‰©ç†æ°¸ä¹…åŒ–ï¼šåŸ·è¡Œæ‹–ç§»å¼•æ“åˆå§‹åŒ–
    setTimeout(() => {
        if (typeof initScheduleSortable === 'function') {
            initScheduleSortable();
        }
        
        // ç‰©ç†å°ç„¦æ²å‹•
        if (window.state.lastAction === 'inserted') {
            const anchor = document.getElementById('itinerary-bottom-anchor');
            if (anchor) anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
            window.state.lastAction = null;
        }
    }, 150);
}

function initScheduleSortable() {
    const el = document.getElementById('itinerary-list-container');
    if (!el || typeof Sortable === 'undefined') return;

    if (el.sortableInstance) el.sortableInstance.destroy();

    el.sortableInstance = new Sortable(el, {
        animation: 150,
        handle: '.transport-card-body, .attraction-card-body', 
        ghostClass: 'opacity-10', // æ‹–å‹•æ™‚åŸæœ¬ä½ç½®å¹¾ä¹é€æ˜
        chosenClass: 'scale-[1.05]', // é¸ä¸­æ™‚æ˜é¡¯æ”¾å¤§
        dragClass: 'shadow-2xl',
        
        forceFallback: true,      // ğŸŒŸ æ ¸å¿ƒï¼šå¼·åˆ¶ä½¿ç”¨ HTML5 ä»¥å¤–çš„æ¨¡æ“¬æ¨¡å¼ (æ›´ç©©å®š)
        fallbackClass: 'sortable-fallback',
        delay: 100,               // ğŸŒŸ æ ¸å¿ƒï¼šæ‰‹æŒ‡æŒ‰ä¸‹ 100ms å¾Œæ‰å•Ÿå‹•æ‹–ç§» (é˜²æ­¢æ»‘å‹•é é¢æ™‚èª¤è§¸)
        delayOnTouchOnly: true,   // åƒ…åœ¨è§¸æ§è£ç½®ä½¿ç”¨å»¶é²
        
        onEnd: async function() {
            const trip = getCurrentTrip();
            const day = trip.days[state.currentDayIndex];
            // æŠ“å– ID é †åº
            const ids = Array.from(el.querySelectorAll('[id^="card-"]'))
                             .map(child => child.id.replace('card-', ''));

            day.schedules = ids.map(id => day.schedules.find(s => s.id === id)).filter(Boolean);
            if (typeof recalculateScheduleTimes === 'function') recalculateScheduleTimes(day);

            await saveData();
            renderDayContent(); 
            console.log("ğŸ’¾ ç‰©ç†æ’åºå·²é€é Sortable å›å¯«æˆåŠŸ");
        }
    });
}

/** ğŸ¤– è¡Œç¨‹é¡§å•æ ¸å¿ƒ v16.0 (ä¸‰ç´šåˆ†æµæ™ºæ…§æ•´åˆç‰ˆ)
 * æ•´åˆï¼š
 * 1. [OFFLINE]ï¼šç¶­æŒåŸæœ‰å…¨ç£å€æƒæ (InternalKnowledgeSearch)ï¼Œç©¿é€ IndexedDB æå– 490+ ç­†è³‡ç”¢ã€‚
 * 2. [LITE]ï¼šæ¥µé€Ÿç¯€æµæ¨¡å¼ï¼Œé‡å°å³æ™‚ç–‘å•çµ¦äºˆ 50 å­—å…§ç²¾è¯å»ºè­°ã€‚
 * 3. [FULL]ï¼šå®Œæ•´é¡§å•æ¨¡å¼ï¼Œæ³¨å…¥ 2026 å†¬å­£ä¸Šä¸‹æ–‡ï¼Œæä¾›ã€å³æ™‚ã€å»ºè­°ã€é¢¨éšªã€‘ä¸‰æ®µæˆ°ç•¥ã€‚
 */
window.askTacticalAI = async function(mode = 'standard', manualQuery = null) {
    const inputEl = document.getElementById('qa-user-query');
    const trackEl = document.getElementById('ai-conversation-track');
    const stream = document.getElementById('qa-chat-stream');
    
    const query = manualQuery || inputEl.value.trim();
    if (!query) return;

    // A. æ•¸æ“šå±¤å°ä½ (Data Layer Alignment)
    const trip = typeof getCurrentTrip === 'function' ? getCurrentTrip() : window.state?.trips?.[0];
    const day = typeof getCurrentDay === 'function' ? getCurrentDay() : (window.state?.currentDayNum ? trip?.days.find(d => d.dayNum === window.state.currentDayNum) : null);
    
    if (!day) return;
    if (!day.chatHistory) day.chatHistory = [];

    // B. ä½¿ç”¨è€…è¨Šæ¯é¡¯å½± (Slate-800 Q æ°£æ³¡)
    const userMessage = { role: 'user', content: query, timestamp: Date.now() };
    day.chatHistory.push(userMessage);
    
    trackEl.insertAdjacentHTML('beforeend', `
        <div class="group relative flex justify-end mb-8 animate-in slide-in-from-right-2">
            <button onclick="window.deleteQAItem('chat', ${day.chatHistory.length - 1})" 
                    class="absolute -top-2 -left-2 opacity-0 group-hover:opacity-100 w-6 h-6 bg-red-500 text-white rounded-full text-[10px] shadow-lg transition-all z-20">âœ•</button>
            <div class="bg-slate-800 text-white px-5 py-3.5 rounded-[1.5rem] rounded-tr-none text-[13px] font-bold shadow-lg max-w-[85%] leading-snug text-left">
                ${query}
            </div>
        </div>`);
    
    if (!manualQuery) inputEl.value = '';
    setTimeout(() => stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' }), 50);

    // C. é¡¯ç¤ºæ€è€ƒå‹•ç•« (Strategizing Animation)
    const loadingId = 'ai-loading-' + Date.now();
    trackEl.insertAdjacentHTML('beforeend', `
        <div id="${loadingId}" class="flex justify-start mb-8 animate-in fade-in">
            <div class="bg-white px-4 py-3 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-2">
                <div class="flex gap-1">
                    <div class="w-1.5 h-1.5 bg-pink-400 rounded-full animate-bounce"></div>
                    <div class="w-1.5 h-1.5 bg-pink-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-1.5 h-1.5 bg-pink-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1 italic">${mode.toUpperCase()} ANALYZING...</span>
            </div>
        </div>`);

    let response = "";
    let finalMode = mode;

    try {
        // --- æ¨¡å¼ 1ï¼šé›¢ç·šæˆ–ç„¡ç¶²è·¯ (ç¶­æŒç›®å‰æƒæå¼•æ“) ---
        if (!navigator.onLine || mode === 'offline') {
            finalMode = 'offline';
            response = await performInternalKnowledgeSearch(query);
        } 
        // --- æ¨¡å¼ 2 & 3ï¼šç·šä¸Šé›²ç«¯ç”Ÿæˆ (Gemini Engine) ---
        else {
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
            
            let prompt = "";
            if (mode === 'lite') {
                // ğŸš€ ç°¡æ˜“ç‰ˆï¼šæ¥µé€Ÿç¯€æµ
                prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­æ—¥æœ¬å°éŠã€‚é‡å°å•é¡Œã€Œ${query}ã€æä¾› 50 å­—å…§æ¥µç°¡æ ¸å¿ƒå»ºè­°ã€‚åƒ…å›è¦†ç´”æ–‡å­—ï¼Œä¸å‡†ç”¨ Markdownã€‚`;
            } else {
                // ğŸ§  è©³ç´°ç‰ˆï¼š2026 å†¬å­£åº§æ¨™é–å®š
                prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­æ—¥æœ¬æ—…éŠé¡§å•ã€‚
                ã€ç•¶å‰ç‰©ç†æ™‚é–“ã€‘ï¼š${dateStr} (2026å¹´å†¬å­£)ã€‚
                ã€ç•¶å‰åœ°é»ã€‘ï¼š${day.city || 'æ—¥æœ¬'}ã€‚
                ã€è¡Œç¨‹ä¸Šä¸‹æ–‡ã€‘ï¼š${day.schedules.map(s => s.name).join(' -> ')}
                ã€ä½¿ç”¨è€…å•é¡Œã€‘ï¼š${query}
                
                æŒ‡ä»¤è¦æ±‚ï¼š
                1. åˆ†ç‚ºã€å³æ™‚å°å¼•ã€‘ã€ã€å¯¦æˆ°å»ºè­°ã€‘ã€ã€é¢¨éšªæé†’ã€‘ã€‚
                2. ç¦æ­¢ä½¿ç”¨ Markdown æ¨™ç±¤ (ä¸è¦æœ‰ ** æˆ– #)ã€‚ä½¿ç”¨æ›è¡Œèˆ‡ç©ºæ ¼æ’ç‰ˆã€‚
                3. å›è¦†æ‡‰ç¬¦åˆ 1 æœˆä»½æ—¥æœ¬ä½æº«æ°£å€™èˆ‡å®‰å…¨å¸¸è­˜ã€‚`;
            }
            
            response = await callGeminiWithRetry(prompt);
            if (!response || response.length < 5) throw new Error("FallbackToLocal");
        }
    } catch (e) {
        // ç™¼ç”ŸéŒ¯èª¤è‡ªå‹•é™ç´šå›é›¢ç·šç£å€æœå°‹
        finalMode = 'offline';
        response = await performInternalKnowledgeSearch(query);
    }

    // D. æ•¸æ“šå­˜å„²èˆ‡æŒä¹…åŒ–
    document.getElementById(loadingId)?.remove();
    const aiMessage = { role: 'ai', content: response, mode: finalMode, timestamp: Date.now() };
    day.chatHistory.push(aiMessage);
    if (typeof saveData === 'function') await saveData(true);

    // E. æ™ºæ…§ CTA æŒ‰éˆ•åµæ¸¬
    const cleanResponse = window.cleanAIFormatting ? window.cleanAIFormatting(response) : response;
    let extraCTA = "";
    if (response.match(/åœ°åœ–|å°èˆª|è·¯ç·š|æ€éº¼å»|ä½ç½®/)) {
        extraCTA += `<button onclick="window.openDayMap()" class="bg-emerald-50 text-emerald-600 border border-emerald-100 px-3 py-1.5 rounded-lg text-[10px] font-black transition-all active:scale-95">ğŸ“ å°èˆªå°ä½</button>`;
    }
    if (response.match(/å¤©æ°£|æ°£æº«|é›ª|ä¿æš–|ä¸‹é›¨/)) {
        extraCTA += `<button onclick="window.askTacticalAI('lite', 'æŸ¥è©¢ä»Šæ—¥è©³ç´°æ°£è±¡é è­¦')" class="bg-blue-50 text-blue-600 border border-blue-100 px-3 py-1.5 rounded-lg text-[10px] font-black transition-all active:scale-95">â˜ï¸ æ°£è±¡æƒ…å ±</button>`;
    }

    // F. ç´”ç™½è·äººå¡ç‰‡æ¸²æŸ“
    const aiMsgHtml = `
        <div class="group relative flex justify-start mb-10 animate-in slide-in-from-left-2">
            <button onclick="window.deleteQAItem('chat', ${day.chatHistory.length - 1})" 
                    class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 w-6 h-6 bg-rose-500 text-white rounded-full text-[10px] shadow-lg transition-all z-20">âœ•</button>
            <div class="w-full bg-white border border-slate-100 rounded-[2.5rem] p-7 shadow-sm relative overflow-hidden">
                <div class="space-y-4 text-slate-700 font-medium leading-relaxed text-left whitespace-pre-wrap">
                    ${cleanResponse}
                </div>
                
                ${extraCTA ? `<div class="mt-6 pt-4 border-t border-slate-50 flex flex-wrap gap-2">${extraCTA}</div>` : ''}

                <div class="mt-6 pt-4 border-t border-slate-50 flex items-center justify-between">
                    <span class="text-[9px] font-black text-slate-300 italic uppercase tracking-widest">
                        SOURCE: ${finalMode.toUpperCase()} | 2026 SYNC
                    </span>
                    ${(navigator.onLine && finalMode === 'offline') ? 
                        `<button onclick="window.askTacticalAI('standard', '${query.substring(0, 15)}')" 
                                 class="text-[9px] font-black theme-text-pink animate-pulse">âœ¨ å•Ÿå‹•é€²åŒ–å›è¦†</button>` : ''}
                </div>
            </div>
        </div>`;
    
    trackEl.insertAdjacentHTML('beforeend', aiMsgHtml);
    setTimeout(() => stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' }), 100);
};

/** ğŸ§¼ ç¬¦è™Ÿè„«æ•èˆ‡éˆæ¥è¾¨è­˜å¼•æ“ (v2.1.0 è·äººå¼·åŒ–ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. è¦–è¦ºæŒ‡ç´‹é–å®šï¼šå¼·åŒ–ã€æ¨™é¡Œè† å›Šã€‘çš„ç™¼å…‰ç‰¹æ•ˆèˆ‡æ–‡å­—ç²—ç´°ï¼Œé–å®š Slate-800 ç¢ºä¿å…¨ç’°å¢ƒå¯è®€ã€‚
 * 2. æ™ºæ…§æ’ç‰ˆè‡ªç™’ï¼šå„ªåŒ–å†’è™Ÿæ¨™é¡Œ (Title: Content) çš„å°æ¯”ï¼Œä½¿ç”¨ä¸‹åŠƒç·šå¼·èª¿é‡é»ã€‚
 * 3. éˆæ¥æ„ŸçŸ¥ï¼šæå‡å°èˆªèˆ‡é€£çµæŒ‰éˆ•çš„ç‰©ç†å›é¥‹ï¼Œç¢ºä¿è§¸æ§ç²¾æº–ã€‚
 */
window.cleanAIFormatting = function(text) {
    if (!text) return "";

    let clean = text;

    // ğŸŒŸ 1. ç²—é«”èªæ³•è½‰ HTML (æ¥µè‡´é»‘ font-black)
    clean = clean.replace(/\*\*(.*?)\*\*/g, '<b class="text-slate-900 font-black">$1</b>');

    // ğŸŒŸ 2. å¤–éƒ¨é€£çµèˆ‡åœ°åœ–è¾¨è­˜ (2026 å»£åŸŸè·¯ç¶²ç›¸å®¹)
    const urlRegex = /(https?:\/\/[^\s\n\r"']+)/g;
    clean = clean.replace(urlRegex, (url) => {
        const isMap = /google.*maps|goo\.gl\/maps|maps\.app\.goo\.gl/.test(url);
        const label = isMap ? 'ğŸ“ å•Ÿå‹•å°èˆª' : 'ğŸ”— å®˜æ–¹è³‡è¨Š';
        const bgColor = isMap 
            ? 'bg-emerald-50 text-emerald-600 border-emerald-200 shadow-emerald-100/50' 
            : 'bg-blue-50 text-blue-600 border-blue-200 shadow-blue-100/50';
        
        return `<a href="${url}" target="_blank" onclick="event.stopPropagation()" 
                   class="inline-flex items-center gap-1.5 px-3 py-1.5 my-1 rounded-xl border ${bgColor} text-[11px] font-black no-underline active:scale-95 transition-all shadow-sm">
                    ${label}
                </a>`;
    });

    // ğŸŒŸ 3. è­˜åˆ¥ã€æ¨™é¡Œè† å›Šã€‘(å¢åŠ  Pink-500 æŒ‡ç¤ºæ¢èˆ‡å‘¼å¸æ„Ÿé™°å½±)
    clean = clean.replace(/ã€(.*?)ã€‘/g, (match, p1) => {
        return `
            <div class="flex items-center gap-2 mt-9 first:mt-2 mb-4">
                <div class="w-1.5 h-4 bg-pink-500 rounded-full shadow-[0_0_10px_rgba(236,72,153,0.4)]"></div>
                <span class="text-[15px] font-black text-slate-800 tracking-tight uppercase">${p1}</span>
                <div class="flex-1 h-[1px] bg-slate-100/80 ml-1"></div>
            </div>`;
    });

    // ğŸŒŸ 4. è™•ç†æ®µè½ã€åˆ—è¡¨èˆ‡æ™ºæ…§å†’è™Ÿæ¨™é¡Œ
    const lines = clean.split('\n').filter(p => p.trim());
    
    return lines.map(p => {
        let line = p.trim();

        // A. è™•ç† Markdown åˆ—è¡¨ (è½‰åŒ–ç‚ºè·äººç²‰è‰²å°å¼•é»)
        if (line.startsWith('* ') || line.startsWith('- ')) {
            const content = line.replace(/^[\*\-]\s+/, '');
            return `<p class="text-[14px] text-slate-600 leading-[1.8] mb-3 pl-2 flex items-start gap-2.5">
                        <span class="shrink-0 text-pink-400 mt-2 text-[8px] animate-pulse">â—</span>
                        <span class="font-medium">${content}</span>
                    </p>`;
        }

        // B. ç§»é™¤å‰©é¤˜ Markdown é›œè¨Š (# èˆ‡ `)
        line = line.replace(/[#`]/g, '');

        // C. æ™ºæ…§åŠ ç²—ã€Œå†’è™Ÿæ¨™é¡Œã€ (ç²¾æº–æ•ç²ï¼šäº¤é€šã€å»ºè­°ã€æé†’)
        const colonIndex = line.indexOf('ï¼š') !== -1 ? line.indexOf('ï¼š') : line.indexOf(':');
        if (colonIndex > 0 && colonIndex < 20) {
            const title = line.substring(0, colonIndex);
            const content = line.substring(colonIndex + 1);
            return `<p class="text-[14px] text-slate-600 leading-[1.8] mb-4">
                        <b class="text-slate-900 font-black border-b-2 border-pink-100/60 pb-0.5">${title}</b>ï¼š${content}
                    </p>`;
        }

        // D. æ¨™æº–å…§æ–‡æ®µè½ (å¢åŠ è¡Œé–“è· Leading)
        return `<p class="text-[14px] text-slate-600 leading-[1.8] mb-4 font-medium tracking-wide">${line}</p>`;
    }).join('');
};


/** ğŸš€ æ‰‹å‹•é€²åŒ–æ©Ÿåˆ¶ï¼šå°‡é›¢ç·šè³‡æ–™å‡ç´šç‚º AI å…§å®¹ (v9.3.0 ç‰©ç†å°ä½ç‰ˆ) 
 * ä¿®æ­£ï¼š
 * 1. å°èˆªå¼·åŒ–ï¼šé–å®š .bg-white æ°£æ³¡ä¸»é«”ï¼Œä¸¦ç²¾æº–å®šä½å…§å®¹å€å¡Š .space-y-6ã€‚
 * 2. æ•¸æ“šå›å¯«ï¼šä¿®æ­£ lastAI çš„æŠ“å–é‚è¼¯ï¼Œç¢ºä¿é€²åŒ–å¾Œçš„å…§å®¹ 100% å­˜å…¥ IndexedDBã€‚
 * 3. å®¹éŒ¯è£œå¼·ï¼šå¢åŠ å° cleanAIFormatting çš„å­˜åœ¨æª¢æŸ¥ã€‚
 */
window.evolveResponse = async function(querySummary, btnEl) {
    // ğŸ›¡ï¸ 1. å°‹æ‰¾æ°£æ³¡ä¸»é«” (ç¢ºä¿åœ¨ç´”æ·¨ç‰ˆçµæ§‹ä¸‹ 100% å°é€š)
    const parentBubble = btnEl.closest('.bg-white');
    if (!parentBubble) return console.error("âŒ ç‰©ç†å°ä½å¤±æ•—ï¼šæ‰¾ä¸åˆ°æ°£æ³¡å®¹å™¨");

    // å°‹æ‰¾æ–‡å­—å…§å®¹å®¹å™¨ (å°ä½ v9.1.5 çµæ§‹)
    const textContainer = parentBubble.querySelector('.space-y-6');
    if (!textContainer) return console.error("âŒ å…§å®¹å€å¡Šå¤±è¹¤");

    // 2. é¡¯ç¤ºé€²åŒ–ä¸­ç‹€æ…‹ (è·äººé¢¨æ ¼)
    const originalBtnHtml = btnEl.innerHTML;
    btnEl.innerHTML = `<span>â³</span> ç·¨ç¹”ä¸­...`;
    btnEl.classList.remove('animate-pulse');
    btnEl.disabled = true;

    try {
        const day = typeof getCurrentDay === 'function' ? getCurrentDay() : (window.state?.trips?.[0]?.days[0]);
        const originalText = textContainer.innerText;
        
        // ğŸš€ åŸ·è¡Œé€²åŒ–è«‹æ±‚
        const prompt = `ä½ ç¾åœ¨æ˜¯å°ˆæ¥­æ—…éŠé¡§å•ã€‚ä½¿ç”¨è€…åœ¨ ${day.city} è©¢å•ã€Œ${querySummary}ã€ï¼Œ
        ç›®å‰çš„æœ¬åœ°å­˜æª”å…§å®¹ç‚ºï¼šã€Œ${originalText}ã€ã€‚
        è«‹çµåˆ 2026 æœ€æ–°è³‡è¨Šï¼Œæä¾›æ›´æ·±å…¥ã€æ›´å…·å¯¦æˆ°åƒ¹å€¼çš„å»ºè­°ã€‚
        è¦æ±‚ï¼šä¸è¦ Markdownï¼Œåˆ†ç‚ºã€å³æ™‚é€²åŒ–å»ºè­°ã€‘ã€ã€é¢¨éšªæé†’ã€‘ã€‚`;
        
        const betterResponse = await callGeminiWithRetry(prompt);
        
        // 3. UI æ›´æ–°èˆ‡ç¾åŒ–è™•ç†
        const cleanResp = window.cleanAIFormatting ? window.cleanAIFormatting(betterResponse) : betterResponse;
        textContainer.innerHTML = cleanResp;

        // 4. ç‰©ç†æŒä¹…åŒ– (æ›´æ–°è³‡æ–™åº«å…§çš„å°è©±ç´€éŒ„)
        if (day.chatHistory && day.chatHistory.length > 0) {
            // å°‹æ‰¾æœ€å¾Œä¸€ç­†ç”± ai ç”¢ç”Ÿçš„é›¢ç·šè¨Šæ¯
            const aiMessages = day.chatHistory.filter(m => m.role === 'ai');
            const targetMessage = aiMessages[aiMessages.length - 1];
            
            if (targetMessage) {
                targetMessage.content = betterResponse;
                targetMessage.isOffline = false; // æ¨™è¨˜ç‚ºé›²ç«¯é€²åŒ–ç‰ˆ
                
                if (typeof saveData === 'function') {
                    await saveData(true); // ç‰©ç†é–å®š
                    console.log("âœ… é€²åŒ–æ•¸æ“šå·²é–å®šè‡³ IndexedDB");
                }
            }
        }

        // 5. æŒ‰éˆ•ç‹€æ…‹å›ºåŒ–
        btnEl.innerHTML = `<span>âœ…</span> é€²åŒ–å®Œæˆ`;
        btnEl.className = "flex items-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-600 rounded-full text-[9px] font-black border border-green-100 shadow-sm";
        btnEl.onclick = null; // é—œé–‰è§¸ç™¼å™¨
        
    } catch (e) {
        console.error("é€²åŒ–å¤±æ•—:", e);
        btnEl.innerHTML = `<span>âŒ</span> è«‹æ±‚å¤±æ•—`;
        setTimeout(() => {
            btnEl.innerHTML = originalBtnHtml;
            btnEl.disabled = false;
            btnEl.classList.add('animate-pulse');
        }, 2000);
    }
};


/**
 * ğŸ”„ TravelFlow è·äººå¤§ä¸€çµ±é€²åŒ–æ¨¡çµ„ v5.9.0
 * ä¿®æ­£é …ç›®ï¼š
 * 1. é—œéµå­—éæ¿¾ï¼šå®Œå…¨ç§»é™¤ã€Œæˆ°è¡“ã€äºŒå­—ï¼Œæ”¹ç‚ºã€Œå»ºè­°ã€æˆ–ã€Œå°å¼•ã€ã€‚
 * 2. Q&A å°ä½ï¼šæŒ‰éˆ•å°‡ç²¾ç¢ºæ³¨å…¥è‡³ Q&A å…§å®¹å€å¡Šã€‚
 * 3. æ¸²æŸ“é–‰ç’°ï¼šæä¾›æ˜ç¢ºçš„é¡¯å½±å‡½æ•¸æ¸…å–®ã€‚
 */
window.initProfessionalEvolutionModule = function() {
    console.log("ğŸ¬ å•Ÿå‹•è·äººæ¶æ§‹ï¼šåŸ·è¡Œæ•¸æ“šå±¤èˆ‡ UI å±¤åˆå§‹åŒ–...");

    // --- [1. æ ¸å¿ƒå­—å…¸ï¼šMaster Glossary] ---
    const INITIAL_GLOSSARY = [
        { id: "GEO_STA_HAKATA", name: "åšå¤šè»Šç«™", aliases: ["åšå¤šé§…", "Hakata Station"], category: "transport", color: "#2563EB", tip: "ğŸ’¡ è½‰ä¹˜æ¨ç´ï¼šå»ºè­°é ç•™ 20 åˆ†é˜é ˜å– JR Passã€‚" },
        { id: "GEO_REG_FUK", name: "ç¦å²¡å¸‚", aliases: ["ç¦å²¡"], category: "region", color: "#E11D48", tip: "ğŸ’¡ æ™šé–“æ¨è–¦å‰å¾€ä¸­æ´²æˆ–å¤©ç¥é«”é©—å±‹å°æ–‡åŒ–ã€‚" },
        { id: "GEO_STA_BEPPU", name: "åˆ¥åºœ", aliases: ["åˆ¥åºœæº«æ³‰", "åˆ¥åºœé§…"], category: "onsen", color: "#38bdf8", tip: "â™¨ï¸ å»ºè­°å‰å¾€ã€åœ°ç„å·¡ç¦®ã€ï¼Œä¸¦æ³¨æ„å…¬è»Šç­æ¬¡æ™‚é–“ã€‚" },
        { id: "GEO_MT_ASO", name: "é˜¿è˜‡å±±", aliases: ["é˜¿è˜‡ç«å±±", "ä¸­å²³"], category: "nature", color: "#10b981", tip: "ğŸŒ‹ å±±å€æ°£æº«ä½ä¸”å¸¸æœ‰ç¡«ç£ºæ°£é«”ç®¡åˆ¶ï¼Œå‡ºç™¼å‰ç¢ºèªç‹€æ…‹ã€‚" }
    ];

    window.state = window.state || {};
    window.state.masterGlossary = INITIAL_GLOSSARY;
    window.state.intelligenceBuffer = window.state.intelligenceBuffer || [];
    window.state.evolutionPower = window.state.evolutionPower || "Free";

    // --- [2. Q&A å€å¡ŠæŒ‰éˆ•æ³¨å…¥é‚è¼¯] ---
    window.injectQAProButton = function(dayNum) {
        const container = document.querySelector(`#qa-container-day-${dayNum}`) || 
                          document.querySelector('.qa-viewer-content');
        
        if (!container || document.getElementById(`scan-btn-${dayNum}`)) return;

        const btn = document.createElement('button');
        btn.id = `scan-btn-${dayNum}`;
        btn.className = "w-full mb-4 p-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold shadow-md flex items-center justify-center gap-2 transition active:scale-95";
        btn.innerHTML = "<span>ğŸ“¡ åŸ·è¡Œå…¨åŸŸå…§å®¹æƒæ</span>";
        btn.onclick = () => window.executeGlobalContentScan(dayNum);
        container.prepend(btn);
        console.log(`âœ… å·²æ–¼ Q&A å€å¡Šæ³¨å…¥æƒææŒ‰éˆ• (Day ${dayNum})`);
    };

/** ğŸ”„ TravelFlow è¡Œç¨‹é¡§å•æ ¸å¿ƒ v7.1.0 (çµ‚æ¥µç´”æ·¨ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. é‚è¼¯æ­¸é›¶ï¼šç§»é™¤æ‰€æœ‰ DOM æ“ä½œèˆ‡å®¹å™¨æ¸…ç†ï¼Œæ”¹ç‚ºç´”ç²¹çš„ç‹€æ…‹ç¢ºèªã€‚
 * 2. éœé»˜å°é€šï¼šä¿ç•™å‡½æ•¸å…¥å£ä»¥ç¶­æŒç³»çµ±ç›¸å®¹æ€§ï¼Œç¢ºä¿ Header åˆ‡æ›ä¸å ±éŒ¯ã€‚
 * 3. è³‡æºé›¶è€—ï¼šå»¢é™¤æ‰€æœ‰æ¢ä»¶åˆ¤æ–·èˆ‡å¤–éƒ¨å‡½æ•¸å‘¼å«ã€‚
 */
window.executeGlobalContentScan = function(dayNum) {
    // 1. åƒ…ä¿ç•™é–‹ç™¼è€…æ—¥èªŒï¼Œç”¨æ–¼ç›£æ§å¤©æ•¸åˆ‡æ›åº§æ¨™
    console.log(`ğŸ“¡ Advisor Connector: Day ${dayNum} aligned. (Active Scanning Disabled)`);

    // 2. ç‰©ç†æ–·è·¯ï¼šä¸å†åŸ·è¡Œä»»ä½• DOM æ¸…ç†ã€æ¸²æŸ“æˆ–è‡ªç™’è¯å‹•ã€‚
    // é€™æ¨£èƒ½ç¢ºä¿ Q&A è¦–çª—çš„å…§å®¹å®Œå…¨ç”± chatHistory é©…å‹•ï¼Œ
    // ä¸æœƒå—åˆ°ä»»ä½•èƒŒæ™¯é‚è¼¯çš„æ„å¤–å¹²æ“¾ã€‚
    return true; 
};

console.log("ğŸ ç³»çµ±å ±å‘Šï¼šå…¨åŸŸæƒæé‚è¼¯å·²å¾¹åº•ç‰©ç†æ’¤ç·¨ï¼Œé¡§å•åŠŸèƒ½å›æ­¸ç´”æ·¨å°è©±æ¨¡å¼ã€‚");

};

/** ğŸ”„ è¡Œç¨‹é¡§å•æŸ¥çœ‹å™¨ v16.5 (ä¸‰ç´šåˆ†æµæ™ºæ…§ç‰ˆ)
 * ä¿®æ­£é‡é»ï¼š
 * 1. ç‰©ç†ç§»é™¤æ®˜ç•™ï¼šå¼·åˆ¶åµæ¸¬ä¸¦ç§»é™¤èˆŠç‰ˆ evolution é¢æ¿ã€‚
 * 2. ä¸‰ç´šåˆ†æµå°ä½ï¼šæ•´åˆ ğŸ“‚é›¢ç·š / âš¡å¿«é€Ÿ / ğŸ§ è©³ç´° ä¸‰è·¯å¯¦é«”æŒ‰éˆ•ã€‚
 * 3. è¦–è¦ºæŒ‡ç´‹é–å®šï¼šQ (æ·±è‰² Slate-800) | A (ç´”ç™½è·äººå¡ç‰‡)ã€‚
 */
window.openQAViewer = function() {
    // ğŸŒŸ A. ç‰©ç†æ¸…å ´ï¼šå¼·åˆ¶ç§»é™¤å³ä¸‹è§’çªå…€çš„å¯¦é«”é¢æ¿
    const legacyPanel = document.querySelector('[id*="evolution-v5"]');
    if (legacyPanel) {
        legacyPanel.remove();
        console.log("%c ğŸ§¹ å®ˆè¡›å ±å‘Šï¼šå·²ç‰©ç†ç§»é™¤å³ä¸‹è§’æ®˜ç•™é¢æ¿ ", "color: #ef4444; font-weight: bold;");
    }

    const day = typeof getCurrentDay === 'function' ? getCurrentDay() : (window.state?.trips?.[0]?.days[0]);
    if (!day) return;

    // ğŸŒŸ B. æ•¸æ“šå±¤éœé»˜è‡ªç™’
    if (day.chatHistory) {
        day.chatHistory = day.chatHistory.filter(msg => msg.content && msg.content.trim().length > 1);
    }

    // ğŸŒŸ C. ç‰©ç†åˆªé™¤æ©Ÿåˆ¶
    window.deleteQAItem = async function(type, index) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ")) return;
        if (type === 'chat') day.chatHistory.splice(index, 1);
        
        if (typeof saveData === 'function') await saveData(true);
        document.getElementById('qa-viewer-overlay')?.remove();
        window.openQAViewer(); // åˆ·æ–°è¦–åœ–
    };

    const modalId = 'qa-viewer-overlay';
    if (document.getElementById(modalId)) document.getElementById(modalId).remove();

    const overlay = document.createElement('div');
    overlay.id = modalId;
    overlay.className = "fixed inset-0 z-[100] flex items-end justify-center bg-slate-900/70 backdrop-blur-sm animate-in fade-in duration-300";
    
    // ğŸŒŸ D. æ¸²æŸ“å°è©±è»Œé“ (æ·±è‰² Q æ°£æ³¡èˆ‡ç´”ç™½ A å¡ç‰‡)
    const historyHtml = (day.chatHistory || []).map((msg, idx) => {
        const isUser = msg.role === 'user';
        if (isUser) {
            return `
                <div class="group relative flex justify-end mb-8 animate-in slide-in-from-right-2 px-4">
                    <button onclick="window.deleteQAItem('chat', ${idx})" 
                            class="absolute -top-2 -left-2 opacity-0 group-hover:opacity-100 w-6 h-6 bg-red-500 text-white rounded-full text-[10px] shadow-lg transition-all z-20">âœ•</button>
                    <div class="bg-slate-800 text-white px-5 py-3.5 rounded-[1.5rem] rounded-tr-none text-[13px] font-bold shadow-lg max-w-[85%] leading-snug text-left">
                        ${msg.content.replace(/[#*]/g, '')}
                    </div>
                </div>`;
        } else {
            const cleanResp = window.cleanAIFormatting ? window.cleanAIFormatting(msg.content) : msg.content;
            return `
                <div class="group relative flex justify-start mb-10 animate-in slide-in-from-left-2 px-4">
                    <button onclick="window.deleteQAItem('chat', ${idx})" 
                            class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 w-6 h-6 bg-rose-500 text-white rounded-full text-[10px] shadow-lg transition-all z-20">âœ•</button>
                    <div class="w-full bg-white border border-slate-100 rounded-[2.5rem] p-7 shadow-sm relative overflow-hidden">
                        <div class="space-y-4 text-slate-700 font-medium leading-relaxed text-left whitespace-pre-wrap">${cleanResp}</div>
                        <div class="mt-6 pt-4 border-t border-slate-50 flex items-center justify-between">
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-300 italic">
                                SOURCE: ${msg.mode ? msg.mode.toUpperCase() : 'ADVISOR'}
                            </span>
                            ${(navigator.onLine && msg.mode === 'offline') ? 
                                `<button onclick="window.askTacticalAI('standard', '${msg.content.substring(0,15).replace(/'/g, "\\'")}')" class="text-[9px] font-black theme-text-pink animate-pulse">âœ¨ å•Ÿå‹•é€²åŒ–</button>` : ''}
                        </div>
                    </div>
                </div>`;
        }
    }).join('');

    overlay.innerHTML = `
        <div class="w-full max-w-lg bg-white rounded-t-[3.5rem] shadow-2xl animate-in slide-in-from-bottom-full duration-500 flex flex-col" style="height: 90vh;">
            <div class="w-12 h-1.5 bg-slate-100 rounded-full mx-auto my-5 flex-shrink-0"></div>
            
            <div class="px-8 pb-4 flex items-center justify-between border-b border-slate-50 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-11 h-11 rounded-2xl bg-pink-50 flex items-center justify-center text-2xl shadow-inner shadow-pink-100/50">ğŸ’¡</div>
                    <div>
                        <h3 class="text-xl font-black text-slate-800 tracking-tighter leading-none">è¡Œç¨‹é¡§å•</h3>
                        <p class="text-[9px] font-black text-pink-500 uppercase tracking-widest mt-1 italic">V16.5 Tactical Divergence</p>
                    </div>
                </div>
                <button onclick="document.getElementById('${modalId}').remove()" class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 font-bold hover:bg-slate-100 transition-all">âœ•</button>
            </div>
            
            <div id="qa-chat-stream" class="flex-1 overflow-y-auto py-8 no-scrollbar space-y-12">
                <div id="ai-conversation-track">
                    ${historyHtml || '<p class="text-center text-slate-300 text-[11px] py-10 font-bold italic tracking-widest uppercase">System Purified / Ready</p>'}
                </div>
            </div>

            <div class="p-6 bg-white border-t border-slate-50 pb-10 flex-shrink-0 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
                <div class="relative flex items-center bg-slate-50 rounded-2xl p-2 border border-slate-200 focus-within:bg-white focus-within:ring-4 ring-pink-100 transition-all shadow-inner mb-4">
                    <input type="text" id="qa-user-query" class="flex-1 bg-transparent border-none outline-none px-4 py-2 text-sm font-bold text-slate-700 placeholder:text-slate-300" placeholder="è©¢å•æˆ°è¡“æˆ–ä½ç½®..." onkeypress="if(event.key === 'Enter') window.askTacticalAI('lite')">
                    <button onclick="window.askTacticalAI('lite')" class="w-12 h-12 rounded-xl bg-pink-500 text-white flex items-center justify-center shadow-lg active:scale-95 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="window.askTacticalAI('offline')" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl text-[10px] font-black border border-slate-200 active:scale-95 transition-all">ğŸ“‚ é›¢ç·š</button>
                    <button onclick="window.askTacticalAI('lite')" class="flex-1 py-3 bg-pink-50 text-pink-500 rounded-xl text-[10px] font-black border border-pink-100 active:scale-95 transition-all">âš¡ å¿«é€Ÿ</button>
                    <button onclick="window.askTacticalAI('standard')" class="flex-1 py-3 bg-slate-800 text-white rounded-xl text-[10px] font-black shadow-lg active:scale-95 transition-all">ğŸ§  è©³ç´°</button>
                </div>
            </div>
        </div>`;
    
    document.body.appendChild(overlay);
    
    setTimeout(() => {
        const stream = document.getElementById('qa-chat-stream');
        if (stream) stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' });
    }, 100);
};


/** ğŸ›°ï¸ EVOLUTION æˆ°æƒ…å®¤æ•´åˆç³»çµ± v11.0 (å–ä»£å¯¦é«”é¢æ¿) 
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†æ¸…å ´ï¼šåŸ·è¡Œæ™‚è‡ªå‹•åµæ¸¬ä¸¦ç§»é™¤ä»»ä½• ID åŒ…å« evolution çš„ DOM ç¯€é»ã€‚
 * 2. æ•¸æ“šå›å ±ï¼šå°‡ç³»çµ±ç‹€æ…‹ (ç‰ˆæœ¬/æ¨¡å¼/ç·©è¡) è¼¸å‡ºè‡³é–‹ç™¼è€…å·¥å…·ï¼Œä¸åœ¨æ‰‹æ©Ÿç•«é¢é¡¯å½±ã€‚
 */
window.logEvolutionStatus = function() {
    // A. ç‰©ç†æ¸…å ´æ©Ÿåˆ¶ï¼šè‡ªå‹•æƒæä¸¦ç§»é™¤æ‡¸æµ®é¢æ¿
    const legacyIds = ['evolution-v59-panel', 'evolution-debug-panel', 'evolution-status-box'];
    legacyIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.remove();
            console.log(`%c ğŸ§¹ å·²ç‰©ç†æ¸…ç†èˆŠæ™‚ä»£æ®˜ç•™ç¯€é»: #${id} `, "color: #ef4444; font-weight: bold;");
        }
    });

    // B. æ•¸æ“šå±¤æå–
    const trip = (typeof state !== 'undefined' && state.trips) ? state.trips[0] : {};
    const day = (typeof state !== 'undefined' && state.currentDayNum) ? trip.days?.find(d => d.dayNum === state.currentDayNum) : null;
    
    // C. Console æˆ°æƒ…è¼¸å‡º (å–ä»£æˆªåœ– image_f86329.png ä¸­çš„é¢æ¿)
    console.group("%c ğŸ›°ï¸ EVOLUTION SYSTEM STATUS (V11.0) ", "background: #1e293b; color: #38bdf8; font-weight: bold; padding: 4px; border-radius: 4px;");
    console.log(`%c æ¨¡å¼: %cStrategic Advisor (Paid Tier)`, "color: #94a3b8", "color: #f472b6; font-weight: bold;");
    console.log(`%c ç·©è¡: %c${day?.chatHistory?.length || 0} ç­†ç´€éŒ„`, "color: #94a3b8", "color: #fbbf24; font-weight: bold;");
    console.log(`%c åº§æ¨™: %cDay ${day?.dayNum || 1} / ${day?.city || 'Banqiao Alignment'}`, "color: #94a3b8", "color: #2dd4bf;");
    console.log(`%c æ ¸å¿ƒ: %cGemini 3 Flash (2026-01-19 Sync)`, "color: #94a3b8", "color: #ffffff; font-style: italic;");
    console.groupEnd();
};

// åœ¨ç³»çµ±åˆå§‹åŒ–å®Œç•¢å¾Œç«‹å³å·¡æª¢
setTimeout(window.logEvolutionStatus, 1500);

/** ğŸ§  æœ¬åœ°é€²éšè§£æå¼•æ“ï¼šæ·±åº¦èªç¾©æ„Ÿæ‡‰ç‰ˆ (v7.2)
 * ä¿®æ­£ï¼š
 * 1. å»¢é™¤ç½é ­æ–‡æ¡ˆï¼šä¸å†åå‡ºé€šç”¨çš„äº¤é€šæ™‚é–“ï¼Œæ”¹ç‚ºæŒ–æ˜ã€Œå‚™è¨»æ¬„ã€èˆ‡ã€Œäº¤é€šå°å¡ã€å…§çš„å¯¦æˆ°å…§å®¹ã€‚
 * 2. æŒ‡ç´‹ç©¿é€ï¼šè‡ªå‹•æœå°‹ state.bucketList (299ç­†è³‡ç”¢) ä¸­çš„éš±è—ç­†è¨˜èˆ‡äº¤é€šæ–¹å¼ã€‚
 * 3. èªæ„é–‰ç’°ï¼šè‹¥æå•çš„åœ°é»åœ¨è¡Œç¨‹ä¸­ï¼Œç›´æ¥æå–è©²å¡ç‰‡çš„ã€Œè©³ç´°å…§å®¹ã€ä½œç‚ºè§£ç­”ã€‚
 */
function performAdvancedLocalSearch(query) {
    const q = query.toUpperCase();
    const day = getCurrentDay();
    const trip = getCurrentTrip();
    const allBuckets = trip?.bucketList || state.bucketList || [];
    const currentSchedules = day?.schedules || [];

    // ğŸŒŸ ç­–ç•¥ 1ï¼šå„ªå…ˆæœå°‹ã€Œç•¶å‰æ’ç¨‹å¡ç‰‡ã€çš„æ·±åº¦æŒ‡ç´‹
    const matchedSchedule = currentSchedules.find(s => q.includes(s.name.toUpperCase()));
    if (matchedSchedule && matchedSchedule.notes) {
        return `é‡å°è¡Œç¨‹ä¸­çš„ã€Œ${matchedSchedule.name}ã€ï¼Œæ‚¨çš„æˆ°è¡“å‚™è¨»è¨˜éŒ„å¦‚ä¸‹ï¼š<br><br>
                <div class="bg-white p-3 rounded-xl border border-pink-100 shadow-inner italic text-slate-600">
                    ${matchedSchedule.notes.replace(/\\n/g, '<br>')}
                </div><br>
                ğŸ’¡ æç¤ºï¼šé€™æ˜¯æ‚¨åœ¨å®‰æ’è¡Œç¨‹æ™‚å›ºåŒ–çš„æˆ°è¡“ç´°ç¯€ã€‚`;
    }

    // ğŸŒŸ ç­–ç•¥ 2ï¼šç©¿é€æœå°‹ã€Œ299 ç­†å‚™é¸è³‡ç”¢ã€ä¸­çš„å°ˆæ¥­ç­†è¨˜
    const matchedBucket = allBuckets.find(b => q.includes(b.name.toUpperCase()));
    if (matchedBucket) {
        let response = `å·²å¾ç‰©ç†å­—å…¸ä¸­æª¢ç´¢åˆ°ã€Œ${matchedBucket.name}ã€çš„æŒ‡ç´‹ï¼š<br><br>`;
        if (matchedBucket.notes) response += `ğŸ“ **å°ˆæ¥­ç­†è¨˜**ï¼š${matchedBucket.notes}<br>`;
        if (matchedBucket.location) response += `ğŸ“ **ç‰©ç†ä½ç½®**ï¼š${matchedBucket.location}<br>`;
        if (matchedBucket.customStyle) response += `ğŸ·ï¸ **åˆ†é¡æ¨™ç±¤**ï¼š#${matchedBucket.customStyle}<br>`;
        
        // åµæ¸¬æ˜¯å¦åŒ…å«ç‰¹å®šçš„ [[äº¤é€šæ¨™ç±¤]]
        const transMatch = matchedBucket.notes?.match(/\[\[(.*?)\]\]/);
        if (transMatch) {
            response += `<br>ğŸš† **åµæ¸¬åˆ°å»ºè­°å‹•ç·š**ï¼š${transMatch[1]}`;
        }
        return response;
    }

    // ğŸŒŸ ç­–ç•¥ 3ï¼šé‡å°ã€Œå°å€‰/åšå¤š/å¤ªå®°åºœã€ç­‰æ ¸å¿ƒå€å¡Šçš„ã€Œé˜²é›·æŒ‡ç´‹ã€
    // åªæœ‰åœ¨çœŸçš„åŒ¹é…åˆ°ç‰¹å®šé›·å€æ™‚æ‰è§¸ç™¼ï¼Œæ‹’çµ•å»¢è©±
    if (q.includes("å°å€‰") && q.includes("åšå¤š") && q.includes("PASS")) {
        return `âš ï¸ **ç¥¨åˆ¸é›·å€è­¦å‘Š**ï¼šåšå¤šèˆ‡å°å€‰é–“çš„ã€Œæ–°å¹¹ç·šã€å±¬ JR è¥¿æ—¥æœ¬ç®¡è½„ã€‚é™¤éæ‚¨æŒæœ‰ã€Œå…¨æ—¥æœ¬ç‰ˆã€æˆ–ã€Œå±±é™½å±±é™°ã€Passï¼Œå¦å‰‡**ä¸€èˆ¬ä¹å· Pass å‡ç„¡æ³•æ­ä¹˜**ã€‚è«‹æ”¹æ­ç‰¹æ€¥ Sonic (è‡ªç”±å¸­/æŒ‡å®šå¸­çš†å¯)ã€‚`;
    }

    if (q.match(/è¡Œæ|å¯„æ”¾|LOCKER/)) {
        return `ğŸ“¦ **å¾Œå‹¤è‡ªç™’å»ºè­°**ï¼šåšå¤šç«™åŠå°å€‰ç«™ 1F å‡æœ‰å¤§é‡ç½®ç‰©æ«ƒã€‚è‹¥å¤§å‹æ«ƒæ»¿è¼‰ï¼Œè«‹å°‹æ‰¾ã€ŒSagawa æ€¥ä¾¿ã€äººå·¥å¯„æ”¾æ«ƒæª¯ï¼ˆåšå¤šç«™é€šå¸¸åœ¨ç­‘ç´«å£é™„è¿‘ï¼‰ã€‚`;
    }

    // ğŸŒŸ ç­–ç•¥ 4ï¼šçµ‚æ¥µè‡ªç™’ä¿åº•
    return `ç›®å‰è™•æ–¼é›¢ç·šç‹€æ…‹ï¼Œä¸”æœ¬åœ°å­—å…¸ä¸­æœªç™¼ç¾é—œæ–¼ã€Œ${query}ã€çš„ç‰¹å®šæˆ°è¡“ç­†è¨˜ã€‚å»ºè­°ç¢ºèªè©²åœ°é»æ˜¯å¦å·²æ”¶éŒ„åœ¨ã€Œå‚™é¸åå–®ã€ä¸­ä¸¦æ¨™è¨»é‡é»ï¼Œä»¥ä¾¿é›¢ç·šæ™‚æª¢ç´¢ã€‚`;
}


/** ğŸ’¡ é—œé–‰è¡Œç¨‹é¡§å•ï¼šç‰©ç†æ’¤é›¢è£œä¸ (v8.5)
 * ä¿®æ­£ï¼š
 * 1. å°ç¨±å‹•æ•ˆï¼šä½¿ç”¨ animate-out èˆ‡ slide-out-to-bottom ç¢ºä¿è¦–è¦ºæ’¤é›¢ä¸çªå…€ã€‚
 * 2. ç‰©ç†æ¸…é™¤ï¼šç²¾ç¢ºè¨ˆç®—å»¶æ™‚ (400ms)ï¼Œç¢ºä¿å‹•ç•«æ¼”ç¹¹å®Œç•¢å¾Œæ‰å¾ DOM ç§»é™¤ã€‚
 */
window.closeQAViewer = function() {
    const overlay = document.getElementById('qa-viewer-overlay');
    if (overlay) {
        // 1. èƒŒæ™¯å±¤åŸ·è¡Œæ·¡å‡º
        overlay.classList.add('animate-out', 'fade-out', 'duration-300');
        
        // 2. å…§å®¹é¢æ¿åŸ·è¡Œå‘ä¸‹æ»‘å‡º (é–å®šç¬¬ä¸€å€‹å­å…ƒç´ )
        if (overlay.firstElementChild) {
            overlay.firstElementChild.classList.add(
                'animate-out', 
                'slide-out-to-bottom-full', 
                'duration-500'
            );
        }
        
        // 3. ç‰©ç†ç£å€æ¸…ç†
        setTimeout(() => {
            overlay.remove();
            console.log("ğŸ è¡Œç¨‹é¡§å•è¦–åœ–å·²å®‰å…¨å¸è¼‰ã€‚");
        }, 400);
    }
};



/** çµ±ä¸€çš„é£¯åº—å¡ç‰‡å…ƒä»¶ - é¦–é å±•ç¤ºç‰ˆ (ç„¡åŠŸèƒ½éˆ•) */
function renderLodgingComponent(data, dayId, isAI = false) {
    if (!data || !data.name) return '';

    return `
    <div class="day-boundary-card lodging relative bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 flex flex-col h-full" 
         style="border-left: 6px solid ${isAI ? '#07b6d5' : '#f59e0b'};">
        
        <div class="p-2.5 bg-yellow-50/50 flex justify-between items-center border-b border-yellow-100/50">
            <span class="text-[10px] font-black text-yellow-800 uppercase tracking-widest">
                ${isAI ? 'AI OPTIMIZED STAY' : 'HOTEL STAY'}
            </span>
            <span class="text-xs">ğŸ¨</span>
        </div>

        <div class="p-4 text-left flex flex-col justify-center flex-grow">
            <div class="text-[10px] text-gray-400 font-bold uppercase mb-1 tracking-tight">Accommodation</div>
            <div class="text-sm font-black text-gray-900 leading-tight mb-1 line-clamp-2">${data.name}</div>
            <div class="text-[10px] text-gray-500 font-medium truncate">${data.address || 'Address TBA'}</div>
            
            ${data.phone ? `<div class="text-xs font-bold text-yellow-600 mt-2 tracking-tight">${data.phone}</div>` : ''}
        </div>
    </div>`;
}

/** ğŸ¯ é ‚éƒ¨æ¨™é¡Œæ¸²æŸ“ï¼šæ·±åº¦é˜²ç¦¦ç©©å¥ç‰ˆ (v3.2.0)
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†ç´šç©ºå€¼å®ˆè¡›ï¼šå¾¹åº•è§£æ±º TypeError (reading 'length')ï¼Œç¢ºä¿åˆå§‹åŒ–æœŸé–“ä¸å ±éŒ¯ã€‚
 * 2. å¾¹åº•ç§»é™¤æƒæï¼šæ‹”é™¤æ‰€æœ‰å° executeGlobalContentScan çš„ç•°æ­¥é€£å‹•ï¼Œç¯€çœç³»çµ±è³‡æºã€‚
 * 3. æˆ°æƒ…å®¤ç‡ˆè™Ÿé€£å‹•ï¼šåƒ…ä¿ç•™å¿…è¦çš„ Alert Sidebar æ¸²æŸ“é‚è¼¯ã€‚
 */
function renderDayHeader({ day, trip }) {
    // ğŸ›¡ï¸ éšæ®µ 0ï¼šæ•¸æ“šå®Œæ•´æ€§æ¢é‡ (é˜²æ­¢ trip æˆ– day ç‚º undefined å°è‡´å´©æ½°)
    if (!day) day = { dayNum: 1, city: [], date: '', startTime: '08:00', endTime: '22:00', schedules: [] };
    if (!trip || !trip.days) trip = { id: 'temp_trip', days: [day] };

    // 1. è™•ç†åŸå¸‚é¡¯ç¤ºé‚è¼¯ (é˜²æ­¢ city æ¬„ä½æ ¼å¼ä¸ä¸€è‡´)
    const rawCities = Array.isArray(day.city) ? day.city : (day.city ? [day.city] : []);
    const cityDisplay = rawCities.length > 0 ? ` (${rawCities[0]}${rawCities.length > 1 ? '++' : ''})` : '';
    
    // 2. ç²å–ç•¶å‰æ­£ç¢ºæ•¸æ“šæº (æ”¯æ´å·¥åŠæ¨¡å¼æ²™ç›’èˆ‡æ­£å¼æ’ç¨‹å¿«ç…§)
    const workshopKey = `${trip.id}_day${day.dayNum}`;
    const schedules = (state.planViewMode === 'workshop') ? 
                      (state.shadowItineraries[workshopKey] || []) : 
                      (day.schedules || []);
    
    // 3. ã€æˆ°æƒ…åŒæ­¥ã€‘åƒ…ä¿ç•™ç‡ˆè™Ÿé›·é”ï¼Œä¸åŸ·è¡Œå…¨åŸŸæƒæ
    setTimeout(() => {
        const alertBox = document.getElementById('sidebar-alerts-container');
        if (alertBox && typeof renderDailyAlertSidebar === 'function') {
            // åªæœ‰åœ¨çœŸçš„æœ‰è¡Œç¨‹æ•¸æ“šæ™‚æ‰åŸ·è¡Œè¨ºæ–·é‡ç¹ª
            alertBox.innerHTML = renderDailyAlertSidebar(schedules, day.date);
        }
    }, 0);

    // 4. åµæ¸¬è¡çªç‡ˆè™Ÿ
    const alerts = [];
    schedules.forEach((s, idx) => {
        const prevS = idx > 0 ? schedules[idx-1] : null;
        if (typeof diagnoseTimeConflict === 'function') {
            const d = diagnoseTimeConflict(day.date, s.startTime, s.raw || s, prevS);
            if (d && d.status !== 'ok') alerts.push(d);
        }
    });
    
    const hasDanger = alerts.some(a => a.status === 'danger');
    const hasWarning = alerts.some(a => a.status === 'warning');
    const tripDaysCount = trip.days ? trip.days.length : 1;

    // 5. æ§‹å»ºæ¥µç°¡ç¾å­¸ HTML
    return `
        <div class="flex justify-between items-center mb-6 py-3 border-b border-gray-100 bg-white sticky top-[106px] z-[30] px-1">
            <div class="flex flex-col text-left">
                <div class="flex items-center gap-2">
                    <h2 class="text-xl font-black text-slate-800">Day ${day.dayNum}${cityDisplay}</h2>
                    ${hasDanger ? 
                        '<span class="flex h-2 w-2 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span></span>' : 
                        (hasWarning ? '<span class="w-2 h-2 rounded-full bg-orange-400 shadow-sm"></span>' : '<span class="w-2 h-2 rounded-full bg-emerald-400 opacity-50"></span>')
                    }
                </div>
                <div class="flex items-center gap-2 mt-0.5">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${day.date || ''}</p>
                    <span class="text-[10px] text-slate-300">|</span>
                    <p class="text-[10px] text-slate-400 font-mono">${day.startTime || '08:00'}-${day.endTime || '22:00'}</p>
                </div>
            </div>
            
            <div class="flex items-center gap-1.5">
                <div id="sidebar-alerts-container" class="mr-1"></div>

                <button onclick="window.openQAViewer()" 
                        class="w-9 h-9 flex items-center justify-center bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100 active:scale-90 transition-all border border-amber-100 shadow-sm" 
                        title="è¡Œç¨‹é¡§å•å°è©±">
                    <span class="text-sm">ğŸ’¡</span>
                </button>

                <button onclick="smartImportByDayCity()" 
                        class="w-9 h-9 flex items-center justify-center bg-rose-50 text-rose-600 rounded-xl hover:bg-rose-100 active:scale-90 transition-all border border-rose-100 shadow-sm" 
                        title="åµæ¸¬ä»Šæ—¥åŸå¸‚ä¸¦åŒ¯å…¥">
                    <span class="text-sm">ğŸ’</span>
                </button>

                <button onclick="openAddScheduleModal()" 
                        class="w-9 h-9 flex items-center justify-center bg-slate-50 text-slate-600 rounded-xl border border-slate-200 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                </button>

                <button onclick="openDayEditModal()" 
                        class="w-9 h-9 flex items-center justify-center bg-slate-50 text-slate-600 rounded-xl border border-slate-200 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                ${tripDaysCount > 1 ? `
                <button onclick="confirmDeleteDay(${day.dayNum})" 
                        class="w-9 h-9 flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl active:scale-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>` : ''}
            </div>
        </div>`;
}

/** åŸ·è¡Œä½å®¿åˆªé™¤é‚è¼¯ - å¾¹åº•æ¸…é™¤ç‰ˆ */
function deleteAccommodation(dayKey) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å¤©çš„ä½å®¿è³‡è¨Šå—ï¼Ÿ")) return;

    // è§£æå¤©æ•¸æ•¸å­—
    const parts = dayKey.split('_day');
    const dayNum = parseInt(parts[1]);

    const clearData = (target) => {
        delete target.accommodation; // æ¸…é™¤ AI æ¬„ä½
        target.lodging = {};        // æ¸…ç©ºæ‰‹å‹•æ¬„ä½
        if (target.metadata) delete target.metadata.accommodation;
    };

    if (state.planViewMode === 'workshop') {
        // 1. è—åœ–æ¨¡å¼ï¼šä¿®æ”¹å½±å­ç·©å­˜
        if (state.shadowItineraries && state.shadowItineraries[dayKey]) {
            clearData(state.shadowItineraries[dayKey]);
        }
        // åŒæ­¥å›æ°¸ä¹…è—åœ–
        if (state.currentWorkshopId) {
            const ws = state.workshops.find(w => w.id === state.currentWorkshopId);
            if (ws) ws.data = JSON.parse(JSON.stringify(state.shadowItineraries));
        }
    } else {
        // 2. æ­£å¼æ¨¡å¼ï¼šä¿®æ”¹åŸå§‹è³‡æ–™
        const trip = getCurrentTrip();
        const day = trip?.days.find(d => d.dayNum === dayNum);
        if (day) clearData(day);
    }

    // 3. å„²å­˜ä¸¦åˆ·æ–°
    saveData();
    renderDayContent();
    showMessage("ğŸ¨ ä½å®¿è³‡è¨Šå·²æˆåŠŸç§»é™¤", "info");
}

/** æ¸²æŸ“é ‚éƒ¨å‹•æ…‹é‚Šç•Œå¡ç‰‡ (èˆªç©ºèˆ‡ä½å®¿ä¸¦åˆ—é‚è¼¯ - åŠ å›ºç‰ˆ) */
function renderDynamicCards({ day, trip }) {
    const isFirstDay = day.dayNum === 1;
    const isLastDay = day.dayNum === trip.days.length; // âœ¨ ç²¾æº–åˆ¤æ–·ç›®å‰æ˜¯å¦ç‚ºæœ€å¾Œä¸€å¤©
    const dayId = `${trip.id}_day${day.dayNum}`;

    // 1. èˆªç©ºå¡åˆ¤å®š (åŠ å…¥ isFirst/isLast é›™é‡é–å®š)
    const arrivalCard = (isFirstDay && day.arrivalInfo && day.arrivalInfo.airport) ? renderArrivalCard(day.arrivalInfo) : null;
    
    // ğŸš¨ ä¿®æ­£é»ï¼šè‹¥ä¸æ˜¯æœ€å¾Œä¸€å¤©ï¼Œå³ä¾¿è³‡æ–™è£¡æœ‰æ®˜ç•™ departureInfo ä¹Ÿä¸å‡†æ¸²æŸ“
    const departureCard = (isLastDay && day.departureInfo && day.departureInfo.airport) ? renderDepartureCard(day.departureInfo) : null;
    
    const flightCard = arrivalCard || departureCard;

    // 2. ä½å®¿è³‡æ–™åˆ¤å®š
    const lodgingData = (day.lodging && day.lodging.name) ? day.lodging : null;
    const isAI = false; // æ­¤ç‰ˆä»¥æ‰‹å‹•ç‚ºä¸»

    if (!flightCard && !lodgingData) return "";

    // 3. ä¸¦åˆ—æ’ç‰ˆé‚è¼¯ (ç¶­æŒ 50/50 ä½ˆå±€)
    if (flightCard && lodgingData) {
        return `
            <div class="grid grid-cols-2 gap-2 mb-4 px-1 items-stretch">
                <div class="w-full">${flightCard}</div>
                <div class="w-full">${renderLodgingComponent(lodgingData, dayId, isAI)}</div>
            </div>`;
    } else {
        const singleContent = flightCard || renderLodgingComponent(lodgingData, dayId, isAI);
        return `
            <div class="flex mb-4 px-1">
                <div class="w-1/2 pr-1">
                    ${singleContent}
                </div>
            </div>`;
    }
}

// æŠµé”å¡ç‰‡ (æ©Ÿå ´/æ¸¯å£)
function renderArrivalCard(arrival) {
    return `
        <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 shadow-sm">
            <p class="text-[10px] font-black text-emerald-400 uppercase">âœˆï¸ æŠµé”è³‡è¨Š</p>
            <p class="text-xs font-bold text-emerald-900 truncate">${arrival.airport} (${arrival.terminal || '-'})</p>
            <p class="text-[9px] text-emerald-500">${arrival.time || '--:--'} è½åœ°</p>
        </div>`;
}

// å‡ºç™¼å¡ç‰‡
function renderDepartureCard(departure) {
    return `
        <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 shadow-sm">
            <p class="text-[10px] font-black text-rose-400 uppercase">ğŸš€ å‡ºç™¼è¿”ç¨‹</p>
            <p class="text-xs font-bold text-rose-900 truncate">${departure.airport}</p>
            <p class="text-[9px] text-rose-500">${departure.time || '--:--'} èµ·é£›</p>
        </div>`;
}

/** è¦–è¦ºæ™‚é–“è»¸ï¼šå¤§é­”ç‹é€£å‹•ç‰ˆ (v2.8.8 ç‰©ç†å°ä½å°æ­£ç‰ˆ) 
 * ä¿®æ­£ï¼š
 * 1. [ç‰©ç†ä½”ä½] æè¿°å°å¡ä¸æ¸²æŸ“åœ“åœˆï¼Œä½†ä¿ç•™éš±å½¢éŒ¨é»ï¼Œç¢ºä¿åœ°åœ– Pin é‡ä¸å¤±è¯ã€‚
 * 2. [é€£ç·šè·¨è¶Š] å¯¦é«”æ™¯é»é–“çš„é€£ç·šæœƒè·³éæè¿°å°å¡ï¼Œç¶­æŒå‹•æ…‹è·¯å¾‘é¡è‰²åˆ¤å®šã€‚
 * 3. [è¦–è¦ºç´”æ·¨] ç§»é™¤æè¿°å°å¡ç”¢ç”Ÿçš„å¤šé¤˜é–“è·ï¼Œä¿æŒæ™‚é–“è»¸ç¯€å¥æ„Ÿã€‚
 */
function renderVisualTimeline({ schedules, day }) {
    if (!schedules || schedules.length === 0) return "";

    const items = [];
    let lastPhysicalItem = null; // ç”¨æ–¼è¿½è¹¤ä¸Šä¸€å€‹ã€Œå¯¦é«”æ™¯é»ã€é€²è¡Œé€£ç·šè¨ˆç®—

    for (let i = 0; i < schedules.length; i++) {
        const s = schedules[i];
        
        // ğŸŒŸ åˆ¤å®šæ˜¯å¦ç‚ºã€Œæè¿°å°å¡ã€
        const isDescription = (s.style === 'description');

        if (isDescription) {
            // ç‰©ç†å°é€šï¼šåœ¨ HTML ä¸­ç•™ä¸‹ ID æ¨™è¨˜ä¾›åœ°åœ–å¼•æ“æƒæï¼Œä½†åœ¨æ™‚é–“è»¸ä¸­å®Œå…¨éš±å½¢
            items.push(`<div id="card-${s.id}" data-id="${s.id}" style="display:none !important;"></div>`);
            continue; 
        }

        // ğŸ“¡ åŸ·è¡Œè¨ºæ–·å¤§è…¦ (èˆ‡ä¸Šä¸€å€‹å¯¦é«”æ™¯é»æ¯”å°)
        const diagnosis = typeof diagnoseTimeConflict === 'function' 
            ? diagnoseTimeConflict(day.date, s.startTime, s.raw || s, lastPhysicalItem)
            : { status: 'ok', msg: '' };
            
        const isDanger = diagnosis.status === 'danger';
        const isWarning = diagnosis.status === 'warning';
        const isPassConflict = isDanger && diagnosis.msg.includes('ç¥¨åˆ¸');

        // --- 2. è™•ç†ä¸­é–“é€£ç·š (è·¨è¶Šæè¿°å°å¡) ---
        if (lastPhysicalItem) {
            let lineColor = "bg-gray-200";
            let lineAnimate = "";
            
            if (isPassConflict) {
                lineColor = "bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]";
                lineAnimate = "animate-pulse";
            } else if (isWarning && (diagnosis.msg.includes('è·¨å€') || diagnosis.msg.includes('æ™‚é–“'))) {
                lineColor = "bg-orange-400 shadow-[0_0_5px_rgba(251,146,60,0.6)]";
                lineAnimate = "animate-pulse";
            }
            
            items.push(`
                <div class="flex-grow min-w-[25px] h-[3px] ${lineColor} ${lineAnimate} self-center mx-1" 
                     style="margin-top: 35px; border-radius: 2px;"></div>
            `);
        }

        // --- 3. è™•ç†å¯¦é«”é»ä½æ¸²æŸ“ ---
        const coreName = (s.name || "").replace(/\[.*?\]|\(.*?\)|ï¼ˆ.*?ï¼‰/g, '').trim();
        const type = String(s.style || "").toLowerCase();
        const isTransport = (type === 'transport');
        
        let icon = getSmartIcon(s.name, isTransport ? 'transport' : (s.style || 'play'));
        if (isPassConflict) icon = "ğŸ›‚";
        else if (isDanger) icon = "ğŸš¨";
        else if (isWarning) icon = "âš ï¸";

        let pinClasses = "";
        if (isPassConflict) {
            pinClasses = "border-red-600 text-red-600 bg-red-100 shadow-[0_0_15px_rgba(220,38,38,0.5)] animate-bounce";
        } else if (isDanger) {
            pinClasses = "border-red-500 text-red-500 bg-red-50 animate-pulse";
        } else if (isWarning) {
            pinClasses = "border-yellow-500 text-yellow-600 bg-yellow-50 shadow-md";
        } else {
            pinClasses = isTransport ? "border-gray-800 text-gray-800 bg-white" : "border-gray-300 text-gray-400 bg-white";
        }

        items.push(`
            <div class="flex-shrink-0 flex flex-col items-center group cursor-pointer" 
                 style="width: 105px;" 
                 onclick="const target = document.getElementById('card-${s.id}'); if(target) target.scrollIntoView({behavior: 'smooth', block: 'center'})">
                
                <div class="w-full min-h-[3.2em] flex items-end justify-center mb-2 px-1">
                    <span class="text-[11px] font-black ${isDanger ? 'text-red-600' : 'text-gray-700'} leading-tight text-center truncate">
                        ${coreName}
                    </span>
                </div>

                <div id="card-${s.id}" data-id="${s.id}" class="w-9 h-9 rounded-full border-2 ${pinClasses} flex items-center justify-center relative z-10 group-hover:scale-125 transition-all duration-300">
                    <span class="text-base">${icon}</span>
                    ${isDanger ? '<div class="absolute -top-1 -right-1 w-3.5 h-3.5 bg-red-600 rounded-full border-2 border-white animate-ping"></div>' : ''}
                </div>

                <span class="mt-1 text-[10px] font-black ${isDanger ? 'text-red-500' : 'text-gray-500'} font-mono">${s.startTime}</span>
            </div>
        `);

        lastPhysicalItem = s; // æ›´æ–°æœ€å¾Œå¯¦é«”ç¯€é»ç´€éŒ„
    }

    return `
        <div class="w-full bg-white border border-gray-100 rounded-2xl p-4 mb-6 shadow-sm overflow-hidden">
            <div class="flex flex-col">
                <div class="italic text-gray-400 text-[10px] mb-4 px-2 tracking-[0.2em] uppercase flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                        Strategic Route Monitor
                    </div>
                    ${day ? `<span class="font-mono text-[9px] opacity-60">${day.date}</span>` : ''}
                </div>
                <div class="flex items-center overflow-x-auto pb-4 no-scrollbar">
                    <div class="flex items-start">
                        ${items.join('')}
                    </div>
                </div>
            </div>
        </div>`;
}

/** ğŸ“¡ æˆ°æƒ…å®¤ï¼šå¾®å‹è¨ºæ–·ç‡ˆè™Ÿ (å¾®ç¸®ç‰ˆ) */
function renderDailyAlertSidebar(schedules, currentDate) {
    // A. è¡Œç¨‹ç‚ºç©ºçš„ã€Œç©ºæ…‹é›·é”ã€- ç¸®å°ç‚ºä¸€å€‹éœè¬çš„å‘¼å¸é»
    if (!schedules || schedules.length === 0) {
        return `
            <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-100/50 rounded-full border border-slate-200/50 transition-all">
                <div class="w-1.5 h-1.5 rounded-full bg-slate-300 animate-pulse"></div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Searching Signal</span>
            </div>`;
    }

    const alerts = [];
    schedules.forEach((s, index) => {
        const prevS = index > 0 ? schedules[index - 1] : null;
        const diagnosis = diagnoseTimeConflict(currentDate, s.startTime, s.raw || s, prevS);
        if (diagnosis.status !== 'ok') {
            alerts.push({ status: diagnosis.status, id: s.id });
        }
    });

    // B. è¡Œç¨‹å®Œç¾çš„ã€Œå…¨ç¶ é€šéã€- ç¸®å°ç‚ºä¸€å€‹å„ªé›…çš„ Secure æ¨™ç±¤
    if (alerts.length === 0) {
        return `
            <div class="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 border border-emerald-100 rounded-full shadow-sm animate-in fade-in zoom-in-95">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[9px] font-black text-emerald-600 uppercase tracking-tight">Strategy Secure</span>
            </div>`;
    }

    // C. ç™¼ç¾å•é¡Œæ™‚çš„ã€Œè­¦æˆ’è† å›Šã€- åªé¡¯ç¤º issue æ•¸é‡
    const hasCritical = alerts.some(a => a.status === 'danger');
    const themeColor = hasCritical ? 'red' : 'orange';
    
    return `
        <div onclick="document.getElementById('day-content-itinerary').scrollIntoView({behavior:'smooth'})" 
             class="group flex items-center gap-2 px-3 py-1.5 bg-${themeColor}-50 border border-${themeColor}-200 rounded-full cursor-pointer hover:bg-${themeColor}-100 transition-all shadow-sm active:scale-95 animate-bounce-subtle">
            <div class="w-2 h-2 rounded-full bg-${themeColor}-500 ${hasCritical ? 'animate-ping' : 'animate-pulse'}"></div>
            <span class="text-[9px] font-black text-${themeColor}-600 uppercase tracking-tight">${alerts.length} Tactical Issues</span>
            <i class="fa-solid fa-chevron-right text-[8px] text-${themeColor}-400 group-hover:translate-x-0.5 transition-transform"></i>
        </div>`;
}

/** ğŸ¨ æ™ºæ…§åœ–ç¤ºåµæ¸¬ 2.2 (å¤§ä¸€çµ±ç²¾åº¦å¼·åŒ–ç‰ˆ)
 * å„ªå…ˆç´šï¼š
 * 1. åç¨±å…§å»º Emoji (çµ•å°å°Šé‡ç”¨æˆ¶è¼¸å…¥)
 * 2. é«˜æ¬Šç”¨èªæ„æ””æˆª (è§£æ±ºç—…é™¢å‡ºç¾æ‹‰éºµã€è³¼ç‰©è®Šé è¨­ç­‰åå·®)
 * 3. ç‰©ç†è³‡æ–™åº«é—œéµå­— (Single Source of Truth: icon_store)
 * 4. æˆ°ç•¥å¤§é¡æ¨£å¼ä¿åº•
 */
function getSmartIcon(name, style = 'food') {
    if (!name) return 'ğŸ“';

    const upperName = name.toUpperCase();

    // ğŸŒŸ 1. åµæ¸¬åç¨±ä¸­æ˜¯å¦è‡ªå¸¶ Emoji (å„ªå…ˆæ¬Šæœ€é«˜)
    const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g;
    const foundEmoji = name.match(emojiRegex);
    if (foundEmoji) return foundEmoji[0];

    // ğŸŒŸ 2. [æ ¸å¿ƒä¿®æ­£] é«˜æ¬Šç”¨èªæ„æ””æˆªå™¨ (Strategic Interceptor)
    // è§£æ±ºæ¸¬è©¦æ—¥èªŒä¸­ã€Œç¦å²¡å¤§å­¸ç—…é™¢ã€è¢«èª¤åˆ¤ç‚ºã€Œé£Ÿã€çš„å•é¡Œ
    const semanticRules = [
        { regex: /ç—…é™¢|é†«é™¢|è¨ºæ‰€|é†«|æ•‘æ€¥|CLINIC|HOSPITAL/, icon: 'ğŸ¥' },
        { regex: /æ‹‰éºµ|ä¸€è˜­|æš–æš®|éºµ|RAMEN|UDON/, icon: 'ğŸœ' },
        { regex: /ç‡’è‚‰|é³¥|è‚‰|STEAK|YAKINIKU/, icon: 'ğŸ¥©' },
        { regex: /ç™¾è²¨|é‹æ²³åŸ|MALL|PARCO|LOFT|è¶…å¸‚|SHOPPING/, icon: 'ğŸ›ï¸' },
        { regex: /è—¥å±€|è—¥åº—|è—¥å¦|DRUGSTORE|æ¾æœ¬æ¸…/, icon: 'ğŸ’Š' },
        { regex: /æ–°å¹¹ç·š|JR|ç‰¹æ€¥|TRAIN|RAILWAY/, icon: 'ğŸš†' },
        { regex: /å·´å£«|BUS|è¥¿éµ|åœç•™æ‰€/, icon: 'ğŸšŒ' },
        { regex: /æ©Ÿå ´|ç©ºæ¸¯|AIRPORT|TERMINAL|èˆªç«™/, icon: 'âœˆï¸' },
        { regex: /ç¥ç¤¾|å®®|å¯º|TEMPLE|SHRINE/, icon: 'â›©ï¸' }
    ];

    for (const rule of semanticRules) {
        if (rule.regex.test(upperName)) return rule.icon;
    }

    // ğŸŒŸ 3. ç©¿é€ç‰©ç†å±¤ï¼šæ¯”å°è³‡æ–™åº«å›å¡«çš„åœ–ç¤ºåº« (icon_store)
    const iconsVault = window.TRANSPORT_ICONS || {}; 
    for (const [key, icon] of Object.entries(iconsVault)) {
        if (upperName.includes(key.toUpperCase())) {
            return icon;
        }
    }

    // ğŸŒŸ 4. æˆ°ç•¥å¤§é¡ä¿åº•é‚è¼¯
    const normalizedStyle = String(style || 'food').toLowerCase();
    
    // ç‰¹åˆ¥è™•ç†äº¤é€šé¡åˆ¥
    if (normalizedStyle === 'transport') return 'ğŸšŒ';
    
    const categoryIcons = { 
        'food': 'ğŸ±', 
        'shop': 'ğŸ›ï¸', 
        'shopping': 'ğŸ›ï¸',
        'hotel': 'ğŸ¨', 
        'lodging': 'ğŸ¨',
        'play': 'ğŸ¡',
        'cultural': 'ğŸ›ï¸',
        'nature': 'ğŸŒ³',
        'medical': 'ğŸ¥'
    };
    
    return categoryIcons[normalizedStyle] || 'ğŸ“';
}

/** ğŸš‰ äº¤é€šå°ˆå±¬åœ–ç¤ºåµæ¸¬ (ç‰©ç†å°ä½ç‰ˆ) 
 * ä½œç”¨ï¼šå°ˆé–€é‡å°è·¯ç¶²ä¸­å¿ƒæ¸²æŸ“æ™‚çš„å¿«é€ŸæŒ‡ç´‹è¾¨è­˜
 */
function detectTransportIcon(name) {
    const iconsVault = window.TRANSPORT_ICONS || {};
    const upperName = name.toUpperCase();

    for (const [key, icon] of Object.entries(iconsVault)) {
        if (upperName.includes(key.toUpperCase())) {
            return icon;
        }
    }
    return 'ğŸš©'; // ç‰©ç†æƒææœªæœçš„é è¨­æ——å¹Ÿ
}

/** ğŸ¨ å¼·æ¸²æŸ“å¼•æ“ï¼šæ’ç¨‹å¡ç‰‡ç¸½æ§ (v5.6.0)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [é¢¨æ ¼åˆ†æµ] æ–°å¢ description é¢¨æ ¼åˆ¤å®šï¼Œæ”¯æ´ç´”æ–‡å­—æè¿°èˆ‡æ¨™ç±¤å †ç–Šã€‚
 * 2. [é‚è¼¯é–å®š] ç¢ºä¿æ¯ä¸€å¼µå¡ç‰‡éƒ½å‚³å…¥è¨ºæ–·æŒ‡ç´‹ (diagnosis)ï¼Œç¶­æŒæˆ°æƒ…å®¤è¯å‹•ã€‚
 * 3. [äº¤äº’å„ªåŒ–] çµ±ä¸€èª¿ç”¨æ¸²æŸ“å‡½æ•¸ï¼Œç¢ºä¿æ‰€æœ‰å¡ç‰‡éƒ½ç¹¼æ‰¿ data-id ä»¥ä¾› SortableJS æ‹–ç§»ã€‚
 */
function renderScheduleCards({ schedules, day }) {
    let html = "";
    
    if (!schedules || schedules.length === 0) {
        return `
            <div class="flex flex-col items-center justify-center py-24 opacity-20 italic">
                <span class="text-4xl mb-2">ğŸ“’</span>
                <p class="text-sm font-black tracking-widest uppercase">å°šæœªå®‰æ’è¡Œç¨‹é …ç›®</p>
            </div>`;
    }

    schedules.forEach((s, index) => {
        const prevS = index > 0 ? schedules[index - 1] : null;
        
        // ğŸ“¡ 1. å‘¼å«ç‰©ç†å¤§è…¦åŸ·è¡Œè¨ºæ–· (æè¿°å°å¡é€šå¸¸ status ç‚º ok)
        const diagnosis = typeof diagnoseTimeConflict === 'function' 
            ? diagnoseTimeConflict(day.date, s.startTime, s.raw || s, prevS)
            : { status: 'ok', msg: '' };
        
        // ğŸš€ 2. æ ¸å¿ƒåˆ†æµæ¸²æŸ“å¼•æ“
        const styleMode = String(s.style || "").trim().toLowerCase();

        if (styleMode === 'description') {
            // A. æè¿°å°å¡ (ç´”æ·¨æ¨¡å¼ï¼šåƒ…æ¨™é¡Œã€å‚™è¨»ã€å †ç–Šæ¨™ç±¤)
            if (typeof renderDescriptionCard === 'function') {
                html += renderDescriptionCard(s, diagnosis);
            } else {
                // é™ç´šè™•ç†ï¼šè‹¥å°šæœªå®šç¾©å‰‡ä½¿ç”¨æ™®é€šå¡ç‰‡
                html += renderNormalCard(s, day, diagnosis);
            }
        } else if (styleMode === 'transport' || s.customStyle === 'å·´å£«' || s.customStyle === 'æ–°å¹¹ç·š') {
            // B. äº¤é€šå°å¡ (å«æœ‰æ™‚é–“è»¸ã€æ¥­è€… Iconã€ç«™é»åˆ—è¡¨)
            html += renderTransportCard(s, diagnosis);
        } else {
            // C. æ™®é€šæ™¯é»å¡ç‰‡
            html += renderNormalCard(s, day, diagnosis);
        }
    });

    return html;
}

/** ğŸšŒ äº¤é€šå°å¡ï¼šè§£é–æ‹–ç§»èˆ‡äº¤äº’åˆ†é›¢ç‰ˆ (v5.7.0) 
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [äº¤äº’åˆ†é›¢] ç§»é™¤å¡ç‰‡ä¸»é«” onclickï¼Œå¾¹åº•è§£æ±ºèˆ‡ SortableJS æ‹–ç§»è¡çªçš„å•é¡Œã€‚
 * 2. [å…¥å£é·ç§»] å°‡ AI+ è¨ºæ–·å…¥å£é·ç§»è‡³å·¦å´ Iconï¼Œé»æ“Šå¸¶æœ‰ âœ¨ çš„åœ–ç¤ºå³å¯é–‹å•Ÿã€‚
 * 3. [çµæ§‹é–å®š] å¡ç‰‡æœ€å¤–å±¤ data-id èˆ‡ id å®Œæ•´å°ä½ï¼Œç¢ºä¿æ‹–ç§»æ’åº 100% æº–ç¢ºã€‚
 */
function renderTransportCard(schedule, diagnosis) {
    const endTime24 = calculateEndTime(schedule.startTime, schedule.durationHours);
    
    // ğŸš€ [æ•¸æ“šå°ä½]ï¼šåŸ·è¡Œã€Œåç¨±è„«æ•ã€åŒ¹é…
    const cleanSearchName = schedule.name.replace(/\(.*?\)|ï¼ˆ.*?ï¼‰/g, '').trim();
    const matchedData = typeof matchVaultRoute === 'function' ? matchVaultRoute(cleanSearchName, schedule.notes) : null;

    // ğŸŒŸ [è¦–è¦ºæŒ‡ç´‹è§£æ]
    const rawNotes = String(schedule.notes || "");
    const oMatch = rawNotes.match(/\(\((.*?)\)\)/); 
    const sMatch = rawNotes.match(/\[\[(.*?)\]\]/); 
    
    // æ¥­è€…åç¨±èˆ‡é¡è‰²åˆ¤å®š
    const operatorName = matchedData?.route?.operator_id || schedule.operator_id || oMatch?.[1] || 'General Transport';
    const opConfig = window.TRANSPORT_OPERATOR_CONFIG ? window.TRANSPORT_OPERATOR_CONFIG[operatorName] : null;
    const opColor = matchedData?.route?.meta?.color || schedule.color || opConfig?.color || '#64748b';
    const icon = getSmartIcon(schedule.name, 'transport');

    // ğŸš‰ [ç«™é»åºåˆ—è‡ªç™’]
    let finalStations = (matchedData?.displayStops?.length > 0) 
        ? matchedData.displayStops 
        : (matchedData?.route?.stations || schedule.stations || []);
        
    if (finalStations.length === 0 && sMatch) {
        finalStations = sMatch[1].split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
    }

    // ğŸš¨ [æ ¸å¿ƒè¨ºæ–·]
    const diagnosticHTML = typeof renderDiagnosisUI === 'function' ? renderDiagnosisUI(diagnosis) : '';

    // ğŸ’¡ [è¨»è§£æ³¨å…¥]
    let injectedNotesHTML = '';
    if (matchedData?.activeNotes?.length > 0) {
        injectedNotesHTML = matchedData.activeNotes.map(note => `
            <div class="flex items-start gap-2 mb-2 p-2 bg-amber-50 border-l-2 border-amber-400 rounded-r-lg animate-in fade-in">
                <span class="text-xs">ğŸ“¢</span>
                <p class="text-[11px] font-black text-amber-800 leading-tight">${note}</p>
            </div>`).join('');
    }

    const officialGuide = matchedData?.route?.meta?.guide || null;
    
    // ğŸŒŸ [æ‘ºç–Šå¼•æ“]
    let stationsHTML = '';
    if (finalStations.length > 0) {
        const uniqueId = `st-${schedule.id}`;
        stationsHTML = `
            <div class="transport-details-box w-full mt-4 border-t border-dashed border-gray-100 pt-3">
                <div class="flex items-center justify-between px-2 py-1.5 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors mb-2"
                     onclick="event.stopPropagation(); const list = document.getElementById('${uniqueId}'); list.classList.toggle('hidden'); this.querySelector('.arrow-icon').classList.toggle('rotate-180');">
                    <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest flex items-center gap-1.5">
                        ğŸš‰ æ²¿é€”åœé  ${finalStations.length} ç«™
                    </span>
                    <span class="arrow-icon text-[10px] opacity-30 transition-transform duration-300">â–¼</span>
                </div>
                <div id="${uniqueId}" class="stations-list-container relative pl-1.5 text-left animate-in slide-in-from-top-1 hidden">
                    <div class="nav-line absolute left-[11px] top-2 bottom-2 w-0.5 bg-gray-200/50"></div>
                    ${finalStations.map((s, i) => {
                        const isEnd = (i === 0 || i === finalStations.length - 1);
                        return `
                            <div class="station-item flex items-center mb-3 relative z-10">
                                <div class="station-dot w-2 h-2 rounded-full mr-3 flex-shrink-0" 
                                     style="background-color: ${isEnd ? opColor : '#cbd5e1'}; box-shadow: ${isEnd ? `0 0 0 3px ${hexToRgba(opColor, 0.1)}` : 'none'};"></div>
                                <span class="text-[12px] ${isEnd ? 'font-black text-gray-800' : 'text-gray-500'}">${s}</span>
                            </div>`;
                    }).join('')}
                </div>
            </div>`;
    }

    // ğŸ§¼ [å…§æ–‡è„«æ•]
    const cleanNotes = rawNotes.replace(/\[\[.*\]\]/g, '').replace(/\(\(.*\)\)/g, '').replace(/\{\{.*\}\}/g, '').trim();

    // ç‹€æ…‹é¡è‰²åˆ¤å®š
    const isDanger = diagnosis?.status === 'danger';
    const isWarning = diagnosis?.status === 'warning';
    const borderColor = isDanger ? 'border-red-500' : (isWarning ? 'border-orange-400' : 'border-gray-100');

    return `
        <div class="transport-divider relative group mb-6" id="card-${schedule.id}" data-id="${schedule.id}">
            <div class="transport-icon-wrap" style="position: absolute; left: -2rem; top: 1.5rem; z-index: 20;">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white shadow-md border-2 border-white transition-all cursor-pointer hover:scale-110 active:scale-90" 
                     style="background-color: ${opColor}"
                     >
                    ${icon}
                    <div class="absolute -right-1 -bottom-1 bg-white rounded-full p-0.5 shadow-sm text-[8px] border border-gray-100">âœ¨</div>
                </div>
            </div>

            <div class="transport-card-body text-left bg-white border-2 ${borderColor} rounded-2xl p-4 shadow-sm ml-2 transition-all active:bg-slate-50 cursor-grab active:cursor-grabbing">
                
                <div class="flex justify-between items-start mb-2">
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="text-[11px] text-white bg-slate-700 font-mono font-black px-2 py-0.5 rounded-full shadow-sm">
                            ${schedule.startTime} - ${endTime24}
                        </span>
                        <span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-slate-100 text-slate-600 border border-slate-200">
                            ${state.currency} ${schedule.cost || 0}
                        </span>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation();">
                        <button onclick="editSchedule('${schedule.id}')" class="p-1.5 text-gray-400 hover:text-blue-500">âœï¸</button>
                        <button onclick="confirmDeleteSchedule('${schedule.id}')" class="p-1.5 text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>
                    </div>
                </div>

                <div class="text-sm font-black text-gray-800 mb-1 flex items-center gap-2">
                    ${schedule.name}
                    ${matchedData ? '<span class="text-[9px] text-blue-500 font-black italic animate-pulse">âˆš Vault Matched</span>' : ''}
                </div>
                
                ${diagnosticHTML} 
                ${injectedNotesHTML}

                ${officialGuide ? `
                    <div class="transport-guide-box bg-blue-50 border-l-4 border-blue-400 p-3 my-3 rounded-r-xl shadow-sm">
                        <div class="text-[11px] text-blue-900 font-bold leading-relaxed">${officialGuide}</div>
                    </div>` : ''}

                <div class="text-[12px] text-gray-500 leading-relaxed font-medium mt-1">${cleanNotes.replace(/\n/g, '<br>')}</div>
                
                ${stationsHTML}
                
                <div class="mt-3 text-right">
                    <span class="text-[9px] text-gray-300 font-bold uppercase tracking-widest">
                        ${operatorName}
                    </span>
                </div>
            </div>
        </div>`;
}

/**
 * å°æ­£ç‰ˆï¼šæ¸²æŸ“ä¸€èˆ¬æ’ç¨‹å¡ç‰‡ (v5.6 äº¤äº’å„ªåŒ–ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [äº¤äº’åˆ†é›¢] ç§»é™¤å¤–å±¤ onclickï¼Œç¢ºä¿èˆ‡æ‹–ç§»æ’åº (SortableJS) ä¸ç”¢ç”Ÿå½ˆçª—è¡çªã€‚
 * 2. [æ‹–ç§»é–å®š] å¼·åŒ– id å±¬æ€§èˆ‡ cursor æ¨£å¼ï¼Œç¢ºä¿ç‰©ç†æ‹–æ‹½æ„Ÿã€‚
 * 3. [AI+ å…¥å£] ç¶­æŒåº•éƒ¨ AI PLUS æŒ‰éˆ•ç‚ºå½ˆçª—å…¥å£ï¼Œä¿æŒä¸»é«”ç´”æ·¨ã€‚
 */
function renderNormalCard(schedule, day, diagnosis = null) {
    const isEnhanced = !!schedule.aiPlus;
    const isAI = !!schedule.isAI;
    const endTime24 = calculateEndTime(schedule.startTime, schedule.durationHours);
    
    // --- ã€ğŸŒŸ æˆ°è¡“å°ä½ï¼šå¼·æ¸²æŸ“è¨ºæ–·ã€‘ ---
    const finalDiagnosis = diagnosis || (typeof diagnoseTimeConflict === 'function' 
        ? diagnoseTimeConflict(day.date, schedule.startTime, schedule.raw || schedule)
        : { status: 'ok', msg: '' });
    
    const isDanger = finalDiagnosis.status === 'danger';
    const hasConflict = finalDiagnosis.status !== 'ok';
    
    // æ ¹æ“šè¨ºæ–·ç‹€æ…‹æ±ºå®šä¸»é¡Œè‰²
    const activeColorClass = isDanger ? 'text-red-600' : (isEnhanced ? 'text-[#07b6d5]' : 'theme-text-pink');
    
    // é‚Šæ¡†ç‰©ç†é–å®š
    let activeBorderColor = isEnhanced ? '#07b6d5' : 'var(--color-border-light-mixed)';
    if (isDanger) activeBorderColor = '#ef4444'; 
    else if (hasConflict) activeBorderColor = '#f59e0b'; 

    // æ§‹é€ æ¨™ç±¤ HTML
    let aiTagHTML = '';
    if (isEnhanced) {
        aiTagHTML = `<span class="ai-plus-tag-shiny">AI+</span>`;
    } else if (isAI) {
        aiTagHTML = `<span class="ai-tag ai-tag-base">AI</span>`;
    }

    // ğŸš€ [æ ¸å¿ƒè¨ºæ–·]
    const diagnosisHTML = typeof renderDiagnosisUI === 'function' 
        ? renderDiagnosisUI(finalDiagnosis) 
        : '';

    // èƒŒæ™¯è™•ç†
    const cardBgClass = isDanger ? 'bg-red-50/50' : (hasConflict ? 'bg-amber-50/30' : 'bg-white');

    return `
        <div id="card-${schedule.id}" data-id="${schedule.id}" 
             class="mb-4 scroll-mt-32 group relative" 
             style="touch-action: none; -webkit-user-select: none; user-select: none;">
            
            <div class="schedule-card-themed shadow-sm ${cardBgClass} p-4 rounded-xl border-l-4 transition-all hover:shadow-md cursor-grab active:cursor-grabbing" 
                 style="border-left-color: ${activeBorderColor}">
                
                <div class="flex space-x-3 w-full text-left">
                    <div class="flex flex-col space-y-1 min-w-[65px]">
                        <div class="mb-1">${aiTagHTML}</div>
                        <p class="text-xl font-black ${activeColorClass}">${schedule.startTime}</p>
                        <p class="text-[11px] text-gray-400 font-bold uppercase tracking-tighter">${formatDuration(schedule.durationHours)}</p>
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-black text-gray-800 mb-1 truncate ${isDanger ? 'text-red-700' : 'text-lg'}">
                                ${schedule.name}
                            </h4>
                            
                            <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation();">
                                <button onclick="openTransferModal('${schedule.id}')" class="p-1.5 text-gray-400 hover:text-blue-500 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                <button onclick="editSchedule('${schedule.id}')" class="p-1.5 text-gray-400 hover:text-blue-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg>
                                </button>
                                <button onclick="confirmDeleteSchedule('${schedule.id}')" class="p-1.5 text-gray-400 hover:text-red-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center text-sm ${activeColorClass} mb-2">
                            <svg class="h-4 w-4 mr-1 fill-current" viewBox="0 0 20 20"><path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9z"/></svg>
                            <a href="${getSmartMapLink(schedule, day)}" target="_blank" onclick="event.stopPropagation();" class="truncate font-black hover:underline tracking-tight">
                                ${schedule.address || schedule.name}
                            </a>
                        </div>

                        ${diagnosisHTML}

                        ${schedule.notes ? `<div class="schedule-note text-[13px] text-gray-600 mt-2 leading-relaxed border-l-2 pl-3">${schedule.notes}</div>` : ''}
                        
                        ${schedule.aiStory ? `
                            <div class="schedule-story-frame animate-in fade-in slide-in-from-top-1 bg-gray-50 border-l-4 border-slate-300 p-3 rounded-r-lg mt-3">
                                <div class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-[0.1em] flex items-center">
                                    <span class="mr-1">ğŸ“œ</span> Narrative Insight
                                </div>
                                <div class="text-xs leading-relaxed text-slate-600 italic">
                                    ${schedule.aiStory}
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex space-x-4 mt-4 text-[11px] ${activeColorClass} font-black uppercase tracking-tighter" onclick="event.stopPropagation();">
                            <span class="flex items-center">ğŸ End: ${endTime24}</span>
                            <button onclick="generateStory('${schedule.id}')" class="hover:opacity-60 transition-opacity flex items-center gap-1">
                                <span>ğŸ“„</span> Story
                            </button>
                            <button onclick="openAIPerScheduleModal('${schedule.id}')" class="flex items-center gap-1 hover:scale-105 active:scale-95 transition-all">
                                <span>âœ¨</span> AI PLUS
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
}


/** ç§»æ¤æ’ç¨‹è‡³æŒ‡å®šè—åœ– (ä¿®å¾©åŠŸèƒ½éµå¤±æ•ˆç‰ˆ) */
function openTransferModal(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    const workshopKey = `${trip.id}_day${day.dayNum}`;
    
    // 1. å–å¾—ä¾†æºæ•¸æ“š
    const currentSchedules = (state.planViewMode === 'workshop') 
        ? (state.shadowItineraries[workshopKey] || []) 
        : (day.schedules || []);
        
    const item = currentSchedules.find(s => s.id === scheduleId);
    if (!item) {
        showMessage('æ‰¾ä¸åˆ°è©²æ’ç¨‹é …ç›®', 'error');
        return;
    }

    // 2. å»ºç«‹é¸å–®
    const options = state.workshops
        .map((ws, idx) => `${idx + 1}. ${ws.name} ${ws.id === state.currentWorkshopId ? '(ç›®å‰è—åœ–)' : ''}`)
        .join('\n');
    
    const choice = prompt(`è¦æŠŠã€Œ${item.name}ã€ç§»æ¤åˆ°å“ªå€‹è—åœ–ï¼Ÿ\n\n${options}\n\n(è«‹è¼¸å…¥ç·¨è™Ÿ)`);
    if (!choice) return;

    const selectedWs = state.workshops[parseInt(choice) - 1];

    if (selectedWs) {
        // 3. æ·±æ‹·è²ä¸¦è³¦äºˆå…¨æ–°çš„ UUID (é€™æ˜¯é˜²æ­¢ç·¨è¼¯å¤±æ•—çš„é—œéµ)
        const newItem = JSON.parse(JSON.stringify(item));
        newItem.id = generateUUID(); 

        // 4. å¯«å…¥ç›®æ¨™è—åœ–çš„æ°¸ä¹…å­˜å„²å€
        if (!selectedWs.data[workshopKey]) selectedWs.data[workshopKey] = [];
        selectedWs.data[workshopKey].push(newItem);
        
        // 5. âœ¨ é‡é»ä¿®å¾©ï¼šå¦‚æœç›®æ¨™æ˜¯ã€Œç•¶å‰æ­£åœ¨çœ‹ã€çš„è—åœ–ï¼ŒåŒæ­¥æ›´æ–°åŸ·è¡Œç·©å­˜
        if (selectedWs.id === state.currentWorkshopId) {
            if (!state.shadowItineraries[workshopKey]) state.shadowItineraries[workshopKey] = [];
            state.shadowItineraries[workshopKey].push(newItem);
            
            // ç«‹å³é‡ç®—æ™‚é–“ä¸¦åˆ·å±ï¼Œè®“æ–°ç”Ÿæˆçš„ ID ç¶å®šåˆ° DOM ä¸Š
            recalculateScheduleTimes({ schedules: state.shadowItineraries[workshopKey], startTime: day.startTime });
            renderDayContent(); 
        }

        saveData();
        showMessage(`âœ… å·²æˆåŠŸè¤‡è£½ã€Œ${item.name}ã€è‡³è—åœ–ï¼š${selectedWs.name}`, 'success');
    }
}


/**
 * çµ‚æ¥µæ•´åˆç‰ˆï¼šAI PLUS æ·±åº¦æ”»ç•¥èˆ‡äº¤é€šå°èˆª (v1.5.2 - 2026 ç©©å®šé˜²è­·ç‰ˆ)
 * ä¿®æ­£ï¼šè§£æ±º aiContentCache æœªå®šç¾©ã€å‡ç´š Gemini 2.0ã€åŠ å…¥ 429 æµé‡é‡è©¦æ©Ÿåˆ¶
 */
async function generateSingleAIPlus(scheduleId, retryCount = 0) {
    // âœ¨ ä¿®æ­£ï¼šç¢ºä¿ aiContentCache å­˜åœ¨ï¼Œé˜²æ­¢ ReferenceError
    if (typeof aiContentCache === 'undefined') {
        window.aiContentCache = JSON.parse(localStorage.getItem('my_trip_ai_cache') || '{}');
    }

    const bodyEl = document.getElementById('aiplus-modal-body');
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!trip || !day || !bodyEl) return;

    const workshopKey = `${trip.id}_day${day.dayNum}`;
    if (!state.theme.geminiKey) {
        showMessage('è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ API Key', 'error');
        return;
    }

    // 1. æ•¸æ“šåˆ†æµå°‹æ‰¾
    let schedule;
    if (state.planViewMode === 'workshop') {
        schedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        schedule = (day.schedules || []).find(s => s.id === scheduleId);
    }
    if (!schedule) return;

    const isTransport = String(schedule.style).toLowerCase() === 'transport';

    // ğŸ›¡ï¸ æ­¥é©Ÿ Aï¼šçœéŒ¢å¿«å–æ””æˆª
    const cacheType = isTransport ? 'route' : 'story';
    const cacheKey = `ai_${cacheType}_${schedule.name}`.trim();

    if (aiContentCache[cacheKey]) {
        console.log("â™»ï¸ å‘½ä¸­å¿«å–ï¼Œçœä¸‹ä¸€ç­†è²»ç”¨");
        schedule.aiPlus = aiContentCache[cacheKey];
        schedule.isAI = true;
        renderAIPlusResultUI(bodyEl, schedule, isTransport);
        syncAndSaveData(); 
        return;
    }

    // 2. é¡¯ç¤ºè—è¡“åŒ–è¼‰å…¥å‹•ç•« (è‹¥ç‚ºé‡è©¦å‰‡æ›´æ–°æ–‡å­—)
    bodyEl.innerHTML = `
        <div class="py-12 text-center">
            <div class="ai-loader-box mx-auto mb-6">
                <div class="refined-plane text-4xl">âœˆï¸</div>
            </div>
            <h4 class="text-xl shimmer-text">
                ${retryCount > 0 ? `æµé‡èª¿ç¯€ä¸­ï¼Œç¬¬ ${retryCount} æ¬¡é‡è©¦...` : `AI+ æ­£åœ¨${isTransport ? 'ç²¾ç®—äº¤é€šè·¯å¾‘' : 'æŒ–æ˜æ™¯é»æ•…äº‹'}...`}
            </h4>
            <p class="text-xs text-gray-400 mt-2">æ­£åœ¨ç‚ºæ‚¨ç¯€çœæ¼«éŠæ™‚é–“</p>
        </div>`;

    try {
        const apiKey = state.theme.geminiKey;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        // ğŸ›¡ï¸ æ­¥é©Ÿ Bï¼šæœ€å¼·ç³»çµ± Prompt çµ„è£
        let systemPrompt = "";
        if (isTransport) {
            systemPrompt = `ä½ ç¾åœ¨æ˜¯ã€ŒAI+ äº¤é€šå°èˆªå°ˆå®¶ã€ã€‚é‡å°é€™æ®µäº¤é€šï¼šã€Œ${schedule.name}ã€ï¼Œè«‹æ’°å¯«æ·±åº¦äº¤é€šæ”»ç•¥ã€‚
            ### ğŸš¨ å…§å®¹è¦æ±‚ï¼š
            1. èªªæ˜å¦‚ä½•æ‰¾åˆ°æœˆå°ã€ç¥¨åƒ¹ã€ä»¥åŠè½‰ä¹˜æœ€çœåŠ›çš„å‡ºå£ã€‚
            2. è‹¥ç‚ºæ—¥æœ¬æ–°å¹¹ç·šå¤§ç«™ï¼ˆå¦‚åšå¤šã€æ±äº¬ï¼‰ï¼Œå¿…é ˆè§£é‡‹ä¸åŒå…¬å¸ï¼ˆJRè¥¿æ—¥æœ¬/JRä¹å·ï¼‰çš„é€²ç«™å·®ç•°ã€‚
            3. åŒ…å«ï¼šã€ä¹˜è»Šæ”»ç•¥ã€‘ã€ã€ç¥¨å‹™å»ºè­°ã€‘ã€ã€è½‰ä¹˜/å‡ºç«™æé†’ã€‘ã€‚
            è«‹ç¢ºä¿è¼¸å‡ºç‚ºç´” JSONï¼Œæ ¼å¼ï¼š{"aiPlus": "å…§å®¹æ–‡å­—..."}`;
        } else {
            systemPrompt = `ä½ ç¾åœ¨æ˜¯ã€ŒAI+ å°ˆæ¥­å°éŠã€ã€‚é‡å°æ™¯é»ï¼šã€Œ${schedule.name}ã€ï¼Œè«‹æ’°å¯«æ·±åº¦æ”»ç•¥ã€‚
            ### ğŸš¨ å…§å®¹è¦æ±‚ï¼š
            1. ç¬¬ä¸€æ®µå¿…é ˆä»¥ã€Œã€å°è¦½è³‡è¨Šã€‘ã€ç‚ºæ¨™é¡Œã€‚
            2. åŒ…å«ã€æ·±åº¦æ­·å²ã€‘ã€ã€éš±è—æ‹ç…§é»ã€‘ã€ã€å¯¦ç”¨æé†’ã€‘ã€‚
            3. æåˆ°ç•¶åœ°ç‰¹ç”¢æ™‚ï¼Œè«‹å‹™å¿…ä½¿ç”¨ [[å•†åº—ï¼šå•†å“å | é ä¼°åƒ¹æ ¼]] æ ¼å¼ä»¥è§¸ç™¼ç³»çµ±æ¨™ç±¤ã€‚
            è«‹ç¢ºä¿è¼¸å‡ºç‚ºç´” JSONï¼Œæ ¼å¼ï¼š{"aiPlus": "å…§å®¹æ–‡å­—..."}`;
        }

        // 3. ç™¼é€è«‹æ±‚
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: systemPrompt }] }],
                generationConfig: { 
                    responseMimeType: "application/json",
                    temperature: 1.0 
                }
            })
        });

        // âœ¨ 429 æµé‡é™åˆ¶è™•ç†ï¼šæŒ‡æ•¸é€€é¿é‡è©¦
        if (response.status === 429 && retryCount < 3) {
            const waitTime = Math.pow(2, retryCount) * 2000; // åˆ†åˆ¥ç­‰å¾… 2s, 4s, 8s
            console.warn(`âš ï¸ è§¸ç™¼ API æµé‡é™åˆ¶ï¼Œ${waitTime/1000}ç§’å¾Œé€²è¡Œç¬¬ ${retryCount+1} æ¬¡é‡è©¦`);
            setTimeout(() => generateSingleAIPlus(scheduleId, retryCount + 1), waitTime);
            return;
        }

        if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);

        const result = await response.json();
        const rawText = result.candidates[0].content.parts[0].text;
        const data = JSON.parse(rawText);

        if (data.aiPlus) {
            // 4. å¯«å…¥å¿«å–èˆ‡æ•¸æ“š
            schedule.aiPlus = data.aiPlus;
            schedule.isAI = true;
            aiContentCache[cacheKey] = data.aiPlus;
            localStorage.setItem('my_trip_ai_cache', JSON.stringify(aiContentCache));

            syncAndSaveData();
            renderAIPlusResultUI(bodyEl, schedule, isTransport);
            showMessage('âœ¨ AI å¼·åŒ–å…§å®¹å·²å°±ç·’', 'success');
        }
    } catch (e) {
        console.error("AI+ éŒ¯èª¤:", e);
        showMessage('ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key', 'error');
        bodyEl.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•å›æ‡‰ (${e.message})ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
    } finally {
        // å¦‚æœä¸æ˜¯å› ç‚º 429 é€²å…¥å»¶é²é‡è©¦ï¼Œå‰‡é—œé–‰å…¨å±€ loading æ¨™ç±¤
        const loader = document.getElementById('ai-loading-modal');
        if (loader) loader.classList.add('hidden');
    }
}

/** æ•¸æ“šåŒæ­¥èˆ‡æŒä¹…åŒ– */
function syncAndSaveData() {
    // å¦‚æœç›®å‰åœ¨è¦åŠƒå·¥åŠæ¨¡å¼ï¼Œå°‡å½±å­æ•¸æ“šåŒæ­¥å› workshops é™£åˆ—
    if (state.planViewMode === 'workshop' && state.currentWorkshopId) {
        const ws = state.workshops.find(w => w.id === state.currentWorkshopId);
        if (ws) {
            ws.data = JSON.parse(JSON.stringify(state.shadowItineraries));
        }
    }
    
    // åŸ·è¡Œå…¨åŸŸå„²å­˜èˆ‡ç•«é¢é‡ç¹ª
    saveData();
    renderDayContent();
}

/** æ¸²æŸ“ AI+ å…§å®¹è‡³æ¨¡æ…‹æ¡† */
function renderAIPlusResultUI(bodyEl, schedule, isTransport) {
    if (!bodyEl) return;
    
    const tagTitle = isTransport ? 'âœ¨ AI+ Route äº¤é€šå°èˆª' : 'âœ¨ AI+ æ·±åº¦æ”»ç•¥';
    const tagClass = isTransport ? 'bg-blue-600' : 'ai-plus-tag-shiny'; // äº¤é€šé¡ç”¨è—è‰²ï¼Œæ™¯é»é¡ç”¨é–ƒäº®éŠ€
    
    bodyEl.innerHTML = `
        <div class="space-y-4 animate-in fade-in slide-in-from-bottom-2">
            <div class="flex items-center space-x-2">
                <span class="${tagClass} px-3 py-1 rounded-full text-white text-[10px] font-black uppercase tracking-widest shadow-sm">
                    ${tagTitle}
                </span>
            </div>
            <div class="text-gray-700 leading-relaxed text-base border-l-4 border-gray-100 pl-4 py-1 italic">
                ${parseAIPlusInteractiveContent(schedule.aiPlus.replace(/\n/g, '<br>'))}
            </div>
        </div>`;
}

// --- è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“å…¥å¢ƒå¡ç‰‡ (æ”¾å¤§å­—é«”ç‰ˆ) ---
// èˆªç©ºå¡æ‰å¹³åŒ–ä¿®æ­£ (Arrival)
function renderArrivalCard(info) {
    return `
    <div class="boarding-pass flex flex-col h-full bg-white shadow-md rounded-xl overflow-hidden border border-gray-100">
        <div class="p-1.5 flex justify-between items-center border-b" 
             style="background-color: var(--color-bg-light-mixed); border-color: var(--color-border-light-mixed);">
            <span class="text-[9px] font-black uppercase tracking-wider" style="color: var(--color-primary);">Boarding Pass</span>
            <span class="text-[10px] font-mono font-bold" style="color: var(--color-primary);">${info.flight || 'TBA'}</span>
        </div>
        <div class="py-2 px-3 flex justify-between items-center flex-grow">
            <div class="text-left">
                <div class="text-[9px] text-gray-400 font-bold uppercase leading-none">Dep</div>
                <div class="text-xs font-black text-gray-900 leading-tight">${info.departureAirport || '---'}</div>
                <div class="text-[10px] font-bold" style="color: var(--color-primary);">${info.departureTime || '--:--'}</div>
            </div>
            <div class="flex-1 flex items-center justify-center px-2 relative">
                <div class="w-full border-t border-dashed border-gray-200"></div>
                <span class="absolute text-xs">âœˆï¸</span>
            </div>
            <div class="text-right">
                <div class="text-[9px] text-gray-400 font-bold uppercase leading-none">Arr</div>
                <div class="text-xs font-black text-gray-900 leading-tight">${info.airport || '---'}</div>
                <div class="text-[10px] font-bold" style="color: var(--color-primary);">${info.time || '--:--'}</div>
            </div>
        </div>
    </div>`;
}

// é›¢å¢ƒå¡æ‰å¹³åŒ–ä¿®æ­£ (Departure)
function renderDepartureCard(info) {
    return `
    <div class="boarding-pass flex flex-col h-full bg-white shadow-md rounded-xl overflow-hidden border border-gray-100"
         style="border-left: 5px solid var(--color-primary);">
        
        <div class="p-1.5 flex justify-between items-center border-b"
             style="background-color: var(--color-bg-light-mixed); border-color: var(--color-border-light-mixed);">
            <span class="text-[9px] font-black uppercase tracking-wider" style="color: var(--color-primary);">Boarding Pass</span>
            <span class="text-[10px] font-mono font-bold" style="color: var(--color-primary);">${info.flight || 'TBA'}</span>
        </div>

        <div class="py-2 px-3 flex justify-between items-center flex-grow">
            <div class="text-left">
                <div class="text-[9px] text-gray-400 font-bold uppercase leading-none">Dep</div>
                <div class="text-xs font-black text-gray-900 leading-tight">${info.airport || '---'}</div>
                <div class="text-[10px] font-bold" style="color: var(--color-primary);">${info.time || '--:--'}</div>
            </div>

            <div class="flex-1 flex items-center justify-center px-2 relative">
                <div class="w-full border-t-2 border-dashed border-gray-200"></div>
                <span class="absolute text-xs" style="transform: rotate(45deg);">âœˆï¸</span>
            </div>

            <div class="text-right">
                <div class="text-[9px] text-gray-400 font-bold uppercase leading-none">Arr</div>
                <div class="text-xs font-black text-gray-900 leading-tight">${info.arrivalAirport || '---'}</div>
                <div class="text-[10px] font-bold" style="color: var(--color-primary);">${info.arrivalTime || '--:--'}</div>
            </div>
        </div>
    </div>`;
}


/** çµ‚æ¥µä¿®å¾©ï¼šæ¸²æŸ“è—åœ–æ–¹æ¡ˆæ»‘è»Œ (çµ•ä¸è·³å›å·¦å´ç‰ˆ) */
function renderWorkshopSlider() {
    const container = document.getElementById('workshop-version-slider');
    if (!container) return;

    // 1. æª¢æŸ¥å…§éƒ¨å®¹å™¨æ˜¯å¦å·²å­˜åœ¨
    let sliderInner = document.getElementById('ws-slider-inner');

    // 2. å¦‚æœæ»‘è»Œé‚„æ²’ç•«éï¼Œæˆ–è€…æ–¹æ¡ˆæ•¸é‡è®Šäº†ï¼Œæ‰é€²è¡Œå®Œæ•´é‡ç•«
    if (!sliderInner || sliderInner.children.length !== (state.workshops.length + 1)) {
        container.innerHTML = `
            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar py-2 mt-1 border-t border-gray-50 scroll-smooth" id="ws-slider-inner">
                <button onclick="createNewWorkshop()" class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-600 rounded-full border border-blue-200">ï¼‹</button>
                ${state.workshops.map(ws => `
                    <div class="relative flex-shrink-0 group/ws">
                        <button id="ws-btn-${ws.id}" onclick="switchWorkshop('${ws.id}')" 
                                class="ws-tab-btn px-4 py-1.5 rounded-full text-[10px] font-black whitespace-nowrap transition-all border">
                            ${ws.name}
                        </button>
                        <div class="absolute -top-2 -right-1 hidden group-hover/ws:flex gap-1">
                            <button onclick="event.stopPropagation(); renameWorkshop('${ws.id}')" class="w-4 h-4 bg-gray-800 text-white rounded-full flex items-center justify-center text-[8px]">âœï¸</button>
                            <button onclick="event.stopPropagation(); deleteWorkshop('${ws.id}')" class="w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center text-[8px]">Ã—</button>
                        </div>
                    </div>`).join('')}
            </div>`;
    }

    // 3. âœ¨ é—œéµï¼šä¸è«–æœ‰ç„¡é‡ç•«ï¼Œéƒ½åªé€é CSS class æ›´æ–°ã€Œé¸ä¸­ç‹€æ…‹ã€
    // é€™éƒ¨åˆ†çµ•å°ä¸æœƒå½±éŸ¿æ²å‹•ä½ç½®
    state.workshops.forEach(ws => {
        const btn = document.getElementById(`ws-btn-${ws.id}`);
        if (!btn) return;
        
        const isActive = state.currentWorkshopId === ws.id;
        if (isActive) {
            btn.className = "ws-tab-btn px-4 py-1.5 rounded-full text-[10px] font-black whitespace-nowrap transition-all border bg-blue-600 text-white border-transparent shadow-md ring-2 ring-blue-100";
            btn.innerHTML = `${ws.name} â—`;
        } else {
            btn.className = "ws-tab-btn px-4 py-1.5 rounded-full text-[10px] font-black whitespace-nowrap transition-all border bg-white text-gray-400 border-gray-200 hover:border-blue-300";
            btn.innerHTML = ws.name;
        }
    });
}

function renderShoppingView() {
    const el = document.getElementById('shopping-view');
    if (!el) return;
    el.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg w-full">
            <h3 class="text-xl font-bold mb-4 theme-text-pink">ğŸ›’ è³¼ç‰©æ¸…å–®</h3>
            <div class="mb-6 border border-gray-200 p-4 rounded-lg bg-gray-50">
                <button class="w-full px-4 py-2 theme-pink text-white rounded-lg font-bold" onclick="openAIShoppingModal()">ğŸ¤– å•Ÿå‹• AI æ¨è–¦</button>
                <div id="ai-shopping-result" class="mt-3 text-sm text-gray-700"></div>
            </div>
            <div id="shopping-list-container" class="space-y-2 max-h-[400px] overflow-y-auto pr-2"></div>
            <div class="mt-4 border-t pt-3 space-y-2">
                <h4 class="font-semibold text-gray-700">æ–°å¢è³¼ç‰©é …ç›®</h4>
                <input type="text" id="new-shopping-name" class="w-full p-2 border rounded" placeholder="å“å">
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="new-shopping-price" placeholder="å–®åƒ¹" class="p-2 border rounded">
                    <input type="number" id="new-shopping-quantity" value="1" class="p-2 border rounded">
                </div>
                <button class="w-full px-4 py-2 theme-pink text-white rounded-lg" onclick="addNewShoppingItem()">+ æ–°å¢</button>
            </div>
        </div>`;
    renderShoppingList();
}


/** ğŸ”„ è©³æƒ…é ç¸½æ§æ¸²æŸ“ v9.1 (è·äººå¤§ä¸€çµ±ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. è·äººè‡ªç™’æ©Ÿåˆ¶ï¼šåˆ‡æ›å›æ­£å¼è¡Œç¨‹æ™‚ï¼Œè‡ªå‹•å°é€š Q&A å€å¡Šå…§å®¹é è¼‰ï¼Œç¢ºä¿æƒæå‡½æ•¸ç‰©ç†å°±ç·’ã€‚
 * 2. è¦–è¦ºé¡¯å½±è£œå¼·ï¼šæ­£å¼è¡Œç¨‹å°è¦½æ–‡å­—é–å®š text-slate-800ï¼Œæå‡æ·ºè‰²èƒŒæ™¯ä¸‹çš„é–±è®€æ¬Šé‡ã€‚
 * 3. éè¿´æ·±åº¦é˜²ç¦¦ï¼šç§»é™¤ä»»ä½•å¯èƒ½è§¸ç™¼ switchView çš„å¾ªç’°å‘¼å«ï¼Œæ”¹ç”¨ç‰©ç† hidden åˆ‡æ›ã€‚
 */
function renderTripDetail() {
    // 1. åº§æ¨™æå–èˆ‡å®‰å…¨é–
    const trip = typeof getCurrentTrip === 'function' 
        ? getCurrentTrip() 
        : window.state?.trips?.find(t => t.id === window.state.currentTripId);

    if (!trip) {
        console.error("âŒ ç„¡æ³•ç²å–è¡Œç¨‹å¯¦é«”ï¼ŒåŸ·è¡Œæ¸…å–®é é€€ç‰ˆç¨‹åº");
        return typeof switchView === 'function' ? switchView('list') : null;
    }

    // 2. ä½ˆå±€æª¢æŸ¥ï¼šç¢ºä¿ä¸»æ¡†æ¶å®¹å™¨å­˜åœ¨
    if (!document.getElementById('mode-frozen-bar')) {
        if (typeof setupTripLayout === 'function') setupTripLayout();
    }

    // 3. åŸºç¤æ¨™é¡ŒåŒæ­¥
    const titleEl = document.getElementById('header-title');
    if (titleEl) titleEl.textContent = trip.name;
    
    // 4. UI å…ƒä»¶å¼•ç”¨é–å®š
    const indicator = document.getElementById('mode-status-indicator');
    const wsActions = document.getElementById('workshop-actions');
    const sliderContainer = document.getElementById('workshop-version-slider');
    const toolsWrap = document.getElementById('workshop-tools-wrap');
    const navText = document.getElementById('itinerary-btn-text');

    // 5. æ¨¡å¼åˆ†æµè™•ç†ï¼šå·¥åŠ (Workshop) vs æ­£å¼ (Itinerary)
    if (window.state.planViewMode === 'workshop') {
        // --- ğŸ› ï¸ è¦åŠƒå·¥åŠæ¨¡å¼ UI ---
        if (navText) {
            navText.textContent = 'è¦åŠƒå·¥åŠ';
            navText.className = 'text-blue-600 font-black tracking-tighter';
        }
        if (toolsWrap) toolsWrap.style.display = 'flex';

        if (indicator) {
            indicator.innerHTML = `
                <span class="px-3 py-1 bg-blue-600 text-white rounded-full text-[10px] font-black breath-workshop shadow-md flex items-center gap-1.5 whitespace-nowrap inline-flex">
                    <span class="dot-indicator"></span>
                    å·¥åŠæ¨¡å¼ç·¨è¼¯ä¸­
                </span>`;
        }

        if (wsActions) {
            wsActions.innerHTML = `<button onclick="createNewWorkshop()" class="w-7 h-7 flex-shrink-0 flex items-center justify-center bg-blue-600 text-white rounded-full shadow-md text-xl font-bold hover:rotate-90 transition-all">+</button>`;
        }
        
        if (typeof renderWorkshopSlider === 'function') renderWorkshopSlider(); 

    } else {
        // --- ğŸ“Œ æ­£å¼è¡Œç¨‹æ¨¡å¼ UI (é è¨­) ---
        if (navText) {
            navText.textContent = 'æ­£å¼è¡Œç¨‹';
            navText.className = 'text-slate-800 font-black tracking-tighter'; // è·äººé»‘é¡¯å½±
        }
        
        if (toolsWrap) toolsWrap.style.display = 'none'; 

        if (indicator) {
            indicator.innerHTML = `
                <span class="px-3 py-1 bg-pink-500 text-white rounded-full text-[10px] font-black breath-master shadow-md flex items-center gap-1.5 whitespace-nowrap inline-flex">
                    <span class="dot-indicator"></span>
                    æ­£å¼æ’ç¨‹é–±è®€ä¸­
                </span>`;
        }

        // ç‰©ç†æ¸…ç†å·¥åŠæ®˜ç•™
        if (wsActions) wsActions.innerHTML = '';
        if (sliderContainer) sliderContainer.innerHTML = '';

        // ğŸŒŸ è·äººå»ºè­°è‡ªç™’ï¼šè‡ªå‹•åŸ·è¡Œå…¨åŸŸæƒæï¼Œç¢ºä¿ Q&A å€å¡Šå…§å®¹èˆ‡è¡Œç¨‹åŒæ­¥
        const currentDayNum = window.state.currentDayNum || 1;
        if (typeof window.executeGlobalContentScan === 'function') {
            // ä½¿ç”¨å»¶æ™‚ç¢ºä¿ renderDayContent æ¸²æŸ“å®Œæˆå¾Œæ‰æ›è¼‰å»ºè­°å¡ç‰‡
            setTimeout(() => {
                window.executeGlobalContentScan(currentDayNum);
            }, 150);
        }
    }

    // 6. æ ¸å¿ƒçµ„ä»¶éˆè·¯æ¸²æŸ“
    if (typeof renderDayTabs === 'function') renderDayTabs(trip);
    if (typeof renderDayContent === 'function') renderDayContent();

    // 7. éè¿´é˜²ç¦¦ï¼šç‰©ç†å±¤é¡¯éš±æ§åˆ¶ï¼Œçµ•ä¸å‘¼å« switchSubView é˜²æ­¢æ£§æº¢å‡º
    const iv = document.getElementById('itinerary-view');
    const tc = document.getElementById('day-tabs-container');
    
    if (iv) iv.classList.remove('hidden');
    if (tc) tc.classList.remove('hidden');
    
    console.log(`ğŸ è©³æƒ…é ç‰©ç†å°ä½å®Œæˆ | ç•¶å‰æ¨¡å¼: ${window.state.planViewMode || 'itinerary'}`);
}

/** ğŸš€ 1. å°æ’­ä¸­å¿ƒï¼šè² è²¬è©³æƒ…èˆ‡åˆ—è¡¨çš„å¤§æ›é  */
function switchView(view, tripId = null) {
    state.currentTripId = tripId;
    
    if (view === 'detail') {
        const container = document.getElementById('content-container');
        if (container) container.innerHTML = ''; // ç‰©ç†æ¸…å ´é˜²æ­¢é‡è¤‡å †ç–Š
        
        renderTripDetail(); 
        
        // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šé€²å…¥è©³æƒ…é å¾Œï¼Œå¼·åˆ¶å•Ÿå‹•ã€Œæ’ç¨‹ã€å­è¦–åœ–æ¸²æŸ“
        setTimeout(() => {
            openProtectedSubView('itinerary');
        }, 50);
    } else {
        state.currentTripId = null;
        state.currentDayIndex = 0;
        window.currentDay = null; 
        renderTripList();
    }
    saveData(); 
}

/** ğŸ›¡ï¸ 2. æ¥ç·šå®ˆè¡›ï¼šè² è²¬é¸å–®æŒ‰éˆ•èˆ‡å¼•æ“çš„å°æ¥ */
window.openProtectedSubView = function(viewId) {
    console.log(`ğŸ“¡ å®ˆè¡›æ¥æ”¶æŒ‡ä»¤ï¼šåˆ‡æ›è‡³ [${viewId}]`);
    
    // ç‰©ç†å°ä½ï¼šç›¸å®¹å„ç¨® ID æ ¼å¼
    const targetMode = viewId.replace('-view', ''); 
    
    // å‘¼å«æ¸²æŸ“å¼•æ“
    if (typeof switchSubView === 'function') {
        switchSubView(targetMode);
    }

    // è¦–è§’è£œä¸ï¼šé—œé–‰æ‰‹æ©Ÿç«¯ä¸‹æ‹‰é¸å–®æ®˜ç•™
    document.querySelectorAll('.group-hover\\:block').forEach(el => {
        el.style.display = 'none';
        setTimeout(() => el.style.display = '', 100); 
    });
}

function switchSubView(mode) {
    state.currentSubView = mode;

    // A. ã€å…¨åŸŸæ¸…å ´ã€‘å®šç¾©æ‰€æœ‰å¯èƒ½çš„å­è¦–åœ–
    const views = ['settings', 'itinerary', 'bucket', 'translate', 'expense', 'shopping', 'emergency', 'data', 'checklist'];
    views.forEach(v => {
        const el = document.getElementById(v + '-view');
        if (el) {
            el.classList.add('hidden');
            el.style.setProperty('display', 'none', 'important'); 
            el.style.height = '0';
            el.scrollTop = 0; 
        }
    });

    // B. ã€ç²¾æº–æ¿€æ´»ã€‘å•Ÿå‹•ç›®æ¨™
    const targetView = document.getElementById(mode + '-view');
    if (targetView) {
        targetView.classList.remove('hidden');
        targetView.style.setProperty('display', 'block', 'important'); 
        targetView.style.height = 'auto'; 
    } else {
        console.warn(`âš ï¸ æ‰¾ä¸åˆ°è¦–åœ–å®¹å™¨: ${mode}-view`);
    }

    // C. ã€å¤©æ•¸å°èˆªé€£å‹•ã€‘
    const tabsContainer = document.getElementById('day-tabs-container');
    if (tabsContainer) {
        if (mode === 'itinerary') {
            tabsContainer.classList.remove('hidden');
            tabsContainer.style.setProperty('display', 'flex', 'important');
            if (typeof renderDayTabs === 'function') renderDayTabs();
            if (window.currentDay === null || window.currentDay === undefined) {
                window.currentDay = 0;
            }
        } else {
            tabsContainer.classList.add('hidden');
            tabsContainer.style.setProperty('display', 'none', 'important');
        }
    }

    // D. ã€åŸ·è¡Œæ¸²æŸ“ã€‘æ ¸å¿ƒä¿®æ­£ï¼šç¢ºä¿æ¨¡çµ„ã€Œå¤–æ®¼ã€èˆ‡ã€Œå…§å®¹ã€åŒæ­¥é‡é‘„
    try {
        switch(mode) {
	case 'itinerary':
                // 1. å–å¾—ç•¶å‰è¡Œç¨‹å¯¦é«”
                const trip = typeof getCurrentTrip === 'function' ? getCurrentTrip() : null;
                
                // 2. æ›´æ–°é ‚éƒ¨å°èˆªç‹€æ…‹ (æ­£å¼/å·¥åŠæ¨™ç±¤)
                if (typeof updateItineraryUIState === 'function') updateItineraryUIState();
                
                // 3. ğŸŒŸ é—œéµè£œå¼·ï¼šç‰©ç†é‡é‘„å¤©æ•¸æ¨™ç±¤åˆ— (Day 1 - Day N)
                // å¿…é ˆä¸»å‹•åŸ·è¡Œæ­¤å‡½æ•¸ï¼Œä¸‹æ‹‰é¸å–®åˆ‡æ›å›ä¾†æ™‚æ‰æœƒçœ‹åˆ°å¤©æ•¸æŒ‰éˆ•
                if (trip && typeof renderDayTabs === 'function') {
                    renderDayTabs(trip);
                }
                
                // 4. æ¸²æŸ“ç•¶å‰é¸å®šå¤©æ•¸çš„å…§å®¹å¡ç‰‡
                if (typeof renderDayContent === 'function') renderDayContent(); 
                break;
            case 'checklist':
                if (typeof renderChecklistTab === 'function') renderChecklistTab();
                break;
            case 'expense':
                // ä¿®æ­£ï¼šå…ˆç•«å¤–æ®¼å†ç®—æ•¸æ“š
                if (typeof renderExpenseView === 'function') renderExpenseView();
                if (typeof calculateAndRenderExpenses === 'function') calculateAndRenderExpenses();
                break;
            case 'bucket':
                if (typeof renderBucketView === 'function') renderBucketView(); 
                break;
            case 'shopping': 
                // ğŸŒŸ ä¿®æ­£ï¼šç¢ºä¿å‘¼å«è² è²¬ã€Œæ•´é ä½ˆå±€ã€çš„å‡½æ•¸
                if (typeof renderShoppingView === 'function') renderShoppingView(); 
                else if (typeof renderShoppingList === 'function') renderShoppingList(); 
                break;
            case 'emergency': 
                // ğŸŒŸ ä¿®æ­£ï¼šç¢ºä¿åŸ·è¡Œç·Šæ€¥åˆ†é å®Œæ•´åˆå§‹åŒ–
                if (typeof renderEmergencyView === 'function') renderEmergencyView(); 
                break;
            case 'settings': 
                if (typeof renderSettingsView === 'function') renderSettingsView(); 
                break;
            case 'data': 
                if (typeof renderDataView === 'function') renderDataView(); 
                break;
            case 'translate': 
                if (typeof renderTranslateView === 'function') renderTranslateView(); 
                break;
        }
    } catch (err) {
        console.error(`ğŸ“¡ è¦–åœ– [${mode}] æ¸²æŸ“ç™¼ç”Ÿå´©æ½°:`, err);
    }

    // E. ã€åº§æ¨™è‡ªç™’ã€‘
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            window.scrollTo(0, 0);
            const mainContent = document.getElementById('content-container');
            if (mainContent) mainContent.scrollTop = 0;
        });
    });
    saveData();
}


/** ğŸ—ï¸ 4. ä½ˆå±€ç¸½æ§ï¼šå»ºç«‹ç‰©ç†ç©ºé–“ */
function setupTripLayout() {
    const container = document.getElementById('content-container');
    if (!container) return;
    container.classList.remove('p-4');
    container.classList.add('p-0');

    container.innerHTML = `
        <div class="p-4 bg-gray-50 border-b border-gray-200 sticky top-0 z-[100]">
            <div class="grid grid-cols-10 gap-1 text-[10px] sm:text-xs text-gray-700">
                <button class="tool-link bg-slate-200 text-slate-700 font-bold" onclick="window.currentDay=null; switchView('list')">åˆ‡æ›</button>
                <button class="tool-link" onclick="openProtectedSubView('settings')">è¨­å®š</button>
                
                <div class="relative group col-span-1">
                    <button class="tool-link w-full h-full flex items-center justify-center gap-1" onclick="openProtectedSubView('itinerary')">
                        <span id="itinerary-btn-text">æ’ç¨‹</span>
                    </button>
                    <div class="absolute left-0 top-full w-40 bg-white shadow-2xl rounded-xl border border-gray-100 hidden group-hover:block z-[9999] pt-2">
                        <div class="p-1.5 flex flex-col gap-1 bg-white rounded-xl shadow-lg">
                            <button onclick="openProtectedSubView('itinerary')" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-gray-700 hover:bg-pink-50 rounded-lg">ğŸ“Œ æ’ç¨‹</button>
                            <div class="h-[1px] bg-gray-50 mx-2"></div>
                            <button onclick="openProtectedSubView('expense')" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-gray-700 hover:bg-green-50 rounded-lg">ğŸ’° è¡Œç¨‹é–‹éŠ·</button>
                            <div class="h-[1px] bg-gray-50 mx-2"></div>
                            <button onclick="openProtectedSubView('checklist')" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-gray-700 hover:bg-blue-50 rounded-lg">âœ… æ”œå¸¶æ¸…å–®</button>
                        </div>
                    </div>
                </div>

                <div class="relative group col-span-1">
                    <button class="tool-link w-full h-full flex items-center justify-center gap-1" data-mode="bucket" onclick="openProtectedSubView('bucket')">
                        <span id="bucket-btn-text">å‚™é¸</span>
                    </button>
                    <div class="absolute left-0 top-full w-44 bg-white shadow-2xl rounded-xl border border-gray-100 hidden group-hover:block z-[9999] pt-2">
                        <div class="p-1.5 flex flex-col gap-1 bg-white rounded-xl shadow-lg">
                            <button onclick="openProtectedSubView('bucket')" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-gray-700 hover:bg-pink-50 hover:text-pink-600 rounded-lg transition-all">ğŸ“ å‚™é¸å£è¢‹åå–®</button>
                            <div class="h-[1px] bg-gray-50 mx-2"></div>
                            <button onclick="toggleModal('dictionary-manager-modal'); renderDictList();" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-gray-700 hover:bg-slate-50 hover:text-slate-900 rounded-lg transition-all">ğŸ“– è¾¨è­˜å­—å…¸è¨­å®š</button>
                            <div class="h-[1px] bg-gray-50 mx-2"></div>
                            <button onclick="toggleModal('transport-hub-modal'); renderTransportHub();" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-blue-700 hover:bg-blue-50 rounded-lg transition-all italic">ğŸš‰ äº¤é€šè·¯ç¶²ä¸­å¿ƒ</button>
                            <div class="h-[1px] bg-gray-50 mx-2"></div>
                            <button onclick="runSystemDeepRescue()" class="flex items-center gap-2 px-3 py-2.5 text-[11px] font-black text-amber-600 hover:bg-amber-50 rounded-lg transition-all">ğŸ©¹ ä¿®å¾©èˆ‡å›æ”¶</button>
                        </div>
                    </div>
                </div>
                <button class="tool-link" onclick="openProtectedSubView('translate')">ç¿»è­¯</button>
                <button class="tool-link" onclick="openProtectedSubView('shopping')">è³¼ç‰©</button>
                <button class="tool-link" onclick="openProtectedSubView('emergency')">ç·Šæ€¥</button>
                <button class="tool-link" onclick="openProtectedSubView('data')">å‚™ä»½</button>
            </div>
        </div>

        <div id="day-tabs-container" class="flex border-b border-gray-200 overflow-x-auto bg-white sticky top-16 z-[40]"></div>

        <div id="views-parent" class="w-full max-w-[800px] mx-auto min-h-screen">
            <div id="itinerary-view" style="display: block;">
                <div id="mode-frozen-bar" class="sticky top-[106px] z-[50] bg-white border-b border-gray-100 h-[52px] flex items-center">
                    <div class="px-4 w-full flex items-center h-full">
                        <span class="px-3 py-1 bg-pink-500 text-white rounded-full text-[10px] font-black">æ’ç¨‹é–±è®€ä¸­</span>
                    </div>
                </div>
                <div id="day-content-itinerary" class="p-4"></div>
            </div>
            <div id="checklist-view" style="display: none;"><div id="checklist-mount-point" class="p-4"></div></div>
            <div id="settings-view" style="display: none;"></div>
            <div id="bucket-view" style="display: none;"></div>
            <div id="expense-view" style="display: none;"></div>
            <div id="translate-view" style="display: none;"></div>
            <div id="shopping-view" style="display: none;"></div>
            <div id="emergency-view" style="display: none;"></div>
            <div id="data-view" style="display: none;"></div>
        </div>
    `;
}

/** ğŸ› ï¸ æ›´æ–° setupTripLayout ä¸­çš„æŒ‰éˆ•è¡Œç‚º */
// è«‹ç¢ºä¿ HTML çµæ§‹ä¸­æ‰€æœ‰çš„å·¥å…·æŒ‰éˆ• onclick éƒ½æŒ‡å‘ openProtectedSubView
// ä¾‹å¦‚ï¼šonclick="openProtectedSubView('bucket')"


/**
 * å®Œæ•´å°æ­£ç‰ˆï¼šåˆ‡æ›è¨ˆç•«æ¨¡å¼
 * æ•´åˆï¼šé«˜å“è³ªå‘¼å¸ç‡ˆã€è‡ªå‹•è¦–åœ–è·³è½‰ã€è—åœ–/æ­£å¼è³‡æ–™éš”é›¢æ¸²æŸ“
 */
function switchPlanMode(mode) {
    // 1. æ›´æ–°å…¨åŸŸç‹€æ…‹
    state.planViewMode = mode;
    
    // 2. âœ¨ è‡ªå‹•å°å‘è¡Œç¨‹è¦–åœ– (ç¢ºä¿ UI å®¹å™¨å·²åˆ‡æ›)
    switchSubView('itinerary');

    // 3. ç²å– UI é¡¯ç¤ºå…ƒç´ 
    const workshopNotice = document.getElementById('workshop-notice') || document.getElementById('workshop-notice-bar');
    const workshopNoticeMini = document.getElementById('workshop-notice-mini');
    const modeStatusIndicator = document.getElementById('mode-status-indicator');
    const navBtnText = document.getElementById('itinerary-btn-text');
    const navBtnIcon = document.getElementById('itinerary-btn-icon');

    if (mode === 'workshop') {
        // --- ğŸ› ï¸ é€²å…¥å·¥åŠæ¨¡å¼ ---

        // A. é¡¯ç¤ºè—è‰²æç¤ºæ©«å¹… (ä¿®æ­£ noticeBar æœªå®šç¾©å•é¡Œ)
        if (workshopNotice) {
            workshopNotice.classList.remove('hidden');
            workshopNotice.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg flex items-center justify-between shadow-sm max-w-[800px] mx-auto mt-4 animate-in slide-in-from-top-2">
                    <div>
                        <p class="text-blue-800 font-bold text-xs leading-tight">ğŸ› ï¸ è¦åŠƒå·¥åŠå·²å•Ÿå‹•</p>
                        <p class="text-blue-600 text-[10px] mt-1">é€™è£¡çš„ä¿®æ”¹ä¸æœƒå½±éŸ¿æ­£å¼è¡Œç¨‹ã€‚</p>
                    </div>
                    <button onclick="publishWorkshop()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-black shadow-md hover:bg-blue-700 active:scale-95 transition-all">
                        ğŸš€ ç¢ºå®šç™¼ä½ˆ
                    </button>
                </div>`;
        }

        // B. åŒæ­¥å°è¦½åˆ—è¦–è¦º (è®Šæ›´ç‚ºå°ˆæ¥­è—)
        if (navBtnText) {
            navBtnText.textContent = 'è¦åŠƒå·¥åŠ';
            navBtnText.style.color = '#2563eb';
            navBtnText.className = 'text-blue-600 font-black';
        }
        if (navBtnIcon) navBtnIcon.textContent = 'ğŸ› ï¸';

        // C. âœ¨ å°å…¥ä¿®æ­£ï¼šé«˜å“è³ªå‘¼å¸ç‡ˆæ¨™ç±¤ (å·¥åŠæ¨¡å¼)
        if (modeStatusIndicator) {
            modeStatusIndicator.innerHTML = `
                <span class="px-3 py-1 bg-blue-600 text-white rounded-full text-[10px] font-black breath-workshop shadow-md flex items-center gap-1.5 whitespace-nowrap inline-flex">
                    <span class="dot-indicator"></span>
                    å·¥åŠæ¨¡å¼ç·¨è¼¯ä¸­
                </span>`;
        }
        
        if (workshopNoticeMini) workshopNoticeMini.classList.remove('hidden');

        // âœ¨ åŒæ­¥ï¼šåœ¨å·¥åŠæ¨¡å¼ä¸‹è§¸ç™¼æ»‘è»Œæ¸²æŸ“
        if (typeof renderWorkshopSlider === 'function') renderWorkshopSlider();

    } else {
        // --- ğŸ“Œ å›åˆ°æ­£å¼æ’ç¨‹ ---

        // A. åŒæ­¥å°è¦½åˆ—è¦–è¦º (å›æ­¸æ·±ç°è‰²)
        if (navBtnText) {
            navBtnText.textContent = 'è¡Œç¨‹';
            navBtnText.style.color = '#374151';
            navBtnText.className = 'text-gray-700 font-medium';
        }
        if (navBtnIcon) navBtnIcon.textContent = 'ğŸ—“ï¸';

        // B. âœ¨ å°å…¥ä¿®æ­£ï¼šé«˜å“è³ªå‘¼å¸ç‡ˆæ¨™ç±¤ (æ­£å¼æ¨¡å¼)
        if (modeStatusIndicator) {
            modeStatusIndicator.innerHTML = `
                <span class="px-3 py-1 bg-pink-500 text-white rounded-full text-[10px] font-black breath-master shadow-md flex items-center gap-1.5 whitespace-nowrap inline-flex">
                    <span class="w-1.5 h-1.5 bg-white rounded-full opacity-60"></span>
                    æ­£å¼æ’ç¨‹é–±è®€ä¸­
                </span>`;
        }
        
        // C. éš±è—æ©«å¹…èˆ‡è¿·ä½ æç¤º
        if (workshopNotice) workshopNotice.classList.add('hidden');
        if (workshopNoticeMini) workshopNoticeMini.classList.add('hidden');
        
        const slider = document.getElementById('workshop-version-slider');
        if (slider) slider.innerHTML = '';
    }
    
    // 4. å¼·åˆ¶åŸ·è¡Œå…§å®¹èˆ‡è©³æƒ…åˆ·æ–° (ç¢ºä¿æ¨™ç±¤ç‹€æ…‹åŒæ­¥)
    renderTripDetail(); 
    
    // 5. âœ¨ ä¿ç•™ï¼šåŸæœ¬çš„å½ˆå‡ºæç¤ºè¨Šæ¯
    const msg = mode === 'master' ? 'ğŸ“Œ å·²åˆ‡æ›è‡³æ­£å¼æ’ç¨‹' : 'ğŸ› ï¸ å·²é€²å…¥è¦åŠƒå·¥åŠ';
    if (typeof showMessage === 'function') showMessage(msg, 'info');
}


function updateItineraryUIState() {
    const navBtnText = document.getElementById('itinerary-btn-text');
    const navBtnIcon = document.getElementById('itinerary-btn-icon');
    const indicator = document.getElementById('mode-status-indicator');

    if (state.planViewMode === 'workshop') {
        if (navBtnText) { navBtnText.textContent = 'å·¥åŠä¸­'; navBtnText.className = 'text-blue-600 font-black'; }
        if (navBtnIcon) navBtnIcon.textContent = 'ğŸ› ï¸';
        if (indicator) {
            indicator.innerHTML = `<span class="px-3 py-1 bg-blue-600 text-white rounded-full text-[10px] font-black breath-workshop shadow-md flex items-center gap-1.5 whitespace-nowrap">å·¥åŠæ¨¡å¼</span>`;
        }
        renderWorkshopSlider();
    } else {
        if (navBtnText) { navBtnText.textContent = 'è¡Œç¨‹'; navBtnText.className = 'text-gray-700 font-medium'; }
        if (navBtnIcon) navBtnIcon.textContent = 'ğŸ—“ï¸';
        if (indicator) {
            indicator.innerHTML = `<span class="px-3 py-1 bg-pink-500 text-white rounded-full text-[10px] font-black breath-master shadow-md flex items-center gap-1.5 whitespace-nowrap">æ­£å¼è¡Œç¨‹</span>`;
        }
        const slider = document.getElementById('workshop-version-slider');
        if (slider) slider.innerHTML = '';
    }
}

/** * 1. å»ºç«‹æ–°å·¥åŠ (è—åœ–) 
 * åŸºæ–¼ç•¶å‰ã€Œæ­£å¼æ’ç¨‹ã€å»ºç«‹ä¸€å€‹æ–°çš„æ²™ç›’åˆ†æ”¯
 */
function createNewWorkshop(customName = null) {
    const trip = getCurrentTrip();
    if (!trip) return;

// å°‹æ‰¾æœ€å¤§åºè™Ÿï¼Œé¿å…åˆªé™¤å¾Œåç¨±é‡è¤‡
const nextNum = state.workshops.reduce((max, ws) => {
    const num = parseInt(ws.name.replace(/[^0-9]/g, '')) || 0;
    return Math.max(max, num);
}, 0) + 1;

const newWS = {
    id: 'ws-' + generateUUID(),
    name: `æ–¹æ¡ˆ ${nextNum}`, // æ°¸é éå¢ï¼Œä¸æœƒé‡è¤‡
    createdAt: new Date().toISOString(),
    data: {} 
};

    // âœ¨ åˆå§‹æ•¸æ“šï¼šå¾ã€Œæ­£å¼è¡Œç¨‹ã€æ·±æ‹·è²ä¸€ä»½ä½œç‚ºèµ·é»
    trip.days.forEach(day => {
        newWS.data[`${trip.id}_day${day.dayNum}`] = JSON.parse(JSON.stringify(day.schedules || []));
    });

    state.workshops.push(newWS);
    state.currentWorkshopId = newWS.id;
    
    // å»ºç«‹å¾Œè‡ªå‹•åˆ‡æ›éå»
    switchWorkshop(newWS.id);
    showMessage(`âœ¨ è—åœ–ã€Œ${newWS.name}ã€å·²å»ºç«‹ä¸¦è‡ªå‹•åˆ‡æ›`, 'success');
}

/** åˆ‡æ›å·¥åŠç‰ˆæœ¬ (åŠ å…¥è‡ªå‹•æ»¾å‹•) */
function switchWorkshop(wsId) {
    state.currentWorkshopId = wsId;
    state.planViewMode = 'workshop';
    
    const ws = state.workshops.find(w => w.id === wsId);
    if (ws) {
        state.shadowItineraries = JSON.parse(JSON.stringify(ws.data));
        
        // 1. åªåˆ·å¡ç‰‡å…§å®¹ï¼Œä¸åˆ·æ•´å€‹ Layout
        renderDayContent(); 
        
        // 2. åŸ·è¡Œä¸Šé¢çš„æ™ºæ…§æ¸²æŸ“ (é€™æ™‚æ²å‹•ä½ç½®ä¸æœƒå‹•)
        renderWorkshopSlider();

        // 3. âœ¨ ç‰©ç†å°ç„¦ï¼šè®“é¸ä¸­çš„æ–¹æ¡ˆã€Œå¹³æ»‘ç§»å‹•ã€åˆ°è¦–ç·šä¸­å¤®
        setTimeout(() => {
            const activeBtn = document.getElementById(`ws-btn-${wsId}`);
            if (activeBtn) {
                activeBtn.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }
        }, 50);
    }
}

/** * 3. åŒæ­¥æ•¸æ“šè‡³è—åœ– (å¯¦æ™‚ä¿å­˜)
 * ç•¶æ‚¨åœ¨å·¥åŠå…§å¢æ¸›æ™¯é»æ™‚ï¼Œé™¤äº†æ›´æ–°ç·©å­˜ï¼Œä¹Ÿè¦åŒæ­¥å› workshops é™£åˆ—
 */
function syncShadowToWorkshop() {
    if (state.planViewMode !== 'workshop' || !state.currentWorkshopId) return;
    
    const ws = state.workshops.find(w => w.id === state.currentWorkshopId);
    if (ws) {
        ws.data = JSON.parse(JSON.stringify(state.shadowItineraries));
        saveData(); // å­˜å…¥ IndexedDB
    }
}

/** * 4. ç™¼ä½ˆæŒ‡å®šå·¥åŠ (è—åœ–è½‰æ­£å¼)
 * å°‡é¸å®šçš„è—åœ–æ•¸æ“šï¼Œè¦†è“‹è‡³æ­£å¼çš„ trip.days
 */
function publishSpecificWorkshop(wsId) {
    const trip = getCurrentTrip();
    const ws = state.workshops.find(w => w.id === wsId);
    if (!trip || !ws) return;

    if (!confirm(`âš ï¸ ç¢ºå®šè¦å°‡ã€Œ${ws.name}ã€ç™¼ä½ˆç‚ºæ­£å¼è¡Œç¨‹å—ï¼Ÿ\né€™å°‡è¦†è“‹æ‚¨ç›®å‰çš„æ‰€æœ‰æ­£å¼æ’ç¨‹ã€‚`)) return;

    // åŸ·è¡Œæ•¸æ“šè¦†è“‹é‚è¼¯
    Object.keys(ws.data).forEach(key => {
        if (key.startsWith(trip.id)) {
            const dayNum = parseInt(key.split('_day')[1]);
            const day = trip.days.find(d => d.dayNum === dayNum);
            if (day) {
                day.schedules = JSON.parse(JSON.stringify(ws.data[key]));
            }
        }
    });

    state.planViewMode = 'master'; // å›åˆ°æ­£å¼æ¨¡å¼
    state.currentWorkshopId = null; // æ¸…é™¤é¸å–ç‹€æ…‹
    
    renderTripDetail();
    saveData();
    showMessage(`ğŸš€ è—åœ–ã€Œ${ws.name}ã€å·²æ­£å¼ç™¼ä½ˆï¼`, 'success');
}

/** ğŸ‘º çµ‚æ¥µæ ¸æ‰“æ“ŠåŠ å›ºç‰ˆï¼šæ¸²æŸ“å¤©æ•¸æ¨™ç±¤åˆ— (è§£æ±ºæ®˜ç•™å•é¡Œ) */
function renderDayTabs(trip) {
    // A. ç¢ºä¿æ¯æ¬¡éƒ½æŠ“å–æœ€æ–° DOM åƒè€ƒï¼Œä¸ä½¿ç”¨å¿«å–
    const tabsContainer = document.getElementById('day-tabs-container');
    if (!tabsContainer || !trip || !trip.days) return;

    // B. âœ¨ ç‰©ç†ç´šæ¸…ç©ºï¼šä½¿ç”¨å…©éšå±¤æ¸…ç©ºæ³•
    tabsContainer.innerHTML = ''; 
    while (tabsContainer.firstChild) {
        tabsContainer.removeChild(tabsContainer.firstChild);
    }

    // C. ç‹€æ…‹æ ¡æº–ï¼šé˜²æ­¢ç´¢å¼•è¶Šç•Œ (åˆªé™¤ä¸­é–“å¤©æ•¸å¾Œçš„å°ä½é—œéµ)
    if (state.currentDayIndex >= trip.days.length) {
        state.currentDayIndex = Math.max(0, trip.days.length - 1);
    }

    // D. æ§‹å»ºæ¨™ç±¤ HTML
    const tabsHTML = trip.days.map((day, index) => {
        let cityNames = typeof getCityDisplayForHeader === 'function' ? getCityDisplayForHeader(day.city) : '';
        if (cityNames.length > 10) cityNames = cityNames.substring(0, 8) + '..)';
        const isActive = index === state.currentDayIndex;
        
        return `
            <button id="day-tab-${index}" onclick="changeDay(${index})"
                    class="transition-all duration-200 flex-shrink-0 ${
                        isActive 
                        ? 'theme-pink text-white font-bold shadow-sm' 
                        : 'text-gray-500 bg-gray-50 hover:bg-gray-100'
                    }">
                <div class="text-[10px] opacity-80 font-mono uppercase">Day ${day.dayNum}</div>
                <div class="truncate px-1">${cityNames.replace(/[()]/g, '') || '---'}</div>
            </button>
        `;
    }).join('');
    
    // E. âœ¨ åŸ·è¡Œæ’å…¥ (ä½¿ç”¨ Fragment æ¸²æŸ“æå‡ç©©å®šæ€§)
    const finalUI = tabsHTML + `
        <button id="add-day-btn" onclick="addNewDay()" 
                class="px-4 text-gray-400 bg-gray-50 hover:bg-gray-100 hover:text-pink-500 transition-colors text-lg flex items-center justify-center border-l border-gray-100">
            ï¼‹
        </button>
        <div class="flex-grow bg-gray-50"></div>
    `;
    
    // F. ğŸš€ å¼·åˆ¶æ’éšŠåŸ·è¡Œï¼šç¢ºä¿æ¸…ç©ºèˆ‡å¯«å…¥åœ¨ç€è¦½å™¨çœ¼ä¸­æ˜¯å…©å€‹ç¨ç«‹äº‹ä»¶
    requestAnimationFrame(() => {
        tabsContainer.innerHTML = finalUI;
        
        // G. åŸ·è¡Œæ»¾å‹•å°ç„¦
        requestAnimationFrame(() => {
            const activeTab = document.getElementById(`day-tab-${state.currentDayIndex}`);
            if (activeTab) {
                activeTab.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest', 
                    inline: 'center'  
                });
            }
        });
    });
}

        /** è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šæ’ç¨‹é¢¨æ ¼ç¢ºå®šè²»ç”¨é¡åˆ¥ */
        function determineExpenseCategory(schedule) {
            // 1. ä½å®¿ (åŸºæ–¼ style: 'other' + customStyle åŒ…å« 'ä½å®¿')
            if (schedule.style === 'other' && schedule.customStyle && schedule.customStyle.includes('ä½å®¿')) {
                return 'ä½å®¿';
            }
            // 2. äº¤é€š (åŸºæ–¼ style: 'transport' - AIç”Ÿæˆçš„äº¤é€šæ’ç¨‹)
            if (schedule.style === 'transport') {
                return 'äº¤é€š';
            }
            // 3. é¤é£²
            if (schedule.style === 'food') {
                return 'é¤é£²';
            }
            // 4. è³¼ç‰©
            if (schedule.style === 'shopping') {
                return 'è³¼ç‰©';
            }
            // 5. æ´»å‹• (æ‰€æœ‰å…¶ä»–é¡å‹)
            // cultural, nature, anime, nightlife, or default 'other' without 'ä½å®¿' keyword
            return 'æ´»å‹•';
        }

        /** è™•ç†ç¸½é ç®—è¼¸å…¥æ¬„ä½çš„è®Šæ›´ */
        function handleBudgetInput(value) {
            // æ¸…é™¤é€—è™Ÿä¸¦è§£æç‚ºæ•¸å­—
            const cleanValue = value.replace(/,/g, '');
            const parsedValue = parseInt(cleanValue);
            
            if (!isNaN(parsedValue) && parsedValue >= 0) {
                state.totalBudget = parsedValue;
                saveData();
                calculateAndRenderExpenses(); 
            } else if (cleanValue === '') {
                state.totalBudget = 0;
                saveData();
                calculateAndRenderExpenses();
            }
        }

        /** é–‹å•Ÿä¿®æ”¹ç¸½é ç®—æ¨¡æ…‹æ¡† */
        function openEditBudgetModal() {
            const budgetInput = document.getElementById('modal-total-budget');
            const currencySelect = document.getElementById('modal-currency');
            
            // åˆå§‹åŒ–æ¨¡æ…‹æ¡†çš„å€¼
            budgetInput.value = state.totalBudget;
            currencySelect.value = state.currency || 'NTD';
            
            toggleModal('edit-budget-modal');
        }

        /** å„²å­˜ç¸½é ç®—èˆ‡å¹£åˆ¥ */
        function saveTotalBudget(event) {
            event.preventDefault();
            
            const budgetInput = document.getElementById('modal-total-budget');
            const currencySelect = document.getElementById('modal-currency');

            const newBudget = parseInt(budgetInput.value);
            const newCurrency = currencySelect.value;

            if (isNaN(newBudget) || newBudget < 0) {
                showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç®—é‡‘é¡', 'error');
                return;
            }

            state.totalBudget = newBudget;
            state.currency = newCurrency;
            
            toggleModal('edit-budget-modal');
            saveData();
            calculateAndRenderExpenses();
            showMessage(`ç¸½é ç®—å’Œå¹£åˆ¥å·²æ›´æ–°ç‚º ${newCurrency} ${newBudget.toLocaleString()}`, 'success');
        }
        
        /**
         * NEW: é–‹å•Ÿè²»ç”¨ç´°é …æ¨¡æ…‹æ¡†
         * @param {string} categoryKey - è²»ç”¨é¡åˆ¥çš„éµ (e.g., 'ä½å®¿')
         * @param {number} total - è©²é¡åˆ¥ç¸½æ”¯å‡º
         */
        function openExpenseDetailModal(categoryKey, total) {
             const trip = getCurrentTrip();
             if (!trip) return;

             let expenseItems = [];
             
             // é‡æ–°éæ­·è¡Œç¨‹ä»¥æå–è©²é¡åˆ¥çš„ç´°é …
             trip.days.forEach(day => {
                 day.schedules.forEach(schedule => {
                     const costValue = parseInt(schedule.cost);
                     if (!isNaN(costValue) && costValue > 0) {
                         const category = determineExpenseCategory(schedule);
                         if (category === categoryKey) {
                             expenseItems.push({
                                 name: schedule.name,
                                 cost: costValue,
                                 date: day.date,
                                 dayNum: day.dayNum,
                                 style: getStyleName(schedule.style, schedule.customStyle)
                             });
                         }
                     }
                 });
             });
             
             // 2. æº–å‚™æ¸²æŸ“æ•¸æ“š: æŒ‰ Day åˆ†çµ„
             const groupedByDay = expenseItems.reduce((acc, item) => {
                 const dayKey = `Day ${item.dayNum}`;
                 if (!acc[dayKey]) {
                     acc[dayKey] = { date: item.date, dayTotal: 0, items: [] };
                 }
                 acc[dayKey].items.push(item);
                 acc[dayKey].dayTotal += item.cost; // è¨ˆç®—è©²å¤©è©²é¡åˆ¥çš„ç¸½å’Œ
                 return acc;
             }, {});

             const header = document.getElementById('expense-modal-title');
             const content = document.getElementById('expense-modal-content');
             const categoryMeta = EXPENSE_CATEGORIES[categoryKey];

             header.textContent = `${categoryKey} - ç´°é …åˆ—è¡¨`;
             header.style.color = categoryMeta.color;

             let detailListHTML = '';
             const sortedDayKeys = Object.keys(groupedByDay).sort((a, b) => parseInt(a.slice(4)) - parseInt(b.slice(4)));

             sortedDayKeys.forEach(dayKey => {
                 const dayGroup = groupedByDay[dayKey];
                 
                 detailListHTML += `
                     <div class="mb-4 pt-3 border-t border-gray-200 first:border-t-0">
                         <h5 class="font-extrabold text-sm mb-2 flex justify-between items-center">
                             <span class="text-gray-700">${dayKey} (${dayGroup.date})</span>
                             <span class="text-sm font-bold theme-text-pink">${state.currency} ${dayGroup.dayTotal.toLocaleString()}</span>
                         </h5>
                     `;

                 detailListHTML += dayGroup.items.map(item => `
                     <div class="flex justify-between items-start py-1 text-sm">
                         <span class="flex-1 min-w-0 mr-4 truncate text-gray-700">${item.name}</span>
                         <span class="font-medium text-gray-700">${item.cost.toLocaleString()}</span>
                     </div>
                 `).join('');

                 detailListHTML += `</div>`; // Close day group
             });


             content.innerHTML = `
                 <div class="mb-4 text-right">
                     <p class="text-sm text-gray-600">è©²é¡åˆ¥ç¸½æ”¯å‡ºï¼š</p>
                     <p class="text-xl font-extrabold text-red-600">${state.currency} ${total.toLocaleString()}</p>
                 </div>
                 <div class="max-h-[50vh] overflow-y-auto rounded-lg border border-gray-300 bg-gray-50 p-4">
                     ${detailListHTML || '<p class="text-center py-4 text-gray-500">ç„¡ç´°é …è¨˜éŒ„ã€‚</p>'}
                 </div>
             `;

             toggleModal('expense-detail-modal');
        }


        /**
         * NEW: æ¸²æŸ“æ¯æ—¥é–‹éŠ·æ‘˜è¦ (åœ¨ä¸»é åº•éƒ¨)
         * @param {number} grandTotal - ç¸½æ”¯å‡ºé‡‘é¡
         */
        function renderDailyExpenseSummary(grandTotal) {
             const trip = getCurrentTrip();
             const container = document.getElementById('daily-expense-summary-container');

             if (!trip || !container) return;

             // 1. å½™ç¸½æ¯æ—¥ç¸½é–‹éŠ·
             const dailyTotals = trip.days.map(day => {
                 const dayTotal = day.schedules.reduce((sum, schedule) => {
                     const cost = parseInt(schedule.cost);
                     return sum + (isNaN(cost) ? 0 : cost);
                 }, 0);
                 return {
                     dayNum: day.dayNum,
                     date: day.date,
                     total: dayTotal
                 };
             });

             // 2. æ‰¾å‡ºæ¯æ—¥æœ€é«˜èŠ±è²» (ç”¨æ–¼è¨ˆç®—é•·æ¢åœ–æ¯”ä¾‹)
             const maxDailyTotal = Math.max(...dailyTotals.map(d => d.total), 1); // é¿å…é™¤ä»¥é›¶

             // 3. æ¸²æŸ“æ¯æ—¥é•·æ¢åœ–å’Œé‡‘é¡
             let summaryHtml = dailyTotals.map(day => {
                 const percentage = (day.total / maxDailyTotal) * 100;
                 const progressColor = day.total > (state.totalBudget / trip.days.length) 
                     ? 'bg-red-500' 
                     : 'bg-pink-500';
                 
                 return `
                     <div class="daily-expense-card">
                         <div class="flex justify-between items-center mb-2">
                             <span class="font-semibold text-gray-700 text-sm">Day ${day.dayNum} (${day.date.slice(5)})</span>
                             <span class="font-normal text-gray-700 text-base">${day.total.toLocaleString()}</span>
                         </div>
                         <div class="daily-progress-bg">
                             <div class="daily-progress-bar ${progressColor}" style="width: ${percentage}%;"></div>
                         </div>
                     </div>
                 `;
             }).join('');

             container.innerHTML = summaryHtml;
        }

        /**
         * è¨ˆç®—ä¸¦æ¸²æŸ“è¡Œç¨‹è²»ç”¨æ¸…å–® (Updated)
         */
        function calculateAndRenderExpenses() {
            // ç¢ºä¿å…ƒç´ å­˜åœ¨ï¼Œé€™æ˜¯ä¿®å¾© ReferenceError çš„é—œéµ
            const expenseContainer = document.getElementById('expense-list-container');
            const grandTotalEl = document.getElementById('grand-total-cost');
            const dailyRemainingEl = document.getElementById('daily-remaining-budget');
            const currencyEl = document.getElementById('budget-currency');
            const grandTotalCurrencyEl = document.getElementById('grand-total-currency');
            const totalBudgetAmountEl = document.getElementById('total-budget-amount');

            const trip = getCurrentTrip();
            
            // å¦‚æœç•¶å‰ä¸åœ¨ expense-view é é¢ï¼Œå‰‡ä¸åŸ·è¡Œæ¸²æŸ“é‚è¼¯
            if (!trip || !expenseContainer) return; 

            // æ›´æ–°å¹£åˆ¥é¡¯ç¤º
            if (currencyEl) currencyEl.textContent = state.currency;
            if (grandTotalCurrencyEl) grandTotalCurrencyEl.textContent = state.currency;
            if (totalBudgetAmountEl) totalBudgetAmountEl.textContent = state.totalBudget.toLocaleString();


            let categorizedCosts = {
                'ä½å®¿': { total: 0, items: [] },
                'äº¤é€š': { total: 0, items: [] },
                'é¤é£²': { total: 0, items: [] },
                'æ´»å‹•': { total: 0, items: [] },
                'è³¼ç‰©': { total: 0, items: [] },
            };
            let grandTotal = 0;

            // éæ­·æ¯ä¸€å¤©å’Œæ¯å€‹æ’ç¨‹ï¼Œæ”¶é›†è²»ç”¨
            const totalDays = trip.days.length; // è¨ˆç®—ç¸½å¤©æ•¸
            
            trip.days.forEach(day => {
                day.schedules.forEach(schedule => {
                    const costValue = parseInt(schedule.cost);
                    if (!isNaN(costValue) && costValue > 0) {
                        const categoryKey = determineExpenseCategory(schedule);
                        
                        if (categorizedCosts[categoryKey]) {
                            categorizedCosts[categoryKey].total += costValue;
                            categorizedCosts[categoryKey].items.push({
                                name: schedule.name,
                                cost: costValue,
                                date: day.date
                            });
                            grandTotal += costValue;
                        }
                    }
                });
            });
            
            // --- NEW BUDGET CALCULATION ---
            const totalBudget = state.totalBudget || 0;
            const remainingBudget = totalBudget - grandTotal;
            const dailyRemaining = totalDays > 0 ? remainingBudget / totalDays : 0;
            const percentageUsed = totalBudget > 0 ? Math.min(100, (grandTotal / totalBudget) * 100) : 0;
            const progressBar = document.getElementById('budget-progress-bar');
            const budgetSummaryText = document.getElementById('budget-summary-text'); // ç²å–ç™¾åˆ†æ¯”å…ƒç´ 

            if (progressBar) {
                progressBar.style.width = `${percentageUsed}%`;
                // é¡è‰²è®Šæ›´
                if (percentageUsed >= 100) {
                    progressBar.classList.remove('bg-pink-500');
                    progressBar.classList.add('bg-red-500');
                } else {
                    progressBar.classList.remove('bg-red-500');
                    progressBar.classList.add('bg-pink-500');
                }
            }
            // FIX 2: å°‡ç™¾åˆ†æ¯”ç§»åˆ°å³ä¸Šè§’
            if (budgetSummaryText) {
                budgetSummaryText.textContent = `${Math.round(percentageUsed)}% å·²ä½¿ç”¨`;
            }

            let expenseHtml = '';
            let hasExpenses = false;

            // æ¸²æŸ“æ¯å€‹é¡åˆ¥
            for (const [key, data] of Object.entries(categorizedCosts)) {
                if (data.total > 0) {
                    hasExpenses = true;
                    const categoryMeta = EXPENSE_CATEGORIES[key];
                    const percentageOfTotal = grandTotal > 0 ? (data.total / grandTotal) * 100 : 0;

                    // æ¯å€‹é¡åˆ¥çš„ç¸½çµå¡ç‰‡ (ä½¿ç”¨ cursor-pointer å•Ÿç”¨é»æ“Šå½ˆå‡º)
                    expenseHtml += `
   		 <div class="col-span-1">
     		   <div class="expense-category-card cursor-pointer bg-white flex flex-col justify-between" 
  		           onclick="openExpenseDetailModal('${key}', ${data.total})"
   		          style="border-color: ${categoryMeta.border}; padding: 1rem; min-height: 100px;">
            
  		          <div class="flex items-center mb-2">
  		             <span class="expense-dot" style="background-color: ${categoryMeta.color}; border-color: ${categoryMeta.color};"></span>
 		               <h4 class="font-bold text-xs text-gray-500 uppercase tracking-wider">${key}</h4>
 		           </div>
            
 		           <div class="flex-grow flex items-center">
   		             <span class="text-lg font-extrabold text-gray-800">
   		                 ${data.total.toLocaleString()}
   		             </span>
 		           </div>
            
		           <div class="text-right">
     		           <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 font-medium">
		                    ${percentageOfTotal.toFixed(1)}%
     		           </span>
     		       </div>

     		   </div>
  		  </div>
		`;
                }
            }
            
            if (!hasExpenses) {
                expenseContainer.innerHTML = '<p class="text-center text-gray-500 mt-4 col-span-full">æ‰€æœ‰æ’ç¨‹ä¸­éƒ½æ²’æœ‰è¼¸å…¥è²»ç”¨ ($) è³‡è¨Šï¼Œè«‹åœ¨æ’ç¨‹å¡ç‰‡ä¸­ç·¨è¼¯å¡«å¯«ã€‚</p>';
            } else {
                // FIX: å…©åˆ—é¡¯ç¤º
                expenseContainer.className = "grid grid-cols-2 gap-4"; // ç¢ºä¿æ˜¯å…©æ¬„
                expenseContainer.innerHTML = expenseHtml;
            }
            
            // 1. Update total cost display
            if (grandTotalEl) {
                grandTotalEl.textContent = `${state.currency} ${grandTotal.toLocaleString()}`;
            }

            // 2. Update total budget input value (format on blur only, or if initially loading)
            // é€™è£¡ä¸éœ€è¦å†æ¬¡è¨­ç½® totalBudgetInputEl.valueï¼Œå› ç‚ºå®ƒåœ¨çˆ¶ç´šå‡½æ•¸ä¸­å·²ç¶“è¢«æ ¼å¼åŒ–ï¼Œé™¤éç”¨æˆ¶æ­£åœ¨ç·¨è¼¯ã€‚

            // 3. Update daily remaining budget display
            if (dailyRemainingEl) {
                 // FIX 1: ç§»é™¤å¹£åˆ¥å’Œ '/ æ—¥ (XXå¤©)'
                 dailyRemainingEl.textContent = remainingBudget >= 0 
                     ? `${Math.round(dailyRemaining).toLocaleString()} / æ—¥`
                     : `è¶…æ”¯ ${Math.abs(Math.round(dailyRemaining)).toLocaleString()} / æ—¥`;
                 
                 // Apply colors based on remaining budget
                 dailyRemainingEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-700');
                 if (remainingBudget >= 0) {
                     dailyRemainingEl.classList.add('text-green-600');
                 } else {
                     dailyRemainingEl.classList.add('text-red-600');
                 }
                 // ç¢ºä¿å­—é«”å¤§å°æ˜¯ text-xs
                 dailyRemainingEl.classList.remove('text-sm', 'text-base', 'text-lg'); 
                 dailyRemainingEl.classList.add('text-xs');
            }
            
            // 4. æ¸²æŸ“æ¯æ—¥é–‹éŠ·æ‘˜è¦
            renderDailyExpenseSummary(grandTotal);
        }


/** * ============================================================
 * ğŸ›’ è³¼ç‰©æ¨¡çµ„ç¸½çµ (åŸç¢¼å°æ­£ç‰ˆ)
 * åŒ…å«ï¼šæ¸²æŸ“å¼•æ“ã€ç‹€æ…‹åˆ‡æ›ã€AIä»£å°‹é‚è¼¯ã€è¡Œç¨‹é€£å‹•
 * ============================================================
 */

/** ğŸ›’ æ¸²æŸ“è³¼ç‰©æ¸…å–®ï¼šæ©«ç§»å°èˆªæ¨™ç±¤ç‰ˆ (v4.8 ä½ˆå±€å¤§å°ä½ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å¾¹åº•è§£æ±ºæ¨™ç±¤é‡ç–Šï¼šå¼·åˆ¶å°èˆªåˆ—ä½”æ“š 100% å¯¬åº¦ä¸¦é–‹å•Ÿç¨ç«‹æ²è»¸ã€‚
 * 2. æ¨™ç±¤ç²¾éŠï¼šé™åˆ¶åç¨±é•·åº¦ç‚º 3 å­—ï¼Œä¸¦å„ªåŒ– Icon èˆ‡æ•¸é‡çš„å°æ¯”ã€‚
 * 3. è¦–åœ–ä¿è­·ï¼šåŠ å…¥ z-index èˆ‡èƒŒæ™¯é–å®šï¼Œç¢ºä¿æ²å‹•æ™‚æ¨™ç±¤åˆ—å§‹çµ‚æ¸…æ™°ã€‚
 */
function renderShoppingList() {
    const viewContainer = document.getElementById('shopping-view');
    if (!viewContainer) return;

    const shoppingList = state.shoppingList || [];
    if (shoppingList.length === 0) {
        viewContainer.innerHTML = renderShoppingEmptyState(); 
        return;
    }

    // ğŸŒŸ Step 1. å…¨å­—æ®µå—…æ¢èˆ‡åˆ†çµ„ (ä¿æŒ v4.7 çš„å¼·å¤§æ„Ÿæ‡‰)
    const groups = shoppingList.reduce((acc, item) => {
        let cat = item.category || item.mainCat || "";
        if (!cat || cat === "ä¸€èˆ¬") {
            const name = (item.name || "").toUpperCase();
            if (name.match(/è—¥|EVE|ç¶­ä»–å‘½|DX|PLUS|é†«/)) cat = "è—¥å¦";
            else if (name.match(/é¤…|ç³–|é£Ÿ|éºµ|é¥…é ­|é«˜æ¹¯/)) cat = "é£Ÿ";
            else if (name.match(/åç”¢|åœŸç”¢|ç¦®|ä¼´æ‰‹/)) cat = "åœŸç”¢";
            else cat = "ä¸€èˆ¬";
        }
        // æ¨™ç±¤ç²¾éŠï¼šéæ¿¾æ‹¬è™Ÿä¸¦æˆªæ–·è‡³ 3 å­—
        cat = cat.replace(/(\(.*?\)|ï¼ˆ.*?ï¼‰|\[.*?\]|ã€.*?ã€‘|\s)/g, '').trim();
        if (cat.length > 3) cat = cat.substring(0, 3);
        if (!cat) cat = "ä¸€èˆ¬";

        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(item);
        return acc;
    }, {});

    const categories = Object.keys(groups).sort((a, b) => {
        if (a === "ä¸€èˆ¬") return 1;
        if (b === "ä¸€èˆ¬") return -1;
        return a.localeCompare(b);
    });
    
    if (!window.activeShoppingCat || !groups[window.activeShoppingCat]) {
        window.activeShoppingCat = categories[0]; 
    }

    // ğŸŒŸ Step 2. æ§‹å»ºã€Œç¨ç«‹å¯¦é«”ã€æ¨™ç±¤ (ä¿®æ­£ flex-shrink)
    const catIcons = { "è—¥å¦": "ğŸ’Š", "é£Ÿ": "ğŸ±", "åœŸç”¢": "ğŸ", "ä¸€èˆ¬": "ğŸ›’" };
    
    let tabsHtml = categories.map(cat => {
        const isActive = window.activeShoppingCat === cat;
        const count = groups[cat].length;
        
        return `
            <div class="flex-shrink-0">
                <button onclick="setShoppingCat('${cat}')" 
                        class="flex items-center gap-1.5 px-4 py-2.5 rounded-2xl border-2 transition-all active:scale-95 ${
                            isActive 
                            ? 'theme-pink text-white border-transparent shadow-lg font-black scale-105' 
                            : 'bg-white text-slate-400 border-slate-100 hover:border-pink-200 shadow-sm'
                        }">
                    <span class="text-sm">${catIcons[cat] || "ğŸ›ï¸"}</span>
                    <span class="text-xs whitespace-nowrap">${cat}</span>
                    <span class="text-[9px] px-1.5 py-0.5 rounded-full ${isActive ? 'bg-white/30 text-white' : 'bg-slate-100 text-slate-300'}">
                        ${count}
                    </span>
                </button>
            </div>`;
    }).join('');

    // ğŸŒŸ Step 3. è£ç®±æ¸²æŸ“ (ä¿®æ­£å®¹å™¨ä½ˆå±€)
    const displayItems = groups[window.activeShoppingCat] || [];
    viewContainer.innerHTML = `
        <div class="bg-white p-6 rounded-[2.5rem] shadow-lg w-full border border-gray-100 animate-in fade-in duration-300">
            <h3 class="text-xl font-black theme-text-pink mb-4 flex items-center gap-2"><span>ğŸ›’</span> æ¡è³¼æ¸…å–®</h3>
            
            <div id="shopping-local-msg" class="hidden mb-4 p-3 rounded-2xl text-[11px] font-black text-center shadow-inner"></div>
            
            ${renderShoppingToolbox()}

            <div class="w-full relative my-6 py-2 border-y border-slate-50 overflow-hidden">
                <div class="flex items-center gap-4 overflow-x-auto no-scrollbar scroll-smooth px-2 py-2" style="-webkit-overflow-scrolling: touch;">
                    ${tabsHtml}
                </div>
                <div class="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-l from-white to-transparent pointer-events-none z-10"></div>
            </div>

            <div id="shopping-list-container" class="space-y-4 min-h-[400px]">
                <div class="flex items-center justify-between mb-2 px-2">
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-4 theme-pink rounded-full"></div>
                        <h4 class="text-xs font-black text-slate-500 tracking-tighter uppercase">
                            Browsing: ${window.activeShoppingCat}
                        </h4>
                    </div>
                    <span class="text-[10px] font-black text-slate-300 bg-slate-50 px-2 py-1 rounded-lg">è¨ˆ ${displayItems.length} ç­†</span>
                </div>
                ${displayItems.map(item => renderSingleShoppingCard(item)).join('')}
            </div>
        </div>`;
}

/** ğŸ› ï¸ åˆ‡æ›é¡åˆ¥ä¸¦é‡æ–°æ¸²æŸ“ */
function setShoppingCat(catName) {
    window.activeShoppingCat = catName;
    renderShoppingList();
    
    // è²¼å¿ƒäº’å‹•ï¼šè‡ªå‹•æ²å‹•è‡³æ¸…å–®é ‚éƒ¨
    const container = document.getElementById('shopping-list-container');
    if (container) container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

/** ğŸ›’ [NEW] è³¼ç‰©é …ç›®å®‰æ’å™¨ï¼šsubmitShoppingToSchedule (v4.6 ç‰©ç†å°ä½ç‰ˆ)
 * ä½œç”¨ï¼šå°‡é¸å®šçš„è³¼ç‰©é …ç›®è½‰åŒ–ç‚ºè¡Œç¨‹ï¼Œæ”¯æ´è²»ç”¨è‡ªå‹•è¨ˆç®—èˆ‡å·¥åŠæ²™ç›’ã€‚
 */
async function submitShoppingToSchedule() {
    const itemId = document.getElementById('item-id-for-schedule').value;
    const dayIndex = parseInt(document.getElementById('schedule-day-select').value);
    const trip = getCurrentTrip();
    const day = trip.days[dayIndex];
    
    // ğŸŒŸ é—œéµï¼šå¾è³¼ç‰©æ¸…å–®æ•¸æ“šæºæå–
    const item = state.shoppingList.find(i => i.id === itemId);

    if (!item || !day) {
        showMessage('æ‰¾ä¸åˆ°è³¼ç‰©é …ç›®ï¼Œç„¡æ³•å®‰æ’', 'error');
        return;
    }

    // 1. å°è£è¡Œç¨‹ç‰©ä»¶ (å°ä½ç‰©ç†å¤§ä¸€çµ±æ ¼å¼)
    const newSchedule = {
        id: 'trip-shop-' + generateUUID(),
        name: `ğŸ›’ è³¼ç‰©ï¼š${item.name}`,
        startTime: day.startTime, // é è¨­ç‚ºè©²å¤©é–‹å§‹æ™‚é–“
        durationHours: 0.5,
        address: item.store || "è³¼ç‰©åœ°é»",
        notes: `æ•¸é‡: ${item.quantity} | å–®åƒ¹: ${item.price} ${item.notes ? `\nå‚™è¨»: ${item.notes}` : ''}`,
        style: 'shopping',
        category: 'è³¼',
        cost: (item.price * item.quantity).toString(),
        isAI: false,
        fromShopId: item.id // å»ºç«‹ç‰©ç†é€£çµ
    };

    // 2. æ³¨å…¥æ•¸æ“šæµ (æ”¯æ´æ²™ç›’åˆ†æµ)
    if (state.planViewMode === 'workshop') {
        const key = `${trip.id}_day${day.dayNum}`;
        if (!state.shadowItineraries[key]) {
            state.shadowItineraries[key] = JSON.parse(JSON.stringify(day.schedules || []));
        }
        state.shadowItineraries[key].push(newSchedule);
        state.shadowItineraries[key].sort((a, b) => a.startTime.localeCompare(b.startTime));
    } else {
        day.schedules.push(newSchedule);
        day.schedules.sort((a, b) => a.startTime.localeCompare(b.startTime));
    }

    // 3. ğŸ’¾ åŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª”èˆ‡é‡ç¹ª
    await saveData(true);
    toggleModal('add-to-schedule-modal');
    
    // 4. è‡ªå‹•å°ç„¦ä¸¦è·³è½‰è¦–åœ–
    state.currentDayIndex = dayIndex;
    openProtectedSubView('itinerary'); 
    
    showMessage(`âœ… å·²å°‡ã€Œ${item.name}ã€å®‰æ’è‡³ç¬¬ ${day.dayNum} å¤©ä¸¦æ ¡æº–è²»ç”¨`, 'success');
}

/** ğŸ› ï¸ è¼”åŠ© 1ï¼šæ¸²æŸ“è³¼ç‰©å·¥å…·ç®± (è§£æ±º ReferenceError) */
function renderShoppingToolbox() {
    return `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div class="p-5 rounded-[2rem] bg-slate-50 border border-slate-100 flex flex-col shadow-inner">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">ğŸš€ ç‡ƒæ–™åŒ…æ³¨å…¥</h4>
                    <button onclick="copyShoppingAIPrompt()" class="text-[10px] theme-text-pink font-black bg-white px-3 py-1 rounded-full shadow-sm">ğŸ§  è¤‡è£½æŒ‡ä»¤</button>
                </div>
                <textarea id="shopping-fuel-input" class="w-full flex-grow p-3 text-[11px] font-mono bg-white border border-slate-200 rounded-2xl outline-none resize-none mb-3 min-h-[100px] focus:ring-2 theme-border-pink" placeholder='è²¼ä¸Š AI JSON...'></textarea>
                <button onclick="processShoppingFuel()" class="w-full py-3 theme-bg theme-text-white rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all">åŸ·è¡Œç‡ƒæ–™è½‰æ›</button>
            </div>

            <div class="flex flex-col gap-3 h-full">
                <div class="flex-1 p-5 rounded-[2rem] bg-blue-50 border border-blue-100 flex flex-col justify-between shadow-sm">
                    <button onclick="openAIShoppingModal()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-xs shadow-md active:scale-95 transition-all">ğŸ¤– AI æ·±åº¦æœå°‹æ¨è–¦</button>
                    <p class="text-[10px] text-blue-400 text-center mt-3 font-bold italic leading-tight">å³æ™‚æƒæç•¶åœ°å°ˆæ¥­è³£å ´èˆ‡ç²¾æº–å®šåƒ¹</p>
                </div>
                <div class="flex-1 p-5 rounded-[2rem] bg-amber-50 border border-amber-100 flex flex-col justify-between shadow-sm">
                    <button onclick="importFuelToShopping()" class="w-full py-4 bg-amber-500 text-white rounded-2xl font-black text-xs shadow-md active:scale-95 transition-all">ğŸ“¦ è¬èƒ½å­—å…¸é†«ç™‚æƒæ</button>
                    <p class="text-[10px] text-amber-800 text-center mt-3 font-bold italic leading-tight">å¾å¯¦é«”å­—å…¸è‡ªå‹•åŒæ­¥ã€è³¼ã€‘æ¨™ç±¤é …ç›®</p>
                </div>
            </div>
        </div>`;
}

/** ğŸ› ï¸ è¼”åŠ© 2ï¼šæ¸²æŸ“ç©ºæ…‹ç•«é¢ (è§£æ±º ReferenceError) */
function renderShoppingEmptyState() {
    return `
        <div class="bg-white p-6 rounded-[2.5rem] shadow-lg w-full border border-gray-100">
            <h3 class="text-xl font-black theme-text-pink mb-6">ğŸ›’ æ¡è³¼æ¸…å–®</h3>
            ${renderShoppingToolbox()}
            <div class="py-20 text-center bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-100">
                <div class="text-4xl mb-4 opacity-20">ğŸ›’</div>
                <p class="text-slate-400 italic text-xs uppercase tracking-widest font-black">ç›®å‰å°šç„¡æ¡è³¼ä»»å‹™</p>
            </div>
        </div>`;
}


/** ğŸ¨ è¼”åŠ©ï¼šå–®å¼µå¡ç‰‡å…ƒä»¶ (v3.9.2 ç‰©ç†å°ä½ä¿®æ­£ç‰ˆ) */
function renderSingleShoppingCard(item) {
    const checked = item.checked ? 'checked' : '';
    const lineThrough = item.checked ? 'line-through text-gray-400 opacity-60' : 'text-gray-800';
    const totalCost = (item.price || 0) * (item.quantity || 1);
    
    // ğŸŒŸ ä¿®æ­£é» 1ï¼šåœ°æ¨™æœå°‹é‚è¼¯å°ä½
    const mapSearch = item.store || item.address || item.name;
    // æ¡ç”¨èˆ‡è¡Œç¨‹å¡ç‰‡ä¸€è‡´çš„æ™ºæ…§åœ°åœ–é€£çµæ ¼å¼
    const googleMapLink = item.mapUrl || `http://googleusercontent.com/maps.google.com/maps?q=${encodeURIComponent(mapSearch)}`;
    
    // ğŸŒŸ ä¿®æ­£é» 2ï¼šåœ–ç‰‡æœå°‹é€£çµå°ä½
    const imageSearchUrl = item.imageSearchUrl || `https://www.google.com/search?q=${encodeURIComponent(item.name)}&tbm=isch`;

    return `
        <div class="shopping-item-card p-4 bg-white border border-gray-100 rounded-2xl shadow-sm hover:border-pink-200 transition-all duration-300">
            <div class="flex justify-between items-start">
                <label class="flex items-center flex-1 min-w-0 cursor-pointer">
                    <input type="checkbox" ${checked} class="form-checkbox text-pink-500 h-5 w-5 rounded-lg border-gray-300 focus:ring-pink-500 transition" 
                           onclick="event.stopPropagation(); toggleShoppingItemChecked('${item.id}')">
                    <div class="ml-3 flex flex-col min-w-0">
                        <span class="font-black text-sm ${lineThrough} truncate">${item.name}</span>
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">
                            ${state.currency} ${item.price?.toLocaleString()} Ã— ${item.quantity}
                        </span>
                    </div>
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-black theme-text-pink">${state.currency} ${totalCost.toLocaleString()}</span>
                    <div class="flex gap-1" onclick="event.stopPropagation();">
                        <button onclick="deleteShoppingItem('${item.id}')" class="p-1 text-slate-200 hover:text-red-500 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-[10px] text-gray-300 pt-2 border-t border-gray-50 mt-2 flex justify-between items-center font-bold">
                <div class="flex items-center gap-2 truncate">
                    <span>ğŸ“ <a href="${googleMapLink}" target="_blank" class="theme-text-pink underline decoration-dotted hover:opacity-70 transition-opacity">${item.store || 'æœªå®šåœ°é»'}</a></span>
                    <a href="${imageSearchUrl}" target="_blank" class="text-blue-400 hover:underline">ğŸ–¼ï¸ æœåœ–</a>
                </div>
                ${item.fromFuel ? '<span class="bg-amber-50 text-amber-500 px-1.5 py-0.5 rounded italic text-[8px] uppercase tracking-tighter shadow-sm">Fuel Pack</span>' : ''}
            </div>
        </div>`;
}


/** âœ¨ ä¿®æ­£ 2ï¼šè³¼ç‰©å°ˆç”¨çš„å±€éƒ¨è¨Šæ¯é¡¯ç¤ºå‡½æ•¸ */
function showShoppingLocalMessage(text, type = 'success') {
    const msgEl = document.getElementById('shopping-local-msg');
    if (!msgEl) {
        // é€€å›å…¨å±€é¡¯ç¤ºï¼Œä»¥é˜²è¬ä¸€
        showMessage(text, type);
        return;
    }

    const colors = {
        success: 'bg-green-100 text-green-700 border border-green-200',
        error: 'bg-red-100 text-red-700 border border-red-200',
        warning: 'bg-amber-100 text-amber-700 border border-amber-200',
        info: 'bg-blue-100 text-blue-700 border border-blue-200'
    };

    msgEl.className = `mb-4 p-3 rounded-xl text-xs font-black transition-all ${colors[type] || colors.success}`;
    msgEl.innerHTML = text;
    msgEl.style.display = 'block';

    setTimeout(() => {
        msgEl.style.display = 'none';
    }, 3000);
}


/** 2. ç‹€æ…‹ç®¡ç†ï¼šåˆ‡æ›ã€æ–°å¢ã€åˆªé™¤ */
function toggleShoppingItemChecked(itemId) {
    const item = state.shoppingList.find(i => i.id === itemId);
    if (item) {
        item.checked = !item.checked;
        saveData();
        renderShoppingList();
    }
}

/** 2. æ–°å¢è³¼ç‰©é …ç›®ï¼šç‰©ç†å­˜å„²ç‰ˆ */
async function addNewShoppingItem() {
    const name = document.getElementById('new-shopping-name').value.trim();
    const quantity = parseInt(document.getElementById('new-shopping-quantity').value) || 1;
    const price = parseFloat(document.getElementById('new-shopping-price').value) || 0;
    
    if (!name) return showShoppingLocalMessage('è«‹è¼¸å…¥å“å', 'error');

    state.shoppingList.push({
        id: generateUUID(),
        name, quantity, price,
        store: document.getElementById('new-shopping-store')?.value.trim() || "",
        checked: false, isAI: false, fromFuel: false
    });

    await saveData(true); // ğŸŒŸ é—œéµï¼šå¼·åˆ¶åŒæ­¥ç‰©ç†ç£å€
    renderShoppingList();
    showShoppingLocalMessage('âœ… å·²åŒæ­¥è‡³ç‰©ç†è³‡æ–™åº«', 'success');
}

/** 3. åˆªé™¤é …ç›®ï¼šç‰©ç†æ’¤ç·¨ç‰ˆ */
async function deleteShoppingItem(itemId) {
    if (!confirm('ç¢ºå®šè¦å¾ç‰©ç†ç£å€æ°¸ä¹…åˆªé™¤å—ï¼Ÿ')) return;
    state.shoppingList = state.shoppingList.filter(item => item.id !== itemId);
    await saveData(true); // ğŸŒŸ é—œéµï¼šå¼·åˆ¶åŒæ­¥ç‰©ç†ç£å€
    renderShoppingList();
    showShoppingLocalMessage('ğŸ—‘ï¸ é …ç›®å·²æ’¤ç·¨', 'info');
}

/** â›½ ç‡ƒæ–™åŒ…å°ˆå±¬ï¼šå¾å­—å…¸è‡ªå‹•å°å…¥è³¼ç‰©é …ç›® (v4.1 ç‰©ç†åŒæ­¥ç‰ˆ)
 * ä¿®æ­£ï¼šå¼·åŒ– saveData(true) ç‰©ç†è½åœ°ï¼Œå„ªåŒ– ID åˆ†æµé‚è¼¯
 */
async function importFuelToShopping() {
    // ğŸ›¡ï¸ 1. å®ˆè¡›æª¢æŸ¥
    if (!state.bucketList || state.bucketList.length === 0) {
        showShoppingLocalMessage('å­—å…¸åº«ç›®å‰ç©ºç©ºå¦‚ä¹Ÿï¼Œç„¡æ³•å°å…¥ç‡ƒæ–™ã€‚', 'info');
        return;
    }

    // ğŸŒŸ 2. ç¯©é¸å­—å…¸ä¸­æ¨™è¨˜ç‚ºã€Œè³¼ã€æˆ–åç¨±åŒ…å«è³¼ç‰©é—œéµå­—çš„é …ç›®
    const shoppingFuel = state.bucketList.filter(item => {
        const hasTag = item.tags && (item.tags.includes('è³¼') || item.tags.includes('è³¼ç‰©'));
        const hasCategory = item.category === 'è³¼' || item.mainCat === 'è³¼';
        return hasTag || hasCategory;
    });

    if (shoppingFuel.length === 0) {
        showShoppingLocalMessage('å­—å…¸ä¸­æ‰¾ä¸åˆ°å¸¶æœ‰ã€è³¼ã€‘æ¨™ç±¤çš„ç‰©è³‡ã€‚', 'warning');
        return;
    }

    let addedCount = 0;
    shoppingFuel.forEach(fuel => {
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼è³¼ç‰©æ¸…å–®ï¼ˆé¿å…åç¨±é‡è¤‡å°å…¥ï¼‰
        const isExists = state.shoppingList.some(s => s.name === fuel.name);
        
        if (!isExists) {
            state.shoppingList.push({
                // âœ¨ ä¿®æ­£ï¼šçµ¦äºˆè³¼ç‰©æ¸…å–®å°ˆå±¬çš„å¯¦é«” ID
                id: 'shop-' + generateUUID(), 
                name: fuel.name,
                quantity: 1,
                price: parseFloat(fuel.price) || 0,
                store: fuel.store || fuel.address || fuel.location || 'ç‡ƒæ–™ä¾†æºæœªæŒ‡å®šåœ°é»',
                checked: false,
                isAI: false,
                fromFuel: true,
                sourceBucketId: fuel.id // ä¿ç•™ä¾†æºè¿½è¹¤
            });
            addedCount++;
        }
    });

    // ğŸŒŸ 3. ç‰©ç†è½åœ°èˆ‡ UI é‡ç¹ª
    if (addedCount > 0) {
        // âœ¨ æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ force=true ç©¿é€æ›´æ–°é–
        await saveData(true); 
        renderShoppingList();
        
        showShoppingLocalMessage(`âœ¨ è£œçµ¦æˆåŠŸï¼å·²å¾ç‰©ç†å­—å…¸è‡ªå‹•å°å…¥ ${addedCount} ç­†é …ç›®ã€‚`, 'warning');
        console.log(`ğŸ›’ [Shopping-Import] æˆåŠŸå¾å­—å…¸æ¬é‹ ${addedCount} ç­†è³‡ç”¢`);
    } else {
        showShoppingLocalMessage('â„¹ï¸ å­—å…¸ä¸­çš„é …ç›®çš†å·²åœ¨æ¸…å–®ä¸­ï¼Œç„¡éœ€é‡è¤‡å°å…¥ã€‚', 'info');
    }
}


/** 3. è¡Œç¨‹é€£å‹•ï¼šé–‹å•Ÿå®‰æ’æ¨¡æ…‹æ¡† */
function openAddToScheduleModal(itemId, itemName) {
    document.getElementById('item-id-for-schedule').value = itemId;
    document.getElementById('schedule-item-display-name').innerText = itemName;
    toggleModal('add-to-schedule-modal');
}

/** 4. AI ä»£å°‹ä»‹é¢æ§åˆ¶ (Bug ä¿®æ­£èˆ‡ç‡ƒæ–™åŒ–å¢å¼·ç‰ˆ) */
function openAIShoppingModal() {
    // ç¢ºä¿åŸºç¤è¼¸å…¥æ¡†å­˜åœ¨å¾Œè³¦å€¼
    const cityEl = document.getElementById('ai-search-city');
    const currencyEl = document.getElementById('ai-search-currency');
    const itemEl = document.getElementById('ai-search-item');
    const resultEl = document.getElementById('ai-shopping-result');

    if (cityEl) cityEl.value = state.aiShoppingConfig.city || "";
    if (currencyEl) currencyEl.value = state.aiShoppingConfig.currency || "JPY";
    if (itemEl) itemEl.value = ''; 

    // âœ¨ æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ if å®ˆè¡›é¿å… null å ±éŒ¯
    if (resultEl) {
        resultEl.innerHTML = '<p class="text-[10px] text-blue-400 italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒAI å°‡æƒæå°ˆæ¥­è³£å ´èˆ‡ç²¾æº–åƒ¹æ ¼</p>';
    } else {
        console.warn("âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ° 'ai-shopping-result' å®¹å™¨ï¼Œè«‹ç¢ºèªè³¼ç‰©é é¢å·²å®Œå…¨æ¸²æŸ“ã€‚");
    }
    
    toggleModal('ai-shopping-settings-modal');
}

/** ğŸ¯ è³¼ç‰©å°ˆç”¨ AI æŒ‡ä»¤ 2.0 (å°ä½è³¼ç‰©è»Šé‚è¼¯) */
function copyShoppingAIPrompt() {
    const city = state.aiShoppingConfig.city || "æ—¥æœ¬ç•¶åœ°";
    const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æœ¬æ—…éŠèˆ‡å°ˆæ¥­æ¡è³¼çš„å°ˆå®¶ã€‚
è«‹é‡å°ã€Œ${city}ã€æä¾› 5-8 å€‹ç†±é–€å¿…è²·æˆ–å°ˆæ¥­é ˜åŸŸå•†å“ï¼Œä¸¦ä»¥ã€ç‡ƒæ–™åŒ…ã€‘æ ¼å¼è¼¸å‡ºã€‚

ğŸš¨ æ ¼å¼è¦ç¯„ï¼š
1. è¼¸å‡ºç‚ºç´” JSON é™£åˆ—ï¼Œä¸å«è§£é‡‹æ–‡å­—ã€‚
2. åŒ…å«æ¬„ä½ï¼šname (å“å), price (æ—¥å¹£å«ç¨…åƒ¹æ•¸å­—), store (å…·é«”æ¨è–¦åº—é‹ª), quantity (1), tags (["è³¼"]), info (å•†å“ç‰¹è‰²)ã€‚
3. image_query è«‹è¨­ç‚º "[å“ç‰Œ] [å“å] official product photo"ã€‚

ç¯„ä¾‹æ ¼å¼ï¼š
[
  {
    "name": "åˆåˆ©ä»–å‘½ EX PLUS (270éŒ )",
    "price": 6200,
    "store": "æ¾æœ¬æ¸… / OS Drug",
    "quantity": 1,
    "tags": ["è³¼"],
    "info": "ç¶“å…¸ç¶­ä»–å‘½ï¼Œå°æ¯”åƒ¹æ ¼å¾Œè³¼å…¥"
  }
]`;

    navigator.clipboard.writeText(prompt).then(() => {
        showMessage('âœ… è³¼ç‰© AI æŒ‡ä»¤å·²è¤‡è£½ï¼', 'success');
    });
}

/** ğŸš€ è™•ç†è³¼ç‰©ç‡ƒæ–™åŒ…åŒæ­¥è½‰æ› (v4.6 æ¨™ç±¤å°ä½ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. è£œé½Š category å±¬æ€§ï¼Œç¢ºä¿æ¸²æŸ“å¼•æ“èƒ½æ­£ç¢ºç”Ÿæˆå¤šæ¨™ç±¤ã€‚
 * 2. å¼·åŒ– saveData(true) ç‰©ç†è½åœ°ï¼Œç¢ºä¿æ•¸æ“šä¸å›å½ˆã€‚
 */
async function processShoppingFuel() {
    const inputEl = document.getElementById('shopping-fuel-input');
    const rawData = inputEl ? inputEl.value.trim() : "";

    if (!rawData) {
        showShoppingLocalMessage('è«‹å…ˆè²¼ä¸Š JSON ç‡ƒæ–™æ•¸æ“šï¼', 'error');
        return;
    }

    // ğŸ›¡ï¸ 0. å•Ÿå‹•åŸå­é–
    window.isTransportUpdating = true;

    try {
        const fuelItems = JSON.parse(rawData);
        const itemsToProcess = Array.isArray(fuelItems) ? fuelItems : [fuelItems];
        
        let addedShopping = 0;
        let addedBucket = 0;

        itemsToProcess.forEach(item => {
            const commonId = generateUUID(); 
            const itemName = item.name || "æœªå‘½åå•†å“";
            const itemPrice = parseFloat(item.price) || 0;
            const itemStore = item.store || item.address || "æœªæŒ‡å®šåœ°é»";
            const itemNotes = item.info || item.notes || "";
            // ğŸŒŸ é—œéµä¿®æ­£ï¼šæå–é¡åˆ¥æ¬„ä½
            const itemCat = item.category || item.mainCat || "ä¸€èˆ¬";

            // ğŸŒŸ 1. æ³¨å…¥è³¼ç‰©æ¸…å–® (Shopping List)
            state.shoppingList.push({
                id: 'shop-' + commonId,
                name: itemName,
                quantity: item.quantity || 1,
                price: itemPrice,
                category: itemCat, // â¬…ï¸ è£œé½Šæ­¤æ¬„ä½ï¼Œæ¨™ç±¤æ‰æœƒå‡ºç¾
                store: itemStore,
                checked: false,
                isAI: false,
                fromFuel: true,
                notes: itemNotes
            });
            addedShopping++;

            // ğŸŒŸ 2. æ³¨å…¥æ™¯é»å­—å…¸ (Bucket List)
            const isExistsInBucket = state.bucketList.some(b => b.name === itemName);
            if (!isExistsInBucket) {
                state.bucketList.push({
                    id: 'bucket-' + commonId,
                    name: itemName,
                    category: "è³¼",
                    mainCat: itemCat, // â¬…ï¸ åŒæ­¥å­˜å„²ç´°åˆ†åˆ†é¡
                    tags: item.tags || ["è³¼", itemCat],
                    price: itemPrice,
                    location: itemStore,
                    notes: itemNotes,
                    isAdded: false,
                    lastUpdate: new Date().toISOString()
                });
                addedBucket++;
            }
        });

        // ğŸ’¾ 3. åŸ·è¡Œç‰©ç†ç´šå­˜æª”
        if (typeof saveData === 'function') {
            await saveData(true); 
        }

        // ğŸ”„ 4. UI é‡ç¹ª (é€™æœƒè§¸ç™¼ renderShoppingList)
        renderShoppingList();
        
        const grid = document.getElementById('bucket-items-grid');
        if (grid && typeof renderBucketItems === 'function') renderBucketItems();

        if (inputEl) inputEl.value = '';

        const msg = `âœ¨ é›™å‘åŒæ­¥æˆåŠŸï¼è³¼ç‰©è»Š +${addedShopping}ï¼Œå­—å…¸åº« +${addedBucket}`;
        showShoppingLocalMessage(msg, 'success');

    } catch (e) {
        console.error("JSON è§£æå¤±æ•—", e);
        showShoppingLocalMessage('âŒ ç‡ƒæ–™æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹ç¢ºèª AI è¼¸å‡ºæ˜¯å¦ç‚ºæ¨™æº– JSONï¼', 'error');
    } finally {
        window.isTransportUpdating = false;
    }
}

/** 3. æ ¸å¿ƒ AI ä»£å°‹é‚è¼¯ (v2.2 2026 æ——è‰¦å°ä½ç‰ˆ) */
async function fetchAIShoppingLocation() {
    const query = document.getElementById('ai-search-item').value.trim();
    const resultEl = document.getElementById('ai-shopping-result');
    const city = state.aiShoppingConfig.city || "ç•¶åœ°";

    if (!query || !state.theme.geminiKey) return;

    resultEl.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-pink-500 border-t-transparent mx-auto mb-4"></div>
            <p class="text-gray-600 text-sm font-black animate-pulse">æ­£åœ¨æ·±åº¦æŒ–æ˜ã€Œ${city}ã€çš„å°ˆæ¥­è³£å ´è³‡è¨Š...</p>
        </div>`;

    const apiKey = state.theme.geminiKey;
    // ğŸš€ å‡ç´šï¼šé–å®š 2.0 å¼•æ“
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    const searchPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æœ¬å„é¡å•†å“çš„å°ˆæ¥­æ¡è³¼ã€‚è«‹é‡å°ã€Œ${query}ã€åœ¨ã€Œ${city}ã€æä¾› 10 ç­†å°ˆæ¥­æ¨è–¦ã€‚
    è¦æ±‚ï¼šåŒ…å«é€£é–è³£å ´èˆ‡è‡³å°‘ 3 ç­†è·äººè€åº—ã€‚è«‹å›å‚³ç´” JSON é™£åˆ—ã€‚`;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: searchPrompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });

        const result = await response.json();
        // ğŸŒŸ çµ±è¨ˆè²»ç”¨
        if (result.usageMetadata) trackApiUsage(result.usageMetadata, 'flash');

        const data = JSON.parse(result.candidates[0].content.parts[0].text);
        const aiResults = data.items || data;

        aiResults.forEach(item => {
            state.shoppingList.push({
                id: generateUUID(),
                name: item.name,
                quantity: 1,
                price: parseFloat(item.price) || 0,
                store: item.store || item.map_query,
                checked: false,
                isAI: true,
                fromFuel: false,
                imageSearchUrl: `https://www.google.com/search?q=${encodeURIComponent(item.image_query || item.name)}&tbm=isch`,
                // ğŸŒŸ ä¿®æ­£é»ï¼š${ æ­£ç¢ºæ‹¼æ¥
                mapUrl: `http://googleusercontent.com/maps.google.com/maps?q=${encodeURIComponent((item.map_query || item.store) + ' ' + city)}`
            });
        });

        await saveData(true); // ç‰©ç†åŒæ­¥
        renderShoppingList();
        resultEl.innerHTML = `<p class="text-sm font-black text-emerald-600">âœ¨ æˆåŠŸï¼å·²åœ¨ç£å€æ–°å¢ ${aiResults.length} å€‹å°ˆæ¥­æ¨è–¦é …ç›®ã€‚</p>`;

    } catch (error) {
        console.error("AI è³¼ç‰©æœå°‹å¤±æ•—:", error);
        resultEl.innerHTML = `<p class="text-xs text-red-500 font-bold">âŒ æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key</p>`;
    }
}


// è³¼ç‰©æ¨¡çµ„çµæŸ

        
/**
 * é–‹å•Ÿæ–°å¢è‡³æ’ç¨‹æ¨¡æ…‹æ¡† (å…¨é€šè·¯å°æ­£ç‰ˆ v3.2)
 * ä¿®æ­£ï¼š
 * 1. å¼·åŒ–ä¾†æºè­˜åˆ¥ï¼Œç¢ºä¿ç‡ƒæ–™åŒ…é …ç›®èƒ½ç²¾æº–å‚³é IDã€‚
 * 2. è‡ªå‹•å°ç„¦ç•¶å‰å¤©æ•¸ï¼Œæå‡æ‰‹æ©Ÿç«¯æ“ä½œé«”æ„Ÿã€‚
 */
function openAddToScheduleModal(itemId, itemName) {
    const trip = getCurrentTrip();
    if (!trip || trip.days.length === 0) {
        showMessage('è«‹å…ˆå‰µå»ºè¡Œç¨‹ï¼', 'error');
        return;
    }

    // A. æ³¨å…¥æ ¸å¿ƒæ•¸æ“š
    const idInput = document.getElementById('item-id-for-schedule');
    const nameDisplay = document.getElementById('item-name-for-schedule') || document.getElementById('schedule-item-display-name');
    
    if (idInput) idInput.value = itemId;
    if (nameDisplay) nameDisplay.textContent = `ğŸ¯ æº–å‚™å®‰æ’ï¼š${itemName}`;

    // B. å‹•æ…‹æ§‹å»ºå¤©æ•¸é¸å–®
    const daySelect = document.getElementById('schedule-day-select');
    if (daySelect) {
        daySelect.innerHTML = trip.days.map((day, index) => 
            `<option value="${index}">ç¬¬ ${day.dayNum} å¤© (${day.date})</option>`
        ).join('');
        
        // æ™ºæ…§é–å®šï¼šé è¨­ç‚ºç›®å‰æ­£åœ¨ç€è¦½çš„å¤©æ•¸ï¼Œæ¸›å°‘é¸æ“‡æˆæœ¬
        daySelect.value = state.currentDayIndex || 0;
    }
    
    // C. å–šèµ·æ¨¡æ…‹æ¡†
    toggleModal('add-to-schedule-modal');
    
    // ğŸ“¢ æˆ°è¨Šå›å ±ï¼šé…åˆã€Œç‡ƒæ–™çµäººã€ä»»å‹™ç³»çµ±ï¼Œæ­¤è™•å¯é ç•™è§¸ç™¼é»
    console.log(`ğŸ“¡ å‚³é€é–€å•Ÿå‹•ï¼šé …ç›® [${itemName}] å·²å°±ç·’ï¼Œç›®æ¨™å¤©æ•¸ï¼šDay ${parseInt(daySelect.value) + 1}`);
}


/**
 * æäº¤æ–°å¢è‡³æ’ç¨‹ (v2.6.3 - æ™ºæ…§è¯å‹•èˆ‡ç‹€æ…‹å®ˆè¡›ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å°å…¥ state.lastAction ç‹€æ…‹æ¨™ç±¤ï¼Œé©…å‹• renderDayContent çš„è‡ªå‹•å°ç„¦ã€‚
 * 2. ç²¾ç¢ºå‘¼å« renderDayContent æ¸²æŸ“å¼•æ“ã€‚
 * 3. å„ªåŒ–éåŒæ­¥æ¸²æŸ“é †åºã€‚
 */
async function submitAddToSchedule() {
    const itemId = document.getElementById('item-id-for-schedule').value;
    const dayIndex = parseInt(document.getElementById('schedule-day-select').value);

    const trip = getCurrentTrip();
    const day = trip.days[dayIndex];

    const item = state.shoppingList.find(i => i.id === itemId) || 
                 (state.bucketList && state.bucketList.find(i => i.id === itemId));

    if (!item || !day) {
        showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼Œæ‰¾ä¸åˆ°é …ç›®æˆ–æ—¥æœŸã€‚', 'error');
        return;
    }

    const semanticResult = recognizeSemantic(item.name, item.tags || []);
    
    const newSchedule = {
        id: generateUUID(),
        name: `${item.name}${item.quantity ? ` (${item.quantity}å€‹)` : ''}`,
        startTime: day.startTime, 
        durationHours: semanticResult.parent === 'è¡Œ' ? 0.3 : 1.0, 
        address: item.address || item.store || 'è«‹åœ¨è¡Œç¨‹ä¸­è£œå……åœ°é»',
        notes: item.info || item.notes || `ä¾†æºå‚™è¨»: ${item.name}`,
        rainPlan: '',
        cost: item.price ? (item.price * (item.quantity || 1)).toString() : '0', 
        style: semanticResult.style, 
        category: semanticResult.parent, 
        customStyle: '',
        aiStory: '',
        aiPlus: ''
    };

    // ğŸ§  æ•¸æ“šå¯«å…¥é‚è¼¯
    if (state.planViewMode === 'workshop') {
        const workshopKey = `${trip.id}_day${day.dayNum}`;
        if (!state.shadowItineraries[workshopKey]) {
            state.shadowItineraries[workshopKey] = JSON.parse(JSON.stringify(day.schedules || []));
        }
        state.shadowItineraries[workshopKey].push(newSchedule);
        recalculateScheduleTimes({ schedules: state.shadowItineraries[workshopKey], startTime: day.startTime });
    } else {
        day.schedules.push(newSchedule);
        recalculateScheduleTimes(day); 
    }
    
    // ğŸ›¡ï¸ ç‹€æ…‹è®Šæ›´ï¼šé–å®šæ—¥æœŸä¸¦æ¨™è¨˜ç‚ºã€Œå‰›å®Œæˆå®‰æ’ã€
    state.currentDayIndex = dayIndex; 
    state.lastAction = 'inserted'; // âœ¨ é—œéµï¼šå‘Šè¨´æ¸²æŸ“å¼•æ“é€™æ˜¯ä¸€æ¬¡ç‰©è³‡ç©ºæŠ•
    
    toggleModal('add-to-schedule-modal');

    // ğŸ”„ UI éåŒæ­¥æ¸²æŸ“æµ
    setTimeout(() => {
        // 1. ç¢ºä¿è¦–åœ–åˆ‡æ›è‡³è¡Œç¨‹é 
        openProtectedSubView('itinerary');
        
        // 2. å‘¼å«æ ¸å¿ƒæ¸²æŸ“å¼•æ“ (è£¡é¢æœƒæª¢æŸ¥ state.lastAction ä¸¦åŸ·è¡Œè‡ªå‹•å°ç„¦)
        renderDayContent(); 
        
        showMessage(`âœ…ã€Œ${item.name}ã€å·²æˆåŠŸå®‰æ’ä¸¦è‡ªå‹•å°ç„¦ï¼`, 'success');

        // 3. é¡å¤–è£œå¼·ï¼šç‰©ç†é«˜äº®å‹•ç•«
        const eventCards = document.querySelectorAll('.schedule-card, .itinerary-item');
        if (eventCards.length > 0) {
            const lastCard = eventCards[eventCards.length - 1];
            lastCard.classList.add('new-highlight'); // ä½¿ç”¨æˆ‘å€‘æº–å‚™å¥½çš„ CSS
            lastCard.style.animation = "pulseHighlight 1.5s ease-out";
        }
    }, 50);

    // ğŸ’¾ èƒŒæ™¯å„²å­˜
    try {
        await Promise.resolve().then(() => saveData());
    } catch (e) {
        console.error("èƒŒæ™¯å„²å­˜ç•°å¸¸:", e);
    }
}




        /**
         * è¼”åŠ©å‡½æ•¸ï¼šå¾ AI éŸ¿æ‡‰ä¸­å®‰å…¨åœ°è§£æ JSONï¼Œå³ä½¿å®ƒè¢« markdown æ¨™è¨˜åŒ…åœã€‚
         * @param {string} rawText - åŒ…å« JSON çš„åŸå§‹æ–‡æœ¬
         * @returns {object} è§£æå¾Œçš„ JSON ç‰©ä»¶
         */
        function safeJsonParse(rawText) {
            if (!rawText) throw new Error("åŸå§‹æ–‡æœ¬ç‚ºç©ºã€‚");
            
            let jsonString = rawText.trim();
            
            // å˜—è©¦å¾ ```json...``` å€å¡Šä¸­æå–
            const match = jsonString.match(/```json\s*([\s\S]*?)\s*```/);
            if (match && match[1]) {
                jsonString = match[1].trim();
            } else {
                // å¦‚æœæ²’æœ‰æ‰¾åˆ° markdown å€å¡Šï¼Œå˜—è©¦ç§»é™¤å¸¸è¦‹çš„æ›è¡Œå’Œä¸éœ€è¦çš„å­—å…ƒ
                jsonString = jsonString.replace(/[\n\r]/g, '').trim();
            }

            // æœ€çµ‚æª¢æŸ¥æ˜¯å¦ç‚ºç©º
            if (!jsonString) throw new Error("ç„¡æ³•å¾æ–‡æœ¬ä¸­æå–æœ‰æ•ˆçš„ JSON å­—ç¬¦ä¸²ã€‚");

            // æœ€çµ‚ä¿®æ­£ï¼šå¦‚æœ AI ä¸éµå®ˆæŒ‡ä»¤ï¼Œé‚„æ˜¯è¿”å›äº†ç´”æ–‡æœ¬ï¼Œæˆ‘å€‘å˜—è©¦æ‰¾åˆ°ç¬¬ä¸€å€‹ [ æˆ– {
            try {
                // æª¢æŸ¥æ˜¯å¦ä»¥ [ æˆ– { é–‹å§‹
                if (jsonString.startsWith('{') || jsonString.startsWith('[')) {
                    // æ‰¾åˆ°çµæŸæ¨™è¨˜
                    const lastChar = jsonString.endsWith(']') ? ']' : (jsonString.endsWith('}') ? '}' : null);
                    
                    if (lastChar) {
                        const startIndex = jsonString.startsWith('{') ? jsonString.indexOf('{') : jsonString.indexOf('[');
                        const endIndex = jsonString.lastIndexOf(lastChar) + 1;
                        jsonString = jsonString.substring(startIndex, endIndex);
                    }
                }
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("JSON.parse å¤±æ•—ï¼Œå˜—è©¦è§£æçš„å­—ç¬¦ä¸²:", jsonString);
                throw new Error(`JSON è§£æéŒ¯èª¤: ${e.message}. åŸå§‹å­—ä¸²: ${jsonString.substring(0, 50)}...`);
            }
        }


/** ğŸ› ï¸ æ•´åˆå‹è¨­å®šè¦–åœ– (v4.8)ï¼šåŠŸèƒ½èšç„¦ç‰ˆ */
async function renderSettingsView() {
    const el = document.getElementById('settings-view');
    if (!el) return;

    // 1. ğŸŒŸ ç‹€æ…‹é–å®š (ç§»é™¤ checklist é è¨­)
    if (!window.activeSettingTab || window.activeSettingTab === 'checklist') {
        window.activeSettingTab = 'theme'; 
    }
    
    const colorConfig = await dbManager.get('config_store', 'THEME_COLORS');
    const colors = colorConfig ? colorConfig.data : (window.THEME_COLORS || {});
    const matrices = await dbManager.getAll('matrix_store');

    // 2. å®šç¾©æ¨™ç±¤é›† (å·²ç§»é™¤ Checklist)
    const tabs = [
        { id: 'theme', name: 'ä½ˆæ™¯ä¸»é¡Œ', icon: 'ğŸ¨' },
        { id: 'engine', name: 'ç‰©ç†è£œçµ¦', icon: 'ğŸš€' },
        { id: 'console', name: 'ç³»çµ±çµ‚ç«¯', icon: 'ğŸ“Ÿ' }
    ];

    const tabsHtml = tabs.map(t => `
        <button onclick="switchSettingTab('${t.id}')" 
                class="inline-block whitespace-nowrap px-10 py-3.5 rounded-2xl text-[13px] font-black transition-all active:scale-95 ${
                    window.activeSettingTab === t.id 
                    ? 'theme-bg theme-text-white shadow-xl scale-105 z-10' 
                    : 'bg-white text-slate-400 border border-slate-100 hover:border-pink-200'
                }">
            <span class="mr-2">${t.icon}</span>${t.name}
        </button>
    `).join('');

    el.innerHTML = `
        <div class="w-full max-w-2xl mx-auto space-y-6 pb-32 animate-in fade-in duration-500 px-4 overflow-hidden">
            <div class="sticky top-0 bg-[#f8f8f8]/95 backdrop-blur-md z-30 -mx-4 px-4">
                <div class="grid grid-flow-col auto-cols-max gap-4 overflow-x-auto no-scrollbar py-6">
                    ${tabsHtml}
                    <div class="w-8"></div>
                </div>
            </div>
            <div id="setting-tab-content" class="min-h-[500px] w-full">
                ${await getActiveSettingTemplate(window.activeSettingTab, { colors, matrices })}
            </div>
        </div>
    `;
    
    // å¦‚æœé€²å…¥ä¸»æ§å°ï¼Œè‡ªå‹•æ»¾å‹•æ—¥èªŒåˆ°åº•éƒ¨
    if (window.activeSettingTab === 'console') {
        const logger = document.getElementById('virtual-console-log');
        if (logger) logger.scrollTop = logger.scrollHeight;
    }
}

/** ğŸ› ï¸ å­å‡½æ•¸ï¼šåˆ‡æ›åˆ†é é‚è¼¯ */
function switchSettingTab(tabId) {
    window.activeSettingTab = tabId;
    renderSettingsView(); // å±€éƒ¨é‡ç¹ª
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/** ğŸ¨ å­å‡½æ•¸ï¼šå…§å®¹åˆ†æµæ¨¡æ¿ä¸­å¿ƒ (v4.9.5 ç‰©ç†å°ä½æ——è‰¦ä¿®æ­£ç‰ˆ)
 * ä¿®æ­£èªªæ˜ï¼š
 * 1. [ID ç‰©ç†é–å®š] å°‡è¼¸å…¥æ¡† ID çµ±ä¸€å®šç¾©ç‚º 'json-fuel-input'ï¼Œå°æ‡‰ v4.5 æ³¨å…¥å¼•æ“ã€‚
 * 2. [è·¨é é©é…] ç¢ºä¿ä¸è«–åœ¨ 'engine' é‚„æ˜¯ 'console' åˆ†é ï¼Œç‰©ç†å¯«å…¥é‚è¼¯çš†ä¸€è‡´ã€‚
 * 3. [è¦–åœ–è¯å‹•] æ³¨å…¥æˆåŠŸå¾Œæœƒè‡ªå‹•è§¸ç™¼ renderSettingsView ä¿æŒç‹€æ…‹åŒæ­¥ã€‚
 */
async function getActiveSettingTemplate(tab, dbData) {
    // é ç®— API KEY é®è”½é¡¯ç¤ºæ–‡å­— (ç”¨æ–¼ UI åˆå§‹åŒ–)
    const geminiDisplay = state.theme.geminiKey ? '****************' : '';

    switch(tab) {
        case 'theme':
            return `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                    <h4 class="text-sm font-black text-slate-800 border-b border-slate-50 pb-4 flex items-center gap-2">
                        <span>ğŸ¨</span> ä½ˆæ™¯ç¾å­¸ç‰©ç†ä¸­å¿ƒ
                    </h4>
                    <div class="grid grid-cols-3 gap-4">
                        ${Object.entries(dbData.colors).map(([name, hex]) => `
                            <div onclick="state.theme.primary='${hex}'; applyTheme(); renderSettingsView();" 
                                 class="cursor-pointer flex flex-col items-center gap-3 p-3 rounded-2xl transition-all border-2 ${state.theme.primary === hex ? 'theme-bg-light theme-border-pink shadow-md' : 'bg-slate-50 border-transparent hover:bg-white'}">
                                <div class="w-10 h-10 rounded-xl shadow-inner border-2 border-white" style="background-color: ${hex}"></div>
                                <span class="text-[10px] font-black text-slate-500 text-center break-all">${name}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="space-y-4">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">UI æ¸²æŸ“å¯†åº¦ (Density)</label>
                        <div class="grid grid-cols-3 gap-2">
                            ${['ç²¾ç°¡', 'æ¨™æº–', 'è©³ç´°'].map(mode => `
                                <button class="py-3 rounded-xl text-xs font-bold border transition-all ${mode === 'æ¨™æº–' ? 'theme-border-pink theme-text-pink bg-pink-50 shadow-sm' : 'bg-white border-slate-100 text-slate-400'}">${mode}</button>
                            `).join('')}
                        </div>
                    </div>
                </div>`;

        case 'engine':
            return `
                <div class="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-sm font-black text-slate-800">ğŸš€ æ•¸æ“šå¤§ä¸€çµ±è£œçµ¦ç«™</h4>
                            <span class="text-[9px] px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded-full font-bold">V4.5 Protocol</span>
                        </div>
                        <textarea id="json-fuel-input" 
                            class="w-full h-32 p-4 text-[10px] font-mono bg-slate-50 rounded-[1.5rem] border-none outline-none focus:ring-2 theme-border-pink mb-4" 
                            placeholder='ç›´æ¥è²¼å…¥ã€Œæ™¯é»å­—å¡ã€æˆ–ã€Œè·¯ç¶²æ•¸æ“šã€JSON...'></textarea>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="importTransportFuel()" 
                                class="py-4 theme-bg theme-text-white rounded-2xl font-black text-sm shadow-xl active:scale-[0.98] transition-all">
                                âš¡ åŸ·è¡Œè½‰æ›
                            </button>
                            <button onclick="document.getElementById('json-fuel-input').value=''" 
                                class="py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                                æ¸…ç©º
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <p class="text-[10px] text-slate-400 font-black uppercase mb-4 tracking-widest">ç§»å‹•æ¬Šé‡ç¾æ³ (Matrix)</p>
                        <div class="max-h-40 overflow-y-auto space-y-2 no-scrollbar">
                            ${dbData.matrices.length === 0 ? '<p class="text-xs text-slate-300 italic">å°šæœªè¼‰å…¥æ¬Šé‡çŸ©é™£</p>' : 
                              dbData.matrices.map(m => `<div class="flex justify-between border-b border-slate-50 pb-1 text-[11px] font-mono"><span class="text-slate-500">${m.routeKey}</span><span class="theme-text-pink font-black">${m.time}m</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;

        case 'console':
            return `
                <div class="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-sm font-black text-slate-800">ğŸ”‘ Gemini AI é€šè¨Šå¯†é‘°</h4>
                            <span class="text-[9px] font-black theme-text-pink uppercase tracking-widest">Secure Link</span>
                        </div>
                        <div class="relative">
                            <input type="password" id="gemini-api-key-input" 
                                   value="${geminiDisplay}"
                                   onblur="handleKeyPersistence(this)"
                                   onfocus="this.type='text'; if(this.value.includes('*')) this.value='';"
                                   class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 theme-border-pink text-sm font-mono tracking-wider transition-all" 
                                   placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API KEY...">
                        </div>
                        <p class="mt-3 text-[10px] text-slate-400 font-bold px-1 flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                            API å¯†é‘°å·²é€£å‹•ç‰©ç†ç£å€ï¼Œé‡æ•´ä¸éºå¤±ã€‚
                        </p>
                    </div>

                    <div class="bg-slate-900 p-6 rounded-[2.5rem] shadow-2xl border border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-[10px] font-mono text-emerald-500 font-bold uppercase tracking-widest">Traveler Terminal v28.0</h4>
                            <button onclick="clearSystemLog()" class="text-[9px] text-slate-500 hover:text-white font-bold uppercase underline">Clear</button>
                        </div>
                        
                        <div id="virtual-console-log" class="h-48 overflow-y-auto font-mono text-[9px] text-emerald-400/80 space-y-1 p-3 bg-black/40 rounded-2xl mb-4 no-scrollbar border border-white/5 shadow-inner">
                            <p class="text-slate-500">> [${new Date().toLocaleTimeString()}] System Core Online.</p>
                            <p class="text-slate-500">> [${new Date().toLocaleTimeString()}] Commands Ready: help, status, storage, audit-assets.</p>
                        </div>

                        <div class="relative flex items-center bg-black/40 rounded-xl border border-white/10 focus-within:border-emerald-500/50 transition-all">
                            <span class="pl-3 text-emerald-500 font-mono text-sm">>></span>
                            <input type="text" id="terminal-input" 
                                   onkeypress="if(event.key === 'Enter') executeTerminalCommand(this.value)"
                                   class="w-full p-3 bg-transparent border-none outline-none text-xs font-mono text-white placeholder:text-slate-600" 
                                   placeholder="è¼¸å…¥æŒ‡ä»¤...">
                        </div>
                    </div>
                </div>`;
        
        default: return ``;
    }
}

/** ğŸ”‘ ä¿®æ­£ç‰ˆï¼šAPI KEY ç‰©ç†é–å®šåŸ·è¡Œç·’ */
async function handleKeyPersistence(inputEl) {
    const key = inputEl.value.trim();
    
    // ğŸ›¡ï¸ 1. å®‰å…¨éæ¿¾ï¼šè‹¥ç‚ºé®è”½ç¢¼æˆ–ç©ºå€¼å‰‡ä¸å‹•ä½œ
    if (key === '****************' || key === "") {
        if (!state.theme.geminiKey) inputEl.value = "";
        return;
    }

    console.log("ğŸ“¡ [Security-Gate] åµæ¸¬åˆ°å¯†é‘°è®Šå‹•ï¼Œå•Ÿå‹•ç£å€å›ºåŒ–ç¨‹åº...");
    
    // ğŸŒŸ 2. é›™é‡åŒæ­¥ï¼šåŒæ­¥è¨˜æ†¶é«”ä¸¦æº–å‚™ç‰©ç†è½åœ°
    state.theme.geminiKey = key;
    
    // ğŸŒŸ 3. å¼·åˆ¶ç‰©ç†å­˜æª” (ä½¿ç”¨ force=true æ“Šç©¿åŸå­é–)
    // é€™èƒ½è§£æ±ºæ—¥èªŒä¸­ã€ŒåŸå­æ›´æ–°é–å®šä¸­ï¼Œè·³éå­˜æª”ã€å°è‡´ Key éºå¤±çš„å•é¡Œ
    if (typeof saveData === 'function') {
        await saveData(true); 
    }
    
    // 4. UI è„«æ•
    inputEl.type = 'password';
    inputEl.value = '****************';
    showMessage('âœ… API KEY å·²ç‰©ç†é–å®šè‡³è³‡æ–™åº«', 'success');
}

/** ğŸ“Ÿ ç³»çµ±çµ‚ç«¯æ©Ÿ v32.0 (å°è©±é…å°å°ä½ç‰ˆ)
 * å„ªåŒ–é …ç›®ï¼š
 * 1. [å°ä½è¤‡è£½] é»æ“Š COPY æŒ‰éˆ•å°‡åŒæ™‚æå–ã€ŒæŒ‡ä»¤ (Q)ã€èˆ‡ã€Œçµæœ (A)ã€ï¼Œä¿ç•™é™¤éŒ¯ä¸Šä¸‹æ–‡ã€‚
 * 2. [é‚è¼¯åˆ†çµ„] æ¯ä¸€è¼ªæŒ‡ä»¤é€±æœŸè‡ªå‹•å°è£ç‚ºä¸€å€‹ Groupï¼Œè¦–è¦ºèˆ‡é‚è¼¯åŒæ­¥ã€‚
 * 3. [æµ·å¤–è¨ºæ–·] å®Œæ•´ä¿ç•™ ping, env, deep-scan ç­‰æµ·å¤–å„ªåŒ–æŒ‡ä»¤ã€‚
 */
async function executeTerminalCommand(cmd) {
    const log = document.getElementById('virtual-console-log');
    const input = document.getElementById('terminal-input');
    const rawInput = cmd.trim();
    if (!rawInput) return;

    // ğŸŒŸ ç”Ÿæˆæœ¬è¼ªå°è©±çš„å”¯ä¸€ ID
    const groupId = `pair-${Date.now()}`;
    
    // å»ºç«‹å°è©±çµ„å®¹å™¨
    log.insertAdjacentHTML('beforeend', `<div id="${groupId}" class="terminal-pair group relative mb-6 border-l-2 border-slate-700/50 pl-3 transition-colors hover:border-emerald-500/50"></div>`);
    const groupContainer = document.getElementById(groupId);

    // --- ğŸ¨ é…å°æ¸²æŸ“å™¨ ---
    const print = (text, type = 'answer', color = 'text-emerald-400') => {
        const isObj = typeof text === 'object' && text !== null;
        const content = isObj ? JSON.stringify(text, null, 2) : text;
        const timestamp = new Date().toLocaleTimeString();
        
        const html = `
            <div class="log-line mb-1 ${type === 'query' ? 'text-slate-400 italic' : color} font-mono animate-in fade-in slide-in-from-left-1">
                <span class="text-[10px] opacity-20 mr-2">${type === 'query' ? 'Q' : 'A'}</span>
                <span class="content-text">${isObj ? `<pre class="bg-black/40 p-2 rounded-lg mt-1 text-[10px] text-cyan-200 border border-white/5">${content}</pre>` : content}</span>
                <textarea class="raw-data hidden opacity-0 absolute pointer-events-none">${content}</textarea>
            </div>
        `;
        groupContainer.insertAdjacentHTML('beforeend', html);
        
        // æ¸²æŸ“è¤‡è£½æŒ‰éˆ• (åƒ…åœ¨ç¬¬ä¸€è¡Œæ¸²æŸ“æ™‚åŠ å…¥)
        if (!groupContainer.querySelector('.copy-trigger')) {
            const btnHtml = `
                <button onclick="copyTerminalPair('${groupId}')" 
                        class="copy-trigger absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-all bg-emerald-500/10 hover:bg-emerald-500/30 text-emerald-400 text-[9px] px-2 py-1 rounded border border-emerald-500/20">
                    COPY PAIR
                </button>
            `;
            groupContainer.insertAdjacentHTML('afterbegin', btnHtml);
        }
        log.scrollTop = log.scrollHeight;
    };

    // 1. æ¸²æŸ“æŒ‡ä»¤ (Query)
    print(rawInput, 'query');
    input.value = '';

    const subCommands = rawInput.split(';').map(s => s.trim()).filter(s => s);

    for (let subCmd of subCommands) {
        const lowerCmd = subCmd.toLowerCase();
        try {
            // --- ğŸŒŸ æ¨¡å¼ Aï¼šæˆ°è¡“æŒ‡ä»¤ ---
            if (lowerCmd === 'help') {
                print({
                    "æµ·å¤–å„ªåŒ–": "ping, env, deep-scan",
                    "ç‰©ç†æ•‘æ´": "unlock, push, audit, fix-geo",
                    "é€²éšåŠŸèƒ½": "æ”¯æ´ await, æ”¯æ´ Pair Copy"
                });
            } 
            else if (lowerCmd === 'ping') {
                const start = Date.now();
                try {
                    await fetch('https://generativelanguage.googleapis.com', { mode: 'no-cors' });
                    print(`âœ… API é€£é€šæ­£å¸¸ | å»¶é²: ${Date.now() - start}ms`);
                } catch (e) { print('ğŸš¨ API é€£ç·šå—é˜»', 'answer', 'text-rose-400'); }
            }
            else if (lowerCmd === 'env') {
                print({ èªè¨€: navigator.language, æ™‚å€: Intl.DateTimeFormat().resolvedOptions().timeZone, ç‹€æ…‹: navigator.onLine ? 'ON' : 'OFF' });
            }
            else if (lowerCmd === 'unlock') {
                window.isTransportUpdating = false;
                print('ğŸ”“ ç‰©ç†é–å®šè§£é™¤');
            }
            else if (lowerCmd === 'push') {
                await saveData(true);
                print('âœ… ç‰©ç†å¿«ç…§å›ºåŒ–æˆåŠŸ');
            }
            else if (lowerCmd === 'audit') {
                const missing = state.bucketList.filter(i => !i.coords || !i.coords.lat);
                print({ ç¸½æ•¸: state.bucketList.length, ç¼ºå¤±: missing.length, Key: state.theme.geminiKey ? 'YES' : 'NO' });
            }
            else if (lowerCmd === 'clear') {
                log.innerHTML = '';
            }
            // --- ğŸŒŸ æ¨¡å¼ Bï¼šç•°æ­¥æ±‚å€¼ ---
            else {
                const evalResult = await eval(`(async () => { return ${subCmd} })()`);
                if (evalResult !== undefined) print(evalResult);
            }
        } catch (err) {
            print(`Runtime Error: ${err.message}`, 'answer', 'text-rose-400 font-bold');
        }
    }
}

/** ğŸ“‹ ç‰©ç†é…å°è¤‡è£½åŸ·è¡Œç·’ï¼šQ & A ä¸€é«”åŒ–æå– */
window.copyTerminalPair = function(groupId) {
    const group = document.getElementById(groupId);
    const lines = group.querySelectorAll('.log-line');
    let textToCopy = "";

    lines.forEach(line => {
        const type = line.querySelector('span').innerText; // Q æˆ– A
        const rawData = line.querySelector('.raw-data').value;
        textToCopy += `${type}: ${rawData}\n`;
    });

    navigator.clipboard.writeText(textToCopy.trim()).then(() => {
        const btn = group.querySelector('.copy-trigger');
        btn.innerText = 'âœ… PAIR COPIED';
        setTimeout(() => { btn.innerText = 'COPY PAIR'; }, 1500);
    });
};


/** ğŸš‘ ç‰©ç†åº§æ¨™ AI è‡ªç™’å¼•æ“ (v3.0 ç¯€æµå¼·åŒ–ç‰ˆ) 
 * æ¨¡å¼ï¼šè‡ªå‹•æ»´çŒ (Drip-Feed)
 * ä¿®æ­£ï¼šåŠ å…¥é–“éš”å»¶é²ã€æ¯ç­†è‡ªå‹•å›ºåŒ–ã€429 ç†”æ–·æ©Ÿåˆ¶
 */
window.repairMissingCoords = async function(limit = 10, delayMs = 3000) {
    const log = document.getElementById('virtual-console-log');
    const print = (t, c = 'text-emerald-400') => {
        // ä½¿ç”¨ div ä¿æŒçµæ§‹æ¸…æ™°
        log.insertAdjacentHTML('beforeend', `<div class="mb-1 ${c}">> ${t}</div>`);
        log.scrollTop = log.scrollHeight;
    };

    // 1. ç¯©é¸ç¼ºå£
    const missing = state.bucketList.filter(i => !i.coords || !i.coords.lat || !i.coords.lng);
    if (missing.length === 0) return print("ğŸŸ¢ ç‰©ç†å·¡æª¢å®Œæˆï¼šå…¨æ•¸è³‡ç”¢åº§æ¨™å·²å°ä½ã€‚", "text-emerald-400");

    const batchSize = Math.min(limit, missing.length);
    print(`ğŸš€ å•Ÿå‹•ç¯€æµæœæ•‘ï¼šé è¨ˆè™•ç† ${batchSize} ç­†ï¼Œæ¯ç­†é–“éš” ${delayMs/1000}s`, "text-cyan-400");

    let successCount = 0;
    for (let i = 0; i < batchSize; i++) {
        const item = missing[i];
        print(`ğŸ“¡ [${i+1}/${batchSize}] æ­£åœ¨å®šä½: ${item.name}...`, "text-slate-400");

        try {
            const prompt = `ä½ æ˜¯ä¸€ä½åœ°ç†åº§æ¨™ç²¾ç®—å¸«ã€‚è«‹æä¾›ã€Œ${item.name}ã€åœ¨ã€Œ${item.location || 'æ—¥æœ¬'}ã€çš„ç²¾æº–ç¶“ç·¯åº¦ã€‚ğŸš¨ è¦æ±‚ï¼šåªå›å‚³ç´” JSONï¼Œæ ¼å¼ï¼š{"lat": æ•¸å­—, "lng": æ•¸å­—}`;
            
            // å‘¼å« API
            const res = await callGeminiWithRetry(prompt);
            const cleanJson = res.replace(/```json|```/g, '').trim();
            const coords = JSON.parse(cleanJson);
            
            // 2. æ•¸æ“šæ ¡æº–èˆ‡æ³¨å…¥
            const lat = parseFloat(coords.lat);
            const lng = parseFloat(coords.lng);

            if (lat && lng) {
                item.coords = { lat, lng };
                successCount++;
                print(`âœ… [${item.name}] å°ä½æˆåŠŸ: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, "text-emerald-500");
                
                // ğŸŒŸ ç‰©ç†å¼·å­˜ï¼šæ¯æˆåŠŸä¸€ç­†å³åˆ»å›ºåŒ–ï¼Œé˜²æ­¢é€²åº¦æ­¸é›¶
                await saveData(true); 
            }
        } catch(e) {
            print(`âŒ [${item.name}] å¤±æ•—: ${e.message}`, "text-rose-400");
            
            // ğŸš¨ æ™ºæ…§ç†”æ–·ï¼šåµæ¸¬åˆ° 429 æµé‡é™åˆ¶
            if (e.message.includes('429')) {
                print("ğŸš¨ åµæ¸¬åˆ° API æµé‡ä¸Šé™ (429)ï¼ç«‹å³å®‰å…¨çµ‚æ­¢æ‰¹æ¬¡ä»»å‹™ã€‚", "text-rose-600 font-bold");
                break; 
            }
        }

        // ğŸŒŸ 3. æˆ°è¡“å†·å»ï¼šé™¤äº†æœ€å¾Œä¸€ç­†å¤–ï¼Œæ¯ç­†åŸ·è¡Œå®Œå¾Œå¼·åˆ¶é€²å…¥å†·å»
        if (i < batchSize - 1) {
            await new Promise(resolve => setTimeout(resolve, delayMs));
        }
    }

    if (successCount > 0) {
        print(`ğŸ éšæ®µæ€§ä¿®å¾©å®Œæˆï¼æˆåŠŸå°ä½ ${successCount} ç­†è³‡ç”¢ã€‚`, "text-cyan-300");
    } else {
        print("â„¹ï¸ æœ¬æ¬¡æœæ•‘æœªæ–°å¢æœ‰æ•ˆåº§æ¨™ã€‚", "text-slate-500");
    }
};

/** ğŸ’‰ ç‰©ç†åº§æ¨™è‡ªå‹•ç¸«åˆå¼•æ“ (v1.5) */
window.stitchBucketCoords = async function() {
    const log = document.getElementById('virtual-console-log');
    const print = (t, c = 'text-emerald-400') => {
        log.insertAdjacentHTML('beforeend', `<p class="${c}">> ${t}</p>`);
        log.scrollTop = log.scrollHeight;
    };

    let stitchedCount = 0;
    const buckets = state.bucketList || [];
    const geoDB = window.GEO_REGIONS || {};

    print("ğŸ§¬ å•Ÿå‹•èªæ„å°ä½åˆ†æ...", "text-blue-400");

    buckets.forEach(item => {
        // å°‹æ‰¾åç¨±æˆ–åœ°é»æ˜¯å¦åŒ…å«å·²çŸ¥çš„ 16 ç­†æ ¸å¿ƒå€åŸŸ (åšå¤š, ç¦å²¡, ç”±å¸ƒé™¢ç­‰)
        for (const [region, aliases] of Object.entries(geoDB)) {
            if (region.endsWith('_coords')) continue;
            
            const matchName = item.name.includes(region) || (item.location && item.location.includes(region));
            const matchAlias = Array.isArray(aliases) && aliases.some(a => item.name.includes(a));
            
            if (matchName || matchAlias) {
                const coords = geoDB[region + '_coords'];
                if (coords && (!item.coords || !item.coords.lat)) {
                    item.coords = { lat: coords.lat, lng: coords.lng };
                    stitchedCount++;
                }
            }
        }
    });

    if (stitchedCount > 0) {
        await saveData(true); // ç‰©ç†é–å®š
        print(`âœ… ç¸«åˆæˆåŠŸï¼šå·²ç‚º ${stitchedCount} ç­†è³‡ç”¢ä¿®å¾©åœ°ç†æŒ‡ç´‹ã€‚`, "text-cyan-300");
        print("ğŸ’¾ ç‰©ç†ç£å€å·²å¼·åˆ¶åŒæ­¥ã€‚");
    } else {
        print("â„¹ï¸ æƒæå®Œç•¢ï¼šæœªç™¼ç¾å¯å°ä½çš„å·²çŸ¥å€åŸŸã€‚");
    }
};

function clearSystemLog() {
    const log = document.getElementById('virtual-console-log');
    if (log) log.innerHTML = '<p class="text-slate-500">> Console cleared.</p>';
}


/** ğŸ“‹ è·äººç´šæ¸…å–®é …ç›®å…ƒä»¶ (v9.2)
 * ä¿®æ­£ï¼š
 * 1. è¦–è¦ºé€£å‹•ï¼šå°å…¥å‹•æ…‹æ¨™ç±¤é¡è‰²æ˜ å°„ï¼Œé‚Šæ¡†èˆ‡æ¨™ç±¤èƒŒæ™¯è‡ªå‹•å°ä½ã€‚
 * 2. ç‹€æ…‹è¨˜æ†¶ï¼šé€é data-id èˆ‡ window å…¨åŸŸç‹€æ…‹é€£å‹•ã€‚
 * 3. æ¥µç°¡ç¾æ„Ÿï¼šç§»é™¤åŸç”Ÿ Checkboxï¼Œæ”¹ç”¨è·äººç´šç‹€æ…‹åˆ‡æ›éˆ•ã€‚
 */
function renderChecklistItem(item) {
    const { id, name, label, checked, tagColor } = item;
    
    // ğŸ¨ å®šç¾©æ¨™ç±¤è¦–è¦ºæŒ‡ç´‹ (è‹¥ç„¡å‚³å…¥é¡è‰²å‰‡è‡ªå‹•åˆ†é…)
    const activeColor = tagColor || (label === 'å¿…å‚™' ? '#ef4444' : '#64748b');
    const lightBg = `${activeColor}15`; // 15% é€æ˜åº¦èƒŒæ™¯
    
    return `
        <div data-item-id="${id}" 
             class="group relative flex items-center justify-between p-4 bg-white rounded-[1.8rem] border border-slate-100 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-300 cursor-pointer"
             style="border-left: 6px solid ${activeColor}">
            
            <div class="flex items-center gap-4">
                <button onclick="window.toggleCheckState('${id}')" 
                        class="w-8 h-8 rounded-xl flex items-center justify-center transition-all duration-500 ${checked ? 'scale-110' : 'bg-slate-50 border-2 border-slate-100'}"
                        style="background-color: ${checked ? activeColor : ''}">
                    ${checked ? '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </button>
                
                <div class="flex flex-col text-left">
                    <span class="text-sm font-black tracking-tight transition-all ${checked ? 'text-slate-300 line-through' : 'text-slate-700'}">
                        ${name}
                    </span>
                </div>
            </div>

            <span class="text-[9px] px-2.5 py-1 rounded-lg font-black uppercase tracking-tighter"
                  style="background-color: ${lightBg}; color: ${activeColor}; border: 1px solid ${lightBg}">
                ${label}
            </span>
        </div>`;
}

/** ğŸ§  ç‹€æ…‹è¨˜æ†¶èˆ‡è‡ªç™’é‚è¼¯ */
window.toggleCheckState = async function(id) {
    // 1. æ‰¾åˆ°æœ¬åœ°è³‡æ–™åº«ä¸­çš„é …ç›®
    const item = state.checklist.find(i => i.id === id);
    if (!item) return;

    // 2. ç‰©ç†ç¿»è½‰ç‹€æ…‹
    item.checked = !item.checked;
    
    // 3. ç©ºé–“ç®¡ç†ï¼šè‹¥æ˜¯å·²è³¼é …/å®Œæˆé …ï¼Œè§¸ç™¼å†·ç†±è³‡æ–™æ¨™è¨˜
    if (item.checked) {
        console.log(`[GC-Manager] Item ${id} marked as Hot-Complete.`);
    }

    // 4. å…¨åŸŸåŒæ­¥èˆ‡ UI é‡ç¹ª
    await saveData(true);
    renderSettingsView(); // æˆ–å°æ‡‰çš„åˆ·æ–°å‡½æ•¸
};


/** ğŸ“ TravelFlow Checklist (v6.3)
 * çµ‚æ¥µåŠŸèƒ½ï¼š
 * 1. [ä¸€éµè²¼ä¸Š] æ”¯æ´æ‰‹æ©Ÿç«¯è‡ªå‹•æŠ“å–å‰ªè²¼ç°¿ï¼Œé™ä½è¼¸å…¥é›£åº¦ã€‚
 * 2. [è‰²å½©å…¨è‡ªå‹•] åŒ¯å…¥å¾Œ UI æ¨™é¡Œèˆ‡å®¹å™¨é‚Šæ¡†åŒæ­¥åæ‡‰æ–°æ•¸æ“šè‰²å½©ã€‚
 * 3. [è‡ªç™’å­˜æª”] å¼·åˆ¶åŸ·è¡Œç‰©ç†å›ºåŒ–ï¼Œç¢ºä¿åˆ†äº«æ•¸æ“šè‚‰èº«æˆè–ã€‚
 */
async function renderChecklistTab() {
    const container = document.getElementById('checklist-mount-point') || document.getElementById('setting-tab-content');
    if (!container) return;

    // --- ğŸŒŸ åŠŸèƒ½ï¼šæ™ºæ…§åˆ†äº«ç¢¼è¤‡è£½ ---
    window.copyChecklistJSON = () => {
        if (!state.checklist || state.checklist.length === 0) return alert("æ¸…å–®æ˜¯ç©ºçš„å–”ï¼");
        const jsonStr = JSON.stringify(state.checklist);
        navigator.clipboard.writeText(jsonStr).then(() => {
            alert("âœ… JSON åˆ†äº«ç¢¼å·²è¤‡è£½ï¼\nè«‹ç›´æ¥è²¼çµ¦æ—…ä¼´å³å¯ã€‚");
        }).catch(() => prompt("è«‹è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼š", jsonStr));
    };

    // --- ğŸŒŸ åŠŸèƒ½ï¼šæ‰‹æ©Ÿå‹å–„æ¨¡æ…‹æ¡† ---
    window.showImportModal = () => {
        const modalHtml = `
            <div id="fuel-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md animate-in fade-in duration-300" onclick="window.closeFuelModal()"></div>
                <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl z-10 overflow-hidden animate-in zoom-in-95 slide-in-from-bottom-10 duration-300">
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-2xl bg-emerald-100 flex items-center justify-center text-xl">â›½</div>
                                <div>
                                    <h3 class="font-black text-slate-800">ç‡ƒæ–™ç¢¼åŒ¯å…¥</h3>
                                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Fuel Inbound</p>
                                </div>
                            </div>
                            <button onclick="window.smartPaste()" class="px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-[10px] font-black active:scale-90">ğŸ“‹ è²¼ä¸Š</button>
                        </div>
                        
                        <textarea id="fuel-input" placeholder="è«‹è²¼å…¥æˆ–é»æ“Šä¸Šæ–¹ã€Œè²¼ä¸Šã€æŒ‰éˆ•..." 
                            class="w-full h-32 bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-[11px] font-bold outline-none focus:border-emerald-400 transition-all no-scrollbar"></textarea>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.processImport(true)" class="py-4 bg-emerald-500 text-white rounded-2xl text-[11px] font-black shadow-lg shadow-emerald-200 active:scale-95 transition-all">
                                â• è¿½åŠ åˆä½µ
                            </button>
                            <button onclick="window.processImport(false)" class="py-4 bg-slate-800 text-white rounded-2xl text-[11px] font-black shadow-lg active:scale-95 transition-all">
                                ğŸ”„ å®Œå…¨è¦†è“‹
                            </button>
                        </div>
                        <button onclick="window.closeFuelModal()" class="w-full py-2 text-slate-400 text-[10px] font-black">å–æ¶ˆé—œé–‰</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closeFuelModal = () => document.getElementById('fuel-modal')?.remove();

    // ğŸŒŸ æ™ºæ…§è²¼ä¸ŠåŠŸèƒ½
    window.smartPaste = async () => {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('fuel-input').value = text;
        } catch (err) {
            alert("è«‹æ‰‹å‹•é•·æŒ‰è¼¸å…¥æ¡†ä¸¦è²¼ä¸Šã€‚");
        }
    };

    window.processImport = async (isMerge) => {
        const input = document.getElementById('fuel-input').value;
        try {
            const parsedData = JSON.parse(input);
            if (!Array.isArray(parsedData)) throw new Error();

            state.checklist = isMerge ? [...(state.checklist || []), ...parsedData] : parsedData;

            await dbManager.save('config_store', { id: 'checklist_data', content: state.checklist });
            await saveData(true);
            window.closeFuelModal();
            renderChecklistTab();
            alert(`ğŸš€ åŒ¯å…¥å®Œæˆï¼`);
        } catch (e) {
            alert("âŒ æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥åˆ†äº«ç¢¼ã€‚");
        }
    };

    // --- 3. ç‹€æ…‹èˆ‡è‰²å½©åˆå§‹åŒ– ---
    if (!state.checklist) state.checklist = [];
    if (!window.activeChecklistCat) window.activeChecklistCat = 'å…¨éƒ¨';

    const getCatColor = (catName) => {
        if (catName === 'å…¨éƒ¨') return '#ff69b4';
        const sample = state.checklist.find(i => i.category === catName);
        return sample ? (sample.color || sample.tagColor || '#94a3b8') : '#94a3b8';
    };

    const activeColor = getCatColor(window.activeChecklistCat);

    // --- 4. æ¸²æŸ“ä¸»çµæ§‹ ---
    container.innerHTML = `
        <div class="space-y-5 animate-in fade-in duration-500">
            <div class="px-2">
                <div class="flex justify-between items-end">
                    <div>
                        <h4 class="text-sm font-black text-slate-800 tracking-widest">æ—…éŠæ”œå¸¶ç‰©å“ check list</h4>
                        <p class="text-[9px] font-black uppercase tracking-widest transition-colors duration-500" style="color: ${activeColor}">
                            ${window.activeChecklistCat} SECTOR
                        </p>
                    </div>
                    <div class="flex gap-1.5">
                        <button onclick="window.copyChecklistJSON()" class="px-3 py-1.5 rounded-full text-[10px] font-black bg-blue-50 text-blue-600 border border-blue-100 active:scale-90">ğŸ”— åˆ†äº«</button>
                        <button onclick="window.showImportModal()" class="px-3 py-1.5 rounded-full text-[10px] font-black bg-emerald-50 text-emerald-600 border border-emerald-100 active:scale-90">â›½ åŒ¯å…¥</button>
                        <button onclick="window.toggleChecklistEditMode()" class="px-3 py-1.5 rounded-full text-[10px] font-black ${window.isChecklistEditing ? 'bg-amber-100 text-amber-600 border-amber-200' : 'bg-slate-100 text-slate-500 border-slate-200'} border active:scale-90">
                            ${window.isChecklistEditing ? 'ğŸ’¾ å®Œæˆ' : 'âš™ï¸ ç·¨è¼¯'}
                        </button>
                    </div>
                </div>
            </div>

            <div class="-mx-4 px-4 overflow-hidden">
                <div class="grid grid-flow-col auto-cols-max gap-3 overflow-x-auto no-scrollbar py-2">
                    ${['å…¨éƒ¨', ...new Set(state.checklist.map(i => i.category))].map(cat => {
                        const isSelected = window.activeChecklistCat === cat;
                        const catColor = getCatColor(cat);
                        return `<button onclick="window.filterChecklist('${cat}')" 
                            style="${isSelected ? `background-color: ${catColor}; color: white;` : `color: ${catColor}; border-color: ${catColor}44;`}"
                            class="flex-none px-4 py-2 rounded-xl text-[11px] font-black border transition-all ${isSelected ? 'shadow-md scale-105' : 'bg-white'}">${cat}</button>`;
                    }).join('')}
                    <div class="w-6"></div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl transition-all duration-500 overflow-hidden divide-y divide-slate-50"
                 style="border: 1px solid #f1f5f9; border-top: 8px solid ${activeColor};">
                ${window.renderChecklistItems()}
            </div>
        </div>
    `;
}

/** ğŸ› ï¸ åŠŸèƒ½é‚è¼¯ä¿æŒæ›è¼‰ */
window.toggleChecklistEditMode = () => { window.isChecklistEditing = !window.isChecklistEditing; renderChecklistTab(); };

/** ğŸ¨ åˆ†é¡ç¯©é¸ä»²è£å™¨ (v4.4 è¦–è¦ºé€£å‹•ç‰ˆ)
 * ä½œç”¨ï¼šåˆ‡æ›åˆ†é åˆ†é¡ï¼Œä¸¦åŒæ­¥è§¸ç™¼ UI è‰²å½©é€£å‹•èˆ‡æ»¾å‹•è£œå„Ÿã€‚
 */
window.filterChecklist = (cat) => {
    // 1. é–å®šç•¶å‰æ´»èºåˆ†é¡
    window.activeChecklistCat = cat;

    // 2. å‹•æ…‹ç‰©ç†ä¸»è‰²è¨ˆç®—
    // å¦‚æœæ˜¯ã€Œå…¨éƒ¨ã€ï¼Œä½¿ç”¨ç³»çµ±é è¨­ç²‰è‰²ï¼›å¦å‰‡æŠ“å–è©²åˆ†é¡çš„ç¬¬ä¸€å€‹é …ç›®çš„é¡è‰²
    const catColor = cat === 'å…¨éƒ¨' 
        ? '#ff69b4' 
        : (state.checklist.find(i => i.category === cat)?.color || '#94a3b8');

    console.log(`ğŸ“¡ [åˆ†å€åˆ‡æ›] ç›®æ¨™ sector: ${cat} | é…è‰²é–å®š: ${catColor}`);

    // 3. è¦–åœ–è£œå„Ÿï¼šå°‡æ¸…å–®å®¹å™¨æ»¾å‹•å›é ‚éƒ¨
    const container = document.getElementById('checklist-mount-point');
    if (container) {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 4. è§¸ç™¼å…¨é‡æ¸²æŸ“
    if (typeof renderChecklistTab === 'function') {
        renderChecklistTab();
    }
};

/** ğŸ“‹ è·äººç´šæ¸…å–®æ¸²æŸ“å¼•æ“ (v9.3 ç‰©ç†è‰²å½©å…¨ç›¸å®¹ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [è‰²å½©ä»²è£] å„ªå…ˆé †åºï¼šitem.color > item.tagColor > åˆ†é¡é¦–é …é¡è‰² > ç³»çµ±ä¸»é¡Œè‰²ã€‚
 * 2. [ç‹€æ…‹åŒæ­¥] ä¿®æ­£å‹¾é¸æ¡†çš„èƒŒæ™¯è‰²é€£å‹•ï¼Œç¢ºä¿å®Œæˆæ™‚å±•ç¾è©²é …ç›®çš„ç‰©ç†ä¸»è‰²ã€‚
 * 3. [é›™å±¬æ€§ç›¸å®¹] åŒæ™‚æ”¯æ´ .task èˆ‡ .text æ¬„ä½ã€‚
 */
window.renderChecklistItems = () => {
    // 1. åŸ·è¡Œåˆ†é¡éæ¿¾
    const filtered = window.activeChecklistCat === 'å…¨éƒ¨' 
        ? state.checklist 
        : state.checklist.filter(i => i.category === window.activeChecklistCat);

    // 2. ç©ºç™½ç‹€æ…‹è™•ç†
    if (filtered.length === 0) return `<div class="py-24 text-center text-slate-300 italic text-xs tracking-widest">NO ASSETS DETECTED</div>`;

    // 3. æ˜ å°„æ¸²æŸ“
    return filtered.map(item => {
        // ğŸ¨ æ ¸å¿ƒä¿®æ­£ï¼šæ·±åº¦æœå°‹è©²é …ç›®çš„ç‰©ç†ä¸»è‰²
        // å¦‚æœè©²é …ç›®æ²’é¡è‰²ï¼Œå°±å»æœå°‹åŒåˆ†é¡ä¸­ä»»ä½•ä¸€å€‹æœ‰é¡è‰²çš„é …ç›®ä½œç‚ºè£œå„Ÿ
        const itemColor = item.color || item.tagColor || 
            (state.checklist.find(i => i.category === item.category && (i.color || i.tagColor))?.color) || 
            (state.checklist.find(i => i.category === item.category && (i.color || i.tagColor))?.tagColor) ||
            '#ff69b4'; // æœ€çµ‚ä¿åº•ä½¿ç”¨ä¸»é¡Œç²‰

        const lightBg = `${itemColor}15`; // 15% é€æ˜åº¦èƒŒæ™¯

        return `
        <div onclick="${window.isChecklistEditing ? '' : `window.toggleItemDone('${item.id}')`}" 
             class="flex items-center gap-4 px-7 py-5 transition-all ${window.isChecklistEditing ? 'cursor-default' : 'cursor-pointer active:bg-slate-50'}">
            
            <div class="flex-none w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${
                item.done ? 'border-transparent' : 'border-slate-200'
            }" style="${item.done ? `background-color: ${itemColor};` : ''}">
                ${item.done ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M5 13l4 4L19 7"></path></svg>' : ''}
            </div>

            <div class="flex-1 min-w-0">
                <p class="text-[14px] font-bold truncate ${item.done ? 'text-slate-300 line-through' : 'text-slate-700'}">
                    ${item.task || item.text || "æœªå‘½åè³‡ç”¢"}
                </p>
                <div class="flex items-center gap-2 mt-0.5">
                    <span class="text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-tighter" 
                          style="background: ${lightBg}; color: ${itemColor}; border: 1px solid ${lightBg}">
                        ${item.category || "GENERAL"}
                    </span>
                </div>
            </div>

            ${window.isChecklistEditing ? `
                <button onclick="window.deleteChecklistItem('${item.id}'); event.stopPropagation();" class="p-2 text-slate-300 hover:text-red-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            ` : ''}
        </div>
    `;
    }).join('');
};

/** ğŸ› ï¸ è·äººç´šæ–°å¢å¼•æ“ (v4.5)
 * ä¿®æ­£ï¼š
 * 1. [è‰²å½©è‡ªå‹•åˆ†é…] å…§å»ºè·äºº 12 è‰²åº«ï¼Œè§£æ±ºæ–°åˆ†é¡è®Šç°è‰²çš„å•é¡Œã€‚
 * 2. [ç¹¼æ‰¿é‚è¼¯] å„ªå…ˆå¾ç¾æœ‰åˆ†é¡æå–é¡è‰²ï¼Œç¢ºä¿è¦–è¦ºé€£çºŒæ€§ã€‚
 * 3. [é›™å±¬æ€§å°è£] åŒæ™‚é–å®š task èˆ‡ textï¼Œé˜²æ­¢æ¸²æŸ“ç«¯ undefinedã€‚
 */
window.confirmAddNewItem = async () => {
    const taskInput = document.getElementById('new-item-task');
    const catInput = document.getElementById('new-item-cat');
    if (!taskInput || !taskInput.value.trim()) return;

    const taskValue = taskInput.value.trim();
    const catValue = (catInput && catInput.value.trim()) ? catInput.value.trim() : 'å…¶ä»–';

    // ğŸ¨ è·äººç´š 12 è‰²åº« (é¸ç”¨é«˜é£½å’Œåº¦ã€æ˜“è®€æ€§å¼·çš„é…è‰²)
    const proPalettes = [
        '#ff69b4', '#4ade80', '#60a5fa', '#fbbf24', 
        '#a78bfa', '#f472b6', '#2dd4bf', '#fb7185', 
        '#818cf8', '#34d399', '#f87171', '#fb923c'
    ];

    // ğŸŒŸ æ ¸å¿ƒé‚è¼¯ï¼šå°‹æ‰¾è©²åˆ†é¡ç¾æœ‰çš„é¡è‰²
    const existingEntry = state.checklist.find(i => 
        i.category === catValue && (i.color || i.tagColor)
    );

    let finalColor;
    if (existingEntry) {
        // A. æ—¢æœ‰åˆ†é¡ï¼šç‰©ç†ç¹¼æ‰¿
        finalColor = existingEntry.color || existingEntry.tagColor;
    } else {
        // B. å…¨æ–°åˆ†é¡ï¼šå¾è‰²åº«ä¸­æ ¹æ“šåˆ†é¡åç¨±çš„ Hash ç¢¼åˆ†é…å›ºå®šé¡è‰² (é¿å…éš¨æ©Ÿäº‚è®Š)
        const hash = catValue.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        finalColor = proPalettes[hash % proPalettes.length];
    }

    // ğŸš€ åŸ·è¡Œç‰©ç†æ³¨å…¥
    const newItem = {
        id: 'c' + Date.now(),
        category: catValue,
        task: taskValue,  // æ”¯æ´æ–°ç‰ˆæ¸²æŸ“
        text: taskValue,  // æ”¯æ´èˆŠç‰ˆæ¸²æŸ“
        done: false,
        color: finalColor,
        tagColor: finalColor
    };

    state.checklist.push(newItem);

    // ğŸ§¹ UI è‡ªç™’ï¼šæ¸…ç©ºè¼¸å…¥ä¸¦é‡æ–°æ¸²æŸ“
    taskInput.value = '';
    if (window.activeChecklistCat === 'å…¨éƒ¨') catInput.value = '';
    
    renderChecklistTab();

    // ğŸ’¾ ç‰©ç†å›ºåŒ–ï¼šé–å…¥ config_store
    if (typeof saveData === 'function') {
        await saveData(true);
    }
    
    console.log(`ğŸ¨ [è‰²å½©å°ä½] åˆ†é¡: ${catValue} | åˆ†é…é¡è‰²: ${finalColor}`);
};


/** ç‹€æ…‹ç¿»è½‰ï¼šæ”¯æ´ç‰©ç†é–å®š */
window.toggleItemDone = async (id) => {
    // æ”¯æ´å­—ä¸²èˆ‡æ•¸å­— ID çš„ç›¸å®¹æ€§æœå°‹
    const item = state.checklist.find(i => i.id == id); 
    if (item) { 
        item.done = !item.done; 
        renderChecklistTab(); 
        if (typeof saveData === 'function') await saveData(true); 
    }
};

/** ç‰©ç†æŠ¹é™¤ï¼šå¾ç£å€å®Œå…¨ç§»é™¤ */
window.deleteChecklistItem = async (id) => {
    if (!confirm('ç¢ºå®šè¦æ°¸ä¹…ç§»é™¤æ­¤è£å‚™æŒ‡ç´‹å—ï¼Ÿ')) return;
    
    state.checklist = state.checklist.filter(i => i.id != id);
    renderChecklistTab(); 
    
    if (typeof saveData === 'function') {
        await saveData(true); // ç‰©ç†ç£å€åŒæ­¥æŠ¹é™¤
    }
};

/** ğŸ§  ç‰©ç†é‡å°ä½ä»²è£å™¨ (v1.0.0)
 * ä½œç”¨ï¼šè·¨æ¨¡çµ„æ›´æ–°é…ç½®ï¼ŒåŒæ™‚é–å®šç‰©ç†æˆ¿é–“èˆ‡å…¨åŸŸè¨˜æ†¶é«”ã€‚
 * @param {string} type - æ›´æ–°é¡åˆ¥ ('THEME', 'ICON', 'MATRIX', 'GEO')
 * @param {string} key - ç‰©ç†ä¸»éµ
 * @param {any} value - æ³¨å…¥çš„æ•¸å€¼
 */
async function updateDefinition(type, key, value) {
    console.log(`ğŸ“¡ [ç‰©ç†å°ä½] é¡åˆ¥: ${type} | Key: ${key} | åŸ·è¡Œä¸­...`);

    try {
        switch (type) {
            case 'THEME':
                // æ›´æ–° THEME_COLORS ç‰©ç†æˆ¿é–“
                const themeConfig = await dbManager.get('config_store', 'THEME_COLORS') || { id: 'THEME_COLORS', data: {} };
                themeConfig.data[key] = value;
                await dbManager.save('config_store', themeConfig);
                
                // åŒæ­¥è‡³å…¨åŸŸå¸¸æ•¸èˆ‡ç•¶å‰ä¸»é¡Œ
                if (!window.THEME_COLORS) window.THEME_COLORS = {};
                window.THEME_COLORS[key] = value;
                state.theme.primary = value; 
                break;

            case 'ICON':
                // æ›´æ–° icon_store ç‰©ç†æˆ¿é–“
                await dbManager.save('icon_store', { keyword: key, icon: value });
                // åŒæ­¥è‡³å…¨åŸŸå¤§è…¦
                if (!window.TRANSPORT_ICONS) window.TRANSPORT_ICONS = {};
                window.TRANSPORT_ICONS[key] = value;
                break;

            case 'MATRIX':
                // æ›´æ–° matrix_store ç‰©ç†æˆ¿é–“
                await dbManager.save('matrix_store', { routeKey: key, time: parseInt(value) });
                // åŒæ­¥è‡³å…¨åŸŸå¤§è…¦
                if (!window.TRAVEL_TIME_MATRIX) window.TRAVEL_TIME_MATRIX = {};
                window.TRAVEL_TIME_MATRIX[key] = parseInt(value);
                break;

            case 'GEO':
                // æ›´æ–° geo_regions_store ç‰©ç†æˆ¿é–“
                await dbManager.save('geo_regions_store', { regionName: key, aliases: value });
                // åŒæ­¥è‡³å…¨åŸŸå¤§è…¦
                if (!window.GEO_REGIONS) window.GEO_REGIONS = {};
                window.GEO_REGIONS[key] = value;
                break;
        }

        // ğŸŒŸ æ ¸å¿ƒï¼šåŸ·è¡Œç‰©ç†å­˜æª”ä¸¦è§¸ç™¼ä»‹é¢åˆ·æ–°
        if (typeof saveData === 'function') await saveData(true);
        console.log(`âœ… [ç‰©ç†é–å®šå®Œæˆ] ${type} å·²å³æ™‚åŒæ­¥è‡³è³‡æ–™åº«ã€‚`);
        
    } catch (e) {
        console.error(`âŒ [å°ä½å¤±æ•—] ${type} æ›´æ–°æ™‚ç™¼ç”Ÿç•°å¸¸:`, e);
    }
}

/** ğŸ¨ ä½ˆæ™¯é…è‰²é–å®šå™¨ (v1.0.0)
 * ä½œç”¨ï¼šå°‡ç•¶å‰é¸å®šçš„ä¸»é¡Œè‰²æ­£å¼é–å…¥ç‰©ç†æˆ¿é–“ï¼Œç¢ºä¿é‡å•Ÿå¾Œé…è‰²ä¸å¤±çœŸã€‚
 */
async function saveThemePhysically() {
    console.log("ğŸ¨ å•Ÿå‹•ä½ˆæ™¯ç‰©ç†é–å®šç¨‹åº...");

    try {
        const currentPrimary = state.theme.primary;
        
        // 1. æ›´æ–°ç‰©ç†é…ç½®æˆ¿é–“ (config_store)
        // æˆ‘å€‘å°‡ç•¶å‰çš„é…è‰²æ–¹æ¡ˆå°è£é€² THEME_COLORS
        const themeConfig = await dbManager.get('config_store', 'THEME_COLORS') || { id: 'THEME_COLORS', data: {} };
        
        // é€™è£¡æˆ‘å€‘å‡è¨­ä½¿ç”¨è€…é–å®šçš„æ˜¯ç›®å‰é¸ä¸­çš„é€™å€‹é¡è‰²
        // ä¹Ÿå¯ä»¥æ ¹æ“šéœ€æ±‚é–å®šæ•´å¥—è‡ªå®šç¾©é…è‰²
        await dbManager.save('config_store', {
            id: 'THEME_COLORS',
            data: { ...window.THEME_COLORS, "è‡ªå®šç¾©é–å®š": currentPrimary }
        });

        // 2. æ›´æ–°ä¸»å¿«ç…§ä¸­çš„ä¸»é¡Œè¨­å®š
        state.theme.lastLockedColor = currentPrimary;

        // 3. åŸ·è¡Œå¼·æ¬Šå­˜æª” (Force Sync)
        if (typeof saveData === 'function') {
            await saveData(true);
        }

        alert("âœ… é…è‰²å·²ç‰©ç†é–å®šï¼ä¸‹æ¬¡å•Ÿå‹•å°‡è‡ªå‹•å¥—ç”¨æ­¤ä¸»é¡Œã€‚");
        console.log(`ğŸ¨ [Theme-Lock] é¡è‰² ${currentPrimary} å·²æˆåŠŸé–å®šè‡³ç‰©ç†åˆ†é ã€‚`);
        
    } catch (e) {
        console.error("âŒ é…è‰²é–å®šå¤±æ•—:", e);
        alert("é…è‰²åŒæ­¥è‡³è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
    }
}


/** ğŸ—‘ï¸ çŸ©é™£æ¸…é™¤å·¥å…· (v1.0.0)
 * ä½œç”¨ï¼šå¾ matrix_store ç‰©ç†ç§»é™¤éŒ¯èª¤çš„æ¬Šé‡ç´€éŒ„ï¼Œä¸¦åŒæ­¥æ›´æ–°è¨ºæ–·å¤§è…¦
 */
async function deleteMatrixRecord(routeKey) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${routeKey}ã€çš„ç§»å‹•æ¬Šé‡ç´€éŒ„å—ï¼Ÿ`)) return;

    try {
        // 1. ç‰©ç†ç§»é™¤
        const transaction = dbManager.db.transaction(['matrix_store'], 'readwrite');
        await transaction.objectStore('matrix_store').delete(routeKey);
        
        // 2. åŒæ­¥è¨˜æ†¶é«”èˆ‡é‡è¼‰å®šç¾©
        if (window.TRAVEL_TIME_MATRIX) delete window.TRAVEL_TIME_MATRIX[routeKey];
        if (typeof loadDefinitions === 'function') await loadDefinitions();
        
        // 3. åˆ·æ–° UI
        renderSettingsView();
        console.log(`ğŸ—‘ï¸ [Matrix-Clear] ${routeKey} å·²å¾ç‰©ç†åˆ†é ç§»é™¤`);
    } catch (e) {
        console.error("âŒ åˆªé™¤çŸ©é™£å¤±æ•—:", e);
    }
}

/** ğŸ’¾ ç³»çµ±é‡å•Ÿå®˜ (v1.2.0)
 * ä½œç”¨ï¼šå–ä»£èˆŠæœ‰ reloadï¼Œç¢ºä¿ç‰©ç†å¯«å…¥å®Œæˆã€é–å®šæ¨™ç±¤èˆ‡åº§æ¨™å¾Œé‡å•Ÿ
 * ä¿®æ­£ï¼šæ–°å¢ Setting Tab è¨˜æ†¶ï¼Œé”æˆã€Œç²¾æº–åˆ†é ç´šåˆ¥ã€çš„åŸåœ°å¾©æ´»
 */
async function saveAndReboot() {
    // å–å¾—é»æ“Šçš„æŒ‰éˆ•
    const btn = event?.target?.closest('button');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = `<span class="animate-pulse">â³ æ­£åœ¨å›ºåŒ–ç‰©ç†ç£å€...</span>`;
    }

    // ğŸ›¡ï¸ å•Ÿå‹•çµ‚æ¥µåŸå­é–ï¼Œå°é–é‡å•Ÿå‰çš„æ‰€æœ‰èƒŒæ™¯å¯«å…¥
    window.isTransportUpdating = true;

    try {
        console.log("ğŸ¬ [SYST-REBOOT] å•Ÿå‹•ç†±å•Ÿå‹•ç¨‹åº...");

        // ğŸŒŸ 1. åº§æ¨™èˆ‡åˆ†é æ·±åº¦è¨˜æ†¶
        if (state.currentTripId) {
            localStorage.setItem('reboot_recovery_trip', state.currentTripId);
            localStorage.setItem('reboot_recovery_view', state.currentSubView || 'itinerary');
            
            // âœ¨ æ–°å¢ï¼šè¨˜æ†¶è¨­å®šé å…§çš„æ¨™ç±¤ä½ç½® (å¦‚ï¼šchecklist, engine, console)
            if (state.currentSubView === 'settings' && window.activeSettingTab) {
                localStorage.setItem('reboot_recovery_tab', window.activeSettingTab);
            }
            
            console.log(`ğŸ“ [åº§æ¨™é–å®š] Trip: ${state.currentTripId} | View: ${state.currentSubView} | Tab: ${window.activeSettingTab || 'none'}`);
        }

        // ğŸŒŸ 2. åŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª” (Force Mode)
        if (typeof saveData === 'function') {
            await saveData(true);
        }
        
        // ğŸŒŸ 3. ç‰©ç†å¯«å…¥å†—é¤˜ç·©è¡
        // çµ¦äºˆ IndexedDB ç£å€è¶³å¤ æ™‚é–“å®Œæˆäº‹å‹™ (Transaction) æäº¤
        await new Promise(r => setTimeout(r, 1000));
        
        console.log("ğŸ”„ [SYST-REBOOT] ç‰©ç†åŒæ­¥å®Œæˆï¼ŒåŸ·è¡Œå¼•æ“é‡å•Ÿ...");

        // ğŸŒŸ 4. åŸ·è¡ŒåŸåœ°é‡åˆ·
        window.location.reload();

    } catch (e) {
        window.isTransportUpdating = false;
        console.error("âŒ é‡å•ŸåŒæ­¥å¤±æ•—:", e);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<span>ğŸ’¾ å„²å­˜ä¸¦é‡å•Ÿç‰©ç†å¼•æ“</span>`;
        }
        showMessage("é‡å•ŸæŒ‡ä»¤é­ç‰©ç†æ””æˆªï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹", "error");
    }
}


/** â³ æ‰‹å‹•çŸ©é™£æ–°å¢å™¨ (v1.0.0)
 * ä½œç”¨ï¼šå–ä»£èˆŠæœ‰ prompt æ¨¡å¼ï¼Œç›´æ¥é€éç‰©ç†ä»²è£å™¨å¯«å…¥æ•¸æ“šåº«
 */
async function addNewMatrixRecord() {
    const origin = prompt("è«‹è¼¸å…¥èµ·é» (ä¾‹å¦‚: åšå¤š):");
    if (!origin) return;
    const dest = prompt("è«‹è¼¸å…¥çµ‚é» (ä¾‹å¦‚: é•·å´):");
    if (!dest) return;
    const mins = prompt("è«‹è¼¸å…¥é è¨ˆç§»å‹•åˆ†é˜æ•¸:", "60");
    if (!mins || isNaN(mins)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ï¼");

    const routeKey = `${origin}-${dest}`;
    
    // ğŸŒŸ å‘¼å«å¤§ä¸€çµ±ä»²è£å™¨ï¼šåŒæ­¥ç‰©ç†æˆ¿é–“èˆ‡è¨˜æ†¶é«”
    await updateDefinition('MATRIX', routeKey, parseInt(mins));
    
    // ğŸŒŸ åˆ·æ–° Setting è¦–åœ–é è¦½
    if (typeof renderSettingsView === 'function') {
        await renderSettingsView();
    }
    
    console.log(`â³ [Matrix-Manual] æ‰‹å‹•æ–°å¢å°ä½å®Œæˆ: ${routeKey} = ${mins}m`);
}

/** ğŸš€ æ•¸æ“šå¤§ä¸€çµ±å¼•æ“ (v7.0 ç‰©ç†çµ‚æ¥µå®šæ¡ˆç‰ˆ)
 * æ•´åˆï¼šv4.5 UI é©é… + v6.5 åˆ†é æ ¡æº– + v3.6 æˆ°è¡“å¢è£œ
 * æ ¸å¿ƒï¼š
 * 1. [ç‰©ç†æ ¡æº–] æ™¯é»è³‡ç”¢ (Bucket) å¯«å…¥ç›®æ¨™æ°¸ä¹…é–å®šç‚º `staging_store`ã€‚
 * 2. [æ­»é–è§£é™¤] è‡ªå‹•å¼·åˆ¶å°‡ isTransportUpdating æ­¸é›¶ï¼Œç¢ºä¿ç©¿é€ saveData åŸå­é–ã€‚
 * 3. [è¦–åœ–å°èˆª] æ³¨å…¥æˆåŠŸå¾Œè‡ªå‹•åŸ·è¡Œè¦–åœ–åˆ‡æ›èˆ‡é‡ç¹ªã€‚
 */
async function importTransportFuel() {
    // 1. ç‰©ç†æŠ“å–å®¹å™¨ï¼šæ”¯æ´æ‰€æœ‰æ­·å²ç‰ˆæœ¬ ID
    const inputField = document.getElementById('json-fuel-input') || 
                       document.getElementById('transport-import-input') ||
                       document.querySelector('.fuel-input-area');
    
    const input = inputField ? inputField.value.trim() : '';
    
    if (input.length < 10) {
        const msg = "âŒ è«‹å…ˆè²¼å…¥æœ‰æ•ˆçš„ JSON ç‡ƒæ–™æ•¸æ“šï¼";
        if (typeof showMessage === 'function') showMessage(msg, "error");
        else alert(msg);
        return;
    }

    // ğŸŒŸ å•Ÿå‹•æ›´æ–°é–
    window.isTransportUpdating = true; 
    console.log("ğŸ“¡ å•Ÿå‹•å¤§ä¸€çµ±å¼•æ“ v7.0ï¼Œç‰©ç†åˆ†é  [staging_store] å·²é–å®š...");

    try {
        const data = JSON.parse(input);
        const items = Array.isArray(data) ? data : [data];
        let report = [];
        
        // ç£å€æ‰¹æ¬¡å®¹å™¨
        const sPayload = []; // æ™¯é» -> staging_store
        const tPayload = []; // è·¯ç¶² -> transport_store

        for (let item of items) {
            // --- A0. æˆ°è¡“æ¸…å–® Checklist ---
            if (item.task !== undefined && item.category !== undefined) {
                if (!state.checklist) state.checklist = [];
                const existingIdx = state.checklist.findIndex(i => i.id === item.id);
                if (existingIdx > -1) state.checklist[existingIdx] = { ...state.checklist[existingIdx], ...item };
                else state.checklist.push(item);
                report.push({ é¡å‹: "ğŸ“ æ¸…å–®", é …ç›®: item.task, ç‹€æ…‹: "å·²å¢è£œ" });
                continue;
            }

            // --- A1. è·¯ç¶²ä¸­å¿ƒçµæ§‹ ---
            if (item.operator_id && item.line_id) {
                const routeKey = item.id || `${item.operator_id}_${item.line_id}`;
                const finalRoute = { ...item, id: routeKey, lastUpdated: new Date().toISOString() };
                if (!window.state.transportVault) window.state.transportVault = [];
                const idx = window.state.transportVault.findIndex(r => r.id === routeKey);
                if (idx > -1) window.state.transportVault[idx] = finalRoute;
                else window.state.transportVault.push(finalRoute);
                tPayload.push(finalRoute);
                report.push({ é¡å‹: "ğŸš‰ è·¯ç¶²", é …ç›®: routeKey, ç‹€æ…‹: "ç‰©ç†é–å®š" });
                continue; 
            }

            // --- A2. æ™¯é»è³‡ç”¢ (Bucket) -> å°ä½è‡³ staging_store ---
            if (item.name && !item.operator_id) {
                if (!state.bucketList) state.bucketList = [];
                const existingIdx = state.bucketList.findIndex(b => b.name.trim() === item.name.trim());
                if (existingIdx > -1) state.bucketList[existingIdx] = { ...state.bucketList[existingIdx], ...item };
                else state.bucketList.push(item);
                sPayload.push(item);
                report.push({ é¡å‹: "ğŸ’ æ™¯é»", é …ç›®: item.name, ç‹€æ…‹: "å°ä½è¦†è“‹" });
                continue;
            }

            // --- B. ç§»å‹•çŸ©é™£ (MATRIX) ---
            if (item.routeKey) {
                await updateDefinition('MATRIX', item.routeKey, item.time);
                report.push({ é¡å‹: "â³ çŸ©é™£", é …ç›®: item.routeKey, ç‹€æ…‹: "ç†±é‡è¼‰" });
                continue;
            }

            // --- C. åœ°ç†æŒ‡ç´‹ (GEO) ---
            if (item.aliases) {
                await updateDefinition('GEO', item.regionName, item.aliases);
                report.push({ é¡å‹: "ğŸŒ åœ°ç†", é …ç›®: item.regionName, ç‹€æ…‹: "æŒ‡ç´‹åŒæ­¥" });
                continue;
            }

            // --- E. æ‰¹é‡ç‰©ä»¶ (ICON/MATRIX) ---
            if (typeof item === 'object' && item !== null) {
                for (const [key, val] of Object.entries(item)) {
                    if (typeof val === 'number') await updateDefinition('MATRIX', key, val);
                    else if (typeof val === 'string' && val.length < 10) await updateDefinition('ICON', key, val);
                }
                report.push({ é¡å‹: "ğŸ¨/â³ æ‰¹é‡", é …ç›®: Object.keys(item)[0] + '...', ç‹€æ…‹: "æ˜ å°„å®Œæˆ" });
            }
        }

        // ğŸŒŸ 2. æ ¸å¿ƒç‰©ç†åŒæ­¥
        if (window.dbManager && window.dbManager.db) {
            const tx = dbManager.db.transaction(['transport_store', 'staging_store'], 'readwrite');
            if (tPayload.length > 0) tPayload.forEach(d => tx.objectStore('transport_store').put(d));
            if (sPayload.length > 0) sPayload.forEach(d => tx.objectStore('staging_store').put(d));
            await new Promise(r => tx.oncomplete = r);
            console.log(`ğŸ’¾ ç‰©ç†é–å®šæˆåŠŸ: staging_store(${sPayload.length})`);
        }

        // ğŸŒŸ 3. å¼·åˆ¶è§£é™¤æ›´æ–°é–ä¸¦å­˜æª”
        window.isTransportUpdating = false; 
        if (typeof saveData === 'function') await saveData(true); 
        
        // ğŸŒŸ 4. UI ä»‹é¢è‡ªå‹•å°èˆªèˆ‡åˆ·æ–°
        if (inputField) inputField.value = '';
        if (typeof renderBucketList === 'function') renderBucketList();
        if (typeof switchSubView === 'function') switchSubView('bucket');

        console.table(report);
        const successMsg = `âœ… ç‰©ç†è£œçµ¦æˆåŠŸï¼\nè™•ç†: ${items.length} ç­† | æ™¯é»å·²å…¥åº«: ${sPayload.length}`;
        if (typeof showMessage === 'function') showMessage(successMsg, 'success');
        else alert(successMsg);

    } catch (e) {
        console.error("âŒ å¼•æ“é‹ä½œå´©æ½°:", e);
        window.isTransportUpdating = false;
        alert("âŒ æ³¨å…¥å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤æˆ–ç‰©ç†è¡çª");
    }
}

/** ğŸ§  è¤‡è£½ç‡ƒæ–™å°ˆç”¨ AI æŒ‡ä»¤ (v3.5.1)
 * ä½œç”¨ï¼šç”¢å‡ºç¬¦åˆ v3.5.0 å¤§ä¸€çµ±åˆ†æµæ¶æ§‹çš„ç²¾æº– JSON æ ¼å¼æŒ‡ä»¤
 * æ•´åˆï¼šæ–°å¢äº¤é€šè·¯ç¶²èˆ‡ UI é…ç½®æ ¼å¼ï¼Œç¢ºä¿å…¨æ¨¡çµ„ç‰©ç†åŒ–å°ä½
 */
function copyFuelAiPrompt() {
    const promptText = `è«‹å¹«æˆ‘ç”Ÿæˆæ—…è¡Œç‡ƒæ–™åŒ… JSONã€‚è«‹æ ¹æ“šæˆ‘çš„éœ€æ±‚æä¾›ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®æ ¼å¼ï¼ˆæˆ–æ··åˆæ ¼å¼ï¼‰ï¼š

1. ğŸš‰ äº¤é€šè·¯ç¶²ï¼š[{"operator_id": "æ¥­è€…", "line_id": "ç·šè·¯å", "color": "HEXé¡è‰²", "stations": ["ç«™1", "ç«™2"], "description": "ç°¡ä»‹"}]
2. â³ ç§»å‹•çŸ©é™£ï¼š[{"routeKey": "èµ·é»-çµ‚é»", "time": åˆ†é˜}]
3. ğŸŒ åœ°ç†æŒ‡ç´‹ï¼š[{"regionName": "å€å", "aliases": ["åˆ¥å1", "åˆ¥å2"]}]
4. ğŸŒ ç¿»è­¯æ”¶è—ï¼š[{"q": "ä¸­æ–‡", "a": "æ—¥æ–‡", "romaji": "ç¾…é¦¬éŸ³", "category": "åˆ†é¡"}]
5. ğŸ¨ UIåœ–ç¤º/æ™‚é–“ï¼š{"é—œéµå­—": "Emojiæˆ–åˆ†é˜æ•¸"}

è«‹ç›´æ¥æä¾›ç´” JSON ä»£ç¢¼é™£åˆ—ï¼Œä¸è¦åŒ…å«ä»»ä½• Markdown èªªæ˜æ–‡å­—ã€‚`;
    
    // ä½¿ç”¨ç¾ä»£ Clipboard API ç¢ºä¿ç€è¦½å™¨ç›¸å®¹æ€§
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(promptText).then(() => {
            const btn = event?.target;
            const originalText = btn ? btn.innerText : "ğŸ§  è¤‡è£½ AI æŒ‡ä»¤";
            
            if (btn) btn.innerText = "âœ… æŒ‡ä»¤å·²è¤‡è£½";
            alert("ğŸ“‹ æˆ°ç•¥å’’èªå·²å­˜å…¥å‰ªè²¼ç°¿ï¼\nè«‹è²¼çµ¦ Gemini ç”¢ç”Ÿç¬¦åˆå¤§ä¸€çµ±æ¶æ§‹çš„ç‡ƒæ–™ JSONã€‚");
            
            if (btn) setTimeout(() => btn.innerText = originalText, 2000);
        }).catch(err => {
            console.error('å„²å­˜è‡³å‰ªè²¼ç°¿å¤±æ•—:', err);
            // é™ç´šè™•ç†ï¼šè‹¥ API å¤±æ•—å‰‡å½ˆå‡ºæç¤º
            prompt("è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å’’èªï¼š", promptText);
        });
    } else {
        // æ¥µç«¯é™ç´šæ–¹æ¡ˆ
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡æœ¬ã€‚");
    }
}


// settingsviewå‡½æ•¸ç›¸é—œçµæŸ


/** æ¸²æŸ“ç¿»è­¯èˆ‡æƒ…å¢ƒå°è©±è¦–åœ– */
function renderTranslateView() {
    const container = document.getElementById('translate-view');
    if (!container) return;

    // ç¢ºä¿ state ä¸­æœ‰å¿…è¦çš„è¨­å®š
    const geminiValue = state.theme.geminiKey ? '****************' : '';

    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg w-full">
            <h3 class="text-xl font-bold mb-6 theme-text-pink flex items-center">
                <span class="mr-2">ğŸŒ</span> å³æ™‚ç¿»è­¯èˆ‡æƒ…å¢ƒå°è©±
            </h3>
            
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-2 text-sm">å–®å¥ç¿»è­¯èˆ‡èªéŸ³</h4>
                <div class="relative mb-3">
                    <textarea id="translate-input" class="w-full p-4 border border-gray-200 rounded-2xl focus:ring-2 theme-border-pink outline-none h-24 text-sm pr-12" 
                        placeholder="è¼¸å…¥ä¸­æ–‡æˆ–æ—¥æ–‡..." oninput="simulateTranslate()"></textarea>
                    <button onclick="startVoiceInput()" class="absolute bottom-3 right-3 p-2.5 rounded-full bg-red-500 text-white hover:bg-red-600 shadow-lg transition">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zM3 8a7 7 0 0114 0v2a1 1 0 11-2 0V8a5 5 0 00-10 0v2a1 1 0 11-2 0V8zM8 17a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/></svg>
                    </button>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-2xl border border-gray-100 mb-4">
                    <p class="text-[10px] text-gray-400 font-black uppercase mb-1">ç¿»è­¯çµæœ</p>
                    <div id="translate-output" class="text-base font-bold text-gray-800">ç­‰å¾…è¼¸å…¥...</div>
                    <div id="audio-placeholder" class="mt-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="playCurrentTranslation()" class="py-2.5 rounded-xl border-2 theme-border-pink theme-text-pink font-bold text-xs hover:theme-bg-light transition">ğŸ—£ï¸ èªéŸ³å›é¥‹ (æ—¥æ–‡)</button>
                    <input type="file" id="photo-translate-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    <label for="photo-translate-input" class="cursor-pointer py-2.5 rounded-xl border-2 theme-border-pink theme-text-pink font-bold text-xs text-center hover:theme-bg-light transition">ğŸ“¸ æ‹ç…§ç¿»è­¯</label>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <h4 class="font-bold text-gray-700 mb-3 text-sm">ğŸ¤– AI æƒ…å¢ƒå°è©±ç”Ÿæˆ</h4>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="keyword-input" placeholder="é—œéµå­— (å¦‚: é£¯åº—é»é¤, è—¥å¦)" class="flex-grow p-3 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 theme-border-pink">
                    <button onclick="generateDialogue()" class="px-6 py-2 theme-pink text-white rounded-xl font-bold text-xs shadow-md">ç”Ÿæˆå°è©±</button>
                </div>
                <div id="dialogue-output" class="space-y-4 min-h-[100px]">
                    <p class="text-[10px] text-gray-400 text-center py-8">è¼¸å…¥ä¸»é¡Œå¾Œï¼ŒAI æœƒç‚ºæ‚¨æº–å‚™å•è©±ç¯„ä¾‹ã€‚</p>
                </div>
            </div>

            <div class="mt-8 border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-black text-gray-700 flex items-center">
                        <span class="mr-2 text-lg">ğŸ“‚</span> æˆ‘çš„æ”¶è—åŒ£
                    </h4>
                    <button onclick="clearTranslationVault()" class="text-[10px] text-gray-400 hover:text-red-500">æ¸…ç©ºæ”¶è—</button>
                </div>
                <div id="translation-vault-container" class="space-y-3 max-h-[300px] overflow-y-auto no-scrollbar pb-10">
                    </div>
            </div>
        </div>
    `;
    
    // æ¸²æŸ“å®Œ HTML å¾Œï¼Œå»¶é²ä¸€ä¸‹ä¸‹å†æŠ“è³‡æ–™åº«ï¼Œé¿å…å®¹å™¨é‚„æ²’æ›è¼‰å®Œæˆ
    setTimeout(() => {
        if (typeof renderTranslationVault === 'function') renderTranslationVault();
    }, 50);
}

/** ğŸ­ æ¸²æŸ“å‚™é¸åå–® (v7.7 ä½ˆå±€å°ä½ç‰ˆ) 
 * ä¿®æ­£ï¼šAI æŒ‡ä»¤éµç§»è‡³å³ä¸Šï¼Œæ‰¹æ¬¡è½‰æ›éµä½æ–¼å³ä¸‹ï¼Œç¢ºä¿è¼¸å…¥æ¡†ç©ºé–“å‘¼å¸æ„Ÿã€‚
 */
function renderBucketView() {
    const el = document.getElementById('bucket-view');
    if (!el) return;

    // ğŸŒŸ 1. åŒæ­¥è®€å–è¨˜æ†¶é«”æ•¸æ“š
    const stats = {
        places: (state.privateData || []).length, 
        dict: (window.GLOBAL_DICT || []).length,   
        ready: (state.bucketList || []).length   
    };

    // ğŸŒŸ 2. èƒŒæ™¯ç‰©ç†æ ¡æº–
    dbManager.getAll('private_store').then(res => {
        const span = document.getElementById('stats-db-pts');
        if (span) span.innerText = res.length || 1;
    });

    const aiInstruction = "ã€AI å–šé†’æŒ‡ä»¤ v2.0ã€‘æ ¸å¿ƒä»»å‹™ï¼šç”Ÿæˆé«˜å“è³ªç¦å²¡/ä¹å·ç‡ƒæ–™åŒ…ã€‚æ ¼å¼è¦ç¯„ï¼šå¿…é ˆä½¿ç”¨ JSON é™£åˆ—ï¼Œæ¬„ä½å« name, category(é£Ÿ/è¡£/ä½/è¡Œ/è‚²/æ¨‚), area, notesã€‚æŠ€è¡“è¦æ±‚ï¼š1. äº¤é€šé …ç›®éœ€åŒ…å« [[ç«™é»æ¸…å–®]] èˆ‡ {{ç‡Ÿé‹å–®ä½}}ã€‚ 2. æ™¯é»æè¿°è‹¥å«å¿…è²·ç‰©éœ€ä½¿ç”¨ [[å•†åº—ï¼šå“å | åƒ¹æ ¼]] æ ¼å¼ã€‚ 3. æ‰€æœ‰è³‡è¨Šé ˆç‚º 2026 æœ€æ–°å¯¦æ¸¬ã€‚";

    el.innerHTML = `
        <style>
            @keyframes pink-shimmer {
                0%, 100% { filter: drop-shadow(0 0 2px rgba(233, 30, 99, 0.4)); opacity: 1; }
                50% { filter: drop-shadow(0 0 5px rgba(233, 30, 99, 0.8)); opacity: 0.9; }
            }
            .pink-neon-text { animation: pink-shimmer 2.5s ease-in-out infinite; }
            .capsule-bg { background-color: var(--color-bg-light-mixed); border: 1px solid var(--color-border-light-mixed); }
        </style>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 w-full transition-all animate-in fade-in duration-300">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <h2 class="text-2xl font-bold theme-text-pink flex items-center">
                    <span class="mr-2">ğŸ’</span> å‚™é¸å£è¢‹åå–®
                </h2>
                
                <div class="flex items-center gap-1 capsule-bg px-4 py-1.5 rounded-full shadow-sm">
                    <div class="flex items-center gap-1.5 px-2">
                        <span class="text-[9px] font-black theme-text-pink opacity-60 uppercase">æ™¯é»</span>
                        <span id="stats-db-pts" class="text-base font-black italic theme-text-pink pink-neon-text leading-none">${stats.places || 1}</span>
                    </div>
                    <div class="w-px h-3 bg-pink-200"></div>
                    <div class="flex items-center gap-1.5 px-2">
                        <span class="text-[9px] font-black theme-text-pink opacity-60 uppercase">å­—å…¸</span>
                        <span class="text-base font-black italic theme-text-pink pink-neon-text leading-none">${stats.dict}</span>
                    </div>
                    <div class="w-px h-3 bg-pink-200"></div>
                    <div class="flex items-center gap-1.5 px-2">
                        <span class="text-[9px] font-black theme-text-pink opacity-60 uppercase">å¾…å‘½</span>
                        <span class="text-base font-black italic theme-text-pink pink-neon-text leading-none">${stats.ready}</span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 rounded-[2.2rem] border border-gray-200 p-5 mb-6 relative">
                <div class="flex justify-between items-center mb-3 px-1">
                    <label class="block text-sm font-bold text-gray-700">å¿«é€ŸåŠ å…¥åº—å®¶ (JSON ç‡ƒæ–™åŒ…)</label>
                    <button onclick="navigator.clipboard.writeText('${aiInstruction}'); alert('ğŸš€ AI å–šé†’æŒ‡ä»¤ 2.0 å·²è¤‡è£½ï¼')" 
                            class="text-xs text-pink-500 hover:text-pink-700 font-medium flex items-center bg-pink-50 px-2 py-1 rounded-md transition">
                        ğŸ§  è¤‡è£½ AI æŒ‡ä»¤ 2.0
                    </button>
                </div>
                
                <textarea id="bucket-raw-input" 
                          class="w-full h-24 p-4 bg-white rounded-2xl text-sm outline-none focus:ring-2 focus:ring-pink-200 shadow-inner border-0 placeholder:text-gray-300" 
                          placeholder="åœ¨æ­¤è²¼ä¸Š AI ç”Ÿæˆçš„ JSON ç‡ƒæ–™åŒ…..."></textarea>
                
                <div class="flex justify-end mt-3 px-1">
                    <button onclick="processBucketImport()" 
                            class="px-6 py-2 theme-pink text-white rounded-full text-sm font-black shadow-lg active:scale-95 transition-all">
                        âœ¨ æ‰¹æ¬¡è½‰æ›
                    </button>
                </div>
            </div>

            <div id="bucket-tabs-list" class="mt-2 mb-4"></div>
            
            <div class="mb-6 relative group px-1">
                <input type="text" oninput="handleBucketSearch(this.value)" placeholder="æœå°‹å‚™é¸æ™¯é»æˆ–åœ°å€..." 
                        class="w-full p-3.5 pl-6 border border-gray-100 rounded-full bg-gray-50 text-sm outline-none focus:bg-white focus:ring-2 theme-border-pink transition-all">
                <div class="absolute right-6 top-3.5 text-gray-300">ğŸ”</div>
            </div>

            <div id="bucket-items-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[200px]"></div>
        </div>
    `;

    // ğŸš€ å¼·åˆ¶è§¸ç™¼å­çµ„ä»¶æ¸²æŸ“
    setTimeout(() => {
        if (typeof renderBucketTabs === 'function') renderBucketTabs();
        if (typeof renderBucketItems === 'function') renderBucketItems();
    }, 50);
}


function renderMagazineContent() {
    const day = getCurrentDay();
    const container = document.getElementById('magazine-view');
    if (!day || !container) return;

    // å–å¾—è‡ªå®šç¾©æ¨™é¡Œæ–‡å­— (è‹¥ç„¡å‰‡ä½¿ç”¨é è¨­)
    const displayDayTitle = day.magazineHeader?.dayTitle || `Day ${day.dayNum}`;
    const displayEdition = day.magazineHeader?.edition || "Winter Edition 2025";
    const displaySubInfo = day.magazineHeader?.subInfo || `${day.date} / ${Array.isArray(day.city) ? day.city.join(' ') : (day.city || "")}`;

    const itemsHtml = day.schedules.map((s, index) => {
        const targetCity = Array.isArray(day.city) ? day.city[index % day.city.length] : "Japan";
        const hasUserPhoto = s.photo && s.photo.startsWith('data:image');
        const photoUrl = hasUserPhoto ? s.photo : `https://loremflickr.com/g/800/1000/${encodeURIComponent(targetCity + ',building')}/all?lock=${index + day.dayNum}`;
        
        return `
            <div class="magazine-item">
                <div class="magazine-media">
                    <div class="magazine-photo-wrapper">
                        <div class="photo-upload-overlay" onclick="triggerPhotoUpload('${s.id}')">
                            <div class="bg-black/40 hover:bg-pink-600 text-white p-2 rounded-full backdrop-blur-sm transition shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /></svg>
                            </div>
                        </div>
                        <img src="${photoUrl}" class="magazine-photo ${hasUserPhoto ? 'user-uploaded' : ''}" style="opacity: 1;">
                        <div class="photo-overlay"></div>
                    </div>
                </div>
                
                <div class="magazine-pin"><span class="magazine-time">${s.startTime}</span></div>
		<div class="magazine-info">
                    <span class="magazine-category-tag">${getStyleName(s.style, s.customStyle)}</span>
                    <h3 contenteditable="true" onblur="saveMagazineText('${s.id}', 'name', this.innerText)">${s.name}</h3>
                    <div class="magazine-desc-text" contenteditable="true" onblur="saveMagazineText('${s.id}', 'notes', this.innerHTML)">
                        ${s.aiPlus || s.notes || 'é»æ“Šç·¨è¼¯å…§å®¹...'}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = `
        <div class="magazine-container">
            <div class="magazine-timeline-line"></div>
            <div class="relative bg-white z-20 py-24 mb-10 text-center border-b border-gray-50">
                <div class="inline-block px-4 py-1 mb-6 border-y border-gray-800 text-[10px] font-black tracking-[0.8em] uppercase" 
                     contenteditable="true" onblur="saveMagazineHeader('edition', this.innerText)">
                    ${displayEdition}
                </div>
                <h1 class="text-8xl font-serif font-black text-gray-900 tracking-tighter mb-6" 
                    contenteditable="true" onblur="saveMagazineHeader('dayTitle', this.innerText)">
                    ${displayDayTitle}
                </h1>
                <div class="font-mono text-[11px] tracking-[0.2em] text-gray-500 uppercase" 
                     contenteditable="true" onblur="saveMagazineHeader('subInfo', this.innerText)">
                    ${displaySubInfo}
                </div>
            </div>
            ${itemsHtml}
        </div>
    `;
}

/** å„²å­˜é›œèªŒé  Header çš„è‡ªå®šç¾©æ–‡å­— */
function saveMagazineHeader(field, value) {
    const day = getCurrentDay();
    if (!day.magazineHeader) day.magazineHeader = {};
    day.magazineHeader[field] = value;
    saveData();
    showMessage('åˆŠé ­æ–‡å­—å·²æ›´æ–°', 'success');
}

/** å„²å­˜é›œèªŒé å€‹åˆ¥æ’ç¨‹çš„æ–‡å­—ä¿®æ”¹ */
function saveMagazineText(scheduleId, field, value) {
    const day = getCurrentDay();
    const schedule = day.schedules.find(s => s.id === scheduleId);
    if (schedule) {
        schedule[field] = value;
        saveData();
        // å¦‚æœä¿®æ”¹çš„æ˜¯åç¨±ï¼ŒåŒæ­¥æ›´æ–°è¡Œç¨‹é é¢å…§å®¹
        renderDayContent(); 
    }
}


        /**
         * é–‹å•Ÿè¡Œç¨‹è©³æƒ…é  (éœ€è²æ˜ç‚º function)
         * @param {string} tripId
         */
        function openTripDetail(tripId) {
            switchView('detail', tripId);
        };
        
        /**
         * é–‹å•Ÿè¡Œç¨‹ç·¨è¼¯æ¨¡æ…‹æ¡† (éœ€è²æ˜ç‚º function)
         * @param {string} tripId
         * @param {string} tripName
         */
        function openTripEditModal(tripId, tripName) {
            // è¨­ç½®ç•¶å‰è¦ç·¨è¼¯çš„è¡Œç¨‹ ID
            state.currentTripId = tripId;
            document.getElementById('current-trip-id-for-edit').value = tripId;
            document.getElementById('edit-trip-name').value = tripName;
            toggleModal('trip-edit-modal');
        }
        
/** å¾¹åº•æ¸…é™¤ä½å®¿è³‡è¨Š (æ”¯æ´ ai-lodging- å‰ç¶´) */
function clearLodgingInfo(prefix) {
    if (!confirm('ç¢ºå®šè¦æ¸…ç©ºç•¶å¤©çš„ä½å®¿è³‡è¨Šå—ï¼Ÿ')) return;

    // 1. æ¸…é™¤ UI æ¬„ä½å…§å®¹
    const nameEl = document.getElementById(`${prefix}name`);
    const addrEl = document.getElementById(`${prefix}address`);
    // å¦‚æœæœ‰é›»è©±æ¬„ä½ä¹Ÿä¸€ä½µæ¸…é™¤ (é›–ç„¶ AI æ¨¡å¼ç›®å‰æ²’ç•«é›»è©±æ¡†ï¼Œä½†å»ºè­°é ç•™)
    const phoneEl = document.getElementById(`${prefix}phone`); 

    if (nameEl) nameEl.value = '';
    if (addrEl) addrEl.value = '';
    if (phoneEl) phoneEl.value = '';

    // 2. æ¸…é™¤æ•¸æ“šçµæ§‹ä¸­çš„é€£çµ
    const day = getCurrentDay();
    if (day) {
        // åŒæ™‚æ¸…é™¤æ‰‹å‹•èˆ‡ AI æ¬„ä½ä»¥ç¢ºä¿ä¹¾æ·¨
        if (prefix.includes('ai')) {
            delete day.accommodation; 
        }
        day.lodging = {}; 
        day.lodgingStatus = 'stay'; 
    }

    showMessage('ä½å®¿è³‡è¨Šå·²é‡ç½®', 'info');
}
        
        // ** æ–°å¢ Lodging List é¸æ“‡åŠŸèƒ½ **
        /**
         * è¼‰å…¥é¸æ“‡çš„ä½å®¿è³‡è¨Šåˆ°è¡¨å–®
         * @param {object} lodgingData - åŒ…å« name, address, phone çš„ä½å®¿ç‰©ä»¶
         * @param {string} prefix - è¡¨å–® ID å‰ç¶´ ('lodging-' æˆ– 'ai-lodging-')
         */
        function selectLodging(lodgingData, prefix) {
            document.getElementById(`${prefix}name`).value = lodgingData.name;
            document.getElementById(`${prefix}address`).value = lodgingData.address;
            document.getElementById(`${prefix}phone`).value = lodgingData.phone;
            toggleModal('lodging-list-modal');
            showMessage(`å·²è¼‰å…¥ä½å®¿ï¼š${lodgingData.name}`, 'info');
        }
        
/** * ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºä½å®¿æ¸…å–®
 * ç¢ºä¿ prefix èƒ½æ­£ç¢ºå‚³éï¼Œä»¥ä¾¿å°‡è³‡æ–™å¡«å…¥å°æ‡‰çš„æ¨¡æ…‹æ¡† (lodging- æˆ– ai-lodging-)
 */
function showLodgingList(prefix) {
    const container = document.getElementById('lodging-list-container');
    container.innerHTML = '<p class="text-gray-500 text-sm italic text-center py-4">æ­£åœ¨è®€å–éå¾€ä½å®¿ç´€éŒ„...</p>';
    
    // å„²å­˜å‰ç¶´ï¼Œä»¥ä¾¿é»æ“Šæ¸…å–®é …ç›®æ™‚ä½¿ç”¨
    document.getElementById('lodging-prefix-for-load').value = prefix;

    // 1. æ”¶é›†æ‰€æœ‰è¡Œç¨‹ä¸­ã€Œå”¯ä¸€ã€çš„ä½å®¿è³‡è¨Š
    const uniqueLodgings = new Map();
    state.trips.forEach(trip => {
        trip.days.forEach(day => {
            if (day.lodging && day.lodging.name && day.lodging.name.trim()) {
                const key = day.lodging.name.trim();
                if (!uniqueLodgings.has(key)) {
                    uniqueLodgings.set(key, {
                        name: key,
                        address: day.lodging.address || '',
                        phone: day.lodging.phone || ''
                    });
                }
            }
        });
    });

    // 2. æ¸²æŸ“æ¸…å–®ä»‹é¢
    let listHTML = '';
    if (uniqueLodgings.size > 0) {
        listHTML = Array.from(uniqueLodgings.values()).map(lodging => {
            // ç·¨ç¢¼è³‡æ–™ä»¥é˜²ç‰¹æ®Šå­—å…ƒéŒ¯èª¤
            const encodedData = encodeURIComponent(JSON.stringify(lodging));
            return `
                <button type="button" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition group mb-2" 
                        onclick="selectLodging(JSON.parse(decodeURIComponent('${encodedData}')), '${prefix}')">
                    <p class="font-bold text-gray-800 group-hover:text-blue-700">${lodging.name}</p>
                    <p class="text-xs text-gray-500 truncate">${lodging.address || 'ç„¡åœ°å€è³‡è¨Š'}</p>
                </button>
            `;
        }).join('');
    } else {
        listHTML = '<p class="text-gray-500 text-sm text-center py-4">ç›®å‰æ²’æœ‰å·²å­˜çš„ä½å®¿ç´€éŒ„ã€‚</p>';
    }
    
    container.innerHTML = listHTML;
    toggleModal('lodging-list-modal');
}


/** * ä¿®æ­£ç‰ˆï¼šé¸æ“‡ä½å®¿ä¸¦å¡«å…¥
 */
function selectLodging(data, prefix) {
    // æ ¹æ“š prefix å¡«å…¥å°æ‡‰çš„ Input ID
    const nameEl = document.getElementById(`${prefix}name`);
    const addrEl = document.getElementById(`${prefix}address`);
    const phoneEl = document.getElementById(`${prefix}phone`);

    if (nameEl) nameEl.value = data.name || '';
    if (addrEl) addrEl.value = data.address || '';
    if (phoneEl) phoneEl.value = data.phone || '';

    toggleModal('lodging-list-modal');
    showMessage(`å·²è¼‰å…¥ï¼š${data.name}`, 'success');
}

/** * ä¿®æ­£ç‰ˆï¼šå¾¹åº•æ¸…é™¤ä½å®¿è³‡è¨Š
 * ä¸åƒ…æ¸…é™¤æ¬„ä½ï¼Œä¹Ÿå°‡ç•¶å‰å¤©æ•¸çš„æ•¸æ“šç‰©ä»¶é‡ç½®
 */
function clearLodgingInfo(prefix) {
    if (!confirm('ç¢ºå®šè¦æ¸…ç©ºç•¶å¤©çš„ä½å®¿è³‡è¨Šå—ï¼Ÿ')) return;

    // 1. æ¸…é™¤ UI æ¬„ä½
    const nameEl = document.getElementById(`${prefix}name`);
    const addrEl = document.getElementById(`${prefix}address`);
    const phoneEl = document.getElementById(`${prefix}phone`);

    if (nameEl) nameEl.value = '';
    if (addrEl) addrEl.value = '';
    if (phoneEl) phoneEl.value = '';

    // 2. æ¸…é™¤ç‹€æ…‹è³‡æ–™ (é‡å°ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„å¤©æ•¸)
    const day = getCurrentDay();
    if (day) {
        day.lodging = { name: '', address: '', phone: '' };
        day.lodgingStatus = 'stay'; // é‡ç½®ç‚ºé è¨­
    }

    showMessage('ä½å®¿è³‡è¨Šå·²é‡ç½®', 'info');
}


/**
 * é–‹å•Ÿå–®æ—¥ç·¨è¼¯æ¨¡æ…‹æ¡†ä¸¦è¼‰å…¥ç¾æœ‰è³‡æ–™
 */
function openDayEditModal() {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!day || !trip) return;

    const isFirstDay = (day.dayNum === 1);
    const isLastDay = (day.dayNum === trip.days.length);

    // 1. è¨­å®šæ¨™é¡Œèˆ‡éš±è—çš„ Index
    document.getElementById('edit-day-modal-title').textContent = `ç·¨è¼¯ ç¬¬ ${day.dayNum} å¤©è¡Œç¨‹`;
    document.getElementById('edit-day-index').value = state.currentDayIndex;

    // 2. å¡«å……åŸºç¤æ—¥æœŸèˆ‡æ™‚é–“
    document.getElementById('edit-day-date').value = day.date || '';
    document.getElementById('edit-day-start-time').value = day.startTime || '08:00';
    document.getElementById('edit-day-end-time').value = day.endTime || '22:00';

    // 3. å¡«å……åŸå¸‚å€åŸŸ (Array è™•ç†)
    const cityContainer = document.getElementById('city-inputs-container');
    cityContainer.innerHTML = ''; 
    const cities = Array.isArray(day.city) ? day.city : (day.city ? [day.city] : []);
    if (cities.length === 0) {
        addCityInput('city-inputs-container'); // å¦‚æœæ²’è³‡æ–™ï¼Œé è¨­çµ¦ä¸€å€‹æ¡†
    } else {
        cities.forEach(city => addCityInput('city-inputs-container', city));
    }

    // 4. å¡«å……ã€Œå…¥å¢ƒè³‡è¨Šã€(åƒ…ç¬¬ä¸€å¤©é¡¯ç¤º)
    const arrivalGroup = document.getElementById('arrival-info-group');
    if (isFirstDay) {
        arrivalGroup.classList.remove('hidden');
        const info = day.arrivalInfo || {};
        document.getElementById('arrival-departure-airport').value = info.departureAirport || '';
        document.getElementById('arrival-departure-time').value = info.departureTime || '';
        document.getElementById('arrival-airport').value = info.airport || '';
        document.getElementById('arrival-time').value = info.time || '';
        document.getElementById('arrival-flight').value = info.flight || '';
        document.getElementById('arrival-transport-mode').value = info.transportMode || 'train';
    } else {
        arrivalGroup.classList.add('hidden');
    }

    // 5. å¡«å……ã€Œé›¢å¢ƒè³‡è¨Šã€(åƒ…æœ€å¾Œä¸€å¤©é¡¯ç¤º)
    const departureGroup = document.getElementById('departure-info-group');
    if (isLastDay) {
        departureGroup.classList.remove('hidden');
        const info = day.departureInfo || {};
        document.getElementById('departure-airport').value = info.airport || '';
        document.getElementById('departure-time').value = info.time || '';
        document.getElementById('departure-arrival-airport').value = info.arrivalAirport || '';
        document.getElementById('departure-arrival-time').value = info.arrivalTime || '';
        document.getElementById('departure-flight').value = info.flight || '';
        document.getElementById('departure-transport-mode').value = info.transportMode || 'train';
    } else {
        departureGroup.classList.add('hidden');
    }

    // 6. å¡«å……ã€Œä½å®¿è³‡è¨Šã€
    if (day.lodging) {
        document.getElementById('lodging-name').value = day.lodging.name || '';
        document.getElementById('lodging-address').value = day.lodging.address || '';
        document.getElementById('lodging-phone').value = day.lodging.phone || '';
    }

    // 7. è¨­å®šã€Œä½å®¿ç‹€æ…‹ã€ (çºŒä½/é€€æˆ¿)
    if (day.lodgingStatus === 'check-out') {
        document.getElementById('lodging-status-check-out').checked = true;
    } else {
        document.getElementById('lodging-status-stay').checked = true; // é è¨­çºŒä½
    }

    // æœ€çµ‚é¡¯ç¤ºè¦–çª—
    toggleModal('edit-day-modal');
}

/**
 * éœ€æ±‚ 3: å‹•æ…‹å¢åŠ äº¤é€šåå¥½é¸å–®
 * @param {string} initialValue - é è¨­é¸ä¸­çš„å€¼
 */
function addTransportPreference(initialValue = 'subway') {
    const container = document.getElementById('transport-pref-container');
    if (!container) return;
    
    const div = document.createElement('div');
    div.className = 'transport-pref-item flex items-center space-x-2 mb-2 bg-blue-50 p-2 rounded-lg border border-blue-100 animate-fade-in';
    
    // é€™è£¡å®šç¾©äº† AI è¦åŠƒæ™‚å¯é¸çš„äº¤é€šå·¥å…·æ¸…å–®
    div.innerHTML = `
        <span class="text-blue-400 font-bold text-xs drag-handle cursor-move">â˜°</span>
        <select class="flex-1 p-2 border border-gray-300 rounded text-sm transport-pref-select bg-white">
            <option value="train" ${initialValue === 'train' ? 'selected' : ''}>é«˜éµ / æ–°å¹¹ç·š</option>
            <option value="subway" ${initialValue === 'subway' ? 'selected' : ''}>ç«è»Š / åœ°éµ</option>
            <option value="bus" ${initialValue === 'bus' ? 'selected' : ''}>å·´å£« / å…¬è»Š</option>
            <option value="walk" ${initialValue === 'walk' ? 'selected' : ''}>æ­¥è¡Œå„ªå…ˆ</option>
            <option value="drive" ${initialValue === 'drive' ? 'selected' : ''}>è‡ªé§•</option>
            <option value="taxi" ${initialValue === 'taxi' ? 'selected' : ''}>è¨ˆç¨‹è»Š</option>
        </select>
        <button type="button" onclick="this.parentElement.remove()" class="text-red-400 font-bold px-2 hover:text-red-600 transition">Ã—</button>
    `;
    container.appendChild(div);
}


/** è¼”åŠ©å‡½å¼ï¼šæ–°å¢åŸå¸‚è¼¸å…¥æ¡† */
function addAICityInput(value = '') {
    const container = document.getElementById('ai-city-inputs-container');
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2 mb-2 animate-fade-in';
    div.innerHTML = `
        <input type="text" name="cities[]" value="${value}" 
               class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
               placeholder="ä¾‹å¦‚ï¼šæ±äº¬">
        <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-1">
            <i class="fas fa-times-circle"></i>
        </button>
    `;
    container.appendChild(div);
}

    // --- NEW: å”åŠ©æ¸…é™¤ AI è¼¸å‡ºä¸­å¤šé¤˜çš„ç¬¦è™Ÿ (å¦‚ $$ æˆ– #) ---
function cleanAIText(text) {
    if (!text) return '';
    return text.toString()
            .replace(/\$\$/g, '') 
            .replace(/##/g, '')
            // ç§»é™¤åŸæœ¬æœƒéæ¿¾ [ ] ( ) çš„æ­£å‰‡ï¼Œä¿ç•™æ™ºæ…§äº¤é€šæ¨™ç±¤
            .trim();
}


/** æ¨¡çµ„ D: è³‡æ–™è§£æèˆ‡æ™ºæ…§æ¨™ç±¤ä¿®å¾© */
function processAISchedules(schedules, day) {
    return schedules.map(s => {
        let notes = s.notes || "";
        // æ™ºæ…§æ¨™ç±¤è‡ªå‹•ä¿®å¾© (é˜²ç¦¦ AI æ¼å¯«æ‹¬è™Ÿ)
        if (String(s.style).toLowerCase() === 'transport' && notes) {
            if (!notes.includes('[[')) {
                const geoMatch = notes.match(/([^\s,]+(?:ç«™|å‰|ç”º|é–€|å£|è™•)(?:,\s*[^\s,]+(?:ç«™|å‰|ç”º|é–€|å£|è™•))+)/);
                if (geoMatch) notes = notes.replace(geoMatch[1], `[[${geoMatch[1]}]]`);
            }
            if (!notes.includes('{{')) {
                const opMatch = notes.match(/([^\s]+(?:äº¤é€šå±€|å·´å£«|éµé“|JR))/);
                if (opMatch) notes = notes.replace(opMatch[1], `{{${opMatch[1]}}}`);
            }
        }
        return {
            id: s.id || generateUUID(),
            isAI: true,
            ...s,
            durationHours: parseFloat(s.durationHours) || 1,
            name: cleanAIText(s.name),
            notes: cleanAIText(notes.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\\n/g, '<br>')),
            style: s.style || 'other'
        };
    });
}

/**
 * æ¨¡çµ„ D: è¦–åœ–åŒæ­¥
 */
function applySchedulesToDay(day, newSchedules) {
    day.schedules = newSchedules;
    recalculateScheduleTimes(day);
    saveData();
    renderDayContent();
    if (state.currentSubView === 'magazine') renderMagazineContent();
}

        
/**
 * ç²¾ç°¡å¼·åŒ–ç‰ˆï¼šAI å‰µæ„å…§å®¹ç”Ÿæˆ (v1.6.3)
 * æ•´åˆï¼šè²»ç”¨è¿½è¹¤ã€æ ¸å¿ƒé€šè¨Šæ¨¡çµ„ã€Markdown é«˜åŠè§£æ
 */
async function fetchAICreativeContent(scheduleId, prompt) {
    if (!state.theme.geminiKey) {
        showMessage('è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­è¼¸å…¥ API Keyï¼', 'error');
        return null;
    }

    // 1. UI åé¥‹ï¼šé–‹å•Ÿè¼‰å…¥å‹•ç•«
    toggleModal('ai-loading-modal');
    const loadingMsg = document.getElementById('ai-loading-message');
    if (loadingMsg) loadingMsg.textContent = 'AI æ­£åœ¨ç™¼æ®æƒ³åƒåŠ›...';

    try {
        // 2. å‘¼å«æ ¸å¿ƒé€šè¨Šæ¨¡çµ„ (callGeminiWithRetry)
        // é€™æ¨£æœƒè‡ªå‹•è§¸ç™¼ trackApiUsage çµ±è¨ˆè²»ç”¨
        const text = await callGeminiWithRetry(prompt);

        if (!text) throw new Error("å›å‚³æ–‡å­—ç‚ºç©º");

        // 3. æ ¼å¼åŒ–è™•ç† (å¼·åŒ–ç‰ˆè§£æ)
        const formattedText = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
            .replace(/###\s+(.*)/g, '<h5 class="font-bold text-blue-600 mt-2">$1</h5>') // æ¨™é¡Œç¾åŒ–
            .replace(/\*(.*?)\*/g, '$1') 
            .replace(/\n/g, '<br>');

        // âš ï¸ ä¿æŒåŸè¨­è¨ˆï¼šä¸åœ¨æ­¤è™•é—œé–‰ Modalï¼Œäº¤ç”±å‘¼å«è€… (å¦‚ generateStory) è™•ç†åŒæ­¥å¾Œé—œé–‰
        return formattedText;

    } catch (error) {
        console.error("å‰µæ„å…§å®¹ç”Ÿæˆå¤±æ•—:", error);
        
        // å¾¹åº•å¤±æ•—æ™‚æ‰å¼·åˆ¶é—œé–‰ Loading
        const loader = document.getElementById('ai-loading-modal');
        if (loader && !loader.classList.contains('hidden')) {
            toggleModal('ai-loading-modal');
        }
        
        showMessage(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, 'error');
        return null;
    }
}

/** * çµ‚æ¥µæ•´åˆç‰ˆï¼šç”Ÿæˆæ™¯é»æ•…äº‹ (æ„Ÿæ€§èªªæ›¸äºº v2.0)
 * ä¿ç•™ï¼šå¤šè—åœ–åŒæ­¥é‚è¼¯ã€å·¥åŠæ²™ç›’é˜²ç¦¦
 * å‡ç´šï¼šgetContext ç°¡åŒ–ã€æ ¸å¿ƒé€šè¨Šå°æ¥ã€è²»ç”¨çµ±è¨ˆ
 */
async function generateStory(scheduleId) {
    console.log("ğŸš€ å•Ÿå‹•æ„Ÿæ€§èªªæ›¸äººæ¨¡å¼ï¼ŒID:", scheduleId);

    // 1. ä½¿ç”¨ getContext ä¸€æ¬¡æ€§å–å¾—æ‰€æœ‰èƒŒæ™¯è³‡æ–™
    const { trip, day, schedule, workshopKey } = getContext(scheduleId);
    
    if (!schedule) {
        showMessage('æ‰¾ä¸åˆ°æ™¯é»è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        return;
    }

    // 2. æº–å‚™ Prompt (å„ªåŒ–èªæ°£æŒ‡ä»¤ï¼Œç§»é™¤å»¢è©±)
    const originalNotes = schedule.notes ? schedule.notes.replace(/<br>/g, '\n') : '';
    const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åŸå¸‚èªªæ›¸äººã€‚è«‹ç‚ºä»¥ä¸‹æ™¯é»æ’°å¯«ä¸€æ®µå……æ»¿æº«åº¦ä¸”å…·æ•…äº‹æ€§çš„æ„Ÿæ€§å°è®€ã€‚
    è¦æ±‚ï¼š
    - å­—æ•¸æ§åˆ¶åœ¨ 60 å­—ä»¥å…§ã€‚
    - èªæ°£å„ªé›…ï¼Œåƒé«˜å“è³ªæ—…éŠé›œèªŒã€‚
    - é©ç•¶ä½¿ç”¨ **ç²—é«”** æ¨™è¨˜é—œéµå­—ï¼Œä¸¦ç”¨æ›è¡Œåˆ†éš”ã€‚
    æ™¯é»ï¼š${schedule.name}
    ä½ç½®ï¼š${schedule.address || 'æ—¥æœ¬ç•¶åœ°'}
    èƒŒæ™¯ï¼š${originalNotes}`;

    try {
        // 3. å‘¼å«æ ¸å¿ƒç”Ÿæˆå‡½æ•¸ (æœƒè‡ªå‹•è¨ˆè²»èˆ‡é‡è©¦)
        const content = await fetchAICreativeContent(scheduleId, prompt);

        if (content) {
            // 4. å¯«å…¥æ™¯é»æ•¸æ“š
            schedule.aiStory = content;
            schedule.isAI = true;

            // 5. è—åœ–åŒæ­¥é‚è¼¯ (ä¿ç•™ä½ æœ€æ ¸å¿ƒçš„å¼·å¥è¨­è¨ˆ)
            if (state.planViewMode === 'workshop' && state.currentWorkshopId) {
                const ws = state.workshops.find(w => w.id === state.currentWorkshopId);
                if (ws) {
                    ws.data = JSON.parse(JSON.stringify(state.shadowItineraries));
                }
            }

            // 6. å„²å­˜èˆ‡æ¸²æŸ“
            await saveData();
            renderDayContent();

            // 7. UI æ¸…ç†
            const modal = document.getElementById('ai-loading-modal');
            if (modal && !modal.classList.contains('hidden')) {
                toggleModal('ai-loading-modal');
            }
            
            showMessage('âœ¨ æ™¯é»æ•…äº‹å·²ç·¨ç¹”å®Œæˆ', 'success');
        }
    } catch (err) {
        console.error("âŒ æ•…äº‹ç”Ÿæˆç™¼ç”Ÿå´©æ½°:", err);
        showMessage('AI æš«æ™‚é›¢ç·šï¼Œè«‹æª¢æŸ¥ API Key', 'error');
        // ç¢ºä¿ç™¼ç”Ÿæ„å¤–éŒ¯èª¤æ™‚é—œé–‰ Loading ç•«é¢
        const loader = document.getElementById('ai-loading-modal');
        if (loader) loader.classList.add('hidden');
    }
}


// b. AI PLUS å¢å¼·åŠŸèƒ½
async function aiPlusEnhance(scheduleId) {
    const day = getCurrentDay();
    const schedule = day.schedules.find(s => s.id === scheduleId);
    if (!schedule) return;

    // ç²å–ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥çš„ notes å…§å®¹ï¼Œç”¨æ–¼é¤µçµ¦ AI é€²è¡Œå¼·åŒ–åƒè€ƒ
    const originalNotesInput = schedule.notes ? schedule.notes.replace(/<br>/g, '\\n') : 'ç„¡ç¾æœ‰ç­†è¨˜ï¼Œè«‹ç”Ÿæˆè©³ç´°å»ºè­°ã€‚';

    const prompt = `ä½ æ˜¯ä¸€ä½åŸå¸‚çš„çµ•ä½³å°éŠï¼Œè«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šï¼Œå°‡è¡Œç¨‹å®‰æ’ï¼ˆè©³ç´°å…§å®¹ï¼‰é€²è¡Œæ“´å……å’Œæ·±åŒ–ã€‚å…§å®¹æ‡‰è©²æä¾›æ›´è©³ç´°çš„æ—…è¡Œå»ºè­°ï¼Œä¾‹å¦‚æœ€ä½³åƒè§€æ™‚é–“ã€éš±è—çš„ç‰¹è‰²æˆ–äº¤é€šç´°ç¯€ï¼Œä¸¦å°‡é‡é»ä»¥ç²—é«”æ¨™è¨˜ï¼Œé©ç•¶æ›è¡Œæè¿°ï¼Œé•·åº¦ç´„ 5-6 å¥ï¼š
è¡Œç¨‹åç¨±: ${schedule.name}
åœ°é»: ${schedule.address}
ç¾æœ‰è©³ç´°å…§å®¹: ${originalNotesInput}`; 
    
    const content = await fetchAICreativeContent(scheduleId, prompt);

    if (content) {
        // 1. å°‡å¼·åŒ–å…§å®¹å­˜å…¥ç¨ç«‹çš„ aiPlus æ¬„ä½
        schedule.aiPlus = content;
        
        // 2. æ¨™è¨˜ç‚º AI ç”¢å‡º
        schedule.isAI = true; 

        saveData();
        renderDayContent();
    }
}


/**
 * æ‰“é–‹å–®å€‹æ’ç¨‹çš„ AI PLUS æ¨¡æ…‹æ¡†ï¼Œä¸¦è¼‰å…¥æ‰€æœ‰å¯ç·¨è¼¯æ¬„ä½
 * @param {string} scheduleId 
 */
function openAIPerScheduleModal(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    const workshopKey = `${trip.id}_day${day.dayNum}`;

    // âœ¨ æ ¸å¿ƒä¿®æ­£ï¼šåˆ†æµå°‹æ‰¾æ™¯é»
    let schedule;
    if (state.planViewMode === 'workshop') {
        schedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        schedule = (day.schedules || []).find(s => s.id === scheduleId);
    }

    if (!schedule) return;
    
    document.getElementById('ai-schedule-modal-title').textContent = `âœ¨ AI PLUS è¡Œç¨‹å¼·åŒ–ï¼š${schedule.name}`;
    document.getElementById('ai-schedule-id-target').value = scheduleId;
    document.getElementById('ai-schedule-name').value = schedule.name;
    document.getElementById('ai-schedule-address').value = schedule.address || '';
    document.getElementById('ai-schedule-notes-input').value = schedule.notes ? schedule.notes.replace(/<br>/g, '\n') : '';
    document.getElementById('ai-schedule-rain-plan-input').value = schedule.rainPlan || '';
    document.getElementById('ai-schedule-start-time').value = schedule.startTime || '';
    document.getElementById('ai-schedule-duration').value = schedule.durationHours || 1;
    document.getElementById('ai-schedule-cost-input').value = schedule.cost || '';

    const styleValue = schedule.style || 'cultural';
    document.getElementById('ai-schedule-style-input').value = styleValue;
    toggleCustomStyleInput(styleValue, 'ai-schedule-custom-style-input', 'ai-schedule-custom-style-group');
    document.getElementById('ai-schedule-custom-style-input').value = schedule.customStyle || '';

    const transportModeEl = document.getElementById('ai-schedule-transport-mode');
    transportModeEl.value = schedule.transportMode || 'none';
    toggleCustomAITransportInput(schedule.transportMode || 'none', 'ai-schedule-custom-transport-group', 'ai-schedule-custom-transport');
    document.getElementById('ai-schedule-custom-transport').value = schedule.customTransport || '';

    toggleModal('ai-schedule-form-modal');
}


/**
 * å®Œæ•´æ•´é “ç‰ˆï¼šè™•ç† AI PLUS è¡¨å–®æäº¤
 * æ”¯æ´ï¼šè·¨è—åœ–æ•¸æ“šæœå°‹ã€è‡ªå‹•æ™‚é–“é‡ç®—ã€è—åœ–åŒæ­¥
 */
async function handleAIPerScheduleSubmit(event) {
    event.preventDefault();

    const scheduleId = document.getElementById('ai-schedule-id-target').value;
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    const workshopKey = `${trip.id}_day${day.dayNum}`;

    // âœ¨ 1. æ ¸å¿ƒæ•´é “ï¼šæ•¸æ“šä¾†æºåˆ†æµæœå°‹
    let schedule;
    let schedulesRef; // ç”¨æ–¼é‡ç®—æ™‚é–“çš„å¼•ç”¨

    if (state.planViewMode === 'workshop') {
        schedulesRef = state.shadowItineraries[workshopKey] || [];
        schedule = schedulesRef.find(s => s.id === scheduleId);
    } else {
        schedulesRef = day.schedules || [];
        schedule = schedulesRef.find(s => s.id === scheduleId);
    }

    if (!schedule) {
        showMessage('æ‰¾ä¸åˆ°è¡Œç¨‹é …ç›®ï¼Œç„¡æ³•å¼·åŒ–ã€‚', 'error');
        return;
    }

    // 2. å„²å­˜ç”¨æˆ¶åœ¨æ¨¡æ…‹æ¡†ä¸­è¼¸å…¥çš„æ–°/ä¿®æ”¹æ•¸æ“š
    const newScheduleData = {
        name: document.getElementById('ai-schedule-name').value.trim(),
        address: document.getElementById('ai-schedule-address').value.trim(),
        // è½‰æ›æ›è¡Œç‚º <br> å­˜å„²
        notes: document.getElementById('ai-schedule-notes-input').value.trim().replace(/\n/g, '<br>'),
        rainPlan: document.getElementById('ai-schedule-rain-plan-input').value.trim(),
        cost: document.getElementById('ai-schedule-cost-input').value.trim().replace(/[^0-9]/g, ''),
        startTime: document.getElementById('ai-schedule-start-time').value,
        durationHours: parseFloat(document.getElementById('ai-schedule-duration').value),
        style: document.getElementById('ai-schedule-style-input').value,
        customStyle: document.getElementById('ai-schedule-style-input').value === 'other' 
                     ? document.getElementById('ai-schedule-custom-style-input').value.trim() : '',
        transportMode: document.getElementById('ai-schedule-transport-mode').value,
        isAI: false, // å…ˆæ¨™è¨˜ç‚ºæ‰‹å‹•ä¿®æ”¹ï¼Œå¾… AI å›å‚³å¾Œå†è½‰ true
    };

    // å°‡æ–°æ•¸æ“šåˆä½µå›ç›®æ¨™ç‰©ä»¶
    Object.assign(schedule, newScheduleData);

    // 3. åŸ·è¡Œæ’ç¨‹æ™‚é–“é‡æ–°è¨ˆç®— (æ ¹æ“šä¾†æºåˆ†æµ)
    if (state.planViewMode === 'workshop') {
        recalculateScheduleTimes({ schedules: schedulesRef, startTime: day.startTime });
        syncShadowToWorkshop(); // âœ¨ åŒæ­¥å› workshops æ°¸ä¹…é™£åˆ—
    } else {
        recalculateScheduleTimes(day);
    }
    saveData();

    // 4. æº–å‚™ AI å¼·åŒ– Prompt (ä½¿ç”¨è™•ç†å¾Œçš„æ•¸æ“š)
    const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—…éŠè¨ˆç•«å¢å¼·é¡§å•ã€‚è«‹æ ¹æ“šä»¥ä¸‹å–®é …è¡Œç¨‹çš„è©³ç´°è³‡è¨Šï¼Œå°å…¶ã€Œè©³ç´°å…§å®¹ã€é€²è¡Œä¸€æ¬¡å°ˆæ¥­çš„æ“´å……èˆ‡å¼·åŒ–ã€‚å¼·åŒ–å¾Œçš„å…§å®¹æ‡‰åŒ…å«æ›´æ·±åº¦çš„æ—…è¡Œå»ºè­°ã€éš±è—çš„ç‰¹è‰²æˆ–é¡å¤–çš„äº¤é€š/è²»ç”¨ç´°ç¯€ï¼Œè®“è¡Œç¨‹æ›´å¯é ã€‚è«‹ä¿æŒåŸæœ‰çš„åç¨±ã€åœ°å€ã€æ™‚é–“å’Œè²»ç”¨ä¸è®Šã€‚è«‹ä½¿ç”¨ Markdown ç²—é«” (**...) å’Œæ›è¡Œç¬¦ (\\n) æ ¼å¼åŒ–å…§å®¹ã€‚

**è¡Œç¨‹è³‡è¨Šï¼š**
- **åç¨±**: ${schedule.name}
- **åœ°é»**: ${schedule.address}
- **æ™‚é–“æ®µ**: ${schedule.startTime} - ${calculateEndTime(schedule.startTime, schedule.durationHours)}
- **é¢¨æ ¼**: ${getStyleName(schedule.style, schedule.customStyle)}
- **è²»ç”¨**: ${state.currency} ${schedule.cost || 0}
- **ç”¨æˆ¶åŸå§‹ç­†è¨˜**: ${newScheduleData.notes.replace(/<br>/g, '\n')}

**è«‹æä¾›ä¸€å€‹ç¶“éå°ˆæ¥­æ“´å……çš„ã€ŒAI å¼·åŒ–å»ºè­°ã€ã€‚** å…§å®¹é•·åº¦ç´„ 5-6 å¥ã€‚è«‹åš´æ ¼ä½¿ç”¨ Markdown æ ¼å¼ï¼Œä¸¦é¿å…ç”¢ç”Ÿä»»ä½•å¤šé¤˜çš„ JSON æˆ–é¡å¤–æ¨™é¡Œã€‚`;

    toggleModal('ai-schedule-form-modal'); // é—œé–‰è¼¸å…¥è¦–çª—

    // 5. å‘¼å« AI æœå‹™
    const content = await fetchAICreativeContent(scheduleId, prompt);

    if (content) {
        // 6. æ›´æ–° AI å¼·åŒ–å…§å®¹
        schedule.aiPlus = content;
        schedule.isAI = true; 

        // âœ¨ å†æ¬¡åŒæ­¥è—åœ–æ•¸æ“š
        if (state.planViewMode === 'workshop') {
            syncShadowToWorkshop();
        }

        saveData();
        renderDayContent(); // é‡æ–°ç¹ªè£½ç•«é¢ï¼Œè®“ AI+ æ¨™ç±¤å‡ºç¾
        showMessage('âœ¨ AI PLUS å¼·åŒ–å»ºè­°å·²æ›´æ–°ï¼', 'success');
    } else {
        showMessage('AI å¼·åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–é‡è©¦ã€‚', 'error');
    }
}

        

/**
 * ä¿®æ­£ç‰ˆï¼šè™•ç†ä¸‹æ‹‰é¸å–®é¸æ“‡ã€Œotherã€æ™‚é¡¯ç¤ºè‡ªå®šç¾©è¼¸å…¥æ¡†
 * @param {string} value - é¸å–®ç•¶å‰çš„å€¼
 * @param {string} groupId - è¦é¡¯ç¤º/éš±è—çš„ div å®¹å™¨ ID
 * @param {string} inputId - è‡ªå®šç¾©è¼¸å…¥æ¡†æœ¬èº«çš„ ID (ç”¨æ–¼éš±è—æ™‚æ¸…ç©ºå…§å®¹)
 */
function toggleCustomAITransportInput(value, groupId, inputId) {
    const group = document.getElementById(groupId);
    if (!group) return;

    if (value === 'other') {
        group.classList.remove('hidden'); // é¡¯ç¤ºè¼¸å…¥æ¡†
    } else {
        group.classList.add('hidden');    // éš±è—è¼¸å…¥æ¡†
        // éš±è—æ™‚é †ä¾¿æ¸…ç©ºè‡ªå®šç¾©æ¬„ä½çš„æ–‡å­—ï¼Œé˜²æ­¢é«’æ•¸æ“š
        const inputEl = document.getElementById(inputId);
        if (inputEl) inputEl.value = '';
    }
}


/**
 * å‹•æ…‹æ–°å¢åŸå¸‚è¼¸å…¥æ¡†
 * @param {string} containerId - å®¹å™¨çš„ ID ('city-inputs-container' æˆ– 'ai-city-inputs-container')
 * @param {string} [initialValue=''] - åˆå§‹å€¼
 */
function addCityInput(containerId, initialValue = '') {
    const container = document.getElementById(containerId);
    const inputCount = container.children.length;

    const wrapper = document.createElement('div');
    wrapper.className = 'flex items-center space-x-2 mb-2';

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'cities[]';
    input.value = initialValue;
    input.placeholder = `åŸå¸‚ ${inputCount + 1}`;
    input.className = 'flex-1 p-3 border border-gray-300 rounded-lg';
    
    // ======== æ ¸å¿ƒä¿®æ­£ï¼šå°å‹•æ…‹ç”Ÿæˆçš„è¼¸å…¥æ¡†ç¶å®šäº‹ä»¶é˜»æ­¢æ©Ÿåˆ¶ ========
    input.addEventListener('mousedown', stopPropagation);
    input.addEventListener('mouseup', stopPropagation);
    // =============================================================
    
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'text-red-500 hover:text-red-700 p-2 rounded-full';
    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>';
    
    deleteBtn.onclick = () => {
        wrapper.remove();
        if (container.children.length === 0) {
             addCityInput(containerId); 
        }
    };

    wrapper.appendChild(input);
    if (inputCount > 0 || container.children.length > 0) {
        wrapper.appendChild(deleteBtn);
    }
    
    container.appendChild(wrapper);
}
        

/**
 * å„²å­˜å–®æ—¥ç·¨è¼¯
 */
function saveDayEdit(event) {
    if (event) event.preventDefault(); // é˜²æ­¢ form é è¨­æäº¤å°è‡´é é¢è·³è½‰
    
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!day || !trip) return;

    const isFirstDay = day.dayNum === 1;
    const isLastDay = day.dayNum === trip.days.length;
    
    // 1. è®€å–ä¸¦éæ¿¾åŸå¸‚è¼¸å…¥
    const cityInputs = document.querySelectorAll('#city-inputs-container input[name="cities[]"]');
    const newCities = Array.from(cityInputs).map(input => input.value.trim()).filter(city => city.length > 0);

    // 2. å„²å­˜åŸºç¤æ—¥æœŸæ™‚é–“èˆ‡åŸå¸‚
    day.date = document.getElementById('edit-day-date').value;
    day.startTime = document.getElementById('edit-day-start-time').value;
    day.endTime = document.getElementById('edit-day-end-time').value;
    day.city = newCities;

    // 3. å„²å­˜å…¥å¢ƒè³‡è¨Š (åƒ…ç¬¬ä¸€å¤©) - åŒ¹é…é¡æ©Ÿç¥¨æ¬„ä½
    if (isFirstDay) {
        const arrivalTransportMode = document.getElementById('arrival-transport-mode').value;
        day.arrivalInfo = {
            departureAirport: document.getElementById('arrival-departure-airport').value.trim(),
            departureTime: document.getElementById('arrival-departure-time').value.trim(),
            airport: document.getElementById('arrival-airport').value.trim(),
            time: document.getElementById('arrival-time').value.trim(),
            flight: document.getElementById('arrival-flight').value.trim(),
            transportMode: arrivalTransportMode,
            // è®€å–è‡ªå®šç¾©äº¤é€šè¼¸å…¥ (å¦‚æœæœ‰çš„è©±)
            customTransport: arrivalTransportMode === 'other' ? 
                (document.getElementById('custom-arrival-transport') ? document.getElementById('custom-arrival-transport').value.trim() : '') : ''
        };
    }

    // 4. å„²å­˜ä½å®¿è³‡è¨Š
    day.lodging = {
        name: document.getElementById('lodging-name').value.trim(),
        address: document.getElementById('lodging-address').value.trim(),
        phone: document.getElementById('lodging-phone').value.trim(),
    };

    // 5. å„²å­˜ä½å®¿ç‹€æ…‹ (çºŒä½/é€€æˆ¿)
    const lodgingStatusRadio = document.querySelector('input[name="lodging-status"]:checked');
    if (day.lodging.name && lodgingStatusRadio) {
        const lodgingStatus = lodgingStatusRadio.value;
        day.lodgingStatus = lodgingStatus;
        
        // åªæœ‰åœ¨ã€Œä¸æ˜¯æœ€å¾Œä¸€å¤©ã€æ™‚ï¼Œæ‰éœ€è¦æŠŠç‹€æ…‹å‚³å°çµ¦ä¸‹ä¸€å¤©
        if (!isLastDay) {
            handleLodgingStatusChange(day, lodgingStatus);
        }
    } else {
        day.lodgingStatus = undefined;
    }

    // 6. å„²å­˜é›¢å¢ƒè³‡è¨Š (åƒ…æœ€å¾Œä¸€å¤©) - åŒ¹é…é¡æ©Ÿç¥¨æ¬„ä½
    if (isLastDay) {
        const departureTransportMode = document.getElementById('departure-transport-mode').value;
        day.departureInfo = {
            airport: document.getElementById('departure-airport').value.trim(),
            time: document.getElementById('departure-time').value.trim(),
            arrivalAirport: document.getElementById('departure-arrival-airport').value.trim(),
            arrivalTime: document.getElementById('departure-arrival-time').value.trim(),
            flight: document.getElementById('departure-flight').value.trim(),
            transportMode: departureTransportMode,
            // è®€å–è‡ªå®šç¾©äº¤é€šè¼¸å…¥ (å¦‚æœæœ‰çš„è©±)
            customTransport: departureTransportMode === 'other' ? 
                (document.getElementById('custom-departure-transport') ? document.getElementById('custom-departure-transport').value.trim() : '') : ''
        };
    }

    // 7. é‡æ–°è¨ˆç®—æ’ç¨‹æ™‚é–“èˆ‡æ›´æ–°ä»‹é¢
    if (day.schedules.length > 0) {
        recalculateScheduleTimes(day);
    }

    saveData();              // å„²å­˜è‡³ LocalStorage
    toggleModal('edit-day-modal'); // é—œé–‰æ¨¡æ…‹æ¡†
    renderTripDetail();      // é‡æ–°æ¸²æŸ“æ•´å€‹è©³æƒ…é  (å« Tab èˆ‡æ–°æ©Ÿç¥¨å°å¡)
    showMessage(`ç¬¬ ${day.dayNum} å¤©è¡Œç¨‹è³‡è¨Šå·²æ›´æ–°ï¼`, 'info');
}


/**
 * è™•ç†ä½å®¿ç‹€æ…‹è®Šæ›´çš„é‚è¼¯ï¼Œä¸¦æ›´æ–°ä¸‹ä¸€å¤©çš„ä½å®¿è³‡æ–™ã€‚
 * @param {object} currentDay - ç•¶å‰ Day çš„ç‰©ä»¶
 * @param {string} lodgingStatus - 'stay' (çºŒä½) æˆ– 'check-out' (é€€æˆ¿)
 */
function handleLodgingStatusChange(currentDay, lodgingStatus) {
    const trip = getCurrentTrip();
    // ç²å–ä¸‹ä¸€å¤©åœ¨é™£åˆ—ä¸­çš„ç´¢å¼• (ç•¶å‰å¤©æ•¸ dayNum æ˜¯ 1-based)
    const nextDayIndex = currentDay.dayNum; 

    // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€å¤©
    if (nextDayIndex < trip.days.length) {
        const nextDay = trip.days[nextDayIndex];
        
        // é è¨­ (status === 'stay' æˆ– undefined/null)
        if (lodgingStatus === 'stay' || !lodgingStatus) {
            // è¤‡è£½ç•¶å‰çš„ä½å®¿è³‡è¨Šåˆ°ä¸‹ä¸€å¤©
            nextDay.lodging = {
                name: currentDay.lodging?.name || '',
                address: currentDay.lodging?.address || '',
                phone: currentDay.lodging?.phone || ''
            };
        } else if (lodgingStatus === 'check-out') {
            // æ¸…ç©ºä¸‹ä¸€å¤©çš„ä½å®¿è³‡è¨Š (é€€æˆ¿)
            nextDay.lodging = {};
        }
        
        // å¦‚æœä¸‹ä¸€å¤©æ²’æœ‰æ’ç¨‹ï¼Œæˆ‘å€‘å¯ä»¥æ ¹æ“šç‹€æ…‹æ·»åŠ æˆ–ç§»é™¤ä¸€å€‹æé†’
        if (nextDay.schedules.length === 0) {
            // ç”±æ–¼ AI æ’ç¨‹æœƒè‡ªå‹•è™•ç†ï¼Œé€™è£¡åªåšæ•¸æ“šå±¤é¢çš„è¤‡è£½/æ¸…ç©ºå³å¯
            // ç‚ºäº†ä¸å¹²æ“¾ç”¨æˆ¶çš„è‡ªç”±æ’ç¨‹ï¼Œæˆ‘å€‘ä¸å†è‡ªå‹•æ·»åŠ ã€Œå¯„æ”¾è¡Œæã€ç­‰æ–‡å­—æ’ç¨‹
        }
    }
}

        /**
         * åˆ‡æ›ç•¶å‰é¡¯ç¤ºçš„å¤©æ•¸
         * @param {number} index
         */
function changeDay(index) {
    state.currentDayIndex = index;
    
    // å¦‚æœç•¶å‰å­è¦–åœ–æ˜¯ itineraryï¼Œæ¸²æŸ“è¡Œç¨‹å…§å®¹
    if (state.currentSubView === 'itinerary') {
        renderDayContent(); 
    } 
    // ã€æ–°å¢ã€‘ï¼šå¦‚æœç•¶å‰æ˜¯é›œèªŒæ¨¡å¼ï¼Œé»æ“Š Day Tab ä¹Ÿè¦é‡æ–°æ¸²æŸ“é›œèªŒ
    else if (state.currentSubView === 'magazine') {
        renderMagazineContent();
    }
    
    // æ›´æ–° Tab æ¨£å¼ (ç¶­æŒåŸæ¨£)
    const tabsContainer = document.getElementById('day-tabs-container');
    const trip = getCurrentTrip();
    if (tabsContainer && trip) {
        tabsContainer.querySelectorAll('button').forEach((btn, idx) => {
            if (idx < trip.days.length) {
                btn.className = `px-4 py-3 text-sm font-medium transition duration-200 min-w-[6rem] ${idx === state.currentDayIndex
                    ? 'theme-pink text-white shadow-inner'
                    : 'text-gray-600 bg-gray-100 hover:bg-gray-200'}`;
            }
        });
    }

    saveData();
}


        /**
         * æ–°å¢ä¸€å€‹æ–°çš„è¡Œç¨‹
         */
        function addNewTrip() {
            const nameInput = document.getElementById('new-trip-name');
            const tripName = nameInput.value.trim();

            if (tripName) {
                const newTrip = {
                    id: generateUUID(),
                    name: tripName,
                    days: [{
                        dayNum: 1,
                        // å–å¾—ä»Šå¤©çš„æ—¥æœŸä¸¦æ ¼å¼åŒ–
                        date: new Date().toISOString().split('T')[0], // é è¨­ç‚ºä»Šå¤©
                        startTime: '08:00', // é è¨­ 08:00
                        endTime: '22:00',
                        city: ['å°åŒ—å¸‚'], // æ”¹ç‚ºé™£åˆ—
                        arrivalInfo: {}, // æ–°å¢å…¥å¢ƒè³‡è¨Š
                        lodging: {}, // æ–°å¢ä½å®¿è³‡è¨Š
                        departureInfo: {}, // æ–°å¢é›¢å¢ƒè³‡è¨Š
                        schedules: []
                    }]
                };
                state.trips.push(newTrip);
                nameInput.value = '';
                toggleModal('add-trip-modal');
                state.currentTripId = newTrip.id; // è¨­ç½®ç•¶å‰è¡Œç¨‹ID
                state.currentDayIndex = newTrip.days.length - 1; // ç¢ºä¿é¸ä¸­æ–°çš„å¤©æ•¸
                switchView('detail', newTrip.id); // åˆ‡æ›åˆ°æ–°çš„è¡Œç¨‹è©³æƒ…é 
                showMessage('è¡Œç¨‹æ–°å¢æˆåŠŸï¼', 'info'); 
            } else {
                showMessage('è¡Œç¨‹åç¨±ä¸èƒ½ç‚ºç©º', 'error');
            }
        };

/**
 * æ–°å¢ä¸€å€‹æ–°çš„å¤©æ•¸ (Day)
 */
function addNewDay() {
    const trip = getCurrentTrip();
    if (!trip) return;

    const nextDayNum = trip.days.length + 1;
    
    // ç²å–å‰ä¸€å¤©çš„æ—¥æœŸä½œç‚ºåŸºæº–ï¼Œä¸¦å¢åŠ ä¸€å¤©
    const prevDay = trip.days[trip.days.length - 1]; // ç²å–å‰ä¸€å¤©çš„ Day ç‰©ä»¶
    const prevDayDate = new Date(prevDay.date);
    prevDayDate.setDate(prevDayDate.getDate() + 1);
    const dateString = prevDayDate.toISOString().split('T')[0];
    
    // æ ¸å¿ƒä¿®æ­£ï¼šè‡ªå‹•ç¹¼æ‰¿å‰ä¸€å¤©çš„ä½å®¿è³‡è¨Š (å¦‚æœå­˜åœ¨)
    const inheritedLodging = (prevDay.lodging && prevDay.lodging.name) ? {
        name: prevDay.lodging.name,
        address: prevDay.lodging.address,
        phone: prevDay.lodging.phone,
    } : {};
    
    const newDay = {
        dayNum: nextDayNum,
        date: dateString,
        startTime: '08:00', // é è¨­ 08:00
        endTime: '22:00',
        city: [], // <--- ä¿®æ­£ï¼šé‡è¨­ç‚ºç©ºé™£åˆ—ï¼Œä¸ç¹¼æ‰¿åŸå¸‚åç¨±
        arrivalInfo: {},
        lodging: inheritedLodging, // <--- å¯«å…¥ç¹¼æ‰¿çš„æ—…é¤¨è³‡è¨Š
        departureInfo: {},
        schedules: []
    };
    
    // è™•ç†æœ€å¾Œä¸€å¤©è®Šå‹•ï¼šå¦‚æœæ–°å¢Dayå¾Œï¼ŒåŸä¾†çš„æœ€å¾Œä¸€å¤©(Day N-1)ä¸å†æ˜¯æœ€å¾Œä¸€å¤©ï¼Œå‰‡ç§»é™¤å…¶é›¢å¢ƒè³‡è¨Š
    if (prevDay.departureInfo) {
        prevDay.departureInfo = {};
    }

    trip.days.push(newDay);
    state.currentDayIndex = trip.days.length - 1; // è‡ªå‹•åˆ‡æ›åˆ°æ–°çš„ Day
    
    // é‡æ–°æ¸²æŸ“æ•´å€‹è©³æƒ…é ä¾†é‡å»º Day Tabsï¼Œä¸¦è§¸ç™¼æ»¾å‹•åˆ°æ–°çš„ Day Tab
    renderTripDetail();
    
    saveData();
    showMessage(`å·²æ–°å¢ ç¬¬ ${nextDayNum} å¤© è¡Œç¨‹ï¼Œè«‹ç·¨è¼¯åŸå¸‚å’Œæ’ç¨‹ã€‚`, 'info');
}
        
/** * ğŸ¨ ä»‹é¢å‹•æ…‹å°ä½ï¼šæ ¹æ“šæ’ç¨‹é¢¨æ ¼åˆ‡æ›è¼¸å…¥æ¬„ä½ (v2.0)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [AI å°é€š]ï¼šåƒ…åœ¨äº¤é€šæ¨¡å¼é¡¯ç¤º AI åŠ©æ‰‹ã€‚
 * 2. [è‡ªè¨‚é¢¨æ ¼]ï¼šåƒ…åœ¨å…¶ä»–æ¨¡å¼é¡¯ç¤ºè‡ªå®šç¾©è¼¸å…¥æ¡†ã€‚
 * 3. [æè¿°æ¨¡å¼è‡ªç™’]ï¼šç•¶é¸ä¸­ã€Œæè¿°æŒ‡å¼•ã€æ™‚ï¼Œè‡ªå‹•éš±è—åœ°å€ã€é›¨å¤©å‚™æ¡ˆèˆ‡è²»ç”¨æ¬„ä½ï¼Œä¿æŒä»‹é¢æ¸…çˆ½ã€‚
 */
function toggleCustomStyleInput(value, customInputId = 'schedule-custom-style', customGroupId = 'custom-style-group') {
    const customInputGroup = document.getElementById(customGroupId);
    const transportAiPanel = document.getElementById('transport-ai-panel');
    
    // ğŸŒŸ å–å¾—æè¿°æ¨¡å¼ä¸‹éœ€è¦ã€Œç‰©ç†éš±è—ã€çš„éå¿…è¦æ¬„ä½å®¹å™¨
    // é€™è£¡å»ºè­°åœ¨ HTML çš„åœ°å€ã€é›¨å¤©å‚™æ¡ˆã€è²»ç”¨å¤–å±¤åŠ ä¸Šå°æ‡‰çš„ IDï¼Œæˆ–ç›´æ¥é¸å–å…¶çˆ¶å±¤
    const addressGroup = document.getElementById('schedule-address')?.closest('.mb-3');
    const rainPlanGroup = document.getElementById('schedule-rain-plan')?.closest('.mb-3');
    const costGroup = document.getElementById('schedule-cost')?.closest('.mb-3');
    const durationGroup = document.getElementById('schedule-duration')?.closest('.flex-1');

    // 1. è™•ç†ã€Œå…¶ä»–ã€è‡ªè¨‚é¢¨æ ¼é¡¯ç¤º
    if (customInputGroup) {
        value === 'other' ? customInputGroup.classList.remove('hidden') : customInputGroup.classList.add('hidden');
    }

    // 2. è™•ç†ã€Œäº¤é€šæ¨¡å¼ã€AI çª—å£é¡¯ç¤º
    if (transportAiPanel) {
        value === 'transport' ? transportAiPanel.classList.remove('hidden') : transportAiPanel.classList.add('hidden');
    }

    // 3. ğŸŒŸ æ ¸å¿ƒï¼šè™•ç†ã€Œæè¿°æŒ‡å¼•ã€æ¨¡å¼çš„æ¬„ä½è¯å‹•
    const isDesc = (value === 'description');
    
    const toggleField = (el, shouldHide) => {
        if (el) shouldHide ? el.classList.add('hidden') : el.classList.remove('hidden');
    };

    // å¦‚æœæ˜¯æè¿°æ¨¡å¼ï¼Œéš±è—åœ°å€ã€é›¨å¤©å‚™æ¡ˆã€è²»ç”¨ï¼›å¦å‰‡å…¨éƒ¨é¡¯ç¤º
    toggleField(addressGroup, isDesc);
    toggleField(rainPlanGroup, isDesc);
    toggleField(costGroup, isDesc);
    
    // ğŸ’¡ æç¤ºï¼šåœç•™æ™‚é–“åœ¨æè¿°æ¨¡å¼é€šå¸¸å›ºå®šç‚º 0.1ï¼Œä¹Ÿå¯ä»¥é¸æ“‡éš±è—
    toggleField(durationGroup, isDesc);

    console.log(`ğŸ“¡ [UI-Alignment] å·²åˆ‡æ›è‡³ ${value} æ¨¡å¼ï¼Œæè¿°æ¬„ä½é€£å‹•ï¼š${isDesc ? 'å•Ÿå‹•' : 'é—œé–‰'}`);
}

/** ğŸšŒ äº¤é€šå°å¡ä»£å¯«å¼•æ“ (v4.2 æµé‡ç†”æ–·é˜²è­·ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [ç‰©ç†ç†”æ–·] ä½¿ç”¨ localStorage è¨˜éŒ„ api_melt_down ç‹€æ…‹ï¼Œé˜²æ­¢ API è€—ç›¡æ™‚æŒçºŒå™´éŒ¯ã€‚
 * 2. [è‡ªç™’æ¢å¾©] åµæ¸¬åˆ° 429 éŒ¯èª¤æ™‚è‡ªå‹•é–å®š 24 å°æ™‚ã€‚
 * 3. [é›™å‘å°ä½] ç¶­æŒåœ°ç†åº§æ¨™å›å¡«èˆ‡å­—å…¸è¦æ ¼åŒ–å°ä½ã€‚
 */
async function runTransportGenerator() {
    // ğŸŒŸ 1. ã€ç‰©ç†ä¿éšªçµ²ã€‘æª¢æŸ¥ç†”æ–·ç‹€æ…‹
    const meltDownUntil = localStorage.getItem('api_melt_down_until');
    if (meltDownUntil && Date.now() < parseInt(meltDownUntil)) {
        const remainingHours = Math.ceil((parseInt(meltDownUntil) - Date.now()) / 3600000);
        showMessage(`ğŸš¨ API é¡åº¦å·²è€—ç›¡ï¼ç†”æ–·ä¿è­·ä¸­ï¼Œé è¨ˆ ${remainingHours} å°æ™‚å¾Œæ¢å¾©ã€‚`, 'error');
        console.warn("ğŸ›¡ï¸ [Quota-Guard] API è™•æ–¼ç†”æ–·å†·å»æœŸï¼Œæ””æˆªè«‹æ±‚ã€‚");
        return;
    }

    const query = document.getElementById('ai-transport-query').value.trim();
    if (!query) return showMessage('è«‹è¼¸å…¥éœ€æ±‚ (ä¾‹å¦‚ï¼šç”±å¸ƒé™¢åˆ°åšå¤šï¼Œæ­ç”±å¸ƒé™¢ä¹‹æ£®)', 'error');

    const manualStartTime = document.getElementById('schedule-start-time').value;
    const day = getCurrentDay();
    const cityContext = Array.isArray(day.city) ? day.city.join(', ') : (day.city || 'æ—¥æœ¬');
    
    showMessage('ğŸš€ AI äº¤é€šå°ˆå®¶æ­£åœ¨å˜—è©¦é€£ç·šä¸¦æª¢ç´¢åº§æ¨™...', 'info');

    try {
        // ğŸŒŸ æ ¸å¿ƒ Prompt
        const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æœ¬ä¹å·äº¤é€šèˆ‡åœ°ç†åº§æ¨™çš„ç²¾ç®—å°ˆå®¶ã€‚
ç•¶å‰åœ°é»èƒŒæ™¯ï¼š${cityContext}
é å®šå‡ºç™¼æ™‚é–“ï¼š${manualStartTime || 'æœªæŒ‡å®š'}

### ä½¿ç”¨è€…éœ€æ±‚ï¼š${query}

è«‹åš´æ ¼å›å‚³ä¸€å€‹ç´” JSON ç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "cardData": {
    "name": "ç·šè·¯å (ä¾‹å¦‚ï¼šJR ä¹å·æ–°å¹¹ç·š)",
    "startTime": "${manualStartTime || 'è«‹æ ¹æ“šè·¯ç¶²æ¨ç®—'}",
    "durationHours": æ•¸å­—,
    "cost": æ•¸å­—,
    "notes": "((ç‡Ÿé‹å–®ä½)) [[èµ·é»ç«™, ç¶“éç«™, çµ‚é»ç«™]] æˆ°è¡“æè¿°"
  },
  "geoFix": [
    {"name": "ç«™é»1åç¨±", "lat": æ•¸å­—, "lng": æ•¸å­—},
    {"name": "ç«™é»2åç¨±", "lat": æ•¸å­—, "lng": æ•¸å­—}
  ]
}
ğŸš¨ è¦æ±‚ï¼š
1. è‹¥æˆ‘å·²æä¾› startTimeï¼Œè«‹ä»¥æ­¤ç‚ºåŸºæº–å°‹æ‰¾è»Šæ¬¡ã€‚
2. geoFix å¿…é ˆæä¾›ç«™é»çš„ç²¾æº–ç¶“ç·¯åº¦ï¼Œç”¨æ–¼ä¿®å¾©ç³»çµ±åœ°ç†ç¼ºå£ã€‚`;

        // 2. å‘¼å«æ ¸å¿ƒé€šè¨Š
        const rawResult = await callGeminiWithRetry(prompt);
        
        // 3. æ¸…æ´—èˆ‡è§£æ JSON
        const cleanJson = rawResult.replace(/```json|```/g, '').trim();
        const data = JSON.parse(cleanJson);

        // --- ğŸ’¾ éšæ®µä¸€ï¼šè¡Œç¨‹å¡ç‰‡å¡«è¡¨ ---
        const card = data.cardData;
        if (card) {
            document.getElementById('schedule-name').value = card.name || "æ–°äº¤é€šè¡Œç¨‹";
            document.getElementById('schedule-start-time').value = card.startTime || manualStartTime || "09:00";
            document.getElementById('schedule-duration').value = card.durationHours || 0.5;
            document.getElementById('schedule-notes').value = card.notes || "";
            document.getElementById('schedule-cost').value = card.cost || "0";
        }

        // --- ğŸ’‰ éšæ®µäºŒï¼šç‰©ç†åº§æ¨™è‡ªç™’ (ä¿®å¾© 490 ç­†è³‡ç”¢) ---
        if (data.geoFix && data.geoFix.length > 0) {
            let fixCount = 0;
            data.geoFix.forEach(fix => {
                const target = state.bucketList.find(b => b.name === fix.name || (b.name.includes(fix.name) && fix.name.length > 2));
                if (target && (!target.coords || !target.coords.lat)) {
                    target.coords = { lat: fix.lat, lng: fix.lng };
                    fixCount++;
                }
            });

            if (fixCount > 0) {
                console.log(`ğŸ“¡ [AI-GeoFix] ä¿®å¾©äº† ${fixCount} ç­†åº§æ¨™ç¼ºå£ã€‚`);
                await saveData(true); 
            }
        }

        // è¡çªæª¢æŸ¥
        if (typeof checkScheduleConflict === 'function') {
            checkScheduleConflict(document.getElementById('schedule-start-time').value, parseFloat(card?.durationHours || 0.5));
        }

        showMessage(data.geoFix ? `âœ… äº¤é€šå·²ç”Ÿæˆï¼Œå·²å°‹å› ${data.geoFix.length} è™•åº§æ¨™` : 'âœ… äº¤é€šå°å¡ä»£å¯«å®Œæˆ', 'success');

    } catch (err) {
        console.error("âŒ äº¤é€šèª¿åº¦ç•°å¸¸:", err);
        
        // ğŸŒŸ 4. ã€ç†”æ–·å•Ÿå‹•ã€‘åµæ¸¬åˆ°é¡åº¦è€—ç›¡æ™‚ï¼Œé–æ­» 24 å°æ™‚
        if (err.message.includes('quota') || err.message.includes('429')) {
            const meltTime = Date.now() + (24 * 60 * 60 * 1000); 
            localStorage.setItem('api_melt_down_until', meltTime.toString());
            showMessage('ğŸš¨ åµæ¸¬åˆ° API é¡åº¦è€—ç›¡ï¼ç³»çµ±å·²è‡ªå‹•å•Ÿå‹• 24H ç†”æ–·ä¿è­·ã€‚', 'error');
        } else {
            showMessage('é€šè¨Šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
    }
}

function checkScheduleConflict(newStart, newDuration) {
    // ğŸ›¡ï¸ é˜²ç¦¦ï¼šå¦‚æœæ™‚é–“æ˜¯ undefined æˆ–æ ¼å¼ä¸å°ï¼Œç›´æ¥è·³å‡ºä¸å ±éŒ¯
    if (!newStart || typeof newStart !== 'string' || !newStart.includes(':')) {
        console.warn("æ™‚é–“æ ¼å¼ä¸å®Œå…¨ï¼Œè·³éæª¢æŸ¥");
        return;
    }

    const day = getCurrentDay();
    const warningBox = document.getElementById('ai-conflict-warning');
    const conflictText = document.getElementById('conflict-text');
    
    try {
        const [h, m] = newStart.split(':').map(Number);
        const newStartMins = h * 60 + m;
        const newEndMins = newStartMins + (newDuration * 60);

        // æª¢æŸ¥èˆ‡ç•¶å¤©å…¶ä»–è¡Œç¨‹æ˜¯å¦é‡ç–Š
        const conflict = day.schedules.find(s => {
            if (!s.startTime || !s.startTime.includes(':') || s.id === document.getElementById('schedule-id').value) return false;
            const [sh, sm] = s.startTime.split(':').map(Number);
            const sStart = sh * 60 + sm;
            const sEnd = sStart + (parseFloat(s.durationHours || 0.5) * 60);
            // åˆ¤æ–·é‡ç–Šé‚è¼¯
            return (newStartMins < sEnd && newEndMins > sStart);
        });

        if (conflict) {
            warningBox.classList.remove('hidden');
            conflictText.innerText = `âš ï¸ èˆ‡ã€Œ${conflict.name}ã€æ™‚é–“é‡ç–Šï¼`;
        } else {
            warningBox.classList.add('hidden');
        }
    } catch (e) {
        console.error("è¡çªæª¢æŸ¥ç•°å¸¸:", e);
    }
}

/** ğŸ¤– æ¨¡å¼ A: AI+ æ¨™ç±¤å¼·åŒ– */
async function runAIEnhancement() {
    const name = document.getElementById('schedule-name').value;
    const notes = document.getElementById('schedule-notes').value;
    
    if(!name) return showMessage('è«‹å…ˆå¡«å¯«åç¨±', 'error');

    showMessage('æ­£åœ¨å„ªåŒ–æ¨™ç±¤çµæ§‹...', 'info');
    const prompt = `è«‹å°‡ä»¥ä¸‹äº¤é€šè³‡è¨Šè½‰åŒ–ç‚ºæ¨™æº–æ¨™ç±¤æ ¼å¼ã€‚
åç¨±ï¼š${name}ï¼Œå‚™è¨»ï¼š${notes}ã€‚
å¿…é ˆåŒ…å« (( )) [[ ]] {{ }}ã€‚åªå›å‚³ JSON { "name": "...", "notes": "..." }`;

    try {
        const jsonText = await callGeminiWithRetry(prompt);
        const result = safeJsonParse(jsonText);
        document.getElementById('schedule-name').value = result.name;
        document.getElementById('schedule-notes').value = result.notes;
        showMessage('âœ¨ æ¨™ç±¤å·²å„ªåŒ–', 'success');
    } catch (err) {
        showMessage('å¼·åŒ–å¤±æ•—', 'error');
    }
}

        /**
         * é–‹å•Ÿæ–°å¢æ’ç¨‹æ¨¡æ…‹æ¡†
         */
function openAddScheduleModal() {
    document.getElementById('schedule-form').reset();
    document.getElementById('schedule-id').value = '';

    const trip = getCurrentTrip();
    const day = getCurrentDay();
    const workshopKey = `${trip.id}_day${day.dayNum}`;

    // âœ¨ ä¿®æ­£ï¼šæ ¹æ“šæ¨¡å¼é¸æ“‡åƒè€ƒçš„ schedules
    const activeSchedules = (state.planViewMode === 'workshop') 
        ? (state.shadowItineraries[workshopKey] || []) 
        : (day.schedules || []);

    let defaultStartTime = day.startTime;
    if (activeSchedules.length > 0) {
        const lastSchedule = activeSchedules.at(-1);
        defaultStartTime = calculateEndTime(lastSchedule.startTime, lastSchedule.durationHours);
    }

            document.getElementById('schedule-start-time').value = defaultStartTime;
            document.getElementById('schedule-duration').value = 1;
            document.getElementById('schedule-notes').value = ''; // æ–°æ¬„ä½æ¸…ç©º
            document.getElementById('schedule-rain-plan').value = ''; // æ–°æ¬„ä½æ¸…ç©º
            document.getElementById('schedule-cost').value = ''; // æ–°æ¬„ä½æ¸…ç©º
            document.getElementById('schedule-style').value = 'cultural'; // é è¨­å€¼
            toggleCustomStyleInput('cultural'); // éš±è—è‡ªè¨‚è¼¸å…¥æ¡†

            toggleModal('add-schedule-modal');
        };

        /**
         * é–‹å•Ÿæ’ç¨‹æ“ä½œé¸å–® (ç·¨è¼¯/åˆªé™¤)
         * @param {string} scheduleId
         * @param {string} scheduleName
         */
        function openScheduleActions(scheduleId, scheduleName) {
            document.getElementById('current-schedule-id-for-action').value = scheduleId;
            document.getElementById('schedule-action-name').textContent = `æ™¯é»æ“ä½œ: ${scheduleName}`;
            toggleModal('schedule-actions-modal');
        };

        // FIX: å®šç¾©ç¼ºå¤±çš„å‡½æ•¸
        function triggerDeleteFromActions() {
            const scheduleId = document.getElementById('current-schedule-id-for-action').value;
            toggleModal('schedule-actions-modal'); // é—œé–‰æ“ä½œé¸å–®
            // ä½¿ç”¨é€šç”¨çš„ç¢ºèªåˆªé™¤æ¨¡æ…‹æ¡†
            confirmDeleteSchedule(scheduleId); 
        }

        // FIX: å®šç¾©ç¼ºå¤±çš„å‡½æ•¸
        function triggerEditFromActions() {
            const scheduleId = document.getElementById('current-schedule-id-for-action').value;
            toggleModal('schedule-actions-modal'); // é—œé–‰æ“ä½œé¸å–®
            editSchedule(scheduleId); // åŸ·è¡Œç·¨è¼¯
        }

/**
 * ä¿®æ­£ç‰ˆï¼šç¢ºèªåˆªé™¤å–®å€‹æ’ç¨‹ (æ”¯æ´å·¥åŠèˆ‡æ­£å¼æ¨¡å¼åˆ†æµ)
 * @param {string} scheduleId
 */
function confirmDeleteSchedule(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!day || !trip) return;

    const workshopKey = `${trip.id}_day${day.dayNum}`;
    
    // âœ¨ æ ¸å¿ƒä¿®æ­£ï¼šæ ¹æ“šæ¨¡å¼é¸å–æ•¸æ“šæº
    let schedule;
    if (state.planViewMode === 'workshop') {
        // å¾ç•¶å‰è—åœ–å½±å­åº«ä¸­å°‹æ‰¾
        schedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        // å¾æ­£å¼æ’ç¨‹ä¸­å°‹æ‰¾
        schedule = (day.schedules || []).find(s => s.id === scheduleId);
    }

    if (!schedule) {
        console.error("æ‰¾ä¸åˆ°è©²æ’ç¨‹é …ç›®ï¼Œç„¡æ³•åˆªé™¤:", scheduleId);
        return;
    }
    
    // è¨­ç½®ç¢ºèªè¨Šæ¯
    const messageEl = document.getElementById('confirm-delete-message');
    if (messageEl) {
        messageEl.innerHTML = `æ‚¨ç¢ºå®šè¦åˆªé™¤æ’ç¨‹ <strong>"${schedule.name}"</strong> å—ï¼Ÿ${state.planViewMode === 'workshop' ? '<br><span class="text-blue-500 text-[10px]">â€» æ­¤æ“ä½œåƒ…å½±éŸ¿ç›®å‰è—åœ–</span>' : ''}`;
    }

    // è¨­ç½®ç¢ºèªæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
    const confirmBtn = document.getElementById('confirm-delete-btn');
    if (confirmBtn) {
        confirmBtn.onclick = () => {
            deleteSchedule(scheduleId); // é€™è£¡æœƒå‘¼å«æˆ‘å€‘ä¹‹å‰ä¿®æ­£éçš„å…·å‚™åˆ†æµé‚è¼¯çš„ deleteSchedule
            toggleModal('confirm-delete-modal');
        };
    }

    // é–‹å•Ÿç¢ºèªæ¨¡æ…‹æ¡†
    toggleModal('confirm-delete-modal');
}


/**
 * ç·¨è¼¯æ’ç¨‹ï¼šè¼‰å…¥è³‡æ–™åˆ°è¡¨å–® (æ”¯æ´å·¥åŠæ²™ç›’åˆ†æµç‰ˆ)
 * @param {string} scheduleId
 */
function editSchedule(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!day || !trip) return;

    const workshopKey = `${trip.id}_day${day.dayNum}`;
    
    // âœ¨ æ ¸å¿ƒæ•´é “ï¼šæ ¹æ“šæ¨¡å¼æ±ºå®šå¾å“ªè£¡æ‰¾è³‡æ–™
    let schedule;
    if (state.planViewMode === 'workshop') {
        // å¾ç•¶å‰è—åœ–å½±å­åº«ä¸­å°‹æ‰¾
        schedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        // å¾æ­£å¼æ’ç¨‹ä¸­å°‹æ‰¾
        schedule = (day.schedules || []).find(s => s.id === scheduleId);
    }

    if (schedule) {
        document.getElementById('schedule-id').value = schedule.id;
        document.getElementById('schedule-name').value = schedule.name;
        
        // æ›¿æ› <br> å› \n ä»¥ä¾¿åœ¨ textarea ä¸­é¡¯ç¤ºå¤šè¡Œ
        document.getElementById('schedule-address').value = schedule.address || '';
        document.getElementById('schedule-notes').value = schedule.notes ? schedule.notes.replace(/<br>/g, '\n') : '';
        
        document.getElementById('schedule-rain-plan').value = schedule.rainPlan || '';
        document.getElementById('schedule-cost').value = schedule.cost || '';
        document.getElementById('schedule-start-time').value = schedule.startTime;
        document.getElementById('schedule-duration').value = schedule.durationHours;
        
        // è¼‰å…¥æ’ç¨‹é¢¨æ ¼å’Œè‡ªè¨‚å…§å®¹
        const styleValue = schedule.style || 'cultural';
        document.getElementById('schedule-style').value = styleValue;
        
        // è§¸ç™¼è‡ªå®šç¾©è¼¸å…¥æ¡†é¡¯ç¤º/éš±è—é‚è¼¯
        if (typeof toggleCustomStyleInput === 'function') {
            toggleCustomStyleInput(styleValue);
        }
        
        if (styleValue === 'other') {
            document.getElementById('schedule-custom-style').value = schedule.customStyle || '';
        }

        toggleModal('add-schedule-modal');
    } else {
        console.error("æ‰¾ä¸åˆ°è©²æ’ç¨‹é …ç›®ï¼Œç„¡æ³•ç·¨è¼¯:", scheduleId);
        showMessage('æ‰¾ä¸åˆ°é …ç›®è³‡æ–™', 'error');
    }
}

/** * çµ‚æ¥µæ•´åˆç‰ˆï¼šåˆªé™¤å–®å€‹æ’ç¨‹ 
 * æ”¯æ´ï¼šå·¥åŠæ²™ç›’åˆ†æµã€è—åœ–åŒæ­¥ã€ä»¥åŠã€Œè³‡æºå›æ”¶ã€è‡³å‚™é¸æ¸…å–®
 */
function deleteSchedule(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!day || !trip) return;

    const workshopKey = `${trip.id}_day${day.dayNum}`;
    let targetSchedule = null;

    // --- 1. é æª¢ï¼šå®šä½è¦åˆªé™¤çš„ç‰©ä»¶ (ç‚ºäº†å›æ”¶å…¶ä¾†æº ID) ---
    if (state.planViewMode === 'workshop') {
        targetSchedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        targetSchedule = day.schedules.find(s => s.id === scheduleId);
    }

    if (!targetSchedule) return;

    // --- ğŸš€ 2. è³‡æºå›æ”¶é‚è¼¯ï¼šè‹¥æœ‰ä¾†æº IDï¼Œè§£é™¤å‚™é¸æ¸…å–®çš„ã€Œå·²æ’å…¥ã€æ¨™è¨˜ ---
    if (targetSchedule.fromBucketId && trip.bucketList) {
        const bucketItem = trip.bucketList.find(bi => bi.id === targetSchedule.fromBucketId);
        if (bucketItem) {
            bucketItem.isAdded = false; // è§£é™¤æ¨™è¨˜ï¼Œè®“å®ƒå›åˆ°å‚™é¸åµæ¸¬æ¸…å–®
            console.log(`â™»ï¸ æ™¯é»ã€Œ${targetSchedule.name}ã€å·²é‡‹æ”¾å›å‚™é¸æ± `);
        }
    }

    // --- 3. åŸ·è¡Œåˆªé™¤å‹•ä½œ (åˆ†æµè™•ç†) ---
    if (state.planViewMode === 'workshop') {
        // âœ¨ A. å¾å½±å­åº« (é‹è¡Œç·©å­˜) åˆªé™¤
        if (state.shadowItineraries[workshopKey]) {
            state.shadowItineraries[workshopKey] = state.shadowItineraries[workshopKey].filter(s => s.id !== scheduleId);
            recalculateScheduleTimes({ 
                schedules: state.shadowItineraries[workshopKey], 
                startTime: day.startTime 
            });
        }
        
        // âœ¨ B. åŒæ­¥å› workshops æ°¸ä¹…é™£åˆ—
        if (state.currentWorkshopId) {
            const ws = state.workshops.find(w => w.id === state.currentWorkshopId);
            if (ws) {
                ws.data = JSON.parse(JSON.stringify(state.shadowItineraries));
            }
        }
        showMessage('ğŸ› ï¸ å·²å¾è—åœ–ç§»é™¤ä¸¦é‡‹æ”¾æ™¯é»', 'info');

    } else {
        // ğŸ“Œ C. å¾æ­£å¼åº«åˆªé™¤
        const initialCount = day.schedules.length;
        day.schedules = day.schedules.filter(s => s.id !== scheduleId);
        if (day.schedules.length < initialCount) {
            recalculateScheduleTimes(day);
            showMessage('ğŸ“Œ å·²å¾æ­£å¼æ’ç¨‹ç§»é™¤ä¸¦é‡‹æ”¾æ™¯é»', 'info');
        }
    }
    
    // --- 4. å­˜æª”èˆ‡ UI åŒæ­¥ ---
    saveData();
    renderDayContent();
    // å¦‚æœå‚™é¸æ¸…å–®å°±åœ¨ç•«é¢æ—ï¼ŒåŒæ­¥åˆ·æ–°å®ƒï¼Œè®“å›æ”¶çš„æ™¯é»ç«‹åˆ»å‡ºç¾
    if (typeof renderBucketItems === 'function') renderBucketItems(); 
}

/** ç™¼ä½ˆå·¥åŠï¼šå°‡å½±å­æ•¸æ“šæ­£å¼è¦†è“‹åˆ° trips */
function publishWorkshop() {
    const trip = getCurrentTrip();
    if (!trip) return;

    if (!confirm('ç¢ºå®šè¦å°‡å·¥åŠçš„æ‰€æœ‰ä¿®æ”¹ç™¼ä½ˆåˆ°æ­£å¼è¡Œç¨‹å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰æ’ç¨‹ã€‚')) return;

    // å°‡æ‰€æœ‰ shadowItineraries ä¸­å±¬æ–¼æ­¤ trip çš„å…§å®¹å¯«å›
    Object.keys(state.shadowItineraries).forEach(key => {
        if (key.startsWith(trip.id)) {
            const dayNum = parseInt(key.split('_day')[1]);
            const day = trip.days.find(d => d.dayNum === dayNum);
            if (day) {
                day.schedules = JSON.parse(JSON.stringify(state.shadowItineraries[key]));
            }
        }
    });

    // æ¸…ç©ºè©²è¡Œç¨‹çš„ç·©å­˜ï¼Œåˆ‡æ›å›æ­£å¼æ¨¡å¼
    state.planViewMode = 'master';
    renderTripDetail(); // é‡æ–°æ•´ç†æ•´å€‹ç•«é¢
    saveData();
    showMessage('ğŸš€ å·¥åŠå…§å®¹å·²æ­£å¼ç™¼ä½ˆï¼', 'success');
}

/** ä¿®æ”¹è—åœ–åç¨± */
function renameWorkshop(wsId) {
    const ws = state.workshops.find(w => w.id === wsId);
    if (!ws) return;
    
    const newName = prompt("è«‹è¼¸å…¥æ–°æ–¹æ¡ˆåç¨±ï¼š", ws.name);
    if (newName && newName.trim()) {
        ws.name = newName.trim();
        saveData(); // âœ¨ å¿…é ˆå‘¼å«å„²å­˜
        renderWorkshopSlider(); // åƒ…æ›´æ–°æ¨™ç±¤ï¼Œä¸æ›ä½ç½®
        showMessage("æ–¹æ¡ˆåç¨±å·²æ›´æ–°", "success");
    }
}

function deleteWorkshop(wsId) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æ–¹æ¡ˆå—ï¼Ÿ")) return;

    // 1. éæ¿¾æ‰åˆªé™¤é …
    state.workshops = state.workshops.filter(w => w.id !== wsId);
    
    // 2. âœ¨ è‡ªå‹•é‡æ–°ç·¨æ’å‘½å (å°±åƒ Day Page ä¸€æ¨£)
    state.workshops.forEach((ws, index) => {
        ws.name = `æ–¹æ¡ˆ ${index + 1}`;
    });

    // 3. æª¢æŸ¥ç•¶å‰é¸ä¸­çš„æ˜¯å¦è¢«åˆªé™¤äº†
    if (state.currentWorkshopId === wsId) {
        state.currentWorkshopId = state.workshops.length > 0 ? state.workshops[0].id : null;
        if (state.currentWorkshopId) {
            switchWorkshop(state.currentWorkshopId);
        } else {
            state.planViewMode = 'master';
            renderTripDetail();
        }
    }

    // 4. åŒæ­¥å­˜æª”
    saveData();
    renderWorkshopSlider();
}
        
/** ä¿®æ­£ç‰ˆï¼šç¢ºèªåˆªé™¤æŒ‡å®šå¤©æ•¸ */
function confirmDeleteDay(dayNum) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${dayNum} å¤©å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•æ’¤éŠ·ã€‚`)) return;

    const trip = getCurrentTrip();
    if (!trip) return;

    // åˆªé™¤è©²å¤©
    trip.days.splice(dayNum - 1, 1);

    // 1. é‡æ–°ç·¨è™Ÿ dayNum
    trip.days.forEach((day, index) => {
        day.dayNum = index + 1;
    });

    // 2. é‡æ–°è¨ˆç®—æ—¥æœŸ (éª¨ç‰Œé€£é–ä¿®æ­£)
    recalculateAllDaysDates(trip);

    // 3. ç´¢å¼•å®‰å…¨å°ä½
    if (state.currentDayIndex >= trip.days.length) {
        state.currentDayIndex = Math.max(0, trip.days.length - 1);
    }

    // 4. æŒä¹…åŒ–
    saveData();
    
    // 5. âœ¨ ä¿®æ­£é»ï¼šå‘¼å«æ­£ç¢ºçš„å‡½æ•¸åç¨±
    // åŸæœ¬å ±éŒ¯ï¼šrenderTabs();
    renderDayTabs(trip); 
    renderDayContent(); // åˆ·æ–°ä¸‹æ–¹çš„æ’ç¨‹å…§å®¹
    
    showMessage(`ç¬¬ ${dayNum} å¤©å·²åˆªé™¤`, 'success');
}

/** æ ¹æ“šç¬¬ä¸€å¤©çš„æ—¥æœŸï¼Œé‡æ–°æ¨ç®—æ•´å€‹ trip çš„æ‰€æœ‰æ—¥æœŸ */
function recalculateAllDaysDates(trip) {
    if (!trip || !trip.days || trip.days.length === 0) return;

    // å–å¾—ç¬¬ä¸€å¤©çš„æ—¥æœŸä½œç‚ºåŸé»
    let startDateStr = trip.days[0].date; 
    if (!startDateStr) return;

    const baseDate = new Date(startDateStr);

    trip.days.forEach((day, index) => {
        const dateObj = new Date(baseDate);
        dateObj.setDate(baseDate.getDate() + index);
        
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        day.date = `${y}-${m}-${d}`;
        day.dayNum = index + 1; // é †ä¾¿é‡æ•´åºè™Ÿ
    });
}

/** ğŸ‘º çµ‚æ¥µæ ¸å½ˆç‰ˆï¼šå¾¹åº•æ‘§æ¯€èˆŠ DOM ç¯€é»ä¸¦å¼·è¿«ç€è¦½å™¨é‡ç¹ª */
async function executeDeleteDay(dayNum) {
    const trip = getCurrentTrip();
    if (!trip) return;

    // 1. âœ¨ ç‰©ç†éš”é›¢ï¼šå…‹éš†ä¸¦æ›¿æ›å®¹å™¨ï¼Œé€™æœƒå¼·åˆ¶ç€è¦½å™¨éºå¿˜èˆŠæœ‰çš„ç¯€é»ç‹€æ…‹èˆ‡å¿«å–
    const oldTabs = document.getElementById('day-tabs-container');
    const newTabs = oldTabs.cloneNode(false); // å…‹éš†ä½†ä¸åŒ…å«å­ç¯€é»
    oldTabs.parentNode.replaceChild(newTabs, oldTabs);
    
    // 2. æ¸…ç©ºå…§å®¹å€
    const dayContent = document.getElementById('day-content-itinerary');
    if (dayContent) dayContent.innerHTML = '';

    // 3. æ•¸æ“šç§»é™¤ (dayNum æ˜¯ 1-based)
    trip.days.splice(dayNum - 1, 1);
    
    // 4. ğŸ›¡ï¸ æ•¸æ“šé€£é–æ ¡æº– (ç¢ºä¿æ—¥æœŸèˆ‡åºè™Ÿå®Œå…¨æ­£ç¢º)
    if (trip.days.length > 0) {
        const startDate = new Date(trip.days[0].date); 
        trip.days.forEach((day, index) => {
            day.dayNum = index + 1;
            const nextDate = new Date(startDate);
            nextDate.setDate(startDate.getDate() + index);
            day.date = nextDate.toISOString().split('T')[0];

            // é—œéµé˜²ç¦¦ï¼šé™¤äº†æœ€å¾Œä¸€å¤©ï¼Œå…¶é¤˜å¼·åˆ¶æ¸…é™¤é›¢å¢ƒå¡
            if (index !== trip.days.length - 1) {
                day.departureInfo = {}; 
            }
        });
    }
    
    // 5. ç´¢å¼•å®‰å…¨æ ¡æ­£
    if (state.currentDayIndex >= trip.days.length) {
        state.currentDayIndex = Math.max(0, trip.days.length - 1);
    }

    // 6. æŒä¹…åŒ–
    await saveData();
    
    // 7. ğŸš€ é›™é‡è§¸ç™¼æ¸²æŸ“
    if (trip.days.length === 0) {
        switchView('list');
    } else {
        // ä½¿ç”¨ RequestAnimationFrame ç¢ºä¿ç€è¦½å™¨å·²è™•ç†å®Œå®¹å™¨æ›¿æ›
        requestAnimationFrame(() => {
            renderTripDetail(); 
            showMessage(`ç¬¬ ${dayNum} å¤©å·²ç§»é™¤ï¼Œç³»çµ±å·²é‡æ•´`, 'success');
        });
    }
}


/** ğŸ”„ è™•ç†æ’ç¨‹è¡¨å–®æäº¤ (åŠ å…¥æè¿°å°å¡åˆ¤å®šèˆ‡æ™‚é–“æ’åºé‚è¼¯) */
function handleScheduleSubmit(event) {
    event.preventDefault();

    const trip = getCurrentTrip(); 
    const day = getCurrentDay();
    const scheduleId = document.getElementById('schedule-id').value;
    const isEditing = !!scheduleId;
    const workshopKey = `${trip.id}_day${day.dayNum}`;

    const selectedStyle = document.getElementById('schedule-style').value;
    const customStyleName = selectedStyle === 'other' ? document.getElementById('schedule-custom-style').value.trim() : '';
    
    // ğŸŒŸ [æè¿°å°å¡åˆ¤å®š]
    const isDescription = selectedStyle === 'description';

    const newScheduleData = {
        name: document.getElementById('schedule-name').value.trim(),
        address: isDescription ? "" : document.getElementById('schedule-address').value.trim(), // æè¿°å°å¡ä¸éœ€åœ°å€
        // ğŸ’¡ ä¿®æ­£ï¼šç§»é™¤ notes çš„ <br> æ›¿æ›ï¼Œäº¤çµ¦æ¸²æŸ“å¼•æ“è™•ç†ä»¥ä¿æŒåŸå§‹æ•¸æ“šç´”æ·¨
        notes: document.getElementById('schedule-notes').value.trim(), 
        rainPlan: isDescription ? "" : document.getElementById('schedule-rain-plan').value.trim(), 
        
        // ğŸ’° åƒ¹æ ¼ç‰©ç†é–å®šï¼šæè¿°å°å¡å¼·åˆ¶ç‚º 0
        cost: isDescription ? "0" : document.getElementById('schedule-cost').value.trim().replace(/[^0-9]/g, ''), 
        
        startTime: document.getElementById('schedule-start-time').value,
        
        // â³ åœç•™æ™‚é–“é–å®šï¼šæè¿°å°å¡è¨­ç‚ºæ¥µçŸ­ä½”ä½ (0.1hr)
        durationHours: isDescription ? 0.1 : (parseFloat(document.getElementById('schedule-duration').value) || 1),
        
        style: selectedStyle, 
        customStyle: isDescription ? "æè¿°" : customStyleName
    };

    // --- âœ¨ æ ¸å¿ƒåˆ†æµé‚è¼¯ ---
    if (state.planViewMode === 'workshop') {
        // ç¢ºä¿å·¥åŠåŸºåº•å­˜åœ¨
        if (!state.shadowItineraries[workshopKey]) {
            state.shadowItineraries[workshopKey] = JSON.parse(JSON.stringify(day.schedules || []));
        }

        if (isEditing) {
            const idx = state.shadowItineraries[workshopKey].findIndex(s => s.id === scheduleId);
            if (idx !== -1) {
                state.shadowItineraries[workshopKey][idx] = { ...state.shadowItineraries[workshopKey][idx], ...newScheduleData };
            }
        } else {
            state.shadowItineraries[workshopKey].push({ id: generateUUID(), ...newScheduleData });
        }
        
        // âœ¨ ã€æ™‚é–“æ’åºã€‘
        state.shadowItineraries[workshopKey].sort((a, b) => a.startTime.localeCompare(b.startTime));
        
        // é‡å°å·¥åŠæ•¸æ“šé‡ç®—æ™‚é–“
        recalculateScheduleTimes({ schedules: state.shadowItineraries[workshopKey], startTime: day.startTime });
        showMessage(`ğŸ› ï¸ å·²å„²å­˜ä¸¦æ’åºå·¥åŠè‰ç¨¿ ${isDescription ? '(æè¿°æŒ‡å¼•)' : ''}`, 'info');

    } else {
        // ğŸ“Œ æ­£å¼æ¨¡å¼
        if (isEditing) {
            const index = day.schedules.findIndex(s => s.id === scheduleId);
            if (index !== -1) {
                day.schedules[index] = { ...day.schedules[index], ...newScheduleData };
            }
        } else {
            day.schedules.push({ id: generateUUID(), ...newScheduleData });
        }

        // âœ¨ ã€æ™‚é–“æ’åºã€‘
        day.schedules.sort((a, b) => a.startTime.localeCompare(b.startTime));

        recalculateScheduleTimes(day);
        showMessage(`ğŸ“Œ å·²æ›´æ–°æ­£å¼æ’ç¨‹ ${isDescription ? '(æè¿°æŒ‡å¼•)' : ''}`, 'success');
    }

    // --- ğŸ’¾ ç‰©ç†æŒä¹…åŒ–èˆ‡è¦–åœ–åˆ·æ–° ---
    toggleModal('add-schedule-modal');
    renderDayContent();

    // åœ¨å„²å­˜æ•¸æ“šå¾Œï¼Œå°‡ç•¶å‰çš„ shadowItineraries åŒæ­¥å› workshops é™£åˆ—
    if (state.planViewMode === 'workshop' && state.currentWorkshopId) {
        const ws = state.workshops.find(w => w.id === state.currentWorkshopId);
        if (ws) {
            ws.data = JSON.parse(JSON.stringify(state.shadowItineraries));
        }
    }

    saveData();
}

        /**
         * åˆªé™¤ç•¶å‰è¡Œç¨‹ (ç¬¬ä¸€æ­¥ï¼šé–‹å•Ÿç¢ºèªå°è©±æ¡†)
         */
        function deleteCurrentTrip() {
            const tripId = document.getElementById('current-trip-id-for-edit').value;
            const trip = getCurrentTrip();

            if (trip) {
                // é—œé–‰è¡Œç¨‹ç·¨è¼¯æ¨¡æ…‹æ¡†
                toggleModal('trip-edit-modal');

                // è¨­ç½®ç¢ºèªè¨Šæ¯
                const messageEl = document.getElementById('confirm-delete-message');
                messageEl.innerHTML = `æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤è¡Œç¨‹ <strong>"${trip.name}"</strong> å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`;

                // è¨­ç½®ç¢ºèªæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
                const confirmBtn = document.getElementById('confirm-delete-btn');
                confirmBtn.onclick = () => executeDeleteTrip(tripId);

                // é–‹å•Ÿç¢ºèªæ¨¡æ…‹æ¡†
                toggleModal('confirm-delete-modal');
            } else {
                 showMessage('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦åˆªé™¤çš„è¡Œç¨‹ã€‚', 'error');
            }
        };

        /**
         * åŸ·è¡Œåˆªé™¤ç•¶å‰è¡Œç¨‹ (ç¬¬äºŒæ­¥ï¼šå¾ç¢ºèªå°è©±æ¡†èª¿ç”¨)
         * @param {string} tripId - è¦åˆªé™¤çš„è¡Œç¨‹ ID
         */
        function executeDeleteTrip(tripId) {
            state.trips = state.trips.filter(t => t.id !== tripId);
            
            toggleModal('confirm-delete-modal'); // é—œé–‰ç¢ºèªå°è©±æ¡†
            switchView('list'); // åˆ‡æ›å›åˆ—è¡¨é é¢
            showMessage('è¡Œç¨‹å·²æˆåŠŸåˆªé™¤ï¼', 'info'); 
        }

        /**
         * å„²å­˜è¡Œç¨‹åç¨±ç·¨è¼¯
         */
        function saveTripNameEdit() {
            const tripId = document.getElementById('current-trip-id-for-edit').value;
            const trip = getCurrentTrip();
            const newName = document.getElementById('edit-trip-name').value.trim();
            
            if (trip && newName) {
                trip.name = newName;
                toggleModal('trip-edit-modal');
                // å¦‚æœç•¶å‰åœ¨è©³æƒ…é ï¼Œå‰‡æ›´æ–°æ¨™é¡Œï¼Œå¦å‰‡åªæ˜¯é‡æ–°æ¸²æŸ“åˆ—è¡¨
                if (state.currentTripId === tripId) {
                     renderTripDetail(); 
                } else {
                     renderTripList();
                }
                saveData();
                showMessage('è¡Œç¨‹åç¨±å·²æ›´æ–°ï¼', 'info'); 
            } else {
                showMessage('è¡Œç¨‹åç¨±ä¸èƒ½ç‚ºç©º', 'error');
            }
        };

/**
 * å‹•æ…‹æ¸²æŸ“æ›´æ–°æ—¥èªŒå…§å®¹ (é…åˆ versionGroups çµæ§‹)
 */
function renderVersionHistory() {
    const container = document.getElementById('version-history-body');
    if (!container) return;

    // æ¸…ç©ºç¾æœ‰å…§å®¹
    container.innerHTML = '';

    state.versionGroups.forEach((group, groupIdx) => {
        // å»ºç«‹å¤§ç‰ˆæœ¬å€å¡Šæ¨™é¡Œ
        const groupHeader = document.createElement('div');
        groupHeader.className = 'mt-6 first:mt-0 mb-3';
        groupHeader.innerHTML = `
            <div class="flex items-center space-x-2 px-1">
                <span class="text-[10px] font-black bg-gray-800 text-white px-1.5 py-0.5 rounded">V${group.major}</span>
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">${group.title}</span>
            </div>
        `;
        container.appendChild(groupHeader);

        // å»ºç«‹è©²åˆ†çµ„ä¸‹çš„å°ç‰ˆæœ¬
        const groupWrapper = document.createElement('div');
        groupWrapper.className = 'space-y-2';

        group.versions.forEach((item, itemIdx) => {
            const isLatest = item.v === state.version;
            const itemDiv = document.createElement('div');
            itemDiv.className = `group border ${isLatest ? 'border-blue-100 ring-1 ring-blue-50' : 'border-gray-50'} rounded-xl overflow-hidden transition-all duration-300 shadow-sm`;
            
            itemDiv.innerHTML = `
                <div class="p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center transition" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('rotate-180')">
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-700 text-sm flex items-center">
                            v${item.v}
                            ${isLatest ? '<span class="ml-2 text-[9px] bg-blue-500 text-white px-1.5 py-0.5 rounded-full font-normal animate-pulse">Latest</span>' : ''}
                        </span>
                        <span class="text-[10px] text-gray-400 mt-0.5">${item.date}</span>
                    </div>
                    <svg class="chevron w-4 h-4 text-gray-300 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div class="${isLatest ? '' : 'hidden'} p-4 pt-0 text-xs text-gray-500 leading-relaxed space-y-2 border-t border-gray-50 bg-gray-50/30">
                    <ul class="list-disc list-inside space-y-1.5">
                        ${item.logs.map(log => `<li class="pl-1">${log}</li>`).join('')}
                    </ul>
                </div>
            `;
            groupWrapper.appendChild(itemDiv);
        });
        
        container.appendChild(groupWrapper);
    });
}

/**
 * ğŸ”„ æ™ºæ…§å‹æ¨¡æ…‹æ¡†ç¸½æ§ (v2.7)
 * æ•´åˆï¼šç‰ˆæœ¬æ—¥èªŒè‡ªå‹•æ¸²æŸ“ã€åŒ¯å‡ºç²¾éˆè¡Œç¨‹åŒæ­¥ã€ç‹€æ…‹é‡è¨­
 */
function toggleModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;

    const isOpening = modal.classList.contains('hidden');
    modal.classList.toggle('hidden');

    // å¦‚æœæ¨¡æ…‹æ¡†æ­£åœ¨è¢«æ‰“é–‹ï¼ŒåŸ·è¡Œç‰¹å®šçš„åˆå§‹åŒ–
    if (isOpening) {
        switch (id) {
            // 1. ç‰ˆæœ¬æ—¥èªŒï¼šé–‹å•Ÿæ™‚æ¸²æŸ“æ­·å²åˆ—è¡¨
            case 'version-history-modal':
                if (typeof renderVersionHistory === 'function') {
                    renderVersionHistory();
                }
                break;

            // 2. åŒ¯å‡ºç²¾éˆï¼šé–‹å•Ÿæ™‚å‹•æ…‹æŠ“å–æœ€æ–°è¡Œç¨‹åˆ—è¡¨ä¾›å‹¾é¸
            case 'export-wizard-modal':
                if (typeof setupExportWizard === 'function') {
                    setupExportWizard();
                }
                break;
                
            // 3. å­—å…¸ç®¡ç†ï¼šé–‹å•Ÿæ™‚æ¸²æŸ“ç¾æœ‰è¾¨è­˜è¦å‰‡
            case 'dictionary-manager-modal':
                if (typeof renderDictList === 'function') {
                    renderDictList();
                }
                break;
        }
    }
}


/** ğŸ“¥ çµ±ä¸€åŒ¯å…¥è™•ç†å™¨ (å·²æ•´åˆé«˜ç´šæŒ‘é¸å™¨) */
function processImport(payload) {
    if (!payload) return;

    // 1. è™•ç†ç³»çµ±è¨­å®šè½‰ç§»
    if (payload.type === "CONFIG_TRANSFER") {
        if (confirm("åµæ¸¬åˆ°ç³»çµ±è¨­å®šè½‰ç§»ï¼ˆå« API KEYï¼‰ï¼Œæ˜¯å¦å¥—ç”¨è‡³æ­¤è£ç½®ï¼Ÿ")) {
            applySystemSettings(payload.data);
        }
        return;
    } 

    // 2. è™•ç†è¡Œç¨‹åŒ…è£¹ (ä¸è«–æ˜¯å‚™ä»½é‚„æ˜¯å¥½å‹åˆ†äº«)
    // ğŸŒŸ çµ±ä¸€å‘¼å«ã€Œé«˜ç´šé è¦½æŒ‘é¸å™¨ã€ï¼Œå»¢æ£„èˆŠçš„ showImportPreview
    showSmartImportSelector(payload);
}



/** ğŸ’ [å¤§è€é—†] é«˜ç´šé è¦½æŒ‘é¸å™¨ - æ——è‰¦å…¨èƒ½è§£æç‰ˆ */
function showSmartImportSelector(payload) {
    window.currentIncomingPayload = payload;
    
    // ==========================================
    // ğŸš€ [å…¨èƒ½è§£ææ ¸å¿ƒ] æš´åŠ›ç©¿é€æŠ€è¡“ï¼šä¸è«–åŸ‹å¤šæ·±éƒ½æŒ–å‡ºä¾†
    // ==========================================
    function findDataDeeply(obj, targetKey, fallbackKeys = []) {
        if (!obj || typeof obj !== 'object') return null;
        
        // 1. å„ªå…ˆæª¢æŸ¥ç›®å‰å±¤ç´šæ˜¯å¦æœ‰ç›®æ¨™ Key æˆ– æ›¿ä»£ Key
        const keysToTry = [targetKey, ...fallbackKeys];
        for (const key of keysToTry) {
            if (Array.isArray(obj[key])) return obj[key];
        }

        // 2. è‹¥ç„¡ï¼Œå‰‡éè¿´æ·±å…¥æ¯ä¸€å±¤
        for (const k in obj) {
            if (typeof obj[k] === 'object') {
                const found = findDataDeeply(obj[k], targetKey, fallbackKeys);
                if (found) return found;
            }
        }
        return null;
    }

    // åŸ·è¡Œå…¨åŸŸæƒæ (æ”¯æ´å„ç¨®å‘½ååˆ¥å)
    const trips = findDataDeeply(payload, 'trips', ['allTrips']) || [];
    const bucketList = findDataDeeply(payload, 'bucketList', ['buckets', 'bucketItems']) || [];
    const dictionary = findDataDeeply(payload, 'dictionary', ['customDictionary', 'dict']) || [];
    const shoppingList = findDataDeeply(payload, 'shoppingList', ['shopping']) || [];

    // ğŸ“Š æˆ°è¡“å ±å‘Šè¼¸å‡ºè‡³ Console
    console.log(`ğŸ“¡ [æ·±åº¦é›·é”æƒæå®Œæˆ] 
    - ç²å–è¡Œç¨‹: ${trips.length} å€‹
    - ç²å–ç‡ƒæ–™åŒ…: ${bucketList.length} ç­†
    - ç²å–å­—å…¸: ${dictionary.length} æ¢
    - ç²å–è³¼ç‰©æ¸…å–®: ${shoppingList.length} ç­†`);
    // ==========================================

    const isRestoreMode = (payload.type === "CLOUD_RESTORE" || payload.type === "FULL_BACKUP");
    const actionFuncName = "executeSmartFinalImport()"; 
    const actionBtnText = isRestoreMode ? "ç¢ºèªä¸¦ç²¾æº–å›æº¯" : "ç¢ºèªåŒ¯å…¥é¸ä¸­è¡Œç¨‹";

    const modalHTML = `
        <div id="import-preview-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[10002] flex items-center justify-center p-4 animate-in fade-in duration-300">
            <div class="bg-white rounded-[2.5rem] w-full max-w-lg overflow-hidden shadow-2xl flex flex-col max-h-[90vh] ring-1 ring-white/20">
                
                <div class="p-6 bg-slate-900 text-white flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center shadow-xl shadow-blue-500/20">
                            <i class="fa-solid fa-box-open text-xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-black text-xl leading-none">æ•¸ä½åŒ…è£¹è§£æ</h3>
                            <p class="text-[10px] text-blue-400 mt-1 uppercase tracking-[0.2em] font-black">Smart Merging Engine</p>
                        </div>
                    </div>
                    <button onclick="closeImportPreview()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-800 text-slate-400 hover:text-white transition-all">âœ•</button>
                </div>

                <div class="px-6 py-4 bg-white border-b border-slate-100 flex-shrink-0">
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-sm"></i>
                        <input type="text" id="selector-search-input" 
                               oninput="filterImportItems(this.value)"
                               placeholder="æœå°‹è¡Œç¨‹åç¨±ã€åœ°å€..." 
                               class="w-full pl-11 pr-4 py-3 bg-slate-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-blue-500/20 transition-all placeholder:text-slate-300 font-medium outline-none">
                    </div>
                </div>

                <div class="modal-scroll-area p-6 space-y-8 bg-slate-50/50 flex-grow overflow-y-auto no-scrollbar">
                    
                    <div class="section-trips">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <span class="w-1 h-3 bg-blue-500 rounded-full"></span> 1. é¸æ“‡è¦åŒ¯å…¥çš„è¡Œç¨‹
                            </h4>
                            <div class="flex gap-4">
                                <button onclick="toggleImportCheckboxes(true)" class="text-[10px] text-blue-600 font-black hover:opacity-70 transition-all">å…¨é¸å¯è¦–</button>
                                <button onclick="toggleImportCheckboxes(false)" class="text-[10px] text-slate-400 font-black hover:opacity-70 transition-all">æ¸…ç©º</button>
                            </div>
                        </div>
                        <div id="import-trip-list-container" class="space-y-2">
                            ${trips.length > 0 ? trips.map((trip, idx) => renderImportCard(trip, idx)).join('') : '<div class="text-center py-6 text-slate-300 text-xs italic">ç„¡è¡Œç¨‹è³‡æ–™</div>'}
                        </div>
                    </div>

                    <div class="section-addons">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 px-1 flex items-center gap-2">
                            <span class="w-1 h-3 bg-rose-400 rounded-full"></span> 2. æ•¸æ“šæ¨¡çµ„æ“´å……
                        </h4>
                        <div class="grid grid-cols-1 gap-3">
                            ${bucketList.length > 0 ? `
                                <label class="flex items-center justify-between p-4 bg-white border border-slate-200/60 rounded-2xl cursor-pointer hover:border-rose-300 transition-all group shadow-sm">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-rose-50 text-rose-500 rounded-xl flex items-center justify-center text-lg group-hover:rotate-12 transition-all">ğŸ’</div>
                                        <div>
                                            <p class="text-sm font-black text-slate-700">åŒ¯å…¥å‚™é¸å£è¢‹åå–®</p>
                                            <p class="text-[9px] font-bold text-rose-400 mt-0.5 uppercase tracking-tighter">å…± ${bucketList.length} å€‹æ”¶è—æ™¯é»</p>
                                        </div>
                                    </div>
                                    <input type="checkbox" id="import-inc-bucket" checked 
                                           class="w-6 h-6 rounded-lg border-slate-300 text-rose-500 focus:ring-rose-500 cursor-pointer shadow-sm">
                                </label>
                            ` : `<div class="p-4 border-2 border-dashed border-slate-200 rounded-2xl text-center text-slate-300 text-xs italic">ç‡ƒæ–™åŒ…æœªåµæ¸¬åˆ°ï¼Œè«‹ç¢ºèªå‚™ä»½ä¾†æº</div>`}
                            
                            ${dictionary.length > 0 ? `
                                <label class="flex items-center justify-between p-4 bg-white border border-slate-200/60 rounded-2xl cursor-pointer hover:border-amber-300 transition-all group shadow-sm">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-amber-50 text-amber-500 rounded-xl flex items-center justify-center text-lg group-hover:scale-110 transition-all">ğŸ“–</div>
                                        <div>
                                            <p class="text-sm font-black text-slate-700">åŒæ­¥è¾¨è­˜å­—å…¸</p>
                                            <p class="text-[9px] font-bold text-amber-400 mt-0.5 uppercase tracking-tighter">å„ªåŒ– AI æ™¯é»è‡ªå‹•è§£æåŠ›</p>
                                        </div>
                                    </div>
                                    <input type="checkbox" id="import-inc-dict" checked 
                                           class="w-6 h-6 rounded-lg border-slate-300 text-amber-500 focus:ring-amber-500 cursor-pointer shadow-sm">
                                </label>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-white border-t border-slate-100 flex-shrink-0 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
                    <div class="flex gap-3">
                        <button onclick="closeImportPreview()" 
                                class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black text-xs hover:bg-slate-200 active:scale-95 transition-all">
                            æ”¾æ£„åŒ¯å…¥
                        </button>
                        <button onclick="${actionFuncName}" 
                                class="flex-[2] py-4 bg-slate-900 text-white rounded-2xl font-black text-xs shadow-xl shadow-slate-200 active:scale-95 hover:bg-blue-600 transition-all">
                            ${actionBtnText}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // æ¸…ç†èˆ‡æ›è¼‰
    const oldModal = document.getElementById('import-preview-modal');
    if (oldModal) oldModal.remove();
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}


/** ğŸ› ï¸ è¼”åŠ©ï¼šæ¸²æŸ“åŒ¯å…¥å¡ç‰‡æ¨£å¼ */
function renderImportCard(item, idx, type) {
    return `
        <label class="import-item-card flex items-center justify-between p-4 bg-white border border-slate-200/60 rounded-2xl cursor-pointer hover:border-blue-400 transition-all group" data-name="${item.name || item.tripName}">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-lg group-hover:scale-110 transition-all">ğŸ—“ï¸</div>
                <div>
                    <p class="text-sm font-black text-slate-700 truncate max-w-[180px]">${item.name || item.tripName || 'æœªå‘½åè¡Œç¨‹'}</p>
                    <p class="text-[9px] font-bold text-slate-400 mt-0.5">${item.days?.length || 0} Days Â· ${item.date || 'ç„¡æ—¥æœŸ'}</p>
                </div>
            </div>
            <input type="checkbox" name="import-trip-idx" value="${idx}" checked class="w-6 h-6 rounded-full border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
        </label>
    `;
}

/** ğŸ› ï¸ è¼”åŠ©ï¼šæ‰¹æ¬¡åˆ‡æ›å‹¾é¸ç‹€æ…‹ (ç©¶æ¥µå¼·å¥ç‰ˆ) */
function toggleImportCheckboxes(selected) {
    const list = document.getElementById('import-trip-list-container');
    if (!list) return;

    list.querySelectorAll('.import-item-card').forEach(card => {
        // âœ¨ æ”¹é€²ï¼šåªè¦ä¸æ˜¯æ˜ç¢ºè¢«è¨­ç‚º noneï¼Œå°±è¦–ç‚ºå¯è¦–é …
        // (è™•ç†ä¸€é–‹å§‹ display ç‚ºç©ºå­—ä¸²çš„æƒ…æ³)
        if (card.style.display !== 'none') {
            const cb = card.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = selected;
        }
    });
}

/** ğŸ” å³æ™‚éæ¿¾åŒ¯å…¥é …ç›® */
function filterImportItems(keyword) {
    const items = document.querySelectorAll('.import-item-card');
    const term = keyword.toLowerCase();
    
    items.forEach(card => {
        const name = card.getAttribute('data-name').toLowerCase();
        if (name.includes(term)) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
}

/** ğŸš€ æ©‹æ¥å™¨ï¼šå°‡æŒ‘é¸å¥½çš„é›²ç«¯è¡Œç¨‹é¤µçµ¦å·®ç•°æ¯”å°å¼•æ“ */
function startSmartMergeFlow() {
    const payload = window.currentIncomingPayload;
    if (!payload) return;

    // 1. å–å¾—ç•«é¢ä¸Šå‹¾é¸çš„è¡Œç¨‹ç´¢å¼•
    const selectedCheckboxes = document.querySelectorAll('input[name="import-trip-idx"]:checked');
    const selectedIdxs = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    const allIncomingTrips = payload.content?.trips || payload.trips || [];
    const selectedTrips = selectedIdxs.map(idx => allIncomingTrips[idx]);

    if (selectedTrips.length === 0) {
        showMessage("è«‹è‡³å°‘é¸å–ä¸€å€‹è¡Œç¨‹é€²è¡Œæ¯”å°", "info");
        return;
    }

    // 2. æš«å­˜é™„åŠ æ¨¡çµ„ (ä¾› applySmartMerge æœ€çµ‚å¯«å…¥ IndexedDB)
    window.pendingCloudMetadata = {
        bucketList: document.getElementById('import-inc-bucket')?.checked ? (payload.content?.bucketList || []) : [],
        dictionary: document.getElementById('import-inc-dict')?.checked ? (payload.content?.dictionary || []) : []
    };

    // 3. é—œé–‰æŒ‘é¸è¦–çª—ï¼Œå•Ÿå‹•å·®ç•°æ¯”å°è¦–çª—
    closeImportPreview();
    
    // èª¿ç”¨å·®ç•°å¼•æ“ï¼šæ¯”å°è¡Œç¨‹æŒ‡ç´‹ (é›œæ¹Š) ä¸¦é–‹å•Ÿ smart-diff-modal
    processSmartDiff(selectedTrips); 
}


/** âœ… æœ€çµ‚åŸ·è¡Œæ™ºæ…§åŒ¯å…¥ (æ——è‰¦æ•´åˆï¼šæ•¸æ“šç©¿é€ + ç²¾æº–ç¸«åˆ + è·¨å¹³å°é˜²ç¦¦ç‰ˆ) */
async function executeSmartFinalImport() {
    const payload = window.currentIncomingPayload;
    if (!payload) {
        showMessage("âŒ æ•¸æ“šåŒ…è£¹å·²å¤±æ•ˆ", "error");
        return;
    }

    try {
        showMessage("ğŸ§¬ æ­£åœ¨åŸ·è¡Œå…¨æ¨¡çµ„æ•¸æ“šç¸«åˆï¼ˆå®‰å…¨é˜²ç¦¦æ¨¡å¼ï¼‰...", "info");

        // --- ğŸš€ éšæ®µä¸€ï¼šå¼·åŠ›æ·±åº¦æƒæ (ç©¿é€ Google Drive åµŒå¥—å±¤ç´š) ---
        function deepFind(obj, target) {
            if (!obj || typeof obj !== 'object') return null;
            if (Array.isArray(obj[target])) return obj[target];
            for (let key in obj) {
                const found = deepFind(obj[key], target);
                if (found) return found;
            }
            return null;
        }

        const rawContent = payload.content || payload;
        const incomingTrips = deepFind(rawContent, 'trips') || [];
        const incomingBucket = deepFind(rawContent, 'bucketList') || deepFind(rawContent, 'buckets') || [];
        const incomingDict = deepFind(rawContent, 'dictionary') || deepFind(rawContent, 'translations') || [];
        const incomingShopping = deepFind(rawContent, 'shoppingList') || [];
        const incomingEmergency = deepFind(rawContent, 'emergencyContacts') || null;

        // --- ğŸ“Š éšæ®µäºŒï¼šå–å¾— UI å‹¾é¸ç‹€æ…‹ ---
        const selectedCheckboxes = document.querySelectorAll('input[name="import-trip-idx"]:checked');
        const selectedIdxs = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
        const selectedTrips = selectedIdxs.map(idx => incomingTrips[idx]);
        const includeAddons = document.getElementById('import-inc-bucket')?.checked;

        // --- ğŸ’‰ éšæ®µä¸‰ï¼šç²¾æº–æ•¸æ“šç¸«åˆ ---
        
        // A. è¡Œç¨‹ç¸«åˆï¼šID ç›¸åŒå‰‡æ›´æ–°ï¼Œä¸åŒå‰‡æ–°å¢ (é˜²æ­¢é‡è¤‡)
        const tripMap = new Map((state.trips || []).map(t => [t.id || t.tripId, t]));
        selectedTrips.forEach(newTrip => {
            const finalId = newTrip.id || newTrip.tripId || ('trip_' + Date.now() + Math.random().toString(36).substr(2,4));
            newTrip.id = finalId; 
            tripMap.set(finalId, newTrip);
        });
        state.trips = Array.from(tripMap.values());

        // B. é™„åŠ æ¨¡çµ„è‡ªç™’
        if (includeAddons) {
            // 1. ç‡ƒæ–™åŒ…åˆä½µ (299 ç­†æ™¯é»æ­¸ä½é‚è¼¯)
            const globalBucketMap = new Map((state.bucketList || []).map(b => [b.name || b.id, b]));
            incomingBucket.forEach(item => globalBucketMap.set(item.name || item.id, item));
            state.bucketList = Array.from(globalBucketMap.values());

            // åŒæ­¥è‡³æ‰€é¸è¡Œç¨‹å…§éƒ¨
            selectedTrips.forEach(t => {
                const tripBucketMap = new Map((t.bucketList || []).map(b => [b.name || b.id, b]));
                incomingBucket.forEach(item => tripBucketMap.set(item.name || item.id, item));
                t.bucketList = Array.from(tripBucketMap.values());
            });

            // 2. è³¼ç‰©æ¸…å–®åˆä½µ
            const shoppingMap = new Map((state.shoppingList || []).map(s => [s.id || s.name, s]));
            incomingShopping.forEach(item => shoppingMap.set(item.id || item.name, item));
            state.shoppingList = Array.from(shoppingMap.values());

            // 3. ç·Šæ€¥è¯çµ¡åˆä½µ
            if (incomingEmergency) {
                const mergeContacts = (local, incoming) => Array.from(new Map([...(local || []), ...(incoming || [])].map(x => [x.name || x.id, x])).values());
                state.emergencyContacts.embassies = mergeContacts(state.emergencyContacts.embassies, incomingEmergency.embassies);
                state.emergencyContacts.medical = mergeContacts(state.emergencyContacts.medical, incomingEmergency.medical);
            }

            // 4. âœ¨ å­—å…¸é˜²ç¦¦æ€§åˆä½µ (è§£æ±º 234K æ•¸æ“šåªå‰© 20 ç­†çš„çµ‚æ¥µæ–¹æ¡ˆ)
            const existingDict = await dbManager.getAll('dictionary_store') || [];
            
            // ğŸ›¡ï¸ æ•¸é‡é–¥é–€ï¼šåªæœ‰ç•¶åŒ¯å…¥å­—å…¸ç­†æ•¸ >= æœ¬åœ°ç­†æ•¸æ™‚ï¼Œæ‰åŸ·è¡Œç‰©ç†è¦†è“‹
            // å¦å‰‡æ¡ã€Œå¢é‡åˆä½µã€ï¼Œç¢ºä¿æœ¬åœ°è¾›è‹¦å»ºç«‹çš„è¦å‰‡ä¸è¢«ç©ºåŒ…å½ˆæ´—æ‰
            if (incomingDict.length > 0) {
                const dictMap = new Map(existingDict.map(d => [d.tag || d.word || d.id, d]));
                incomingDict.forEach(entry => dictMap.set(entry.tag || entry.word || entry.id, entry));
                
                const finalDictArray = Array.from(dictMap.values());
                
                console.log(`ğŸ”¥ ç‰©ç†å±¤è‡ªå‹•ä¿®å¾©ï¼šåŒæ­¥ ${finalDictArray.length} ç­†å­—å…¸é …ç›®`);
                for (const entry of finalDictArray) {
                    if (dbManager.save) await dbManager.save('dictionary_store', entry);
                    else if (dbManager.put) await dbManager.put('dictionary_store', entry.tag || entry.id, entry);
                }
                window.GLOBAL_DICT = finalDictArray;
            }
        }

        // --- ğŸ’¾ éšæ®µå››ï¼šæŒä¹…åŒ–èˆ‡æŒ‡ç´‹æ›´æ–° ---
        state.lastRestoreTime = new Date().toISOString(); 
        await saveData();  
        closeImportPreview(); 

        setTimeout(() => {
            // è¦–åœ–è‡ªå‹•é‡ç¹ªèˆ‡åŒæ­¥
            if (state.currentSubView === 'bucket' && typeof renderBucketView === 'function') renderBucketView();
            if (typeof renderTripList === 'function') renderTripList();
            if (typeof renderApp === 'function') renderApp();
            
            const grid = document.getElementById('bucket-items-grid');
            if (grid && typeof renderBucketItems === 'function') renderBucketItems();
            
            showMessage(`âœ… æ•¸æ“šæ•´åˆå®Œæˆï¼å·²æ¢å¾©è¡Œç¨‹ã€${state.bucketList.length} ç­†æ™¯é»èˆ‡å…¨é‡å­—å…¸ã€‚`, "success");
            window.currentIncomingPayload = null;
        }, 150);

    } catch (e) {
        console.error("âŒ åŒ¯å…¥å´©æ½°:", e);
        showMessage("æ•¸æ“šç¸«åˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼", "error");
    }
}

/** ğŸšª é—œé–‰é è¦½ (å¢åŠ æ¸…ç†æ©Ÿåˆ¶) */
function closeImportPreview() {
    const modal = document.getElementById('import-preview-modal');
    if (modal) {
        modal.remove();
        // é¡å¤–æ¸…ç†ï¼šç¢ºä¿èƒŒæ™¯æ»¾å‹•æ¢å¾©ï¼Œé˜²æ­¢ UI é–æ­»
        document.body.style.overflow = '';
    }
    // é›™é‡ä¿éšªï¼šæ¸…ç†æš«å­˜
    window.currentIncomingPayload = null;
}



/* ==========================================
   ğŸ› ï¸ UI Controls (ä¿®æ­£å¾Œçš„é»æ“Šè™•ç†)
   ========================================== */

function handleModalBackdropClick(event, modalId) {
    const modal = document.getElementById(modalId);
    // åªæœ‰ç•¶é»æ“Šçš„ç›®æ¨™å‰›å¥½æ˜¯èƒŒæ™¯é®ç½©å±¤æ™‚æ‰é—œé–‰
    if (event.target === modal) {
        toggleModal(modalId);
    }
}


/** ğŸ›¡ï¸ æ——è‰¦å…¨è³‡ç”¢æ·±æ½›ç‰ˆï¼šexportData (v6.8)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [ç‰©ç†æ‰“æ’ˆ] ç©¿é€ IndexedDB æŠ“å– 15 ç­†åº§æ¨™èˆ‡ 35 ç­†è·¯ç¶²ã€‚
 * 2. [é›™è»Œè£œå„Ÿ] è‹¥ç£å€ç‚ºç©ºï¼Œè‡ªå‹•è½‰å‘è¨˜æ†¶é«” (State) æå–æ•¸æ“šã€‚
 * 3. [çµæ§‹é–å®š] ç¢ºä¿é›²ç«¯å¿«ç…§ (main_state) èˆ‡åŒ¯å‡ºæª”æ¡ˆå®Œå…¨å°é½Šã€‚
 */
async function exportData() {
    console.log("%cğŸš€ [å…¨é«”ç³»æ‰“æ’ˆ] å•Ÿå‹• v6.8 å…¨ç¶­åº¦è³‡ç”¢å°è£ç¨‹åº...", "color: #3b82f6; font-weight: bold;");
    try {
        // ğŸŒŸ 1. ç‰©ç†æˆ¿é–“å…¨æƒæï¼šç©¿é€ 5 å¤§æ ¸å¿ƒç£å€ (IndexedDB)
        const [
            physTrips,      // è¡Œç¨‹æ ¸å¿ƒ
            physVault,      // äº¤é€šè·¯ç¶²
            physDict,       // å­—å…¸ç¿»è­¯
            physGeo,        // åœ°ç†åº§æ¨™æŒ‡ç´‹
            physConfig      // é…ç½®ç£å€ (Checklist, Shopping, Emergency)
        ] = await Promise.all([
            dbManager.getAll('trips_store'),
            dbManager.getAll('transport_store'),
            dbManager.getAll('dictionary_store'),
            dbManager.getAll('geo_regions_store'),
            dbManager.getAll('config_store')
        ]);

        // ğŸŒŸ 2. æ•¸æ“šä»²è£è¼”åŠ©å™¨ï¼šå„ªå…ˆå–ç£å€å…§å®¹ï¼Œè‹¥ç„¡å‰‡ç”±è¨˜æ†¶é«”è£œè¶³
        const getPhysContent = (id, stateFallback) => {
            const asset = physConfig.find(c => c.id === id);
            return (asset && asset.content && asset.content.length > 0) ? asset.content : (stateFallback || []);
        };

        // ğŸŒŸ 3. å°è£å…¨ç¶­åº¦è³‡ç”¢é€ƒç”Ÿè‰™
        const exportPayload = {
            version: "v28.0-Ultimate-Backup",
            timestamp: new Date().toISOString(),
            // ç³»çµ±è¨ºæ–·çµ±è¨ˆ (ç¢ºèªæ‰“æ’ˆæ•¸é‡)
            stats: {
                trips: physTrips.length || (state.trips?.length || 0),
                dictionary: physDict.length || (state.dictionary?.length || 0),
                geoRegions: physGeo.length || (state.geoRegions?.length || 0),
                transportVault: physVault.length || (state.transportVault?.length || 0),
                checklist: getPhysContent('checklist_data', state.checklist).length,
                shopping: getPhysContent('shopping_list', state.shoppingList).length
            },
            content: {
                // A. æˆ°è¡“è¡Œå‹•æ¨¡çµ„ (é›™è»Œè£œå„Ÿæ‰“æ’ˆ)
                trips: (physTrips && physTrips.length > 0) ? physTrips : (state.trips || []),
                bucketList: state.bucketList || [],
                checklist: getPhysContent('checklist_data', state.checklist),
                shoppingList: getPhysContent('shopping_list', state.shoppingList),
                emergencyContacts: getPhysContent('emergency_data', state.emergencyContacts),
                
                // B. ç‰©ç†åŸºåº§æ¨¡çµ„ (å­—å…¸ã€è·¯ç¶²ã€åœ°ç†åº§æ¨™)
                dictionary: (physDict && physDict.length > 0) ? physDict : (state.dictionary || []),
                transportVault: (physVault && physVault.length > 0) ? physVault : (state.transportVault || []),
                geoRegions: (physGeo && physGeo.length > 0) ? physGeo : (state.geoRegions || []), 
                
                // C. ç³»çµ±ç’°å¢ƒè¨­å®š
                appConfig: {
                    theme: state.theme,
                    currency: state.currency,
                    totalBudget: state.totalBudget,
                    lastTripId: state.currentTripId,
                    mainStateVersion: "v28.0"
                }
            }
        };

        // ğŸŒŸ 4. ä¸‹è¼‰åŸ·è¡Œ
        const dataStr = JSON.stringify(exportPayload, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `TravelFlow_MASTER_BACKUP_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log("%câœ… [æ‰“æ’ˆæˆåŠŸ] è¡Œç¨‹ã€æ¸…å–®ã€è³¼ç‰©ã€å­—å…¸ã€è·¯ç¶²ã€åº§æ¨™å·²å…¨æ•¸å°è£å…¥è‰™ï¼š", "color: #10b981; font-weight: bold;", exportPayload.stats);
        if (typeof showMessage === 'function') {
            showMessage('âœ… å…¨è³‡ç”¢å‚™ä»½æˆåŠŸï¼Œæ‰€æœ‰æ¨¡çµ„å·²å®Œæ•´å°å‡º', 'success');
        }
        
    } catch (e) { 
        console.error("âŒ [æ‰“åŒ…ç½é›£æ€§å¤±æ•—] æ‰“æ’ˆè·¯å¾‘æ–·è£‚:", e);
        if (typeof showMessage === 'function') {
            showMessage('âŒ å‚™ä»½æ‰“åŒ…å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç³»çµ±ç‹€æ…‹', 'error');
        }
    }
}


function getScheduleHash(s) {
    if (!s) return 'empty';
    
    // ğŸŒŸ ä¿®æ­£é»ï¼šä½¿ç”¨ || "" é˜²æ­¢æ¬„ä½ç¼ºå¤±æ™‚ç”¢ç”Ÿ "undefined" å­—ä¸²å½±éŸ¿é›œæ¹Šçµæœ
    const coreContent = [
        s.name || "",
        s.startTime || "",
        s.durationHours || 0,
        s.notes || "",
        s.cost || 0,
        s.address || ""
    ].join('|');

    let hash = 0;
    for (let i = 0; i < coreContent.length; i++) {
        const char = coreContent.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash |= 0; 
    }
    return hash.toString(36);
}


/** ğŸ¨ æ¸²æŸ“ç²¾ç·»çš„å·®ç•°æ¯”å°é …ç›® (è¦–è¦ºå¼·åŒ–ç‰ˆ) */
function addDiffItem(type, label, data) {
    const id = `diff-${Math.random().toString(36).substr(2, 9)}`;
    pendingMergeData.push({ id, type, data, selected: true });

    // 1. é…ç½®è¦–è¦ºå±¬æ€§ (ä¿®æ­£ï¼šä½¿ç”¨å®Œæ•´ Tailwind é¡åé¿å…ç·¨è­¯éºæ¼)
    const config = {
        'new_trip': { 
            bg: 'bg-emerald-50', text: 'text-emerald-500', 
            tag: 'bg-emerald-100 text-emerald-600', icon: 'ğŸŒ', label: 'å…¨æ–°è¡Œç¨‹' 
        },
        'new_item': { 
            bg: 'bg-blue-50', text: 'text-blue-500', 
            tag: 'bg-blue-100 text-blue-600', icon: 'ğŸ“', label: 'æ–°å¢æ™¯é»' 
        },
        'mod_item': { 
            bg: 'bg-amber-50', text: 'text-amber-500', 
            tag: 'bg-amber-100 text-amber-600', icon: 'ğŸ“', label: 'å…§å®¹ç•°å‹•' 
        }
    }[type] || { bg: 'bg-slate-50', text: 'text-slate-500', tag: 'bg-slate-100 text-slate-600', icon: 'â“', label: 'æœªçŸ¥' };

    // 2. å…·é«”å·®ç•°å…§å®¹è¾¨è­˜
    let diffDetails = "";
    if (type === 'mod_item') {
        const trip = state.trips.find(t => t.id === data.tripId);
        const day = trip?.days.find(d => d.dayNum === data.dayNum);
        const local = day?.schedules.find(s => s.id === data.schedule.id);
        const remote = data.schedule;

        if (local) {
            const changes = [];
            if (local.startTime !== remote.startTime) changes.push(`â° æ™‚é–“: ${local.startTime} â†’ ${remote.startTime}`);
            if (local.name !== remote.name) changes.push(`ğŸ·ï¸ åç¨±è®Šæ›´`);
            if (local.notes !== remote.notes) changes.push(`âœï¸ å‚™è¨»æ›´æ–°`);
            if (parseInt(local.cost) !== parseInt(remote.cost)) changes.push(`ğŸ’° è²»ç”¨ç•°å‹•`);
            
            if (changes.length > 0) {
                diffDetails = `
                    <div class="mt-2 space-y-1">
                        ${changes.map(c => `<p class="text-[10px] text-amber-600 font-bold leading-none">${c}</p>`).join('')}
                    </div>`;
            }
        }
    }

    // 3. è¼¸å‡º HTML (ä¿®æ­£ï¼šå¼·åŒ– Checkbox äº¤äº’)
    const html = `
        <div class="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-2xl cursor-pointer hover:border-blue-300 transition-all shadow-sm group relative" 
             onclick="const cb = this.querySelector('input'); cb.checked = !cb.checked; updateDiffSelection('${id}', cb.checked)">
            
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <div class="w-10 h-10 rounded-xl ${config.bg} ${config.text} flex items-center justify-center text-lg flex-shrink-0 group-hover:scale-110 transition-transform">
                    ${config.icon}
                </div>
                
                <div class="min-w-0 flex-1 text-left">
                    <span class="text-[9px] font-black uppercase px-1.5 py-0.5 rounded ${config.tag} tracking-tighter">
                        ${config.label}
                    </span>
                    <p class="text-sm font-bold text-slate-700 truncate mt-1">${label}</p>
                    ${diffDetails}
                </div>
            </div>

            <div class="ml-4 flex-shrink-0" onclick="event.stopPropagation()">
                <input type="checkbox" checked onchange="updateDiffSelection('${id}', this.checked)" 
                       class="diff-item-checkbox w-6 h-6 text-blue-600 rounded-full border-slate-300 focus:ring-blue-500 transition-all cursor-pointer">
            </div>
        </div>
    `;

    const container = document.getElementById('diff-list-container');
    if (container) {
        container.insertAdjacentHTML('beforeend', html);
    }
}

/** ğŸ› ï¸ å…¨é¸/å–æ¶ˆè¼”åŠ©å‡½å¼ (å¼·åŒ–ç‰ˆ) */
function toggleAllDiffs(selected) {
    // 1. åŒæ­¥æ›´æ–°è¨˜æ†¶é«”ä¸­çš„æ•¸æ“šç‹€æ…‹ (æ ¸å¿ƒé‚è¼¯)
    if (Array.isArray(pendingMergeData)) {
        pendingMergeData.forEach(d => d.selected = selected);
    }

    // 2. æ‰¹æ¬¡æ›´æ–° UI ä¸Šçš„ Checkbox ç‹€æ…‹
    // ğŸŒŸ å„ªåŒ–ï¼šä½¿ç”¨æ›´ç²¾æº–çš„ class é¸æ“‡å™¨ï¼Œä¸¦è§¸ç™¼ change äº‹ä»¶ç¢ºä¿é‚è¼¯è¯å‹•
    const checkboxes = document.querySelectorAll('.diff-item-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selected;
    });

    // 3. è§¸ç™¼å°æç¤º
    const count = pendingMergeData.length;
    if (count > 0) {
        showMessage(`å·²${selected ? 'é¸å–' : 'å–æ¶ˆ'}å…¨éƒ¨ ${count} é …è®Šå‹•`, 'info');
    }
}

function updateDiffSelection(diffId, isChecked) {
    const item = pendingMergeData.find(d => d.id === diffId);
    if (item) {
        item.selected = isChecked;
        
        // é¡å¤–åŠ å¼·ï¼šè‡ªå‹•æª¢æ ¸å…¨é¸ç‹€æ…‹
        const allChecked = pendingMergeData.every(d => d.selected);
        const masterCheckbox = document.getElementById('master-diff-checkbox'); 
        if (masterCheckbox) masterCheckbox.checked = allChecked;
        
        console.log(`[Diff Engine] é …ç›® ${diffId} -> ${isChecked ? 'ä¿ç•™' : 'ç•¥é'}`);
    }
}
        
/** * ğŸ—ºï¸ æ•´åˆç‰ˆï¼šæ™ºæ…§è¾¨è­˜é—œéµåœ°æ¨™è© + çµ‚æ¥µç‰¹æ®Šç¬¦è™Ÿé˜²è­· (2026 çµ‚æ¥µä¿®æ­£ç‰ˆ)
 * ç¢ºä¿åœ¨ PC/å¹³æ¿/æ‰‹æ©Ÿ éƒ½èƒ½ 100% å–šèµ· Google Maps App
 */
function getSmartMapLink(schedule, day) {
    // ç¢ºä¿ day.city å­˜åœ¨ä¸”ç‚ºé™£åˆ—ï¼Œå–ç¬¬ä¸€ä½ä½œç‚ºæœå°‹åŸºæº–åŸå¸‚
    const tripCity = (day && day.city && Array.isArray(day.city)) ? day.city[0] : (day?.city || "");
    const rawName = schedule.name || "";

    // 1. è¨˜æ†¶é—œéµåœ°æ¨™å¾Œç¶´ (ä¿ç•™è·äººç²¾ç¥ï¼Œé¿å…è¢«æ¸…æ´—æ‰)
    const importantSuffixes = ["ç¸½åº—", "ç¸½æœ¬åº—", "æœ¬åº—", "é§…", "è»Šç«™", "æ”¯åº—"];
    const foundSuffix = importantSuffixes.find(suffix => rawName.includes(suffix));

    // 2. çµ‚æ¥µæ¸…æ´—æµç¨‹ï¼šç§»é™¤æ‹¬è™Ÿå…§å®¹ã€ç‰¹æ®Šç¬¦è™Ÿï¼Œåªç•™ä¸‹ç´”æ·¨åœ°å
    let cleanName = rawName
        .replace(/(\(.*?\)|ï¼ˆ.*?ï¼‰|\[.*?\]|ã€.*?ã€‘)/g, '') // ç§»é™¤æ‰€æœ‰æ‹¬è™ŸåŠå…¶å…§å®¹
        .replace(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?*#]/g, ' ') // å°‡ç‰¹æ®Šç¬¦è™Ÿè½‰ç‚ºç©ºæ ¼
        .replace(/\s+/g, ' ') // ç¸®æ¸›é€£çºŒç©ºæ ¼
        .trim();

    // 3. æ™ºæ…§è£œå›åœ°æ¨™å±¬æ€§
    if (foundSuffix && !cleanName.includes(foundSuffix)) {
        cleanName += ` ${foundSuffix}`;
    }

    // 4. æ¥µçŸ­åç¨±é˜²ç¦¦ (é˜²æ­¢æ¸…æ´—å¾Œåªå‰©ä¸€å€‹å­—æœå°‹ä¸åˆ°)
    if (cleanName.length < 2) {
        cleanName = rawName.replace(/[*#ã€ã€‘[\]()]/g, '').trim();
    }

    // 5. çµ„è£æœå°‹å­—ä¸²ï¼šå„ªå…ˆä½¿ç”¨åœ°å€ï¼Œç„¡åœ°å€å‰‡ç”¨åœ°å+åŸå¸‚
    let searchQuery = (schedule.address && schedule.address.trim().length > 0) 
        ? schedule.address 
        : `${cleanName} ${tripCity}`;

    // 6. âœ¨ ä¿®æ­£é‡é»ï¼šä½¿ç”¨ Google å®˜æ–¹ Universal Links (https://www.google.com/maps/search/?api=1&...)
    // æ­¤æ ¼å¼åœ¨ç§»å‹•è£ç½®æœƒè‡ªå‹•åµæ¸¬ä¸¦é–‹å•Ÿ Google Maps Appï¼Œä¸”å®Œå…¨å…è²»
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
}




// ç¿»è­¯ç›¸é—œæ¨¡çµ„èµ·é»

/** ğŸ’¾ å°‡ç¿»è­¯å­˜å…¥ IndexedDB (v5.2 ç‰©ç†åŒæ­¥ç‰ˆ)
 * ä½œç”¨ï¼šå¯«å…¥å°ˆå±¬ç‰©ç†åˆ†é ï¼Œä¸¦åŒæ­¥è‡³å…¨åŸŸ state èˆ‡ä¸»å¿«ç…§
 */
async function saveTranslationToVault(data) {
    if (!data) return;
    
    const entry = {
        id: 'trans-' + generateUUID(),
        ...data,
        timestamp: Date.now()
    };

    try {
        // ğŸŒŸ 1. ç‰©ç†å¯«å…¥ï¼šé–å®šå°ˆå±¬åˆ†é  translations_store
        await dbManager.save('translations_store', entry);
        
        // ğŸŒŸ 2. è¨˜æ†¶é«”åŒæ­¥ï¼šæ›´æ–°é‹è¡Œä¸­çš„ç‹€æ…‹
        if (!state.translationVault) state.translationVault = [];
        state.translationVault.push(entry);
        
        // ğŸŒŸ 3. å¿«ç…§åŒæ­¥ï¼šå‘¼å« saveData(true) ç¢ºä¿ main_state åŒ…å«æ­¤æ–°æ•¸æ“š
        if (typeof saveData === 'function') {
            await saveData(true);
        }

        // ğŸŒŸ 4. UI é‡ç¹ª
        if (typeof renderTranslationVault === 'function') {
            renderTranslationVault(); 
        }
        
        showMessage('âœ… ç¿»è­¯å·²é–å…¥æ°¸ä¹…æ”¶è—åŒ£', 'success');
        console.log(`ğŸ—£ï¸ [Vault-Add] å·²åŒæ­¥ç¿»è­¯: ${entry.ja}`);

    } catch (e) {
        console.error("âŒ æ”¶è—ç¿»è­¯å¤±æ•—:", e);
        showMessage('æ”¶è—å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹', 'error');
    }
}

/** ğŸ§¹ ç¿»è­¯å°ˆå±¬åº«ï¼šå¾¹åº•ç‰©ç†æ¸…å ´ (v1.0.0)
 * ä½œç”¨ï¼šä¸€éµæŠ¹é™¤ translations_store ç£å€ï¼Œè§£æ±ºé‡æ•´å¾ŒèˆŠç¿»è­¯å½ˆå›çš„å•é¡Œã€‚
 */
async function clearTranslationVault() {
    if (!confirm("ğŸš¨ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—çš„ç¿»è­¯å—ï¼Ÿæ­¤å‹•ä½œå°‡æ°¸ä¹…åˆªé™¤ç‰©ç†ç£å€æ•¸æ“šã€‚")) return;
    
    // ğŸ›¡ï¸ 1. å•Ÿå‹•åŸå­é–
    window.isTransportUpdating = true; 

    try {
        // 2. ç›´æ¥æ“Šç©¿åˆ†é æ¸…ç©º IndexedDB
        await dbManager.clear('translations_store');
        
        // 3. åŒæ­¥è¨˜æ†¶é«”
        state.translationVault = [];
        
        // 4. å¼·åˆ¶åŸ·è¡Œå¿«ç…§åŒæ­¥
        await saveData(true);
        
        // 5. UI é‡ç¹ª
        if (typeof renderTranslationVault === 'function') renderTranslationVault();
        
        showMessage("ğŸ§¹ ç¿»è­¯å°ˆå±¬åº«å·²å¾¹åº•æ¸…ç©º", "info");
    } catch (e) {
        console.error("æ¸…ç©ºå¤±æ•—:", e);
        showMessage("æ¸…ç©ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£çµ", "error");
    } finally {
        window.isTransportUpdating = false;
    }
}

/** ğŸ—£ï¸ é»æ“Šã€ŒèªéŸ³å›é¥‹ã€æŒ‰éˆ•æ™‚èª¿ç”¨ (v5.2)
 * ä½œç”¨ï¼šå°‡è¼¸å…¥æ–‡å­—é€é AI ç¿»è­¯å¾Œç›´æ¥ç”±èªéŸ³å¼•æ“æ’­æ”¾
 */
async function playCurrentTranslation() {
    const inputEl = document.getElementById('translate-input');
    const input = inputEl ? inputEl.value.trim() : "";
    
    if (!input) {
        showMessage('è«‹å…ˆè¼¸å…¥è¦ç™¼éŸ³çš„æ–‡å­—', 'info');
        return;
    }
    
    if (!state.theme.geminiKey) {
        showMessage('è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­è¼¸å…¥ Gemini API Keyï¼', 'error');
        return;
    }

    try {
        // 1. UI åé¥‹ï¼šé¡¯ç¤ºèªéŸ³ç”Ÿæˆç‹€æ…‹
        const audioPlaceholder = document.getElementById('audio-placeholder');
        if (audioPlaceholder) audioPlaceholder.innerHTML = '<div class="animate-pulse text-xs text-pink-500 font-bold">ğŸ§ æ­£åœ¨é€é AI æ¨¡æ“¬æ—¥æ–‡ç™¼éŸ³...</div>';

        // æ­¥é©Ÿ 1: è«‹æ±‚ Gemini ç¿»è­¯æˆæ—¥æ–‡ (å…§éƒ¨è¼”åŠ©å‡½æ•¸)
        const targetText = await translateToJapaneseForTTS(input);
        
        if (targetText && targetText !== 'ç¿»è­¯å¤±æ•—') {
            // æ­¥é©Ÿ 2: æ’­æ”¾æ—¥æ–‡èªéŸ³ (ç‰©ç†èªéŸ³å¼•æ“)
            // ä½¿ç”¨ 'Puck' æˆ– 'Kore' èªéŸ³ï¼Œè¦–æ‚¨çš„ playAudio å¯¦ä½œè€Œå®š
            await playAudio(targetText, 'Puck'); 
            console.log(`ğŸ”Š [TTS-Success] æ­£åœ¨æ’­æ”¾: ${targetText}`);
        } else {
            throw new Error("AI ç¿»è­¯å›å‚³ç„¡æ•ˆ");
        }
    } catch (e) {
        console.error("âŒ èªéŸ³å›é¥‹å´©æ½°:", e);
        showMessage('èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        const placeholder = document.getElementById('audio-placeholder');
        if (placeholder) placeholder.innerHTML = '';
    }
}
        
        /**
         * è¼”åŠ©å‡½æ•¸: ç¿»è­¯è¼¸å…¥æ–‡å­—åˆ°æ—¥æ–‡ (å°ˆä¾› TTS ä½¿ç”¨)
         */
        async function translateToJapaneseForTTS(text) {
             const apiKey = state.theme.geminiKey;
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             
             const prompt = `Translate only the following text directly into Japanese (without any other commentary or surrounding characters). Text: "${text}"`;

             const payload = {
                 contents: [{ parts: [{ text: prompt }] }],
                 systemInstruction: {
                     parts: [{ text: "ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç¿»è­¯å®˜ï¼Œåªå›ç­”ç¿»è­¯çµæœï¼Œä¸¦ä½¿ç”¨æ—¥æ–‡ã€‚å¦‚æœåŸæ–‡æ˜¯æ—¥æ–‡ï¼Œå‰‡ç›´æ¥è¿”å›åŸæ–‡ã€‚" }]
                 },
             };
             
             try {
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });
                 const result = await response.json();
                 return result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || "ç¿»è­¯å¤±æ•—";
             } catch (error) {
                 console.error("æ—¥æ–‡ç¿»è­¯ API éŒ¯èª¤:", error);
                 return "ç¿»è­¯å¤±æ•—";
             }
        }


/** å°ˆæ¥­ç‰ˆç¿»è­¯ï¼šæ”¯æ´ AI åˆ†é¡èˆ‡æ°¸ä¹…æ”¶è— (v5.3.0)
 * ä¿®æ­£ï¼šå‡ç´š Gemini 2.0 å¼•æ“ï¼Œä¸¦å„ªåŒ–æ”¶è—æŒ‰éˆ•çš„è³‡æ–™å‚³éå®‰å…¨æ€§
 */
async function executeTranslate() {
    const inputEl = document.getElementById('translate-input');
    const input = inputEl ? inputEl.value.trim() : "";
    const output = document.getElementById('translate-output');
    
    if (!input || !state.theme.geminiKey) {
        showMessage('è«‹è¼¸å…¥æ–‡å­—ä¸¦ç¢ºä¿ API Key å·²è¨­å®š', 'error');
        return;
    }

    output.innerHTML = `
        <div class="flex items-center gap-2 animate-pulse text-pink-500">
            <div class="w-2 h-2 bg-pink-500 rounded-full"></div>
            <span class="text-sm font-bold">æ­£åœ¨ç²¾æº–ç¿»è­¯ä¸¦åˆ†æèªå¢ƒ...</span>
        </div>`;

    const apiKey = state.theme.geminiKey;
    // ğŸš€ å‡ç´šï¼šé–å®š 2.0 Flash å¼•æ“é”æˆæ¥µé€Ÿå›æ‡‰
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æœ¬æ–‡åŒ–çš„å°ˆæ¥­æ—…éŠå°è¦½ã€‚è«‹å°‡ã€Œ${input}ã€ç²¾æº–è­¯æˆæ—¥æ–‡ã€‚
    è«‹è€ƒæ…®æ—…éŠæƒ…å¢ƒï¼Œæä¾›æœ€è‡ªç„¶çš„ç”¨æ³•ï¼Œä¸¦åš´æ ¼å›å‚³ä»¥ä¸‹ JSON æ ¼å¼ï¼š
    {
      "zh": "${input}",
      "ja": "æ—¥æ–‡ç¿»è­¯çµæœ",
      "romaji": "ç¾…é¦¬æ‹¼éŸ³",
      "tip": "æ–‡åŒ–ã€ç¦®å„€æˆ–ç™¼éŸ³æé†’",
      "category": "åˆ†é¡(äº¤é€š/ç”¨é¤/ä½å®¿/è³¼ç‰©/ä¸€èˆ¬)"
    }`;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });

        if (!response.ok) throw new Error(`API éŒ¯èª¤: ${response.status}`);

        const result = await response.json();
        // ğŸŒŸ çµ±è¨ˆè²»ç”¨
        if (result.usageMetadata) trackApiUsage(result.usageMetadata, 'flash');

        const data = JSON.parse(result.candidates[0].content.parts[0].text);

        // ğŸ›¡ï¸ å®‰å…¨åŒ–è™•ç†ï¼šé˜²æ­¢ JSON å…§çš„å¼•è™Ÿç ´å£ HTML onclick èªæ³•
        // æˆ‘å€‘å°‡æ•¸æ“šå…ˆå­˜å…¥ window æš«å­˜å€ï¼Œè®“æŒ‰éˆ•å»é‚£è£¡é ˜è³‡æ–™
        window.lastTranslationResult = data;

        // æ¸²æŸ“çµæœ UI
        output.innerHTML = `
            <div class="space-y-3 animate-in fade-in slide-in-from-top-1">
                <div class="p-3 bg-white rounded-xl border border-pink-100 shadow-sm">
                    <p class="text-xs text-gray-400 mb-1">æ—¥æ–‡ (Japanese)</p>
                    <p class="text-xl font-black theme-text-pink leading-tight">${data.ja}</p>
                    <p class="text-[11px] text-gray-500 font-mono mt-1">${data.romaji}</p>
                </div>
                
                <div class="p-3 bg-blue-50/50 rounded-xl border border-blue-100">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Tactical Tip</p>
                    <p class="text-[13px] text-blue-700 leading-relaxed">ğŸ’¡ ${data.tip}</p>
                </div>

                <button onclick="saveTranslationToVault(window.lastTranslationResult)" 
                        class="w-full py-3 theme-bg theme-text-white rounded-2xl font-black text-xs shadow-lg shadow-pink-100 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>ğŸ“‚</span> æ”¶è—è‡³ç¿»è­¯å°ˆå±¬åº« (Vault)
                </button>
            </div>`;

    } catch (e) {
        console.error("ç¿»è­¯å¼•æ“ç™¼ç”Ÿç•°å¸¸:", e);
        output.innerHTML = `<p class="text-sm text-red-500 font-bold">âŒ ç¿»è­¯å¤±æ•—ï¼š${e.message}</p>`;
    }
}



        /**
         * å¯¦ä½œèªéŸ³è¼¸å…¥åŠŸèƒ½ï¼ˆä½¿ç”¨ Web Speech APIï¼‰
         */
        function startVoiceInput() {
            const audioPlaceholder = document.getElementById('audio-placeholder');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                showMessage('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ APIï¼Œè«‹ä½¿ç”¨ Chrome ç€è¦½å™¨ã€‚', 'error');
                if (audioPlaceholder) audioPlaceholder.innerHTML = '';
                return;
            }

            // ç¢ºä¿åœæ­¢ä»»ä½•æ­£åœ¨é€²è¡Œçš„è¾¨è­˜
            if (window.speechRecognizer) {
                window.speechRecognizer.stop();
            }

            const recognition = new SpeechRecognition();
            window.speechRecognizer = recognition; 
            
            recognition.lang = 'zh-TW'; // ç›®æ¨™è¾¨è­˜èªè¨€ç‚ºä¸­æ–‡
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.continuous = false;

            if (audioPlaceholder) audioPlaceholder.innerHTML = '<div class="text-sm font-semibold text-pink-600">ğŸ¤ æ­£åœ¨è†è½ï¼Œè«‹èªªè©±...</div>';

            try {
                recognition.start();
            } catch (e) {
                // è™•ç†é€£çºŒé»æ“Š start çš„éŒ¯èª¤
                console.error("Recognition start error:", e);
                if (audioPlaceholder) audioPlaceholder.innerHTML = '';
                showMessage('èªéŸ³åŠŸèƒ½å•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é‡æ–°æ•´ç†ã€‚', 'error');
                return;
            }


            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('translate-input').value = transcript;
                simulateTranslate(); // è§¸ç™¼ç¿»è­¯
                showMessage('èªéŸ³è¼¸å…¥å·²è½‰éŒ„ï¼Œæ­£åœ¨ç¿»è­¯...', 'info');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error === 'no-speech') {
                    showMessage('æœªåµæ¸¬åˆ°èªéŸ³ï¼Œè«‹é‡è©¦ã€‚', 'error');
                } else if (event.error === 'not-allowed') {
                    showMessage('è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™ã€‚', 'error');
                } else {
                    showMessage(`èªéŸ³è¾¨è­˜éŒ¯èª¤: ${event.error}`, 'error');
                }
                if (audioPlaceholder) audioPlaceholder.innerHTML = '';
            };

            recognition.onend = () => {
                if (audioPlaceholder) audioPlaceholder.innerHTML = '';
            };
        }


        // è¼”åŠ©å‡½æ•¸ï¼šè™•ç†åœ–ç‰‡ä¸Šå‚³
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     const base64Image = e.target.result.split(',')[1];
                     const mimeType = file.type;
                     analyzeImageForTranslation(base64Image, mimeType);
                 };
                 reader.readAsDataURL(file);
            }
        }
        
        // è¼”åŠ©å‡½æ•¸ï¼šåŸ·è¡Œåœ–ç‰‡ç¿»è­¯
        async function analyzeImageForTranslation(base64Image, mimeType) {
            const output = document.getElementById('translate-output');
            if (!state.theme.geminiKey) {
                 output.textContent = 'è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­è¼¸å…¥ Gemini API Keyï¼';
                 return;
            }
            output.textContent = 'ğŸ“¸ æ­£åœ¨åˆ†æåœ–ç‰‡ä¸­çš„æ–‡å­—ä¸¦é€²è¡Œç¿»è­¯...';

            const apiKey = state.theme.geminiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const prompt = "è«‹ä»”ç´°è®€å–åœ–ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œç„¶å¾Œå°‡é€™äº›æ–‡å­—ç¿»è­¯æˆæµæš¢çš„ç¹é«”ä¸­æ–‡ã€‚è¼¸å‡ºæ ¼å¼ç‚ºï¼š\n---åŸæ–‡---\n[åœ–ç‰‡ä¸­åµæ¸¬åˆ°çš„æ–‡å­—]\n---ä¸­æ–‡ç¿»è­¯---\n[ç¹é«”ä¸­æ–‡ç¿»è­¯çµæœ]";

            const payload = {
                contents: [{ 
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
            };

            try {
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });
                 const result = await response.json();
                 const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "åœ–ç‰‡ç¿»è­¯å¤±æ•—ã€‚";
                 output.textContent = text.trim();
                 showMessage('åœ–ç‰‡ç¿»è­¯å®Œæˆï¼', 'success');
            } catch (error) {
                console.error("åœ–ç‰‡ç¿»è­¯ API éŒ¯èª¤:", error);
                output.textContent = 'åœ–ç‰‡ç¿»è­¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–åœ–ç‰‡æ ¼å¼ã€‚';
                showMessage('åœ–ç‰‡ç¿»è­¯å¤±æ•—', 'error');
            }
        }

        /**
         * æ¸²æŸ“å–®ç´”çš„æ—…å®¢å•è©±æ¸…å–®
         * @param {object[]} dialogueArray - åŒ…å« zh, ja_raw, ja_display, romaji çš„é™£åˆ—
         */
        function renderDialogueList(dialogueArray) {
            const outputContainer = document.getElementById('dialogue-output');
            
            let dialogueHtml = dialogueArray.map((line, index) => {
                
                // Speaker icon (using SVG for size/color control)
                const playButton = `<button class="text-lg text-pink-600 hover:text-pink-800 transition p-1" onclick="playAudio('${line.ja_raw}', 'Kore')" title="æ’­æ”¾æ—¥èª">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-current" viewBox="0 0 24 24"><path d="M3 10v4h4l5 5V5l-5 5H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                          </button>`;

                return `
                    <div class="p-4 bg-white rounded-xl shadow-md border-l-4 border-pink-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-500">ä¸­æ–‡ (Chinese)</p>
                                <p class="text-lg font-bold text-gray-800 mb-2">${index + 1}. ${line.zh}</p>
                                
                                <p class="text-sm text-gray-500">æ—¥èª (Japanese)</p>
                                <p class="text-base font-semibold text-gray-700">${line.ja_display}</p>
                                
                                <p class="text-sm text-gray-500 mt-2">ç¾…é¦¬æ‹¼éŸ³ (Romaji)</p>
                                <p class="text-xs text-gray-600">${line.romaji}</p>
                            </div>
                            <div class="ml-4 flex-shrink-0">
                                ${playButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            outputContainer.innerHTML = `<div class="space-y-3 mt-4">${dialogueHtml}</div>`;
        }

        /**
         * æƒ…å¢ƒå°è©±ç”Ÿæˆ (åªç”Ÿæˆæ—…å®¢å•è©±ç¯„ä¾‹)
         */
        async function generateDialogue() {
            const keyword = document.getElementById('keyword-input').value.trim();
            const outputContainer = document.getElementById('dialogue-output');
            
            if (!keyword) {
                showMessage('è«‹è¼¸å…¥å°è©±æƒ…å¢ƒé—œéµå­—', 'info');
                return;
            }
            if (!state.theme.geminiKey) {
                outputContainer.innerHTML = '<p class="text-sm text-red-500">è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­è¼¸å…¥ Gemini API Keyï¼</p>';
                 return;
            }
            
            outputContainer.innerHTML = '<div class="text-center"><div class="animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-pink-500 border-opacity-20 border-t-pink-500 mb-2 mx-auto"></div><p class="text-gray-600 text-sm">æ­£åœ¨ç”Ÿæˆå•è©±ç¯„ä¾‹...</p></div>';
            
            const apiKey = state.theme.geminiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // è«‹æ±‚ç”Ÿæˆ 10 å¥æ—…å®¢å•è©±ç¯„ä¾‹ (JSON çµæ§‹) - UPDATED PROMPT to fix æ°´ç‚Šé‹ issue
            const prompt = `ç”Ÿæˆ 10 å¥èˆ‡æ—…éŠæƒ…å¢ƒã€Œ${keyword}ã€ç›¸é—œï¼Œä¸”é©åˆã€Œæ—…å®¢ã€ä½¿ç”¨çš„**ç¹é«”ä¸­æ–‡**å•è©±ç¯„ä¾‹æˆ–å¸¸ç”¨èªã€‚
è«‹ç‚ºæ¯ä¸€å¥ç”Ÿæˆä»¥ä¸‹æ¬„ä½ï¼Œä¸¦ç¢ºä¿æ—¥èªç¿»è­¯ï¼ˆja_raw, ja_displayï¼‰å’Œç¾…é¦¬æ‹¼éŸ³ï¼ˆromajiï¼‰çš„æº–ç¢ºæ€§ï¼š
1. **zh**: ç¹é«”ä¸­æ–‡å•å¥ã€‚
2. **ja_raw**: å®Œæ•´çš„æ—¥èªå•å¥ï¼ˆç”¨æ–¼TTSæ’­æ”¾ï¼Œä¸å«<ruby>æ¨™ç±¤ï¼‰ã€‚
3. **ja_display**: åŒ…å«ç¾…é¦¬æ‹¼éŸ³ï¼ˆRomajiï¼‰å’Œä½¿ç”¨ <ruby> æ¨™ç±¤æ¨™è¨»å¹³å‡åï¼ˆFuriganaï¼‰çš„æ—¥èªé¡¯ç¤ºæ ¼å¼ï¼Œä¾‹å¦‚ï¼š<ruby>æ°´ç‚Š<rt>ã¿ãšãŸã</rt></ruby>ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
4. **romaji**: è©²å¥çš„ç¾…é¦¬æ‹¼éŸ³ã€‚

**è«‹åš´æ ¼è¼¸å‡º JSON çµæ§‹ï¼Œä¸”é™£åˆ—ä¸­å¿…é ˆæœ‰ 10 å€‹ç‰©ä»¶ï¼š**
{
  "questions": [
    { "zh": "...", "ja_raw": "...", "ja_display": "...", "romaji": "..." },
    // ... 9 more objects
  ]
}
è«‹å‹¿åœ¨ JSON ä»¥å¤–çš„ä»»ä½•åœ°æ–¹è¼¸å‡ºå…¶ä»–æ–‡å­—ã€‚`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    "questions": { 
                        "type": "ARRAY",
                        "items": { 
                            "type": "OBJECT",
                            "properties": {
                                "zh": { "type": "STRING" },
                                "ja_raw": { "type": "STRING" },
                                "ja_display": { "type": "STRING" },
                                "romaji": { "type": "STRING" }
                            },
                            "required": ["zh", "ja_raw", "ja_display", "romaji"]
                        }
                    }
                },
                required: ["questions"]
            };
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                },
                systemInstruction: {
                    parts: [{ text: "ä½ æ˜¯ä¸€ä½æ—…éŠå°è©±å°ˆå®¶ï¼Œåªè¿”å›ä¸€å€‹åŒ…å« 10 å€‹å•è©±ç‰©ä»¶çš„ JSON å°è±¡ï¼Œä¸¦åš´æ ¼éµå¾ª<ruby>æ¨™ç±¤æ ¼å¼ã€‚å°æ–¼æ—¥èªè©å½™ï¼Œç¢ºä¿ç¾…é¦¬æ‹¼éŸ³ã€åŸå¥å’ŒæŒ¯å‡åï¼ˆFuriganaï¼‰çš„å°æ‡‰å’Œæº–ç¢ºæ€§ã€‚" }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                // ä½¿ç”¨å®‰å…¨è§£æå‡½æ•¸
                const aiResult = safeJsonParse(jsonText);
                const questions = aiResult.questions;

                if (!Array.isArray(questions) || questions.length !== 10) throw new Error("AI æ²’æœ‰è¿”å›æœ‰æ•ˆçš„ 10 å¥å•é¡Œåˆ—è¡¨ã€‚");

                renderDialogueList(questions);
                showMessage('å•è©±ç¯„ä¾‹ç”ŸæˆæˆåŠŸï¼', 'success');

            } catch (error) {
                console.error("ç”Ÿæˆå°è©± API éŒ¯èª¤:", error);
                outputContainer.innerHTML = `<p class="text-sm text-red-500">å°è©±ç”Ÿæˆå¤±æ•—ï¼š${error.message}ï¼Œè«‹æª¢æŸ¥ API Key æˆ–é‡è©¦ã€‚</p>`;
            }
        }
        
        /** Helper functions for PCM to WAV conversion (Copied structure) */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // Function to convert raw PCM to WAV Blob
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // Write WAV header
            const writeString = (offset, s) => {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset + i, s.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF'); // Chunk ID
            view.setUint32(4, 36 + pcm16.length * 2, true); // Chunk Size
            writeString(8, 'WAVE'); // Format
            view.setUint32(12, 16, true); // Subchunk 1 ID
            view.setUint32(16, 16, true); // Subchunk 1 Size (16 for PCM)
            view.setUint16(20, 1, true); // Audio Format (1 for PCM)
            view.setUint16(22, 1, true); // Num Channels
            view.setUint32(24, sampleRate, true); // Sample Rate
            view.setUint32(28, sampleRate * 2, true); // Byte Rate
            view.setUint16(32, 2, true); // Block Align (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // Bits Per Sample

            writeString(36, 'data'); // Subchunk 2 ID
            view.setUint32(40, pcm16.length * 2, true); // Subchunk 2 Size

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        };
        
        /**
         * æ’­æ”¾ TTS éŸ³é » (TTS API å¯¦ä½œ)
         * @param {string} text - è¦æ’­æ”¾çš„æ–‡æœ¬
         * @param {string} voice - TTS èªéŸ³åç¨± (ä¾‹å¦‚ 'Kore')
         */
        async function playAudio(text, voice = 'Kore') {
            if (!state.theme.geminiKey) {
                 showMessage('è«‹å…ˆè¼¸å…¥ Gemini API Key', 'error');
                 return;
            }
            
            // ç”±æ–¼ 429 éŒ¯èª¤é »ç¹ï¼Œæ’­æ”¾å‰åŠ è¼‰ loading ç‹€æ…‹
            const loadingHtml = '<div class="animate-pulse text-sm text-gray-500">ğŸ§ æ­£åœ¨ç”ŸæˆéŸ³é »...</div>';
            const audioPlaceholder = document.getElementById('audio-placeholder');
            if (audioPlaceholder) audioPlaceholder.innerHTML = loadingHtml;

            const apiKey = state.theme.geminiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // ç¢ºä¿åªå‚³éè¦ç™¼éŸ³çš„æ–‡æœ¬ï¼Œä¸¦è«‹æ±‚ TTS èªéŸ³
            const ttsPrompt = `Say the following text: "${text}"`;

            const payload = {
                contents: [{ parts: [{ text: ttsPrompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voice }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                attempts++;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         if ((response.status === 503 || response.status === 429) && attempts < maxAttempts) {
                              await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempts) * 1000));
                              continue; 
                         } else {
                            throw new Error(`TTS API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                         }
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const match = mimeType.match(/rate=(\d+)/);
                        const sampleRate = match ? parseInt(match[1], 10) : 24000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        const audioEl = new Audio(audioUrl);
                        
                        // æ’­æ”¾éŸ³é »ï¼Œä¸¦åœ¨æ’­æ”¾çµæŸå¾Œæ¸…ç† URL
                        audioEl.play().catch(e => {
                            console.error("Audio playback failed:", e);
                            showMessage("éŸ³é »æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨é™åˆ¶", "error");
                        });
                        
                        audioEl.onended = () => {
                             URL.revokeObjectURL(audioUrl);
                             if (audioPlaceholder) audioPlaceholder.innerHTML = '';
                        };
                        return;

                    } else {
                        throw new Error("TTS API å›æ‡‰ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é »è³‡æ–™");
                    }
                } catch (e) {
                    console.error("TTS éŒ¯èª¤:", e);
                    if (attempts === maxAttempts) {
                        showMessage(`éŸ³é »ç”Ÿæˆæœ€çµ‚å¤±æ•—: ${e.message}`, 'error');
                        if (audioPlaceholder) audioPlaceholder.innerHTML = '';
                    }
                }
            }
        }






/** ğŸ†˜ ç·Šæ€¥æ•‘è­·èˆ‡è³‡æ´æ¨¡çµ„ **/

/** ğŸš¨ æ¸²æŸ“ç·Šæ€¥é  (v5.5 ä½ˆå±€æ ¡æº–èˆ‡å·¥å…·ç®±ä¸¦åˆ—ç‰ˆ) 
 * ä¿®æ­£ï¼š
 * 1. å·¥å…·ç®±ä½ˆå±€å„ªåŒ–ï¼šAI æœå°‹èˆ‡ JSON æ³¨å…¥æ¡†å·¦å³ä¸¦åˆ—ã€‚
 * 2. å¾¹åº•è§£æ±ºå°èˆªåˆ—å †ç–Šï¼šå¼•å…¥ flex-shrink-0 èˆ‡ å¯¬åº¦é–å®šã€‚
 */
function renderEmergencyView() {
    const container = document.getElementById('emergency-view');
    if (!container) return;

    // ğŸŒŸ Step 1. å®šç¾©æ¨™ç±¤åˆ†é¡
    const categories = [
        { id: 'medical', name: 'é†«ç™‚æ•‘æ´', icon: 'ğŸ¥' },
        { id: 'consulate', name: 'é ˜äº‹è­·ç…§', icon: 'ğŸ‡¹ğŸ‡¼' },
        { id: 'insurance', name: 'ç†è³ é˜²ç¦¦', icon: 'ğŸ›¡ï¸' }
    ];

    if (!window.activeEmergencyCat) window.activeEmergencyCat = 'medical';

    // ğŸŒŸ Step 2. æ§‹å»ºç‰©ç†å°ä½æ¨™ç±¤ (è§£æ±ºå †ç–Šå•é¡Œ)
    let tabsHtml = categories.map(cat => {
        const isActive = window.activeEmergencyCat === cat.id;
        return `
            <div class="flex-shrink-0">
                <button onclick="setEmergencyCat('${cat.id}')" 
                        class="flex items-center gap-2 px-5 py-2.5 rounded-2xl border-2 transition-all active:scale-95 ${
                            isActive 
                            ? 'bg-red-500 text-white border-transparent shadow-lg scale-105 font-black' 
                            : 'bg-white text-slate-500 border-slate-100 hover:border-red-200 shadow-sm'
                        }">
                    <span class="text-sm">${cat.icon}</span>
                    <span class="text-xs whitespace-nowrap">${cat.name}</span>
                </button>
            </div>`;
    }).join('');

    // ğŸŒŸ Step 3. æº–å‚™å­é é¢å…§å®¹
    let contentHtml = "";
    if (window.activeEmergencyCat === 'medical') {
        contentHtml = `
            <div class="animate-in fade-in">
                <h4 class="text-sm font-black text-gray-700 border-l-4 border-emerald-500 pl-3 mb-4 uppercase tracking-widest font-black">ğŸ¥ é„°è¿‘ä¸­æ–‡é†«ç™‚è³‡æº</h4>
                <div id="medical-list" class="space-y-4 min-h-[100px]"></div>
            </div>`;
    } else if (window.activeEmergencyCat === 'consulate') {
        contentHtml = renderConsulateSOP();
    } else if (window.activeEmergencyCat === 'insurance') {
        contentHtml = renderInsuranceModule();
    }

    // ğŸŒŸ Step 4. å…¨å±€æ¸²æŸ“ (åŒ…å«å·¥å…·ç®±ä¸¦åˆ—è¨­è¨ˆ)
    container.innerHTML = `
        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl w-full border-t-8 border-red-500 animate-in slide-in-from-bottom-4 duration-500">
            <h3 class="text-xl font-black text-red-600 mb-6 flex items-center gap-2 font-black">
                <span class="animate-pulse">ğŸš¨</span> ç·Šæ€¥æ‡‰è®Šæˆ°æƒ…å®¤
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="p-5 rounded-[2rem] bg-slate-50 border border-slate-100 flex flex-col shadow-inner">
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest font-black">ğŸš€ æ•‘è­·ç‡ƒæ–™æ³¨å…¥</h4>
                        <button onclick="copyEmergencyAIPrompt()" class="text-[9px] font-black theme-text-pink bg-white px-2 py-1 rounded-md shadow-sm">ğŸ§  æŒ‡ä»¤</button>
                    </div>
                    <textarea id="emergency-fuel-input" class="w-full flex-grow p-3 text-[10px] font-mono bg-white border border-slate-200 rounded-2xl outline-none min-h-[80px] mb-2" placeholder="è²¼ä¸Š JSON..."></textarea>
                    <button onclick="processEmergencyFuel()" class="w-full py-2.5 bg-red-500 text-white rounded-xl font-black text-xs shadow-md active:scale-95 transition-all">åŸ·è¡ŒåŒæ­¥</button>
                </div>

                <div class="p-5 rounded-[2.5rem] bg-blue-50 border border-blue-100 flex flex-col justify-between shadow-inner">
                    <div class="flex flex-col gap-2">
                         <h4 class="text-[10px] font-black text-blue-400 uppercase tracking-widest font-black px-1 mb-2">ğŸ¤– æ™ºæ…§æ•‘æ´å·¥å…·</h4>
                         <input type="text" id="ai-emergency-city-input" class="w-full p-3 text-xs bg-white border border-blue-200 rounded-2xl outline-none" placeholder="è¼¸å…¥æœå°‹åŸå¸‚...">
                    </div>
                    <div id="ai-emergency-status" class="py-2"></div>
                    <button onclick="triggerAIEmergencySearch()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all">å•Ÿå‹• AI æ™ºæ…§æœæ•‘</button>
                    <p class="text-[10px] text-blue-500 text-center mt-3 font-bold italic">æƒæ 24H æ€¥è¨ºèˆ‡ä¸­æ–‡é†«é™¢</p>
                </div>
            </div>

            <div class="w-full relative my-6 py-2 border-y border-slate-50 overflow-hidden">
                <div class="flex items-center gap-4 overflow-x-auto no-scrollbar scroll-smooth px-2 py-2" style="-webkit-overflow-scrolling: touch;">
                    ${tabsHtml}
                </div>
                <div class="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-l from-white to-transparent pointer-events-none z-10"></div>
            </div>

            <div id="emergency-dynamic-content" class="min-h-[400px]">
                ${contentHtml}
            </div>
        </div>`;

    // è§¸ç™¼å±€éƒ¨åˆ—è¡¨æ¸²æŸ“
    if (window.activeEmergencyCat === 'medical') {
        renderEmbassyList();
        renderMedicalList();
    }
}

/** ğŸ› ï¸ å­çµ„ä»¶ï¼šåˆ‡æ›ç·Šæ€¥é¡åˆ¥ */
function setEmergencyCat(catId) {
    window.activeEmergencyCat = catId;
    renderEmergencyView();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/** ğŸ‡¹ğŸ‡¼ æ¸²æŸ“é ˜äº‹è­·ç…§åˆ†é  (ä¿®æ­£ï¼šæ¡†æ¶å°é½Šèˆ‡åŸç‰ˆé…è‰²) */
function renderConsulateSOP() {
    const embassies = state.emergencyContacts.embassies || [];
    const embassyCards = embassies.length > 0 
        ? embassies.map(e => `
            <div class="emergency-card border-l-4 border-blue-500 p-4 bg-white shadow-sm rounded-2xl mb-4">
                <div class="flex justify-between items-start">
                    <h5 class="font-black text-slate-800 text-sm">${e.name}</h5>
                    <div class="flex gap-1">
                        <button onclick="editEmbassy('${e.id}')" class="text-slate-300 hover:text-blue-500 transition-colors">âœï¸</button>
                    </div>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 italic">ğŸ“ ${e.address || 'ç„¡åœ°å€è³‡è¨Š'}</p>
                <div class="flex gap-4 mt-3">
                    <a href="tel:${e.phone}" class="text-[11px] font-black text-blue-600">ğŸ“ ä¸€èˆ¬: ${e.phone}</a>
                    <a href="tel:${e.rescuePhone}" class="text-[11px] font-black text-red-600">ğŸš¨ æ€¥é›£: ${e.rescuePhone}</a>
                </div>
            </div>`).join('')
        : '<p class="text-xs text-slate-400 text-center py-4">ç›®å‰ç„¡é§å¤–è³‡æ–™</p>';

    return `
        <div class="animate-in fade-in space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-sm font-black text-gray-700 border-l-4 border-blue-500 pl-3 mb-4 uppercase tracking-widest">ğŸ‡¹ğŸ‡¼ é§å¤–ä»£è¡¨è™•</h4>
                    <div class="space-y-4">${embassyCards}</div>
                </div>
                <div class="p-6 rounded-[2rem] bg-rose-50 border-2 border-dashed border-rose-200">
                    <h4 class="text-sm font-black text-rose-600 mb-4 flex items-center tracking-widest">
                        <span class="mr-2">ğŸ“•</span> è­·ç…§éºå¤± / æ—¥æœ¬ç¾å ´æ‡‰è®Š SOP
                    </h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-white p-3 rounded-2xl shadow-sm border border-rose-100">
                            <p class="text-[10px] font-black text-rose-400 mb-1 uppercase">STEP 01: å ±æ¡ˆ</p>
                            <p class="text-xs font-bold text-gray-700">èµ´æœ€è¿‘ã€Œäº¤ç•ªã€å ±æ¡ˆï¼Œå–å¾—ã€éºå¤±å±†å‡ºè­‰æ˜æ›¸ã€‘ã€‚</p>
                        </div>
                        <div class="bg-white p-3 rounded-2xl shadow-sm border border-rose-100">
                            <p class="text-[10px] font-black text-rose-400 mb-1 uppercase">STEP 02: ç…§ç‰‡</p>
                            <p class="text-xs font-bold text-gray-700">æº–å‚™ 2 å‹ç…§ç‰‡ 2 å¼µï¼Œè¯ç¹«ã€ä»£è¡¨è™•ã€‘é ç´„ã€‚</p>
                        </div>
                        <div class="bg-white p-3 rounded-2xl shadow-sm border border-rose-100">
                            <p class="text-[10px] font-black text-rose-400 mb-1 uppercase">STEP 03: è­‰æ˜</p>
                            <p class="text-xs font-bold text-gray-700">ç”³è«‹ã€Œå…¥åœ‹è­‰æ˜æ›¸ã€è¿”å°ï¼Œå‹™å¿…é›»è©±ç¢ºèªè¾¦å…¬æ™‚é–“ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
}

/** ğŸ›¡ï¸ æ¸²æŸ“ç†è³ èˆ‡ä¿éšªæ¨¡çµ„ (æ¢å¾©åŸç‰ˆå€å¡ŠåŒ–å®šç¾©) */
function renderInsuranceModule() {
    const insuranceResources = state.emergencyContacts.medical.filter(m => m.isInsurance) || [];

    return `
        <div class="animate-in fade-in space-y-6">
            <div class="p-6 rounded-[2.5rem] bg-sky-50 border-2 border-dashed border-sky-200">
                <h4 class="text-sm font-black text-sky-600 mb-6 flex items-center tracking-widest">
                    <span class="mr-2">ğŸ›¡ï¸</span> æ—…éŠä¿éšªè™•ç½®æµç¨‹ & è¯çµ¡è³‡æº
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-sky-100">
                        <p class="text-xs font-black text-sky-700 mb-3 border-b border-sky-50 pb-2 flex items-center gap-2">
                            <span>ğŸ¥</span> æµ·å¤–çªç™¼ç–¾ç—…/å‚·å®³
                        </p>
                        <ul class="text-[11px] space-y-3 text-slate-600 font-bold leading-relaxed">
                            <li class="flex items-start gap-2">â— <span class="flex-1">ç´¢å–ã€è¨ºæ–·è­‰æ˜æ›¸ã€‘æ­£æœ¬ (éœ€é†«ç”Ÿç°½ç« )</span></li>
                            <li class="flex items-start gap-2">â— <span class="flex-1">ä¿ç•™ã€æ”¶æ“šæ˜ç´°ã€‘(è¨ºå¯Ÿè²»ã€è™•æ–¹ç®‹)</span></li>
                            <li class="flex items-start gap-2">â— <span class="flex-1">ä½é™¢éœ€è‡´é›»ä¿éšªå…¬å¸å°‹æ±‚ã€Œæµ·å¤–æ€¥é›£æ•‘åŠ©ã€</span></li>
                        </ul>
                    </div>
                    
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-sky-100 flex flex-col">
                        <p class="text-xs font-black text-sky-700 mb-3 border-b border-sky-50 pb-2 flex items-center gap-2">
                            <span>âœˆï¸</span> æ—…éŠä¸ä¾¿éšª (å»¶èª¤/è¡Œæ)
                        </p>
                        <ul class="text-[11px] space-y-3 text-slate-600 font-bold leading-relaxed mb-4">
                            <li class="flex items-start gap-2">â— <span class="flex-1">ç­æ©Ÿå»¶èª¤ï¼šç´¢å–ã€å»¶èª¤è­‰æ˜ã€‘</span></li>
                            <li class="flex items-start gap-2">â— <span class="flex-1">è¡Œææå¤±ï¼šå–å¾—ã€è¡Œæäº‹æ•…å ±å‘Š PIRã€‘</span></li>
                        </ul>
                        
                        <div class="mt-auto p-3 bg-sky-50 rounded-2xl border border-sky-100">
                            <p class="text-[9px] font-black text-sky-600 mb-2 uppercase tracking-tighter">ğŸ“ ä¿éšªå…¬å¸ 24H å°ˆç·š</p>
                            <div class="space-y-2 max-h-[100px] overflow-y-auto no-scrollbar">
                                ${insuranceResources.length > 0 ? insuranceResources.map(ins => `
                                    <div class="flex justify-between items-center text-[10px] font-black text-slate-700">
                                        <span>${ins.name}</span>
                                        <a href="tel:${ins.phone}" class="font-mono text-sky-600 underline">${ins.phone}</a>
                                    </div>`).join('') : '<p class="text-[9px] text-slate-300 italic">å°šæœªå°å…¥ä¿éšªç‡ƒæ–™</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 rounded-[2rem] bg-white border border-sky-100 shadow-sm">
                    <h5 class="text-xs font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span>ğŸ“‹</span> æ—¥æœ¬æ—…éŠç†è³ è­‰æ“šæ¡é›†æ¸…å–®
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3 text-[11px] font-bold text-slate-500">
                        ${renderClaimCheckbox('c1', 'é†«ç™‚ç†è³ ï¼šè¨ºæ–·æ›¸ã€æ”¶æ“šã€è™•æ–¹ç®‹')}
                        ${renderClaimCheckbox('c2', 'ç­æ©Ÿå»¶èª¤ï¼šå»¶èª¤è­‰æ˜ã€ç™»æ©Ÿè­‰ã€æ”¶æ“š')}
                        ${renderClaimCheckbox('c3', 'è¡Œææå¤±ï¼šPIR å ±å‘Šã€å—æç…§')}
                        ${renderClaimCheckbox('c4', 'è­·ç…§éºå¤±ï¼šäº¤ç•ªç·¨è™Ÿã€ä»£è¡¨è™•æ”¶æ“š')}
                    </div>
                    <div class="mt-6 pt-4 border-t border-sky-50 text-center">
                        <p class="text-[10px] text-sky-600 font-black italic">ğŸ¯ æ ¸å¿ƒå‹•ä½œï¼šå›å°å¾Œ 30 å¤©å…§æå‡ºç”³è«‹ï¼Œå»ºè­°å…¨ç¨‹æ‰‹æ©Ÿæ‹ç…§å­˜æª”ã€‚</p>
                    </div>
                </div>
            </div>
        </div>`;
}

/** ğŸ› ï¸ è¼”åŠ©æ¸²æŸ“ï¼šå¸¶ç‰©ç†è¨˜æ†¶çš„ Checkbox */
function renderClaimCheckbox(id, text) {
    const isChecked = state.emergencyClaims && state.emergencyClaims[id] ? 'checked' : '';
    return `
        <div class="flex items-center gap-3">
            <input type="checkbox" ${isChecked} onchange="toggleEmergencyClaim('${id}')"
                   class="h-4 w-4 text-sky-500 rounded border-slate-300 focus:ring-sky-500 transition-all">
            <span class="${isChecked ? 'text-slate-400 line-through' : ''}">${text}</span>
        </div>`;
}

/** ğŸ’¾ ç‰©ç†åŒæ­¥ï¼šç†è³ å‹¾é¸ç‹€æ…‹ */
async function toggleEmergencyClaim(id) {
    if (!state.emergencyClaims) state.emergencyClaims = {};
    state.emergencyClaims[id] = !state.emergencyClaims[id];
    
    // ğŸŒŸ å¼·åˆ¶æ“Šç©¿åŸå­é–å¯«å…¥ IndexedDB
    await saveData(true); 
    console.log(`ğŸ›¡ï¸ [Emergency-Vault] ç†è³ é …ç›® ${id} ç‹€æ…‹å·²é–å®š`);
}
/** ğŸ“„ æ¸²æŸ“ç†è³ æ–‡ä»¶æª¢æ ¸æ¸…å–® */
function renderClaimsChecklist() {
    const claims = [
        { id: 'c1', title: 'è¨ºæ–·è­‰æ˜æ›¸', desc: 'éœ€è“‹é†«é™¢å…¬ç« ï¼Œè¨»æ˜å‚·ç—…åç¨±' },
        { id: 'c2', title: 'é†«ç™‚è²»ç”¨æ”¶æ“šæ­£æœ¬', desc: 'åŒ…å«è—¥è²»æ˜ç´°è¡¨' },
        { id: 'c3', title: 'è­·ç…§å½±æœ¬', desc: 'å«å€‹äººé èˆ‡æ­¤æ¬¡å…¥å¢ƒ/å‡ºå¢ƒç« é ' },
        { id: 'c4', title: 'ç†è³ ç”³è«‹æ›¸', desc: 'ä¿éšªå…¬å¸å°ˆç”¨è¡¨æ ¼' },
        { id: 'c5', title: 'äº‹æ•…è­‰æ˜ (èª¤é»/éºå¤±)', desc: 'èˆªç©ºå…¬å¸æˆ–è­¦å¯Ÿå±€é–‹ç«‹' }
    ];

    if (!state.emergencyClaims) state.emergencyClaims = {};

    return `
        <div class="space-y-4">
            <h4 class="text-sm font-black text-slate-700 mb-2 uppercase tracking-widest">ç†è³ å¿…å‚™æ–‡ä»¶</h4>
            ${claims.map(item => {
                const isChecked = state.emergencyClaims[item.id] ? 'checked' : '';
                return `
                    <label class="flex items-start p-4 bg-slate-50 rounded-2xl border border-slate-100 cursor-pointer transition-all hover:bg-white hover:border-red-200">
                        <input type="checkbox" ${isChecked} 
                               onchange="toggleClaimItem('${item.id}')"
                               class="mt-1 form-checkbox h-5 w-5 text-red-500 rounded border-slate-300 focus:ring-red-500">
                        <div class="ml-4">
                            <p class="text-sm font-black text-slate-800">${item.title}</p>
                            <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-tighter">${item.desc}</p>
                        </div>
                    </label>
                `;
            }).join('')}
        </div>`;
}

/** ğŸ› ï¸ ç‰©ç†åŒæ­¥ï¼šåˆ‡æ›ç†è³ é …ç›®å‹¾é¸ */
async function toggleClaimItem(id) {
    if (!state.emergencyClaims) state.emergencyClaims = {};
    state.emergencyClaims[id] = !state.emergencyClaims[id];
    
    // ğŸŒŸ å¼·åˆ¶åŸ·è¡Œç‰©ç†è½åœ°
    await saveData(true); 
    console.log(`ğŸš¨ [Emergency] ç†è³ é …ç›® ${id} ç‹€æ…‹å·²ç‰©ç†é–å®š`);
}



/** ğŸš€ ä¿®æ­£ï¼šåˆ†æµåŒæ­¥è™•ç†å‡½æ•¸ (v5.3 ç‰©ç†å°ä½ä¿®æ­£ç‰ˆ)
 * ä½œç”¨ï¼šç²¾æº–åˆ†æµ å¤§ä½¿é¤¨ã€é†«ç™‚ã€ä¿éšª ä¸‰è·¯æ•¸æ“šï¼Œä¸¦å¼·æ¬Šé–å…¥ç‰©ç†ç£å€ã€‚
 */
async function processEmergencyFuel() {
    const inputEl = document.getElementById('emergency-fuel-input');
    const rawData = inputEl ? inputEl.value.trim() : "";

    if (!rawData) {
        showEmergencyLocalMessage('è«‹è²¼ä¸Šç‡ƒæ–™åŒ…æ•¸æ“šï¼', 'error');
        return;
    }

    // ğŸ›¡ï¸ 0. å•Ÿå‹•åŸå­é–ï¼šé˜²æ­¢æ³¨å…¥æœŸé–“èƒŒæ™¯è‡ªå‹•å­˜æª”å¹²æ“¾
    window.isTransportUpdating = true;

    try {
        const fuelItems = JSON.parse(rawData);
        const items = Array.isArray(fuelItems) ? fuelItems : [fuelItems];
        
        let embassyCount = 0;
        let medicalCount = 0;
        let insuranceCount = 0;

        items.forEach(item => {
            const commonId = generateUUID();
            // ğŸ¯ é—œéµè­˜åˆ¥é‚è¼¯
            const isEmbassy = item.type === 'embassy' || item.name.includes('ä»£è¡¨è™•') || item.name.includes('è¾¦äº‹è™•');
            const isInsurance = item.type === 'insurance' || item.name.includes('ä¿éšª') || item.name.includes('ç”¢éšª');

            if (isEmbassy) {
                // 1. åˆ†æµè‡³ä»£è¡¨è™•æ¸…å–® (åŠ ä¸Š emba- å‰ç¶´ä»¥åˆ©ç‰©ç†è¾¨è­˜)
                state.emergencyContacts.embassies.push({
                    id: 'emba-' + commonId, 
                    isAI: false, 
                    fromFuel: true,
                    name: item.name, 
                    address: item.address, 
                    phone: item.phone, 
                    rescuePhone: item.rescuePhone || item.phone
                });
                embassyCount++;
            } else {
                // 2. åˆ†æµè‡³é†«ç™‚æ¸…å–® (æ¨™è¨˜ isInsurance ä¾›åˆ†é éæ¿¾)
                state.emergencyContacts.medical.push({
                    id: (isInsurance ? 'ins-' : 'med-') + commonId, 
                    isAI: false, 
                    fromFuel: true,
                    isInsurance: isInsurance,
                    name: item.name, 
                    address: item.address, 
                    phone: item.phone, 
                    info: isInsurance ? `ğŸ›¡ï¸ ${item.info || "ç†è³ å°ˆç·š"}` : item.info || "é†«ç™‚æ”¯æ´"
                });
                
                if (isInsurance) insuranceCount++; 
                else medicalCount++;
            }

            // 3. åŒæ­¥é€²å…¥å­—å…¸æ­¸æª” (ç¢ºä¿ recognizeSemantic èƒ½æ„Ÿæ‡‰ç·Šæ€¥åœ°æ¨™)
            if (!state.bucketList.some(b => b.name === item.name)) {
                let tags = ["æ€¥"];
                if (isEmbassy) tags.push("é§å¤–");
                else if (isInsurance) tags.push("ä¿éšª");
                else tags.push("é†«");

                state.bucketList.push({
                    id: 'bucket-' + commonId, 
                    name: item.name, 
                    category: "é†«", 
                    tags: tags,
                    address: item.address, 
                    phone: item.phone, 
                    notes: item.info || "",
                    lastUpdate: new Date().toISOString()
                });
            }
        });

        // ğŸ’¾ 4. åŸ·è¡Œã€Œç‰©ç†ç´šã€å¼·æ¬Šå­˜æª” (Force Mode)
        // ä½¿ç”¨ await ç¢ºä¿è³‡æ–™å®Œå…¨å¯«å…¥ IndexedDB å¾Œæ‰é‡‹æ”¾é–å®š
        await saveData(true); 

        // ğŸ”„ 5. UI ä»‹é¢é‡ç¹ª (é€™æœƒè§¸ç™¼ v5.2 çš„æ¨™ç±¤éæ¿¾é‚è¼¯)
        renderEmergencyView(); 
        
        // æˆ°è¨Šå›å ±
        let successMsg = `âœ¨ æ™ºæ…§åˆ†æµæˆåŠŸï¼`;
        if (embassyCount > 0) successMsg += ` å¤§ä½¿é¤¨ +${embassyCount}`;
        if (medicalCount > 0) successMsg += ` é†«ç™‚ +${medicalCount}`;
        if (insuranceCount > 0) successMsg += ` ä¿éšª +${insuranceCount}`;
        
        showEmergencyLocalMessage(successMsg, 'success');
        if (inputEl) inputEl.value = ''; 

    } catch (e) {
        console.error("ç·Šæ€¥ç‡ƒæ–™è§£æå¤±æ•—:", e);
        showEmergencyLocalMessage('è§£æå¤±æ•—ï¼Œè«‹ç¢ºèª JSON æ ¼å¼ï¼', 'error');
    } finally {
        // ğŸ”“ 6. è§£é™¤åŸå­é–
        window.isTransportUpdating = false;
    }
}


/** ğŸ¯ ä¿®æ­£ï¼šè¤‡è£½ç·Šæ€¥é†«ç™‚å°ˆå±¬ AI æŒ‡ä»¤ (ä¸‰åˆä¸€å®Œæ•´ç‰ˆ) */
function copyEmergencyAIPrompt() {
    const day = getCurrentDay();
    const city = (day && day.city && day.city.length > 0) ? day.city[0] : "æŒ‡å®šåŸå¸‚";
    
    const prompt = `ä½ æ˜¯ä¸€ä½åœ‹éš›æ—…éŠå®‰å…¨èˆ‡æ€¥é›£æ•‘åŠ©å°ˆå®¶ã€‚
è«‹é‡å°ã€Œ${city}ã€æä¾›ä»¥ä¸‹ä¸‰é¡è³‡æºï¼Œä¸¦ä»¥å–®ä¸€ JSON é™£åˆ—æ ¼å¼è¼¸å‡ºï¼š

1. **é§å¤–æ©Ÿæ§‹**ï¼šè©²åŸå¸‚æˆ–é„°è¿‘çš„ã€Œä¸­è¯æ°‘åœ‹é§å¤–ä»£è¡¨è™•ã€ã€‚
2. **é†«ç™‚è³‡æº**ï¼š3-5 å€‹æä¾›ä¸­æ–‡æœå‹™çš„æ€¥æ•‘é†«é™¢ã€‚
3. **ä¿éšªè³‡æº**ï¼šå°ç£å¸¸è¦‹ä¿éšªå…¬å¸ï¼ˆå¦‚åœ‹æ³°ã€å¯Œé‚¦ï¼‰çš„ 24H æµ·å¤–æ€¥é›£æ•‘åŠ©é›»è©±ã€‚

ğŸš¨ æ ¼å¼è¦ç¯„ï¼š
- è¼¸å‡ºç‚ºç´” JSON é™£åˆ—ï¼Œä¸å«è§£é‡‹ã€‚
- æ¯å€‹ç‰©ä»¶å¿…é ˆåŒ…å« type æ¬„ä½ ("embassy", "medical", "insurance")ã€‚
- æ¬„ä½åŒ…å«ï¼šname, address, phone, info, rescuePhone (åƒ…é™ embassy)ã€‚

ç¯„ä¾‹æ ¼å¼ï¼š
[
  {
    "type": "embassy",
    "name": "å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•",
    "address": "æ±äº¬æ¸¯å€ç™½é‡‘å°",
    "phone": "+81-3-3280-7811",
    "rescuePhone": "+81-80-6557-8796",
    "info": "æä¾›è­·ç…§éºå¤±èˆ‡æ€¥é›£æ•‘åŠ©"
  },
  {
    "type": "insurance",
    "name": "åœ‹æ³°ç”¢éšªæµ·å¤–æ€¥é›£å°ˆç·š",
    "address": "24H å…¨çƒä¸­å¿ƒ",
    "phone": "+886-2-2181-5888",
    "info": "ç†è³ è«®è©¢èˆ‡æµ·å¤–æ€¥é›£é†«ç™‚æ”¯æ´"
  }
]`;

    navigator.clipboard.writeText(prompt).then(() => {
        showEmergencyLocalMessage('âœ… ä¸‰åˆä¸€ AI æ•‘è­·æŒ‡ä»¤å·²è¤‡è£½ï¼', 'success');
    });
}


/** âœ¨ å±€éƒ¨è¨Šæ¯é¡¯ç¤º (ç·Šæ€¥é å°ˆç”¨) */
function showEmergencyLocalMessage(text, type = 'success') {
    const msgEl = document.getElementById('emergency-local-msg');
    if (!msgEl) return;
    const colors = {
        success: 'bg-green-100 text-green-700 border border-green-200',
        error: 'bg-red-100 text-red-700 border border-red-200',
        warning: 'bg-amber-100 text-amber-700 border border-amber-200'
    };
    msgEl.className = `mb-4 p-3 rounded-xl text-xs font-black transition-all ${colors[type] || colors.success}`;
    msgEl.innerHTML = text;
    msgEl.style.display = 'block';
    setTimeout(() => msgEl.style.display = 'none', 3000);
}

/** ğŸ” å­—å…¸éæ¿¾æ ¸å¿ƒ - ä¿®æ­£é‚è¼¯ä»¥ç¢ºä¿å³æ™‚é‡ç¹ª */
function filterEmergencyByDict(tag) {
    const dict = window.GLOBAL_DICT || [];
    const entry = dict.find(d => d.tag === tag);
    if (!entry) return;

    const keywords = entry.keywords || [];
    const allResources = state.emergencyContacts.medical || [];
    
    const filtered = allResources.filter(m => 
        keywords.some(k => m.name.includes(k) || (m.info && m.info.includes(k)))
    );

    const list = document.getElementById('medical-list');
    if (!list) return;

    if (filtered.length === 0) {
        list.innerHTML = `<p class="text-xs text-gray-400 text-center py-10 italic border-2 border-dashed border-gray-100 rounded-3xl">ğŸ” æœ¬åœ°è³‡æ–™åº«æš«ç„¡ [#${tag}] çš„ç´€éŒ„</p>`;
    } else {
        list.innerHTML = filtered.map(m => `
            <div class="emergency-card border-l-4 border-emerald-400 p-4 bg-white shadow-sm rounded-2xl mb-3 animate-in slide-in-from-top-1">
                <div class="flex justify-between items-start">
                    <div>
                        <h5 class="font-bold text-gray-800 text-sm">${m.name}</h5>
                        <span class="text-[9px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full font-black mt-1 inline-block border border-emerald-100">${tag}</span>
                    </div>
                    <button onclick="editMedical('${m.id}')" class="p-2 text-gray-300 hover:text-pink-500 transition-colors">âœï¸</button>
                </div>
                <p class="text-[11px] text-gray-500 mt-3 flex items-center gap-1">
                    <span class="opacity-50">ğŸ“</span> ${m.address}
                </p>
                <div class="mt-3 flex gap-4">
                    <a href="tel:${m.phone}" class="text-xs font-black text-emerald-600 font-mono bg-emerald-50 px-3 py-1 rounded-lg">ğŸ“ ${m.phone}</a>
                </div>
            </div>
        `).join('');
    }
}



/** æ¸²æŸ“é§å¤–ä»£è¡¨è™•åˆ—è¡¨å¡ç‰‡ */
function renderEmbassyList() {
    const list = document.getElementById('embassy-list');
    if (!list) return;
    const embassies = state.emergencyContacts.embassies || [];
    list.innerHTML = embassies.map(e => `
        <div class="emergency-card border-l-4 border-blue-400 p-4 bg-white shadow-sm rounded-xl mb-3">
            <div class="flex justify-between items-start">
                <h5 class="font-bold text-gray-800 text-sm">${e.name}</h5>
                <div class="flex gap-2">
                    <button onclick="editEmbassy('${e.id}')" class="text-gray-400 hover:text-blue-500 text-xs">ç·¨è¼¯</button>
                    <button onclick="deleteEmbassy('${e.id}')" class="text-gray-400 hover:text-red-500 text-xs">åˆªé™¤</button>
                </div>
            </div>
            <p class="text-[11px] text-gray-500 mt-1">ğŸ“ ${e.address || 'ç„¡åœ°å€è³‡è¨Š'}</p>
            <div class="flex gap-4 mt-3">
                <a href="tel:${e.phone}" class="text-xs font-bold text-blue-600">ğŸ“ ä¸€èˆ¬é›»è©±</a>
                <a href="tel:${e.rescuePhone}" class="text-xs font-bold text-red-600">ğŸš¨ æ€¥é›£æ•‘åŠ©</a>
            </div>
        </div>
    `).join('') || '<p class="text-xs text-gray-400 text-center py-4">ç›®å‰ç„¡è³‡æ–™</p>';
}

/** æ¸²æŸ“é†«ç™‚è³‡æºåˆ—è¡¨å¡ç‰‡ */
function renderMedicalList() {
    const list = document.getElementById('medical-list');
    if (!list) return;
    const medical = state.emergencyContacts.medical || [];
    list.innerHTML = medical.map(m => `
        <div class="emergency-card border-l-4 border-emerald-400 p-4 bg-white shadow-sm rounded-xl mb-3">
            <div class="flex justify-between items-start">
                <div>
                    <h5 class="font-bold text-gray-800 text-sm">${m.name}</h5>
                    <span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold">${m.info || 'æä¾›ä¸­æ–‡æœå‹™'}</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="editMedical('${m.id}')" class="text-gray-400 hover:text-blue-500 text-xs">ç·¨è¼¯</button>
                    <button onclick="deleteMedical('${m.id}')" class="text-gray-400 hover:text-red-500 text-xs">åˆªé™¤</button>
                </div>
            </div>
            <p class="text-[11px] text-gray-500 mt-2">ğŸ“ ${m.address || 'ç„¡åœ°å€è³‡è¨Š'}</p>
            <a href="tel:${m.phone}" class="inline-block mt-2 text-xs font-bold text-emerald-600">ğŸ“ è¯çµ¡é›»è©±: ${m.phone}</a>
        </div>
    `).join('') || '<p class="text-xs text-gray-400 text-center py-4">ç›®å‰ç„¡è³‡æ–™</p>';
}

        /**
         * åˆªé™¤å¤§ä½¿é¤¨/ä»£è¡¨è™•
         */
        function deleteEmbassy(id) {
            const index = state.emergencyContacts.embassies.findIndex(e => e.id === id);
            if (index > -1 && confirm(`ç¢ºå®šè¦åˆªé™¤ ${state.emergencyContacts.embassies[index].name} çš„è¯çµ¡è³‡è¨Šå—ï¼Ÿ`)) {
                state.emergencyContacts.embassies.splice(index, 1);
                saveData();
                if (state.currentSubView === 'emergency') renderEmbassyList();
                showMessage('å¤§ä½¿é¤¨è³‡è¨Šå·²åˆªé™¤', 'info');
            }
        }

/** --- é†«ç™‚è³‡æºåŠŸèƒ½ --- **/

function addMedical() {
    const newId = generateUUID();
    document.getElementById('edit-medical-id').value = newId;
    document.getElementById('edit-medical-name').value = '';
    document.getElementById('edit-medical-info').value = '';
    document.getElementById('edit-medical-address').value = '';
    document.getElementById('edit-medical-phone').value = '';
    toggleModal('medical-edit-modal');
}

/** --- ç·¨è¼¯é†«ç™‚è³‡æºåŠŸèƒ½ --- **/

function editMedical(id) {
    const medical = state.emergencyContacts.medical.find(m => m.id === id);
    if (!medical) return;

    document.getElementById('edit-medical-id').value = id;
    document.getElementById('edit-medical-name').value = medical.name;
    document.getElementById('edit-medical-info').value = medical.info;
    document.getElementById('edit-medical-address').value = medical.address;
    document.getElementById('edit-medical-phone').value = medical.phone;
    toggleModal('medical-edit-modal');
}

/** --- å„²å­˜é†«ç™‚è³‡æºåŠŸèƒ½ --- **/

function saveMedicalEdit() {
    const id = document.getElementById('edit-medical-id').value;
    const name = document.getElementById('edit-medical-name').value.trim();
    const info = document.getElementById('edit-medical-info').value.trim();
    const address = document.getElementById('edit-medical-address').value.trim();
    const phone = document.getElementById('edit-medical-phone').value.trim();

    if (!name) { showMessage('è«‹è¼¸å…¥å–®ä½åç¨±', 'error'); return; }

    const index = state.emergencyContacts.medical.findIndex(m => m.id === id);
    const data = { id, name, info, address, phone, isAI: false };

    if (index > -1) {
        state.emergencyContacts.medical[index] = data;
    } else {
        state.emergencyContacts.medical.push(data);
    }

    saveData();
    toggleModal('medical-edit-modal');
    renderMedicalList();
    showMessage('é†«ç™‚è³‡æºè³‡è¨Šå·²æ›´æ–°', 'success');
}

        /**
         * åˆªé™¤ä¸­æ–‡é†«ç™‚å”åŠ©è³‡æº
         */
        function deleteMedical(id) {
            const index = state.emergencyContacts.medical.findIndex(m => m.id === id);
            if (index > -1 && confirm(`ç¢ºå®šè¦åˆªé™¤ ${state.emergencyContacts.medical[index].name} çš„è³‡è¨Šå—ï¼Ÿ`)) {
                state.emergencyContacts.medical.splice(index, 1);
                saveData();
                if (state.currentSubView === 'emergency') renderMedicalList();
                showMessage('é†«ç™‚è³‡æºè³‡è¨Šå·²åˆªé™¤', 'info');
            }
        }


/** ğŸ¯ å‘¼å« AI æœå°‹é§å¤–å¤§ä½¿é¤¨å’Œä¸­æ–‡é†«ç™‚è³‡æº (v5.4 ç‰©ç†å°ä½ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å‡ç´šè‡³ Gemini 2.0 Flash å¼•æ“ä»¥æå‡ 2026 æœ€æ–°åœ°æ¨™ç²¾æº–åº¦ã€‚
 * 2. å°å…¥ await saveData(true) ç¢ºä¿æœæ•‘è³‡è¨Šå³æ™‚é–å…¥ç‰©ç†ç£å€ã€‚
 * 3. å¼·åŒ– JSON è§£æç©©å®šæ€§èˆ‡ ID å”¯ä¸€æ€§ã€‚
 */
async function fetchAIEmergencyInfo() {
    const city = document.getElementById('ai-emergency-city-input').value.trim();
    const statusEl = document.getElementById('ai-emergency-status');

    if (!city) {
        statusEl.innerHTML = '<p class="text-xs text-red-500 font-black">âŒ è«‹è¼¸å…¥è¦æœå°‹çš„åŸå¸‚/åœ‹å®¶ï¼</p>';
        return;
    }
    if (!state.theme.geminiKey) {
        statusEl.innerHTML = '<p class="text-xs text-red-500 font-black">âŒ è«‹å…ˆåœ¨ã€Œè¨­å®šã€ä¸­è¼¸å…¥ API Keyï¼</p>';
        return;
    }

    statusEl.innerHTML = `
        <div class="text-center py-4 animate-pulse">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-red-500 border-t-transparent mb-2"></div>
            <p class="text-gray-600 text-sm font-black">AI æ­£åœ¨æ·±åº¦æƒæ ${city} çš„æ•‘æ´è³‡æº...</p>
        </div>`;
    
    // é–å®šç•¶å‰æœå°‹åŸå¸‚ç‹€æ…‹
    state.aiEmergencySearchResults.city = city;

    const apiKey = state.theme.geminiKey;
    // ğŸš€ å‡ç´šï¼šä½¿ç”¨ 2026 æœ€å¼·æ•‘æ´å¼•æ“ 2.0 Flash
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šåœ‹éš›æ—…éŠå®‰å…¨èˆ‡æ€¥é›£æ•‘åŠ©çš„å°ˆå®¶ã€‚è«‹é‡å°åŸå¸‚ã€Œ${city}ã€ï¼Œç‚ºå°ç£æ—…å®¢æœå°‹ä»¥ä¸‹ç·Šæ€¥è³‡è¨Šï¼š
1. **é§å¤–æ©Ÿæ§‹**ï¼šåœ¨è©²åŸå¸‚æˆ–é„°è¿‘åœ°å€çš„ã€Œä¸­è¯æ°‘åœ‹é§å¤–ä»£è¡¨è™•ã€ã€‚
2. **ä¸­æ–‡é†«ç™‚**ï¼šå°‹æ‰¾ 3-5 ç­†æä¾›ã€Œä¸­æ–‡æœå‹™ã€æˆ–ã€Œè¯èªé†«ç”Ÿã€çš„æ€¥è¨ºé†«é™¢ã€‚

**ğŸš¨ åš´æ ¼è¼¸å‡ºè¦ç¯„ï¼š**
- åƒ…å›å‚³ç´” JSON ç‰©ä»¶ã€‚
- æ¬„ä½ï¼šembassies [ {name, address, phone, rescuePhone} ], medical [ {name, info, address, phone} ]ã€‚
- å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`;

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ "google_search": {} }], 
        systemInstruction: {
            parts: [{ text: "ä½ æ˜¯ä¸€ä½ç²¾æº–çš„æ•‘è­·èª¿åº¦å®˜ã€‚åªå›å‚³ JSON æ ¼å¼ï¼Œç¢ºä¿æ‰€æœ‰é›»è©±èˆ‡åœ°å€å‡ç‚º 2026 æœ€æ–°è³‡è¨Šã€‚" }]
        },
        generationConfig: { responseMimeType: "application/json" }
    };

    let attempts = 0;
    const maxAttempts = 3;

    while (attempts < maxAttempts) {
        attempts++;
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API ç‹€æ…‹ç¢¼: ${response.status}`);

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const parsedResult = typeof jsonText === 'string' ? JSON.parse(jsonText) : jsonText;
            
            // ğŸ›¡ï¸ æ•¸æ“šç‰©ç†åˆ†æµè™•ç†
            // 1. è™•ç†ä»£è¡¨è™• (éæ¿¾èˆŠçš„ AI çµæœ)
            state.emergencyContacts.embassies = state.emergencyContacts.embassies.filter(e => e.isAI !== true);
            if (parsedResult.embassies && parsedResult.embassies.length > 0) {
                parsedResult.embassies.forEach(e => {
                    state.emergencyContacts.embassies.push({
                        id: 'emba-ai-' + generateUUID(),
                        isAI: true,
                        ...e
                    });
                });
            }

            // 2. è™•ç†é†«ç™‚è³‡æº (éæ¿¾èˆŠçš„ AI çµæœ)
            state.emergencyContacts.medical = state.emergencyContacts.medical.filter(m => m.isAI !== true);
            if (parsedResult.medical && parsedResult.medical.length > 0) {
                parsedResult.medical.forEach(m => {
                    state.emergencyContacts.medical.push({
                        id: 'med-ai-' + generateUUID(),
                        isAI: true,
                        isInsurance: false,
                        ...m
                    });
                });
            }

            // ğŸ’¾ 3. åŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª”
            // ä½¿ç”¨ await ç¢ºä¿æœå°‹çµæœåœ¨é é¢é‡ç¹ªå‰å·²é–å…¥ IndexedDB
            await saveData(true); 

            // ğŸ”„ 4. UI å³æ™‚é‡ç¹ª
            if (state.currentSubView === 'emergency') {
                renderEmergencyView(); // è§¸ç™¼ v5.2 çš„æ¨™ç±¤èˆ‡åˆ—è¡¨æ›´æ–°
            }
            
            statusEl.innerHTML = `<p class="text-xs text-green-600 font-black">âœ¨ æœå°‹å®Œæˆï¼å·²å°‡æ•‘æ´æŒ‡ç´‹é–å…¥ç‰©ç†ç£å€ã€‚</p>`;
            return;

        } catch (error) {
            console.error("AI æœæ•‘å¤±æ•—:", error);
            if (attempts === maxAttempts) {
                statusEl.innerHTML = `<p class="text-xs text-red-500 font-bold">âŒ æœæ•‘å¤±æ•—: ${error.message}</p>`;
            } else {
                statusEl.innerHTML = `<p class="text-xs text-orange-600">åµæ¸¬åˆ°ç¶²è·¯å¹²æ“¾ï¼Œç¬¬ ${attempts} æ¬¡é‡æ–°æƒæ...</p>`;
                await new Promise(r => setTimeout(r, 2000));
            }
        }
    }
}




/** --- é§å¤–ä»£è¡¨è™•åŠŸèƒ½ --- **/

function addEmbassy() {
    // é è¨­ä¸€å€‹æ–°ç‰©ä»¶ IDï¼Œé–‹å•Ÿæ¨¡æ…‹æ¡†é€²è¡Œç·¨è¼¯
    const newId = generateUUID();
    document.getElementById('edit-embassy-id').value = newId;
    document.getElementById('edit-embassy-name').value = '';
    document.getElementById('edit-embassy-address').value = '';
    document.getElementById('edit-embassy-phone').value = '';
    document.getElementById('edit-embassy-rescue').value = '';
    toggleModal('embassy-edit-modal');
}


/** --- ç·¨è¼¯å¤§ä½¿é¤¨/ä»£è¡¨è™• (æ¨¡æ“¬æ¨¡æ…‹æ¡†) --- **/

function editEmbassy(id) {
    const embassy = state.emergencyContacts.embassies.find(e => e.id === id);
    if (!embassy) return;
    
    document.getElementById('edit-embassy-id').value = id;
    document.getElementById('edit-embassy-name').value = embassy.name;
    document.getElementById('edit-embassy-address').value = embassy.address;
    document.getElementById('edit-embassy-phone').value = embassy.phone;
    document.getElementById('edit-embassy-rescue').value = embassy.rescuePhone;
    toggleModal('embassy-edit-modal');
}

/** --- å„²å­˜å¤§ä½¿é¤¨/ä»£è¡¨è™• (æ¨¡æ“¬æ¨¡æ…‹æ¡†) --- **/
function saveEmbassyEdit() {
    const id = document.getElementById('edit-embassy-id').value;
    const name = document.getElementById('edit-embassy-name').value.trim();
    const address = document.getElementById('edit-embassy-address').value.trim();
    const phone = document.getElementById('edit-embassy-phone').value.trim();
    const rescuePhone = document.getElementById('edit-embassy-rescue').value.trim();

    if (!name) { showMessage('è«‹è¼¸å…¥åç¨±', 'error'); return; }

    const index = state.emergencyContacts.embassies.findIndex(e => e.id === id);
    const data = { id, name, address, phone, rescuePhone, isAI: false };

    if (index > -1) {
        state.emergencyContacts.embassies[index] = data;
    } else {
        state.emergencyContacts.embassies.push(data);
    }

    saveData();
    toggleModal('embassy-edit-modal');
    renderEmbassyList();
    showMessage('é§å¤–ä»£è¡¨è™•è³‡è¨Šå·²æ›´æ–°', 'success');
}

// ç·Šæ€¥é é¢çµæŸ


/** ğŸ—£ï¸ ç¿»è­¯å°ˆå±¬æ¨¡çµ„ï¼šæ•¸æ“šç¨ç«‹åŒ–ç‰ˆæœ¬ **/

/** ğŸš¨ æ¸²æŸ“ç¿»è­¯èˆ‡æƒ…å¢ƒå°è©±è¦–åœ– (v5.1 ç‡ƒæ–™åŒ–å°æ­£ç‰ˆ) */
function renderTranslateView() {
    const container = document.getElementById('translate-view');
    if (!container) return;

    container.innerHTML = `
        <div class="bg-white p-6 rounded-[2.5rem] shadow-lg w-full border border-gray-100 transition-all animate-in fade-in">
            <h3 class="text-xl font-bold mb-6 theme-text-pink flex items-center">
                <span class="mr-2">ğŸŒ</span> å³æ™‚ç¿»è­¯èˆ‡æƒ…å¢ƒå°è©±
            </h3>

            <div id="translation-local-msg" class="hidden mb-4 p-3 rounded-xl text-xs font-bold animate-bounce text-center"></div>

            <div class="mb-8 p-4 rounded-3xl bg-gray-50 border border-gray-100 shadow-inner">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-[11px] font-black text-gray-700 uppercase tracking-tighter">ğŸš€ ç¿»è­¯æƒ…å¢ƒç‡ƒæ–™åŒ…</h4>
                    <button onclick="copyTranslationAIPrompt()" 
                            class="text-xs text-pink-500 hover:text-pink-700 font-medium flex items-center bg-pink-50 px-2 py-1 rounded-md transition-all">
                        ğŸ§  è¤‡è£½ AI æŒ‡ä»¤
                    </button>
                </div>
                <textarea id="translation-fuel-input" 
                          class="w-full p-3 text-[10px] bg-white border border-gray-200 rounded-2xl outline-none resize-none mb-2 h-20"
                          placeholder="è²¼ä¸Š AI è¼¸å‡ºçš„ç¿»è­¯ JSON (åŒ…å«æ—¥æ–‡èˆ‡ç¾…é¦¬æ‹¼éŸ³)..."></textarea>
                <button onclick="processTranslationFuel()" 
                        class="w-full py-2.5 theme-pink text-white rounded-xl font-black text-xs shadow-md active:scale-95 transition-all">
                    å­˜å…¥ç¿»è­¯å°ˆå±¬åº« (Vault)
                </button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-2 text-sm">å–®å¥ç¿»è­¯èˆ‡èªéŸ³</h4>
                <div class="relative mb-3">
                    <textarea id="translate-input" class="w-full p-4 border border-gray-200 rounded-2xl focus:ring-2 theme-border-pink outline-none h-24 text-sm pr-12" 
                        placeholder="è¼¸å…¥ä¸­æ–‡æˆ–æ—¥æ–‡..." oninput="simulateTranslate()"></textarea>
                    <button onclick="startVoiceInput()" class="absolute bottom-3 right-3 p-2.5 rounded-full bg-red-500 text-white hover:bg-red-600 shadow-lg transition">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zM3 8a7 7 0 0114 0v2a1 1 0 11-2 0V8a5 5 0 00-10 0v2a1 1 0 11-2 0V8zM8 17a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/></svg>
                    </button>
                </div>
                
                <div id="trans-result-area" class="p-4 bg-gray-50 rounded-2xl border border-gray-100 mb-4 min-h-[60px]">
                    <p class="text-[10px] text-gray-400 font-black uppercase mb-1">ç¿»è­¯çµæœ</p>
                    <p id="translate-output" class="text-base font-bold text-gray-800">ç­‰å¾…è¼¸å…¥...</p>
                    <div id="audio-placeholder" class="mt-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="playCurrentTranslation()" class="py-2.5 rounded-xl border-2 theme-border-pink theme-text-pink font-bold text-xs hover:theme-bg-light transition">ğŸ—£ï¸ èªéŸ³å›é¥‹ (æ—¥æ–‡)</button>
                    <input type="file" id="photo-translate-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    <label for="photo-translate-input" class="cursor-pointer py-2.5 rounded-xl border-2 theme-border-pink theme-text-pink font-bold text-xs text-center hover:theme-bg-light transition">ğŸ“¸ æ‹ç…§ç¿»è­¯</label>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <h4 class="font-bold text-gray-700 mb-3 text-sm">ğŸ¤– AI æƒ…å¢ƒå°è©±ç”Ÿæˆ</h4>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="keyword-input" placeholder="é—œéµå­— (å¦‚: é£¯åº—é»é¤, è—¥å¦)" class="flex-grow p-3 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 theme-border-pink">
                    <button onclick="generateDialogue()" class="px-6 py-2 theme-pink text-white rounded-xl font-bold text-xs shadow-md">ç”Ÿæˆå°è©±</button>
                </div>
                <div id="dialogue-output" class="space-y-4 min-h-[100px]">
                    <p class="text-[10px] text-gray-400 text-center py-8">è¼¸å…¥ä¸»é¡Œå¾Œï¼ŒAI æœƒç‚ºæ‚¨æº–å‚™å•è©±ç¯„ä¾‹ã€‚</p>
                </div>
            </div>

            <div class="mt-8 border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-black text-gray-700 flex items-center">
                        <span class="mr-2 text-lg">ğŸ“‚</span> ç¿»è­¯æ”¶è—åŒ£ (å°ˆå±¬åº«)
                    </h4>
                    <button onclick="clearTranslationVault()" class="text-[10px] text-gray-400 hover:text-red-500 font-bold uppercase">æ¸…ç©º Vault</button>
                </div>
                <div id="translation-vault-container" class="space-y-3 max-h-[400px] overflow-y-auto no-scrollbar pb-10">
                    </div>
            </div>
        </div>
    `;
    renderTranslationVault();
}

/** ğŸš€ è™•ç†ç¿»è­¯å°ˆç”¨ç‡ƒæ–™åŒæ­¥ï¼šç²¾æº–åˆ†æµè‡³ Vault ä¸¦å¼·åŒ–å¯¦é«”å„²å­˜ */
async function processTranslationFuel() {
    const inputEl = document.getElementById('translation-fuel-input');
    const rawData = inputEl.value.trim();
    
    // 1. é˜²ç¦¦æª¢æŸ¥
    if (!rawData) { 
        showTranslationLocalMessage('è«‹è²¼ä¸Šç¿»è­¯ JSONï¼', 'error'); 
        return; 
    }

    try {
        const fuelItems = JSON.parse(rawData);
        const items = Array.isArray(fuelItems) ? fuelItems : [fuelItems];
        
        // 2. åˆå§‹åŒ– Vault é™£åˆ— (ç¢ºä¿æ•¸æ“šåŸºåº§å­˜åœ¨)
        if (!state.translationVault) state.translationVault = [];

        let count = 0;
        
        // ä½¿ç”¨ Promise.all ç¢ºä¿æ‰€æœ‰ç‰©ç†å¯«å…¥å®Œæˆ
        await Promise.all(items.map(async (item) => {
            // ä»¥ä¸­æ–‡åŸæ–‡ (q) ç‚º key æª¢æŸ¥é‡è¤‡ï¼Œé¿å…æ±™æŸ“è³‡æ–™åº«
            if (!state.translationVault.some(t => t.q === item.q)) {
                const newEntry = {
                    id: generateUUID(),
                    q: item.q,                  // ä¸­æ–‡
                    a: item.a,                  // æ—¥æ–‡
                    romaji: item.romaji || "",   // ç¾…é¦¬æ‹¼éŸ³
                    category: item.category || "å¸¸ç”¨èª",
                    timestamp: Date.now()
                };

                // A. å¯«å…¥å…¨åŸŸç‹€æ…‹è¨˜æ†¶é«” (ä¾›å³æ™‚æ¸²æŸ“)
                state.translationVault.push(newEntry);

                // B. ç‰©ç†åŒæ­¥ï¼šå¯«å…¥å°ˆå±¬ç¿»è­¯ Store (æŒä¹…åŒ–é›™é‡ä¿éšª)
                if (dbManager && dbManager.save) {
                    await dbManager.save('translations_store', newEntry);
                }
                
                count++;
            }
        }));

        // 3. è§¸ç™¼æ——è‰¦ç´šå…¨é‡å­˜æª” (åŸ·è¡Œå¿«ç…§å‚™ä»½èˆ‡è‡ªç™’å‚™ä»½)
        await saveData();

        // 4. æ›´æ–° UI è¦–åœ–
        if (typeof renderTranslationVault === 'function') {
            renderTranslationVault(); 
        } else if (typeof renderTranslateView === 'function') {
            renderTranslateView(); // è‹¥æ‰¾ä¸åˆ°ç´°ç¯€æ¸²æŸ“å‰‡é‡ç¹ªä¸»è¦–åœ–
        }

        // 5. åé¥‹å°å…¥æˆ°æœ
        showTranslationLocalMessage(`âœ… ç¿»è­¯å°ˆå±¬åº«è£œçµ¦å®Œç•¢ï¼å¯¦é«”åŒæ­¥æ–°å¢ ${count} ç­†ã€‚`, 'success');
        
        // 6. æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦æ»¾å‹•è‡³åˆ—è¡¨é ‚éƒ¨
        if (inputEl) inputEl.value = '';
        const vaultContainer = document.getElementById('translation-vault-container');
        if (vaultContainer) vaultContainer.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (e) {
        console.error("ğŸ—£ï¸ ç¿»è­¯ç‡ƒæ–™è£œçµ¦å¤±æ•—:", e);
        showTranslationLocalMessage('âŒ æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æå…¥åº«', 'error');
    }
}

/** ğŸ“œ æ¸²æŸ“ç¿»è­¯å°ˆå±¬æ”¶è—åŒ£ï¼šæ‘ºç–Šå¼æª”æ¡ˆç¸½ç®¡ (v5.6.0)
 * ä¿®æ­£ï¼š
 * 1. é»æ“Šé¡åˆ¥æ¨™é¡Œå¯è‡ªç”±æ”¶æ”¾å…§å®¹ã€‚
 * 2. å¼•å…¥ window.vaultCollapseState è¿½è¹¤ç‹€æ…‹ï¼Œé˜²æ­¢é‡ç¹ªæ™‚è‡ªå‹•å½ˆé–‹ã€‚
 */
function renderTranslationVault() {
    const listContainer = document.getElementById('translation-vault-container');
    if (!listContainer) return;
    
    const vault = state.translationVault || [];

    // åˆå§‹åŒ–æ”¶æ”¾ç‹€æ…‹è¿½è¹¤å™¨ (è‹¥ä¸å­˜åœ¨)
    if (!window.vaultCollapseState) window.vaultCollapseState = {};

    if (vault.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-12 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-100">
                <p class="text-slate-300 italic text-xs uppercase tracking-widest font-black">Vault Empty</p>
            </div>`;
        return;
    }

    // ğŸŒŸ Step 1. é‚è¼¯åˆ†çµ„
    const groups = vault.reduce((acc, item) => {
        const cat = item.category || "ä¸€èˆ¬";
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(item);
        return acc;
    }, {});

    const catStyles = {
        "äº¤é€š": { color: "#3b82f6", icon: "ğŸš„" },
        "ç”¨é¤": { color: "#10b981", icon: "ğŸ±" },
        "ä½å®¿": { color: "#8b5cf6", icon: "ğŸ¨" },
        "è³¼ç‰©": { color: "#f59e0b", icon: "ğŸ›ï¸" },
        "é†«è—¥": { color: "#ef4444", icon: "ğŸ¥" },
        "ä¸€èˆ¬": { color: "#64748b", icon: "ğŸ’¬" }
    };

    // ğŸŒŸ Step 2. æ§‹å»º HTML
    let html = "";
    for (const [catName, items] of Object.entries(groups)) {
        const style = catStyles[catName] || catStyles["ä¸€èˆ¬"];
        const isCollapsed = window.vaultCollapseState[catName] === true;
        const arrowRotation = isCollapsed ? "" : "rotate-90";
        const contentDisplay = isCollapsed ? "hidden" : "";

        html += `
            <div class="mb-4 border-b border-gray-50 pb-2">
                <div onclick="toggleVaultCategory('${catName}')" 
                     class="flex items-center justify-between py-2 px-2 hover:bg-gray-50 rounded-xl cursor-pointer transition-all group">
                    <div class="flex items-center gap-3">
                        <svg class="w-3 h-3 text-gray-400 transition-transform duration-200 ${arrowRotation}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span class="text-lg">${style.icon}</span>
                        <h4 class="text-sm font-black text-slate-700">${catName}</h4>
                        <span class="text-[9px] bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full font-bold">${items.length}</span>
                    </div>
                    <div class="opacity-0 group-hover:opacity-100 text-[10px] text-gray-300 font-bold uppercase tracking-tighter">Click to Toggle</div>
                </div>

                <div id="vault-cat-${catName}" class="grid grid-cols-1 gap-2 mt-2 px-1 ${contentDisplay} animate-in fade-in slide-in-from-top-1">
                    ${items.map(t => `
                        <div class="group flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl shadow-sm hover:border-pink-200 hover:shadow-md transition-all duration-300">
                            <div class="flex-grow min-w-0">
                                <p class="text-[10px] font-bold text-gray-400 truncate mb-1">${t.q}</p>
                                <p class="text-sm font-black text-slate-800 leading-tight">${t.a}</p>
                                <p class="text-[10px] text-pink-400 font-mono font-bold mt-1 tracking-tight">${t.romaji}</p>
                            </div>
                            
                            <div class="flex items-center gap-1 ml-4 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                                <button onclick="event.stopPropagation(); playTTS('${t.a.replace(/'/g, "\\'")}')" 
                                        class="w-8 h-8 bg-slate-50 text-slate-400 rounded-lg flex items-center justify-center hover:bg-pink-500 hover:text-white transition-all">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                                </button>
                                <button onclick="event.stopPropagation(); deleteTranslationFromVault('${t.id}')" 
                                        class="w-8 h-8 text-slate-200 hover:text-red-500 flex items-center justify-center transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round"/></svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }

    listContainer.innerHTML = html;
}

/** ğŸ› ï¸ æ‘ºç–Šè§¸ç™¼å™¨ï¼šç®¡ç†æ”¶æ”¾ç‹€æ…‹ä¸¦é©…å‹• UI æ›´æ–° */
function toggleVaultCategory(catName) {
    if (!window.vaultCollapseState) window.vaultCollapseState = {};
    
    // åˆ‡æ›å¸ƒæ—å€¼
    window.vaultCollapseState[catName] = !window.vaultCollapseState[catName];
    
    // åŸ·è¡Œå±€éƒ¨é‡æ–°æ¸²æŸ“ (ç‚ºäº†ä¿æŒæ²å‹•ä½ç½®ï¼Œæˆ‘å€‘é‡æ–°åŸ·è¡Œæ¸²æŸ“ä½†å¯ä»¥å„ªåŒ–åªå‹• DOM)
    renderTranslationVault();
}

/** ğŸ›¡ï¸ ç‰©ç†æ•¸æ“šåŒæ­¥ä¿è­· */
async function syncTransportVault() {
    if (!dbManager.db) return;

    console.log("ğŸ“¡ æ­£åœ¨åŸ·è¡Œç‰©ç†æ•¸æ“šå›å¡«...");
    
    return new Promise((resolve) => {
        const tx = dbManager.db.transaction(['transport_store'], 'readonly');
        const store = tx.objectStore('transport_store');
        const request = store.getAll();

        request.onsuccess = () => {
            const data = request.result;
            if (data && data.length > 0) {
                // ğŸŒŸ é—œéµé»ï¼šå°‡ç‰©ç†è³‡æ–™å›å¡«è‡³å…¨åŸŸç‹€æ…‹
                window.state.transportVault = data; 
                console.log(`âœ… å›å¡«æˆåŠŸï¼šå·²åŒæ­¥ ${data.length} ç­†è·¯ç¶²è‡³è¨˜æ†¶é«”`);
            }
            resolve(data);
        };
    });
}

/**  å‡½æ•¸ï¼šå‹•æ…‹æ–‡å­—é¡è‰² */
function getTextColor(status) {
    return {
        'danger': 'text-red-600',
        'warning': 'text-yellow-700',
        'info': 'text-blue-600'
    }[status] || 'text-gray-500';
}

/** ğŸ§  è¤‡è£½ç¿»è­¯å°ˆç”¨ AI æŒ‡ä»¤ */
function copyTranslationAIPrompt() {
    const prompt = `ä½ æ˜¯ä¸€ä½æ—¥èªç¿»è­¯èˆ‡æ—…éŠå°ˆå®¶ã€‚è«‹æä¾› 5-8 å¥èˆ‡ã€Œæ—¥æœ¬æ—…éŠå¸¸ç”¨å°è©±ã€ç›¸é—œçš„èªå¥ï¼Œä¸¦ä»¥ JSON é™£åˆ—æ ¼å¼è¼¸å‡ºã€‚

ğŸš¨ æ ¼å¼è¦ç¯„ï¼š
1. è¼¸å‡ºç‚ºç´” JSONï¼Œä¸å«è§£é‡‹ã€‚
2. æ¬„ä½åŒ…å«ï¼šq (ä¸­æ–‡), a (æ—¥æ–‡), romaji (ç¾…é¦¬æ‹¼éŸ³), category (åˆ†é¡)ã€‚
3. åˆ†é¡åŒ…å«ï¼šäº¤é€šã€ç”¨é¤ã€è³¼ç‰©ã€é†«è—¥ã€‚

ç¯„ä¾‹ï¼š
[
  { "q": "é€™é™„è¿‘æœ‰è—¥å±€å—ï¼Ÿ", "a": "ã“ã®è¿‘ãã«è–¬å±€ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "romaji": "Kono chikaku ni yakkyoku wa arimasu ka?", "category": "é†«è—¥" }
]`;
    navigator.clipboard.writeText(prompt).then(() => {
        showTranslationLocalMessage('âœ… ç¿»è­¯ AI æŒ‡ä»¤å·²è¤‡è£½ï¼', 'success');
    });
}

/** ğŸ“¡ å±€éƒ¨è¨Šæ¯é¡¯ç¤º (ç¿»è­¯é å°ˆç”¨) */
function showTranslationLocalMessage(text, type = 'success') {
    const msgEl = document.getElementById('translation-local-msg');
    if (!msgEl) return;
    const colors = {
        success: 'bg-green-100 text-green-700 border border-green-200',
        error: 'bg-red-100 text-red-700 border border-red-200'
    };
    msgEl.className = `mb-4 p-3 rounded-xl text-xs font-black transition-all ${colors[type] || colors.success}`;
    msgEl.innerHTML = text;
    msgEl.style.display = 'block';
    setTimeout(() => msgEl.style.display = 'none', 3000);
}


/** ğŸ”Š æ’­æ”¾æ—¥æ–‡èªéŸ³ (å¼·åˆ¶é‡å•Ÿå¼·åŒ–ç‰ˆ) */
function speakJapanese(text) {
    if (!window.speechSynthesis) {
        showTranslationLocalMessage('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½', 'error');
        return;
    }

    // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå…ˆå–æ¶ˆæ‰€æœ‰æ­£åœ¨æ’éšŠçš„èªéŸ³ï¼Œé˜²æ­¢å¡æ­»
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    
    // ç²å–ç•¶å‰è¨­å‚™å¯ç”¨çš„èªéŸ³åŒ…
    const voices = window.speechSynthesis.getVoices();
    
    // å„ªå…ˆå°‹æ‰¾æ—¥æ–‡èªéŸ³åŒ…
    const jaVoice = voices.find(v => v.lang.includes('ja') || v.lang.includes('JP'));
    if (jaVoice) utterance.voice = jaVoice;

    utterance.lang = 'ja-JP';
    utterance.rate = 0.85; // ç¨å¾®æ”¾æ…¢é€Ÿåº¦
    utterance.pitch = 1.0;
    utterance.volume = 1.0; // ç¢ºä¿éŸ³é‡æ»¿æ ¼

    // ç›£è½éŒ¯èª¤å›å ±
    utterance.onerror = (event) => {
        console.error('SpeechSynthesisUtterance Error:', event.error);
    };

    window.speechSynthesis.speak(utterance);
}


/** ğŸ—‘ï¸ åˆªé™¤å–®ç­†ç¿»è­¯æ”¶è— (å°æ¥å°ˆå±¬ Vault)
 * ä¿®æ­£ï¼šå°‡åˆªé™¤å°è±¡æŒ‡å‘ state.translationVaultï¼Œä¸¦åŒæ­¥æ›´æ–°ç•«é¢
 */
async function deleteTranslationFromVault(id) {
    if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤æ”¶è—å—ï¼Ÿ')) return;

    // 1. å¾è¨˜æ†¶é«”ç‹€æ…‹ä¸­éæ¿¾
    const index = state.translationVault.findIndex(t => t.id === id);
    if (index > -1) {
        state.translationVault.splice(index, 1);
        
        // 2. åŒæ­¥è‡³ IndexedDB (ä¾ç…§æ‚¨çš„ dbManager é‚è¼¯)
        saveData(); 
        
        // 3. é‡æ–°æ¸²æŸ“å°ˆå±¬åˆ—è¡¨
        renderTranslationVault();
        
        // 4. ä½¿ç”¨å±€éƒ¨è¨Šæ¯å›å ±ï¼Œé¿å… Navbar é®æ“‹
        showTranslationLocalMessage('å·²å¾æ”¶è—åŒ£ç§»é™¤', 'success');
    }
}

/** ğŸ”Š èªéŸ³è½‰æ¥é ­ï¼šçµ±ä¸€ playTTS æŒ‡ä»¤ */
function playTTS(text) {
    console.log("ğŸ“¢ è§¸ç™¼èªéŸ³æ’­æ”¾:", text);
    // å‘¼å«æˆ‘å€‘å·²ç¶“å®šç¾©å¥½çš„æ ¸å¿ƒå‡½æ•¸
    if (typeof speakJapanese === 'function') {
        speakJapanese(text);
    } else {
        console.error("âŒ æ‰¾ä¸åˆ° speakJapanese å‡½æ•¸");
    }
}

/** ğŸŒ å‡½æ•¸ Aï¼šåœ°ç†æŒ‡ç´‹è‡ªå‹•å°ç„¦ (æè¿°å°å¡é¿è®“èˆ‡åŸå¸‚è‡ªç™’ç‰ˆ) 
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [ç²¾æº–éæ¿¾] æ’é™¤ style ç‚º description çš„é …ç›®ï¼Œç¢ºä¿è¨ˆç®—ä¸­å¿ƒé»æ™‚ä¸è¢«å¹²æ“¾ã€‚
 * 2. [åŸå¸‚å°ç„¦] è‹¥ç•¶æ—¥ç„¡å¯¦é«”æ™¯é»åº§æ¨™ï¼Œå„ªå…ˆè·³è½‰è‡³è©²å¤©è¨­å®šçš„åŸå¸‚ä¸­å¿ƒï¼Œè€Œéå›ºå®šåšå¤šã€‚
 * 3. [é˜²ç¦¦åç§»] è§£æ±ºåº§æ¨™ç‚ºç©ºæ™‚å¯èƒ½å°è‡´çš„åœ°åœ–é–ƒç¾æˆ–å®šä½è‡³å®œè˜­çš„å•é¡Œã€‚
 */
window.autoFocusTripMap = function() {
    const trip = state.trips[0];
    const day = state.trips[0].days[state.currentDayIndex];
    if (!day || !window.map) return;

    // ğŸŒŸ 1. æå–å¯¦é«”æ™¯é»åº§æ¨™ (éæ¿¾æ‰æè¿°å°å¡èˆ‡ç„¡åº§æ¨™é …)
    const coords = (day.schedules || [])
        .filter(s => s.style !== 'description') // ğŸ‘ˆ æ ¸å¿ƒä¿®æ­£ï¼šæè¿°å°å¡ä¸åƒèˆ‡åº§æ¨™è¨ˆç®—
        .filter(s => s.coords && s.coords.lat && s.coords.lng)
        .map(s => [parseFloat(s.coords.lng), parseFloat(s.coords.lat)]);

    if (coords.length > 0) {
        // âœ… æ¨¡å¼ Aï¼šæœ‰å¯¦é«”æ™¯é» -> å°ç„¦è‡³æ™¯é»ç¾¤èšä¸­å¿ƒ
        console.log(`ğŸ“¡ åœ°ç†å°ç„¦ä¸­ï¼šé–å®š ${day.city} çš„ ${coords.length} å€‹å¯¦é«”åº§æ¨™é»`);
        const center = [
            coords.reduce((a, b) => a + b[0], 0) / coords.length,
            coords.reduce((a, b) => a + b[1], 0) / coords.length
        ];

        // æ›´æ–°è¡Œç¨‹ä½ç½®æè¿°ï¼Œé˜²æ­¢ UI æ®˜ç•™èˆŠåœ°é»
        trip.location = (Array.isArray(day.city) ? day.city[0] : day.city) || "è‡ªå‹•å®šä½";
        
        window.map.jumpTo({ center, zoom: 12 });
    } else {
        // ğŸŒŸ 2. æ¨¡å¼ Bï¼šç„¡å¯¦é«”åº§æ¨™ (ä¾‹å¦‚æ•´å¤©éƒ½æ˜¯æè¿°å°å¡) -> å°ç„¦è‡³åŸå¸‚é è¨­ä¸­å¿ƒ
        const currentCity = Array.isArray(day.city) ? day.city[0] : (day.city || "");
        
        // å˜—è©¦å¾å…¨åŸŸåœ°ç†å­—å…¸ä¸­æ‰“æ’ˆè©²åŸå¸‚çš„çœŸç†åº§æ¨™
        const cityKey = Object.keys(window.GEO_REGIONS || {}).find(k => k.includes(currentCity) && !k.endsWith('_coords'));
        const cityPos = cityKey ? window.GEO_REGIONS[cityKey + "_coords"] : null;

        if (cityPos && cityPos.lng) {
            console.log(`ğŸ“ å¯¦é«”é»ä½ç¼ºå£ï¼šè‡ªå‹•å°ç„¦è‡³åŸå¸‚ä¸­å¿ƒ [${currentCity}]`);
            window.map.jumpTo({ center: [cityPos.lng, cityPos.lat], zoom: 11 });
        } else {
            // æœ€çµ‚ä¿åº•ï¼šå›æ­¸åšå¤šè»Šç«™ (é˜²æ­¢åœ°åœ–é£›å»å®œè˜­æˆ– 0,0)
            console.log("âš ï¸ ç„¡æ³•åˆ¤å®šåŸå¸‚åº§æ¨™ï¼ŒåŸ·è¡Œæœ€çµ‚ç‰©ç†ä¿åº• (åšå¤š)");
            window.map.jumpTo({ center: [130.4208, 33.5897], zoom: 11 });
        }
    }
};

/** ğŸ—“ï¸ å‡½æ•¸ Bï¼šå¤©æ•¸åˆ‡æ›é€£å‹• (å–ä»£åŸæœ¬ä¸å…·å°ä½èƒ½åŠ›çš„è³¦å€¼) */
window.changeDay = function(index) {
    state.currentDayIndex = index;
    
    // åˆ·æ–° UI
    if (state.currentSubView === 'itinerary') renderDayContent();
    else if (state.currentSubView === 'magazine') renderMagazineContent();

    // ğŸš€ é—œéµè£œå¼·ï¼šåˆ‡æ›å¾Œè‡ªå‹•è§¸ç™¼åœ°åœ–é£›å‘åº§æ¨™
    setTimeout(() => {
        window.autoFocusTripMap();
    }, 350);

    const trip = getCurrentTrip();
    if (trip) renderDayTabs(trip);
    saveData();
};

// ç¿»è­¯ç›¸é—œæ¨¡çµ„çµæŸ

/** ğŸ¬ çµ‚æ¥µè‡ªç™’ç‰ˆï¼šæ‡‰ç”¨ç¨‹å¼éåŒæ­¥åˆå§‹åŒ– (v4.6 æ——è‰¦å°ä½ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [ç‰©ç†å°ä½] å¼·åˆ¶ç¢ºä¿ Checklist ç£å€å„ªå…ˆè¼‰å…¥ï¼Œé˜²æ­¢é–‹æ©Ÿæ™‚é¡åˆ¥éºå¤±ã€‚
 * 2. [åŸå­å®ˆè¡›] åˆå§‹åŒ–å…¨ç¨‹é–å®š isTransportUpdatingï¼Œé˜²æ­¢å¯«å…¥ç«¶çˆ­ã€‚
 * 3. [è¦–åœ–è‡ªç™’] å„ªåŒ–åŸåœ°å¾©æ´»é‚è¼¯ï¼Œç¢ºä¿æ¢å¾©æ™‚åŒæ­¥é‡æ•´å­è¦–åœ–ç‹€æ…‹ã€‚
 * 4. [åœ°ç†é–ƒç¾] é–å®š 2000ms åŸ·è¡Œ autoFocusTripMapï¼Œç¢ºä¿åœ°åœ–å¼•æ“å®Œå…¨å•Ÿå‹•ã€‚
 */
async function init() {
    try {
        console.log("%cğŸ¬ ç³»çµ±å•Ÿå‹•ä¸­ï¼šåŸ·è¡Œå…¨ç‰©ç†åŒ–å°ä½æµç¨‹...", "color: #3b82f6; font-weight: bold;");

        // ğŸŒŸ 0. æ ¸å¿ƒç‹€æ…‹é ç†±èˆ‡ç‰©ç†æ›´æ–°é–å®š (Prevent race conditions during init)
        if (!window.state) window.state = { transportVault: [], trips: [], currentSubView: 'itinerary', theme: { primary: '#e91e63' } };
        window.isTransportUpdating = true; 

        // é ç†±èªéŸ³å¼•æ“
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = () => {
                console.log(`ğŸ”Š èªéŸ³å¼•æ“å°±ç·’ï¼šå…± ${window.speechSynthesis.getVoices().length} ç¨®èªè¨€åŒ…`);
            };
        }

        // ğŸŒŸ 1. ã€ç‰©ç†åŸºåº§å»ºç«‹ã€‘å»ºç«‹å¯¦é«”æˆ¿é–“ (IndexedDB v8)
        await dbManager.init();

        // ğŸŒŸ 2. ã€ç‰©ç†è³‡æ–™ç§»æ°‘ã€‘æ¬é‹éœæ…‹æŒ‡ç´‹ (åŒ…å« 15 ç­†ä¹å·åº§æ¨™èˆ‡ 35 ç­†è·¯ç¶²)
        if (typeof migrateDefinitionsToDB === 'function') {
            await migrateDefinitionsToDB();
        }

        // ğŸŒŸ 3. ã€æ•¸æ“šæ·±åº¦æ‰“æ’ˆã€‘å¾ç‰©ç†ç£å€æ¢å¾© main_state èˆ‡å„åˆ†é è³‡ç”¢
        // é€™æ˜¯ç¢ºä¿ API KEY èˆ‡è¡Œç¨‹è³‡æ–™æ¢å¾©çš„é—œéµæ­¥é©Ÿ
        await loadData(); 

        // ğŸŒŸ 4. ã€åœ°ç†æŒ‡ç´‹æ ¡æº–ã€‘å›å¡«å€åŸŸåˆ¥åèˆ‡å¯¦é«”åº§æ¨™
        if (typeof syncGeoRegionsToMemory === 'function') {
            await syncGeoRegionsToMemory();
        }

        // ğŸŒŸ 5. ã€æ¬Šå¨ä»²è£ã€‘äºŒæ¬¡äº¤å‰æ¯”å°ï¼Œç¢ºä¿è¨˜æ†¶é«”å¤§è…¦èˆ‡ç£å€ 100% åŒæ­¥
        const [physTrans, physMatrix] = await Promise.all([
            dbManager.getAll('transport_store'),
            dbManager.getAll('matrix_store')
        ]);

        if (physTrans && physTrans.length > 0) {
            window.state.transportVault = physTrans;
            state.transportVault = physTrans;
        }
        
        if (physMatrix && physMatrix.length > 0) {
            window.TRAVEL_TIME_MATRIX = physMatrix.reduce((acc, curr) => {
                if (curr.routeKey) acc[curr.routeKey] = curr.time;
                return acc;
            }, {});
        }

        // ğŸŒŸ 6. ã€èªæ„å¤§è…¦é‡é‘„ã€‘åˆ·æ–° 490 ç­†è³‡ç”¢çš„åˆ†é¡æŒ‡ç´‹
        if (typeof syncBucketToGlobalDict === 'function') {
            await syncBucketToGlobalDict();
            console.log("ğŸ§  èªæ„å¤§è…¦ç‰©ç†æŒ‡ç´‹å°ä½å®Œæˆ");
        }

        // ğŸŒŸ 7. ã€æ™‚é–“è»¸å°é½Šã€‘å¼·åˆ¶é‡æ–°è¨ˆç®—æ‰€æœ‰å¤©æ•¸çš„è¡çªè¨ºæ–·
        if (window.state.trips?.length > 0) {
            window.state.trips.forEach(trip => {
                trip.days?.forEach(day => {
                    if (typeof recalculateScheduleTimes === 'function') recalculateScheduleTimes(day);
                });
            });
        }

        // ğŸŒŸ 8. âœ¨ ã€åŸåœ°å¾©æ´»è¨ˆç•«ã€‘æ¢å¾©é‡å•Ÿå‰çš„è¦–åœ–èˆ‡æ¨™ç±¤ä½ç½®
        const recoveryTripId = localStorage.getItem('reboot_recovery_trip');
        const recoveryView = localStorage.getItem('reboot_recovery_view');
        const recoveryTab = localStorage.getItem('reboot_recovery_tab'); 

        if (recoveryTripId && state.trips.some(t => t.id === recoveryTripId)) {
            window.state.currentTripId = recoveryTripId;
            window.state.currentSubView = recoveryView || 'itinerary';
            
            if (window.state.currentSubView === 'settings' && recoveryTab) {
                window.activeSettingTab = recoveryTab;
            }
            
            // æ¸…é™¤æ¢å¾©æ¨™è¨˜ï¼Œç¢ºä¿ä¸‹æ¬¡å•Ÿå‹•ç‚ºé è¨­ç‹€æ…‹
            localStorage.removeItem('reboot_recovery_trip');
            localStorage.removeItem('reboot_recovery_view');
            localStorage.removeItem('reboot_recovery_tab');
        }

        // ğŸŒŸ 9. ã€è¦–è¦ºç‰©ç†æ¿€æ´»ã€‘è§£é–å­˜æª”ä¸¦åŸ·è¡Œæ¸²æŸ“æµ
        window.isTransportUpdating = false; // ğŸ”“ ç‰©ç†é‡‹æ”¾é–ï¼Œç¾åœ¨å¯ä»¥é€²è¡Œæ­£å¸¸å­˜æª”

        if (window.state.currentTripId) {
            // A. å»ºç«‹ç‰©ç† Layout å¤–æ®¼
            if (typeof setupTripLayout === 'function') setupTripLayout(); 
            
            // B. å‘¼å«å°èˆªå®ˆè¡›åŸ·è¡Œç²¾æº–æ¸²æŸ“
            const subView = window.state.currentSubView;
            
            // åŸ·è¡Œ switchSubView ä»¥å»ºç«‹å„åŠŸèƒ½çš„ DOM ç’°å¢ƒ
            if (typeof switchSubView === 'function') {
                switchSubView(subView);
            } else {
                // å›é€€ä¿åº•æ¸²æŸ“
                if (typeof renderTripDetail === 'function') renderTripDetail();
                if (typeof renderDayContent === 'function') renderDayContent();
            }
        } else {
            // ç„¡è¡Œç¨‹æ™‚é¡¯ç¤ºè¡Œç¨‹æ¸…å–®
            if (typeof renderTripList === 'function') renderTripList();
        }

        // ğŸŒŸ 10. âœ¨ ã€é–‹æ©Ÿè‡ªç™’å°ç„¦ã€‘è‡ªå‹•é–ƒç¾è‡³è¡Œç¨‹ä¸­å¿ƒåº§æ¨™
        setTimeout(() => {
            console.log("%cğŸ åŸ·è¡Œé–‹æ©Ÿåœ°ç†æŒ‡ç´‹å°ä½ï¼šé–ƒç¾ä¹å·ä½ç½®...", "color: #f59e0b; font-weight: bold;");
            if (typeof window.autoFocusTripMap === 'function') {
                window.autoFocusTripMap();
            }
        }, 2000);

        console.log("%câœ… å…¨ç³»çµ±åˆå§‹åŒ–å®Œç•¢ï¼šç‰©ç†å¤§ä¸€çµ±å¼•æ“ç©©å®šé‹è½‰ä¸­ã€‚", "color: #10b981; font-weight: bold;");

    } catch (err) {
        window.isTransportUpdating = false; 
        console.error("âŒ ç³»çµ±å•Ÿå‹•éˆæ¢æ–·è£‚:", err);
        
        // å´©æ½°è‡ªç™’é‡å°å‘
        if (typeof renderTripList === 'function') renderTripList();
        
        if (err.name === 'VersionError') {
            showMessage("è³‡æ–™åº«ç‰ˆæœ¬è¡çªï¼Œæ­£å˜—è©¦è‡ªå‹•ä¿®å¾©...", "error");
            setTimeout(() => location.reload(), 2000);
        }
    }
}

/** ğŸ› ï¸ æ•¸æ“šèˆ‡é›²ç«¯ä»‹é¢æœ€å¾Œè£œå¼· */
function initDataHub() {
    // ç›£è½æ‰€æœ‰å­˜æª”å‹•ä½œï¼ŒåŒæ­¥æ›´æ–° JSON Debug å€åŸŸ
    const originalSaveData = saveData;
    window.saveData = async function() {
        await originalSaveData();
        const exportEl = document.getElementById('json-export-output');
        if (exportEl) {
            exportEl.value = JSON.stringify(state, null, 2);
        }
    };
}

// åœ¨ init() çš„æœ€å¾Œä¸€è¡Œå‘¼å«
// initDataHub();

// ğŸš€ å”¯ä¸€åŸ·è¡Œå…¥å£
document.addEventListener('DOMContentLoaded', () => {
    init().catch(err => {
        console.error("Fatal Error during init:", err);
        if (typeof showMessage === 'function') {
            showMessage("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†", "error");
        }
    });
});

/**
 * è³‡æ–™é·ç§»æ¨¡çµ„ï¼šå¾ LocalStorage æ¬ç§»åˆ° IndexedDB
 */
async function migrateDataIfNeeded() {
    const oldData = localStorage.getItem(APP_ID);
    if (oldData) {
        console.log("ğŸšš åµæ¸¬åˆ°èˆŠç‰ˆ LocalStorage è³‡æ–™ï¼Œé–‹å§‹é·ç§»...");
        try {
            const parsedOldData = JSON.parse(oldData);
            // å°‡èˆŠè³‡æ–™åŒ…è£æˆæ–°çš„ main_state æ ¼å¼
            const dataToStore = {
                id: 'main_state',
                trips: parsedOldData.trips || [],
                theme: parsedOldData.theme || state.theme,
                totalBudget: parsedOldData.totalBudget || 50000,
                currency: parsedOldData.currency || 'JPY',
                shoppingList: parsedOldData.shoppingList || [],
                emergencyContacts: parsedOldData.emergencyContacts || state.emergencyContacts,
                aiDayConfig: parsedOldData.aiDayConfig || { preferredTransport: 'train' },
                lastUpdated: new Date().toISOString(),
                migratedFromLS: true
            };
            
            await dbManager.save('private_store', dataToStore);
            // é·ç§»æˆåŠŸå¾Œï¼Œå»ºè­°ä¿ç•™ LS è³‡æ–™ä¸€é™£å­ï¼Œæˆ–æ”¹åå‚™ä»½ï¼Œä¸è¦ç›´æ¥åˆªé™¤
            localStorage.setItem(APP_ID + '_MIGRATED', oldData);
            localStorage.removeItem(APP_ID); 
            console.log("âœ… è³‡æ–™é·ç§»å®Œæˆ");
            return true;
        } catch (e) {
            console.error("âŒ é·ç§»å¤±æ•—:", e);
        }
    }
    return false;
}


/**
 * è¼”åŠ©å‡½æ•¸ï¼šé˜»æ­¢äº‹ä»¶å‘ä¸Šå†’æ³¡ï¼Œé˜²æ­¢èª¤è§¸ç™¼æ¨¡æ…‹æ¡†çš„èƒŒæ™¯é—œé–‰
 * @param {Event} event 
 */
function stopPropagation(event) {
    if (event.stopPropagation) {
        event.stopPropagation();
    } else if (event.cancelBubble !== undefined) {
        event.cancelBubble = true;
    }
};

/** * è¼”åŠ©å‡½å¼ï¼šæ ¹æ“šåŸå¸‚é™£åˆ—é•·åº¦ç”Ÿæˆ Day Header å’Œ Tab çš„åŸå¸‚é¡¯ç¤ºå­—ä¸²ã€‚
 * @param {string[]} cityArray - åŸå¸‚åç¨±é™£åˆ—
 * @returns {string} - æ ¼å¼åŒ–å¾Œçš„å­—ä¸² (e.g., "(å°åŒ—å¸‚ | æ–°åŒ—å¸‚)" æˆ– "(å°åŒ—å¸‚++)" æˆ– "")
 */
function getCityDisplayForHeader(cityArray) {
    if (!cityArray || cityArray.length === 0) {
        return ''; // ç©ºé™£åˆ—æ™‚ä¸é¡¯ç¤ºæ‹¬è™Ÿ
    }

    const cityCount = cityArray.length;
    const primaryCity = cityArray[0];

    if (cityCount === 1) {
        return ` (${primaryCity})`;
    } else if (cityCount === 2) {
        // å…©å€‹åŸå¸‚æ™‚é¡¯ç¤º City1 | City2
        return ` (${cityArray.join(' | ')})`; 
    } else if (cityCount >= 3) {
        // ä¸‰å€‹æˆ–æ›´å¤šåŸå¸‚æ™‚é¡¯ç¤º City1++
        return ` (${primaryCity}++)`;
    }

    return ` (${cityArray.join(' | ')})`;
}

/** å£“ç¸®åœ–ç‰‡è‡³æ¥µä½ K æ•¸ä»¥ç¯€çœ LocalStorage ç©ºé–“ */
async function compressImage(base64Str) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64Str;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let width = img.width;
            let height = img.height;

            // é™åˆ¶æœ€å¤§å¯¬åº¦ç‚º 800px
            const maxSide = 800;
            if (width > maxSide || height > maxSide) {
                if (width > height) {
                    height = (maxSide / width) * height;
                    width = maxSide;
                } else {
                    width = (maxSide / height) * width;
                    height = maxSide;
                }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            // ä½¿ç”¨ JPEG 0.5 ç•«è³ªé€²è¡Œå¼·åŠ›å£“ç¸®
            resolve(canvas.toDataURL('image/jpeg', 0.5));
        };
    });
}

/** ä¿®æ­£ç‰ˆï¼šç¢ºä¿èƒ½æ­£ç¢ºæ‰¾åˆ°ä¸¦æ›´æ–°ç…§ç‰‡æ•¸æ“š */
function triggerPhotoUpload(scheduleId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                showMessage('æ­£åœ¨è—è¡“åŒ–è™•ç†ç…§ç‰‡...', 'info');
                
                // 1. å£“ç¸®åœ–ç‰‡
                const compressed = await compressImage(event.target.result);
                
                // 2. åœ¨å…¨åŸŸ state ä¸­å°‹æ‰¾å°æ‡‰è¡Œç¨‹
                let found = false;
                state.trips.forEach(trip => {
                    trip.days.forEach(day => {
                        const schedule = day.schedules.find(s => s.id === scheduleId);
                        if (schedule) {
                            schedule.photo = compressed; // ç›´æ¥å­˜å…¥ Base64
                            found = true;
                        }
                    });
                });

                if (found) {
                    saveData();
                    renderMagazineContent(); // ç«‹å³é‡æ–°æ¸²æŸ“ç•«é¢
                    showMessage('ç…§ç‰‡ä¸Šå‚³ä¸¦å·²å¥—ç”¨é¢¨æ ¼', 'success');
                }
            } catch (err) {
                console.error("Upload error:", err);
                showMessage('ç…§ç‰‡è™•ç†å¤±æ•—', 'error');
            }
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

function getCategoryStyle(category) {
    const styles = {
        'transport': { bg: 'bg-blue-100', text: 'text-blue-700', label: 'äº¤é€š' },
        'food': { bg: 'bg-orange-100', text: 'text-orange-700', label: 'é£²é£Ÿ' },
        'lodging': { bg: 'bg-purple-100', text: 'text-purple-700', label: 'ä½å®¿' },
        // --- ä¿®æ­£ï¼šæ´»å‹•æ”¹ç‚ºç«ç‘°ç²‰ ---
        'activity': { bg: 'bg-rose-50', text: 'text-rose-600', label: 'æ´»å‹•', border: 'border-rose-pink' },
        'shopping': { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'è³¼ç‰©' },
        'other': { bg: 'bg-gray-100', text: 'text-gray-700', label: 'å…¶ä»–' }
    };
    return styles[category] || styles['other'];
}

// æ ¸å¿ƒï¼šå°‡ AI æ–‡å­—ä¸­çš„å•†å“æ¨™ç±¤è½‰æ›ç‚ºå¯é»æ“Šæ¨™ç±¤
function parseAIPlusContent(text) {
    if (!text) return "";
    
    // æ­£å‰‡è¡¨é”å¼ï¼šå°‹æ‰¾ [[å•†å“åç¨±]] ä¸¦è½‰æ›
    // ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•åœ¨è³‡æ–™ä¸­åŠ å…¥é€™é¡æ¨™è¨˜ï¼Œæˆ–è®“ AI ç”¢ç”Ÿæ™‚è‡ªå‹•å¸¶å…¥
    return text.replace(/\[\[(.*?)\]\]/g, (match, itemName) => {
        return `
            <span class="ai-shopping-tag cursor-pointer inline-flex items-center px-2 py-0.5 mx-1 rounded-md bg-cyan-50 border border-cyan-200 text-cyan-700 font-bold hover:bg-cyan-100 transition-all active:scale-95 shadow-sm" 
                  onclick="quickAddToShoppingList('${itemName}', event)">
                ğŸ›ï¸ ${itemName}
                <b class="ml-1 text-[9px] bg-cyan-500 text-white px-1 rounded shadow-sm">AI+</b>
            </span>
        `;
    });
}

/**
 * å¿«é€ŸåŠ å…¥è³¼ç‰©æ¸…å–®å‡½å¼ (ä¿®æ­£ç‰ˆ)
 */
function quickAddToShoppingList(fullTitle, priceStr, storeName, event) {
    // 1. é˜²æ­¢é»æ“Šæ¨™ç±¤æ™‚åŒæ™‚è§¸ç™¼æ¨¡æ…‹æ¡†é—œé–‰
    if (event) event.stopPropagation(); 
    
    try {
        // 2. æª¢æŸ¥ state.shoppingList æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç„¡å‰‡åˆå§‹åŒ–
        if (!state.shoppingList) {
            state.shoppingList = [];
        }

        // 3. å»ºç«‹å•†å“ç‰©ä»¶ (ä½¿ç”¨ UUID æˆ–éš¨æ©Ÿ ID)
        const newItem = {
            id: typeof generateUUID === 'function' ? generateUUID() : 'item-' + Date.now(),
            name: fullTitle,      // å­˜å…¥å®Œæ•´åç¨±
            quantity: 1,          // é è¨­æ•¸é‡ç‚º 1
            price: priceStr,      // å­˜å…¥ AI æä¾›çš„åƒ¹æ ¼æè¿°
            store: storeName,     // å­˜å…¥å•†åº—åç¨±
            checked: false,       // é è¨­ç‚ºæœªæ¡è³¼
            isAI: true            // æ¨™è¨˜ç‚º AI å»ºè­°é …ç›®
        };

        // 4. å°‡æ–°é …ç›®åŠ å…¥å…¨åŸŸç‹€æ…‹ä¸¦å„²å­˜
        state.shoppingList.push(newItem);
        saveData(); // ç¢ºä¿å‘¼å«äº†æ‚¨çš„å„²å­˜å‡½å¼

        // 5. è¦–è¦ºå›é¥‹ï¼šå°‡æ¨™ç±¤è®Šæˆç¶ è‰²ï¼Œæç¤ºå·²æˆåŠŸåŠ å…¥
        const el = event.currentTarget;
        if (el) {
            el.style.transition = 'all 0.3s ease';
            el.style.backgroundColor = '#f0fdf4'; // æˆåŠŸç¶ èƒŒæ™¯
            el.style.borderColor = '#bbf7d0';     // æˆåŠŸç¶ é‚Šæ¡†
            el.style.color = '#15803d';           // æ·±ç¶ æ–‡å­—
            el.innerHTML = `âœ… å·²åŠ å…¥æ¸…å–® <b class="ml-1 text-[8px] bg-green-500 text-white px-1 rounded shadow-sm">ADDED</b>`;
            el.onclick = null; // ç§»é™¤é»æ“Šäº‹ä»¶é˜²æ­¢é‡è¤‡åŠ å…¥
        }

        // 6. é¡¯ç¤ºå½ˆå‡ºè¨Šæ¯
        if (typeof showMessage === 'function') {
            const itemNameOnly = fullTitle.includes(' - ') ? fullTitle.split(' - ')[1] : fullTitle;
            showMessage(`âœ¨ å·²å°‡ã€Œ${itemNameOnly}ã€åŠ å…¥è³¼ç‰©æ¸…å–®ï¼`, 'success');
        }

        // 7. è‹¥ç•¶å‰æ­£å¥½åœ¨è³¼ç‰©æ¸…å–®é é¢ï¼Œå‰‡ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        if (state.currentSubView === 'shopping' && typeof renderShoppingList === 'function') {
            renderShoppingList();
        }

    } catch (error) {
        console.error("åŠ å…¥è³¼ç‰©æ¸…å–®å¤±æ•—:", error);
        if (typeof showMessage === 'function') showMessage('åŠ å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¨‹å¼é‚è¼¯', 'error');
    }
}


/**
 * è§£æ AI+ å…§å®¹ä¸¦è½‰æ›ç‚ºäº’å‹•æ¨™ç±¤ (v1.1.1 å®Œæ•´å°å…¥å¼·åŒ–ç‰ˆ)
 */
function parseAIPlusInteractiveContent(text) {
    if (!text) return "";
    
    // é è™•ç†ï¼šå°‡ Markdown ç²—é«”è½‰ç‚º HTML
    let cleanedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    // è§£æ [[åœ°æ¨™ï¼šå•†å“ | åƒ¹æ ¼]] äº’å‹•æ¨™ç±¤
    return cleanedText.replace(/\[\[(.*?)(?:\ï¼š|\:)(.*?)\|(.*?)\]\]/g, (match, store, itemName, price) => {
        const s = store.trim();
        const n = itemName.trim();
        const p = price.trim();
        const full = `${s} - ${n}`;
        
        // è½‰ç¾©å­—ä¸²ä¸­çš„å–®å¼•è™Ÿï¼Œé˜²æ­¢ onclick èªæ³•å‡ºéŒ¯
        const safeFull = full.replace(/'/g, "\\'");
        const safePrice = p.replace(/'/g, "\\'");
        const safeStore = s.replace(/'/g, "\\'");

        return `
            <span class="ai-plus-tag-shiny cursor-pointer inline-flex items-center px-2 py-1 mx-0.5 my-1 rounded-md active:scale-95 shadow-sm transition-all hover:brightness-95" 
                  onclick="quickAddToShoppingList('${safeFull}', '${safePrice}', '${safeStore}', event)">
                ğŸ›ï¸ <span class="mx-1">${n}</span>
                <b class="text-[8px] opacity-70 tracking-tighter uppercase font-bold">AI+</b>
            </span>
        `;
    });
}


/**
 * å¿«é€ŸåŠ å…¥è³¼ç‰©æ¸…å–®å‡½å¼ (å®Œæ•´å°å…¥ä¿®å¾©ç‰ˆ)
 * ä¿®æ­£ï¼šèªæ³•é–‰åˆéŒ¯èª¤ã€try-catch çµæ§‹ã€å­—ä¸²è§£æå®‰å…¨æ©Ÿåˆ¶
 */
function quickAddToShoppingList(fullTitle, priceStr, storeName, event) {
    if (event) event.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¸ç™¼æ¨¡æ…‹æ¡†é—œé–‰
    
    try {
        // 1. ç¢ºä¿å…¨åŸŸè³¼ç‰©æ¸…å–®é™£åˆ—å­˜åœ¨ (é˜²å‘†)
        if (!state.shoppingList) {
            state.shoppingList = [];
        }

        // 2. å»ºç«‹æ–°å•†å“ç‰©ä»¶
        const newItem = {
            id: typeof generateUUID === 'function' ? generateUUID() : crypto.randomUUID(),
            name: fullTitle || "æœªå‘½åå•†å“",
            quantity: 1,
            price: priceStr || "åƒ¹æ ¼æœªå®š",
            store: storeName || "æœªçŸ¥åœ°é»",
            checked: false,
            isAI: true
        };

        // 3. å¯«å…¥å…¨åŸŸç‹€æ…‹é™£åˆ—
        state.shoppingList.push(newItem);

        // 4. ç«‹å³åŒæ­¥åˆ° LocalStorage
        if (typeof saveData === 'function') {
            saveData();
        }

        // 5. è¦–è¦ºå›é¥‹ï¼šè®Šæ›´æ¨™ç±¤å¤–è§€ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å·²åŠ å…¥æˆåŠŸ
        const el = event.currentTarget || event.target;
        if (el && el.classList.contains('ai-plus-tag-shiny')) {
            el.classList.remove('ai-plus-tag-shiny');
            el.style.transition = 'all 0.3s ease';
            el.style.backgroundColor = '#f0fdf4'; // æˆåŠŸç¶ è‰²èƒŒæ™¯
            el.style.borderColor = '#bbf7d0';     // æ·ºç¶ é‚Šæ¡†
            el.style.color = '#15803d';           // æ·±ç¶ æ–‡å­—
            el.innerHTML = `âœ… å·²åŠ å…¥ <b class="ml-1 text-[8px] bg-green-500 text-white px-1 rounded shadow-sm">ADDED</b>`;
            el.onclick = null; // é—œé–‰é»æ“ŠåŠŸèƒ½é¿å…é‡è¤‡åŠ å…¥
        }

        // 6. é¡¯ç¤ºè¨Šæ¯æç¤ºï¼šå®‰å…¨è§£ææ¨™é¡Œ
        // å¦‚æœ fullTitle æ˜¯ "åœ°é» - å•†å“"ï¼Œå‰‡å–å‡ºå•†å“åï¼›å¦å‰‡é¡¯ç¤ºå…¨æ–‡
        const displayName = fullTitle.includes(' - ') ? fullTitle.split(' - ')[1].trim() : fullTitle;
        if (typeof showMessage === 'function') {
            showMessage(`âœ¨ å·²å°‡ã€Œ${displayName}ã€åŠ å…¥è³¼ç‰©æ¸…å–®ï¼`, 'success');
        }

        // 7. å¦‚æœç•¶å‰æ­£é–‹å•Ÿè³¼ç‰©åˆ†é ï¼Œå‰‡å³æ™‚æ›´æ–°åˆ—è¡¨
        if (state.currentSubView === 'shopping' && typeof renderShoppingList === 'function') {
            renderShoppingList();
        }

    } catch (error) {
        console.error("å¿«é€ŸåŠ å…¥æ¸…å–®å‡ºéŒ¯:", error);
        if (typeof showMessage === 'function') {
            showMessage('åŠ å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™çµæ§‹', 'error');
        }
    }
}

/** ğŸ¨ æ¸²æŸ“å‚™é¸å°èˆªæ¨™ç±¤ (v5.7 çµ‚æ¥µç‰©ç†é–å®šç‰ˆ) 
 * ä¿®æ­£é»ï¼š
 * 1. [ç‰©ç†å¯¬åº¦ç¡¬é–]ï¼šä¸å†ä½¿ç”¨ autoï¼Œæ”¹ç”¨å›ºå®š 75px å¯¬åº¦ï¼Œç¢ºä¿æ‰€æœ‰æ¨™ç±¤å¯¬åº¦çµ•å°ä¸€è‡´ã€‚
 * 2. [ç¦æ­¢æ›è¡Œ]ï¼šå¼·åˆ¶ white-space: nowrap ä¸¦ç¸®æ¸›å…§è·ï¼Œé˜²æ­¢æ–‡å­—æ’é–‹æŒ‰éˆ•ã€‚
 * 3. [æ»¾å‹•å€è£œå¼·]ï¼šåœ¨å®¹å™¨æœ€å³å´åŠ å…¥ä¸€å€‹å›ºå®šå¯¬åº¦çš„é€æ˜ Spacerï¼Œé˜²æ­¢æœ€å¾Œä¸€å€‹æŒ‰éˆ•è¢«é‚Šç·£åˆ‡æ–·ã€‚
 */
function renderBucketTabs() {
    const listContainer = document.getElementById('bucket-tabs-list');
    if (!listContainer) return;

    const mainCategories = [
        { id: 'å…¨éƒ¨', icon: 'ğŸŒ' }, { id: 'é£Ÿ', icon: 'ğŸ±' }, { id: 'é†«', icon: 'ğŸ¥' },
        { id: 'è¡Œ', icon: 'ğŸš—' }, { id: 'ä½', icon: 'ğŸ¨' }, { id: 'ç©', icon: 'ğŸ¡' }, { id: 'è³¼', icon: 'ğŸ›ï¸' }
    ];

    let html = `
        <div class="flex items-center justify-start gap-2 overflow-x-auto pb-4 no-scrollbar scroll-smooth px-4" 
             style="display: flex !important; flex-wrap: nowrap !important; width: 100%; -webkit-overflow-scrolling: touch;">
            
            ${mainCategories.map(cat => {
                const isActive = state.activeParentTab === cat.id;
                return `
                    <button onclick="setParentTab('${cat.id}')" 
                            class="flex-none flex items-center justify-center gap-1 rounded-2xl text-[11px] font-black transition-all border active:scale-95 ${
                                isActive ? 'theme-pink text-white border-transparent shadow-md' : 'bg-white text-slate-500 border-slate-100'
                            }"
                            style="width: 75px !important; min-width: 75px !important; height: 34px !important; flex-shrink: 0 !important; white-space: nowrap !important; padding: 0 !important;">
                        <span class="text-sm" style="flex-shrink: 0;">${cat.icon}</span> 
                        <span class="tracking-tighter" style="flex-shrink: 0;">${cat.id}</span>
                    </button>
                `;
            }).join('')}

            <button onclick="runSystemSelfHealing()" 
                    class="flex-none flex items-center justify-center bg-amber-50 text-amber-500 border border-amber-100 rounded-xl shadow-sm active:scale-90 transition-all"
                    style="width: 34px !important; height: 34px !important; flex-shrink: 0 !important; margin-left: 4px;">
                <span style="font-size: 14px;">âš™ï¸</span>
            </button>

            <div style="width: 24px; flex-shrink: 0;"></div>
        </div>
    `;
    listContainer.innerHTML = html;
}

/** ğŸ› ï¸ åˆ‡æ›çˆ¶ç³»å¤§é¡ (v3.0 è‡ªç™’ç‰ˆ) */
function setParentTab(parentName) {
    // 1. ç‰©ç†ç‹€æ…‹æ›´æ–°
    state.activeParentTab = parentName;
    state.activeBucketTab = 'å…¨éƒ¨'; // âœ¨ æ¨™è¨˜ï¼šé›–ç„¶ UI ä¸é¡¯ç¤ºå‰¯æ¨™ç±¤ï¼Œä½†é‚è¼¯å±¤é‡ç½®ç‚ºå…¨éƒ¨ä»¥ç¢ºä¿éæ¿¾å…¨é€š

    // 2. ğŸŒŸ æœå°‹è‡ªç™’ï¼šåˆ‡æ›åˆ†é¡æ™‚ç‰©ç†å¼·åˆ¶å°‡åˆ†é æ­¸é›¶
    if (window.bucketPagination) {
        window.bucketPagination.currentPage = 1;
    }

    // 3. åŸ·è¡Œé‡ç¹ªï¼šåŒæ™‚æ›´æ–° Tabs é«˜äº®èˆ‡ Items éæ¿¾çµæœ
    renderBucketItems(true); 
    
    console.log(`ğŸ¯ åˆ†å€å°ä½ï¼š${parentName} | æœå°‹æ¨¡å¼ï¼šéˆæ•ç©¿é€`);
}

/** ğŸ” å£è¢‹åå–®å»£åŸŸæœå°‹è™•ç† (v8.0) */
function handleBucketSearch(query) {
    const q = query.trim().toUpperCase();
    state.bucketSearchTerm = q;

    // ğŸŒŸ æœå°‹è‡ªç™’ï¼šè¼¸å…¥å³é‡ç½®åˆ†é ï¼Œé˜²æ­¢æœåˆ°çµæœå»åœåœ¨ç©ºç™½é 
    if (window.bucketPagination) {
        window.bucketPagination.currentPage = 1;
    }

    // åŸ·è¡Œæ¸²æŸ“ (false: ä¸é‡ç¹ª Tabs ä»¥å…æ‰‹æ©Ÿç«¯ Input å¤±ç„¦)
    renderBucketItems(false); 
}


/** * ç•¶ä½¿ç”¨è€…é¸æ“‡æŸä¸€é¢¨æ ¼å¾Œçš„æ·±åº¦è¦åŠƒå‡½æ•¸ (å…¨çƒé€šç”¨ç‰ˆ v2.0) 
 */
async function generateFullSuite(originalId, style) {
    const day = getCurrentDay();
    const schedule = day.schedules.find(s => s.id === originalId);
    if (!day || !schedule) return;

    // å–å¾—ç•¶å‰æ’å®šçš„åŸå¸‚åç¨± (å¦‚æœæœ‰å¤šå€‹å–ç¬¬ä¸€å€‹)
    const currentCity = (Array.isArray(day.city) && day.city.length > 0) ? day.city[0] : "ç•¶åœ°";

    // 1. é¡¯ç¤ºç²¾ç·»çš„ AI è¼‰å…¥å‹•ç•«
    showAILoadingUI(style);

    // 2. çµ„è£å…¨çƒé€šç”¨çš„ Prompt
    const prompt = `ä½ ç¾åœ¨æ˜¯ã€Œ${currentCity}ã€åœ¨åœ°çš„å°ˆæ¥­å°éŠã€‚
ç›®å‰èµ·é»æ˜¯ã€Œ${schedule.name}ã€ï¼Œä½¿ç”¨è€…é¸æ“‡äº†ã€Œ${style}ã€é¢¨æ ¼çš„å‘¨é‚Šå»¶ä¼¸è¡Œç¨‹ã€‚
è«‹ä»¥æ­¤èµ·é»ç‚ºä¸­å¿ƒï¼Œè¦åŠƒ 3 å€‹å‘¨é‚Š 15 åˆ†é˜è»Šç¨‹/æ­¥ç¨‹å…§çš„å»¶ä¼¸æ™¯é»æˆ–æ´»å‹•ã€‚

### ğŸš¨ è¡Œç¨‹è¦æ±‚ï¼š
1. **äº¤é€šå‹•ç·š**: å¿…é ˆæ ¹æ“š ${currentCity} çš„å¯¦éš›äº¤é€šç‹€æ³è¨ˆç®—ç²¾æº–æ™‚é–“ï¼Œä¸¦ä»¥ style: "transport" ç¨ç«‹æ’å…¥æ’ç¨‹é …ç›®ã€‚
2. **æ·±åº¦å…§å®¹**: æ¯å€‹åœ°é»çš„ aiPlus æ¬„ä½éœ€æ’°å¯«ç´„ 150 å­—ï¼ŒåŒ…å«è©²è™•çš„æ–‡åŒ–èƒŒæ™¯ã€éš±è—çœ‹é»æˆ–è©²åœ‹/è©²åœ°å€å¿…é»å¿…è²·å»ºè­°ã€‚
3. **äº’å‹•æ¨™è¨˜**: æåˆ°ç•¶åœ°ç‰¹ç”¢æˆ–å¿…è²·ç‰©å“æ™‚ï¼Œè«‹å‹™å¿…ä½¿ç”¨ [[å•†åº—æˆ–åœ°é»ï¼šå•†å“å | é ä¼°åƒ¹æ ¼]] æ ¼å¼ä»¥è§¸ç™¼ç³»çµ±æ¨™ç±¤ã€‚
4. **èªè¨€**: å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚

è«‹å›å‚³ç²¾æº–ä¸”ç¬¦åˆ Schema çš„ JSON é™£åˆ—ã€‚`;

    try {
        // å‘¼å«æ‚¨ç¾æœ‰çš„ API è«‹æ±‚å™¨
        const jsonText = await callGeminiWithRetry(prompt);
        const newItems = safeJsonParse(jsonText);
        
        // è™•ç†ä¸¦æ’å…¥æ–°è¡Œç¨‹ (æ‰¾åˆ°åŸå§‹é …ç›®ä½ç½®ä¸¦æ›¿æ›/å»¶ä¼¸)
        const processedItems = processAISchedules(newItems, day);
        const originalIndex = day.schedules.findIndex(s => s.id === originalId);
        
        // ä¿ç•™åŸé …ç›®ï¼Œå°‡æ–°ç”Ÿæˆçš„ 3 å€‹é»æ¥åœ¨å¾Œé¢
        day.schedules.splice(originalIndex + 1, 0, ...processedItems);

        // é‡æ–°æ•´ç†æ•¸æ“šèˆ‡ä»‹é¢
        applySchedulesToDay(day, day.schedules);
        showMessage(`âœ¨ å·²ç‚ºæ‚¨å®Œæˆ ${currentCity} çš„${style}æ·±åº¦è¦åŠƒï¼`, 'success');
    } catch (error) {
        console.error("æ·±åº¦è¦åŠƒå¤±æ•—:", error);
        showMessage("AI è¦åŠƒæš«æ™‚ç„¡æ³•å®Œæˆï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key", "error");
    } finally {
        toggleModal('ai-loading-modal');
    }
}


/**
 * ğŸ“Š API æ¶ˆè€—çµ±è¨ˆï¼š2026 è·¨ä¸–ä»£ç›¸å®¹ç‰ˆ (v1.9.1)
 * æ”¯æ´ Gemini 1.5, 2.5, 3 å…¨ç³»åˆ— Token è¿½è¹¤
 */
function trackApiUsage(metadata, modelType = 'flash') {
    if (!metadata) return;

    try {
        // âœ¨ ç›¸å®¹æ€§æ¬„ä½æå–ï¼šæ”¯æ´ä¸åŒç‰ˆæœ¬çš„ Token å‘½åè¦å‰‡
        const promptTokens = metadata.promptTokenCount || metadata.prompt_token_count || 0;
        const candidatesTokens = metadata.candidatesTokenCount || metadata.candidates_token_count || 0;
        const totalTokens = metadata.totalTokenCount || (promptTokens + candidatesTokens);

        // ç¢ºä¿ state.apiStats å­˜åœ¨
        if (!state.apiStats) state.apiStats = { totalTokens: 0, totalCalls: 0, history: [] };

        state.apiStats.totalTokens += totalTokens;
        state.apiStats.totalCalls += 1;

        // ğŸ›¡ï¸ ä¿®æ­£é»ï¼šåŠ ä¸Šã€Œå®‰å…¨æª¢æŸ¥ã€é˜²æ­¢ toLocaleString å ±éŒ¯
        const now = new Date();
        const timestamp = now ? now.toLocaleString() : 'æœªçŸ¥æ™‚é–“';

        const record = {
            time: timestamp,
            model: modelType,
            prompt: promptTokens,
            output: candidatesTokens,
            total: totalTokens
        };

        // åªä¿ç•™æœ€è¿‘ 50 ç­†ç´€éŒ„
        state.apiStats.history.unshift(record);
        if (state.apiStats.history.length > 50) state.apiStats.history.pop();

        console.log(`ğŸ“Š AI æ¶ˆè€—çµ±è¨ˆ [${modelType.toUpperCase()}]:`, record);
        
        // æ›´æ–° UI ç‹€æ…‹åˆ— (è‹¥æœ‰æ­¤å‡½æ•¸)
        if (typeof updateStatusBar === 'function') updateStatusBar();
        
    } catch (err) {
        console.error("âŒ çµ±è¨ˆæ•¸æ“šå¯«å…¥å¤±æ•—:", err);
    }
}

function openAIPlusModal(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    const workshopKey = `${trip.id}_day${day.dayNum}`;

    let schedule;
    if (state.planViewMode === 'workshop') {
        schedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        schedule = (day.schedules || []).find(s => s.id === scheduleId);
    }

    if (!schedule) return;

    const titleEl = document.getElementById('aiplus-modal-title');
    const bodyEl = document.getElementById('aiplus-modal-body');
    if (titleEl) titleEl.textContent = schedule.name;

    if (bodyEl) {
        if (schedule.aiPlus) {
            bodyEl.innerHTML = `
                <div class="space-y-4 animate-in fade-in">
                    <div class="flex items-center space-x-2">
                        <span class="ai-plus-tag-shiny">âœ¨ AI+ æ·±åº¦æ”»ç•¥</span>
                    </div>
                    <div class="text-gray-700 leading-relaxed text-base">
                        ${parseAIPlusInteractiveContent(schedule.aiPlus.replace(/\n/g, '<br>'))}
                    </div>
                </div>`;
        } else {
            bodyEl.innerHTML = `
                <div class="py-12 text-center">
                    <div class="text-4xl mb-4 opacity-30">âœ¨</div>
                    <p class="text-gray-400 mb-6">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œé–‹å•Ÿ AI+ æ·±åº¦å…§å®¹å¼·åŒ–</p>
                    <button onclick="generateSingleAIPlus('${schedule.id}')" 
                            class="ai-plus-tag-shiny px-8 py-3 text-sm cursor-pointer hover:scale-105 transition-transform shadow-lg">
                        ç«‹å³é–‹å•Ÿ AI+ å¼·åŒ–
                    </button>
                </div>`;
        }
    }
    toggleModal('ai-plus-modal');
}


/** æ¸²æŸ“é–‹éŠ·é é¢å®Œæ•´éª¨æ¶ - å°å…¥èˆŠç‰ˆæ­£å¸¸é¡¯ç¤ºé‚è¼¯ */
function renderExpenseView() {
    const el = document.getElementById('expense-view');
    if (!el) return;

    el.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg w-full">
            <h3 class="text-xl font-bold mb-4 theme-text-pink">ğŸ’° æ—…è¡Œé–‹éŠ·åˆ†é¡çµ±è¨ˆ</h3>
            
            <div id="total-budget-card" class="mb-6 p-4 rounded-xl border border-gray-300 shadow-md">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-gray-700 mb-1">ç¸½é ç®— (<span id="budget-currency"></span>)</p>
                        <span id="total-budget-amount" class="text-2xl font-extrabold text-red-600">0</span>
                    </div>
                    <button onclick="openEditBudgetModal()" class="px-3 py-1 bg-gray-100 rounded-lg text-xs font-bold hover:bg-gray-200 transition">ä¿®æ”¹é ç®—</button>
                </div>
                
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-xs font-semibold text-gray-600">é ç®—é€²åº¦</p>
                        <span id="budget-summary-text" class="text-xs font-semibold text-pink-600">0%</span>
                    </div>
                    <div class="h-3 rounded-full bg-gray-200 overflow-hidden">
                        <div id="budget-progress-bar" class="h-full bg-pink-500 transition-all duration-500" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div id="expense-list-container" class="grid grid-cols-2 gap-4"></div>

            <h4 class="text-xl font-bold mt-8 mb-4 theme-text-pink">ğŸ“… æ¯æ—¥é–‹éŠ·æ‘˜è¦</h4>
            <div id="daily-expense-summary-container" class="space-y-4"></div>

            <div class="mt-4 border-t pt-3 flex justify-between font-bold text-lg final-summary-card">
                <span>ç¸½é ä¼°æ”¯å‡º (<span id="grand-total-currency"></span>)</span>
                <span id="grand-total-cost" class="text-red-600">0</span>
            </div>
        </div>
    `;
}

/** ğŸ“– å‚™é¸å£è¢‹æ¸²æŸ“å¼•æ“ (v5.8 æ——è‰¦ç©©å®šç‰ˆ) 
 * ä¿®æ­£é»ï¼š
 * 1. [ç‰©ç†ä½ˆå±€é–å®š]ï¼šå¼·åˆ¶ grid å®¹å™¨ä¸è·‘ä½ï¼Œä¸¦é–å®šå¡ç‰‡æœ€å¤§å¯¬åº¦ã€‚
 * 2. [åˆ†é¡å°ä½åŠ å¼·]ï¼šnormalizeCat åŠ å…¥æ›´å¤šè®Šé«”å­—æ”¯æ´ï¼Œç¢ºä¿æ•¸æ“šç²¾æº–å…¥åº«ã€‚
 * 3. [æ‰‹æ©Ÿç†±å€å„ªåŒ–]ï¼šå¼·åŒ–å¡ç‰‡ä¸ŠåŠéƒ¨é»æ“Šæµæš¢åº¦ï¼Œå°æ¥ openEditModalByIdã€‚
 * 4. [åˆ†é é‚è¼¯è‡ªç™’]ï¼šç¢ºä¿æœå°‹çµæœè®Šå‹•æ™‚ï¼Œåˆ†é ç‹€æ…‹ 100% æ­£ç¢ºã€‚
 */
function renderBucketItems(shouldUpdateTabs = true) {
    const grid = document.getElementById('bucket-items-grid');
    const trip = getCurrentTrip();

    if (!grid) return;
    
    // ğŸŒŸ [ç’°å¢ƒé–å®š]ï¼šé‡ç½® Grid æ¨£å¼ï¼Œç¢ºä¿å·¦å³ç•™ç™½ä¸”ä¸æ»¿ç‰ˆ
    grid.style.display = 'grid';
    grid.className = "grid grid-cols-1 gap-4 px-4 pb-20";

    if (!trip || !trip.days) {
        grid.innerHTML = `<div class="col-span-full py-10 text-center text-slate-400 italic font-black">â³ æ•¸æ“šåŒæ­¥ä¸­...</div>`;
        return;
    }

    if (shouldUpdateTabs) renderBucketTabs();

    // 1. æ•¸æ“šæºåˆä½µèˆ‡å»é‡ (ç‰©ç†å°ä½)
    const rawBucket = trip?.bucketList || [];
    const rawPrivate = state.privateData || [];
    let combinedList = Array.from(new Map([...rawPrivate, ...rawBucket]
        .filter(it => it && it.id)
        .map(item => [item.id, item])).values());

    // 2. æ¬Šå¨åˆ†é¡æ­¸ä¸€åŒ–å¼•æ“
    const normalizeCat = (cat, style) => {
        const c = String(cat || "").trim();
        if (['é£Ÿ', 'é£²é£Ÿ', 'é¤å»³', 'å’–å•¡', 'ç¾é£Ÿ', 'ç”œé»'].includes(c)) return 'é£Ÿ';
        if (['é†«', 'é†«ç™‚', 'è—¥å¦', 'é†«é™¢', 'è¨ºæ‰€'].includes(c)) return 'é†«';
        if (['è¡Œ', 'äº¤é€š', 'è·¯ç¶²', 'è»Šç«™', 'æ–°å¹¹ç·š'].includes(c)) return 'è¡Œ';
        if (['ä½', 'ä½å®¿', 'é£¯åº—', 'æ—…é¤¨', 'Hotel'].includes(c)) return 'ä½';
        if (['è³¼', 'è³¼ç‰©', 'ç™¾è²¨', 'å•†åº—', 'è²·', 'è—¥å¦'].includes(c)) return 'è³¼';
        if (['ç©', 'æ™¯é»', 'å¨›æ¨‚', 'æ´»å‹•', 'ç¥ç¤¾'].includes(c)) return 'ç©';
        const d = (window.GLOBAL_DICT || []).find(x => x.tag === style);
        return d ? d.parent : 'ç©';
    };

    // 3. éˆæ•éæ¿¾å¼•æ“ (æ”¯æ´å¤šè©ç©¿é€)
    const term = (state.bucketSearchTerm || "").toLowerCase().trim();
    const keywords = term.split(/\s+/).filter(k => k.length > 0);
    
    let filteredList = combinedList.filter(item => {
        const auth = normalizeCat(item.category, item.customStyle);
        // åˆ†é¡éæ¿¾
        if (state.activeParentTab && state.activeParentTab !== 'å…¨éƒ¨' && auth !== state.activeParentTab) return false;
        
        // é—œéµå­—éæ¿¾
        if (keywords.length === 0) return true;
        const fingerprint = [item.name, item.area, item.location, item.customStyle, item.notes, auth]
            .map(v => String(v||"").toLowerCase()).join(' ');
        return keywords.every(kw => fingerprint.includes(kw));
    });

    // 4. åˆ†é è‡ªç™’é‚è¼¯
    if (!window.bucketPagination) window.bucketPagination = { currentPage: 1, pageSize: 10 };
    const totalItems = filteredList.length;
    const totalPages = Math.ceil(totalItems / window.bucketPagination.pageSize);
    if (window.bucketPagination.currentPage > totalPages && totalPages > 0) {
        window.bucketPagination.currentPage = 1;
    }

    const start = (window.bucketPagination.currentPage - 1) * window.bucketPagination.pageSize;
    const pagedList = filteredList.slice(start, start + window.bucketPagination.pageSize);

    if (totalItems === 0) {
        grid.innerHTML = `<div class="col-span-full py-20 text-center animate-in fade-in">
            <div class="text-4xl mb-4 opacity-10">ğŸ”</div>
            <p class="text-slate-400 font-bold text-xs tracking-widest uppercase">No assets in this category</p>
        </div>`;
        return;
    }

    // 5. åŸ·è¡Œç‰©ç†å¡ç‰‡æ¸²æŸ“ (Grid å…§éƒ¨)
    let cardsHtml = pagedList.map(item => {
        const cat = normalizeCat(item.category, item.customStyle);
        const themeMap = { 'é£Ÿ': 'emerald', 'è³¼': 'amber', 'ä½': 'purple', 'è¡Œ': 'blue', 'ç©': 'pink', 'é†«': 'red' };
        const color = themeMap[cat] || 'slate';
        const isAdded = trip?.days?.some(d => d.schedules?.some(s => s.name === item.name));
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}`;

        return `
            <div class="mx-auto w-full max-w-[340px] bg-white p-5 rounded-[2rem] border-2 ${isAdded ? 'border-slate-50 opacity-60' : 'border-slate-100 shadow-sm'} transition-all hover:border-pink-200 active:scale-[0.98] mb-2 flex flex-col justify-between min-h-[220px]">
                
                <div class="text-left cursor-pointer" onclick="openEditModalById('${item.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-[9px] font-black px-2.5 py-1 rounded-lg border bg-${color}-50 text-${color}-700 border-${color}-100 uppercase tracking-tighter">
                            ${cat} | ${item.customStyle || 'ä¸€èˆ¬'}
                        </span>
                    </div>
                    <h4 class="font-black text-slate-800 text-sm mb-1 leading-snug line-clamp-2" style="min-height: 2.5rem;">
                        ${item.name}
                    </h4>
                    <p class="text-[10px] text-slate-400 font-bold truncate">ğŸ“ ${item.area || item.location || 'é»æ“Šç€è¦½å…§å®¹'}</p>
                    ${item.notes ? `<p class="text-[9px] text-pink-400 mt-1 italic truncate opacity-70">ğŸ“ ${item.notes}</p>` : ''}
                </div>

                <div class="mt-4 pt-4 border-t border-slate-50 flex gap-2 h-10">
                    <button onclick="deleteBucketItem('${item.id}'); event.stopPropagation();" 
                            class="w-10 h-full flex items-center justify-center bg-slate-50 text-slate-300 hover:text-red-500 rounded-2xl active:scale-90 transition-all">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6" stroke-width="2.5" stroke-linecap="round"/></svg>
                    </button>
                    <a href="${mapUrl}" target="_blank" onclick="event.stopPropagation();" 
                       class="flex-1 flex items-center justify-center bg-blue-50 text-blue-600 rounded-2xl text-[10px] font-black shadow-sm active:scale-95 transition-all">ğŸ—ºï¸ åœ°åœ–</a>
                    <div class="flex-[1.5] relative">
                        <select onclick="event.stopPropagation();" onchange="insertBucketToDay('${item.id}', this.value); this.value=''" 
                                class="w-full h-full text-[10px] border-2 border-slate-100 rounded-2xl font-black bg-white outline-none px-2 appearance-none cursor-pointer">
                            <option value="">ï¼‹ å®‰æ’</option>
                            ${trip?.days?.map(d => `<option value="${d.dayNum}">Day ${d.dayNum}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>`;
    }).join('');

    // 6. æ¸²æŸ“åˆ†é  UI
    let pagHtml = "";
    if (totalPages > 1) {
        pagHtml = `<div class="col-span-full flex items-center justify-center gap-6 mt-6 py-6 border-t border-slate-50">
            <button onclick="changeBucketPage(${window.bucketPagination.currentPage - 1})" 
                    class="w-10 h-10 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center active:bg-pink-50 transition-all ${window.bucketPagination.currentPage === 1 ? 'opacity-20 cursor-not-allowed' : ''}">â¬…ï¸</button>
            <span class="text-xs font-black text-slate-500 font-mono">${window.bucketPagination.currentPage} / ${totalPages}</span>
            <button onclick="changeBucketPage(${window.bucketPagination.currentPage + 1})" 
                    class="w-10 h-10 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center active:bg-pink-50 transition-all ${window.bucketPagination.currentPage === totalPages ? 'opacity-20 cursor-not-allowed' : ''}">â¡ï¸</button>
        </div>`;
    }

    grid.innerHTML = cardsHtml + pagHtml;
}


/** ğŸ“± æ‰‹æ©Ÿå‹å–„ç·¨è¼¯å™¨ (é€šç”¨å°ä½ç‰ˆ) */
function openMobileFriendlyEditor(item, onSaveCallback) {
    let modal = document.getElementById('mobile-editor-overlay');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'mobile-editor-overlay';
        modal.className = 'fixed inset-0 z-[9999] bg-white animate-in slide-in-from-bottom duration-300 flex flex-col';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 flex-shrink-0 bg-white">
            <button onclick="closeMobileEditor()" class="text-slate-400 font-bold text-lg p-2">å–æ¶ˆ</button>
            <h3 class="font-black text-slate-800">ä¿®æ­£å…§å®¹</h3>
            <button id="mobile-save-trigger" class="theme-text-pink font-black text-lg p-2">å„²- å„²å­˜</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-white">
            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-300 uppercase tracking-widest px-1">è³‡ç”¢åç¨±</label>
                <input id="edit-name" type="text" value="${item.name || ''}" 
                       class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-pink-200 outline-none font-bold text-slate-700 shadow-inner">
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-300 uppercase tracking-widest px-1">å€åŸŸ / åœ°å€</label>
                <input id="edit-location" type="text" value="${item.location || item.area || ''}" 
                       class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-pink-200 outline-none font-bold text-slate-700 shadow-inner">
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-300 uppercase tracking-widest px-1">æˆ°è¡“å‚™è¨» (Notes)</label>
                <textarea id="edit-notes" rows="6" 
                          class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-pink-200 outline-none font-bold text-slate-700 shadow-inner leading-relaxed">${item.notes || ''}</textarea>
            </div>
            
            <p class="text-[10px] text-slate-300 text-center italic mt-10">å„²å­˜å¾Œå°‡åŒæ­¥è‡³ç‰©ç†ç£å€ IndexedDB</p>
        </div>
    `;

    // å„²å­˜äº‹ä»¶ç¶å®š
    document.getElementById('mobile-save-trigger').onclick = () => {
        const updatedData = {
            name: document.getElementById('edit-name').value.trim(),
            location: document.getElementById('edit-location').value.trim(),
            notes: document.getElementById('edit-notes').value.trim()
        };
        
        // åŸ·è¡Œå¤–éƒ¨å‚³å…¥çš„å„²å­˜é‚è¼¯ (è™•ç†ä¸åŒæ•¸æ“šæº)
        if (onSaveCallback) onSaveCallback(updatedData);
        
        closeMobileEditor();
    };

    modal.style.display = 'flex';
}

window.closeMobileEditor = () => {
    const modal = document.getElementById('mobile-editor-overlay');
    if (modal) modal.style.display = 'none';
};



/** ğŸ”¢ åˆ†é ç¿»é è™•ç†å‡½æ•¸ (v4.6 éˆæ•æœå°‹è¯å‹•ç‰ˆ) 
 * ä¿®æ­£ï¼šç¿»é æ™‚æ‡‰è¨ˆç®—ã€Œéæ¿¾å¾Œã€çš„ç¸½æ•¸ï¼Œè€ŒéåŸå§‹ç¸½æ•¸
 */
window.changeBucketPage = function(page) {
    if (!window.bucketPagination) return;
    
    // ğŸŒŸ 1. å–å¾—ç•¶å‰ã€Œæœå°‹è©ã€èˆ‡ã€Œæ¨™ç±¤ã€ç‹€æ…‹ä¸‹çš„æ•¸æ“šç¸½é‡
    const trip = getCurrentTrip();
    const term = (state.bucketSearchTerm || "").toLowerCase().trim();
    const keywords = term.split(/\s+/).filter(k => k.length > 0);

    // å–å¾—èˆ‡æ¸²æŸ“å¼•æ“ä¸€è‡´çš„åˆä½µæ•¸æ“šæº
    const rawBucket = trip?.bucketList || [];
    const rawPrivate = state.privateData || [];
    let list = Array.from(new Map([...rawPrivate, ...rawBucket]
        .filter(it => it && it.id)
        .map(item => [item.id, item])).values());

    // ğŸŒŸ 2. æ¨¡æ“¬éæ¿¾é‚è¼¯ï¼ˆç¢ºä¿ç¸½é æ•¸è¨ˆç®—ç²¾ç¢ºï¼‰
    if (keywords.length > 0) {
        list = list.filter(item => {
            const fingerprint = [item.name, item.location, item.area, item.customStyle, item.notes, item.category]
                .map(v => typeof v === 'string' ? v.toLowerCase() : '').join(' ');
            return keywords.every(kw => fingerprint.includes(kw));
        });
    }

    if (state.activeParentTab && state.activeParentTab !== 'å…¨éƒ¨') {
        list = list.filter(item => {
            const entry = (window.GLOBAL_DICT || []).find(d => d.tag === item.customStyle);
            return entry ? entry.parent === state.activeParentTab : (item.category === state.activeParentTab);
        });
    }

    if (state.activeBucketTab && state.activeBucketTab !== 'å…¨éƒ¨') {
        list = list.filter(item => item.customStyle === state.activeBucketTab);
    }

    // ğŸŒŸ 3. è¨ˆç®—æ­£ç¢ºçš„ç¸½é æ•¸
    const totalItems = list.length;
    const totalPages = Math.ceil(totalItems / window.bucketPagination.pageSize);

    // ğŸŒŸ 4. é‚Šç•Œæª¢æŸ¥èˆ‡åŸ·è¡Œ
    if (page < 1 || page > totalPages) return;
    
    window.bucketPagination.currentPage = page;
    
    // åŸ·è¡Œæ¸²æŸ“ (false è¡¨ç¤ºä¸é‡æ–°ç”Ÿæˆé ‚éƒ¨ Tabsï¼Œä¿è­·è¼¸å…¥ç„¦é»èˆ‡æ•ˆèƒ½)
    renderBucketItems(false); 

    // ğŸŒŸ 5. ç‰©ç†è¦–åœ–æ ¡æº–ï¼šæ»¾å›é ‚éƒ¨
    // å¦‚æœæ˜¯ Modal å…§ï¼Œæ”¹ç”¨ grid.parentElement.scrollTo
    const scrollTarget = document.getElementById('bucket-items-grid')?.parentElement || window;
    scrollTarget.scrollTo({ top: 0, behavior: 'smooth' });
};

/** ğŸš‘ çµ‚æ¥µæ‰‹è¡“åˆ€ï¼šä¸»å‹•é˜²ç¦¦ + æ·±åº¦æ•‘æ´è‡ªç™’ç³»çµ± (v4.5 æ——è‰¦å°ä½ç‰ˆ) 
 * ä¿®æ­£ï¼šå¼·åŒ–æ•¸æ“šæƒææ·±åº¦ï¼Œä¸¦èˆ‡åˆ†é å¼•æ“åŒæ­¥ç‹€æ…‹
 */
async function hardRescueItems() {
    // 1. å¾ dbManager å–å¾—ä¸»ç‹€æ…‹å¿«ç…§ (ç¬¦åˆä½ çš„ private_store çµæ§‹)
    const mainState = await dbManager.get('private_store', 'main_state');
    
    if (!mainState || !mainState.trips) {
        return "âŒ éŒ¯èª¤ï¼šè³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°ä¸»ç‹€æ…‹æˆ–è¡Œç¨‹è³‡æ–™ï¼Œè«‹æª¢æŸ¥ IndexedDB é€£ç·šã€‚";
    }

    let totalRescued = 0;
    const allTrips = mainState.trips; 

    console.log(`ğŸš€ æ•¸æ“šä¿®å¾©å•Ÿå‹•ï¼šæ­£åœ¨æƒæ [${allTrips.length}] å€‹è¡Œç¨‹...`);

    allTrips.forEach(trip => {
        // ç¢ºä¿ bucketList çµæ§‹å®Œæ•´
        if (!trip.bucketList) trip.bucketList = [];
        
        // å»ºç«‹åç¨±ç´¢å¼•ï¼Œé˜²æ­¢é‡è¤‡æ•‘å›é€ æˆæ•¸æ“šå†—é¤˜
        const bucketNames = new Set(trip.bucketList.map(b => (b.name || "").trim().toLowerCase()));

        // éæ­·æ¯ä¸€å¤©ï¼Œæ·±å…¥æƒæ schedules èˆ‡ itinerary
        trip.days.forEach(day => {
            const dayItems = [
                ...(day.schedules || []),
                ...(day.itinerary || [])
            ];

            dayItems.forEach(s => {
                const sNameLower = (s.name || "").trim().toLowerCase();
                
                // ğŸ› ï¸ æ ¸å¿ƒé‚è¼¯ï¼šæ’é™¤äº¤é€šï¼Œä¸¦é‡å°ä¸åœ¨å‚™é¸æ¡¶çš„ã€Œå¤±è¯æ™¯é»ã€é€²è¡Œç‰©ç†é‚„åŸ
                if (s.style !== 'transport' && sNameLower && !bucketNames.has(sNameLower)) {
                    const rescuedItem = {
                        id: s.fromBucketId || ('rescued-' + Math.random().toString(36).substr(2, 9)),
                        name: s.name,
                        location: s.address || s.location || "",
                        notes: s.notes || "å¾è¡Œç¨‹ä¸­è‡ªå‹•æ•‘å›",
                        style: s.style || "food", // é è¨­é¡åˆ¥
                        category: s.category || "é£Ÿ",
                        customStyle: s.customStyle || "åœ°æ¨™",
                        isAdded: true, // æ¨™è¨˜ç‚ºå·²æ’å…¥ï¼Œæœå°‹æ™‚æœƒé¡¯ç¤ºåŠé€æ˜
                        status: 'want',
                        lastUpdate: new Date().toISOString()
                    };

                    trip.bucketList.push(rescuedItem);
                    bucketNames.add(sNameLower);
                    totalRescued++;
                    console.log(`âœ… æˆåŠŸå°‹å›è³‡ç”¢ï¼š${s.name}`);
                }
            });
        });

        // ğŸŸ¡ é¡å¤–é˜²ç¦¦ï¼šé‡å° spot ç­‰èˆŠæ¨™ç±¤é€²è¡Œç‰©ç†é‡é‘„
        trip.bucketList.forEach(item => {
            if (item.style === 'spot') item.style = 'play';
        });
    });

    // 2. ğŸŒŸ æ•¸æ“šå¤§ä¸€çµ±åŒæ­¥
    state.trips = allTrips;
    if (state.currentTripId) {
        const current = allTrips.find(t => t.id === state.currentTripId);
        if (current) {
            state.currentTrip = current;
            state.bucketList = current.bucketList; // ç¢ºä¿æœå°‹æºåŒæ­¥
        }
    }

    // 3. ğŸŒŸ åˆ†é é‡ç½®ï¼šä¿®å¾©å¾Œå¼·åˆ¶å›åˆ°ç¬¬ä¸€é ï¼Œä»¥ä¾¿æŸ¥çœ‹çµæœ
    if (window.bucketPagination) {
        window.bucketPagination.currentPage = 1;
    }

    // 4. ğŸ’¾ åŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª”
    // èª¿ç”¨ saveData(true) ç¢ºä¿æ•¸æ“šå¼·åˆ¶å¯«å…¥ private_store
    await saveData(true);

    // 5. ğŸ¨ UI é‡ç¹ª
    if (typeof renderBucketItems === 'function') renderBucketItems(true);
    if (typeof renderDayContent === 'function') renderDayContent();
    
    return `ğŸ‰ æ•‘æ´æˆåŠŸï¼å·²å¾æ•¸æ“šæ·±è™•æ•‘å› ${totalRescued} å€‹æ™¯é»ï¼Œåˆ†é å·²é‡ç½®ã€‚`;
}


/** ğŸš‘ çµ‚æ¥µæ‰‹è¡“åˆ€ï¼šä¸»å‹•é˜²ç¦¦ + æ·±åº¦æ•‘æ´è‡ªç™’ç³»çµ± (v4.6 æ——è‰¦ç‰ˆ) */
async function hardRescueItems() {
    // 1. å–å¾—æ•¸æ“šæ ¸å¿ƒ (main_state)
    const mainState = await dbManager.get('private_store', 'main_state');
    if (!mainState || !mainState.trips) return "âŒ éŒ¯èª¤ï¼šæ•¸æ“šæ ¸å¿ƒ main_state ææ¯€æˆ–ä¸å­˜åœ¨ã€‚";

    let passiveCount = 0; // è¢«å‹•æ•‘å›æ•¸
    let activeCount = 0;  // ä¸»å‹•é˜²ç¦¦è£œå›æ•¸
    const allTrips = mainState.trips;

    // ğŸ”¥ ã€æ ¸å¿ƒé˜²ç¦¦å€ã€‘ï¼šå®šç¾©çµ•å°ä¸å…è¨±å¤±è¹¤çš„ã€Œéˆé­‚æ™¯é»ã€èˆ‡ã€Œåº§æ¨™è£œå¼·ã€
    // åŠ å…¥ lat/lng è§£æ±ºæ—¥èªŒä¸­æåˆ°çš„åº§æ¨™ç¼ºå¤±è­¦å‘Š
    const SOUL_OF_FUKUOKA = [
        { name: "ä¸€è˜­æ‹‰éºµ å¤ªå®°åºœåƒé“åº—", location: "å¤ªå®°åºœ", style: "food", category: "é£Ÿ", customStyle: "æ‹‰éºµ", lat: 33.5144, lng: 130.5186, notes: "äº”è§’å½¢åˆæ ¼ç¢—ï¼å¤ªå®°åºœé™å®š" },
        { name: "å¤ªå®°åºœå¤©æ»¿å®®", location: "å¤ªå®°åºœ", style: "play", category: "ç©", customStyle: "ç¥ç¤¾", lat: 33.5215, lng: 130.5348, notes: "å­¸å•ä¹‹ç¥ï¼Œå¿…æ‘¸å¾¡ç¥ç‰›" },
        { name: "æ«›ç”°ç¥ç¤¾", location: "åšå¤š", style: "play", category: "ç©", customStyle: "ç¥ç¤¾", lat: 33.5930, lng: 130.4106, notes: "åšå¤šç¸½é®å®ˆï¼Œè¶…å·¨å¤§å±±ç¬ " },
        { name: "åšå¤šé‹æ²³åŸ", location: "åšå¤š", style: "play", category: "ç©", customStyle: "è³¼ç‰©", lat: 33.5898, lng: 130.4108, notes: "æ°´èˆç§€èˆ‡æ‹‰éºµç«¶æŠ€å ´" },
        { name: "å”æˆ¶å¸‚å ´", location: "ä¸‹é—œ", style: "food", category: "é£Ÿ", customStyle: "å¸‚å ´", lat: 33.9577, lng: 130.9482, notes: "é€±æœ«é™å®šçš„æ¡å£½å¸å¤§æˆ°" }
    ];

    console.log(`ğŸ“¡ å•Ÿå‹•å…¨åŸŸç‰©ç†æ•¸æ“šè‡ªç™’æƒæ...`);

    allTrips.forEach(trip => {
        if (!trip.bucketList) trip.bucketList = [];
        
        // å»ºç«‹ç²¾æº–åç¨±ç´¢å¼•ï¼ˆå»ç©ºç™½ã€è½‰å°å¯«ï¼‰
        let bucketNames = new Set(trip.bucketList.map(b => (b.name || "").trim().toLowerCase()));

        // --- ğŸŸ¢ ç¬¬ä¸€éšæ®µï¼šè¢«å‹•ä¿®å¾© (æ·±åº¦æƒæ schedules èˆ‡ itinerary) ---
        trip.days.forEach(day => {
            // ç©¿é€æ‰€æœ‰å¯èƒ½çš„è¡Œç¨‹é™£åˆ—
            const dayItems = [...(day.schedules || []), ...(day.itinerary || [])];
            
            dayItems.forEach(s => {
                const sNameNormalized = (s.name || "").trim().toLowerCase();
                
                // æ’é™¤äº¤é€šï¼Œä¸”é‡å°ä¸åœ¨å‚™é¸æ¡¶çš„é …ç›®é€²è¡Œé‚„åŸ
                if (s.style !== 'transport' && sNameNormalized && !bucketNames.has(sNameNormalized)) {
                    trip.bucketList.push({
                        id: 'rescued-' + Math.random().toString(36).substr(2, 9),
                        name: s.name,
                        location: s.address || s.location || "",
                        notes: s.notes || "å¾è¡Œç¨‹ä¸­è‡ªå‹•æ‰¾å›",
                        style: s.style || "food",
                        category: s.category || "é£Ÿ",
                        customStyle: s.customStyle || "åœ°æ¨™",
                        isAdded: true, // æ—¢ç„¶æ˜¯å¾è¡Œç¨‹æ‰¾å›çš„ï¼Œæ¨™è¨˜ç‚ºå·²åŠ å…¥
                        status: 'want',
                        lastUpdate: new Date().toISOString()
                    });
                    bucketNames.add(sNameNormalized);
                    passiveCount++;
                }
            });
        });

        // --- ğŸŸ¡ ç¬¬äºŒéšæ®µï¼šä¸»å‹•é˜²ç¦¦ (éˆé­‚æ™¯é»åº§æ¨™è£œå¼·) ---
        SOUL_OF_FUKUOKA.forEach(soul => {
            const soulNameLower = soul.name.toLowerCase();
            const exists = Array.from(bucketNames).some(name => name.includes(soulNameLower) || soulNameLower.includes(name));
            
            if (!exists) {
                trip.bucketList.push({
                    id: 'soul-' + Math.random().toString(36).substr(2, 9),
                    ...soul,
                    isAdded: false,
                    status: 'must',
                    lastUpdate: new Date().toISOString()
                });
                bucketNames.add(soulNameLower);
                activeCount++;
            }
        });

        // --- ğŸ”µ ç¬¬ä¸‰éšæ®µï¼šç‰©ç†æ ¼å¼é‡é‘„ ---
        trip.bucketList.forEach(item => {
            // æ¸…é™¤éæ™‚æ¨™ç±¤
            if (item.style === 'spot') item.style = 'play';
            // ç¢ºä¿é¡åˆ¥å°ä½
            if (!item.category) {
                const dictEntry = (window.GLOBAL_DICT || []).find(d => d.tag === item.customStyle);
                item.category = dictEntry ? dictEntry.parent : (item.style === 'food' ? 'é£Ÿ' : 'ç©');
            }
        });
    });

    // 2. ğŸŒŸ é—œéµä¿®æ­£ï¼šæ•¸æ“šåŸå­åŒ–åŒæ­¥èˆ‡åˆ†é é‡ç½®
    state.trips = allTrips;
    
    if (state.currentTripId) {
        const current = allTrips.find(t => t.id === state.currentTripId);
        if (current) {
            state.currentTrip = current;
            state.bucketList = current.bucketList; 
        }
    }

    // ğŸš€ é‡ç½®åˆ†é ï¼Œç¢ºä¿æ•‘æ´çµæœç«‹å³é¡¯å½±
    if (window.bucketPagination) {
        window.bucketPagination.currentPage = 1;
    }

    // 3. ğŸ’¾ åŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª” (Force Mode)
    await saveData(true);
    
    // æ¸…é™¤æœå°‹æ¡†ï¼Œè®“æ•‘æ´æˆæœç„¡æ­»è§’å‘ˆç¾
    state.bucketSearchTerm = "";
    
    return `ğŸ‰ æ•¸æ“šè‡ªç™’å®Œæˆï¼\nğŸ”¹ è¢«å‹•æ•‘å›ï¼š${passiveCount} ç­†\nğŸ›¡ï¸ ä¸»å‹•è£œå¼·ï¼š${activeCount} ç­†\nå·²ç¢ºä¿ 279+ ç­†è³‡ç”¢ç‰©ç†å°ä½å®Œæˆä¸¦è§£æ±ºåº§æ¨™ç¼ºå¤±ã€‚`;
}

/** ğŸš‘ è¡“å¾Œç…§è­·ï¼šæˆ°ç•¥ä¿®å¾©æŒ‰éˆ•ä»‹é¢ (v4.6 ç‰©ç†è‡ªç™’ç‰ˆ) 
 * ä¿®æ­£é‡é»ï¼š
 * 1. [åˆ†é æ¸…é›¶]ï¼šæ•‘æ´å¾Œå¼·åˆ¶é‡ç½®åˆ†é è‡³ç¬¬ä¸€é ï¼Œç¢ºä¿ 279+ ç­†è³‡ç”¢ç«‹å³é¡¯å½±ã€‚
 * 2. [æœå°‹é‡ç½®]ï¼šè‡ªå‹•æ¸…é™¤æœå°‹é—œéµå­—ï¼Œé¿å…æœå°‹è©å±è”½äº†æ•‘å›çš„çµæœã€‚
 * 3. [æŒ‡ç´‹å›ºåŒ–]ï¼šå¼·åŒ– syncBucketToGlobalDict èˆ‡ç‰©ç†å¼·æ¬Šå­˜æª”çš„é€£å‹•ã€‚
 */
async function runSystemDeepRescue() {
    // 1. æ‰‹è¡“å‰ç¢ºèª
    if (!confirm('ğŸš¨ åŸ·è¡Œã€Œæ•¸æ“šè‡ªç™’æ‰‹è¡“ã€ï¼Ÿ\n\nç³»çµ±å°‡ç©¿é€ç£å€æƒæ IndexedDB ä¸¦æ¯”å°éˆé­‚æ™¯é»åå–®ï¼Œ\næ‰¾å›å¤±è¯æ™¯é»ä¸¦é‡æ–°ç‰©ç†é–å®šåº§æ¨™ã€‚')) return;
    
    // 2. é–å®šæŒ‰éˆ•é˜²æ­¢é‡è¤‡è§¸ç™¼
    const btn = event?.target?.closest('button');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-pulse">ğŸ“¡ æ‰‹è¡“é€²è¡Œä¸­...</span>';
    }
    
    showMessage("ğŸ“¡ æ•¸æ“šç£å€å·¡æª¢ä¸­ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...", "info");
    
    try {
        // ğŸš€ A. åŸ·è¡Œåº•å±¤ç¡¬æ ¸æ•‘æ´ (æ‰¾å›å¤±è¯è³‡ç”¢)
        const result = await hardRescueItems();
        
        // ğŸš€ B. åŸ·è¡Œç‰©ç†å¤§ä¸€çµ±åŒæ­¥ (é‡é‘„æ¨™ç±¤æŒ‡ç´‹)
        // ç¢ºä¿æ•‘æ´å›ä¾†çš„è³‡ç”¢é‡æ–°é€²è¡Œã€Œè¡Œ/é†«/é£Ÿ/ä½/ç©/è³¼ã€å­—å…¸åˆ†é¡
        if (typeof syncBucketToGlobalDict === 'function') {
            console.log("ğŸ§¬ æ­£åœ¨åŸ·è¡Œèªæ„æŒ‡ç´‹é‡é‘„...");
            await syncBucketToGlobalDict();
        }

        // ğŸš€ C. ç‹€æ…‹è‡ªç™’æ ¡æº– (éå¸¸é‡è¦ï¼šç¢ºä¿æ–°è³‡æ–™èƒ½è¢«çœ‹è¦‹)
        state.bucketSearchTerm = ''; // æ¸…ç©ºæœå°‹æ¡†
        state.activeParentTab = 'å…¨éƒ¨'; // é‡ç½®å¤§é¡åˆ†é¡
        state.activeBucketTab = 'å…¨éƒ¨'; // é‡ç½®å­é¡åˆ†é¡
        
        // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šé‡ç½®åˆ†é å¼•æ“ï¼Œé˜²æ­¢è³‡æ–™è¢«åŸ‹åœ¨å¾Œæ–¹åˆ†é 
        if (window.bucketPagination) {
            window.bucketPagination.currentPage = 1;
        }

        // ğŸš€ D. å¼·åˆ¶ç‰©ç†å¼·æ¬Šå­˜æª” (é¿å…ç€è¦½å™¨å´©æ½°å°è‡´æ•¸æ“šä¸Ÿå¤±)
        await saveData(true);
        
        // 3. æ‰‹è¡“æˆåŠŸåé¥‹
        showMessage(result, "success");
        console.log("â™»ï¸ æ‰‹è¡“å®Œæˆï¼šç‰©ç†æŒ‡ç´‹å·²é‡æ–°å›ºåŒ–è‡³ç£å€ã€‚");

        // --- ğŸ©º è¡“å¾Œ UI åŒæ­¥é‡ç¹ª ---
        if (typeof renderBucketItems === 'function') {
            // æ•‘æ´å¾Œé€šå¸¸æœƒç”¢ç”Ÿæ–°è³‡æ–™ï¼Œå¼·åˆ¶é‡ç¹ªç¶²æ ¼
            renderBucketItems(true); 
        }
        
        // è‹¥åœ¨è¡Œç¨‹è¦–åœ–ï¼ŒåŒæ­¥åˆ·æ–°è¡Œç¨‹å…§å®¹
        if (state.currentSubView === 'itinerary' && typeof renderDayContent === 'function') {
            renderDayContent();
        }
        
        // æ²å‹•è‡³é ‚éƒ¨å±•ç¤ºæˆæœ
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
    } catch (err) {
        console.error("Critical Surgery Error:", err);
        showMessage("âŒ æ‰‹è¡“å¤±æ•—ï¼šæ ¸å¿ƒç£å€é€£ç·šç•°å¸¸æˆ–æ•¸æ“šæ ¼å¼æ¯€æ", "danger");
    } finally {
        // 4. è§£é™¤æŒ‰éˆ•é–å®š
        if (btn) {
            btn.disabled = false;
            btn.innerText = 'ğŸš‘ åŸ·è¡Œæ•¸æ“šè‡ªç™’';
        }
    }
}

/** æ›´æ–°åº—å®¶ç‹€æ…‹ (å¿…åƒ/æƒ³å»/å·²å») */
async function updateBucketStatus(itemId, newStatus) {
    const trip = getCurrentTrip();
    const item = trip.bucketList.find(i => i.id === itemId);
    if (item) {
        item.status = newStatus;
        await saveData(); // æ”¹ç‚º await
        renderBucketItems();
        const labels = { 'must': 'ğŸ”¥ å·²åˆ—ç‚ºå¿…åƒé‡é»ï¼', 'want': 'â­ å·²åŠ å…¥æƒ³å»æ¸…å–®', 'done': 'âœ… ç´€éŒ„ç‚ºå·²é€ è¨ª' };
        showMessage(labels[newStatus], 'info');
    }
}

/** æ™ºæ…§æ’åºï¼šè®“æ‚¨é»æ“Šã€ŒğŸ”¥å¿…å»ã€æ™‚ï¼Œç´…è‰²æ¨™ç±¤çš„åº—å®¶æœƒæ’åœ¨ç¬¬ä¸€ä½ */
function sortBucketList(priorityType) {
    const trip = getCurrentTrip();
    if (!trip || !trip.bucketList) return;

    const weights = { 'must': 2, 'want': 2, 'done': 2 };
    weights[priorityType] = 1; // æŠŠé¸ä¸­çš„é¡å‹å„ªå…ˆæ¬Šæé«˜
    
    trip.bucketList.sort((a, b) => {
        const wA = weights[a.status || 'want'];
        const wB = weights[b.status || 'want'];
        if (wA !== wB) return wA - wB;
        return (a.location || '').localeCompare(b.location || '');
    });

    saveData();
    renderBucketItems(true); // æ’åºå¾Œéœ€è¦å®Œæ•´åˆ·æ–°
    showMessage(`å·²å°‡å…¶è¨­å®šç‚ºå„ªå…ˆé¡¯ç¤º`, 'success');
}

/** æ‰‹å‹•æ›´æ–°å‚™é¸é …ç›®çš„æ¨™ç±¤ - v4.1 ç‰©ç†åŒæ­¥ç‰ˆ
 * ä¿®æ­£ï¼š
 * 1. å¼·åŒ–æ•¸æ“šå°ä½ï¼šç¢ºä¿ customStyle, style èˆ‡ mainCat ä¸‰ä½ä¸€é«”ã€‚
 * 2. ç‰©ç†è½åœ°ï¼šé€£å‹• syncBucketToGlobalDict ç¢ºä¿èªæ„å¤§è…¦åŒæ­¥æ›´æ–°ã€‚
 * 3. è¦–åœ–ä¿è­·ï¼šåŸ·è¡Œç‰©ç†å¼·æ¬Šå­˜æª”ï¼Œè§£æ±º F5 è·‘ä½å•é¡Œã€‚
 */
async function updateBucketItemTag(bucketId, newTag) {
    if (!newTag) return;
    
    const trip = getCurrentTrip();
    if (!trip || !trip.bucketList) return;

    const item = trip.bucketList.find(i => i.id === bucketId);
    if (!item) return;

    console.log(`ğŸ“¡ [Tag-Pivot] æ­£åœ¨ç‚ºé …ç›® [${item.name}] é‡æ–°å°ä½æ¨™ç±¤: ${newTag}`);

    // 1. å¯«å…¥åŸºæœ¬æ¨™ç±¤å±¬æ€§
    item.customStyle = newTag;
    
    // ğŸŒŸ 2. æ™ºæ…§åˆ¤å®šèˆ‡éµå¾‹æ ¡æº–
    const dictEntry = (window.GLOBAL_DICT || []).find(d => d.tag === newTag);
    let finalParent = 'ç©'; // é è¨­ä¿åº•
    
    if (dictEntry) {
        finalParent = dictEntry.parent;
    } else if (MASTER_CATEGORIES[newTag]) {
        finalParent = newTag;
    }

    // éµå¾‹å°ä½ä¿®æ­£ (ç¢ºä¿ç¬¦åˆ 6 å¤§ç¶­åº¦)
    if (['äº¤', 'è¡Œ'].includes(finalParent)) finalParent = 'è¡Œ';
    if (['é†«', 'æ€¥'].includes(finalParent)) finalParent = 'é†«';
    if (['è³¼', 'è²·'].includes(finalParent)) finalParent = 'è³¼';
    if (['æ™¯', 'ç©'].includes(finalParent)) finalParent = 'ç©';

    // æ›´æ–°ç‰©ä»¶æ¬Šå¨å±¬æ€§
    item.mainCat = finalParent;
    item.category = finalParent; // é›™æ¬„ä½åŒæ­¥ï¼Œé˜²ç¦¦èˆŠé‚è¼¯
    const master = MASTER_CATEGORIES[finalParent] || MASTER_CATEGORIES['ç©'];
    item.style = master.theme || master.style || 'play';

    // ğŸŒŸ 3. åŸ·è¡Œç‰©ç†å¤§ä¸€çµ±åŒæ­¥
    try {
        // å…ˆåŒæ­¥å…¨åŸŸ state å‰¯æœ¬
        state.bucketList = trip.bucketList;

        // å‘¼å«ç‰©ç†åŒæ­¥å¼•æ“ï¼šåŸ·è¡Œæ­¸ä¸€åŒ–èˆ‡æŒ‡ç´‹å¯«å…¥
        if (typeof syncBucketToGlobalDict === 'function') {
            await syncBucketToGlobalDict();
        } else {
            // è‹¥åŒæ­¥å‡½æ•¸å°šæœªå°±ç·’ï¼ŒåŸ·è¡Œå¼·æ¬Šå­˜æª”ä¿åº•
            await saveData(true);
        }

        // 4. UI å³æ™‚éŸ¿æ‡‰
        renderBucketItems();
        showMessage(`âœ… å·²å°‡ã€Œ${item.name}ã€æ­¸é¡è‡³ [${finalParent}]`, 'success');
        
    } catch (e) {
        console.error("âŒ æ¨™ç±¤åŒæ­¥å¤±æ•—:", e);
        showMessage("åŒæ­¥è‡³è³‡æ–™åº«æ™‚ç™¼ç”Ÿç•°å¸¸", "error");
    }
}



/** å»ºç«‹æ–°è—åœ– (æ–¹æ¡ˆ) - çµ‚æ¥µé˜²ç¦¦èˆ‡åŒæ­¥ç‰ˆ */
function createNewWorkshop() {
    const trip = getCurrentTrip();
    if (!trip) return;

    // 1. ç”¢ç”Ÿæ–°æ–¹æ¡ˆç‰©ä»¶
    const newWS = {
        id: 'ws-' + generateUUID(),
        name: `æ–°æ–¹æ¡ˆ ${state.workshops.length + 1}`,
        createdAt: new Date().toISOString(),
        data: {} 
    };

    // 2. æ·±åº¦æ‹·è²æ­£å¼è¡Œç¨‹æ•¸æ“šä½œç‚ºåˆç¨¿
    trip.days.forEach(day => {
        newWS.data[`${trip.id}_day${day.dayNum}`] = JSON.parse(JSON.stringify(day.schedules || []));
    });

    // 3. æ›´æ–°è¨˜æ†¶é«”ç‹€æ…‹
    state.workshops.push(newWS);
    state.currentWorkshopId = newWS.id; // âœ¨ å­˜æª”å‰å…ˆè¨­å®š ID
    state.planViewMode = 'workshop';    // âœ¨ ç¢ºä¿æ¨¡å¼æ­£ç¢º

    // 4. âœ¨ æ ¸å¿ƒå°æ­£ï¼šå…ˆåˆ‡æ› UIï¼ŒåŒæ­¥åŸ·è¡Œå­˜æª”
    // é€™æ¨£å³ä¾¿å­˜æª”éç¨‹æ…¢äº† 0.1 ç§’ï¼Œä½¿ç”¨è€…ä»‹é¢ä¹Ÿæ˜¯æµæš¢çš„
    switchWorkshop(newWS.id);
    
    // ç«‹å³åŸ·è¡Œå…·å‚™ã€Œé˜²ç¦¦æ©Ÿåˆ¶ã€çš„ saveData
    saveData(); 
}

/** åˆ‡æ›è—åœ–ç‰ˆæœ¬ */
function switchWorkshop(wsId) {
    state.currentWorkshopId = wsId;
    state.planViewMode = 'workshop';
    
    const ws = state.workshops.find(w => w.id === wsId);
    if (ws) {
        state.shadowItineraries = JSON.parse(JSON.stringify(ws.data));
        
        // 1. åˆ·æ–°ä¸‹æ–¹çš„æ’ç¨‹å¡ç‰‡ (é€™ä¸å½±éŸ¿é ‚éƒ¨æ»‘è»Œ)
        renderDayContent(); 
        
        // 2. æ›´æ–°æ»‘è»Œç‹€æ…‹ (åªæ›é¡è‰²ï¼Œæ²è»¸ä¸è·³å‹•)
        renderWorkshopSlider();

        // 3. âœ¨ å¼·åˆ¶å°ç„¦ï¼šå°‡é¸ä¸­çš„æŒ‰éˆ•å¸åˆ°è¦–ç·šä¸­å¤®
        setTimeout(() => {
            const activeBtn = document.getElementById(`ws-btn-${wsId}`);
            const sliderInner = document.getElementById('ws-slider-inner');
            if (activeBtn && sliderInner) {
                activeBtn.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center' // å°‡é¸ä¸­é …ç½®ä¸­
                });
            }
        }, 50);
    }
}

function renderWorkshopSlider() {
    const container = document.getElementById('workshop-version-slider');
    if (!container) return;

    container.innerHTML = state.workshops.map(ws => {
        const isActive = state.currentWorkshopId === ws.id;
        return `
            <div class="relative flex-shrink-0 group/ws">
                <button id="ws-btn-${ws.id}" onclick="switchWorkshop('${ws.id}')" 
                        class="px-3 py-1 rounded-full text-[10px] font-black whitespace-nowrap transition-all border ${
                            isActive ? 'bg-blue-600 text-white border-transparent shadow-md' : 'bg-white text-gray-400 border-gray-200'
                        }">
                    ${ws.name}${isActive ? ' â—' : ''}
                </button>
                <div class="absolute -top-2 -right-1 hidden group-hover/ws:flex gap-1 z-20">
                    <button onclick="event.stopPropagation(); renameWorkshop('${ws.id}')" class="w-3.5 h-3.5 bg-gray-800 text-white rounded-full flex items-center justify-center text-[8px] shadow-sm">âœï¸</button>
                    <button onclick="event.stopPropagation(); deleteWorkshop('${ws.id}')" class="w-3.5 h-3.5 bg-red-500 text-white rounded-full flex items-center justify-center text-[8px] shadow-sm">Ã—</button>
                </div>
            </div>`;
    }).join('');
}

/** ğŸ› ï¸ å…¨ç³»çµ±ç‰©ç†è‡ªç™’æ ¸å¿ƒ (v6.0) */
window.runSystemSelfHealing = async function() {
    const trip = getCurrentTrip();
    if (!trip) return showMessage('âŒ æ‰¾ä¸åˆ°è¡Œç¨‹æ•¸æ“šæº', 'error');

    try {
        // 1. é¡¯ç¤ºè™•ç†ä¸­ UI
        showMessage('â³ æ­£åœ¨ç©¿é€æ•¸æ“šå±¤åŸ·è¡Œè‡ªç™’...', 'info');
        
        // 2. æ•¸æ“šæ¸…æ´—ï¼šå°ä½åˆ†é¡ã€ä¿®æ­£ IDã€é‡å¯«æœå°‹æŒ‡ç´‹
        let healCount = 0;
        const allAssets = [...(state.privateData || []), ...(trip.bucketList || [])];
        
        allAssets.forEach(item => {
            const oldCat = item.category;
            const fingerprint = (item.name + (item.notes || "") + (item.customStyle || "")).toLowerCase();
            
            // å¼·åˆ¶æ­¸ä¸€åŒ– (Normalization)
            if (fingerprint.match(/éºµ|ç‡’|å’–å•¡|å±…é…’å±‹|é£Ÿ|é¤å»³|ç”œé»/)) item.category = "é£Ÿ";
            else if (fingerprint.match(/è—¥|é†«|è¨ºæ‰€|ä¿å¥|å£ç½©|é†«é™¢/)) item.category = "é†«";
            else if (fingerprint.match(/è»Š|ç·š|ç«™|è·¯|å·´å£«|æ–°å¹¹ç·š|jr|è¥¿éµ/)) item.category = "è¡Œ";
            else if (fingerprint.match(/é£¯åº—|ä½|æ—…é¤¨|hostel|hotel/)) item.category = "ä½";
            else if (fingerprint.match(/è³¼|è²·|ç™¾è²¨|mall|outlet|å•†åº—/)) item.category = "è³¼";
            else if (!item.category) item.category = "ç©";

            if (oldCat !== item.category) healCount++;
        });

        // 3. ç‰©ç†é–å®šï¼šå¯«å…¥ IndexedDB
        if (typeof saveData === 'function') await saveData();

        // 4. é‡è¨­åˆ†é èˆ‡æ¨™ç±¤è¦–åœ–
        window.bucketPagination = { currentPage: 1, pageSize: 10 };
        state.activeParentTab = 'å…¨éƒ¨'; // å¼·åˆ¶å›åˆ°ã€Œå…¨éƒ¨ã€ä»¥é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š

        // 5. é‡æ–°æ¸²æŸ“
        if (typeof renderBucketItems === 'function') renderBucketItems(true);
        
        showMessage(`âœ… è‡ªç™’å®Œæˆï¼ä¿®å¾© ${healCount} ç­†æ•¸æ“šï¼Œæœå°‹ç´¢å¼•å·²åˆ·æ–°ã€‚`, 'success');
        console.log("ğŸ ç‰©ç†å¤§ä¸€çµ±è‡ªç™’ç¨‹åºåŸ·è¡Œå®Œç•¢ã€‚");
        
    } catch (err) {
        console.error("è‡ªç™’å¤±æ•—:", err);
        showMessage('âŒ è‡ªç™’ç¨‹åºç™¼ç”Ÿç‰©ç†å´©æ½°', 'error');
    }
};

/** ğŸ”„ å°‡å‚™é¸é …ç›®å®‰æ’åˆ°ç‰¹å®šå¤©æ•¸ (æ”¯æ´æè¿°å°å¡ã€åƒ¹æ ¼èˆ‡äº¤é€šå±¬æ€§ç¹¼æ‰¿) */
async function insertBucketToDay(bucketId, dayNum) {
    if (!dayNum) return;
    const trip = getCurrentTrip();
    
    // å¾å‚™é¸æ¸…å–®å°‹æ‰¾è©²é …ç›®
    const bucketItem = trip.bucketList.find(i => i.id === bucketId);
    
    const workshopKey = `${trip.id}_day${dayNum}`;
    const day = trip.days.find(d => d.dayNum == dayNum);

    if (!bucketItem || !day) return;

    // æ ¹æ“šæ¨¡å¼é¸å–ã€Œåƒè€ƒæ’ç¨‹ã€ä¾†è¨ˆç®—é–‹å§‹æ™‚é–“
    const activeSchedules = (state.planViewMode === 'workshop') 
        ? (state.shadowItineraries[workshopKey] || day.schedules || []) 
        : (day.schedules || []);

    // è¨ˆç®—æ–°è¡Œç¨‹çš„é–‹å§‹æ™‚é–“ (è‡ªå‹•æ¥çºŒå‰ä¸€å€‹è¡Œç¨‹)
    let nextStartTime = day.startTime || "09:00";
    if (activeSchedules.length > 0) {
        const last = activeSchedules[activeSchedules.length - 1];
        nextStartTime = calculateEndTime(last.startTime, last.durationHours);
    }

    // ğŸŒŸ [æè¿°å°å¡é‚è¼¯åˆ¤å®š]
    const isDescription = bucketItem.style === 'description';

    // ğŸŒŸ [æ•¸æ“šå°ä½æ ¸å¿ƒ]ï¼šå»ºæ§‹æ–°è¡Œç¨‹ç‰©ä»¶
    const newSchedule = {
        id: generateUUID(),
        name: bucketItem.name,
        startTime: nextStartTime,
        // æè¿°å°å¡é è¨­ 0.1 å°æ™‚ï¼ˆåƒ…ä½œä½”ä½ï¼‰ï¼Œå…¶é¤˜é è¨­ 1 å°æ™‚
        durationHours: bucketItem.durationHours || (isDescription ? 0.1 : 1),
        address: bucketItem.location || bucketItem.name,
        notes: bucketItem.notes || "",
        
        // ğŸ’° åƒ¹æ ¼ç¹¼æ‰¿ (æè¿°å°å¡é€šå¸¸ç‚º 0)
        cost: bucketItem.cost || 0, 
        
        // ğŸ¨ é¢¨æ ¼å°ç„¦
        style: bucketItem.style || 'transport',
        customStyle: bucketItem.customStyle || (isDescription ? 'æè¿°' : ''),
        
        // ğŸšŒ äº¤é€šå±¬æ€§ (ä¾›æè¿°å°å¡æ”¯æ´å †ç–Šé¡¯ç¤ºæ¨™ç±¤)
        operator_id: bucketItem.operator_id || null,
        stations: bucketItem.stations || [],
        color: bucketItem.color || null,
        
        isAI: false,
        fromBucketId: bucketItem.id 
    };

    // æ ¸å¿ƒæ•¸æ“šåˆ†æµé‚è¼¯ (å·¥åŠ vs æ­£å¼)
    if (state.planViewMode === 'workshop') {
        if (!state.shadowItineraries[workshopKey]) {
            state.shadowItineraries[workshopKey] = JSON.parse(JSON.stringify(day.schedules || []));
        }
        state.shadowItineraries[workshopKey].push(newSchedule);
        
        if (typeof recalculateScheduleTimes === 'function') {
            recalculateScheduleTimes({ 
                schedules: state.shadowItineraries[workshopKey], 
                startTime: day.startTime 
            });
        }
        showMessage(`ğŸ› ï¸ å·²å®‰æ’ã€Œ${bucketItem.name}ã€è‡³å·¥åŠè‰ç¨¿ (ç¬¬ ${dayNum} å¤©)`, 'info');
    } else {
        // æ­£å¼æ¨¡å¼
        day.schedules.push(newSchedule);
        if (typeof recalculateScheduleTimes === 'function') {
            recalculateScheduleTimes(day);
        }
        showMessage(`âœ… å·²å®‰æ’ã€Œ${bucketItem.name}ã€è‡³ç¬¬ ${dayNum} å¤©`, 'success');
    }

    // æ¨™è¨˜ç‚ºå·²åŠ å…¥
    bucketItem.isAdded = true; 

    // ğŸ’¾ ç‰©ç†å›ºåŒ–ï¼šå­˜å…¥ IndexedDB
    await saveData();
    
    // æ›´æ–°è¦–åœ–èˆ‡åˆ†é 
    state.currentDayIndex = dayNum - 1; 
    
    if (typeof renderBucketItems === 'function') renderBucketItems(); 
    
    // ç«‹å³é‡æ–°æ¸²æŸ“æ’ç¨‹é ï¼Œå°‡æ ¹æ“š newSchedule.style èª¿ç”¨ renderDescriptionCard
    renderDayContent();  
}

/**
 * ğŸ“‹ æè¿°å°å¡ (v1.5)ï¼šæ”¯æ´åœ–ç‰‡ç§»é™¤ã€ç¶²å€é€£çµèˆ‡è‡ªç”±é¸å–ç‰ˆ
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [åœ–ç‰‡ç§»é™¤] åœ¨åœ–ç‰‡å³ä¸Šè§’åŠ å…¥ç‰©ç†åˆªé™¤éˆ•ï¼Œä¸¦é€é removeMemoPhoto åŸ·è¡Œæ¸…é™¤ã€‚
 * 2. [å–æ¶ˆç§»å‹•] ä¿æŒ select-text å±¬æ€§ï¼Œç¢ºä¿å…§å®¹è‡ªç”±é¸å–ã€‚
 * 3. [ç¶²å€æ„Ÿæ‡‰] ä¿æŒè‡ªå‹•è½‰é€£çµåŠŸèƒ½ã€‚
 */
function renderDescriptionCard(schedule, diagnosis = null) {
    const rawNotes = String(schedule.notes || "");
    
    // ğŸš‰ [è§£æå †ç–Šæ¨™ç±¤]ï¼šæŠ“å–æ‰€æœ‰æ¥­è€…èˆ‡ç«™é»
    const operatorMatches = [...rawNotes.matchAll(/\(\((.*?)\)\)/g)].map(m => m[1]);
    const stationMatches = [...rawNotes.matchAll(/\[\[(.*?)\]\]/g)].map(m => m[1]);

    // ğŸ§¼ [å…§å®¹è„«æ•]ï¼šç§»é™¤æŠ€è¡“æ¨™ç±¤ä¸¦åŸ·è¡Œã€Œç¶²å€è‡ªå‹•æ„Ÿæ‡‰ã€
    let cleanNotes = rawNotes
        .replace(/\[\[.*?\]\]/g, '')
        .replace(/\(\(.*?\)\)/g, '')
        .replace(/\{\{.*?\}\}/g, '')
        .trim();

    const urlRegex = /(https?:\/\/[^\s]+)/g;
    cleanNotes = cleanNotes.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" class="text-blue-500 underline hover:text-blue-700 transition-colors break-all">${url}</a>`;
    });

    // ğŸŒŸ åœ–ç‰‡å€åŸŸæ¸²æŸ“ (æ–°å¢ç§»é™¤æŒ‰éˆ•)
    const photoHTML = schedule.photo ? `
        <div class="relative mt-2 mb-4 group/img rounded-2xl overflow-hidden border border-slate-100 shadow-sm transition-all hover:shadow-md">
            <button onclick="removeMemoPhoto('${schedule.id}', event)" 
                    class="absolute top-2 right-2 z-20 bg-red-500/80 hover:bg-red-600 text-white w-7 h-7 rounded-full flex items-center justify-center shadow-lg transition-all active:scale-90"
                    title="ç§»é™¤ç…§ç‰‡">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="3" stroke-linecap="round"/></svg>
            </button>
            <img src="${schedule.photo}" class="w-full h-auto object-cover max-h-[300px] cursor-zoom-in" 
                 onclick="window.open('${schedule.photo}', '_blank')" alt="Memo Photo">
        </div>
    ` : '';

    // æ¸²æŸ“æ¥­è€…æ¨™ç±¤å †ç–Š
    const operatorTagsHTML = operatorMatches.map(op => {
        const opConfig = window.TRANSPORT_OPERATOR_CONFIG ? window.TRANSPORT_OPERATOR_CONFIG[op] : null;
        const color = opConfig?.color || '#64748b';
        return `<span class="px-2 py-0.5 rounded text-[10px] font-black text-white shadow-sm" style="background-color: ${color}">${op}</span>`;
    }).join('');

    // æ¸²æŸ“ç«™é»è·¯ç·šå †ç–Š
    const stationsHTML = stationMatches.map(sGroup => {
        const stations = sGroup.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
        return `
            <div class="mt-3 p-2.5 bg-slate-50 rounded-xl border-l-4 border-slate-300">
                <div class="flex flex-wrap items-center gap-1.5">
                    ${stations.map((s, i) => `
                        <span class="text-[12px] text-slate-700 font-bold">${s}</span>
                        ${i < stations.length - 1 ? '<span class="text-slate-300 text-[10px]">â†’</span>' : ''}
                    `).join('')}
                </div>
            </div>`;
    }).join('');

    return `
        <div id="card-${schedule.id}" data-id="${schedule.id}" data-map-skip="true"
             class="mb-6 relative group is-description select-text">
            
            <div class="absolute left-[-1rem] top-2 bottom-2 w-1 bg-slate-100 rounded-full"></div>

            <div class="description-card-body text-left bg-white border-2 border-slate-100 rounded-2xl p-5 shadow-sm ml-2 transition-all hover:border-slate-200">
                
                <div class="flex flex-wrap gap-2 mb-3">
                    <span class="bg-slate-700 text-white text-[9px] font-black px-2 py-0.5 rounded-md uppercase tracking-widest">Memo</span>
                    ${operatorTagsHTML}
                </div>

                <h4 class="text-base font-black text-slate-800 mb-2 leading-tight select-text">${schedule.name}</h4>
                
                ${photoHTML}

                <div class="text-[13px] text-slate-500 leading-relaxed font-medium select-text">
                    ${cleanNotes.replace(/\n/g, '<br>')}
                </div>

                ${stationsHTML}
                
                <div class="mt-4 pt-4 border-t border-slate-50 flex justify-end gap-2" onclick="event.stopPropagation();">
                    <button onclick="triggerPhotoUpload('${schedule.id}')" 
                            class="text-[11px] font-black text-blue-500 hover:bg-blue-50 px-2 py-1 rounded-lg transition-colors uppercase tracking-tighter">
                        ğŸ“¸ Photo
                    </button>
                    <button onclick="editSchedule('${schedule.id}')" 
                            class="text-[11px] font-black text-slate-300 hover:text-blue-500 transition-colors uppercase tracking-widest">
                        âœï¸ Edit
                    </button>
                    <button onclick="confirmDeleteSchedule('${schedule.id}')" 
                            class="text-[11px] font-black text-slate-300 hover:text-red-500 transition-colors uppercase tracking-widest">
                        ğŸ—‘ï¸ Delete
                    </button>
                </div>
            </div>
        </div>`;
}

/**
 * ğŸ—‘ï¸ ç§»é™¤ Memo ç…§ç‰‡ä¸¦åŒæ­¥ç‰©ç†ç£å€
 */
async function removeMemoPhoto(scheduleId, event) {
    if (event) event.stopPropagation(); // é˜²æ­¢é»æ“ŠæŒ‰éˆ•æ™‚è§¸ç™¼åœ–ç‰‡æ”¾å¤§
    if (!confirm("ç¢ºå®šè¦ç§»é™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) return;

    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!day) return;

    // åˆ†æµå°‹æ‰¾æ™¯é»æ•¸æ“š (æ”¯æ´å·¥åŠæ¨¡å¼)
    let schedulesRef;
    if (state.planViewMode === 'workshop') {
        const workshopKey = `${trip.id}_day${day.dayNum}`;
        schedulesRef = state.shadowItineraries[workshopKey] || [];
    } else {
        schedulesRef = day.schedules || [];
    }

    const schedule = schedulesRef.find(s => s.id === scheduleId);
    
    if (schedule) {
        // 1. ç‰©ç†ç§»é™¤åœ–ç‰‡æ¬„ä½
        delete schedule.photo;
        
        // 2. åŒæ­¥è³‡æ–™åº« (IndexedDB)
        if (typeof saveData === 'function') {
            await saveData(true); // ä½¿ç”¨ Force Mode ç¢ºä¿å¯«å…¥
        }
        
        // 3. UI è‡ªç™’åˆ·æ–°
        if (typeof renderDayContent === 'function') {
            renderDayContent();
        }
        
        showMessage('âœ… ç…§ç‰‡å·²ç§»é™¤', 'info');
    }
}

/** åˆªé™¤å‚™é¸é …ç›® */
async function deleteBucketItem(id) {
    const trip = getCurrentTrip();
    if (!trip || !trip.bucketList) return;
    if (!confirm('ç¢ºå®šè¦å¾å‚™é¸æ¸…å–®ç§»é™¤å—ï¼Ÿ')) return;
    
    trip.bucketList = trip.bucketList.filter(i => i.id !== id);
    await saveData(); // æ”¹ç‚º await
    renderBucketItems();
}



/* ==========================================
   ğŸ’¾ DATA HUB SYSTEM (æ•´åˆåŒ¯å‡ºå…¥ç¸½æ§)
   ========================================== */
/** â˜ï¸ Google Drive é›²ç«¯ç®¡ç†æ¨¡çµ„ (v8.5 æ——è‰¦ç®¡ç†ç‰ˆ) 
 * æ•´åˆï¼šæ¬Šé™ç®¡ç†ã€æª”æ¡ˆæ¸…å–®ã€åˆªé™¤ã€ä¸Šå‚³ã€ä¸‹è¼‰
 */
const cloudManager = {
    accessToken: null,
    CLIENT_ID: '763540090366-iskv4ve80bd838amj59c0ut3avuo1li3.apps.googleusercontent.com', 
    
    // --- ğŸ”‘ æ¬Šé™ç®¡ç†å±¤ ---
    initAuth() {
        if (!window.google) {
            showMessage("âš ï¸ Google SDK å°šæœªè¼‰å…¥", "error");
            return;
        }
        const client = google.accounts.oauth2.initTokenClient({
            client_id: this.CLIENT_ID,
            // ğŸŒŸ æ“´å¤§ Scopeï¼šappdata ç”¨æ–¼ç§æœ‰å‚™ä»½ï¼Œfile ç”¨æ–¼ç”Ÿæˆåˆ†äº«é€£çµ
            scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file',
            callback: (response) => {
                if (response.access_token) {
                    this.accessToken = response.access_token;
                    this.onAuthSuccess();
                }
            },
        });
        client.requestAccessToken({ prompt: 'consent' });
    },

    onAuthSuccess() {
        localStorage.setItem('gdrive_token', this.accessToken);
        localStorage.setItem('gdrive_token_expire', Date.now() + 3600 * 1000);
        
        // è§¸ç™¼å¤–éƒ¨ UI åˆ·æ–° (ç¢ºä¿ refreshCloudUI å­˜åœ¨)
        if (typeof refreshCloudUI === 'function') refreshCloudUI(); 
        if (typeof renderCloudManagerUI === 'function') renderCloudManagerUI();
        
        showMessage("â˜ï¸ é›²ç«¯æˆæ¬ŠæˆåŠŸï¼", "success");
    },

    // --- ğŸ“¤ [ç‰©ç†å°ä½] åŸ·è¡Œä¸Šå‚³ (æ”¯æ´å‚™ä»½æˆ–åˆ†äº«) ---
    async uploadFile(fileName, content, useAppData = true) {
        const token = this.accessToken || localStorage.getItem('gdrive_token');
        if (!token) throw new Error("å°šæœªæˆæ¬Š Google Drive");

        const metadata = {
            name: fileName,
            mimeType: 'application/json',
            // è‹¥ç‚ºç§æœ‰å‚™ä»½å­˜å…¥ appDataFolderï¼Œåˆ†äº«é€£çµå‰‡å­˜å…¥ root (drive.file)
            parents: useAppData ? ['appDataFolder'] : [] 
        };

        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        formData.append('file', new Blob([content], { type: 'application/json' }));

        const url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name';
        
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || "é›²ç«¯ä¸Šå‚³å¤±æ•—");
        }
        return await res.json();
    },

    // --- ğŸ“¥ [ç‰©ç†å°ä½] ä¸‹è¼‰æª”æ¡ˆå…§å®¹ ---
    async downloadFile(fileId) {
        const token = this.accessToken || localStorage.getItem('gdrive_token');
        if (!token) throw new Error("æ†‘è­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");

        const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
        
        const res = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
            this.handleTokenExpire();
            throw new Error("æ†‘è­‰éæœŸ");
        }

        if (!res.ok) throw new Error("ç„¡æ³•æŠ“å–é›²ç«¯æ•¸æ“š");
        return await res.json();
    },

    // --- ğŸ“œ æ¸…å–®ç®¡ç†å±¤ ---
    async listFiles() {
        const token = this.accessToken || localStorage.getItem('gdrive_token');
        if (!token) return [];
        try {
            const url = `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=files(id, name, modifiedTime, size)&orderBy=modifiedTime desc`;
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            
            if (res.status === 401) {
                this.handleTokenExpire();
                return [];
            }
            
            const data = await res.json();
            return data.files || [];
        } catch (e) {
            console.error("è®€å–æ¸…å–®å¤±æ•—:", e);
            return [];
        }
    },

    async deleteFile(fileId) {
        const token = this.accessToken || localStorage.getItem('gdrive_token');
        if (!token) return false;
        try {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            return res.ok;
        } catch (e) {
            console.error("åˆªé™¤æª”æ¡ˆå¤±æ•—:", e);
            return false;
        }
    },

    // --- ğŸ©º è‡ªç™’é‚è¼¯ï¼šæ†‘è­‰éæœŸè™•ç† ---
    handleTokenExpire() {
        localStorage.removeItem('gdrive_token');
        localStorage.removeItem('gdrive_token_expire');
        this.accessToken = null;
        if (typeof refreshCloudUI === 'function') refreshCloudUI();
        showMessage("ğŸ”‘ é›²ç«¯æ†‘è­‰å·²å¤±æ•ˆï¼Œè«‹é‡æ–°é»æ“Šæˆæ¬Š", "warning");
    }
};


/** ğŸ›°ï¸ é›²ç«¯æ•¸æ“šé€è¦–å¼•æ“ (v7.5)
 * ä½œç”¨ï¼šç©¿é€ Snapshot v7.2 å°è£åŒ…ï¼Œæå–ç²¾æº–è³‡ç”¢å ±å‘Š
 */
function analyzeSnapshotContent(rawData) {
    try {
        // ğŸŒŸ ç©¿é€å°è£å±¤ç´š (ç›¸å®¹ Snapshot v7.2 æˆ– å¹³é¢çµæ§‹)
        const payload = rawData.content || rawData.data || rawData;
        
        const report = {
            trips: (payload.trips || []).length,
            bucket: (payload.bucketList || []).length,
            private: (payload.privateData || []).length,
            transport: (payload.transportVault || []).length,
            dict: (payload.dictionary || []).length,
            emergency: (payload.emergencyContacts?.medical?.length || 0) + 
                       (payload.emergencyContacts?.embassies?.length || 0)
        };

        const total = Object.values(report).reduce((a, b) => a + b, 0);
        return { success: true, report, total, timestamp: rawData.timestamp };
    } catch (e) {
        return { success: false, msg: "æ•¸æ“šæ ¼å¼ç„¡æ³•è§£æ" };
    }
}

/** ğŸ¨ æ¸²æŸ“é›²ç«¯è³‡ç”¢å¿«é€Ÿé€è¦–å¡ç‰‡ (Terminalé¢¨æ ¼) */
function getCloudAssetTerminalHTML(rawData) {
    const analysis = analyzeSnapshotContent(rawData);
    if (!analysis.success) return `<p class="text-red-400 text-[10px]">âš ï¸ æ ¼å¼éŒ¯èª¤</p>`;
    
    const r = analysis.report;
    return `
        <div class="mt-4 p-4 bg-slate-900 rounded-2xl font-mono text-[10px] text-emerald-400 border border-emerald-500/20 shadow-inner">
            <div class="flex justify-between border-b border-emerald-500/10 pb-1 mb-2">
                <span>SYSTEM_DECODE: SUCCESS</span>
                <span class="opacity-50">${analysis.total} UNITS</span>
            </div>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                <div class="flex justify-between"><span>â— è¡Œç¨‹:</span><span class="text-white">${r.trips}</span></div>
                <div class="flex justify-between"><span>â— å‚™é¸:</span><span class="text-white">${r.bucket}</span></div>
                <div class="flex justify-between"><span>â— ç§æœ‰:</span><span class="text-white">${r.private}</span></div>
                <div class="flex justify-between"><span>â— è·¯ç¶²:</span><span class="text-white">${r.transport}</span></div>
                <div class="flex justify-between"><span>â— å­—å…¸:</span><span class="text-white">${r.dict}</span></div>
                <div class="flex justify-between"><span>â— ç·Šæ€¥:</span><span class="text-white">${r.emergency}</span></div>
            </div>
        </div>
    `;
}

/** æ›´æ–°é›²ç«¯ UI é¡¯ç¤ºç‹€æ…‹ */
function refreshCloudUI() {
    const indicator = document.getElementById('cloud-indicator');
    const authBtn = document.getElementById('cloud-auth-btn');
    const syncBtn = document.getElementById('cloud-sync-now');
    const statusText = document.getElementById('cloud-status-desc');

    if (cloudManager.accessToken || localStorage.getItem('gdrive_token')) {
        indicator?.classList.replace('bg-blue-300', 'bg-green-400');
        if (authBtn) authBtn.innerText = "âœ… é›²ç«¯å·²é€£çµ";
        if (syncBtn) {
            syncBtn.disabled = false;
            syncBtn.classList.replace('bg-blue-400', 'bg-blue-700');
            syncBtn.classList.replace('text-white/50', 'text-white');
            syncBtn.style.cursor = 'pointer';
        }
        if (statusText) statusText.innerText = "å·²é€£çµæ‚¨çš„ Google Driveï¼Œéš¨æ™‚å¯ä»¥åŒæ­¥è³‡æ–™ã€‚";
    }
}

function handleCloudAuth() {
    cloudManager.initAuth();
}


// é›²ç«¯æª”æ¡ˆç®¡ç†

/** ğŸ¨ æ¸²æŸ“é›²ç«¯æª”æ¡ˆæ¸…å–® UI (v8.2 å…¨ç¶­åº¦æ„Ÿæ‡‰ç‰ˆ) 
 * ä¿®æ­£ï¼š
 * 1. [æ•¸æ“šè£œé½Š]ï¼šæ–°å¢æƒæ bucketList (å¾…å‘½ç‡ƒæ–™) èˆ‡ shoppingList (è³¼ç‰©æ¸…å–®)ã€‚
 * 2. [å°ä½æ¨™ç±¤]ï¼šå¢åŠ å°æ‡‰æˆªåœ–ä»‹é¢çš„ âš¡ èˆ‡ ğŸ›’ åœ–ç¤ºï¼Œç¢ºä¿è³‡è¨Šå°ç¨±ã€‚
 */
async function renderCloudManagerUI() {
    const listContainer = document.getElementById('cloud-backups-list');
    if (!listContainer) return;

    // 1. å•Ÿå‹•åŠ è¼‰å‹•ç•«
    listContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center py-10 space-y-3">
            <div class="animate-spin rounded-full h-6 w-6 border-2 border-blue-500 border-t-transparent"></div>
            <p class="text-[10px] text-blue-500 font-black animate-pulse uppercase tracking-widest">ğŸ“¡ Scanning Cloud Assets...</p>
        </div>`;

    const files = await cloudManager.listFiles();

    // 2. ç©ºç™½ç‹€æ…‹è™•ç†
    if (files.length === 0) {
        listContainer.innerHTML = `<div class="text-center py-12 text-gray-400 text-xs italic bg-gray-50 rounded-3xl border-2 border-dashed border-gray-100">ğŸ“­ é›²ç«¯ç£å€ç›®å‰ç„¡å‚™ä»½ç´€éŒ„</div>`;
        return;
    }

    // 3. åˆå§‹æ¸²æŸ“æª”æ¡ˆæ¡†æ¶
    listContainer.innerHTML = files.map(f => {
        const sizeKB = (f.size / 1024).toFixed(1);
        const isHealthy = f.size > 307200; // 300KB å®‰å…¨ç·š
        const timeStr = new Date(f.modifiedTime).toLocaleString();

        return `
            <div class="p-5 bg-white border border-gray-100 rounded-[2rem] mb-4 shadow-sm group hover:border-blue-300 transition-all animate-in fade-in">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-grow">
                        <p class="text-xs font-black text-gray-800 truncate">${f.name}</p>
                        <p class="text-[9px] text-gray-400 font-mono mt-1">${timeStr} | <span class="${isHealthy ? 'text-emerald-500' : 'text-rose-500'} font-bold">${sizeKB} KB</span></p>
                    </div>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="restoreFromCloud('${f.id}')" class="px-3 py-1.5 bg-blue-600 text-white text-[10px] font-black rounded-xl shadow-md active:scale-95 transition-all">é‚„åŸ</button>
                        <button onclick="deleteCloudFile('${f.id}')" class="p-2 text-gray-300 hover:text-red-500 rounded-xl transition-all">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5" stroke-linecap="round"/></svg>
                        </button>
                    </div>
                </div>

                <div id="file-peek-${f.id}" class="mt-4 pt-3 border-t border-gray-50 flex flex-wrap gap-2">
                    <div class="animate-pulse h-4 bg-gray-50 rounded w-full"></div>
                </div>
            </div>
        `;
    }).join('');

    // 4. ğŸš€ [éåŒæ­¥æƒæå¼•æ“] åŸ·è¡Œç‰©ç†ç£å€æ·±åº¦ç©¿é€åˆ†æ
    files.forEach(async (f) => {
        const peekEl = document.getElementById(`file-peek-${f.id}`);
        if (!peekEl) return;

        try {
            const token = (typeof cloudManager !== 'undefined' ? cloudManager.accessToken : null) || localStorage.getItem('gdrive_token');
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const backup = await res.json();
            const payload = backup.content || backup.data || backup;

            // ğŸŒŸ æ ¸å¿ƒçµ±è¨ˆï¼šå°ä½æˆªåœ–ä¸­çš„æ‰€æœ‰æ•¸æ“šç¶­åº¦
            const stats = {
                trips: (payload.trips || []).length,
                routes: (payload.transportVault || []).length,
                private: (payload.privateData || []).length,
                dict: (payload.dictionary || []).length,
                staging: (payload.bucketList || []).length, // âš¡ å°ä½æˆªåœ–ä¸­çš„ 490 ç­†å¾…å‘½
                shopping: (payload.shoppingList || []).length, // ğŸ›’ è³¼ç‰©æ¸…å–®
                emergency: (payload.emergencyContacts?.medical?.length || 0) + (payload.emergencyContacts?.embassies?.length || 0)
            };

            // æ¸²æŸ“é€è¦–å°æ¨™ç±¤ (è‰²å½©ç³»çµ±èˆ‡ä¸»ä»‹é¢åŒæ­¥)
            peekEl.innerHTML = `
                <div class="flex items-center gap-1.5 bg-blue-50/50 px-2 py-1 rounded-lg border border-blue-100/50" title="ä¹å·è¡Œç¨‹">
                    <span class="text-[9px]">ğŸš—</span> <span class="text-[10px] font-black text-blue-600">${stats.trips}</span>
                </div>
                <div class="flex items-center gap-1.5 bg-emerald-50/50 px-2 py-1 rounded-lg border border-emerald-100/50" title="äº¤é€šè·¯ç¶²">
                    <span class="text-[9px]">ğŸš‰</span> <span class="text-[10px] font-black text-emerald-600">${stats.routes}</span>
                </div>
                <div class="flex items-center gap-1.5 bg-amber-50/50 px-2 py-1 rounded-lg border border-amber-100/50" title="æ ¸å¿ƒæ™¯é»">
                    <span class="text-[9px]">ğŸ“</span> <span class="text-[10px] font-black text-amber-600">${stats.private}</span>
                </div>
                <div class="flex items-center gap-1.5 bg-purple-50/50 px-2 py-1 rounded-lg border border-purple-100/50" title="èªæ„å­—å…¸">
                    <span class="text-[9px]">ğŸ“–</span> <span class="text-[10px] font-black text-purple-600">${stats.dict}</span>
                </div>
                <div class="flex items-center gap-1.5 bg-pink-50/50 px-2 py-1 rounded-lg border border-pink-100/50" title="å¾…å‘½ç‡ƒæ–™">
                    <span class="text-[9px]">âš¡</span> <span class="text-[10px] font-black text-pink-600">${stats.staging}</span>
                </div>
                <div class="flex items-center gap-1.5 bg-orange-50/50 px-2 py-1 rounded-lg border border-orange-100/50" title="è³¼ç‰©æ¸…å–®">
                    <span class="text-[9px]">ğŸ›’</span> <span class="text-[10px] font-black text-orange-600">${stats.shopping}</span>
                </div>
                <div class="flex items-center gap-1.5 bg-red-50/50 px-2 py-1 rounded-lg border border-red-100/50" title="ç·Šæ€¥é†«è­·">
                    <span class="text-[9px]">ğŸš‘</span> <span class="text-[10px] font-black text-red-600">${stats.emergency}</span>
                </div>
            `;
        } catch (err) {
            peekEl.innerHTML = `<div class="w-full text-[9px] text-gray-300 italic">âš ï¸ æ­¤æª”æ¡ˆæ ¼å¼ä¸ç›¸å®¹æˆ–å·²è¢«æå£ï¼Œç„¡æ³•åŸ·è¡Œé€è¦–ã€‚</div>`;
        }
    });
}


/** åŸ·è¡Œé›²ç«¯åˆªé™¤ */
async function deleteCloudFile(fileId) {
    if (!confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é›²ç«¯å‚™ä»½å—ï¼Ÿ")) return;
    const success = await cloudManager.deleteFile(fileId);
    if (success) {
        showMessage("ğŸ—‘ï¸ é›²ç«¯å‚™ä»½å·²ç§»é™¤", "info");
        renderCloudManagerUI();
    }
}

/** ğŸ” ç²å–é›²ç«¯å‚™ä»½æ¸…å–® (v7.2 æ†‘è­‰è‡ªç™’ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å¢åŠ  401 è‡ªå‹•é™¤éŒ¯æ©Ÿåˆ¶ï¼Œç¢ºä¿æ†‘è­‰å¤±æ•ˆæ™‚ UI æœƒç«‹åˆ»åŒæ­¥ã€‚
 * 2. å¼·åŒ–éåŒæ­¥ fetch çš„ç•°å¸¸è£œæ‰ã€‚
 */
async function listFiles() {
    // å„ªå…ˆå¾ cloudManager æˆ– localStorage ç²å–æ†‘è­‰
    const token = (typeof cloudManager !== 'undefined' ? cloudManager.accessToken : null) || localStorage.getItem('gdrive_token');
    
    if (!token) {
        console.log("ğŸ“¡ é›²ç«¯æƒæä¸­æ­¢ï¼šå°šæœªç²å¾—æ†‘è­‰");
        return [];
    }
    
    try {
        const url = `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=files(id, name, modifiedTime, size)&orderBy=modifiedTime desc`;
        
        const res = await fetch(url, { 
            headers: { 'Authorization': `Bearer ${token}` } 
        });
        
        // ğŸŒŸ [æ¬Šå¨ä»²è£] å¦‚æœ Google èªªä½ æ²’æ¬Šé™ (401)ï¼Œä»£è¡¨ Token å·²éæœŸæˆ–è¢«æ’¤éŠ·
        if (res.status === 401) {
            console.warn("ğŸ”‘ åµæ¸¬åˆ°é›²ç«¯æ†‘è­‰å·²éæœŸï¼ŒåŸ·è¡Œç‰©ç†é‡ç½®...");
            
            // ç‰©ç†æ¸…é™¤ç„¡æ•ˆæ†‘è­‰
            localStorage.removeItem('gdrive_token'); 
            if (typeof cloudManager !== 'undefined') {
                cloudManager.accessToken = null;
            }
            
            // è§¸ç™¼ UI é‡ç¹ªï¼Œè®“ã€Œä¸Šå‚³/ä¸‹è¼‰ã€æŒ‰éˆ•è®Šå›ã€Œæˆæ¬Šã€ç‹€æ…‹
            if (typeof refreshCloudUI === 'function') {
                refreshCloudUI();
            } else if (typeof renderCloudManagerUI === 'function') {
                renderCloudManagerUI();
            }
            
            return [];
        }

        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

        const data = await res.json();
        console.log(`ğŸ“¡ é›²ç«¯æ¸…å–®åŒæ­¥å®Œæˆï¼šåµæ¸¬åˆ° ${data.files ? data.files.length : 0} ç­†å‚™ä»½æŒ‡ç´‹`);
        return data.files || [];

    } catch (e) {
        console.error("âŒ é›²ç«¯è®€å–ç½é›£æ€§å¤±æ•—:", e);
        // è‹¥ç™¼ç”Ÿç¶²è·¯å´©æ½°ï¼Œä¸æ¸…é™¤ Tokenï¼Œåƒ…å›å ±éŒ¯èª¤
        return [];
    }
}

/** ğŸ“¥ åŸ·è¡Œé›²ç«¯é‚„åŸ (v6.8ï¼šæ™ºæ…§æŒ‘é¸å™¨ç‰ˆ) 
 * é€²åŒ–ï¼šä¸‹è¼‰å¾Œä¸ç›´æ¥è¦†è“‹ï¼Œè€Œæ˜¯å‘¼å« Smart Selector é¢æ¿é€²è¡Œå±€éƒ¨é‚„åŸ
 */
async function restoreFromCloud(fileId) {
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) {
        showMessage("ğŸ”‘ è«‹å…ˆé‡æ–°åŸ·è¡Œé›²ç«¯æˆæ¬Š", "error");
        return;
    }

    try {
        showMessage("ğŸ“¥ æ­£åœ¨è§£è¼‰é›²ç«¯å…¨é‡åŒ…è£¹ (5MB)...", "info");
        
        const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error("ä¸‹è¼‰å¤±æ•—æˆ–æ¬Šæ–å·²éæœŸ");
        const backup = await res.json();

        // ğŸŒŸ 1. æ•¸æ“šè§£ç¢¼
        const data = backup.content || backup.data || backup;
        if (!data) throw new Error("æª”æ¡ˆçµæ§‹ç•°å¸¸ï¼Œç„¡æ³•è§£ææ•¸æ“šå…§å®¹");

        // ğŸŒŸ 2. å•Ÿå‹•æ™ºæ…§åŒ¯å…¥æŒ‘é¸å™¨ä»‹é¢ (å–ä»£èˆŠçš„ confirm)
        renderSmartRestoreSelector(data, backup.timestamp);

    } catch (e) {
        console.error("âŒ é›²ç«¯ä¸‹è¼‰å¤±æ•—:", e);
        showMessage("é‚„åŸå¤±æ•—ï¼š" + e.message, "error");
    }
}

/** ğŸ¨ æ¸²æŸ“æ™ºæ…§é‚„åŸæŒ‘é¸å™¨ (v7.5 æ•¸æ“šé€è¦–æ•´åˆç‰ˆ) 
 * æ•´åˆé»ï¼š
 * 1. [è¡›æ˜Ÿé€è¦–]ï¼šåœ¨é‚„åŸå‰è‡ªå‹•è§£æ JSON å…§å®¹ï¼Œå›å ±ç‰©ç†è³‡ç”¢ç¸½æ•¸ã€‚
 * 2. [çµæ§‹è‡ªç™’]ï¼šè‡ªå‹•åµæ¸¬ Snapshot v7.2 å°è£å±¤ç´šã€‚
 */
function renderSmartRestoreSelector(data, timestamp) {
    // ğŸŒŸ Step 1. è¡›æ˜Ÿæ•¸æ“šé€è¦–å¼•æ“ (å…§éƒ¨è§£æé‚è¼¯)
    const analyzeSnapshot = (rawData) => {
        try {
            // è‡ªå‹•åµæ¸¬ Snapshot v7.2 å°è£å±¤ç´š
            const payload = rawData.content || rawData.data || rawData;
            return {
                trips: (payload.trips || []).length,
                dictionary: (payload.dictionary || []).length,
                privateData: (payload.privateData || []).length,
                transportVault: (payload.transportVault || []).length,
                bucketList: (payload.bucketList || []).length,
                total: 0 // å¾…ç´¯è¨ˆ
            };
        } catch (e) { return null; }
    };

    const stats = analyzeSnapshot(data);
    const totalUnits = stats ? Object.values(stats).reduce((a, b) => a + b, 0) : 0;

    // å»ºç«‹ Modal å®¹å™¨
    let modal = document.getElementById('restore-selector-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'restore-selector-modal';
        modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] flex items-center justify-center p-4';
        document.body.appendChild(modal);
    }

    // æ•¸æ“šæƒ…å ±æ¸…å–® (å°æ‡‰ç‰©ç†åˆ†é èˆ‡ state å±¬æ€§)
    const options = [
        { id: 'trips', key: 'trips', label: 'ğŸš— ä¹å·è¡Œç¨‹æ’ç¨‹', count: stats?.trips || 0, desc: 'åŒ…å«æ¯æ—¥è©³ç´°è·¯ç·šèˆ‡äº¤é€š' },
        { id: 'dictionary', key: 'dictionary', label: 'ğŸ“– èªæ„è¾¨è­˜å­—å…¸', count: stats?.dictionary || 0, desc: '85ç­†åœ°ç†ã€ç¾é£Ÿèˆ‡é†«ç™‚è¦å‰‡' },
        { id: 'privateData', key: 'privateData', label: 'ğŸ“ ç§æœ‰æ™¯é»æ•¸æ“š (4.9MB)', count: stats?.privateData || 0, desc: '299ç­†æ ¸å¿ƒæ™¯é»ç‰©ç†ç²¾è¯' },
        { id: 'transportVault', key: 'transportVault', label: 'ğŸš‰ å¯¦é«”è·¯ç¶²è³‡ç”¢', count: stats?.transportVault || 0, desc: '21æ¢JRã€è¥¿éµèˆ‡åœ°éµç·šè·¯' },
        { id: 'bucketList', key: 'bucketList', label: 'ğŸŒŸ å‚™é¸æš«å­˜åå–®', count: stats?.bucketList || 0, desc: 'å°šæœªæ’å…¥å¤©æ•¸çš„æ½›åŠ›æ™¯é»' }
    ];

    const timeStr = timestamp ? new Date(timestamp).toLocaleString() : "æœªçŸ¥æ™‚é–“";

    modal.innerHTML = `
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-300 border border-white/20">
            <div class="theme-pink p-8 text-white">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-2xl font-bold tracking-tight">ğŸš€ æ™ºæ…§é‚„åŸæŒ‘é¸å™¨</h3>
                        <p class="text-xs opacity-80 mt-1 font-mono">BACKUP_TS: ${timeStr}</p>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full text-[10px] font-bold">V7.5 AUTO-SCAN</div>
                </div>

                <div class="mt-6 p-4 bg-black/20 rounded-2xl font-mono text-[10px] border border-white/10 backdrop-blur-md">
                    <div class="flex justify-between border-b border-white/10 pb-1 mb-2">
                        <span class="opacity-70 italic">DETECTED_ASSETS_REPORT:</span>
                        <span class="text-emerald-300 font-black">READY</span>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 opacity-90">
                        <div class="flex justify-between"><span>â— è¡Œç¨‹:</span><span>${stats?.trips || 0}</span></div>
                        <div class="flex justify-between"><span>â— è·¯ç¶²:</span><span>${stats?.transportVault || 0}</span></div>
                        <div class="flex justify-between"><span>â— ç§æœ‰:</span><span>${stats?.privateData || 0}</span></div>
                        <div class="flex justify-between"><span>â— å­—å…¸:</span><span>${stats?.dictionary || 0}</span></div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 space-y-3 max-h-[40vh] overflow-y-auto custom-scrollbar">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-2">è«‹æŒ‘é¸è¦åŒ¯å…¥çš„ç‰©ç†åˆ†å€</p>
                ${options.map(opt => `
                    <label class="group flex items-center gap-4 p-4 rounded-2xl border border-gray-100 hover:border-pink-200 hover:bg-pink-50/30 transition-all cursor-pointer active:scale-[0.98]">
                        <div class="relative flex items-center justify-center">
                            <input type="checkbox" name="restore-option" value="${opt.id}" data-key="${opt.key}" checked 
                                   class="peer w-6 h-6 rounded-lg border-2 border-gray-200 text-pink-500 focus:ring-pink-500 transition-all">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-gray-800 group-hover:text-pink-600 transition-colors">${opt.label}</p>
                                <span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-0.5 rounded-md font-mono">${opt.count}</span>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-0.5">${opt.desc}</p>
                        </div>
                    </label>
                `).join('')}
            </div>

            <div class="p-6 bg-gray-50/80 border-t border-gray-100 flex gap-3">
                <button onclick="document.getElementById('restore-selector-modal').remove()" 
                        class="flex-1 py-4 rounded-2xl font-bold text-gray-400 hover:bg-gray-200 transition-all active:scale-95">
                    å–æ¶ˆ
                </button>
                <button id="execute-restore-btn" 
                        class="flex-[2] py-4 rounded-2xl font-bold text-white theme-pink shadow-lg shadow-pink-200 active:scale-95 transition-all">
                    ç¢ºèªåŒæ­¥è³‡æ–™
                </button>
            </div>
        </div>
    `;

    // åŸ·è¡Œå±€éƒ¨é‚„åŸé‚è¼¯ (ç©¿é€ Snapshot v7.2 çµæ§‹)
    document.getElementById('execute-restore-btn').onclick = async () => {
        const checkboxes = Array.from(modal.querySelectorAll('input[name="restore-option"]:checked'));
        if (checkboxes.length === 0) return showMessage("è«‹è‡³å°‘é¸æ“‡ä¸€é …å…§å®¹", "error");

        const payload = data.content || data.data || data; // è‡ªå‹•å°ä½ payload
        const filteredData = {};
        
        checkboxes.forEach(cb => {
            const key = cb.getAttribute('data-key');
            filteredData[key] = payload[key];
        });

        // è£œé½Š Meta
        filteredData.theme = payload.theme || data.theme || state.theme;
        filteredData.version = payload.version || data.version || state.version;

        modal.remove(); 
        showMessage("ğŸ§¬ æ­£åœ¨åŸ·è¡Œç‰©ç†ç£å€æ•¸æ“šå›å¡«...", "info");
        
        await performFullStateRestore(filteredData);
    };
}

/**
 * âš¡ è¼”åŠ©å‡½æ•¸ï¼šåŸ·è¡Œç‰©ç†å±¤ç´šå…¨é‡å¯«å…¥ (v6.6 ç©©å®šå°ä½ç‰ˆ)
 * ä¿®æ­£ï¼šè§£æ±º dbManager.clear ä¸å­˜åœ¨çš„å•é¡Œï¼Œæ”¹ç”¨åŸç”Ÿäº¤æ˜“æŒ‡ä»¤
 */
async function performFullStateRestore(fullData) {
    try {
        showMessage("âš™ï¸ æ­£åœ¨å•Ÿå‹•åŸç”Ÿæ•¸æ“šæ ¡æº–...", "info");

        // ğŸŒŸ 1. ç‰©ç†åˆ†é å°ä½å¯«å…¥
        const storeMapping = {
            'dictionary': 'dictionary_store',
            'privateData': 'private_store',
            'publicData': 'public_store',
            'stagingData': 'staging_store'
        };

        // å–å¾—åŸç”Ÿè³‡æ–™åº«ç‰©ä»¶
        const db = dbManager.db;

        for (const [dataKey, storeName] of Object.entries(storeMapping)) {
            const dataList = fullData[dataKey];
            
            if (Array.isArray(dataList)) {
                console.log(`ğŸ“¡ æº–å‚™ç‰©ç†å›å¡«: ${storeName} (ä¾†æºç­†æ•¸: ${dataList.length})`);
                
                await new Promise((resolve, reject) => {
                    // é–‹å•Ÿè®€å¯«äº¤æ˜“
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // A. æ¸…ç©ºè©²åˆ†é  (ä½¿ç”¨åŸç”Ÿ clear)
                    const clearRequest = store.clear();
                    
                    clearRequest.onsuccess = () => {
                        // B. æ‰¹æ¬¡å¯«å…¥æ–°æ•¸æ“š
                        if (dataList.length === 0) {
                            resolve();
                            return;
                        }
                        
                        let count = 0;
                        dataList.forEach(item => {
                            const addRequest = store.put(item); // ä½¿ç”¨ put ç¢ºä¿ ID è¡çªæ™‚è¦†è“‹
                            addRequest.onsuccess = () => {
                                count++;
                                if (count === dataList.length) resolve();
                            };
                            addRequest.onerror = (e) => console.error(`å¯«å…¥é …ç›®å¤±æ•—:`, e);
                        });
                    };

                    transaction.onerror = (e) => reject(new Error(`äº¤æ˜“å¤±æ•—: ${e.target.error}`));
                });
            }
        }

        // ğŸŒŸ 2. æ›´æ–°è¨˜æ†¶é«” state èˆ‡ LocalStorage (è™•ç† trips èˆ‡å…¶ä»– meta)
        // ç¢ºä¿ 4.9MB åŒ…è£¹å…§çš„ UI ç‹€æ…‹ä¹Ÿèƒ½åŒæ­¥
        if (fullData.trips) state.trips = fullData.trips;
        if (fullData.bucketList) state.bucketList = fullData.bucketList;
        if (fullData.theme) state.theme = fullData.theme;
        
        // å‘¼å«æ‚¨åŸæœ¬çš„ä¿å­˜å‡½æ•¸ï¼ˆè«‹ç¢ºä¿ saveStateToLocalStorage å­˜åœ¨ï¼‰
        if (typeof saveStateToLocalStorage === 'function') {
            saveStateToLocalStorage();
        }

        // ğŸŒŸ 3. çµ‚æ¥µé‡ç¹ª
        showMessage("ğŸ‰ æ•¸æ“šå·²å„æ­¸å„ä½ï¼Œå³å°‡é‡æ•´...", "success");
        setTimeout(() => {
            location.reload();
        }, 1500);

    } catch (err) {
        console.error("å…¨é‡ç‰©ç†é‚„åŸå´©æ½°:", err);
        showMessage("âŒ æ•¸æ“šå¯«å…¥å¤±æ•—: " + err.message, "error");
    }
}


/** ğŸš€ æ•´åˆå°æ­£ç‰ˆï¼šè³‡æ–™ç®¡ç†ä¸­å¿ƒ (v2.9 - é«”é‡æ„Ÿæ‡‰èˆ‡é›²ç«¯ç®¡ç†ç‰ˆ) 
 * æ•´åˆï¼šé›²ç«¯åŒæ­¥ (å«é«”é‡é ä¼°)ã€é›²ç«¯æª”æ¡ˆåº«ã€æ™ºæ…§åˆ†äº«ã€JSON æ“ä½œå€
 */
function renderDataView() {
    const el = document.getElementById('data-view');
    if (!el) return;

    // 1. æ§‹å»ºæ•´åˆä»‹é¢
    el.innerHTML = `
        <div class="bg-white p-6 rounded-3xl shadow-lg w-full max-w-2xl mx-auto border border-gray-100">
            <h3 class="text-2xl font-black theme-text-pink mb-8 flex items-center gap-3">
                <span class="p-3 bg-pink-50 rounded-2xl">ğŸ’¾</span> è³‡æ–™ç®¡ç†ä¸­å¿ƒ
            </h3>

            <div id="cloud-sync-card" class="mb-6 p-5 rounded-[2rem] bg-gradient-to-br from-blue-600 to-blue-500 text-white shadow-lg shadow-blue-200 animate-in fade-in duration-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-grow min-w-0">
                        <h4 class="text-sm font-black flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
                            Google Drive é›²ç«¯åŒæ­¥
                        </h4>
                        <div class="flex items-center gap-2 mt-1.5">
                            <p id="cloud-status-desc" class="text-[10px] text-blue-100 truncate">è¡Œç¨‹å°‡å‚™ä»½è‡³æ‚¨çš„ Google å¸³è™Ÿ</p>
                            <span id="backup-size-estimate" class="text-[9px] bg-white/20 px-2 py-0.5 rounded-full text-blue-100 font-mono transition-all border border-white/10">
                                âš–ï¸ è¨ˆç®—é«”é‡ä¸­...
                            </span>
                        </div>
                    </div>
                    <div id="cloud-indicator" class="w-3 h-3 rounded-full bg-blue-300 border-2 border-white/50 flex-shrink-0"></div>
                </div>
                
                <div class="flex gap-2">
                    <button id="cloud-auth-btn" onclick="handleCloudAuth()" 
                            class="flex-1 py-2.5 bg-white text-blue-600 rounded-xl font-bold text-xs hover:bg-blue-50 transition-all active:scale-95">
                        æˆæ¬Šé€£çµé›²ç«¯
                    </button>
                    <button id="cloud-sync-now" onclick="syncAllToCloud()" 
                            class="flex-1 py-2.5 bg-blue-700 text-white rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">
                        ç«‹å³å‚™ä»½å…¨é‡
                    </button>
                </div>
            </div>

            <div class="mb-8 px-1">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round"/></svg>
                        é›²ç«¯æª”æ¡ˆåº« (ç‰ˆæœ¬å›æº¯)
                    </h4>
                    <button onclick="renderCloudManagerUI()" class="text-[10px] text-blue-500 font-bold hover:underline">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div id="cloud-backups-list" class="space-y-2 min-h-[50px]">
                    <p class="text-[10px] text-gray-300 text-center py-4 italic border-2 border-dashed border-gray-50 rounded-2xl">å°šæœªè®€å–é›²ç«¯åˆ—è¡¨...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="p-5 border border-pink-100 rounded-3xl bg-pink-50/30 text-center">
                    <h4 class="text-[10px] font-black text-pink-400 uppercase mb-3 tracking-widest">æ™ºæ…§åˆ†äº«</h4>
                    <button onclick="toggleModal('export-wizard-modal')" 
                            class="w-full py-4 theme-pink text-white rounded-2xl font-bold text-sm shadow-md hover:brightness-110 active:scale-95 transition-all">
                        ğŸ“¤ å•Ÿå‹•åŒ¯å‡ºç²¾éˆ
                    </button>
                </div>

                <div class="p-5 border border-blue-100 rounded-3xl bg-blue-50/30 text-center">
                    <h4 class="text-[10px] font-black text-blue-400 uppercase mb-3 tracking-widest">æª”æ¡ˆé‚„åŸ</h4>
                    <input type="file" id="import-file-input" class="hidden" onchange="importData(event)">
                    <label for="import-file-input" 
                           class="block w-full py-4 bg-blue-600 text-white text-center rounded-2xl font-bold text-sm cursor-pointer shadow-md hover:bg-blue-700 transition-all">
                        ğŸ“¥ è®€å– JSON æª”æ¡ˆ
                    </label>
                </div>
            </div>

            <details class="group border-t border-gray-100 pt-6">
                <summary class="list-none flex justify-between items-center cursor-pointer text-gray-400 hover:text-gray-600 transition">
                    <span class="text-xs font-black uppercase tracking-widest flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" stroke-width="2"/></svg>
                        é€²éš JSON åŸå§‹ç¢¼æ“ä½œ
                    </span>
                    <span class="group-open:rotate-180 transition-transform">â–¼</span>
                </summary>
                
                <div class="mt-6 space-y-6 animate-in fade-in slide-in-from-top-2">
                    <div class="mb-4">
                        <label class="text-[10px] text-gray-400 font-bold mb-1 block uppercase">ç›®å‰çš„è³‡æ–™åŸå§‹ç¢¼</label>
                        <textarea id="json-export-output" readonly rows="4" 
                            class="w-full p-3 text-[10px] bg-gray-900 text-green-400 rounded-2xl font-mono focus:ring-0 border-none"></textarea>
                        <button onclick="copyJsonOutput()" 
                            class="w-full mt-2 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition">
                            ğŸ“‹ è¤‡è£½ JSON å…¨åŸŸä»£ç¢¼
                        </button>
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-400 font-bold mb-1 block uppercase">æ‰‹å‹•æ–‡å­—é‚„åŸ</label>
                        <textarea id="json-import-input" rows="4" placeholder="åœ¨æ­¤è²¼ä¸Šå‚™ä»½èªæ³•..." 
                            class="w-full p-3 text-[10px] border border-gray-200 rounded-2xl font-mono focus:ring-2 theme-border-pink outline-none bg-gray-50"></textarea>
                        <button onclick="importJsonFromText()" 
                            class="w-full mt-2 py-2.5 bg-slate-800 text-white rounded-xl text-[10px] font-bold shadow-sm active:scale-95 transition">
                            âš¡ ç«‹å³åŸ·è¡Œèªæ³•é‚„åŸ
                        </button>
                        <p id="import-status-text" class="text-[10px] mt-2 text-red-500 text-center"></p>
                    </div>
                </div>
            </details>
        </div>
    `;

    // ğŸŒŸ ç‰©ç†å°ä½ï¼šåŸ·è¡Œåˆå§‹åŒ–é‚è¼¯
    refreshCloudUI();
    if (localStorage.getItem('gdrive_token')) {
        renderCloudManagerUI();
    }
    
    // ğŸŒŸ æ™ºæ…§æ„Ÿæ‡‰ï¼šå•Ÿå‹•é«”é‡é ä¼°
    setTimeout(estimateExportSize, 500);

    // æ›´æ–° JSON è¼¸å‡ºå…§å®¹
    const exportEl = document.getElementById('json-export-output');
    if (exportEl) {
        exportEl.value = JSON.stringify({
            trips: state.trips,
            shoppingList: state.shoppingList,
            emergencyContacts: state.emergencyContacts,
            theme: state.theme,
            version: state.version,
            lastUpdated: new Date().toISOString()
        }, null, 2);
    }
}

/** ğŸ“Š é ä¼°ç•¶å‰æ•¸æ“šå°è£é«”é‡ (æ”¯æ´ v7.2 æ¬Šå¨å·¥å» ) */
async function estimateExportSize() {
    try {
        if (typeof generateFullSnapshot !== 'function') return;
        
        // æ¨¡æ“¬å°è£æµç¨‹
        const snapshot = await generateFullSnapshot();
        const jsonString = JSON.stringify(snapshot);
        const sizeKB = (jsonString.length / 1024).toFixed(1);
        
        const indicator = document.getElementById('backup-size-estimate');
        if (indicator) {
            indicator.innerText = `é ä¼°é«”é‡: ${sizeKB} KB`;
            // é‚è¼¯é–€æª»ï¼šè€ƒé‡ 279+ è³‡ç”¢ï¼Œ300KB ç‚ºå®‰å…¨ç·š
            if (jsonString.length < 307200) { 
                indicator.classList.add('text-amber-300', 'font-black');
                indicator.title = "è­¦å‘Šï¼šé«”é‡ä½æ–¼é æœŸï¼Œè«‹æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§";
            } else {
                indicator.classList.remove('text-amber-300');
                indicator.title = "æ•¸æ“šç‹€æ…‹å¥åº·";
            }
        }
    } catch (e) {
        console.error("é«”é‡ä¼°ç®—ç•°å¸¸:", e);
    }
}

// --- 2. åŒ¯å‡ºæµ (Outgoing) ---
// function setupExportWizard() { ... } // æ¸²æŸ“å‹¾é¸æ¸…å–®
/** åˆå§‹åŒ–åŒ¯å‡ºç²¾éˆçš„è¡Œç¨‹é¸é … */
function setupExportWizard() {
    const container = document.getElementById('export-trip-options');
    if (!container) return;
    container.innerHTML = state.trips.map(t => `
        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-2xl cursor-pointer hover:bg-pink-50 transition-colors">
            <div class="min-w-0">
                <p class="text-xs font-bold text-gray-700 truncate">${t.name}</p>
                <p class="text-[9px] text-gray-400">${t.days.length} å¤©è¡Œç¨‹</p>
            </div>
            <input type="checkbox" name="export-trips" value="${t.id}" checked class="w-5 h-5 text-pink-500 rounded-full border-gray-300">
        </label>
    `).join('');
}


// async function startSmartExport() { ... } // å•Ÿå‹•æ‰“åŒ…æµç¨‹
/**
 * ğŸš€ æ™ºæ…§åŒ¯å‡ºç¸½æ§ï¼šæ•´åˆ prepareLeanTrip å¼•æ“èˆ‡å®‰å…¨è„«æ•
 * @param {string} mode - 'share' (åˆ†äº«é€£çµ) æˆ– 'file' (ä¸‹è¼‰ JSON)
 */
async function startSmartExport(mode = 'share') {
    // --- 1. åˆå§‹åŒ–èˆ‡é¸å–é …æª¢æŸ¥ ---
    const selectedTripCheckboxes = document.querySelectorAll('input[name="export-trips"]:checked');
    const selectedTripIds = Array.from(selectedTripCheckboxes).map(i => i.value);
    
    if (selectedTripIds.length === 0) {
        showMessage('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¡Œç¨‹åŒ¯å‡º', 'error');
        return;
    }

    showMessage('æ­£åœ¨æ‰“åŒ…ä¸¦åŸ·è¡Œéš±ç§ä¿è­·æª¢æŸ¥...', 'info');

    try {
        // --- 2. å°è£åŸºç¤æ•¸æ“šåŒ… (Payload Wrapper) ---
        let payload = {
            type: mode === 'share' ? "TRIP_PACKAGE" : "FULL_BACKUP",
            version: state.version,
            exportDate: new Date().toISOString(),
            settings: {
                currency: state.currency,
                theme: state.theme ? state.theme.primary : 'pink'
            },
            content: {
                // ğŸŒŸ ä¿®æ”¹é»ï¼šä½¿ç”¨å¼•æ“è™•ç†æ¯ä¸€å€‹é¸ä¸­çš„è¡Œç¨‹
                trips: selectedTripIds.map(id => {
                    const originalTrip = state.trips.find(t => t.id === id);
                    // èª¿ç”¨æˆ‘å€‘çš„æ ¸å¿ƒéæ¿¾å¼•æ“ (prepareLeanTrip)
                    return prepareLeanTrip(originalTrip);
                })
            }
        };

        // --- 3. æ ¹æ“šå‹¾é¸æ¢ä»¶æ›è¼‰é™„åŠ æ¨¡çµ„ ---
        if (document.getElementById('exp-inc-bucket')?.checked) {
            payload.content.bucketList = JSON.parse(JSON.stringify(state.bucketList || []));
        }
        if (document.getElementById('exp-inc-dict')?.checked) {
            payload.content.dictionary = window.GLOBAL_DICT || [];
        }
        
        // æª¢æŸ¥ç·Šæ€¥è¯çµ¡æ¨¡çµ„
        const emgEl = document.getElementById('exp-inc-emergency');
        if (emgEl && emgEl.checked) {
            payload.content.emergency = JSON.parse(JSON.stringify(state.emergencyContacts || {}));
        }

        // --- 4. åŸ·è¡Œé¡å¤–å®‰å…¨è„«æ• (Security Masking) ---
        const maskApi = document.getElementById('exp-sec-api')?.checked;
        const maskPhone = document.getElementById('exp-sec-phone')?.checked;

        if (maskApi) {
            // ç¢ºä¿ Payload ä¸­å®Œå…¨ä¸å« API Key
            if (payload.settings) delete payload.settings.geminiKey;
            // å¦‚æœ prepareLeanTrip æœ‰æ³¨å…¥ä½œè€…è³‡è¨Šï¼Œé€™è£¡ä¹Ÿèƒ½é¡å¤–è™•ç†
        }

        // å¦‚æœå‹¾é¸å±è”½é›»è©±ï¼Œé‡å° Payload å…§çš„è³‡æ–™åšæœ€å¾Œæƒæ
        if (maskPhone) {
            payload.content.trips.forEach(trip => {
                trip.days?.forEach(day => {
                    if (day.lodging && day.lodging.phone) day.lodging.phone = "éš±ç§å±è”½";
                });
            });
        }

        payload.hash = btoa(Date.now().toString()).substring(0, 8);

        // --- 5. é—œé–‰è¦–çª—ä¸¦å•Ÿå‹•è¼¸å‡º ---
        toggleModal('export-wizard-modal');

        if (mode === 'share') {
            // ğŸŒŸ èµ°é€£çµåˆ†äº«è·¯å¾‘ (æœƒé€²è¡Œ pako å£“ç¸®èˆ‡ TinyURL)
            await handleSmartShare(payload);
        } else {
            // ğŸŒŸ èµ°ä¸‹è¼‰æª”æ¡ˆè·¯å¾‘
            downloadAsJsonFile(payload);
        }

    } catch (err) {
        console.error("åŒ¯å‡ºéç¨‹å‡ºéŒ¯:", err);
        showMessage("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™çµæ§‹", "error");
    }
}


/** å…§éƒ¨ç½²åŠ©ï¼šåŸ·è¡Œè³‡æ–™è„«æ• */
function executeInternalMasking(payload) {
    const maskApi = document.getElementById('exp-sec-api').checked;
    const maskPhone = document.getElementById('exp-sec-phone').checked;

    if (maskApi) {
        // æ¸…é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„ API Key
        if (state.theme) payload.theme = { ...state.theme, geminiKey: "" };
    }

    if (maskPhone) {
        payload.content.trips.forEach(trip => {
            trip.days.forEach(day => {
                if (day.lodging) day.lodging.phone = "éš±ç§å±è”½";
                day.schedules.forEach(s => {
                    if (s.notes) s.notes = s.notes.replace(/\d{2,4}-\d{2,4}-\d{4}/g, "[é›»è©±å·²é®è”½]");
                });
            });
        });
    }
    payload.hash = btoa(Date.now().toString()).substring(0, 8);
    return payload;
}

/** è¼”åŠ©å‡½æ•¸ï¼šåŸ·è¡Œ JSON ä¸‹è¼‰ */
function downloadAsJsonFile(payload) {
    const dataStr = JSON.stringify(payload, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    // æª”åæ ¹æ“šè¡Œç¨‹æ•¸é‡æ±ºå®š
    const fileName = payload.content.trips.length === 1 
        ? `${payload.content.trips[0].name}_Backup` 
        : `MultiTrips_Backup_${new Date().toISOString().slice(0,10)}`;
        
    a.href = url;
    a.download = `${fileName}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showMessage('âœ… æª”æ¡ˆå‚™ä»½æˆåŠŸ', 'success');
}

/** è¼”åŠ©åŠŸèƒ½ï¼šå…¨é¸åˆ‡æ› */
function toggleSelectAllTrips() {
    const checkboxes = document.querySelectorAll('input[name="export-trips"]');
    const allChecked = Array.from(checkboxes).every(c => c.checked);
    checkboxes.forEach(c => c.checked = !allChecked);
}

// function executeSecureExport() { ... } // ä¸‹è¼‰å»éš±ç§æª”æ¡ˆ
/** åŸ·è¡Œå®‰å…¨æ¸…æ´—ä¸¦ä¸‹è¼‰ */
function executeSecureExport() {
    // 1. æ·±æ‹·è²ç•¶å‰æ•¸æ“šï¼Œé¿å…å½±éŸ¿ä½¿ç”¨è€…æ­£åœ¨æ“ä½œçš„ç•«é¢
    let data = JSON.parse(JSON.stringify({
        trips: state.trips,
        shoppingList: state.shoppingList,
        emergencyContacts: state.emergencyContacts,
        theme: state.theme,
        totalBudget: state.totalBudget,
        currency: state.currency,
        version: state.version,
        isSharedPackage: true // æ¨™è¨˜ç‚ºåˆ†äº«åŒ…
    }));

    // 2. ç²å–å‹¾é¸ç‹€æ…‹
    const maskApi = document.getElementById('mask-api-key').checked;
    const maskLodging = document.getElementById('mask-lodging').checked;
    const maskFlight = document.getElementById('mask-flight').checked;
    const cleanUserNotes = document.getElementById('clean-user-notes').checked;
    const cleanExpenses = document.getElementById('clean-expenses').checked;

    // 3. éè¿´æ¸…æ´—é‚è¼¯
    if (maskApi && data.theme) data.theme.geminiKey = "";

    data.trips.forEach(trip => {
        trip.days.forEach(day => {
            // A. é®è”½ä½å®¿éš±ç§
            if (maskLodging && day.lodging) {
                if (day.lodging.roomNumber) day.lodging.roomNumber = "***";
                if (day.lodging.phone) day.lodging.phone = "å·²é®è”½";
            }

            // B. é®è”½èˆªç­éš±ç§
            if (maskFlight) {
                if (day.arrivalInfo) day.arrivalInfo.flight = day.arrivalInfo.flight ? day.arrivalInfo.flight.slice(0, 2) + "***" : "";
                if (day.departureInfo) day.departureInfo.flight = day.departureInfo.flight ? day.departureInfo.flight.slice(0, 2) + "***" : "";
            }

            // C. æ¸…æ´—æ’ç¨‹ç´°é …
            day.schedules.forEach(s => {
                if (cleanUserNotes) s.notes = ""; 
                if (cleanExpenses) s.cost = "0";
                
                // å¦‚æœå‹¾é¸é®è”½ä½å®¿ï¼Œä¸”æ’ç¨‹ä¸­å«æœ‰ã€Œé£¯åº—ã€å­—æ¨£çš„åç¨±ï¼Œä¹Ÿåšæ¨¡ç³ŠåŒ–è™•ç†
                if (maskLodging && s.name.includes("é£¯åº—") && s.address) {
                    s.address = s.address.split("è™Ÿ")[0] + "è™Ÿ (è©³ç´°æˆ¿è™Ÿå·²é®è”½)";
                }
            });
        });
    });

    if (cleanExpenses) data.totalBudget = 0;

    // 4. ä¸‹è¼‰æª”æ¡ˆ
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const fileName = `TripShare_${getCurrentTrip()?.name || 'æ—…éŠè¨ˆç•«'}_${new Date().toISOString().slice(0, 10)}.json`;
    
    a.href = url;
    a.download = fileName;
    a.click();
    
    URL.revokeObjectURL(url);
    toggleModal('export-security-modal');
    showMessage('ğŸ›¡ï¸ å·²å®Œæˆéš±ç§è„«æ•ï¼Œåˆ†äº«åŒ…ä¸‹è¼‰æˆåŠŸï¼', 'success');
}


// async function handleSmartShare(payload) { ... } // å£“ç¸®ä¸¦æ±ºå®šå‚³è¼¸è·¯å¾‘
async function handleSmartShare(payload) {
    const jsonString = JSON.stringify(payload);
    let base64Data = "";

    // ğŸ›¡ï¸ é˜²ç¦¦æ€§æª¢æŸ¥ï¼šç¢ºèª pako æ˜¯å¦çœŸçš„å­˜åœ¨
    if (typeof pako !== 'undefined') {
        try {
            const compressed = pako.deflate(jsonString, { to: 'string' }); 
            base64Data = btoa(encodeURIComponent(compressed));
            console.log("ğŸ“¦ æ•¸æ“šå·²é€šé Pako å£“ç¸®");
        } catch (e) {
            console.warn("Pako å£“ç¸®å¤±æ•—ï¼Œæ”¹æ¡åŸå§‹ç·¨ç¢¼", e);
            base64Data = btoa(encodeURIComponent(jsonString));
        }
    } else {
        console.warn("âš ï¸ åµæ¸¬ä¸åˆ° pako åº«ï¼Œå°‡ä¸å£“ç¸®ç›´æ¥å‚³è¼¸");
        base64Data = btoa(encodeURIComponent(jsonString));
    }
    
    // åˆ¤æ–·é•·åº¦æ˜¯å¦è¶…éç€è¦½å™¨æ¥µé™ (ç´„ 2000 å­—å…ƒ)
    if (base64Data.length < 1500) {
        const shortUrl = `${window.location.origin}?import=${base64Data}`;
        copyToClipboard(shortUrl);
        showMessage("âš¡ å¿«æ·é€£çµå·²è¤‡è£½ (é©ç”¨æ–¼è¨­å®šèˆ‡å–®æ—¥è¡Œç¨‹)");
    } else {
        const fileId = await uploadToGDrive(jsonString);
        const cloudUrl = `${window.location.origin}?fileId=${fileId}`;
        copyToClipboard(cloudUrl);
        showMessage("â˜ï¸ é›²ç«¯é€£çµå·²è¤‡è£½ (é©ç”¨æ–¼å®Œæ•´å¤šæ—¥è¡Œç¨‹)");
    }
}



/** ğŸ“¥ ç¶²å€åµæ¸¬èˆ‡è§£æå¼•æ“ (v8.6 æ——è‰¦ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. [å”è­°å¤§ä¸€çµ±]ï¼šå°‡é›²ç«¯ä¸‹è¼‰é‚è¼¯æ”¶ç´è‡³ cloudManager.downloadFile çµ±ä¸€èª¿åº¦ã€‚
 * 2. [æ™ºæ…§é€£å‹•]ï¼šç„¡è«–æ˜¯ Base64 æˆ–é›²ç«¯ IDï¼Œæœ€çµ‚å‡å°å…¥ renderSmartRestoreSelectorã€‚
 * 3. [æŒ‡ç´‹æ¸…æ½”]ï¼šç¢ºä¿é‚„åŸå‰ URL å·²è¢«ç‰©ç†æ·¨åŒ–ï¼Œé˜²æ­¢ç„¡é™é‡è¼‰å¾ªç’°ã€‚
 */
async function checkUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const importData = urlParams.get('import');
    const fileId = urlParams.get('fileId');

    // ğŸŒŸ [åˆ†æµ A] è™•ç†å¿«æ· Base64 é€£çµ (é©ç”¨è¼•é‡æ•¸æ“š)
    if (importData) {
        showMessage("âš¡ åµæ¸¬åˆ°å¿«æ·åˆ†äº«å”è­°ï¼Œæ­£åœ¨è§£ç¢¼...", "info");
        try {
            // 1. ç‰©ç†é‚„åŸ Base64 æŒ‡ç´‹
            const normalizedBase64 = importData.replace(/-/g, '+').replace(/_/g, '/');
            const binaryString = atob(normalizedBase64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            let decoded;
            try {
                // 2. åŸ·è¡Œ pako.ungzip (å°æ‡‰ generateShareLink çš„ gzip)
                const decompressed = pako.ungzip(bytes, { to: 'string' });
                decoded = JSON.parse(decompressed);
            } catch (pakoErr) {
                console.warn("ğŸ›¡ï¸ Pako å”è­°ä¸åŒ¹é…ï¼Œå˜—è©¦ Legacy è§£æ...");
                decoded = JSON.parse(decodeURIComponent(escape(binaryString)));
            }

            // 3. å–šé†’æ™ºæ…§æŒ‘é¸å™¨ä»‹é¢
            if (decoded) {
                const payload = decoded.content || decoded;
                renderSmartRestoreSelector(payload, decoded.timestamp || new Date());
            }

            // 4. ç‰©ç†æ¸…ç† URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
        } catch (e) {
            console.error("âŒ å¿«æ·åŒ¯å…¥è§£æç½é›£:", e);
            showMessage("âŒ æ•¸æ“šå°è£ææ¯€æˆ–ä¸æ”¯æ´æ­¤ç‰ˆæœ¬æ ¼å¼", "error");
        }
    } 
    
    // ğŸŒŸ [åˆ†æµ B] è™•ç† Google Drive é›²ç«¯ä¸­ç¹¼åŒ¯å…¥ (é©ç”¨ 279+ ç­†å¤§å‹å°è£)
    else if (fileId) {
        showMessage("â˜ï¸ åµæ¸¬åˆ°é›²ç«¯è¨—ç®¡é€£çµï¼Œæ­£åœ¨é€£ç·š...", "info");
        try {
            // 1. æª¢æŸ¥æ†‘è­‰é– (éœ€ç¢ºä¿ cloudManager å·²åˆå§‹åŒ–)
            const token = localStorage.getItem('gdrive_token');
            if (!token) {
                showMessage("ğŸ”‘ é›²ç«¯é€£çµå—é™ï¼šè«‹å…ˆåŸ·è¡Œ Google æˆæ¬Š", "warning");
                // å»¶é²å–šé†’æˆæ¬Šè¦–çª—ï¼Œç¢ºä¿ä½¿ç”¨è€…çœ‹å¾—åˆ°æç¤º
                setTimeout(() => cloudManager.initAuth(), 1200);
                return;
            }

            // 2. ä½¿ç”¨ç‰©ç†ä¸­æ¨ä¸‹è¼‰æª”æ¡ˆå…§å®¹
            const cloudData = await cloudManager.downloadFile(fileId);
            if (!cloudData) throw new Error("Cloud Data Empty");

            const payload = cloudData.content || cloudData;

            // 3. å•Ÿå‹•é€è¦–èˆ‡æŒ‘é¸ä»‹é¢
            renderSmartRestoreSelector(payload, cloudData.timestamp || new Date());
            
            // 4. ç‰©ç†æ¸…ç† URL
            window.history.replaceState({}, document.title, window.location.pathname);

        } catch (e) {
            console.error("âŒ é›²ç«¯è¨—ç®¡åŒ¯å…¥å¤±æ•—:", e);
            showMessage("âŒ ç„¡æ³•å¾ä¼ºæœå™¨å–å›åˆ†äº«å…§å®¹", "error");
        }
    }
}


/** ğŸ“¥ æ•¸æ“šå…¨é‡å›æ­¸å¼•æ“ (ä¸€å‹æ°¸é€¸å‹•æ…‹å°ä½ç‰ˆ) 
 * ä¿®æ­£é …ç›®ï¼š
 * 1. ã€ç‰©ç†å°ä½ã€‘æ–°å¢ config_store å¯«å…¥ï¼Œç¢ºä¿ Checklist å°è£ç‚º checklist_data æ°¸ä¹…å›ºåŒ–ã€‚
 * 2. ã€ç£å€æ¸…å ´ã€‘åœ¨å¯«å…¥å‰åŸ·è¡Œ store.clear()ï¼Œç¢ºä¿ä¸åŒè¡Œç¨‹çš„è³‡ç”¢ï¼ˆå¦‚è·¯ç¶²ã€åº§æ¨™ï¼‰ä¸äº¤å‰æ±¡æŸ“ã€‚
 * 3. ã€æ ¼å¼è‡ªç™’ã€‘è‡ªå‹•è­˜åˆ¥ Base64 æˆ–ç´” JSON æ ¼å¼ï¼Œä¸¦åµæ¸¬ payload ä¾†æºã€‚
 */
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    // ğŸ›¡ï¸ ç‰©ç†é˜²ç¦¦ï¼šæ¸…é™¤èƒŒæ™¯å®šæ™‚å™¨ï¼Œé˜²æ­¢èˆŠå®šä½é‚è¼¯å¹²æ“¾
    for (let i = 1; i < 9999; i++) window.clearTimeout(i);

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const rawText = e.target.result.trim();
            let decodedData;
            
            // ğŸŒŸ æ ¼å¼è‡ªç™’ï¼šæ”¯æ´åŠ å¯†å¾Œçš„ Base64 æˆ–æ¨™æº– JSON
            try {
                decodedData = JSON.parse(rawText);
            } catch (jsonErr) {
                const decodedBase64 = decodeURIComponent(atob(rawText));
                decodedData = JSON.parse(decodedBase64);
            }

            if (!decodedData) throw new Error('ç„¡æ³•è¾¨è­˜æ•¸æ“šæ ¼å¼');

            // ğŸŒŸ ç‰©ç†ç©¿é€ï¼šæå– payload (ç›¸å®¹ content å°è£æˆ–å¹³é¢çµæ§‹)
            const payload = decodedData.content || decodedData.data || decodedData;
            
            // --- ğŸš€ A. æå–æ ¸å¿ƒè¡Œç¨‹è³‡ç”¢ ---
            const incomingTrips = payload.trips || (Array.isArray(payload) ? payload : []);
            const incomingBucket = payload.bucketList || payload.buckets || [];
            const incomingShopping = payload.shoppingList || [];
            const incomingEmergency = payload.emergencyContacts || { embassies: [], medical: [] };
            const incomingChecklist = payload.checklist || payload.appSettings?.checklist || []; 

            // --- ğŸš€ B. æå–ç‰©ç†ç£å€è³‡ç”¢ ---
            const incomingDict = payload.dictionary || [];
            const incomingTrans = payload.translations || payload.translationVault || [];
            const incomingVault = payload.transportVault || [];
            const incomingGeo = payload.geoRegions || []; 

            console.log(`ğŸ“¡ è½åœ°å•Ÿå‹•ï¼šè¡Œç¨‹(${incomingTrips.length}) å­—å…¸(${incomingDict.length}) å€åŸŸ(${incomingGeo.length}) æ¸…å–®(${incomingChecklist.length})`);

            // --- ğŸ’¾ C. åŸ·è¡Œç‰©ç†åˆ†é å¯«å…¥ (IndexedDB æ ¸å¿ƒ) ---
            if (dbManager.db) {
                const storesToProcess = [
                    { name: 'transport_store', data: incomingVault, key: 'id' },
                    { name: 'dictionary_store', data: incomingDict, key: 'tag' },
                    { name: 'translations_store', data: incomingTrans, key: 'id' },
                    { name: 'geo_regions_store', data: incomingGeo, key: 'regionName' },
                    // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå°‡ Checklist ä»¥å°ˆç”¨ ID é–å…¥é…ç½®ç£å€
                    { name: 'config_store', data: [{ id: 'checklist_data', content: incomingChecklist }], key: 'id' }
                ];

                for (const storeObj of storesToProcess) {
                    await new Promise((resolve, reject) => {
                        const tx = dbManager.db.transaction([storeObj.name], 'readwrite');
                        const store = tx.objectStore(storeObj.name);
                        
                        // ğŸŒŸ æ¸…å ´ï¼šç¢ºä¿ç£å€ç´”æ·¨ï¼Œé˜²æ­¢èˆŠè¡Œç¨‹æ®˜ç•™åº§æ¨™æ±¡æŸ“æ–°è¡Œç¨‹
                        store.clear(); 
                        
                        if (storeObj.data && storeObj.data.length > 0) {
                            storeObj.data.forEach(item => {
                                const key = item[storeObj.key] || item.id || item.tag || null;
                                if (key) store.put(item);
                            });
                        }
                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject();
                    });
                }
                
                // åŒæ­¥å…¨å±€è®Šæ•¸èˆ‡åœ°ç†å¼•æ“ (ç”¨æ–¼ MapBox/Leaflet æ¸²æŸ“)
                if (incomingDict.length > 0) window.GLOBAL_DICT = incomingDict;
                if (incomingGeo.length > 0) {
                    window.GEO_REGIONS = incomingGeo.reduce((acc, curr) => {
                        acc[curr.regionName] = curr.aliases || [];
                        acc[curr.regionName + "_coords"] = { lng: curr.lng, lat: curr.lat, zoom: curr.zoom || 11 };
                        return acc;
                    }, {});
                }
            }

            // --- ğŸ”„ D. ç‹€æ…‹åŒæ­¥èˆ‡ UI å•Ÿå‹• ---
            if (state.trips.length === 0 || confirm('åµæ¸¬åˆ°ç¾æœ‰è¡Œç¨‹ï¼Œæ˜¯å¦åŸ·è¡Œå…¨é‡è¦†è“‹é‚„åŸï¼Ÿ')) {
                state.trips = incomingTrips;
                state.bucketList = incomingBucket;
                state.shoppingList = incomingShopping;
                state.emergencyContacts = incomingEmergency;
                state.checklist = incomingChecklist; // âœ… åŒæ­¥æ›´æ–°è¨˜æ†¶é«”ï¼Œè§£æ±ºæ¸²æŸ“æ–·è·¯
                state.translationVault = incomingTrans;
                state.transportVault = incomingVault;

                if (state.trips[0]) {
                    const firstTrip = state.trips[0];
                    state.currentTripId = firstTrip.id;
                    state.currentDayIndex = 0;
                    state.currentSubView = 'itinerary';
                }
                
                // ğŸŒŸ å¼·åˆ¶åŸ·è¡Œä¸€æ¬¡å­˜æª”ä»¥å›ºåŒ–ç‰©ç†ç‹€æ…‹ï¼Œç¢ºä¿ reload å¾Œè³‡æ–™ä¸æ¶ˆå¤±
                await saveData(true); 

                // ğŸŒŸ åŸ·è¡Œ UI é‡ç¹ªæµç¨‹
                if (typeof setupTripLayout === 'function') setupTripLayout();
                
                setTimeout(() => {
                    if (typeof renderTripDetail === 'function') renderTripDetail();
                    
                    // ğŸŒŸ è£œå„Ÿæ¸²æŸ“ï¼šå¦‚æœç›®å‰åœ¨ settings è¦–åœ–ï¼Œå¼·åˆ¶é‡ç¹ª Checklist
                    if (state.currentSubView === 'settings' && typeof renderSettingsView === 'function') {
                        renderSettingsView();
                    }
                    
                    if (typeof window.autoFocusTripMap === 'function') window.autoFocusTripMap();
                    
                    showMessage('âœ… å…¨é‡è³‡ç”¢åŒæ­¥å®Œç•¢ï¼šChecklist èˆ‡åœ°ç†æŒ‡ç´‹å·²é–å®šç£å€', 'success');
                }, 350);
            }

        } catch (err) {
            console.error("âŒ åŒ¯å…¥ç½é›£æ€§éŒ¯èª¤:", err);
            showMessage('åŒ¯å…¥å¤±æ•—ï¼šè³‡æ–™åŒ…æ ¼å¼ä¸ç¬¦æˆ–ç£å€æ‹’çµ•å¯«å…¥', 'error');
        }
    };
    reader.readAsText(file);
}


/** * åŸ·è¡Œæ™ºæ…§å·®ç•°åˆ†æ (2026 æ——è‰¦å°é½Šç‰ˆ)
 * ä½œç”¨ï¼šå°æ¯”å¤–éƒ¨æ•¸æ“šèˆ‡æœ¬åœ° IndexedDB ç‹€æ…‹ï¼Œæ‰¾å‡ºå¢é‡è®Šå‹•
 */
function processSmartDiff(incomingTrips) {
    pendingMergeData = []; // 1. é‡ç½®å¾…è™•ç†æ¸…å–®
    const container = document.getElementById('diff-list-container');
    if (container) container.innerHTML = ''; // 2. æ¸…ç©º UI å®¹å™¨

    // ğŸ›¡ï¸ æ•¸æ“šå®‰å…¨æ€§æª¢æŸ¥ï¼šç¢ºä¿å‚³å…¥çš„æ˜¯æ•¸çµ„
    const tripsArray = Array.isArray(incomingTrips) ? incomingTrips : [incomingTrips];

    tripsArray.forEach(newTrip => {
        // 3. å°‹æ‰¾æœ¬åœ°æ˜¯å¦æœ‰ç›¸åŒ ID çš„è¡Œç¨‹
        const localTrip = state.trips.find(t => t.id === newTrip.id);
        
        if (!localTrip) {
            // æ¨¡å¼ Aï¼šå…¨æ–°è¡Œç¨‹ (æ•´å€‹ Package åŒ¯å…¥)
            addDiffItem('new_trip', `å…¨æ–°è¡Œç¨‹: ${newTrip.name}`, newTrip);
        } else {
            // æ¨¡å¼ Bï¼šæ·±åº¦æ¯”å°ç¾æœ‰è¡Œç¨‹
            if (!newTrip.days) return;

            newTrip.days.forEach(newDay => {
                if (!newDay.schedules) return;

                newDay.schedules.forEach(newSched => {
                    // æ‰¾å‡ºæœ¬åœ°å°æ‡‰å¤©æ•¸èˆ‡æ™¯é»
                    const localDay = localTrip.days.find(d => d.dayNum === newDay.dayNum);
                    const localSched = localDay?.schedules.find(s => s.id === newSched.id);

                    if (!localSched) {
                        // å­é …ç›®æ¨¡å¼ 1ï¼šæ–°å¢æ™¯é» (æœ¬åœ°æ²’æœ‰é€™å€‹ ID)
                        addDiffItem('new_item', `[D${newDay.dayNum}] æ–°å¢: ${newSched.name}`, { 
                            tripId: newTrip.id, 
                            dayNum: newDay.dayNum, 
                            schedule: newSched 
                        });
                    } else if (getScheduleHash(localSched) !== getScheduleHash(newSched)) {
                        // å­é …ç›®æ¨¡å¼ 2ï¼šå…§å®¹ç•°å‹• (é€éæŒ‡ç´‹é›œæ¹Šåµæ¸¬å…§å®¹ã€æ™‚é–“ã€å‚™è¨»çš„è®ŠåŒ–)
                        addDiffItem('mod_item', `[D${newDay.dayNum}] ä¿®æ”¹: ${newSched.name}`, { 
                            tripId: newTrip.id, 
                            dayNum: newDay.dayNum, 
                            schedule: newSched 
                        });
                    }
                });
            });
        }
    });

    // 4. æœ€çµ‚åˆ†æµæ±ºç­–
    if (pendingMergeData.length > 0) {
        // é¡¯ç¤ºå·®ç•°æ¸…å–®è®“ä½¿ç”¨è€…æ‰‹å‹•å‹¾é¸
        toggleModal('smart-diff-modal');
    } else {
        // ğŸŒŸ æ ¸å¿ƒå¢å¼·ï¼šå¦‚æœè¡Œç¨‹å…§å®¹æ²’è®Šï¼Œä½†ã€Œæš«å­˜æ¨¡çµ„ã€è£¡æœ‰æ±è¥¿(å¦‚å­—å…¸ã€å‚™é¸åå–®)ï¼Œå‰‡ç›´æ¥è·³è½‰å¯«å…¥
        if (window.pendingCloudMetadata && 
           (window.pendingCloudMetadata.bucketList.length > 0 || window.pendingCloudMetadata.dictionary.length > 0)) {
            applySmartMerge(); // ç›´æ¥åŸ·è¡Œæœ€çµ‚å¯«å…¥æµç¨‹
        } else {
            showMessage('å…§å®¹å®Œå…¨ä¸€è‡´ï¼Œä¸éœ€æ›´æ–°', 'info');
        }
    }
}




async function applySmartMerge() {
    const selectedDiffs = pendingMergeData.filter(d => d.selected);
    if (selectedDiffs.length === 0) {
        showMessage('è«‹è‡³å°‘å‹¾é¸ä¸€é …è¦åŒ¯å…¥çš„å…§å®¹', 'info');
        return;
    }

    try {
        selectedDiffs.forEach(diff => {
            if (diff.type === 'new_trip') {
                const idx = state.trips.findIndex(t => t.id === diff.data.id);
                if (idx !== -1) {
                    state.trips[idx] = diff.data; // ID ç›¸åŒå‰‡è¦†è“‹ (å›æº¯å ´æ™¯)
                } else {
                    state.trips.push(diff.data); // å…¨æ–°è¡Œç¨‹
                }
            } else if (diff.type === 'new_item' || diff.type === 'mod_item') {
                const { tripId, dayNum, schedule } = diff.data;
                const targetTrip = state.trips.find(t => t.id === tripId);
                const targetDay = targetTrip?.days.find(d => d.dayNum === dayNum);
                
                if (targetDay) {
                    if (!Array.isArray(targetDay.schedules)) targetDay.schedules = [];
                    const existingIdx = targetDay.schedules.findIndex(s => s.id === schedule.id);
                    if (existingIdx !== -1) {
                        targetDay.schedules[existingIdx] = schedule; 
                    } else {
                        targetDay.schedules.push(schedule); 
                    }
                    targetDay.schedules.sort((a, b) => a.startTime.localeCompare(b.startTime));
                    recalculateScheduleTimes(targetDay);
                }
            }
        });

        if (window.pendingCloudMetadata) {
            const { bucketList, dictionary } = window.pendingCloudMetadata;
            if (bucketList && bucketList.length > 0) {
                const existingNames = new Set((state.bucketList || []).map(i => i.name));
                bucketList.forEach(item => {
                    if (!existingNames.has(item.name)) {
                        state.bucketList = state.bucketList || [];
                        state.bucketList.push(item);
                    }
                });
            }
            if (dictionary && dictionary.length > 0) {
                for (const entry of dictionary) {
                    await dbManager.save('dictionary_store', entry);
                }
                window.GLOBAL_DICT = await dbManager.getAll('dictionary_store');
            }
            window.pendingCloudMetadata = null;
        }

        await saveData(); 
        toggleModal('smart-diff-modal');
        
        if (state.currentTripId) {
            renderTripDetail(); 
        } else {
            renderTripList();
        }
        showMessage(`âœ… å·²æˆåŠŸé‚„åŸä¸¦å¥—ç”¨ ${selectedDiffs.length} é …è®Šæ›´`, 'success');
    } catch (err) {
        console.error("é‚„åŸåŸ·è¡Œå¤±æ•—:", err);
        showMessage("âŒ å­˜å„²éç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
    }
}


async function executeDataImport(payload) {
    try {
        const content = payload.content || payload;
        const isFullBackup = !!content.appSettings || !!content.theme;

        if (content.trips && Array.isArray(content.trips)) {
            content.trips.forEach(newTrip => {
                const index = state.trips.findIndex(t => t.id === newTrip.id);
                if (index !== -1) {
                    state.trips[index] = newTrip;
                } else {
                    state.trips.push(newTrip);
                }
            });
        }

        if (content.bucketList && Array.isArray(content.bucketList)) {
            const currentTrip = getCurrentTrip();
            // ğŸŒŸ ä¿®æ­£é»ï¼šåªæœ‰åœ¨æœ‰é¸å®šè¡Œç¨‹æ™‚ï¼Œæ‰åŒ¯å…¥ã€Œè¡Œç¨‹å°ˆå±¬å‚™é¸åå–®ã€
            // å¦å‰‡æ‡‰åŒ¯å…¥åˆ°å…¨åŸŸ state.bucketList
            if (currentTrip) {
                if (!currentTrip.bucketList) currentTrip.bucketList = [];
                const existingNames = new Set(currentTrip.bucketList.map(b => b.name));
                content.bucketList.forEach(item => {
                    if (!existingNames.has(item.name)) currentTrip.bucketList.push(item);
                });
            } else {
                // è‹¥åœ¨ç¸½åˆ—è¡¨åŒ¯å…¥ï¼Œå­˜å…¥å…¨åŸŸå‚™é¸åº«
                state.bucketList = state.bucketList || [];
                const globalNames = new Set(state.bucketList.map(b => b.name));
                content.bucketList.forEach(item => {
                    if (!globalNames.has(item.name)) state.bucketList.push(item);
                });
            }
        }

        if (isFullBackup || payload.type === "CONFIG_TRANSFER") {
            if (content.theme) state.theme = { ...state.theme, ...content.theme };
            if (content.dictionary) {
                for (const entry of content.dictionary) {
                    await dbManager.save('dictionary_store', entry);
                }
                window.GLOBAL_DICT = await dbManager.getAll('dictionary_store');
            }
        }

        await saveData();
        renderTripList(); 
        showMessage("âœ… æ•¸æ“šå·²æˆåŠŸæ•´åˆåŒ¯å…¥", "success");
        
    } catch (e) {
        console.error("åŒ¯å…¥åŸ·è¡Œå¤±æ•—:", e);
        showMessage("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸ç›¸å®¹", "error");
    }
}


// --- 4. èˆŠç‰ˆç›¸å®¹èˆ‡å·¥å…· ---
// function copyJsonOutput() { ... } // è¤‡è£½æ–‡å­—

        // --- JSON å‚™ä»½åŠŸèƒ½ (INLINE) ---

        /** è¤‡è£½ JSON è¼¸å‡ºæ¬„ä½çš„å…§å®¹åˆ°å‰ªè²¼ç°¿ */
        function copyJsonOutput() {
             const textarea = document.getElementById('json-export-output');
             
             // é¸ä¸­ textarea å…§å®¹
             textarea.select();
             
             try {
                 // å˜—è©¦ä½¿ç”¨ç¾ä»£ Clipboard API
                 navigator.clipboard.writeText(textarea.value).then(() => {
                      showMessage('JSON èªæ³•å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'info'); 
                 }).catch(() => {
                      // åŸ·è¡Œ fallback
                      document.execCommand('copy');
                      showMessage('JSON èªæ³•å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'info'); 
                 });
             } catch (err) {
                 // Fallback for non-secure contexts or older browsers
                 document.execCommand('copy');
                 showMessage('JSON èªæ³•å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'info'); 
             }
        }



// function importJsonFromText() { ... } // è²¼ä¸Šæ–‡å­—é‚„åŸ
/** ä¿®æ­£å¾Œçš„ JSON èªæ³•åŒ¯å…¥ */
function importJsonFromText() {
    const jsonText = document.getElementById('json-import-input').value.trim();
    if (!jsonText) return;

    try {
        const rawData = JSON.parse(jsonText);
        const trips = (rawData.trips && Array.isArray(rawData.trips)) ? rawData.trips : rawData;
        
        if (!Array.isArray(trips)) throw new Error('èªæ³•çµæ§‹æ‡‰ç‚ºè¡Œç¨‹é™£åˆ—æˆ–å®Œæ•´å‚™ä»½ç‰©ä»¶');

        state.trips = trips;
        saveData();
        state.trips.forEach(trip => trip.days.forEach(recalculateScheduleTimes));
        switchView('list');
        showMessage('JSON è¼‰å…¥æˆåŠŸ', 'success');
    } catch (error) {
        document.getElementById('import-status-text').textContent = `èªæ³•éŒ¯èª¤: ${error.message}`;
    }
}


// é›²ç«¯Google Driverå„²å­˜èˆ‡ä¸‹è¼‰


/** ğŸ“¥ é›²ç«¯è¼‰å…¥ï¼šå¾ Google Drive æŠ“å›å‚™ä»½ */
async function loadFromCloud() {
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) {
        showMessage("è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ", "warning");
        cloudManager.initAuth();
        return;
    }

    try {
        showMessage("ğŸ” æ­£åœ¨æœå°‹é›²ç«¯å‚™ä»½...", "info");
        // æœå°‹æª”æ¡ˆ
        const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='MyTripBackup.json' and parents in 'appDataFolder'&spaces=appDataFolder&fields=files(id, name)`;
        const res = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const { files } = await res.json();

        if (!files || files.length === 0) {
            showMessage("ğŸ“­ é›²ç«¯æŸ¥ç„¡å‚™ä»½æª”æ¡ˆ", "warning");
            return;
        }

        // ä¸‹è¼‰æª”æ¡ˆå…§å®¹
        const downloadUrl = `https://www.googleapis.com/drive/v3/files/${files[0].id}?alt=media`;
        const fileRes = await fetch(downloadUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const cloudData = await fileRes.json();

        // èª¿ç”¨ä½ ä¹‹å‰çš„æ™ºæ…§æ¯”å°é‚è¼¯ (processSmartDiff)
        const incomingTrips = cloudData.trips || cloudData.data?.trips;
        if (incomingTrips) {
            processSmartDiff(incomingTrips); 
            showMessage("âœ… å·²ç²å–é›²ç«¯è³‡æ–™ï¼Œè«‹é€²è¡Œæ¯”å°", "success");
        }
    } catch (error) {
        console.error("è¼‰å…¥å¤±æ•—:", error);
        showMessage("âŒ é›²ç«¯è¼‰å…¥å¤±æ•—", "error");
    }
}

/** â˜ï¸ é›²ç«¯å‚³è¼¸å®˜ (v8.9 å¯¦é«”å°ä½ç‰ˆ) 
 * ä¿®æ­£ï¼šå»¢æ£„æœ¬åœ°ä¸‹è¼‰æ¨¡æ“¬ï¼Œå¼·åˆ¶åŸ·è¡Œ Google Drive API å¯¦é«”å‚³è¼¸
 * ç›®çš„ï¼šç¢ºä¿ç”ŸæˆçœŸå¯¦çš„ fileIdï¼Œè§£æ±º local-file-mode éŒ¯èª¤
 */
async function uploadToGDrive(jsonString) {
    console.log("ğŸ“¡ [Cloud-Upload] å•Ÿå‹•å¯¦é«”å‚³è¼¸æµç¨‹...");
    
    // 1. å–å¾—æœ€æ–°æ†‘è­‰
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) {
        showMessage("ğŸ”‘ æœªåµæ¸¬åˆ°é›²ç«¯æ†‘è­‰ï¼Œè«‹å…ˆåŸ·è¡Œæˆæ¬Š", "warning");
        cloudManager.initAuth();
        return null;
    }

    try {
        // 2. å°è£æª”æ¡ˆåç¨±
        const fileName = `SHARE_TRIP_${Date.now()}.json`;

        // 3. å‘¼å«ä¸­æ¨ä¸Šå‚³ï¼šuseAppData è¨­ç‚º falseï¼Œæª”æ¡ˆæ‰èƒ½è¢«é€£çµæŒæœ‰è€…è®€å–
        const gFile = await cloudManager.uploadFile(fileName, jsonString, false);

        if (gFile && gFile.id) {
            console.log(`âœ… é›²ç«¯ç¯€é»å·²å»ºç«‹: ${gFile.id}`);
            return gFile.id; // å›å‚³çœŸæ­£çš„ Google File ID
        } else {
            throw new Error("æœªèƒ½ç²å–å‚³è¼¸å›å‚³ ID");
        }
    } catch (err) {
        console.error("âŒ é›²ç«¯å‚³è¼¸å¤±æ•—:", err);
        showMessage("â˜ï¸ å‚³è¼¸å¤±æ•—ï¼Œæ”¹æ¡æœ¬åœ°ä¸‹è¼‰å‚™ä»½", "error");
        
        // ä¿åº•æ©Ÿåˆ¶ï¼šè‹¥é›²ç«¯å¤±æ•—ï¼Œæ‰åŸ·è¡ŒåŸæœ¬çš„ä¸‹è¼‰å‹•ä½œ
        executeLocalDownload(jsonString);
        return "upload-failed-fallback";
    }
}

/** è¼”åŠ©ï¼šåŸæœ‰çš„æœ¬åœ°ä¸‹è¼‰é‚è¼¯ä½œç‚ºä¿åº• */
function executeLocalDownload(jsonString) {
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Backup_Local_${new Date().getTime()}.json`;
    a.click();
}


/** ğŸ­ æ•¸æ“šæ¬Šå¨å·¥å»  (v7.2ï¼šç‰©ç†å¤§ä¸€çµ±å…¨å°ä½ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. è£œé½Šç£å€ï¼šæ­£å¼å°‡ transport_store èˆ‡ matrix_store ç´å…¥æƒæã€‚
 * 2. æŒ‡ç´‹æ ¡æº–ï¼šç¢ºä¿ç‰©ç†å­—å…¸èˆ‡è·¯ç¶²è³‡ç”¢èƒ½ 100% è¢«æ‰“åŒ…ã€‚
 * 3. é«”é‡é è­¦ï¼šé‡å° 299+ æ™¯é»æ™‚ä»£çš„åˆç†é«”é‡é€²è¡Œé–€æª»æ ¡æ­£ã€‚
 */
async function generateFullSnapshot() {
    console.log("ğŸ“¡ å•Ÿå‹•å…¨é‡æ•¸æ“šæŒ‡ç´‹æƒæ (v7.2)...");
    
    // ğŸŒŸ 1. ç‰©ç†å±¤æ·±åº¦æƒæï¼šæ¶µè“‹æ‰€æœ‰é—œéµæˆ°ç•¥ç£å€
    const stores = [
        'dictionary_store', 
        'private_store', 
        'transport_store',  // ğŸš‰ å¯¦é«”è·¯ç¶²ç£å€
        'matrix_store',     // â³ ç§»å‹•æ¬Šé‡çŸ©é™£
        'translations_store', 
        'public_store'
    ];
    
    const results = {};

    for (const storeName of stores) {
        try {
            const data = await dbManager.getAll(storeName);
            // ç¢ºä¿æ•¸æ“šæ·±åº¦éš”é›¢ï¼Œé˜²æ­¢å°è±¡åƒè€ƒæ±¡æŸ“
            results[storeName] = JSON.parse(JSON.stringify(data || []));
            console.log(`ğŸ“¡ [ç‰©ç†æ ¡æº–] ${storeName}: åµæ¸¬åˆ° ${results[storeName].length} ç­†ç‰©ç†æŒ‡ç´‹`);
        } catch (e) {
            console.warn(`âš ï¸ ç„¡æ³•è®€å–ç‰©ç†åˆ†é : ${storeName}`, e);
            results[storeName] = [];
        }
    }

    // ğŸŒŸ 2. æ ¸å¿ƒç‹€æ…‹é‚„åŸ (å¾ private_store æå– main_state å¿«ç…§ä½œç‚ºå‚™ä»½åŸºæº–)
    const dbMainState = results['private_store'].find(i => i.id === 'main_state') || {};

    // ğŸŒŸ 3. å…¨æ–¹ä½æ¬Šå¨å°ä½å°è£
    const snapshot = {
        type: "FULL_BACKUP_V7.2",
        version: state.version || "3.0.0",
        timestamp: new Date().toISOString(),
        content: {
            // A. èªæ„æ¨¡çµ„ï¼šå¼·åˆ¶æ¡ç”¨ DB å¯¦é«”è¦å‰‡
            dictionary: results['dictionary_store'].length > 0 ? results['dictionary_store'] : (window.GLOBAL_DICT || []),
            
            // B. ğŸš‰ äº¤é€šè·¯ç¶²æ¨¡çµ„ï¼šç¢ºä¿ 21 æ¢(æˆ–æ›´å¤š)ç‰©ç†ç·šè·¯è³‡ç”¢å®Œå…¨æ­¸ä½
            transportVault: results['transport_store'],
            
            // C. â³ ç§»å‹•æ¬Šé‡çŸ©é™£ï¼šé–å®šè·¨å€ç§»å‹•è¨ˆç®—æŒ‡ç´‹
            matrixVault: results['matrix_store'],

            // D. è¡Œç¨‹èˆ‡å·¥åŠæ•¸æ“šï¼šå„ªå…ˆå– DB ç‰©ç†å¿«ç…§ï¼Œè¨˜æ†¶é«”ç‚ºè£œä½
            trips: (state.trips && state.trips.length > 0) ? state.trips : (dbMainState.trips || []),
            workshops: (state.workshops && state.workshops.length > 0) ? state.workshops : (dbMainState.workshops || []),
            
            // E. ç§æœ‰/åˆ†äº«è³‡æ–™ï¼šç‰©ç†å°ä½
            privateData: results['private_store'],
            publicData: results['public_store'],
            
            // F. ç¿»è­¯æ”¶è—åŒ£èˆ‡è³¼ç‰©æ¸…å–®
            translations: results['translations_store'],
            shoppingList: state.shoppingList || dbMainState.shoppingList || [],
            emergencyContacts: state.emergencyContacts || dbMainState.emergencyContacts || {},
            
            // G. å…¨åŸŸé…ç½®èˆ‡ç‹€æ…‹
            bucketList: (state.bucketList && state.bucketList.length > 0) ? state.bucketList : (dbMainState.bucketList || []),
            theme: state.theme || dbMainState.theme || {},
            totalBudget: state.totalBudget || dbMainState.totalBudget || 0,
            currency: state.currency || dbMainState.currency || 'JPY',
            apiTotalCostNTD: state.apiTotalCostNTD || dbMainState.apiTotalCostNTD || 0
        }
    };

    // ğŸŒŸ 4. æœ€çµ‚é«”é‡èˆ‡æŒ‡ç´‹ä¸€è‡´æ€§æª¢æŸ¥
    const finalBlob = JSON.stringify(snapshot);
    const finalSizeKB = (finalBlob.length / 1024).toFixed(2);
    
    console.log(`ğŸ“Š [Snapshot v7.2 Report]
    ------------------------------
    âœ… ç‰©ç†å­—å…¸: ${snapshot.content.dictionary.length} æ¢
    âœ… è·¯ç¶²è³‡ç”¢: ${snapshot.content.transportVault.length} æ¢
    âœ… æ ¸å¿ƒè¡Œç¨‹: ${snapshot.content.trips.length} å€‹
    âœ… ç‰©ç†åˆ†é : ${stores.length} å€‹
    ğŸš€ å°è£é«”é‡: ${finalSizeKB} KB
    ------------------------------`);

    // å®‰å…¨é–€æª»æ ¡æ ¸ï¼šè€ƒé‡ 299+ æ™¯é»èˆ‡è·¯ç¶²ï¼Œ300KB ç‚ºæœ€ä½å®‰å…¨æ°´ä½
    if (parseFloat(finalSizeKB) < 300) {
        console.error("ğŸš¨ è­¦å‘Šï¼šæ•¸æ“šé«”é‡ç–‘ä¼¼ç•°å¸¸ç¸®æ°´ï¼Œè«‹æª¢æŸ¥ IndexedDB é€£çµç‹€æ…‹ï¼");
    }

    return snapshot;
}


/** ğŸš€ åŸ·è¡Œå…¨é‡é›²ç«¯åŒæ­¥ (v7.2ï¼šç‰©ç†å¤§ä¸€çµ±åŠ å›ºç‰ˆ) 
 * ä¿®æ­£ï¼š
 * 1. é–€æª»æ ¡æº–ï¼šé‡å° v7.2 ç²¾ç…‰æ•¸æ“šé‡ï¼Œå°‡å®‰å…¨è­¦æˆ’ç·šå®šæ–¼ 300KBã€‚
 * 2. åŸå­ä¿è­·ï¼šå¼•å…¥æ›´æ–°é–ï¼Œé˜²æ­¢å‚™ä»½æœŸé–“æ•¸æ“šæŠ–å‹•ã€‚
 * 3. å®¹éŒ¯è™•ç†ï¼šå„ªåŒ–èˆ‡ uploadToAppDataFolder çš„éåŒæ­¥å°æ¥ã€‚
 */
async function syncAllToCloud() {
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) { 
        showMessage("ğŸ”‘ è«‹å…ˆæˆæ¬Šé€£çµ Google Drive", "error"); 
        if (typeof handleCloudAuth === 'function') handleCloudAuth();
        return; 
    }

    // ğŸ›¡ï¸ 0. å•Ÿå‹•åŸå­é–ï¼šç¢ºä¿æƒææœŸé–“è³‡æ–™åº«è™•æ–¼éœæ…‹
    window.isTransportUpdating = true;

    try {
        if (!dbManager.db) await dbManager.init();
        showMessage("ğŸ“Š æ­£åœ¨æå–ç‰©ç†ç£å€æŒ‡ç´‹...", "info");

        // ğŸŒŸ 1. èª¿ç”¨ v7.2 æ•¸æ“šæ¬Šå¨å·¥å» 
        const snapshot = await generateFullSnapshot();
        const uploadStr = JSON.stringify(snapshot);
        const currentSize = uploadStr.length;
        const sizeInKB = (currentSize / 1024).toFixed(2);

        console.log(`ğŸ“¡ [Cloud-Sync] å°è£é«”é‡ç¢ºèª: ${sizeInKB} KB`);

        // ğŸŒŸ 2. é‚è¼¯æ ¡é©—é–€æª» (ç²¾ç…‰å¾Œå»ºè­°æ°´ä½)
        // è€ƒæ…®åˆ° 299+ æ™¯é»ã€21 æ¢è·¯ç¶²èˆ‡å­—å…¸ï¼Œä½æ–¼ 300KB é€šå¸¸ä»£è¡¨æ•¸æ“šè®€å–å¤±æ•—
        if (currentSize < 307200) { 
            alert(`ğŸš¨ æ•¸æ“šèç¸®é è­¦ï¼\nç›®å‰é«”é‡åƒ… ${sizeInKB} KBï¼Œä½æ–¼ 300KB å®‰å…¨é–€æª»ã€‚\nå‚™ä»½å·²ä¸­æ­¢ï¼Œè«‹ç¢ºèªå­—å…¸èˆ‡è·¯ç¶²æ˜¯å¦æ­£ç¢ºè¼‰å…¥ã€‚`);
            window.isTransportUpdating = false;
            return;
        }

        // ğŸŒŸ 3. å‘½åå°ä½
        const now = new Date();
        const defaultName = `${now.getMonth()+1}${now.getDate()}_ä¹å·ç‰©ç†å…¨å°ä½å‚™ä»½`;
        const customTag = prompt(`æ•¸æ“šå°è£æˆåŠŸ (${sizeInKB} KB)ã€‚\nè«‹è¼¸å…¥æ­¤å‚™ä»½ç‰ˆæœ¬çš„æˆ°ç•¥åç¨±ï¼š`, defaultName);
        
        if (customTag === null) {
            window.isTransportUpdating = false;
            return;
        }

        const fileName = `${customTag.trim() || 'Perfect_Vault'}.json`;
        showMessage(`ğŸš€ æ­£åœ¨å°‡æŒ‡ç´‹åŒ…è£¹å‚³é€è‡³é›²ç«¯...`, "info");

        // ğŸŒŸ 4. åŸ·è¡Œç‰©ç†å±¤å‚³è¼¸
        // ä½¿ç”¨ false ç¢ºä¿ä¸è¦†è“‹èˆŠæª”ï¼Œä¿ç•™æ­·å²ç‰ˆæœ¬ä»¥åˆ©å›æº¯
        const result = await uploadToAppDataFolder(fileName, uploadStr, false);

        if (result) {
            // æ›´æ–°æœ¬åœ°æ°´ä½ç´€éŒ„ï¼Œä¾›å¾ŒçºŒè¨ºæ–·åƒè€ƒ
            localStorage.setItem('last_cloud_backup_size', currentSize.toString());
            localStorage.setItem('last_cloud_backup_time', now.toISOString());
            
            showMessage(`âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼æª”æ¡ˆï¼š${fileName}`, "success");
            
            // ğŸ”„ å³æ™‚åˆ·æ–°é›²ç«¯ç®¡ç†ä¸­å¿ƒåˆ—è¡¨
            if (typeof renderCloudManagerUI === 'function') {
                renderCloudManagerUI();
            }
        }

    } catch (error) {
        console.error("âŒ é›²ç«¯åŒæ­¥ç½é›£åˆ†æ:", error);
        showMessage(`åŒæ­¥å¤±æ•—ï¼š${error.message}`, "error");
    } finally {
        // ğŸ”“ 5. è§£é™¤åŸå­é–
        window.isTransportUpdating = false;
        console.log("ğŸ”“ é›²ç«¯ä»»å‹™çµæŸï¼Œè§£é™¤ç‰©ç†é–å®š");
    }
}

/**
 * ğŸ“¡ åº•å±¤é€šè¨Šå®˜ï¼šåŸ·è¡Œ Google Drive æª”æ¡ˆä¸Šå‚³
 * @param {string} fileName æª”å
 * @param {string} content JSON å­—ä¸²
 * @param {boolean} overwrite æ˜¯å¦è¦†è“‹åŒåæª”æ¡ˆ (é è¨­ç‚º falseï¼Œå³å»ºç«‹æ–°ç‰ˆæœ¬)
 */
async function uploadToAppDataFolder(fileName, content, overwrite = false) {
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) throw new Error("Missing Access Token");

    let existingFileId = null;

    // ğŸŒŸ 1. åªæœ‰åœ¨æŒ‡å®šã€Œè¦†è“‹æ¨¡å¼ã€æ™‚ï¼Œæ‰å»æœå°‹æ˜¯å¦æœ‰åŒåæª”æ¡ˆ
    if (overwrite) {
        const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and parents in 'appDataFolder'&spaces=appDataFolder`;
        const searchRes = await fetch(searchUrl, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const searchData = await searchRes.json();
        if (searchData.files && searchData.files.length > 0) {
            existingFileId = searchData.files[0].id;
        }
    }

    // 2. æ§‹å»ºä¸­ç¹¼è³‡æ–™ (Metadata)
    const metadata = {
        name: fileName,
        mimeType: 'application/json',
        // å¦‚æœæ˜¯æ›´æ–°èˆŠæª”ï¼Œä¸éœ€è¦å¡« parentsï¼›å¦‚æœæ˜¯æ–°æª”æ¡ˆï¼Œå¿…é ˆæŒ‡å®šåœ¨ appDataFolder ä¸‹
        ...(existingFileId ? {} : { parents: ['appDataFolder'] })
    };

    // 3. ä½¿ç”¨ Multipart ä¸Šå‚³æ ¼å¼ (Metadata + File Body)
    const formData = new FormData();
    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    formData.append('file', new Blob([content], { type: 'application/json' }));

    // ğŸŒŸ 4. æ ¹æ“šæ˜¯å¦å­˜åœ¨ FileId æ±ºå®š URL èˆ‡ Method
    // POST ç”¨æ–¼æ–°å»ºï¼ŒPATCH ç”¨æ–¼æ›´æ–°å…§å®¹
    let uploadUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
    let method = 'POST';

    if (existingFileId) {
        uploadUrl = `https://www.googleapis.com/upload/drive/v3/files/${existingFileId}?uploadType=multipart`;
        method = 'PATCH';
    }

    // 5. åŸ·è¡Œå‚³è¼¸
    const response = await fetch(uploadUrl, {
        method: method,
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
    });

    if (!response.ok) {
        const err = await response.json();
        console.error("Google Drive API Error:", err);
        throw new Error(err.error?.message || "Upload Failed");
    }

    return await response.json();
}


/** ğŸ“¥ å¾é›²ç«¯æŠ“å–æœ€æ–°çš„å…¨é‡å‚™ä»½ä¸¦åŸ·è¡Œé‚„åŸ */
async function fetchFromCloud() {
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) return;

    try {
        showMessage("ğŸ” æ­£åœ¨å¾é›²ç«¯æœå°‹å‚™ä»½...", "info");
        
        const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='MyTripBackup.json' and parents in 'appDataFolder'&spaces=appDataFolder&fields=files(id, name)`;
        const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const { files } = await searchRes.json();

        if (!files || files.length === 0) {
            showMessage("ğŸ“­ é›²ç«¯æŸ¥ç„¡å‚™ä»½æª”æ¡ˆ", "warning");
            return;
        }

        // ä¸‹è¼‰æª”æ¡ˆå…§å®¹
        const fileId = files[0].id;
        const downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
        const fileRes = await fetch(downloadUrl, { headers: { 'Authorization': `Bearer ${token}` } });
        const cloudData = await fileRes.json();

        // ä½¿ç”¨æˆ‘å€‘ä¹‹å‰å¯«å¥½çš„è¬ç”¨è§£æå™¨èˆ‡å·®ç•°æ¯”å°
        const incomingTrips = cloudData.data?.trips || cloudData.trips;
        if (incomingTrips) {
            processSmartDiff(incomingTrips); // é€²å…¥æ¯”å°å½ˆçª—
        }
    } catch (error) {
        console.error("é›²ç«¯è®€å–å¤±æ•—:", error);
        showMessage("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™", "error");
    }
}


/** ğŸ”— ç”Ÿæˆåˆ†äº«ç¶²å€ (v8.8 é›²ç«¯æ¬Šé™å°ä½ç‰ˆ)
 * ä¿®æ­£é …ç›®ï¼š
 * 1. [æ¬Šé™è§£é–]ï¼šå°‡ useAppData æ”¹ç‚º falseï¼Œç¢ºä¿ç”Ÿæˆçš„ fileId å…·å‚™åˆ†äº«å±¬æ€§ã€‚
 * 2. [Token é æª¢]ï¼šåœ¨æ‰“åŒ…å‰å…ˆç¢ºèªæ†‘è­‰ï¼Œé˜²æ­¢é€²å…¥ local-file-mode æ¨¡æ“¬æ¨¡å¼ã€‚
 * 3. [è‡ªç™’å°ä½]ï¼šå¢åŠ å°è¾­å…¸ (dictionary) ç­†æ•¸çš„ç‰©ç†å°é½Šã€‚
 */
async function generateShareLink() {
    const currentTrip = state.trips.find(t => t.id === state.currentTripId);
    if (!currentTrip) {
        showMessage("âŒ æ‰¾ä¸åˆ°ç•¶å‰è¡Œç¨‹ï¼Œç„¡æ³•ç”Ÿæˆé€£çµ", "error");
        return;
    }

    // ğŸŒŸ 1. ç‰©ç†æ†‘è­‰é æª¢ï¼šè‹¥ç„¡ Token ç›´æ¥å¼•å°æˆæ¬Šï¼Œé˜²æ­¢ç”¢ç”Ÿç„¡æ•ˆé€£çµ
    const token = cloudManager.accessToken || localStorage.getItem('gdrive_token');
    if (!token) {
        showMessage("ğŸ”‘ è«‹å…ˆé€£çµ Google å¸³è™Ÿï¼Œæ‰èƒ½ç”Ÿæˆé›²ç«¯åˆ†äº«é€£çµ", "warning");
        cloudManager.initAuth();
        return;
    }

    const btn = event?.target?.closest('button');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = `<span>ğŸ›°ï¸ é›²ç«¯å‚³è¼¸ä¸­...</span>`;
    }
    
    showMessage("ğŸ“¦ æ­£åœ¨åŸ·è¡Œæ•¸æ“šè„«æ•å°è£...", "info");

    try {
        // 2. å‘¼å«éæ¿¾å¼•æ“
        const exportData = prepareLeanTrip(currentTrip);
        
        // 3. æ•¸æ“šå°è£ (Snapshot çµæ§‹)
        const payload = {
            type: "SHARED_TRIP",
            version: "8.8",
            timestamp: new Date().toISOString(),
            content: {
                trips: [exportData],
                // åƒ…å°è£æ­¤è¡Œç¨‹ç›¸é—œçš„å­—å…¸è¦å‰‡
                dictionary: (window.GLOBAL_DICT || []).filter(d => 
                    exportData.days.some(day => day.schedules?.some(s => s.customStyle === d.tag))
                )
            }
        };

        const jsonStr = JSON.stringify(payload);
        
        // 4. è¨ˆç®—å£“ç¸®é«”é‡
        let base64String = "";
        if (typeof pako !== 'undefined') {
            const binaryData = pako.gzip(jsonStr);
            base64String = btoa(String.fromCharCode(...binaryData))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        const baseUrl = window.location.origin + window.location.pathname;
        let finalUrl = "";

        // ğŸŒŸ 5. ç‰©ç†åˆ†æµé‚è¼¯
        // è·¯å¾‘ Aï¼šè³‡æ–™å°æ–¼ 1500 å­—å…ƒ -> èµ°ç¶²å€å”è­°
        if (base64String && base64String.length < 1500) {
            finalUrl = `${baseUrl}?import=${base64String}`;
            console.log("ğŸš€ Payload è¼•å·§ï¼Œæ¡ç”¨ Base64 ç›´æ¥å°ä½");
        } 
        // è·¯å¾‘ Bï¼šè³‡æ–™è¼ƒå¤§ -> åŸ·è¡Œé›²ç«¯ä¸­ç¹¼è¨—ç®¡
        else {
            showMessage("â˜ï¸ é«”é‡è¼ƒå¤§ï¼Œæ­£åœ¨è¨—ç®¡è‡³é›²ç«¯åˆ†æµä¼ºæœå™¨...", "info");
            const fileName = `SHARE_${exportData.name}_${Date.now()}.json`;
            
            // ğŸŒŸ é—œéµä¿®æ­£ï¼šuseAppData å¿…é ˆç‚º falseï¼Œæª”æ¡ˆæ‰å…·å‚™å¯è®€æ€§
            // å‘¼å« cloudManager v8.5 çš„ uploadFile
            const gFile = await cloudManager.uploadFile(fileName, jsonStr, false);
            
            if (gFile && gFile.id) {
                finalUrl = `${baseUrl}?fileId=${gFile.id}`;
                console.log(`âœ… é›²ç«¯è¨—ç®¡æˆåŠŸï¼ŒID: ${gFile.id}`);
            } else {
                throw new Error("Cloud Storage Failed");
            }
        }

        // 6. ç¸®ç¶²å€è™•ç† (é˜²æ­¢ç¶²å€éé•·è¢«é€šè¨Šè»Ÿé«”æˆªæ–·)
        if (finalUrl && window.location.hostname !== 'localhost') {
            try {
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(finalUrl)}`);
                if (response.ok) finalUrl = await response.text();
            } catch (e) { console.warn("TinyURL è·³é"); }
        }

        // 7. ç‰©ç†è¤‡è£½åˆ°å‰ªè²¼ç°¿
        await navigator.clipboard.writeText(finalUrl);
        showMessage("âœ… åˆ†äº«é€£çµå·²è¤‡è£½ï¼å¯ç›´æ¥å‚³é€çµ¦è¦ªå‹ã€‚", "success");

    } catch (err) {
        console.error("ç”Ÿæˆåˆ†äº«å¤±æ•—:", err);
        showMessage("âŒ æ•¸æ“šå°è£æˆ–é›²ç«¯å‚³è¼¸å¤±æ•—", "error");
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = `ğŸ“¤ ç”Ÿæˆåˆ†äº«é€£çµ`;
        }
    }
}

/** ğŸ§ª æ ¹æ“šä½¿ç”¨è€…å‹¾é¸éæ¿¾è¡Œç¨‹å…§å®¹ */
function getFilteredTripData(originalTrip) {
    // 1. æ·±åº¦è¤‡è£½ä¸€ä»½ï¼Œé¿å…æ”¹åˆ°æ­£åœ¨ç·¨è¼¯çš„åŸå§‹è³‡æ–™
    const tripCopy = JSON.parse(JSON.stringify(originalTrip));

    // 2. å–å¾— UI ä¸Šçš„å‹¾é¸ç‹€æ…‹ (å‡è¨­ä½ çš„ checkbox ID å¦‚ä¸‹)
    const includeNotes = document.getElementById('share-include-notes')?.checked ?? true;
    const includeExpenses = document.getElementById('share-include-expenses')?.checked ?? true;
    const includeTransport = document.getElementById('share-include-transport')?.checked ?? true;

    // 3. åŸ·è¡Œéæ¿¾é‚è¼¯
    if (!includeExpenses) {
        delete tripCopy.expenses;
        delete tripCopy.budgetLimit;
    }

    if (!includeNotes || !includeTransport) {
        tripCopy.days.forEach(day => {
            day.stops.forEach(stop => {
                if (!includeNotes) delete stop.memo;     // ç§»é™¤ç­†è¨˜
                if (!includeTransport) delete stop.transport; // ç§»é™¤äº¤é€šæ–¹å¼
            });
        });
    }

    // 4. ç§»é™¤ç³»çµ±ç§æœ‰çš„æš«å­˜æ¬„ä½ (ä¾‹å¦‚æœ¬åœ° ID æˆ–åŒæ­¥æ¨™ç±¤)
    delete tripCopy.localChangeTimestamp;
    
    return tripCopy;
}


/** ğŸ§ª ç²¾ç°¡åŒ–è¡Œç¨‹ç‰©ä»¶ (éæ¿¾å¼•æ“ï¼šåˆ†äº«èˆ‡ä¸‹è¼‰å…±ç”¨) */
function prepareLeanTrip(originalTrip) {
    // 1. æ·±åº¦è¤‡è£½ï¼Œé¿å…æ”¹åˆ°åŸå§‹è³‡æ–™
    const lean = JSON.parse(JSON.stringify(originalTrip));

    // 2. å–å¾— UI ä¸Šçš„å‹¾é¸ç‹€æ…‹ (è‹¥ ID ä¸åŒè«‹å°æ‡‰ä¿®æ”¹)
    const options = {
        includeNotes: document.getElementById('share-notes')?.checked ?? true,
        includeExpenses: document.getElementById('share-expenses')?.checked ?? true,
        includeTransport: document.getElementById('share-transport')?.checked ?? true
    };

    // 3. æ ¹æ“šå‹¾é¸è¨­å®šç§»é™¤æ¬„ä½
    if (!options.includeExpenses) {
        delete lean.expenses;
        delete lean.budgetLimit;
        delete lean.expenseCategories; // è‹¥æœ‰é ç®—åˆ†é¡ä¹Ÿä¸€ä½µåˆªé™¤
    }

    if (lean.days) {
        lean.days.forEach(day => {
            if (day.stops) {
                day.stops.forEach(stop => {
                    if (!options.includeNotes) delete stop.memo;
                    if (!options.includeTransport) delete stop.transport;
                });
            }
        });
    }

    // 4. æ³¨å…¥æµ®æ°´å°èˆ‡ç§»é™¤ç³»çµ±æš«å­˜
    lean.meta = {
        sharedAt: new Date().toISOString(),
        author: "Jimmy's Travel App",
        version: "1.0-shared"
    };
    delete lean.lastSync;
    delete lean.localChangeTimestamp;

    return lean;
}


/** ğŸ› ï¸ æª¢æŸ¥ç¶²å€åƒæ•¸ä¸¦è§£å£“ç¸®åŒ¯å…¥ (v3.2 å¼·åŒ–ç›¸å®¹ç‰ˆ) */
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    let importData = urlParams.get('import');

    if (importData) {
        try {
            // 1. é‚„åŸç¶²å€å®‰å…¨ Base64 å­—å…ƒ
            importData = importData.replace(/-/g, '+').replace(/_/g, '/');
            const padding = importData.length % 4;
            if (padding) importData += '='.repeat(4 - padding);

            // 2. Base64 è§£ç¢¼è½‰å›äºŒé€²ä½
            const binaryStr = atob(importData);
            const charData = Uint8Array.from(binaryStr, c => c.charCodeAt(0));

            // 3. ä½¿ç”¨ Pako è§£å£“ç¸® (Gzip -> JSON)
            const decompressed = pako.ungzip(charData, { to: 'string' });
            const newTrip = JSON.parse(decompressed);

            // ğŸ” ã€é™¤éŒ¯é›·é”ã€‘åœ¨æ§åˆ¶å°å°å‡ºæ”¶åˆ°çš„åŒ…è£¹å…§å®¹ï¼Œæ–¹ä¾¿æˆ‘å€‘æª¢æŸ¥æ¬„ä½
            console.log("ğŸ“¦ é–€è¡›æ”¶åˆ°çš„åŒ…è£¹å…§å®¹ï¼š", newTrip);

            // ğŸŒŸ ä¿®æ­£ï¼šå¯¬é¬†æª¢æŸ¥æ¨™é¡Œæ¬„ä½ (æ”¯æ´ tripName, name, æˆ– title)
            const finalTripName = newTrip.tripName || newTrip.name || newTrip.title || "æœªå‘½åè¡Œç¨‹";
            
            // å¦‚æœé€£å¤©æ•¸è³‡æ–™éƒ½æ²’æœ‰ï¼Œé‚£æ‰æ˜¯çœŸçš„ç„¡æ•ˆ
            if (!newTrip.days && !newTrip.stops) {
                throw new Error("åŒ…è£¹å…§å®¹ä¸å®Œæ•´ï¼Œç¼ºå°‘è¡Œç¨‹å¤©æ•¸æˆ–æ™¯é»è³‡æ–™");
            }

            // 4. å½ˆå‡ºåŒ¯å…¥ç¢ºèª
            if (confirm(`æ”¶åˆ°åˆ†äº«è¡Œç¨‹ï¼šã€${finalTripName}ã€‘\nå…± ${newTrip.days?.length || 0} å¤©ï¼Œæ˜¯å¦åŒ¯å…¥æ‚¨çš„åˆ—è¡¨ï¼Ÿ`)) {
                
                // ç¢ºä¿åŒ¯å…¥å¾Œçš„åç¨±æ­£ç¢º
                newTrip.tripName = finalTripName;
                
                // ğŸŒŸ ä¿®æ­£ï¼šçµ¦äºˆå”¯ä¸€ ID
                newTrip.id = 'trip_' + Date.now();
                
                // æ ¹æ“šç³»çµ±çµæ§‹å­˜å…¥å…¨åŸŸ state
                if (typeof state !== 'undefined' && Array.isArray(state.trips)) {
                    state.trips.push(newTrip);
                } else if (typeof allTrips !== 'undefined') {
                    // å¦‚æœä½ çš„è®Šæ•¸å« allTrips ä¹Ÿè¦ç›¸å®¹
                    allTrips.push(newTrip);
                }
                
                // ğŸŒŸ ä¿®æ­£ï¼šå„²å­˜é‚è¼¯
                if (typeof saveAllData === 'function') {
                    saveAllData(); 
                } else if (typeof dbManager !== 'undefined' && dbManager.db) {
                    dbManager.save('private_store', { id: 'app_state', data: state });
                }
                
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                if (typeof renderTripList === 'function') renderTripList();
                
                if (typeof showMessage === 'function') {
                    showMessage("âœ… æˆåŠŸåŒ¯å…¥åˆ†äº«è¡Œç¨‹ï¼", "success");
                }
            }

            // 5. æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œä¿æŒä¹¾æ·¨
            window.history.replaceState({}, document.title, window.location.pathname);

        } catch (e) {
            console.error("âŒ è§£æåˆ†äº«ç¶²å€å¤±æ•—:", e);
            if (typeof showMessage === 'function') {
                showMessage("âŒ åŒ¯å…¥å¤±æ•—ï¼š" + e.message, "error");
            }
        }
    }
}

/**
 * æ™ºæ…§åŒ¯å…¥è§£æå¼•æ“ (Regex æ ¸å¿ƒ)
 * å°‡æ–‡å­—è½‰æ›ç‚º Staging ç‰©ä»¶
 */
function parseSmartInput(rawText) {
    const lines = rawText.split(/[\n,;ï¼Œï¼›]+/).map(l => l.trim()).filter(l => l);
    const results = [];

    lines.forEach(line => {
        // 1. åµæ¸¬ç¶²å€
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const urls = line.match(urlRegex) || [];
        const cleanLine = line.replace(urlRegex, '').trim();

        // 2. åµæ¸¬æ¨™ç±¤ [ ]
        const tagRegex = /\[(.*?)\]/g;
        const tags = [];
        let match;
        while ((match = tagRegex.exec(cleanLine)) !== null) {
            tags.push(match[1]);
        }
        const name = cleanLine.replace(tagRegex, '').trim() || "æœªå‘½ååœ°é»";

        results.push({
            id: 'staging-' + generateUUID(),
            name: name,
            location: tags.join(' | '),
            notes: urls.join('\n'),
            isDuplicate: false, // ç¨å¾Œç”¨æ–¼æ¯”å°ç§æœ‰åº«
            status: 'want'
        });
    });

    return results;
}

/** è¼”åŠ©ï¼šçµ±ä¸€æŠ“å–ç•¶å‰æ’ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç¢ºä¿æ•¸æ“šåˆ†æµæ­£ç¢º */
function getContext(scheduleId) {
    const trip = getCurrentTrip();
    const day = getCurrentDay();
    if (!trip || !day) return { trip: null, day: null, schedule: null };

    const workshopKey = `${trip.id}_day${day.dayNum}`;
    let schedule;

    if (state.planViewMode === 'workshop') {
        schedule = (state.shadowItineraries[workshopKey] || []).find(s => s.id === scheduleId);
    } else {
        schedule = (day.schedules || []).find(s => s.id === scheduleId);
    }
    
    return { trip, day, schedule, workshopKey };
}

/**
 * 2026 æ——è‰¦é€šè¨Šæ¨¡çµ„ï¼šé–å®š Gemini 2.5/3 ç©©å®šè·¯å¾‘ (v1.9.0)
 * å¾¹åº•è§£æ±º 404 (Model not found) èˆ‡ 400 (Param conflict)
 */
async function callGeminiWithRetry(prompt, maxRetries = 3) {
    const apiKey = state.theme.geminiKey;
    if (!apiKey) throw new Error("å°šæœªè¨­å®š Gemini API Key");

    // âœ¨ 2026 æœ€æ–°æ¨¡å‹æ¸…å–®ï¼šå„ªå…ˆä½¿ç”¨ 2.5/3 ç³»åˆ—
    const models = [
        "gemini-3-flash-preview", // 2026 æœ€å¼·é è¦½ç‰ˆï¼Œæ”¯æ´è¤‡é›œè¦åŠƒ
        "gemini-2.5-flash",       // ç›®å‰æœ€ç©©å®šçš„æ­£å¼ç”Ÿç”¢ç‰ˆ
        "gemini-1.5-flash-002"    // ç¶“å…¸æ¬¾æœ€å¾Œä¿éšª
    ];
    
    let currentModelIndex = 0;
    const useJsonMode = prompt.toLowerCase().includes('json');

    let attempts = 0;
    while (attempts < maxRetries) {
        attempts++;
        const modelName = models[currentModelIndex];
        
        // âœ¨ é—œéµä¿®æ­£ï¼š2.5/3 ç³»åˆ—å»ºè­°ä½¿ç”¨ v1beta è·¯å¾‘ä»¥é–‹å•Ÿã€Œæ€è€ƒæ¨¡å¼ (Thinking)ã€èˆ‡ã€ŒJSON æ¨¡å¼ã€
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                // 2.5/3 ç³»åˆ—çš„åŸç”Ÿ JSON æ”¯æŒ
                ...(useJsonMode ? { responseMimeType: "application/json" } : {}),
                temperature: 0.7,
                maxOutputTokens: 4096
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                // è™•ç† 404ï¼šæ¨¡å‹ ID æ‰¾ä¸åˆ°æ™‚ï¼Œè‡ªå‹•è·³è½‰ä¸‹ä¸€å€‹ 2026 ID
                if (response.status === 404 && currentModelIndex < models.length - 1) {
                    console.warn(`âš ï¸ æ¨¡å‹ [${modelName}] åœ¨æ­¤åœ°å€ä¸å¯ç”¨ï¼Œåˆ‡æ›è‡³ [${models[currentModelIndex+1]}]`);
                    currentModelIndex++;
                    attempts--; // åˆ‡æ›æ¨¡å‹ä¸è¨ˆå…¥å¤±æ•—æ¬¡æ•¸
                    continue;
                }
                throw new Error(result.error?.message || "API è«‹æ±‚å¤±æ•—");
            }

            // çµ±è¨ˆ API ä½¿ç”¨é‡ (Gemini 2.5/3 æ”¯æ´ç´°ç¯€çµ±è¨ˆ)
            if (result.usageMetadata) trackApiUsage(result.usageMetadata, 'flash');

            let text = result.candidates[0].content.parts[0].text;
            
            // âœ¨ è‡ªç™’éæ¿¾ï¼šè‹¥ API æ²’å•Ÿç”¨ JSON æ¨¡å¼å»å™´äº† Markdown
            if (useJsonMode && text.includes('```')) {
                text = text.replace(/```json|```/g, '').trim();
            }

            return text;

        } catch (error) {
            console.error(`âŒ ç¬¬ ${attempts} æ¬¡å˜—è©¦å¤±æ•—:`, error.message);
            if (attempts >= maxRetries) throw error;
            await new Promise(r => setTimeout(r, 1500)); // å¢åŠ ç­‰å¾…æ™‚é–“é¿é–‹æµé‡é™åˆ¶
        }
    }
}

/**
 * æ ¸å¿ƒèª¿åº¦å“¡ï¼šæ¯ç•¶è¡Œç¨‹è®Šå‹•ï¼ˆæ‹–æ‹½ã€åˆªé™¤ã€ä¿®æ”¹æ™‚é–“ï¼‰æ™‚ï¼Œå‘¼å«æ­¤å‡½æ•¸
 */
function refreshUI() {
    // 1. å–å¾—ç•¶å‰æ—¥æœŸçš„æ‰€æœ‰è¡Œç¨‹
    const schedules = state.plans[state.currentDate] || [];

    // 2. æ›´æ–°é ‚éƒ¨çš„ã€Œè¦–è¦ºæ™‚é–“è»¸ã€
    const timelineCont = document.getElementById('visual-timeline-container');
    if (timelineCont) {
        timelineCont.innerHTML = renderVisualTimeline({ schedules, day: { date: state.currentDate } });
    }

    // 3. æ›´æ–°å´é‚Šæ¬„çš„ã€Œä»Šæ—¥è­¦å ±ç¸½è¦½ã€ (æˆ‘å€‘çš„æ–°é­”ç‹åŠŸèƒ½)
    const alertBox = document.getElementById('sidebar-alerts-container');
    if (alertBox) {
        alertBox.innerHTML = renderDailyAlertSidebar(schedules, state.currentDate);
    }

    // 4. æ›´æ–°ä¸»è¦çš„ã€Œè¡Œç¨‹å¡ç‰‡åˆ—è¡¨ã€
    // é€™è£¡è«‹æ›æˆä½ åŸæœ¬è² è²¬æ¸²æŸ“å¡ç‰‡çš„å‡½æ•¸åç¨±ï¼Œä¾‹å¦‚ renderCards(schedules);
    if (typeof renderCards === 'function') {
        renderCards(schedules);
    }
    
    console.log("ğŸ”„ UI ç¸½è¦½èˆ‡è­¦å ±å·²åŒæ­¥æ›´æ–°");
}

/**
 * äº¤é€šåœé ç«™æ”¶æŠ˜åˆ‡æ›å‡½æ•¸ (ä¿®æ­£ç‰ˆï¼šç›´æ¥æ§åˆ¶ Hidden ç‹€æ…‹)
 */
window.toggleTransportDetails = function(btn, id) {
    const expandDiv = document.getElementById(`transport-expand-${id}`);
    const arrow = btn.querySelector('.icon-arrow');
    const label = btn.querySelector('.toggle-label');
    
    if (!expandDiv) return;

    const isHidden = expandDiv.classList.contains('hidden');

    if (isHidden) {
        expandDiv.classList.remove('hidden');
        if (arrow) arrow.style.transform = 'rotate(90deg)';
        if (label) label.textContent = 'éš±è—åœé ç«™';
        btn.classList.add('bg-blue-100');
    } else {
        expandDiv.classList.add('hidden');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
        if (label) label.textContent = 'æŸ¥çœ‹æ²¿é€”åœé ';
        btn.classList.remove('bg-blue-100');
    }
};



/** ğŸš€ ä¹å·æ——è‰¦ç‰ˆï¼šå¤§ä¸€çµ±æ•´åˆå°èˆªå¼•æ“ v28.0 (å‹•æ…‹æ™‚ç©ºè‡ªç™’ç‰ˆ)
 * ä¿®æ­£ï¼šå¾¹åº•ç§»é™¤ Hard-coded "ç¦å²¡"ï¼Œå¯¦ç¾å…¨çƒåœ°å€è‡ªå‹•é©é…ã€‚
 */
(function() {
    console.log("ğŸ¬ æ——è‰¦ç‰ˆé–‹æ©Ÿï¼šåŸ·è¡Œå…¨è‡ªå‹•ç’°å¢ƒé©é…...");

    // 1. ã€æ ¸å¿ƒã€‘åœ°ç†æŒ‡ç´‹å‹•æ…‹å°ç„¦ (ä¸è«–å»å“ªï¼Œéƒ½ä»¥è¡Œç¨‹ç‚ºæº–)
    window.autoFocusTripMap = function() {
        const trip = state.trips && state.trips[0];
        const day = typeof getCurrentDay === 'function' ? getCurrentDay() : trip?.days[state.currentDayIndex || 0];
        
        if (!day || !window.map) return;

        // ğŸŒŸ å„ªå…ˆæŠ“å–ç•¶æ—¥æ‰€æœ‰æ™¯é»çš„å¯¦é«”åº§æ¨™
        const coords = (day.schedules || [])
            .filter(s => s.coords?.lat && s.coords?.lng)
            .map(s => [parseFloat(s.coords.lng), parseFloat(s.coords.lat)]);

        if (coords.length > 0) {
            // è¨ˆç®—æ™¯é»ç¾¤èšä¸­å¿ƒ
            const center = [
                coords.reduce((a, b) => a + b[0], 0) / coords.length,
                coords.reduce((a, b) => a + b[1], 0) / coords.length
            ];
            
            // ğŸš€ å‹•æ…‹æ›´æ–°è¡Œç¨‹åœ°é»ï¼Œä¸å†å¯«æ­»ç¦å²¡
            if (trip) {
                trip.location = day.city || trip.location || "è‡ªå‹•å®šä½";
            }
            
            window.map.jumpTo({ center, zoom: 12 });
            console.log(`âœ… åœ°é»è‡ªç™’å®Œæˆï¼šå·²å°ç„¦è‡³ä»Šæ—¥æ™¯é»ä¸­å¿ƒ [${trip.location}]`);
        } else {
            // ğŸš€ è‹¥ç„¡åº§æ¨™ï¼Œå˜—è©¦å¾ GEO_REGIONS æŠ“å–åŸå¸‚ä¸­å¿ƒ
            const currentCity = Array.isArray(day.city) ? day.city[0] : day.city;
            if (window.GEO_REGIONS && window.GEO_REGIONS[currentCity]) {
                const cityPos = window.GEO_REGIONS[currentCity];
                window.map.jumpTo({ center: [cityPos.lng, cityPos.lat], zoom: 11 });
            }
        }
    };

    // 2. ã€æ ¸å¿ƒã€‘æ•¸æ“šç£å€è‡ªç™’ (è§£æ±ºè·¨è¨­å‚™è·¯ç¶²éºå¤±)
    const performDeepHeal = async () => {
        console.log("ğŸ“¡ åŸ·è¡Œæ•¸æ“šæ·±å±¤å·¡æª¢...");
        if (!dbManager.db) await dbManager.init();
        
        const vault = await dbManager.getAll('transport_store');
        
        // è·¨è¨­å‚™åŒæ­¥é‚è¼¯ï¼šç¢ºä¿å°å…¥çš„ JSON è·¯ç¶²èƒ½ç‰©ç†å¯«å…¥ IndexedDB
        if ((!vault || vault.length === 0) && state.transportVault?.length > 0) {
            const tx = dbManager.db.transaction(['transport_store'], 'readwrite');
            state.transportVault.forEach(r => tx.objectStore('transport_store').put(r));
            tx.oncomplete = () => {
                console.log("âœ… å¯¦é«”è·¯ç¶²è³‡ç”¢å·²æˆåŠŸç§»æ°‘è‡³æ­¤è¨­å‚™ã€‚");
                if (typeof renderTransportHub === 'function') renderTransportHub();
            };
        } else if (vault?.length > 0) {
            state.transportVault = vault;
        }

        // å•Ÿå‹•å³å°ç„¦
        window.autoFocusTripMap();
    };

    // 3. ã€æ””æˆªã€‘å¤©æ•¸åˆ‡æ›é€£å‹•
    const originalChangeDay = window.changeDay;
    window.changeDay = function(index) {
        if (typeof originalChangeDay === 'function') originalChangeDay(index);
        // åˆ‡æ›å¤©æ•¸å¾Œï¼Œåœ°åœ–è‡ªå‹•è¿½éš¨è©²æ—¥æ™¯é»
        setTimeout(window.autoFocusTripMap, 400);
    };

    // 4. ã€å•Ÿå‹•ã€‘ç‰©ç†é˜²ç¦¦å·¡é‚
    window.addEventListener('load', () => {
        // çµ¦äºˆç€è¦½å™¨è¶³å¤ æ™‚é–“è®€å– IndexedDB
        setTimeout(performDeepHeal, 1500); 
    });

    console.log("ğŸ v28.0 å‹•æ…‹å°ä½å¼•æ“å°±ç·’ï¼šç³»çµ±ç¾åœ¨å¯é©é…å…¨çƒä»»ä½•æ—…éŠå€åŸŸã€‚");
})();

/** ğŸ“¡ ç‰©ç†éŒ¯èª¤ç›£æ§ï¼šå°‡éš±è—éŒ¯èª¤å°æµè‡³çµ‚ç«¯æ©Ÿ */
(function hookSystemErrors() {
    const originalConsoleError = console.error;

    // 1. æ””æˆªä¸€èˆ¬ JS éŒ¯èª¤ (å¦‚ TypeError)
    window.onerror = function(msg, url, line, col, error) {
        const consoleLog = document.getElementById('virtual-console-log');
        if (consoleLog) {
            const time = new Date().toLocaleTimeString();
            const logHTML = `<p class="text-rose-500 font-black tracking-tighter">> [CRITICAL_ERROR ${time}] ${msg} (Line: ${line})</p>`;
            consoleLog.insertAdjacentHTML('beforeend', logHTML);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }
        return false; // è®“ç€è¦½å™¨åŸæœ¬çš„ log ä¾ç„¶é‹ä½œ
    };

    // 2. æ””æˆªç•°æ­¥ Promise éŒ¯èª¤ (Gemini API å¤±æ•—çš„ä¸»å› )
    window.addEventListener('unhandledrejection', event => {
        const consoleLog = document.getElementById('virtual-console-log');
        if (consoleLog) {
            const reason = event.reason?.message || event.reason;
            consoleLog.insertAdjacentHTML('beforeend', `<p class="text-amber-500 font-bold">> [ASYNC_REJECT] ${reason}</p>`);
        }
    });

    console.log("ğŸ“Ÿ ç³»çµ±é™¤éŒ¯é–€æˆ¶å·²é–‹æ”¾ï¼šæŒ‡ä»¤æ§åˆ¶å°å…·å‚™ JS åŸ·è¡ŒåŠ›ã€‚");
})();

    </script>
</body>
</html>