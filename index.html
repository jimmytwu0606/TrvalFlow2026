<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelFlow - 御風隨型 (智慧行程)</title>
    
    <!-- React & ReactDOM --><script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX --><script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tesseract.js for OCR --><script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- html2canvas for Screenshot Export --><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts --><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        /* 針對 iOS/Android 的 Scrollbar 隱藏 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* Ruby (Furigana) Styling - Ensures rt is small */
        ruby {
            ruby-position: over;
        }
        rt {
            font-size: 0.6em;
            color: inherit;
            opacity: 0.8;
        }
        
        /* Custom Flight Ticket Notches */
        .ticket-notch-left, .ticket-notch-right {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
        }
        .ticket-notch-left { left: -10px; }
        .ticket-notch-right { right: -10px; }
        .theme-selector-item {
            width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 0 0 2px transparent;
            transition: box-shadow 0.15s ease-in-out;
        }
        .theme-selector-item.active {
            box-shadow: 0 0 0 3px currentColor;
        }

        /* Fix for voice recording pulse on mobile */
        .recording-pulse {
            animation: pulse-red 1s infinite;
        }
        
        /* Style for selectively bolded text inside notes (font weight is inherited/default for the surrounding text, only <b> changes it) */
        .notes-content strong, .notes-content b {
            font-weight: 700; /* Ensure <b> tags are distinctly bold */
        }

        /* New table styles for shopping list */
        .shopping-table th {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 2px solid;
        }
        .shopping-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid;
        }

        /* DND Styles for items */
        .item-drag-over-visual {
            border: 2px dashed #9ca3af !important;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- API Configuration Placeholder ---
        // 系統會自動注入密鑰，但使用者可透過 UI 覆寫此值
        const apiKey = ""; 
        
        // 使用不同的 KEY 確保與舊的 session/local storage 衝突
        const STORAGE_KEY = 'travelflow_local_v5_0';

        // --- Theme Palettes ---
        const PALETTES = {
            // Original Green (Nature/Mori)
            green: { 
                name: '綠野 (原)', 
                main: '#83A846', 
                dark: '#6EB566', 
                light_bg: '#F4F8EB', 
                light_text: '#3A4520', 
                dark_accent: '#A4CA68',
                ai_bg: 'bg-[#F0FFF4]', // Light BG for AI
                dark_ai_bg: 'bg-[#142814]'
            },
            // Ocean/Aqua (Blue/Teal)
            aqua: { 
                name: '海洋 (藍)', 
                main: '#06B6D4', 
                dark: '#0891B2', 
                light_bg: '#F0FFFF', 
                light_text: '#0F766E', 
                dark_accent: '#2DD4BF',
                ai_bg: 'bg-[#F0FFFF]',
                dark_ai_bg: 'bg-[#064E3B]' 
            },
            // Terracotta/Red (Warm/Sunset)
            terracotta: { 
                name: '暖土 (紅)', 
                main: '#D97706', 
                dark: '#B45309', 
                light_bg: '#FFF7ED', 
                light_text: '#9A3412', 
                dark_accent: '#FBBF24',
                ai_bg: 'bg-[#FEFCE8]', 
                dark_ai_bg: 'bg-[#431401]'
            },
            // Lavender/Purple (Soft Mauve - Adjusted)
            lavender: { 
                name: '薰衣 (柔和)', 
                main: '#A78BFA', // Light purple
                dark: '#8B5CF6', // Slightly darker for gradient
                light_bg: '#F5F3FF', // Very light purple background
                light_text: '#5B21B6', // Darker text for contrast
                dark_accent: '#C7D2FE', // Light blue-purple for dark mode accent
                ai_bg: 'bg-[#F5F3FF]',
                dark_ai_bg: 'bg-[#1b1923]' // Darker, less distracting dark mode background
            },
            // Rose Pink (Adjusted for softer look)
            rose: {
                name: '玫瑰 (柔粉)',
                main: '#F472B6', // Rose 400
                dark: '#EC4899', // Rose 500
                light_bg: '#FFF7F9', // Very light pink background
                light_text: '#9D174D', // Ruby for contrast
                dark_accent: '#FDBFDC', // Lighter pink for dark mode accent
                ai_bg: 'bg-[#FFF0F5]', // Even lighter pink for AI background
                dark_ai_bg: 'bg-[#291720]' // Darker, muted pink for dark mode AI
            }, 
            // Moon Grey (New)
            grey: {
                name: '月灰 (柔和)',
                main: '#6B7280', // Gray 500
                dark: '#4B5563', // Gray 600
                light_bg: '#F9FAFB', // Very light gray
                light_text: '#374151', // Dark gray for text
                dark_accent: '#9CA3AF', // Gray 400 for dark mode accent
                ai_bg: 'bg-[#F3F4F6]', // Light gray for AI background
                dark_ai_bg: 'bg-[#1F2937]' // Darker gray for dark mode AI
            }
        };
        // --- Icons ---
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const IconDollar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
        const IconTranslate = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 8l6 6"></path><path d="M4 14l6-6 2-3"></path><path d="M2 5h12"></path><path d="M7 2h1"></path><path d="M22 22l-5-10-5 10"></path><path d="M14 18h6"></path></svg>;
        const IconMapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconLoading = () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>;
        const IconYen = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 5l6 7 6-7" /><path d="M12 12v8" /><path d="M6 15h12" /><path d="M6 18h12" /></svg>;
        const IconShield = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;
        const IconMicrophone = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>;
        const IconCamera = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>;
        const IconPencilSmall = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 9.5-9.5z"></path></svg>;
        const IconLink = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>;
        const IconExclamation = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconSparkles = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>;
        const IconMoon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const IconPalette = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.5 16.5c-4-4 2-10 6-6 4-4-2-10-6-6-4 4-10-2-6-6z" /><circle cx="12" cy="12" r="10" /><path d="M12 2a10 10 0 0 0 0 20z" /></svg>;
        const IconCloud = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>;
        const IconRain = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinecap="round"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>;
        const IconSnow = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="3" x2="12" y2="21"></line><line x1="8" y1="8" x2="16" y2="16"></line><line x1="16" y1="8" x2="8" y2="16"></line><line x1="4" y1="12" x2="20" y2="12"></line></svg>;
        const IconBook = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>;
        const IconUmbrella = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinecap="round"><path d="M23 12a11.05 11.05 0 0 0-22 0zm-5 7a3 3 0 0 1-6 0v-7" /></svg>;
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconPlaneDeparture = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 22h20"/><path d="M8 5.67Q10 3 12 5.67l3 1.33L22 6l-2.5 4.5L22 13l-1.5 1.5-5.8-1.45L11 17l-3-1-3 3-1.5-1.5L5 16l2.5-4L3 8l2.5-1.5 2.5 1.5-2.33-2.33"/></svg>;
        const IconExport = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
        const IconImage = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconCode = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"></polyline></svg>;
        const IconEyeOff = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>;
        const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const IconKey = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.5a2.5 2.5 0 0 0 0 5h1.5a2.5 2.5 0 0 0 0-5zM12 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM10 10l-4 4"/></svg>;
        const IconStar = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const IconVolume = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5L6 9H2v6h4l5 4z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
        // NEW: Shopping Cart Icon
        const IconShoppingCart = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>;
        // NEW: Plus Square Icon
        const IconSquarePlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>;
        // NEW: Image Icon for Google Image Search
        const IconSearchImage = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>;
        // NEW: Time Icon (Clock)
        const IconTime = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        // NEW: Arrow Left Icon
        const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>;
        // NEW: Arrow Right Icon
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>;


        // MODIFIED: User/Person Icon for settings (Replaces IconSettings)
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;


        // 預設資料
        const INITIAL_DATA = {
            title: '福岡七日遊行程', // FIX 1: 預設值為核心名稱
            days: [
                { id: 1, name: 'D1', date: '1/23', themeCity: '福岡', reservedTime: '', cityStory: '福岡是九州最大的城市，古稱博多。這裡是日本與亞洲大陸交流的門戶。' },
                { id: 2, name: 'D2', date: '1/24', themeCity: '太宰府', reservedTime: '', cityStory: '' },
                { id: 3, name: 'D3', date: '1/25', themeCity: '由布院', reservedTime: '', cityStory: '' },
                { id: 4, name: 'D4', date: '1/26', themeCity: '別府', reservedTime: '', cityStory: '' },
                { id: 5, name: 'D5', date: '1/27', themeCity: '熊本', reservedTime: '', cityStory: '' },
                { id: 6, name: 'D6', date: '1/28', themeCity: '鹿兒島', reservedTime: '', cityStory: '' },
                { id: 7, name: 'D7', date: '1/29', themeCity: '福岡', reservedTime: '', cityStory: '' },
            ],
            items: [
                { id: 1700000000000, dayId: 1, time: '10:00', duration: '2小時', title: '抵達福岡機場', location: '福岡機場 (FUK)', mapUrl: 'http://googleusercontent.com/maps.google.com/9', cost: 0, notes: 'CI110 航班', weather: 'sunny', temperature: 12, type: 'flight', story: '', isAi: false, isAiPlus: false, tabelog_score: 0, rainy_backup: '' },
                { id: 1700000000001, dayId: 1, time: '12:30', duration: '1小時', title: '飯店 Check-in', location: '博多車站周邊飯店', mapUrl: 'https://www.google.com/maps/search/?api=1&query=博多車站0', cost: 0, notes: '寄放行李', weather: 'cloudy', temperature: 13, type: 'activity', story: '', isAi: false, isAiPlus: false, tabelog_score: 0, rainy_backup: '' },
                { id: 1700000000002, dayId: 1, time: '18:00', duration: '1.5小時', title: '晚餐：一蘭拉麵', location: '一蘭 本社總本店', mapUrl: 'https://www.google.com/maps/search/?api=1&query=博多車站1', cost: 1500, notes: '福岡必吃豚骨拉麵', weather: 'cloudy', temperature: 10, tabelog_score: 3.56, type: 'food', story: '', isAi: false, isAiPlus: false, rainy_backup: '' },
            ],
            budget: 50000,
            safety: {
                office_name: '台北駐大阪經濟文化辦事處福岡分處',
                office_phone: '+81-92-734-2810 / 急難救助: +81-90-1922-9740',
                office_address: '福岡市中央區櫻坂3-12-42 (Sakurazaka 3-12-42, Chuo-ku, Fukuoka-shi)',
                medical_support: [
                    { name: '九州大學醫院 (國際醫療部)', phone: '+81-92-642-5163', address: '福岡市東區馬出3-1-1', desc: '提供部分中文醫療口譯 (需預約)' },
                    { name: '福岡記念病院', phone: '+81-92-821-4731', address: '福岡市早良區西新1-1-35', desc: '設有國際醫療支援中心' },
                    { name: '千鳥橋病院', phone: '+81-92-641-2761', address: '福岡市博多區千代5-18-1', desc: '提供多語言醫療諮詢' },
                    { name: '櫻十字福岡醫院', phone: '+81-92-791-1100', address: '福岡市中央區渡辺通3-5-11', desc: '位於市中心，對外國遊客友善' },
                    { name: '福岡市急患診療中心', phone: '+81-92-847-1099', address: '福岡市早良區百道濱1-6-9', desc: '夜間/假日急診 (建議搭配翻譯軟體)' }
                ],
                emergency_numbers: '報案 110 / 火警救護 119'
            },
            // NEW: Shopping List Data Structure
            shopping_list: [
                { id: 1, name: '福岡草莓大福', price: 350, location: '博多運河城一樓', mapUrl: 'https://www.google.com/maps/search/?api=1&query=博多運河城', purchased: false, isAi: true },
                { id: 2, name: '柚子胡椒醬', price: 800, location: '超市/伴手禮店', mapUrl: 'https://www.google.com/maps/search/?api=1&query=超市', purchased: false, isAi: true },
            ]
        };

        // --- Helper: Generate Google Maps URL ---
        const generateMapUrl = (query) => {
            if (!query) return '';
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        };

        // --- Helper: Generate Google Image URL ---
        const generateImageUrl = (query) => {
            if (!query) return '#';
            return `https://www.google.com/search?q=${encodeURIComponent(query)}&tbm=isch`;
        };
        
        // --- Helper: TTS Voice Setup (Robust) ---
        let JPN_VOICE = null;
        let TTS_VOICES_LOADED = false;

        const loadTtsVoices = () => {
            TTS_VOICES_LOADED = true;
            const voices = window.speechSynthesis.getVoices();
            // Try to find a standard Japanese voice
            JPN_VOICE = voices.find(voice => voice.lang === 'ja-JP' || voice.lang.startsWith('ja-'));
            // Remove listener once loaded to prevent multiple calls
            window.speechSynthesis.onvoiceschanged = null;
        };

        if ('speechSynthesis' in window) {
            // Check immediately, in case voices are already loaded
            if (window.speechSynthesis.getVoices().length > 0) {
                loadTtsVoices();
            } else {
                // If not loaded, attach event listener
                window.speechSynthesis.onvoiceschanged = loadTtsVoices;
            }
        }

        const speakJapanese = (text) => {
            if (!('speechSynthesis' in window)) {
                alert("您的瀏覽器不支援語音合成功能 (TTS)。");
                return;
            }
            
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';

            if (!TTS_VOICES_LOADED) {
                // Attempt a quick manual load check if we missed the event
                loadTtsVoices();
            }

            if (JPN_VOICE) {
                utterance.voice = JPN_VOICE;
            } else {
                // Fail silently if voice not found, but TTS API is available.
                // It often defaults to a decent voice anyway.
            }
            
            window.speechSynthesis.speak(utterance);
        };
        // --- End TTS Helper ---


        // --- App Component ---
        const App = () => {
            // [NEW STATE] for API Key Overriding
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('user_gemini_api_key') || '');
            const [tempApiKey, setTempApiKey] = useState(userApiKey); // Initialize tempKey for settings modal

            // [NEW STATE] for Settings Modal
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [isKeyVisible, setIsKeyVisible] = useState(false); // NEW state for key visibility

            // [NEW STATE] for Title Edit
            const [isTitleModalOpen, setIsTitleModalOpen] = useState(false);
            const [tempTitle, setTempTitle] = useState('');
            
            // NEW: Shopping List States
            const [isShoppingModalOpen, setIsShoppingModalOpen] = useState(false); // For Add to Itinerary Modal
            const [shoppingItemToAdd, setShoppingItemToAdd] = useState(null); // The item being added
            const [shoppingDayTarget, setShoppingDayTarget] = useState(1); // Default to D1
            const [newShoppingItem, setNewShoppingItem] = useState({ name: '', price: '', location: '' });
            const [isShoppingAiLoading, setIsShoppingAiLoading] = useState(false);
            // FIX: Ensure initialization is safe
            const [aiShoppingCity, setAiShoppingCity] = useState(INITIAL_DATA.days[0]?.themeCity || '福岡'); 
            
            // NEW: AI Suggestion State
            const [aiSuggestedItem, setAiSuggestedItem] = useState(null); // Holds the suggested activity before acceptance

            // NEW: Pagination State
            const MAX_DAYS_DISPLAY = 7;
            const [currentDayRangeStart, setCurrentDayRangeStart] = useState(0);
            
            // NEW: Item DND State (For inside day items)
            const [itemDragId, setItemDragId] = useState(null); 
            const [itemDragOverId, setItemDragOverId] = useState(null);
            const dragItemRef = useRef(null);
            const dragOverItemRef = useRef(null);
            // NEW: Item Copy/Move State
            const [isCopyMoveModalOpen, setIsCopyMoveModalOpen] = useState(false);
            const [itemToCopy, setItemToCopy] = useState(null);
            const [targetDayId, setTargetDayId] = useState(1); 
            
            // FIX: Re-declared isListening (was missing in the code block)
            const [isListening, setIsListening] = useState(false);


            // --- Helper: Check API Key and Alert ---
            const checkApiKeyAndAlert = () => {
                const keyToUse = userApiKey || apiKey;
                if (!keyToUse) {
                    alert("⚠️ 尚未設定 Gemini API Key。請點擊右上角齒輪圖標，輸入您的密鑰以啟用 AI 功能。"); 
                    return false;
                }
                return true;
            };

            // [MODIFIED callGemini function now inside App to use userApiKey state]
            const callGemini = async (prompt, isJson = false) => {
                const keyToUse = userApiKey || apiKey;
                
                if (!keyToUse) {
                    throw new Error("API Key required for Gemini call."); 
                }

                try {
                    const body = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    if (isJson) {
                        body.generationConfig = {
                            responseMimeType: "application/json"
                        };
                    }

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${keyToUse}`, 
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        }
                    );
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `API request failed: ${response.status}`);
                    }
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (error.message.includes('403') || error.message.includes('API_KEY_INVALID') || error.message.includes('not valid')) {
                        alert("AI 連線失敗: 權限不足或密鑰無效。請確認您的 Gemini API 密鑰設定。");
                    } else if (error.message.includes('API Key required')) {
                        // Suppress key error here, as it should be handled by caller alert
                    } else {
                        alert("AI 連線錯誤: " + error.message);
                    }
                    throw error;
                }
            }

            // --- Helper: Clean JSON String ---
            function cleanJsonString(str) {
                let cleaned = str.trim();
                cleaned = cleaned.replace(/```json\s*/g, "").replace(/\s*```/g, "").trim();
                
                const start = cleaned.indexOf('[');
                const end = cleaned.lastIndexOf(']');
                const startObj = cleaned.indexOf('{');
                const endObj = cleaned.lastIndexOf('}');

                if (start !== -1 && (startObj === -1 || start < startObj)) {
                    if (end !== -1) return cleaned.substring(start, end + 1);
                } 
                else if (startObj !== -1) {
                    if (endObj !== -1) return cleaned.substring(startObj, endObj + 1);
                }
                return cleaned; 
            }

            const [colorKey, setColorKey] = useState(() => {
                return localStorage.getItem('travel_color_theme') || 'green';
            });
            const [appData, setAppData] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                try {
                    return saved ? { ...INITIAL_DATA, ...JSON.parse(saved) } : INITIAL_DATA;
                } catch (e) {
                    console.error("Error loading localStorage data:", e);
                    return INITIAL_DATA;
                }
            });

            const [activeTab, setActiveTab] = useState('itinerary');  
            const [selectedDayId, setSelectedDayId] = useState(1);
            const [theme, setTheme] = useState(() => {
                return localStorage.getItem('travel_theme') || 'light';
            }); 
            const [isLoaded] = useState(false);
            
            const [isLoading] = useState(false); 

            // Tools New State
            const [phraseKeyword, setPhraseKeyword] = useState('');
            const [generatedPhrases, setGeneratedPhrases] = useState([]);
            const [isGeneratingPhrases, setIsGeneratingPhrases] = useState(false);

            // AI Planner (新增起始地/結束地 state)
            const [isAiPlannerOpen, setIsAiPlannerOpen] = useState(false);
            const [aiPlannerCity, setAiPlannerCity] = useState(''); // 中央城市/主題
            const [aiPlannerStartLocation, setAiPlannerStartLocation] = useState(''); // 起始地
            const [aiPlannerEndLocation, setAiPlannerEndLocation] = useState(''); // 結束地/返回地
            const [aiPlannerStyle, setAiPlannerStyle] = useState('');
            const [aiPlannerStartTime, setAiPlannerStartTime] = useState('10:00');
            const [aiPlannerEndTime, setAiPlannerEndTime] = useState('20:00');
            const [aiPlannerMinCost, setAiPlannerMinCost] = useState(''); 
            const [aiPlannerMaxCost, setAiPlannerMaxCost] = useState(''); 
            const [isAiPlanning, setIsAiPlanning] = useState(false);

            // Export Modal
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [exportContent, setExportContent] = useState('');
            const [exportImage, setExportImage] = useState(null);
            const [isPrivacyMode, setIsPrivacyMode] = useState(false);

            // Budget Modal
            const [isBudgetModalOpen, setIsBudgetModalOpen] = useState(false);
            const [tempBudget, setTempBudget] = useState(0);

            // Modals
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [isDaySettingsOpen, setIsDaySettingsOpen] = useState(false);
            const [daySettingsData, setDaySettingsData] = useState({ themeCity: '', reservedTime: '', cityStory: '' });
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: '', onConfirm: null });
            
            // Loading States
            const [generatingStoryId, setGeneratingStoryId] = useState(null);
            const [isAiGeneratingStory, setIsAiGeneratingStory] = useState(false);
            const [isAiLoadingSafety, setIsAiLoadingSafety] = useState(false);
            const [isAiTranslating, setIsAiTranslating] = useState(false);
            const [isOcrProcessing, setIsOocrProcessing] = useState(false);
            
            // NEW: AI Plus processing state
            const [isAiPlusProcessingId, setIsAiPlusProcessingId] = useState(null); 

            // Tools Data
            const [translateText, setTranslateText] = useState('');
            const [translatedResult, setTranslatedResult] = useState('');
            const [safetyRegion, setSafetyRegion] = useState('日本福岡');
            
            // References
            const fileInputRef = useRef(null);

            // Form
            const [formData, setFormData] = useState({
                time: '', duration: '', title: '', location: '', mapUrl: '', cost: '', notes: '', 
                weather: 'sunny', temperature: '', tabelog_score: '', rainy_backup: '', story: '', type: 'activity'
            });

            // --- Derived State Definitions ---
            const isDark = theme === 'dark';  
            const currentPalette = PALETTES[colorKey];  
            
            // Helper function to get current day name (used for shopping list context)
            const getCurrentDayName = (id) => appData.days?.find(d => d.id === id)?.themeCity || appData.days?.[0]?.themeCity || '福岡';


            const currentDay = useMemo(() => {
                return appData.days?.find(d => d.id === selectedDayId) || appData.days?.[0] || INITIAL_DATA.days[0];
            }, [appData.days, selectedDayId]);

            const currentDayItems = useMemo(() => {
                // FIX: Remove .sort() here so DND works by manipulating the array order directly
                // The main list holds items in their display order for the currently selected day.
                return appData.items.filter(item => item.dayId === selectedDayId);
            }, [appData.items, selectedDayId]);

            const totalShoppingCost = useMemo(() => appData.shopping_list.reduce((sum, item) => sum + (Number(item.price) || 0), 0), [appData.shopping_list]);
            
            // [NEW DERIVED STATE] Calculate day's temperature range and main weather from items
            const dayTempRange = useMemo(() => {
                const temps = currentDayItems
                    .map(item => Number(item.temperature))
                    .filter(temp => !isNaN(temp) && temp !== 0);

                if (temps.length === 0) return { min: null, max: null, weather: null };
                
                const min = Math.min(...temps);
                const max = Math.max(...temps);
                
                // Simple heuristic for main weather: use the most frequent weather type
                const weatherCounts = currentDayItems.reduce((acc, item) => {
                    acc[item.weather] = (acc[item.weather] || 0) + 1;
                    return acc;
                }, {});
                const mainWeather = Object.keys(weatherCounts).reduce((a, b) => (weatherCounts[a] > weatherCounts[b] ? a : b), 'sunny');

                return { min, max, weather: mainWeather };
            }, [currentDayItems]);

            const totalSpent = useMemo(() => appData.items.reduce((sum, item) => sum + (Number(item.cost) || 0), 0), [appData.items]);
            const remainingBudget = appData.budget - totalSpent; 

            const dailyCosts = useMemo(() => {
                return appData.days.map(day => {
                    const dayTotal = appData.items
                        .filter(item => item.dayId === day.id)
                        .reduce((sum, item) => sum + (Number(item.cost) || 0), 0);
                    return { ...day, total: dayTotal };
                });
            }, [appData.days, appData.items]);

            const budgetBreakdown = useMemo(() => {
                const breakdown = {
                    hotel: { label: '住宿', amount: 0, color: 'text-blue-500', bg: 'bg-blue-500' },
                    food: { label: '餐飲', amount: 0, color: 'text-orange-500', bg: 'bg-orange-500' },
                    transport: { label: '交通/機票', amount: 0, color: 'text-purple-500', bg: 'bg-purple-500' },
                    activity: { label: '活動/購物', amount: 0, color: 'text-green-500', bg: 'bg-green-500' }
                };

                appData.items.forEach(item => {
                    const cost = Number(item.cost) || 0;
                    if (item.type === 'hotel') breakdown.hotel.amount += cost;
                    else if (item.type === 'food') breakdown.food.amount += cost;
                    else if (item.type === 'flight') breakdown.transport.amount += cost; 
                    else breakdown.activity.amount += cost;
                });
                return breakdown;
            }, [appData.items]);

            const hasAiItems = useMemo(() => currentDayItems.some(i => i.isAi), [currentDayItems]);
            // ---------------------------------
            
            // Persistence (Local Storage Only)
            useEffect(() => {
                // Use localStorage for theme and color key
                localStorage.setItem('travel_theme', theme);
                localStorage.setItem('travel_color_theme', colorKey);
                // Use localStorage for main data
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                // setIsLoaded(true); // NOTE: Removed redundant setIsLoaded(true) here
            }, [appData, theme, colorKey]);

            // --- Theme Selectors ---
            const dynamicColors = useMemo(() => {
                const main = currentPalette.main;
                const dark = currentPalette.dark;
                const dark_accent = currentPalette.dark_accent;
                const light_bg = currentPalette.light_bg;

                if (isDark) {
                    return {
                        bgMain: 'bg-[#111827]', 
                        bgSub: currentPalette.dark_ai_bg,
                        textMain: 'text-[#F3F4F6]', 
                        textSub: 'text-[#9CA3AF]',
                        accentText: `text-[${dark_accent}]`,
                        cardBg: 'bg-[#1F2937] border-gray-700 shadow-sm',
                        modalBg: 'bg-[#1F2937] text-white',
                        inputBg: 'bg-[#374151] border-gray-600 text-white focus:border-[#A4CA68]',
                        headerBg: `bg-[#1F2937]/90 backdrop-blur-md border-b border-gray-700`,
                        // FIX: Corrected missing backtick
                        accentBg: `bg-[${dark_accent}] hover:bg-[${main}] text-[#111827]`, 
                        flightCard: `from-[${dark}] to-[${main}] border-[${dark}]`, // Flight gradient
                        aiBorder: `border-[${dark_accent}]`, // AI card border
                        timelineDot: `bg-[${dark_accent}] border-[#1F2937]`,
                        flightText: 'text-white',
                        // NEW: Suggested Card Styles (dark blue/cyan accent)
                        suggestCardBg: 'bg-[#0f172a] border-l-4 border-cyan-400 shadow-lg',
                        suggestCardText: 'text-cyan-400',
                    };
                } else {
                    return {
                        bgMain: `bg-[${light_bg}]`, 
                        bgSub: currentPalette.ai_bg,
                        textMain: `text-[${currentPalette.light_text}]`, 
                        textSub: 'text-[#5C6E38]',
                        accentText: `text-[${main}]`,
                        cardBg: `bg-white border-[#DEEBAF] shadow-sm`,
                        modalBg: 'bg-white text-gray-800',
                        inputBg: `bg-[#FDFDF9] border-[#9CA825]/50 text-[#3A4520] focus:border-[${main}]`,
                        headerBg: `bg-gradient-to-r from-[${dark}]/90 to-[${main}]/90 backdrop-blur-md text-white shadow-md`,
                        accentBg: `bg-[${main}] hover:bg-[${dark}] text-white`,
                        flightCard: `from-[${dark}] to-[${main}] border-[${dark}]`, // Flight gradient
                        aiBorder: `border-[${main}]`, // AI card border
                        timelineDot: `bg-[${main}] border-[#F4F8EB]`,
                        flightText: 'text-white',
                        // NEW: Suggested Card Styles (light blue/cyan accent)
                        suggestCardBg: 'bg-cyan-50 border-l-4 border-cyan-500 shadow-md',
                        suggestCardText: 'text-cyan-700',
                    };
                }
            }, [colorKey, isDark]);

            // Extract dynamic styles
            const { bgMain, bgSub, textMain, textSub, accentText, accentBg, headerBg, cardBg, modalBg, inputBg, flightCard, aiBorder, timelineDot, flightText, suggestCardBg, suggestCardText } = dynamicColors;

            // Actions
            const updateAppData = (key, value) => setAppData(prev => ({ ...prev, [key]: value }));
            const handleToggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');
            const handleSetColorKey = (key) => setColorKey(key);
            
            // [MODIFIED] Handle Save API Key
            const handleSaveApiKey = () => {
                if (tempApiKey.trim()) {
                    setUserApiKey(tempApiKey.trim());
                    localStorage.setItem('user_gemini_api_key', tempApiKey.trim());
                    alert("已儲存 API Key！新的密鑰將用於 AI 呼叫。");
                } else {
                    setUserApiKey('');
                    localStorage.removeItem('user_gemini_api_key');
                    alert("已清除 API Key！將使用預設的系統密鑰。");
                }
                setIsSettingsModalOpen(false); // Close settings modal
            };


            // FIX 1: Implement custom modal opening logic
            const handleEditTitle = () => {
                setTempTitle(appData.title);
                setIsTitleModalOpen(true);
            };

            const handleSaveTitle = () => {
                if (tempTitle && tempTitle.trim() !== "") {
                    updateAppData('title', tempTitle.trim());
                }
                setIsTitleModalOpen(false);
            };
            
            const addNewDay = () => {
                const newId = appData.days.length + 1;
                const lastDay = appData.days[appData.days.length - 1];
                let nextDate = '';
                if(lastDay && lastDay.date) {
                    const parts = lastDay.date.split('/');
                    if(parts.length === 2) {
                        let month = parseInt(parts[0]);
                        let day = parseInt(parts[1]) + 1;
                        if (day > 31) { day = 1; month++; }
                        nextDate = `${month}/${day}`;
                    }
                }
                const newDay = { id: newId, name: `D${newId}`, date: nextDate, themeCity: '', reservedTime: '', cityStory: '' };
                
                const newDaysArray = [...appData.days, newDay];
                updateAppData('days', newDaysArray);
                setSelectedDayId(newId);

                // NEW LOGIC FOR PAGINATION
                if (newDaysArray.length > MAX_DAYS_DISPLAY) {
                    // Shift view to the right to see the new day
                    setCurrentDayRangeStart(newDaysArray.length - MAX_DAYS_DISPLAY);
                }
            };

            // DND and Renumbering Logic
            const [dayDragId, setDayDragId] = useState(null);

            const handleDragStart = (e, id) => {
                setDayDragId(id);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnter = (id) => {
                if (dayDragId === id || dayDragId === null) return;
                
                // --- Safe DND Reordering and Renumbering ---
                let tempReindexedDays = [...appData.days];
                const currentDraggedIndex = tempReindexedDays.findIndex(d => d.id === dayDragId);
                const currentTargetIndex = tempReindexedDays.findIndex(d => d.id === id);

                if (currentDraggedIndex === -1 || currentTargetIndex === -1) return;

                // 1. Reorder the array
                const [draggedDay] = tempReindexedDays.splice(currentDraggedIndex, 1);
                tempReindexedDays.splice(currentTargetIndex, 0, draggedDay);

                // 2. Map Old Day IDs to New sequential IDs
                const oldIdToNewIdMap = {};
                let newSelectedDayId = selectedDayId;
                
                const finalDaysWithNewIds = tempReindexedDays.map((day, index) => {
                    const newId = index + 1;
                    const newName = `D${newId}`;
                    
                    // The day.id at this point is the OLD ID
                    oldIdToNewIdMap[day.id] = newId;

                    // If this was the day currently selected, update the selected ID
                    if (day.id === selectedDayId) {
                        newSelectedDayId = newId;
                    }
                    
                    return { ...day, id: newId, name: newName };
                });

                // 3. Remap items and update day state
                const finalItems = appData.items.map(item => ({
                    ...item,
                    dayId: oldIdToNewIdMap[item.dayId] || item.dayId // Safely update dayId for items
                }));

                setAppData(prev => ({ 
                    ...prev, 
                    days: finalDaysWithNewIds,
                    items: finalItems
                }));
                
                setSelectedDayId(newSelectedDayId); 
                setDayDragId(newSelectedDayId); 

                // 4. Adjust visibility for visual stability (scrolling)
                if (currentTargetIndex >= currentDayRangeStart + MAX_DAYS_DISPLAY - 1) {
                    setCurrentDayRangeStart(currentTargetIndex - MAX_DAYS_DISPLAY + 2); // Shift by 2 for visual stability
                } else if (currentTargetIndex < currentDayRangeStart) {
                    setCurrentDayRangeStart(currentTargetIndex);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDayDragId(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleDragEnd = () => {
                setDayDragId(null);
            };
            
            // Pagination Handlers
            const canScrollBack = currentDayRangeStart > 0;
            const canScrollForward = currentDayRangeStart + MAX_DAYS_DISPLAY < appData.days.length;

            const handleScroll = (direction) => {
                if (direction === 'forward' && canScrollForward) {
                    setCurrentDayRangeStart(prev => Math.min(prev + 1, appData.days.length - MAX_DAYS_DISPLAY));
                } else if (direction === 'back' && canScrollBack) {
                    setCurrentDayRangeStart(prev => Math.max(0, prev - 1));
                }
            };
            
            // NEW: Delete Day Functionality
            const handleDeleteDay = (dayIdToDelete) => {
                if (appData.days.length <= 1) {
                    alert("無法刪除最後一天行程。");
                    return;
                }
                setConfirmModal({
                    isOpen: true,
                    message: `確定要刪除 ${appData.days.find(d => d.id === dayIdToDelete)?.name} 及其所有行程嗎？`,
                    onConfirm: () => {
                        let tempDays = appData.days.filter(d => d.id !== dayIdToDelete);
                        let newSelectedDayId = selectedDayId;
                        let newCurrentDayRangeStart = currentDayRangeStart;
                        
                        // 1. Re-index remaining days and create ID map
                        const oldIdToNewIdMap = {};
                        const reindexedDays = tempDays.map((day, index) => {
                            const newId = index + 1;
                            const newName = `D${newId}`;
                            
                            oldIdToNewIdMap[day.id] = newId;
                            
                            return { ...day, id: newId, name: newName };
                        });

                        // 2. Adjust selectedDayId
                        if (dayIdToDelete === selectedDayId) {
                            const indexAfterDeletion = Math.min(dayIdToDelete - 1, reindexedDays.length - 1);
                            newSelectedDayId = reindexedDays[indexAfterDeletion]?.id || (reindexedDays.length > 0 ? reindexedDays[0].id : 1);
                        } else {
                            newSelectedDayId = oldIdToNewIdMap[selectedDayId] || selectedDayId;
                        }
                        
                        // 3. Adjust pagination start
                        if (newCurrentDayRangeStart >= reindexedDays.length || newCurrentDayRangeStart > 0) {
                            newCurrentDayRangeStart = Math.max(0, Math.min(newCurrentDayRangeStart, reindexedDays.length - MAX_DAYS_DISPLAY));
                        }

                        // 4. Remap items
                        const finalItems = appData.items
                            .filter(item => item.dayId !== dayIdToDelete) 
                            .map(item => ({
                                ...item,
                                dayId: oldIdToNewIdMap[item.dayId] || item.dayId 
                            }));

                        setAppData(prev => ({ 
                            ...prev, 
                            days: reindexedDays,
                            items: finalItems
                        }));

                        setSelectedDayId(newSelectedDayId);
                        setCurrentDayRangeStart(newCurrentDayRangeStart);
                        setConfirmModal({ isOpen: false, message: '', onConfirm: null });
                    }
                });
            };


            // --- DND Logic for Items within a Day ---
            const handleItemDragStart = (e, item) => {
                e.dataTransfer.setData("itemId", item.id.toString());
                e.dataTransfer.setData("dayId", item.dayId.toString());
                setItemDragId(item.id);
            };

            const handleItemDragOver = (e, targetItem) => {
                e.preventDefault(); 
                if (itemDragId === null) return;

                const dragItem = appData.items.find(i => i.id === itemDragId);
                if (!dragItem || dragItem.dayId !== targetItem.dayId) return; 

                // Visual cue
                if (itemDragOverId !== targetItem.id) {
                    setItemDragOverId(targetItem.id);
                }
            };
            
            const handleItemDrop = (e, targetItem) => {
                e.preventDefault();
                const droppedItemId = Number(e.dataTransfer.getData("itemId"));
                const droppedItemDayId = Number(e.dataTransfer.getData("dayId"));
                
                if (droppedItemId === targetItem.id || droppedItemDayId !== targetItem.dayId) {
                    setItemDragId(null);
                    setItemDragOverId(null); 
                    return;
                }

                // 1. Get ALL items (needed for non-selected day items)
                const allItems = [...appData.items];
                
                // 2. Get the items for the current day
                const currentDayList = allItems.filter(i => i.dayId === selectedDayId);
                
                // 3. Separate item being moved
                const itemToMove = currentDayList.find(i => i.id === droppedItemId);
                
                if (!itemToMove) return;

                // 4. Create the new list order for the current day
                let listWithoutMoved = currentDayList.filter(i => i.id !== droppedItemId);
                let targetIndex = listWithoutMoved.findIndex(i => i.id === targetItem.id);
                
                // Perform the insertion
                listWithoutMoved.splice(targetIndex, 0, itemToMove);

                // 5. Reconstruct the full items array, maintaining original order of other days
                const itemsOfOtherDays = allItems.filter(i => i.dayId !== selectedDayId);
                
                setAppData(prev => ({
                    ...prev,
                    items: [...itemsOfOtherDays, ...listWithoutMoved]
                }));
                
                setItemDragId(null);
                setItemDragOverId(null);
                alert("行程順序已調整！請記得點擊項目修改時間，確保排程的合理性。");
            };

            const handleItemDragLeave = () => {
                setItemDragOverId(null);
            };
            
            // FIX: Defined the missing function
            const handleItemDragEnd = () => {
                setItemDragId(null);
                setItemDragOverId(null);
            };
            // --- End DND Logic for Items ---


            const handleModalDelete = () => {
                if (!editingItem) return;
                setConfirmModal({
                    isOpen: true,
                    message: `確定要刪除行程 "${editingItem.title}" 嗎？`,
                    onConfirm: () => {
                        updateAppData('items', appData.items.filter(i => i.id !== editingItem.id));
                        setIsModalOpen(false); // <--- 關鍵: 成功刪除後關閉編輯視窗
                        setConfirmModal({ isOpen: false, message: '', onConfirm: null });
                    }
                });
            };

            const handleOpenModal = (item = null) => {
                if (item) {
                    setEditingItem(item);
                    setFormData({ ...item, cost: item.cost.toString(), temperature: item.temperature?.toString(), tabelog_score: item.tabelog_score?.toString(), type: item.type || 'activity' });
                } else {
                    setEditingItem(null);
                    setFormData({ 
                        time: currentDayItems[currentDayItems.length - 1]?.time || '09:00', // Default to time of last item, or 09:00
                        duration: '1小時', 
                        title: '', location: '', mapUrl: '', cost: '', notes: '', 
                        weather: 'sunny', temperature: '', tabelog_score: '', rainy_backup: '', story: '', type: 'activity'
                    });
                }
                setIsModalOpen(true);
            };

            const handleOpenCopyMoveModal = (item) => {
                setItemToCopy(item);
                setTargetDayId(item.dayId); // Default target to item's current day
                setIsModalOpen(false); // Close edit modal
                setIsCopyMoveModalOpen(true);
            };

            const handleSaveItem = () => {
                if (!formData.title) return alert('請輸入活動名稱');

                let finalMapUrl = formData.mapUrl;
                if (!finalMapUrl && formData.location) {
                    finalMapUrl = generateMapUrl(formData.location);
                } else if (!finalMapUrl && formData.title) {
                    finalMapUrl = generateMapUrl(formData.title);
                }

                let finalNotes = formData.notes;

                // Check if time has been changed to remove the move/copy warning note
                if (editingItem) {
                    const originalItem = appData.items.find(i => i.id === editingItem.id);
                    // Only check if original item existed and had the warning note
                    if (originalItem && originalItem.notes && originalItem.notes.includes('請確認並修改時間。')) {
                         if (originalItem.time !== formData.time) {
                            // Time changed, remove the "請確認並修改時間" warning
                            finalNotes = finalNotes.replace(/\[從 D\d+ (移動|複製)\] 請確認並修改時間。 ?/g, '').trim();
                        } else {
                            // Time not changed, keep the note
                            finalNotes = originalItem.notes;
                        }
                    }
                }

                const newItem = { 
                    ...formData, 
                    notes: finalNotes,
                    cost: Number(formData.cost || 0), 
                    temperature: Number(formData.temperature || 0),
                    dayId: selectedDayId,
                    mapUrl: finalMapUrl,
                    tabelog_score: Number(formData.tabelog_score || 0), // Ensure score is number
                    isAi: editingItem ? editingItem.isAi : false, // Preserve AI status on edit
                    isAiPlus: editingItem ? editingItem.isAiPlus : false, // Preserve AI+ status on edit
                    isAiSuggestion: editingItem ? editingItem.isAiSuggestion : false, // Preserve suggestion status
                    id: editingItem ? editingItem.id : Date.now() // Use existing ID or new ID
                };
                
                // Remove mapUrl if empty
                if (!newItem.mapUrl || newItem.mapUrl.trim() === '') delete newItem.mapUrl;

                if (editingItem) {
                    updateAppData('items', appData.items.map(i => i.id === editingItem.id ? newItem : i));
                } else {
                    // NEW: Insert new item to the end of the day list
                    updateAppData('items', [...appData.items, newItem]);
                }
                setIsModalOpen(false);
            };

            // NEW: Handle Copy/Move Item from Modal
            const handleExecuteCopyMove = (isMove) => {
                if (!itemToCopy) return;

                const newId = Date.now();
                const targetDay = Number(targetDayId);
                const sourceDayName = appData.days.find(d => d.id === itemToCopy.dayId)?.name || `D${itemToCopy.dayId}`;

                // 1. Create the new item (Note: isAiPlus/isAi/isAiSuggestion set to FALSE for copied/moved items)
                const newItem = {
                    ...itemToCopy,
                    id: newId,
                    dayId: targetDay,
                    isAi: false, 
                    isAiPlus: false, 
                    isAiSuggestion: false,
                    // Add status to notes to remind user it was moved/copied and needs time adjustment
                    notes: `[從 ${sourceDayName} ${isMove ? '移動' : '複製'}] 請確認並修改時間。 ${itemToCopy.notes}`,
                    time: '09:00' // Reset time to 9:00 for the new day
                };

                // 2. Filter out original item if it's a move operation
                let finalItems = isMove
                    ? appData.items.filter(i => i.id !== itemToCopy.id) 
                    : [...appData.items]; 

                // 3. Insert into the end of the target day's item list
                finalItems = [...finalItems, newItem]; 
                
                updateAppData('items', finalItems);
                setIsCopyMoveModalOpen(false);
                setItemToCopy(null);
                
                // Switch to target day after move/copy
                setSelectedDayId(targetDay);

                alert(`已將 "${itemToCopy.title}" ${isMove ? '移動' : '複製'}到 D${targetDay}！請至該天行程確認。`);
            };


            
            const handleClearDayItems = () => {
                setConfirmModal({
                    isOpen: true,
                    message: `確定要清空「${currentDay.name}」的所有行程嗎？`,
                    onConfirm: () => {
                        updateAppData('items', appData.items.filter(item => item.dayId !== selectedDayId));
                        setConfirmModal({ isOpen: false, message: '', onConfirm: null });
                    }
                });
            };

            const handleClearAiItems = () => {
                setConfirmModal({
                    isOpen: true, message: `確定要清除「${currentDay.name}」的所有 AI 生成行程嗎？`,
                    onConfirm: () => {
                        updateAppData('items', appData.items.filter(item => !(item.dayId === selectedDayId && (item.isAi || item.isAiPlus))));
                        setConfirmModal({ isOpen: false, message: '', onConfirm: null });
                    }
                });
            }

            const openBudgetModal = () => {
                setTempBudget(appData.budget);
                setIsBudgetModalOpen(true);
            };

            const saveBudget = () => {
                if(isNaN(tempBudget) || tempBudget < 0) return alert("請輸入有效的預算金額");
                updateAppData('budget', parseInt(tempBudget));
                setIsBudgetModalOpen(false);
            };

            // Shopping List Handlers
            const handleOpenAddToItinerary = (item) => {
                setShoppingItemToAdd(item);
                setShoppingDayTarget(selectedDayId); // Default to current selected day
                setIsShoppingModalOpen(true);
            };
            
            const handleSaveShoppingToItinerary = () => {
                if (!shoppingItemToAdd) return;

                const newItem = {
                    id: Date.now(),
                    dayId: Number(shoppingDayTarget),
                    time: '18:00', // Default time, user can edit later
                    duration: '1小時',
                    title: `購物：${shoppingItemToAdd.name}`,
                    location: shoppingItemToAdd.location,
                    mapUrl: shoppingItemToAdd.mapUrl,
                    cost: Number(shoppingItemToAdd.price) || 0,
                    notes: `購買清單項目: <b>${shoppingItemToAdd.name}</b>`,
                    weather: 'sunny',
                    temperature: '',
                    type: 'activity',
                    tabelog_score: 0,
                    isAi: false,
                    isAiPlus: true, // Mark as AI+ enhanced since it links to shopping list details
                    rainy_backup: ''
                };

                updateAppData('items', [...appData.items, newItem]);
                setIsShoppingModalOpen(false);
                setShoppingItemToAdd(null);
                alert(`已將 ${shoppingItemToAdd.name} 新增到 D${shoppingDayTarget} 行程!`);
            };

            const handleAddShoppingItem = () => {
                if (!newShoppingItem.name.trim()) return alert("請輸入商品名稱");
                
                const newItem = {
                    id: Date.now(),
                    name: newShoppingItem.name.trim(),
                    price: Number(newShoppingItem.price) || 0,
                    location: newShoppingItem.location.trim(),
                    mapUrl: newShoppingItem.location.trim() ? generateMapUrl(newShoppingItem.location.trim()) : '',
                    purchased: false,
                    isAi: false
                };
                updateAppData('shopping_list', [...appData.shopping_list, newItem]);
                setNewShoppingItem({ name: '', price: '', location: '' });
            };

            const handleTogglePurchased = (id) => {
                updateAppData('shopping_list', appData.shopping_list.map(item => 
                    item.id === id ? { ...item, purchased: !item.purchased } : item
                ));
            };

            const handleDeleteShoppingItem = (id) => {
                updateAppData('shopping_list', appData.shopping_list.filter(item => item.id !== id));
            };

            const handleAiGenerateShoppingList = async () => {
                if (!checkApiKeyAndAlert()) return;

                const city = aiShoppingCity || '日本';
                setIsShoppingAiLoading(true);

                try {
                    // NEW PROMPT: Request specific brand/product and confirm status
                    const prompt = `You are a travel shopping expert. Recommend 8-10 popular, non-perishable local souvenirs or specialty items for tourists in "${city}", Traditional Chinese language.
                    
                    Instructions:
                    1. Each 'name' MUST be a specific product name, ideally including the brand (e.g., "茅乃舍 博多限定高湯包", "一蘭 速食拉麵").
                    2. Provide a realistic 'price' (JPY, integer market average), and a specific 'location' (e.g., specific store name or general area like "博多車站內").
                    3. The recommended shops MUST be real and currently operating (no permanent closures).
                    
                    Return STRICTLY a valid JSON array (no markdown, no surrounding text): [
                        { "name": "商品名稱", "price": 0, "location": "推薦購買店名" }
                    ]`;

                    const resultText = await callGemini(prompt, true);
                    const cleanedJson = cleanJsonString(resultText);
                    const parsedItems = JSON.parse(cleanedJson);

                    const newItems = parsedItems.map((item, index) => ({
                        id: Date.now() + index,
                        name: item.name || '未知商品',
                        price: Number(item.price) || 0,
                        location: item.location || '各大超市',
                        mapUrl: generateMapUrl(item.location + " " + item.name),
                        purchased: false,
                        isAi: true
                    }));

                    updateAppData('shopping_list', [...appData.shopping_list, ...newItems]);
                } catch (e) {
                    console.error("AI Shopping List Error:", e);
                    alert("AI 購物清單生成失敗: " + (e.message || "請檢查 API Key 或重試。"));
                } finally {
                    setIsShoppingAiLoading(false);
                }
            };
            // End Shopping List Handlers


            // AI Suggestion Handlers
            const handleAiSuggestActivity = async (timeOfDay) => {
                if (!checkApiKeyAndAlert()) return;
                
                const city = currentDay.themeCity || appData.days?.[0]?.themeCity || '福岡';
                const date = currentDay.date || '今日';
                
                // Clear previous suggestion first if a new generation starts
                setAiSuggestedItem(null);
                
                setIsAiPlanning(true); // Reuse planning loading state for simplicity
                
                let timeConstraint = '';
                let defaultTime = '14:00';
                
                // MODIFIED TIME SLOTS
                switch(timeOfDay) {
                    case 'morning':
                        timeConstraint = '早上 (5:00 - 12:00)，建議在 10:00 左右，適合戶外活動或參觀景點。';
                        defaultTime = '10:00';
                        break;
                    case 'afternoon':
                        timeConstraint = '下午 (12:00 - 17:00)，建議在 14:00 左右，適合購物、咖啡廳或博物館。';
                        defaultTime = '14:00';
                        break;
                    case 'evening':
                        timeConstraint = '晚上 (17:00 - 23:00)，建議在 19:00 左右，適合晚餐、夜景或娛樂。';
                        defaultTime = '19:00';
                        break;
                    case 'late_night':
                        timeConstraint = '深夜 (23:00 - 隔日 5:00)，建議在 01:00 左右，專門用於如博多祇園山笠等清晨/夜間特殊活動。';
                        defaultTime = '01:00';
                        break;
                    default:
                        timeConstraint = '不限時間，建議是今日的特色活動。';
                        defaultTime = '14:00';
                }

                try {
                    const prompt = `You are a spontaneous travel guide. Suggest ONE highly engaging activity or dining experience for a tourist in "${city}" on date "${date}". Focus on: ${timeConstraint} Also prioritize any local events, festivals (like Gion Matsuri, Tenjin Festival), markets (like Tenjin Market), or major cultural events occurring in this city during this month.
                    
                    Instructions:
                    1. **Response:** Must be a single JSON object (no markdown).
                    2. **Notes:** Provide detailed tips, viewing focus, or preparation steps in the 'notes' field. For key phrases, wrap them in <b> tags. If suggesting an event/festival, include event time/details in the notes. Use Traditional Chinese.
                    3. **Type/Details:** Provide sensible defaults for 'time' (MUST be near ${defaultTime} if activity type allows), 'duration', 'cost', 'weather', 'temperature', and 'type' ('activity' or 'food'). Include realistic 'tabelog_score' if 'food' (3.50-4.00).
                    4. **Rainy Backup:** Provide a suitable indoor 'rainy_backup' if the suggestion is exposed/outdoor, otherwise set to "".
                    5. **Status:** Must confirm the location is currently operating (no permanent closures).
                    
                    STRICTLY return ONLY the JSON object: { "time": "HH:MM", "duration": "e.g. 1.5小時", "title": "Activity Name", "location": "Address/Place Name", "cost": 0, "notes": "Tips/details (use <b> tags)", "weather": "sunny", "temperature": 20, "type": "activity", "tabelog_score": 0.00, "rainy_backup": "" }`;

                    const resultText = await callGemini(prompt, true);
                    const cleanedJson = cleanJsonString(resultText);
                    const suggestedData = JSON.parse(cleanedJson);

                    const newItem = {
                        ...suggestedData,
                        id: Date.now(),
                        dayId: selectedDayId,
                        mapUrl: generateMapUrl(suggestedData.title + " " + suggestedData.location),
                        cost: Number(suggestedData.cost || 0),
                        temperature: Number(suggestedData.temperature || 0),
                        tabelog_score: Number(suggestedData.tabelog_score || 0),
                        isAi: false, 
                        isAiPlus: false,
                        isAiSuggestion: true, // Mark this temporary item
                    };
                    
                    setAiSuggestedItem(newItem);
                } catch (error) {
                    console.error("AI Suggestion Failed:", error);
                    alert("AI 建議生成失敗: " + (error.message || "請檢查 API Key 或重試。"));
                } finally {
                    setIsAiPlanning(false);
                }
            };
            
            const handleAcceptSuggestion = () => {
                if (!aiSuggestedItem) return;

                // Convert the suggested item into a permanent, accepted item
                const acceptedItem = {
                    ...aiSuggestedItem,
                    isAi: false, // Not fully generated plan
                    isAiPlus: true, // Mark it as AI+ reinforced / manually accepted
                    isAiSuggestion: false, // Remove temporary flag
                    id: Date.now() // Give it a new final ID
                };
                
                updateAppData('items', [...appData.items, acceptedItem]);
                setAiSuggestedItem(null); // Clear suggestion after acceptance
                alert(`已接受建議並將 "${acceptedItem.title}" 加入行程!`);
            };


            // Export
            const handleExport = () => {
                let text = `${appData.title}\n\n`;
                appData.days.forEach(day => {
                    text += `【${day.name} - ${day.date} ${day.themeCity}】\n`;
                    const dayItems = appData.items
                        .filter(i => i.dayId === day.id)
                        .filter(i => !(isPrivacyMode && (i.type === 'flight' || i.type === 'hotel')))
                        .sort((a, b) => a.time.localeCompare(b.time));
                    if(dayItems.length === 0) text += "  (無行程)\n";
                    dayItems.forEach(item => {
                        text += `● ${item.time} ${item.title}`;
                        if(item.location) text += ` @ ${item.location}`;
                        if(item.cost > 0) text += ` (¥${item.cost})`;
                        // Clean HTML tags from notes for plain text export
                        const notesClean = item.notes ? item.notes.replace(/<[^>]*>/g, '').trim() : '';
                        if(notesClean) text += ` - ${notesClean}`;
                        if(item.type === 'food' && item.tabelog_score > 0) text += ` [Tabelog: ${item.tabelog_score}]`;
                        text += `\n`;
                    });
                    text += `\n`;
                });
                text += `\n--- 總預算狀況 ---\n`;
                text += `總預算: ¥${appData.budget.toLocaleString()}\n`;
                text += `已支出: ¥${totalSpent.toLocaleString()}\n`;
                text += `剩餘: ¥${remainingBudget.toLocaleString()}\n`;
                setExportContent(text);

                // Start screenshot process
                setTimeout(async () => {
                    const element = document.getElementById('itinerary-content-export');
                    if (!element) return;
                    // Force minimum background color for the screenshot based on theme
                    const bgForScreenshot = isDark ? '#111827' : currentPalette.light_bg;
                    try {
                        const canvas = await html2canvas(element, {
                            useCORS: true, 
                            scale: 2, 
                            backgroundColor: bgForScreenshot,
                            height: element.scrollHeight,
                            windowHeight: element.scrollHeight,
                            onclone: (doc) => {
                                // Important: Temporarily hide all the floating elements which are not part of the content
                                doc.querySelector('.add-button-float').style.display = 'none';
                                doc.querySelector('.header-buttons').style.display = 'none';
                                doc.querySelector('#itinerary-content-export').style.paddingBottom = '20px'; // Add some bottom padding
                            }
                        });
                        const imgData = canvas.toDataURL('image/png');
                        setExportImage(imgData);
                        setIsExportModalOpen(true);
                    } catch (err) {
                        console.error("Screenshot failed", err);
                        alert("截圖生成失敗，請嘗試使用文字匯出。");
                        setExportImage(null); // Ensure no old image is shown
                        setIsExportModalOpen(true); 
                    }
                }, 100);
            };

            const handleExportHtml = () => {
                // Use dynamic palette colors in exported HTML
                const exportHeaderBg = `background-image: linear-gradient(to right, ${currentPalette.dark}, ${currentPalette.main});`;
                const exportTextMain = `color: ${currentPalette.light_text};`;

                const htmlContent = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>${appData.title} - 行程表</title><script src="https://cdn.tailwindcss.com"><\/script><style>body{font-family:sans-serif;}</style></head><body class="bg-gray-50 p-8"><div class="max-w-3xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden"><div style="${exportHeaderBg}" class="p-6 text-white"><h1 class="text-3xl font-bold">${appData.title}</h1></div><div class="p-6 space-y-8">${appData.days.map(day=>{const items=appData.items.filter(i=>i.dayId===day.id).sort((a,b)=>a.time.localeCompare(b.time));return`<div><h2 class="text-xl font-bold border-b pb-2 mb-4" style="${exportTextMain}">${day.date} ${day.name} - ${day.themeCity}</h2><div class="space-y-4">${items.map(item=>`<div class="flex gap-4 p-4 border rounded-lg"><div class="font-bold w-16">${item.time}</div><div><div class="font-bold">${item.title} ${item.cost > 0 ? `(¥${item.cost})` : ''}</div><div class="text-sm text-gray-500">${item.location} ${item.notes ? `| ${item.notes}` : ''}</div></div></div>`).join('')}</div></div>`;}).join('')}</div></div></body></html>`;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${appData.title}_完整行程.html`;
                link.click();
            };

            const handleDownloadImage = () => {
                if(!exportImage) return;
                const link = document.createElement('a');
                link.download = `${appData.title}_${currentDay.name}_行程.png`;
                link.href = exportImage;
                link.click();
            };

            const handleCopyContent = () => {
                navigator.clipboard.writeText(exportContent).then(() => alert("已複製文字內容！"));
            };

            const handleOpenDaySettings = () => {
                setDaySettingsData({ themeCity: currentDay.themeCity || '', reservedTime: currentDay.reservedTime || '', cityStory: currentDay.cityStory || '' });
                setIsDaySettingsOpen(true);
            };
            const handleSaveDaySettings = () => {
                const updatedDays = appData.days.map(d => d.id === selectedDayId ? { ...d, ...daySettingsData } : d);
                updateAppData('days', updatedDays);
                setIsDaySettingsOpen(false);
            };

            // AI Features
            const handleAiGenerateStory = async () => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                if (!daySettingsData.themeCity) return alert("請先輸入主題城市");
                setIsAiGeneratingStory(true);
                try {
                    const prompt = `Tell a short, engaging historical story about "${daySettingsData.themeCity}" for a tourist. Write in Traditional Chinese (繁體中文). Keep it under 100 words. STRICTLY return ONLY the story text. Do not include title, markdown formatting, or character counts (like (100字)).`;
                    let result = await callGemini(prompt);
                    // Post-processing
                    result = result.replace(/[\(\[\{（]?\d+\s*(字|words?|characters?|chars?)[\)\]\}）]?$/i, '').trim();
                    result = result.replace(/```/g, '').trim();
                    setDaySettingsData(prev => ({ ...prev, cityStory: result }));
                } catch (error) { 
                    console.error(error);
                    alert("AI 故事生成失敗"); 
                } finally { setIsAiGeneratingStory(false); }
            };

            const handleGenerateItemStory = async (item) => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                setGeneratingStoryId(item.id);
                try {
                    const prompt = `Tell a short historical fact or cultural context about "${item.location || item.title}" for a tourist in Traditional Chinese. Under 80 words. Return ONLY the plain text. Do not use Markdown or include character counts.`;
                    let story = await callGemini(prompt);
                    // Post-processing
                    story = story.replace(/[\(\[\{（]?\d+\s*(字|words?|characters?|chars?)[\)\]\}）]?$/i, '').trim();
                    story = story.replace(/```/g, '').trim();
                    updateAppData('items', appData.items.map(i => i.id === item.id ? { ...i, story } : i));
                } catch (error) { 
                    console.error(error);
                    alert("AI 故事生成失敗"); 
                } finally { setGeneratingStoryId(null); }
            };
            
            const handleAiPlusEnhancement = async (item) => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                if (item.title === '移動/交通') return alert('交通項目通常已包含詳細路線，請嘗試強化景點或餐廳。');
                
                setIsAiPlusProcessingId(item.id);
                try {
                    const existingData = JSON.stringify({
                        title: item.title,
                        location: item.location,
                        type: item.type,
                        notes: item.notes,
                        rainy_backup: item.rainy_backup || '',
                        tabelog_score: item.tabelog_score || 0
                    });

                    const prompt = `You are a professional travel information expert. Enhance the details of this existing itinerary item.
                    Task: Given the item data, provide highly detailed and helpful travel notes/tips.
                    
                    Existing Data (Chinese/Japanese): ${existingData}
                    
                    Instructions for Enhancement (Return JSON object):
                    1. **notes (Mandatory update):** MUST be enhanced with detailed, specific tips (觀賞重點/推薦菜單/小秘訣). IMPORTANT: Format the notes using bullet points with newlines (e.g., "- Tip 1\\n- Tip 2"). For key phrases (e.g., dish names, main tips, specific routes), wrap them in <b> tags (e.g., "點餐 <b>特製豚骨拉麵</b>"). Use Traditional Chinese. Confirm the location is currently operating (no permanent closures).
                    2. **rainy_backup:** If currently empty and the item type suggests outdoor exposure, suggest a realistic, indoor alternative location (Chinese name).
                    3. **tabelog_score (Food only):** If type is 'food' and score is 0, provide a realistic float score between 3.50 and 4.00 (e.g., 3.65). Otherwise, keep original score.
                    
                    STRICTLY return ONLY the updated JSON object with *all* original fields present. The output must be perfectly parsable JSON: {"title": "...", "notes": "...", "rainy_backup": "...", "tabelog_score": 3.60}.`;

                    const resultText = await callGemini(prompt, true);
                    const cleanedJson = cleanJsonString(resultText);
                    const updatedFields = JSON.parse(cleanedJson);

                    const updatedItem = {
                        ...item,
                        ...updatedFields,
                        // Ensure numerical fields remain robustly converted from API string output
                        tabelog_score: Number(updatedFields.tabelog_score) || Number(item.tabelog_score) || 0,
                        isAiPlus: true, // Mark it as AI Enhanced
                        // Preserve original AI status if it was AI generated initially
                        isAi: item.isAi || false 
                    };
                    
                    updateAppData('items', appData.items.map(i => i.id === item.id ? updatedItem : i));
                } catch (error) { 
                    console.error("AI Plus Enhancement Failed:", error);
                    alert("AI Plus 強化失敗: " + (error.message || "請檢查 API Key 或重試。"));
                } finally { 
                    setIsAiPlusProcessingId(null);
                }
            };


            const handleGeneratePhrases = async () => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                if (!phraseKeyword) return alert("請輸入關鍵字");
                setIsGeneratingPhrases(true);
                setGeneratedPhrases([]); // Clear previous results
                try {
                    // --- UPDATED PROMPT: Emphasize Keigo and strict ruby format, request jp_clean for TTS ---
                    const prompt = `Role: Professional Japanese language tutor specializing in polite conversation (Keigo).
                    Task: Provide 8 to 10 highly practical and POLITE Japanese phrases suitable for a tourist interacting with service staff, related to the keyword: "${phraseKeyword}". Ensure standard polite forms (です/ます/ございます) are used.
                    Format: Strictly return a valid JSON array of objects (no markdown, no surrounding text).
                    Structure: [{"zh": "Traditional Chinese meaning (e.g., 我想預約)", "jp_html": "Japanese text with HTML ruby tags for reading aid. CRITICALLY, EVERY KANJI MUST BE WRAPPED with <ruby>Kanji<rt>Hiragana</rt></ruby>. Example: <ruby>予約<rt>よやく</rt></ruby>をしたいのですが", "jp_clean": "Clean Japanese text (no ruby tags) for TTS playback", "romaji": "Romaji reading (e.g., Yoyaku o shitai no desu ga)"}]`;
                    
                    const result = await callGemini(prompt, true);
                    const cleaned = cleanJsonString(result);
                    const phrases = JSON.parse(cleaned);
                    setGeneratedPhrases(phrases);
                } catch (e) {
                    console.error("Gemini API Error:", e);
                    alert("生成失敗: " + e.message);
                } finally {
                    setIsGeneratingPhrases(false);
                }
            };

            const handleAiSafetyInfo = async () => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                if(!safetyRegion) return alert('請輸入城市名稱');
                setIsAiLoadingSafety(true);
                try {
                    // UPDATED PROMPT to explicitly request multilingual address/name format
                    const prompt = `Retrieve emergency contact info for a Taiwanese tourist in "${safetyRegion}". Return strictly JSON: {office_name, office_phone, office_address, medical_support: [{name, phone, address, desc}], emergency_numbers}. Must include local government office for Taiwan and 3-5 medical institutions. 
                    
                    Requirements for multilingual output:
                    1. office_name: Official name in Traditional Chinese.
                    2. office_address: Provide the local address (Japanese/local script), followed by the English or Romanized translation in parentheses. Example: "福岡市中央區櫻坂3-12-42 (Sakurazaka 3-12-42, Chuo-ku, Fukuoka-shi)".
                    3. medical_support: The 'name' field should include the Japanese name, Traditional Chinese name, and English/Romanized name. The 'address' field should include the local and English/Romanized address for GPS ease. The 'desc' must clarify the Chinese/multilingual support status.
                    
                    STRICTLY return ONLY a single JSON object (no markdown).`;
                    
                    const resultText = await callGemini(prompt, true); 
                    const cleaned = cleanJsonString(resultText);
                    const info = JSON.parse(cleaned);
                    if (info && info.office_name) {
                        // Correctly update state with new info
                        updateAppData('safety', {
                            ...appData.safety, // Keep defaults if missing
                            ...info 
                        });
                        alert(`已更新 ${safetyRegion} 的緊急資訊！`);
                    } else {
                        alert("AI 未能找到有效資訊，請檢查城市名稱或稍後再試");
                    }
                } catch (e) { 
                    console.error(e);
                    alert("更新失敗: " + e.message); 
                } finally { 
                    setIsAiLoadingSafety(false); 
                }
            };

            const handleAiTranslate = async (textToTranslate = translateText) => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                if(!textToTranslate || isAiTranslating || isOcrProcessing || isListening) return;
                setIsAiTranslating(true);
                try {
                    const prompt = `Translate: "${textToTranslate}". If the input is Traditional Chinese, translate to polite Japanese. If the input is Japanese (or other), translate to Traditional Chinese. Return only the clean translation text.`;
                    const res = await callGemini(prompt);
                    setTranslatedResult(res.trim());
                } catch(e){ alert(e.message); } finally { setIsAiTranslating(false); }
            }

            const handleSpeechRecognition = () => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return alert("您的瀏覽器不支援語音辨識");
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW'; 
                recognition.onstart = () => { setIsListening(true); setTranslateText(''); setTranslatedResult(''); };
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setTranslateText(transcript);
                    handleAiTranslate(transcript);
                };
                recognition.onerror = (event) => {
                    if (event.error === 'no-speech') {
                        // Silently handle no speech error
                    } else {
                        alert("語音辨識錯誤: " + event.error);
                    }
                };
                recognition.start();
            };

            const handleCameraClick = () => fileInputRef.current?.click();
            const handleImageUpload = async (e) => {
                if (!checkApiKeyAndAlert()) { e.target.value = ''; return; } // Early exit check
                const file = e.target.files[0];
                if (!file) return;
                setIsOcrProcessing(true);
                setTranslateText('');
                setTranslatedResult('');
                try {
                    // Use jpn+chi_tra for Japanese tickets with Chinese context
                    const { data: { text } = {} } = await Tesseract.recognize(file, 'jpn+chi_tra'); 
                    const cleanedText = text ? text.trim() : '';
                    setTranslateText(cleanedText);
                    // Pass the recognized text for AI translation
                    handleAiTranslate(cleanedText);
                } catch (err) { alert("圖片辨識失敗"); } finally { setIsOcrProcessing(false); e.target.value = ''; }
            };

            const handleAiPlan = async () => {
                if (!checkApiKeyAndAlert()) return; // Early exit check
                const locationToPlan = aiPlannerCity || currentDay.themeCity;
                const startLocation = aiPlannerStartLocation;
                const endLocation = aiPlannerEndLocation;
                const minCost = Number(aiPlannerMinCost) || 0;
                const maxCost = Number(aiPlannerMaxCost) || 100000;
                
                if (!locationToPlan || !aiPlannerStyle) return alert('請輸入地點和風格');
                if (minCost > maxCost) return alert('最低預算不能高於最高預算'); // FIX 3: Validation

                setIsAiPlanning(true);
                try {
                    // UPDATED PROMPT with new requirements
                    const prompt = `You are a professional, highly detailed travel planner specializing in Kyushu, Japan.
                    Task: Plan a realistic, detailed 1-day itinerary for "${locationToPlan}" (${aiPlannerStyle}) in Traditional Chinese, starting at ${aiPlannerStartTime} and ending at ${aiPlannerEndTime}.
                    Starting Location for Day: "${startLocation || locationToPlan + "主要交通樞紐"}"
                    End Location for Day (Final Return Point): "${endLocation || startLocation || locationToPlan + "主要交通樞紐"}"
                    
                    Constraints:
                    1. **Concreteness & Status:** All titles and locations MUST be real, specific places (e.g., "太宰府天滿宮", not just "景點") and MUST be currently operating (no permanent closures).
                    2. **Notes/Transportation (Mandatory):** The 'notes' field has dual purpose:
                       a) For activities/sights (type: 'activity', 'hotel', 'flight'): Provide specific viewing focus, tips, or important details. IMPORTANT: Format these tips using bullet points with newlines (e.g., "- <b>必看</b>主殿的梅花圖騰\\n- 建議提早<b>30分鐘</b>抵達").
                       b) For transport (Title: "移動/交通"): Provide specific route details and tools (e.g., "搭乘<b>西鐵天神大牟田線特急</b>" or "搭乘<b>福岡市地下鐵空港線</b>").
                    3. **Budget:** Total cost should be between JPY ${minCost} and JPY ${maxCost}. Individual item costs must be realistic.
                    4. **Food Details:** For 'food' type items, include a 'tabelog_score' (realistic float value between 3.00 and 4.50, e.g., 3.65).
                    5. **Rainy Backup:** For *all* outdoor activities (e.g., parks, shrines, outdoor viewing), provide a specific, indoor 'rainy_backup' location/activity name, otherwise set to "".

                    Return STRICTLY a valid JSON array (no markdown, no surrounding text): [
                        {
                            "time": "HH:MM", 
                            "duration": "e.g. 1小時", 
                            "title": "Activity Name or 移動/交通", 
                            "location": "Address/Place Name", 
                            "cost": 0, 
                            "notes": "Detailed notes (use <b> tags for emphasis).", 
                            "weather": "sunny", 
                            "temperature": 20, 
                            "type": "activity", // Use 'activity' for transit steps too
                            "tabelog_score": 0.00, // Only for food.
                            "rainy_backup": "" // Indoor place name if activity is outdoor.
                        }
                    ]`;
                    const resultText = await callGemini(prompt, true);
                    const cleanedJson = cleanJsonString(resultText);
                    const parsedItems = JSON.parse(cleanedJson);

                    const newItems = parsedItems.map((item, index) => ({
                        ...item,
                        id: Date.now() + index,
                        dayId: selectedDayId,
                        mapUrl: generateMapUrl(item.title + " " + item.location),
                        cost: Number(item.cost || 0),
                        temperature: Number(item.temperature || 0),
                        tabelog_score: Number(item.tabelog_score || 0), // Use generated score
                        isAi: true,
                        isAiPlus: false // Newly generated items are initial AI (not plus enhanced)
                    }));
                    
                    updateAppData('items', [...appData.items, ...newItems]);
                    setIsAiPlannerOpen(false);
                    if (!currentDay.themeCity) {
                        const updatedDays = appData.days.map(d => d.id === selectedDayId ? { ...d, themeCity: locationToPlan } : d);
                        updateAppData('days', updatedDays);
                    }
                } catch (error) { 
                    console.error("Gemini API Error:", error);
                    alert("AI 排程生成失敗: " + (error.message || "請檢查 API Key 或重試。"));
                } finally { setIsAiPlanning(false); }
            };

            const renderWeatherIcon = (type) => {
                switch(type) {
                    case 'sunny': return <span className="text-orange-400"><IconSun /></span>;
                    case 'cloudy': return <span className="text-slate-400"><IconCloud /></span>;
                    case 'rainy': return <span className="text-blue-400"><IconRain /></span>;
                    case 'snowy': return <span className="text-cyan-300"><IconSnow /></span>;
                    default: return <span className="text-orange-400"><IconSun /></span>;
                }
            };

            // AI Style Styles (Dynamic)
            const aiCardStyle = isDark 
                ? `${bgSub} border-l-4 border-[${currentPalette.dark_accent}] shadow-[0_0_15px_rgba(164,202,104,0.1)]` 
                : `bg-gradient-to-br from-[${currentPalette.ai_bg}] to-white border-l-4 border-[${currentPalette.main}] shadow-sm`;

            // NEW: Suggested Card Style (will use cyan/blue to distinguish from AI plan)
            const suggestionCardStyle = isDark 
                ? `bg-[#1F2937] border-l-4 border-cyan-400 shadow-md` 
                : `bg-cyan-50 border-l-4 border-cyan-500 shadow-sm`;

            return (
                <div className={`min-h-screen font-sans pb-24 transition-colors duration-300 ${bgMain} ${textMain}`}>
                    {/* Header */}
                    <div className={`sticky top-0 z-40 transition-colors duration-300 ${headerBg}`}>
                        <div className="max-w-3xl mx-auto px-4 py-3">
                            <div className="flex justify-between items-center flex-wrap"> 
                                {/* FIX 1: 確保標題顯示 appData.title，使其可被編輯 */}
                                <div className="w-full flex justify-between items-center pb-2">
                                    <h1 onClick={handleEditTitle} className={`text-xl font-bold flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity ${isDark ? 'text-white' : 'text-white'}`}>
                                        <span className="truncate">{appData.title}</span> <span className="opacity-60 flex-shrink-0"><IconPencilSmall /></span>
                                    </h1>
                                </div>
                                
                                {/* FIX: 將按鈕群組放在標題下方獨立的一行，確保標題有足夠的空間 (2.) */}
                                <div className={`flex w-full justify-start gap-1 p-1 rounded-lg flex-shrink-0 header-buttons ${isDark ? 'bg-[#374151]' : 'bg-black/10'}`}>
                                    
                                    {/* NEW: Combined Settings Button (API Key, Theme, Color) - ENHANCED VISUALS */}
                                    <button 
                                        onClick={() => { setTempApiKey(userApiKey); setIsSettingsModalOpen(true); setIsKeyVisible(false); }} // Reset key visibility on open
                                        className={`p-2 rounded-md transition-all ${
                                            userApiKey 
                                                ? 'text-green-300 hover:bg-green-700/50' // Highlight green if custom key is active
                                                : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                        }`} 
                                        title={userApiKey ? "設定 (自訂 Key 已啟用)" : "應用程式設定"}
                                    >
                                        <IconUser /> {/* UPDATED ICON */}
                                    </button>

                                    <button onClick={() => setActiveTab('itinerary')} className={`p-2 rounded-md ${activeTab === 'itinerary' 
                                        ? (isDark ? 'bg-[#4B5563] text-[#A4CA68]' : `bg-white text-[${currentPalette.main}]`) 
                                        : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                    }`}><IconCalendar /></button>
                                    <button onClick={() => setActiveTab('tools')} className={`p-2 rounded-md ${activeTab === 'tools' 
                                        ? (isDark ? 'bg-[#4B5563] text-[#A4CA68]' : `bg-white text-[${currentPalette.main}]`) 
                                        : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                    }`}><IconTranslate /></button>
                                    <button onClick={() => setActiveTab('budget')} className={`p-2 rounded-md ${activeTab === 'budget' 
                                        ? (isDark ? 'bg-[#4B5563] text-[#A4CA68]' : `bg-white text-[${currentPalette.main}]`) 
                                        : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                    }`}><IconYen /></button>
                                    <button onClick={() => setActiveTab('shopping')} className={`p-2 rounded-md ${activeTab === 'shopping' 
                                        ? (isDark ? 'bg-[#4B5563] text-[#A4CA68]' : `bg-white text-[${currentPalette.main}]`) 
                                        : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                    }`}><IconShoppingCart /></button>
                                    <button onClick={() => setActiveTab('safety')} className={`p-2 rounded-md ${activeTab === 'safety' 
                                        ? (isDark ? 'bg-[#4B5563] text-[#A4CA68]' : `bg-white text-[${currentPalette.main}]`) 
                                        : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                    }`}><IconShield /></button>
                                    <button onClick={() => setIsPrivacyMode(!isPrivacyMode)} className={`p-2 rounded-md transition-all ${isPrivacyMode 
                                        ? 'text-red-400 bg-white/20' 
                                        : (isDark ? 'text-gray-400 hover:text-white' : 'text-white hover:bg-white/20')
                                    }`} title="隱私/截圖模式">{isPrivacyMode ? <IconEyeOff /> : <IconEye />}</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4 mt-4" id="itinerary-content-export"> {/* Added ID for screenshot export */}
                        {/* Loading Indicator */}
                        {isLoading && (
                            <div className="text-center py-10 rounded-xl border border-dashed text-slate-400 border-gray-700">
                                <IconLoading /> 正在載入您的行程...
                            </div>
                        )}
                        
                        {!isLoading && activeTab === 'itinerary' && (
                            <div className="animate-fadeIn relative"> 

                                {/* Day Selector & Pagination */}
                                <div className="flex items-center justify-between overflow-x-auto no-scrollbar pb-2 relative z-10">
                                    <button 
                                        onClick={() => handleScroll('back')} 
                                        disabled={!canScrollBack} 
                                        className={`p-2 rounded-full transition-all disabled:opacity-30 flex-shrink-0 ${isDark ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-700 hover:bg-gray-200'}`}
                                    >
                                        <IconArrowLeft />
                                    </button>

                                    <div className="flex gap-2 px-1 min-w-0 flex-1 justify-center">
                                        {appData.days.slice(currentDayRangeStart, currentDayRangeStart + MAX_DAYS_DISPLAY).map(day => (
                                            <div 
                                                key={day.id} 
                                                draggable={!isPrivacyMode}
                                                onDragStart={(e) => handleDragStart(e, day.id)}
                                                onDragEnter={(e) => handleDragEnter(day.id)}
                                                onDragOver={handleDragOver}
                                                onDrop={handleDrop}
                                                onDragEnd={handleDragEnd}
                                                className={`flex-shrink-0 cursor-pointer relative group ${dayDragId === day.id ? 'opacity-50' : ''}`}
                                            >
                                                <button 
                                                    onClick={() => setSelectedDayId(day.id)} 
                                                    className={`w-16 h-16 rounded-xl text-xs flex flex-col items-center justify-center border transition-all shadow-md ${selectedDayId === day.id 
                                                        ? (isDark ? `bg-[${currentPalette.dark_accent}] text-[#111827] border-[${currentPalette.dark_accent}] scale-105` : `bg-[${currentPalette.main}] text-white border-[${currentPalette.main}] scale-105`) 
                                                        : `${isDark ? 'bg-[#1F2937] border-gray-600 text-gray-400' : 'bg-white text-[#5C6E38] border-[#DEEBAF]'}`}`
                                                    }
                                                >
                                                    <span className={`text-[10px] font-medium leading-none mb-0.5 opacity-80 truncate max-w-full ${selectedDayId === day.id ? 'text-black/70' : ''}`}>{day.themeCity || '未設定'}</span>
                                                    <span className="font-bold text-lg leading-none">{day.name}</span>
                                                    <span className={`text-[10px] leading-none opacity-60 ${selectedDayId === day.id ? 'text-black/60' : ''}`}>{day.date}</span>
                                                </button>
                                                {/* NEW: Delete Button on Day Tile */}
                                                {!isPrivacyMode && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); handleDeleteDay(day.id); }}
                                                        className={`absolute top-0 right-0 p-1 rounded-bl-lg rounded-tr-xl opacity-0 group-hover:opacity-100 transition-opacity z-20 ${
                                                            isDark ? 'bg-red-700/80 text-white' : 'bg-red-500/80 text-white'
                                                        }`}
                                                        title={`刪除 ${day.name}`}
                                                    >
                                                        <IconTrash width={12} height={12} />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                        {!isPrivacyMode && (
                                            <button onClick={addNewDay} className={`flex-shrink-0 w-16 h-16 rounded-xl border border-dashed flex items-center justify-center ${isDark ? 'bg-[#1F2937] text-gray-400 border-gray-600 hover:bg-[#374151]' : 'bg-[#E9F3D8] text-[${currentPalette.main}] border-[#DEEBAF] hover:bg-[#DEEBAF]'}`}><IconPlus /></button>
                                        )}
                                    </div>

                                    <button 
                                        onClick={() => handleScroll('forward')} 
                                        disabled={!canScrollForward} 
                                        className={`p-2 rounded-full transition-all disabled:opacity-30 flex-shrink-0 ${isDark ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-700 hover:bg-gray-200'}`}
                                    >
                                        <IconArrowRight />
                                    </button>
                                </div>


                                {/* Day Info Card (Starts aligning content to the left) */}
                                <div className={`mt-2 mb-4 p-4 rounded-xl border relative shadow-sm ${cardBg}`}>
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="flex-1 flex items-center gap-2 flex-wrap min-w-0"> 
                                            <h2 className="text-2xl font-bold"> 
                                                <span className="truncate">{currentDay.themeCity || <span className="text-gray-400 font-normal text-base">設定主題城市...</span>}</span>
                                            </h2>
                                            
                                            {/* NEW: Day Weather/Temp Display (3.) */}
                                            {(dayTempRange.min !== null && dayTempRange.max !== null) && (
                                                <div className={`flex items-center gap-2 text-sm ${textSub} ml-2`}>
                                                    <span className="flex items-center">
                                                        {renderWeatherIcon(dayTempRange.weather)}
                                                    </span>
                                                    <span className={`font-mono font-bold ${accentText}`}>
                                                        {dayTempRange.min}°C ~ {dayTempRange.max}°C
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Controls Group - Moved Edit/Clear to the far right (3.) */}
                                        <div className="flex flex-shrink-0 gap-1 ml-4 items-center">
                                            {currentDay.reservedTime && <span className={`text-xs px-2 py-1 rounded-lg border flex-shrink-0 flex items-center gap-1 ${isDark ? `bg-[#374151] ${accentText} border-gray-600` : `bg-[${currentPalette.light_bg}] ${accentText} border-[#DEEBAF]`}`}><IconClock /> 預留: {currentDay.reservedTime}</span>}
                                            {!isPrivacyMode && <button onClick={handleOpenDaySettings} className={`p-1.5 rounded-full transition-colors ${isDark ? 'hover:bg-gray-700 text-gray-400' : `hover:bg-[${currentPalette.light_bg}] ${accentText}`}`} title="編輯今日資訊"><IconEdit /></button>}
                                            {!isPrivacyMode && <button onClick={handleClearDayItems} className={`p-1.5 rounded-full transition-colors ${isDark ? 'hover:bg-red-900/30 text-red-400' : 'hover:bg-red-50 text-red-600'}`} title="清空當日行程"><IconTrash /></button>}
                                        </div>
                                    </div>
                                    
                                    {/* 修正城市敘事對齊：移除 W-16 佔位符，讓其佔滿空間 (1.) */}
                                    {currentDay.cityStory && (
                                        <div className="pt-2">  
                                            <div className={`text-sm leading-7 p-3 rounded-lg border relative w-full ${isDark ? 'bg-[#111827] border-gray-700' : `bg-[${currentPalette.light_bg}] border-[#DEEBAF]`}`}>
                                                <span className={`absolute top-0 right-0 text-[9px] font-bold px-1.5 py-0.5 rounded-bl-lg rounded-tr-lg ${isDark ? `text-[#111827] bg-[${currentPalette.dark_accent}]` : `text-white bg-[${currentPalette.main}]`}`}>AI 故事</span>
                                                <div className="flex gap-2 items-start"><span className="text-base flex-shrink-0 mt-0.5">📖</span><span className={`${textMain} tracking-wide min-w-0 break-words`}>{currentDay.cityStory}</span></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* NEW: AI Suggested Activity Card */}
                                {!isPrivacyMode && (aiSuggestedItem ? (
                                    <div className={`animate-fadeIn p-4 rounded-xl border border-l-4 relative mb-4 ${suggestionCardStyle}`} style={{ borderColor: isDark ? currentPalette.dark_accent : currentPalette.main }}>
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className={`font-bold text-lg flex items-center gap-2 ${suggestCardText}`}>
                                                💡 AI 建議活動: {aiSuggestedItem.title}
                                            </h3>
                                            {/* Dismiss Button */}
                                            <button onClick={() => setAiSuggestedItem(null)} className={`text-sm p-1 rounded-full opacity-60 hover:opacity-100 ${isDark ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}><IconX /></button>
                                        </div>
                                        <div className="text-sm space-y-2">
                                            <p className={`${isDark ? 'text-gray-400' : 'text-gray-600'} break-words`}>
                                                @ {aiSuggestedItem.location} • {aiSuggestedItem.time}
                                            </p>
                                            <p 
                                                className={`text-base leading-relaxed ${isDark ? 'text-gray-300' : 'text-gray-800'} notes-content`}
                                                dangerouslySetInnerHTML={{ __html: aiSuggestedItem.notes }}
                                            ></p>
                                            <div className="flex gap-3 pt-2">
                                                <button onClick={handleAcceptSuggestion} className={`flex-1 py-2 rounded-lg font-bold transition-all ${accentBg}`}>
                                                    ✅ 接受並新增至行程
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="mb-4 text-center p-4 border rounded-xl space-y-3" style={{ borderColor: currentPalette.main + '20' }}>
                                        <p className={`${textSub} text-sm font-bold`}>⚡ 取得單點 AI 建議</p>
                                        <div className="grid grid-cols-4 gap-2">
                                            <button onClick={() => handleAiSuggestActivity('morning')} disabled={isAiPlanning} className={`py-2 rounded-lg text-xs font-bold disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-1 ${isAiPlanning ? 'opacity-70 cursor-not-allowed' : accentBg}`}>
                                                {isAiPlanning ? <IconLoading/> : '早上 (12點前)'}
                                            </button>
                                            <button onClick={() => handleAiSuggestActivity('afternoon')} disabled={isAiPlanning} className={`py-2 rounded-lg text-xs font-bold disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-1 ${isAiPlanning ? 'opacity-70 cursor-not-allowed' : accentBg}`}>
                                                {isAiPlanning ? <IconLoading/> : '下午 (17點前)'}
                                            </button>
                                            <button onClick={() => handleAiSuggestActivity('evening')} disabled={isAiPlanning} className={`py-2 rounded-lg text-xs font-bold disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-1 ${isAiPlanning ? 'opacity-70 cursor-not-allowed' : accentBg}`}>
                                                {isAiPlanning ? <IconLoading/> : '晚上 (23點前)'}
                                            </button>
                                            <button onClick={() => handleAiSuggestActivity('late_night')} disabled={isAiPlanning} className={`py-2 rounded-lg text-xs font-bold disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-1 ${isAiPlanning ? 'opacity-70 cursor-not-allowed' : accentBg}`}>
                                                {isAiPlanning ? <IconLoading/> : '深夜 (5點前)'}
                                            </button>
                                        </div>
                                        <div className={`text-xs ${textSub}`}>建議將根據當日城市 **{currentDay.themeCity}** 推薦活動或節慶。</div>
                                    </div>
                                ))}


                                {/* AI/Clear Buttons */}
                                {!isPrivacyMode && <div className="flex gap-2 mb-4 relative z-10">
                                    <button onClick={() => { setAiPlannerCity(currentDay.themeCity); setIsAiPlannerOpen(true); }} className={`flex-1 py-2 rounded-xl border flex items-center justify-center gap-2 font-bold text-sm hover:shadow-sm transition-all ${isDark ? 'bg-gradient-to-r from-gray-800 to-gray-700 text-[#A4CA68] border-gray-600 hover:border-[#A4CA68]' : `bg-[${currentPalette.light_bg}] ${accentText} border-[${currentPalette.main}] hover:bg-[#DEEBAF]`}`}><IconSparkles /> ✨ AI 自動幫我排這一天</button>
                                    {hasAiItems && <button onClick={handleClearAiItems} className={`px-4 py-2 rounded-xl border flex items-center justify-center gap-1 text-sm font-bold ${isDark ? 'bg-red-900/20 text-red-400 border-red-900' : 'bg-white text-red-600 border-red-400 hover:bg-[#F4F8EB]'}`}><IconTrash /> 清除 AI</button>}
                                </div>}

                                {/* Itinerary Items */}
                                <div className="space-y-4 mt-2 pb-24">
                                    {currentDayItems.length === 0 ? (
                                        <div className={`text-center py-12 rounded-xl border border-dashed ${isDark ? 'text-gray-500 border-gray-700' : 'text-slate-400'}`}><p>這天還沒有行程安排</p><p className="text-sm mt-1">點擊上方 AI 按鈕或右下角 + 新增</p></div>
                                    ) : (
                                        currentDayItems
                                            .filter(item => !(isPrivacyMode && (item.type === 'flight' || item.type === 'hotel')))
                                            .map((item, index) => (
                                                <div 
                                                    key={item.id} 
                                                    draggable={!isPrivacyMode}
                                                    onDragStart={(e) => handleItemDragStart(e, item)}
                                                    onDragEnter={(e) => handleItemDragOver(e, item)}
                                                    onDragOver={(e) => handleItemDragOver(e, item)}
                                                    onDrop={(e) => handleItemDrop(e, item)}
                                                    onDragEnd={handleItemDragEnd}
                                                    className={`relative group transition-transform ${itemDragId === item.id ? 'opacity-30' : ''} ${itemDragOverId === item.id ? 'item-drag-over-visual' : ''}`}
                                                > 
                                                    
                                                    {/* Clickable Card Wrapper */}
                                                    <div 
                                                        onClick={() => handleOpenModal(item)}
                                                        className={`rounded-xl p-3 shadow-sm border relative transition-all hover:shadow-md overflow-hidden cursor-pointer active:scale-[0.99] ${
                                                            item.type === 'flight' 
                                                                ? (isDark ? `${bgSub} border-[${currentPalette.dark}] text-white` : `bg-gradient-to-r ${flightCard} shadow-md text-white`)
                                                                // Use specific style for accepted suggestion (AI+)
                                                                : (item.isAiPlus || item.isAiSuggestion // Check if it's AI+ OR accepted suggestion
                                                                    ? suggestionCardStyle
                                                                    : (item.isAi ? aiCardStyle : cardBg)
                                                                )
                                                        }`}>
                                                        
                                                        {/* Dynamic Notches */}
                                                        {item.type === 'flight' && (
                                                            <>
                                                                <div className={`ticket-notch-left ${isDark ? 'bg-[#111827]' : bgMain.replace(/bg-/, 'bg-')} `}></div>
                                                                <div className={`ticket-notch-right ${isDark ? 'bg-[#111827]' : bgMain.replace(/bg-/, 'bg-')} `}></div>
                                                            </>
                                                        )}

                                                        {/* AI / AI+ Tag Display */}
                                                        {(item.isAi || item.isAiPlus || item.isAiSuggestion) && (
                                                            <span className={`absolute top-0 right-0 text-[9px] font-bold px-1.5 py-0.5 rounded-bl-lg rounded-tr-xl pointer-events-none ${
                                                                item.isAi 
                                                                    ? (isDark ? `bg-[${currentPalette.dark_accent}] text-[#111827]` : `text-white bg-[${currentPalette.main}]`)
                                                                    : (isDark ? 'bg-cyan-400 text-[#111827]' : 'bg-cyan-500 text-white')
                                                            }`}>
                                                                {item.isAiPlus || item.isAiSuggestion ? 'AI+' : 'AI'}
                                                            </span>
                                                        )}
                                                        
                                                        {/* AI Sparkles (Visual cue for AI items) */}
                                                        {(item.isAi || item.isAiPlus || item.isAiSuggestion) && <div className="absolute top-0 right-0 p-1 opacity-10 pointer-events-none"><IconSparkles /></div>}
                                                        
                                                        <div className="flex items-start justify-between relative z-10">
                                                            
                                                            {/* Main Content Area */}
                                                            <div className="flex gap-3 w-full">
                                                                
                                                                {/* Time/Type Column (FIXED: Increased width from w-14 to w-16 for better time display) */}
                                                                <div className="flex flex-col items-center pt-1 w-16 flex-shrink-0">
                                                                    <div className="flex flex-col items-center w-full">
                                                                        {(item.isAi || item.isAiPlus || item.isAiSuggestion) && <span className={`text-[9px] font-bold px-1 rounded mb-1 ${item.isAiPlus || item.isAiSuggestion ? (isDark ? 'bg-cyan-400 text-[#111827]' : 'bg-cyan-500 text-white') : (isDark ? `bg-[${currentPalette.dark_accent}] text-[#111827]` : `bg-[${currentPalette.main}] text-white`)}`}>{item.isAiPlus || item.isAiSuggestion ? 'AI+' : 'AI'}</span>}
                                                                        <span className={`text-lg font-bold font-mono leading-none ${item.type === 'flight' ? flightText : accentText}`}>{item.time}</span>
                                                                        {item.duration && <span className={`text-[10px] font-medium mt-1 ${item.type === 'flight' ? 'text-white/80' : textSub}`}>{item.duration}</span>}
                                                                        {item.type === 'flight' && <span className="mt-2 text-white/80 scale-125 transform"><IconPlaneDeparture /></span>}
                                                                    </div>
                                                                </div>

                                                                {/* Description/Location Column */}
                                                                <div className="flex-1 min-w-0 pt-0.5">
                                                                    <h3 className={`font-bold text-lg leading-tight break-words pr-8 ${item.type === 'flight' ? flightText : textMain}`}> 
                                                                        {item.title}
                                                                    </h3>
                                                                    {item.location && (
                                                                        <div className={`flex items-center text-sm mb-1 mt-1 ${item.type === 'flight' ? 'text-white/90' : textSub}`}>
                                                                            <span className="mr-1 flex-shrink-0"><IconMapPin /></span>
                                                                            <a href={item.mapUrl} target="_blank" rel="noopener noreferrer" className={`underline decoration-dotted break-all ${item.type === 'flight' ? 'text-white' : accentText}`} onClick={(e)=>e.stopPropagation()}>{item.location}</a>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* FIX 2: 備註驚嘆號顏色 (深橙/紅) */}
                                                                    {item.notes && <div className={`flex items-start gap-1.5 mt-2 p-2 rounded-lg ${item.type === 'flight' ? 'bg-black/10' : (isDark ? 'bg-gray-800' : 'bg-black/5')}`}>
                                                                        <span className={`${item.type === 'flight' || item.type === 'hotel' 
                                                                            ? (isDark ? 'text-red-400' : 'text-red-600') 
                                                                            : (isDark ? 'text-orange-300' : 'text-orange-500')} flex-shrink-0 mt-0.5 scale-75`}>
                                                                            <IconExclamation />
                                                                        </span>
                                                                        {/* FIX: Use text-lg and font-bold for better emphasis and readability */}
                                                                        <p 
                                                                            className={`text-lg leading-relaxed ${item.type === 'flight' ? 'text-white/90' : textSub} break-words whitespace-pre-wrap notes-content`}
                                                                            dangerouslySetInnerHTML={{ __html: item.notes }}
                                                                        ></p>
                                                                    </div>}

                                                                    {/* Tabelog Score Display */}
                                                                    {item.type === 'food' && item.tabelog_score > 0 && (
                                                                        <div className={`flex items-center gap-1 mt-2 text-sm font-bold ${isDark ? 'text-yellow-400' : 'text-yellow-600'}`}>
                                                                            <IconStar />
                                                                            <span className="font-mono">{item.tabelog_score.toFixed(2)}</span>
                                                                            <span className={`text-xs font-normal ${textSub}`}> (Tabelog)</span>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* 修正: Item Story 增加 min-w-0 和 break-words 以防止溢出 (2.) */}
                                                                    {item.story && (
                                                                        <div className={`mt-2 p-3 rounded-lg border flex gap-2 items-start w-full ${isDark ? 'bg-[#111827] border-gray-700 text-gray-300' : `bg-[${currentPalette.light_bg}] border-[#DEEBAF] ${textMain}`}`}>
                                                                            <div className={`mt-0.5 flex-shrink-0 ${accentText}`}><IconBook /></div>
                                                                            <span className="text-sm leading-relaxed tracking-wide min-w-0 break-words">{item.story}</span>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    <div className="flex flex-wrap items-center gap-2 mt-2">
                                                                        {/* Story Button (only visible if no story and not AI+ or private mode) */}
                                                                        {!item.story && !item.isAiPlus && !item.isAiSuggestion && !isPrivacyMode && (
                                                                            <button 
                                                                                onClick={(e)=>{e.stopPropagation(); handleGenerateItemStory(item)}} 
                                                                                className={`text-xs flex items-center gap-1 px-2 py-1 rounded transition-colors ${item.type === 'flight' ? 'text-white/80 hover:bg-white/20' : `${accentText} hover:bg-[${currentPalette.light_bg}]`}`}
                                                                            >
                                                                                {generatingStoryId===item.id ? <IconLoading/> : <IconBook/>} 生成故事
                                                                            </button>
                                                                        )}
                                                                        
                                                                        {/* AI Plus Enhancement Button (visible only if not explicitly enhanced yet and not private mode) */}
                                                                        {!item.isAiPlus && !item.isAiSuggestion && !isPrivacyMode && (
                                                                            <button 
                                                                                onClick={(e) => { e.stopPropagation(); handleAiPlusEnhancement(item); }} 
                                                                                className={`text-xs flex items-center gap-1 px-2 py-1 rounded transition-colors ${isAiPlusProcessingId === item.id ? 'opacity-70 cursor-not-allowed' : (isDark ? 'text-indigo-300 hover:bg-indigo-900/30' : 'text-indigo-600 hover:bg-indigo-50')}`}
                                                                                disabled={isAiPlusProcessingId === item.id}
                                                                            >
                                                                                {isAiPlusProcessingId === item.id ? <IconLoading/> : <IconSparkles/>} AI PLUS 強化
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                    
                                                                    {item.rainy_backup && <div className={`mt-2 p-2 rounded-lg border flex items-start gap-2 text-xs w-full ${isDark ? 'bg-[#374151] border-gray-600 text-gray-300' : 'bg-gray-50 border-gray-200 text-gray-600'}`}><div className="mt-0.5"><IconUmbrella /></div><div className="break-words"><span className="font-bold">雨天備案：</span><a href={generateMapUrl(item.rainy_backup)} target="_blank" rel="noopener" className="underline decoration-dotted" onClick={(e)=>e.stopPropagation()}>{item.rainy_backup}</a></div></div>}
                                                                </div>
                                                                
                                                            </div>

                                                            {/* Right Info Column (FIXED: Reduced margin from mr-8 to mr-0, but kept flex-shrink-0) */}
                                                            <div className="flex flex-col items-end gap-1 ml-2 flex-shrink-0"> 
                                                                <div className="text-right min-w-[60px] flex-shrink-0"> 
                                                                    <div className={`font-mono font-bold text-lg ${item.type === 'flight' ? flightText : accentText}`}>
                                                                        {item.cost > 0 ? `¥${item.cost.toLocaleString()}` : <span className={`${item.type === 'flight' ? 'text-white/50' : 'text-gray-300'}`}>-</span>}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-1 mt-1">
                                                                    {item.temperature && <span className={`text-sm font-bold font-mono tracking-tight ${item.type === 'flight' ? 'text-white/80' : textSub}`}>{item.temperature}°C</span>}
                                                                    <div className={item.type === 'flight' ? 'text-white' : ''}>{renderWeatherIcon(item.weather)}</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* DELETE BUTTON BLOCK REMOVED HERE (2. & 3. 處理後續，已在 Modal 中處理) */}
                                                    </div>
                                                </div>
                                            ))
                                    )}
                                </div>
                                {!isPrivacyMode && <button onClick={() => handleOpenModal()} className={`fixed bottom-6 right-6 text-white p-4 rounded-full shadow-lg transition-all z-30 flex items-center justify-center ${accentBg} active:scale-95 add-button-float`}><IconPlus /></button>}
                            </div>
                        )}

                        {/* Budget Tab */}
                        {!isLoading && activeTab === 'budget' && (
                            <div className="animate-fadeIn space-y-4">
                                <div className={`p-6 rounded-xl border shadow-sm ${cardBg} text-center`}>
                                    <h2 className={`text-sm font-bold uppercase mb-2 ${textSub}`}>總預算運用狀況</h2>
                                    <div className="relative pt-2">
                                        <div className="flex items-end justify-center gap-2">
                                            <span className={`text-4xl font-mono font-bold ${remainingBudget < 0 ? 'text-red-500' : accentText}`}>
                                                ¥{remainingBudget.toLocaleString()}
                                            </span>
                                            <span className={`text-sm mb-1.5 ${textSub}`}>/ ¥{appData.budget.toLocaleString()} 剩餘</span>
                                        </div>
                                        <div className={`w-full rounded-full h-3 mt-4 overflow-hidden ${isDark ? 'bg-gray-700' : `bg-[${currentPalette.light_bg}]`}`}>
                                            <div 
                                                className={`h-3 rounded-full ${remainingBudget < 0 ? 'bg-red-500' : `bg-[${currentPalette.main}]`}`} 
                                                style={{ width: `${Math.min((totalSpent / appData.budget) * 100, 100)}%` }}
                                            ></div>
                                        </div>
                                        <div className={`mt-3 pt-3 border-t ${isDark ? 'border-gray-700' : 'border-dashed border-[#DEEBAF]'} flex justify-between text-xs flex-wrap`}> 
                                            <span className={textSub}>已支出: ¥${totalSpent.toLocaleString()}</span>
                                            <span className={`${isDark ? 'text-blue-400' : 'text-blue-600'} font-bold`}>
                                                建議每日剩餘: ¥${Math.max(0, Math.floor(remainingBudget / appData.days.length)).toLocaleString()}
                                            </span>
                                        </div>
                                    </div>
                                    <button onClick={openBudgetModal} className={`mt-4 text-xs px-3 py-1.5 rounded-lg transition ${isDark ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : `bg-[${currentPalette.light_bg}] ${textSub} hover:bg-[#DEEBAF]`}`}>修改總預算</button>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    {Object.entries(budgetBreakdown).map(([key, data]) => (
                                        <div key={key} className={`p-3 rounded-lg border ${cardBg}`}>
                                            <div className="flex items-center gap-2 mb-2">
                                                <div className={`w-2 h-2 rounded-full ${data.bg}`}></div>
                                                <span className={`text-sm font-bold ${textSub}`}>{data.label}</span>
                                            </div>
                                            <span className={`font-mono font-bold text-lg ${textMain}`}>¥${data.amount.toLocaleString()}</span>
                                            <div className="text-xs text-gray-400 mt-1">${Math.round((data.amount/totalSpent)*100 || 0)}%</div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Daily Costs List Restored */}
                                <h3 className={`font-bold ml-1 mt-4 ${textMain}`}>每日支出統計</h3>
                                <div className="space-y-2">
                                    {dailyCosts.map(day => (
                                        <div key={day.id} className={`flex justify-between items-center p-3 rounded-lg border ${cardBg}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm ${isDark ? 'bg-[#374151] text-[#A4CA68]' : 'bg-[${currentPalette.light_bg}] text-[#5C6E38]'}`}>
                                                    {day.name}
                                                </div>
                                                <div>
                                                    <div className={`font-bold ${textMain}`}>{day.themeCity || '未定主題'}</div>
                                                    <div className={`text-xs ${textSub}`}>{day.date}</div>
                                                </div>
                                            </div>
                                            <div className={`font-mono font-bold text-lg ${textMain}`}>
                                                ¥${day.total.toLocaleString()}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Shopping Tab (NEW) */}
                        {!isLoading && activeTab === 'shopping' && (
                            <div className="animate-fadeIn space-y-4">
                                <div className={`p-5 rounded-xl border shadow-sm ${cardBg}`}>
                                    <h2 className={`text-xl font-bold mb-4 flex items-center gap-2 ${accentText}`}><IconShoppingCart /> AI 購物清單與手動新增</h2>

                                    {/* AI Generation Controls */}
                                    <div className="space-y-3 mb-4 p-4 border rounded-xl" style={{ borderColor: currentPalette.main + '20' }}>
                                        <div className="flex gap-2 items-center">
                                            <input type="text" value={aiShoppingCity} onChange={(e) => setAiShoppingCity(e.target.value)} placeholder="輸入城市以取得當地特產推薦" className={`flex-1 border rounded-lg p-3 text-sm outline-none ${inputBg}`} />
                                            <button onClick={handleAiGenerateShoppingList} disabled={isShoppingAiLoading} className={`px-4 py-2 rounded-lg text-sm font-bold disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-2 ${accentBg}`}>
                                                {isShoppingAiLoading ? <IconLoading /> : '✨ AI 推薦'}
                                            </button>
                                        </div>
                                        <div className={`text-xs ${textSub}`}>當前城市: {getCurrentDayName(selectedDayId)}</div>
                                    </div>
                                    
                                    {/* Manual Add Form */}
                                    <div className={`space-y-2 p-4 rounded-xl border ${isDark ? 'bg-[#111827] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                                        <h3 className={`text-base font-bold ${textMain}`}>手動新增項目</h3>
                                        <div className="grid grid-cols-6 gap-2">
                                            <input type="text" placeholder="商品名稱" value={newShoppingItem.name} onChange={e => setNewShoppingItem({...newShoppingItem, name: e.target.value})} className={`col-span-3 p-2 text-sm rounded ${inputBg}`} />
                                            <input type="number" placeholder="價格(JPY)" value={newShoppingItem.price} onChange={e => setNewShoppingItem({...newShoppingItem, price: e.target.value})} className={`col-span-1 p-2 text-sm rounded ${inputBg}`} />
                                            <input type="text" placeholder="購買地點" value={newShoppingItem.location} onChange={e => setNewShoppingItem({...newShoppingItem, location: e.target.value})} className={`col-span-2 p-2 text-sm rounded ${inputBg}`} />
                                        </div>
                                        <button onClick={handleAddShoppingItem} disabled={!newShoppingItem.name.trim()} className={`w-full py-2 rounded-lg text-sm font-bold disabled:opacity-50 transition ${accentBg}`}>新增至清單</button>
                                    </div>

                                    {/* Shopping List Table */}
                                    <h3 className={`font-bold mt-6 mb-2 ${textMain}`}>我的購物清單 (總計: ¥{totalShoppingCost.toLocaleString()})</h3>
                                    <div className={`overflow-x-auto rounded-lg border ${isDark ? 'border-gray-700' : 'border-gray-200'} shadow-md`}>
                                        <table className={`min-w-full shopping-table ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                                            <thead>
                                                <tr className={`uppercase text-xs font-bold ${isDark ? 'bg-[#374151]' : 'bg-gray-100'} ${textSub}`} style={{ borderColor: currentPalette.main + '40' }}>
                                                    <th></th>
                                                    <th>商品名稱</th>
                                                    <th>價格</th>
                                                    <th>地點/備註</th>
                                                    <th>行程</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {appData.shopping_list.map(item => (
                                                    <tr key={item.id} className={`transition-all ${item.purchased ? (isDark ? 'opacity-50 line-through bg-[#1F2937]/50' : 'opacity-60 line-through bg-green-50') : (isDark ? 'hover:bg-[#374151]' : 'hover:bg-gray-100')}`} style={{ borderColor: isDark ? '#374151' : '#E5E7EB' }}>
                                                        <td className="w-8">
                                                            <input type="checkbox" checked={item.purchased} onChange={() => handleTogglePurchased(item.id)} className={`form-checkbox h-4 w-4 rounded transition-colors ${item.purchased ? `text-[${currentPalette.main}] border-[${currentPalette.main}] bg-[${currentPalette.main}]` : 'text-gray-400'}`} style={{ borderColor: currentPalette.main + '40' }}/>
                                                        </td>
                                                        <td className="font-medium break-words max-w-[150px] flex items-center gap-2">
                                                            {item.name}
                                                            {/* Google Image Search Link */}
                                                            <a href={generateImageUrl(item.name)} target="_blank" rel="noopener noreferrer" className={`text-blue-500 hover:text-blue-400`} onClick={(e) => e.stopPropagation()}>
                                                                <IconSearchImage width="14" height="14" />
                                                            </a>
                                                        </td>
                                                        <td className="font-mono text-sm">¥{item.price.toLocaleString()}</td>
                                                        <td>
                                                            {item.location && (
                                                                <a href={item.mapUrl} target="_blank" rel="noopener noreferrer" className={`text-xs flex items-center gap-1 ${isDark ? 'text-blue-400' : 'text-blue-600'} hover:underline`} onClick={(e) => e.stopPropagation()}>
                                                                    <IconMapPin /> {item.location}
                                                                </a>
                                                            )}
                                                        </td>
                                                        <td className="w-20 text-center">
                                                            <button 
                                                                onClick={() => handleOpenAddToItinerary(item)}
                                                                disabled={!item.location}
                                                                className={`p-1.5 rounded-lg text-xs font-bold transition-colors disabled:opacity-50 ${accentBg}`}
                                                                title={item.location ? "新增到當日行程" : "地點資訊不完整"}
                                                            >
                                                                <IconSquarePlus />
                                                            </button>
                                                        </td>
                                                        <td className="w-10">
                                                            <button onClick={() => handleDeleteShoppingItem(item.id)} className={`p-1 rounded-full hover:bg-red-100/20 ${isDark ? 'text-red-400' : 'text-red-500'}`}><IconTrash /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {appData.shopping_list.length === 0 && (
                                                    <tr><td colSpan="6" className="text-center py-4 text-gray-500">清單為空。請手動新增或使用 AI 推薦。</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Tools Tab */}
                        {!isLoading && activeTab === 'tools' && (
                            <div className="animate-fadeIn space-y-4">
                                <div className={`p-4 rounded-xl border shadow-sm ${cardBg}`}>
                                    <h2 className={`font-bold mb-3 flex items-center gap-2 ${textMain}`}><IconTranslate /> 中日雙向即時翻譯</h2>
                                    <div className="relative">
                                        <textarea placeholder="輸入中文自動翻日文，或輸入日文翻中文..." rows="4" className={`w-full border rounded-lg p-3 text-sm outline-none mb-2 pr-12 ${inputBg} ${isListening ? `ring-2 ${isDark ? `ring-[${currentPalette.dark_accent}]` : `ring-[${currentPalette.main}]`}` : ''}`} value={translateText} onChange={(e) => setTranslateText(e.target.value)}></textarea>
                                        <button onClick={handleSpeechRecognition} className={`absolute bottom-4 right-3 p-2 rounded-full transition-all ${isListening ? `${isDark ? `bg-[${currentPalette.dark_accent}] text-[#111827] recording-pulse` : `bg-[${currentPalette.main}] text-white recording-pulse`}` : `${isDark ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : `${bgSub} ${textSub} hover:bg-[#DEEBAF]`}`}`} title="語音輸入 (中文)"><IconMicrophone /></button>
                                    </div>
                                    <div className="flex gap-2 mb-3">
                                        <input type="file" accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} />
                                        <button onClick={handleCameraClick} disabled={isOcrProcessing} className={`flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition ${isDark ? 'bg-gray-700 hover:bg-gray-600 text-gray-300' : `${bgSub} ${textSub} hover:bg-[#DEEBAF]`}`}>
                                            {isOcrProcessing ? <IconLoading /> : '拍照/上傳'}
                                        </button>
                                        <button onClick={() => handleAiTranslate()} disabled={isAiTranslating || !translateText} className={`flex-1 py-2 rounded-lg text-sm font-bold disabled:opacity-50 transition ${accentBg}`}>{isAiTranslating ? '翻譯中...' : '翻譯'}</button>
                                    </div>
                                    {translatedResult && <div className={`p-4 rounded-lg mb-2 text-lg font-bold text-center border ${isDark ? 'bg-[#111827] text-[#A4CA68] border-gray-700' : `bg-[${currentPalette.light_bg}] ${accentText} border-[#DEEBAF]`}`}>{translatedResult}</div>}
                                </div>
                                
                                {/* Keyword Practical Phrases Generator */}
                                <div className={`mt-6 p-4 rounded-xl border shadow-sm ${cardBg}`}>
                                    <h2 className={`font-bold mb-3 flex items-center gap-2 ${textMain}`}>💬 關鍵字情境對話 (敬語與發音輔助)</h2>
                                    <div className="flex gap-2 mb-3">
                                        <input 
                                            type="text" 
                                            value={phraseKeyword} 
                                            onChange={(e) => setPhraseKeyword(e.target.value)} 
                                            placeholder="輸入情境關鍵字 (如: 美妝, 燒肉, 車站)..." 
                                            className={`flex-1 border rounded-lg px-3 py-2 text-sm outline-none ${inputBg}`}
                                            onKeyDown={(e) => e.key === 'Enter' && handleGeneratePhrases()}
                                        />
                                        <button 
                                            onClick={handleGeneratePhrases} 
                                            disabled={isGeneratingPhrases} 
                                            className={`px-4 py-2 rounded-lg text-sm font-bold disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-2 ${isDark ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white hover:bg-purple-600'}`}
                                        >
                                            {isGeneratingPhrases ? <IconLoading /> : '生成對話'}
                                        </button>
                                    </div>
                                    
                                    {generatedPhrases.length > 0 && (
                                        <div className="space-y-2">
                                            {generatedPhrases.map((p, idx) => (
                                                <div key={idx} className={`p-3 rounded-lg border relative ${isDark ? 'bg-[#374151] border-gray-600' : 'bg-gray-50 border-gray-200'}`}>
                                                    
                                                    {/* Playback Button */}
                                                    <button 
                                                        onClick={() => speakJapanese(p.jp_clean || p.jp_html?.replace(/<[^>]*>/g, '') || '')}
                                                        className={`absolute top-3 right-3 p-1.5 rounded-full transition-colors ${isDark ? 'text-gray-300 hover:bg-gray-600' : 'text-purple-600 hover:bg-purple-100'}`}
                                                        title="播放發音"
                                                    >
                                                        <IconVolume />
                                                    </button>

                                                    <div className={`font-bold text-sm ${textMain} pr-8`}>{p.zh}</div>
                                                    {/* UPDATED: Larger font and clearer display for ruby/Kanji text */}
                                                    <div className={`text-xl mt-1 font-bold ${textMain} leading-relaxed`} dangerouslySetInnerHTML={{ __html: p.jp_html || p.jp }}></div>
                                                    {/* UPDATED: Romaji font size slightly larger and monospace for clarity */}
                                                    <div className={`text-sm mt-1 font-mono ${isDark ? 'text-purple-300' : 'text-purple-700'}`}>{p.romaji}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Safety Tab */}
                        {!isLoading && activeTab === 'safety' && (
                            <div className="animate-fadeIn space-y-4">
                                <div className={`p-5 rounded-xl border shadow-sm ${cardBg}`}>
                                    <h2 className={`text-xl font-bold mb-4 flex items-center gap-2 ${accentText}`}><IconShield /> 緊急聯絡資訊</h2>
                                    <div className="flex gap-2 mb-3">
                                        <input type="text" value={safetyRegion} onChange={(e) => setSafetyRegion(e.target.value)} placeholder="例如：東京、大阪..." className={`flex-1 border rounded-lg px-3 py-2 text-sm outline-none ${inputBg}`} onKeyDown={(e) => e.key === 'Enter' && handleAiSafetyInfo()} />
                                        <button onClick={handleAiSafetyInfo} disabled={isAiLoadingSafety} className={`px-4 py-2 rounded-lg text-sm font-bold disabled:opacity-50 transition shadow-sm flex items-center gap-2 ${isDark ? 'bg-red-700 text-white' : accentBg}`}>{isAiLoadingSafety ? <IconLoading /> : '更新'}</button>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className={`p-3 rounded-lg border text-center ${cardBg}`}><div className={`text-xs ${textSub}`}>警察局 (報案)</div><div className={`text-2xl font-bold font-mono ${accentText}`}>110</div></div>
                                            <div className={`p-3 rounded-lg border text-center ${cardBg}`}><div className={`text-xs ${textSub}`}>火警 / 救護車</div><div className={`text-2xl font-bold font-mono ${accentText}`}>119</div></div>
                                        </div>
                                        
                                        {/* FIXED LINE 1343 ERROR: Broke long JSX string into safer, multi-line structure */}
                                        <div className={`p-4 rounded-xl border ${cardBg}`}>
                                            <h3 className={`font-bold mb-2 ${isDark ? 'text-blue-400' : textMain}`}>
                                                🏢 {appData.safety.office_name}
                                            </h3>
                                            <p className={`text-sm ${textSub}`}>
                                                {appData.safety.office_address}<br/>
                                                <span className={`font-mono ${isDark ? 'text-blue-400' : accentText}`}>
                                                    {appData.safety.office_phone}
                                                </span>
                                            </p>
                                        </div>
                                        
                                        {/* Medical Support Section Added */}
                                        <div className={`p-4 rounded-xl border ${cardBg}`}>
                                            <h3 className={`font-bold mb-2 ${isDark ? 'text-emerald-400' : textMain}`}>🏥 中文醫療協助資源</h3>
                                            <ul className="space-y-4">
                                                {appData.safety.medical_support?.map((hosp, idx) => (
                                                    <li key={idx} className={`p-3 rounded-lg border ${isDark ? 'bg-[#1F2937] border-gray-600' : `bg-[${currentPalette.light_bg}] border-[#DEEBAF]`}`}>
                                                        <div className={`font-bold text-base mb-1 ${textMain}`}>{hosp.name}</div>
                                                        <div className="space-y-1 text-sm">
                                                            {hosp.desc && <div className={`text-xs mb-2 ${textSub}`}>{hosp.desc}</div>}
                                                            {hosp.phone && (
                                                                <div className="flex items-center gap-2">
                                                                    <span className={textSub}>📞</span>
                                                                    <a href={`tel:${hosp.phone}`} className={`underline decoration-dotted font-mono ${accentText}`}>{hosp.phone}</a>
                                                                </div>
                                                            )}
                                                            {hosp.address && (
                                                                <div className="flex items-start gap-2">
                                                                    <span className={textSub}>📍</span>
                                                                    <a href={generateMapUrl(hosp.address)} target="_blank" rel="noopener noreferrer" className={`flex-1 ${textMain} hover:${accentText}`}>
                                                                        {hosp.address}
                                                                    </a>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                            <div className={`mt-3 text-xs p-2 rounded ${isDark ? 'bg-[#111827] text-gray-400' : 'bg-gray-50 text-gray-400'}`}>
                                                *就醫時建議攜帶護照及保險證明。如遇語言隔閡，可使用本 App 翻譯功能或撥打保險公司急難救助電話請求口譯。
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modals are kept concise but functional */}
                    
                    {isExportModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>匯出今日行程</h3>
                                    <button onClick={() => setIsExportModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-4 flex-1 overflow-y-auto space-y-4">
                                    {exportImage ? (
                                        <div className="space-y-2">
                                            <div className="border rounded-lg overflow-hidden shadow-sm">
                                                <img src={exportImage} alt="Export Preview" className="w-full h-auto" />
                                            </div>
                                            <button onClick={handleDownloadImage} className={`w-full py-3 ${accentBg} rounded-xl font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2`}>
                                                <IconDownload /> 下載圖片
                                            </button>
                                        </div>
                                    ) : <div className={`text-center py-8 ${textSub}`}><IconLoading /> 圖片生成失敗</div>}
                                    <button onClick={handleExportHtml} className={`w-full py-3 border rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2 ${isDark ? 'border-gray-600 text-gray-300 hover:bg-gray-700' : 'border-gray-300 text-gray-600 hover:bg-gray-50'}`}><IconCode /> 下載網頁檔 (.html)</button>
                                    <div>
                                        <textarea readOnly value={exportContent} className={`w-full h-32 border rounded-lg p-3 text-sm font-mono text-xs leading-relaxed outline-none resize-none ${inputBg}`}></textarea>
                                        <button onClick={handleCopyContent} className={`mt-2 w-full py-2 border rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2 ${isDark ? 'border-gray-600 text-gray-300 hover:bg-gray-700' : 'border-gray-300 text-gray-600 hover:bg-gray-50'}`}><IconCopy /> 複製文字</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add/Edit Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>{editingItem ? '編輯行程' : '新增行程'}</h3>
                                    <button onClick={() => setIsModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                                    <div>
                                        <label className={`block text-xs font-bold mb-2 uppercase ${textSub}`}>行程類別</label>
                                        <div className={`flex p-1 rounded-lg border ${isDark ? 'bg-[#374151] border-gray-600' : 'bg-[#F4F8EB] border-[#DEEBAF]'}`}>
                                            {['activity', 'flight', 'food', 'hotel'].map(t => (
                                                <button key={t} onClick={() => setFormData({...formData, type: t})} className={`flex-1 py-2 text-xs rounded-md capitalize transition-all ${formData.type === t ? (isDark ? 'bg-gray-600 text-white shadow' : `${accentBg} shadow`) : (isDark ? 'text-gray-400' : 'text-[#5C6E38]')}`}>
                                                    {t === 'flight' ? '✈️ 航班' : (t === 'food' ? '🍴 餐飲' : (t === 'hotel' ? '🏨 住宿' : '🚩 景點'))}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="col-span-1">
                                            <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>時間</label>
                                            <input type="time" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} />
                                        </div>
                                        <div className="col-span-2">
                                            <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>預算 (JPY)</label>
                                            <div className="relative flex items-center gap-2">
                                                <span className="absolute left-3 top-2.5 text-slate-400"><IconDollar /></span>
                                                <input type="number" placeholder="0" value={formData.cost} onChange={e => setFormData({...formData, cost: e.target.value})} className={`w-full border rounded-lg p-2.5 pl-9 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none font-mono font-bold ${isDark ? `text-[${currentPalette.dark_accent}]` : textMain} ${inputBg}`} />
                                            </div>
                                        </div>
                                    </div>
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>名稱</label><input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`} /></div>
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>地點</label><input type="text" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`} /></div>
                                    
                                    {/* Weather / Temp / Duration row */}
                                    <div className="grid grid-cols-3 gap-3">
                                        <div>
                                            <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>天氣</label>
                                            <select value={formData.weather} onChange={e => setFormData({...formData, weather: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`}>
                                                {['sunny', 'cloudy', 'rainy', 'snowy'].map(w => <option key={w} value={w}>{w === 'sunny' ? '☀️ 晴' : w === 'cloudy' ? '☁️ 多雲' : w === 'rainy' ? '🌧️ 雨' : '🌨️ 雪'}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>氣溫 (°C)</label>
                                            <input type="number" placeholder="15" value={formData.temperature} onChange={e => setFormData({...formData, temperature: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`} />
                                        </div>
                                        <div>
                                            <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>預計時長</label>
                                            <input type="text" placeholder="2小時" value={formData.duration} onChange={e => setFormData({...formData, duration: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`} />
                                        </div>
                                    </div>
                                    
                                    {/* Tabelog Score Input (Conditional) */}
                                    {formData.type === 'food' && (
                                        <div>
                                            <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>Tabelog 評分 (3.00 ~ 4.50)</label>
                                            <input 
                                                type="number" 
                                                step="0.01"
                                                placeholder="3.50" 
                                                value={formData.tabelog_score} 
                                                onChange={e => setFormData({...formData, tabelog_score: e.target.value})} 
                                                className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`} 
                                            />
                                        </div>
                                    )}

                                    {/* Notes / Rainy Backup */}
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>備註</label><textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} rows="2" className={`w-full border rounded-lg p-2.5 text-sm outline-none resize-none ${inputBg}`} /></div>
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>雨天備案地點</label><input type="text" value={formData.rainy_backup} onChange={e => setFormData({...formData, rainy_backup: e.target.value})} className={`w-full border rounded-lg p-2.5 text-sm outline-none ${inputBg}`} /></div>
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    {/* NEW: 刪除按鈕只在編輯模式顯示 (3.) */}
                                    {editingItem && (
                                        <>
                                            <button
                                                onClick={handleModalDelete}
                                                className={`py-2.5 px-4 rounded-xl font-bold transition-colors text-red-500 hover:bg-red-50/50 flex items-center justify-center gap-1 flex-1 max-w-[120px] ${isDark ? 'bg-[#374151] hover:bg-red-900/40 text-red-400' : 'text-red-500 hover:bg-red-50'}`}
                                                title="刪除行程"
                                            >
                                                <IconTrash /> 刪除
                                            </button>
                                            <button 
                                                onClick={() => handleOpenCopyMoveModal(editingItem)}
                                                className={`py-2.5 px-4 rounded-xl font-bold transition-colors text-indigo-500 hover:bg-indigo-50/50 flex items-center justify-center gap-1 flex-1 max-w-[120px] ${isDark ? 'bg-[#374151] hover:bg-indigo-900/40 text-indigo-400' : 'text-indigo-500 hover:bg-indigo-50'}`}
                                                title="複製或移動到其他天"
                                            >
                                                <IconCopy width={14} height={14} /> 複製/移動
                                            </button>
                                        </>
                                    )}
                                    <button onClick={() => setIsModalOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>取消</button>
                                    <button onClick={handleSaveItem} className={`flex-1 py-2.5 text-white rounded-xl font-bold hover:shadow-lg transition-all active:scale-95 ${accentBg}`}>儲存變更</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Title Edit Modal (New) */}
                    {isTitleModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>編輯旅程名稱</h3>
                                    <button onClick={() => setIsTitleModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6">
                                    <label className={`block text-xs font-bold mb-2 uppercase ${textSub}`}>旅程名稱</label>
                                    <input
                                        type="text"
                                        placeholder="例如：九州七日遊行程"
                                        value={tempTitle}
                                        onChange={(e) => setTempTitle(e.target.value)}
                                        onKeyDown={(e) => { if (e.key === 'Enter') handleSaveTitle(); }}
                                        className={`w-full border rounded-lg p-3 text-lg outline-none ${inputBg}`}
                                        autoFocus
                                    />
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button onClick={() => setIsTitleModalOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>取消</button>
                                    <button onClick={handleSaveTitle} disabled={!tempTitle.trim()} className={`flex-1 py-2.5 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 ${accentBg}`}>儲存變更</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isBudgetModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>設定總預算</h3>
                                    <button onClick={() => setIsBudgetModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6">
                                    <label className={`block text-xs font-bold mb-2 uppercase ${textSub}`}>預算金額 (JPY)</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-slate-400"><IconDollar /></span>
                                        <input type="number" value={tempBudget} onChange={(e) => setTempBudget(e.target.value)} className={`w-full border rounded-lg p-3 pl-10 text-lg font-mono font-bold outline-none ${inputBg}`} autoFocus />
                                    </div>
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button onClick={() => setIsBudgetModalOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>取消</button>
                                    <button onClick={saveBudget} className={`flex-1 py-2.5 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 ${accentBg}`}>確認修改</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* isDaySettingsOpen */}
                    {isDaySettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>設定今日主題</h3>
                                    <button onClick={() => setIsDaySettingsOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                   <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>主題城市</label><input type="text" value={daySettingsData.themeCity} onChange={(e) => setDaySettingsData({...daySettingsData, themeCity: e.target.value})} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                   <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>預留時間</label><input type="text" value={daySettingsData.reservedTime} onChange={(e) => setDaySettingsData({...daySettingsData, reservedTime: e.target.value})} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                   <div>
                                       <div className="flex justify-between items-end mb-2">
                                           <label className={`block text-xs font-bold uppercase ${textSub}`}>城市故事 (AI)</label>
                                           <button onClick={handleAiGenerateStory} disabled={isAiGeneratingStory || !daySettingsData.themeCity} className={`text-xs px-2 py-1 rounded transition-colors ${isAiGeneratingStory || !daySettingsData.themeCity ? 'opacity-50' : (isDark ? 'bg-indigo-900 text-indigo-300' : `${bgSub} ${textSub} hover:bg-[#DEEBAF] hover:${textMain}`)}`}>{isAiGeneratingStory ? '生成中...' : '✨ 生成'}</button>
                                       </div>
                                       <textarea rows="4" value={daySettingsData.cityStory} onChange={(e) => setDaySettingsData({...daySettingsData, cityStory: e.target.value})} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none resize-none ${inputBg}`} />
                                   </div>
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button onClick={() => setIsDaySettingsOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>取消</button>
                                    <button onClick={handleSaveDaySettings} className={`flex-1 py-2.5 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 ${accentBg}`}>儲存</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {isAiPlannerOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                             <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`p-6 text-center ${isDark ? 'bg-indigo-900 text-white' : `bg-gradient-to-r from-[${currentPalette.dark}] to-[${currentPalette.main}] text-white`}`}>
                                    <div className="mx-auto bg-white/20 w-12 h-12 rounded-full flex items-center justify-center mb-3 text-2xl">✨</div>
                                    <h3 className="text-xl font-bold mb-1">AI 智慧排程</h3>
                                    <p className="text-white/80 text-sm">輸入地點與風格，自動規劃一日行程</p>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>旅遊主題城市</label><input type="text" value={aiPlannerCity} onChange={(e) => setAiPlannerCity(e.target.value)} placeholder={currentDay.themeCity || '城市名稱'} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>起始地點 (例如：博多車站)</label><input type="text" value={aiPlannerStartLocation} onChange={(e) => setAiPlannerStartLocation(e.target.value)} placeholder="當天住宿地點或交通樞紐" className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>旅遊風格</label><input type="text" value={aiPlannerStyle} onChange={(e) => setAiPlannerStyle(e.target.value)} placeholder="例如: 美食與文化體驗" className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                    <div className="flex gap-3">
                                        <div className="flex-1"><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>開始時間</label><input type="time" value={aiPlannerStartTime} onChange={(e) => setAiPlannerStartTime(e.target.value)} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                        <div className="flex-1"><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>結束時間</label><input type="time" value={aiPlannerEndTime} onChange={(e) => setAiPlannerEndTime(e.target.value)} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                    </div>
                                    <div><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>返回地點 (結束行程地)</label><input type="text" value={aiPlannerEndLocation} onChange={(e) => setAiPlannerEndLocation(e.target.value)} placeholder="回到住宿地點或機場" className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>

                                    {/* FIX 3: Add Budget Range Inputs */}
                                    <div className="flex gap-3">
                                        <div className="flex-1"><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>最低預算 (JPY)</label><input type="number" placeholder="0" value={aiPlannerMinCost} onChange={(e) => setAiPlannerMinCost(e.target.value)} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                        <div className="flex-1"><label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>最高預算 (JPY)</label><input type="number" placeholder="100000" value={aiPlannerMaxCost} onChange={(e) => setAiPlannerMaxCost(e.target.value)} className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`} /></div>
                                    </div>
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button onClick={() => setIsAiPlannerOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>取消</button>
                                    <button onClick={handleAiPlan} disabled={isAiPlanning || !aiPlannerCity || !aiPlannerStyle} className={`flex-1 py-2.5 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 disabled:opacity-70 flex items-center justify-center gap-2 ${accentBg}`}>
                                        {isAiPlanning ? <><IconLoading /> 規劃中...</> : '開始生成'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {confirmModal.isOpen && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg} p-6`}>
                                <h3 className={`text-lg font-bold ${textMain}`}>確認操作</h3>
                                <p className={`mb-6 ${textSub}`}>{confirmModal.message}</p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setConfirmModal({ isOpen: false, message: '', onConfirm: null })} 
                                        className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'bg-[#374151]' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={confirmModal.onConfirm} 
                                        className="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition-all active:scale-95"
                                    >
                                        確認
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NEW: Combined Settings Modal (Replaces old API Key Modal) */}
                    {isSettingsModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}><IconUser className="inline mr-2"/> 應用程式設定</h3>
                                    <button onClick={() => setIsSettingsModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    {/* 1. Theme Toggle */}
                                    <div>
                                        <label className={`block text-xs font-bold mb-2 uppercase ${textSub}`}>模式切換</label>
                                        <div className={`flex justify-between items-center p-2 rounded-lg border ${isDark ? 'bg-[#374151] border-gray-600' : 'bg-[#F4F8EB] border-[#DEEBAF]'}`}>
                                            <span className={`${textMain}`}>{isDark ? '🌙 深色模式' : '☀️ 淺色模式'}</span>
                                            <button onClick={handleToggleTheme} className={`p-2 rounded-full transition-all ${isDark ? 'bg-gray-600 text-yellow-300' : `${accentBg} text-white`}`}>
                                                {isDark ? <IconSun /> : <IconMoon />}
                                            </button>
                                        </div>
                                    </div>

                                    {/* 2. Color Palette Selector */}
                                    <div>
                                        <label className={`block text-xs font-bold mb-2 uppercase ${textSub}`}>主題顏色</label>
                                        <div className="flex flex-wrap gap-3">
                                            {Object.keys(PALETTES).map(key => (
                                                <button 
                                                    key={key} 
                                                    onClick={() => handleSetColorKey(key)} 
                                                    className={`p-1 rounded-full transition-all flex items-center gap-2 ${colorKey === key ? (isDark ? 'bg-gray-700' : 'bg-gray-100') : ''}`}
                                                >
                                                    <div className={`theme-selector-item ${colorKey === key ? 'active' : ''}`} style={{ backgroundColor: PALETTES[key].main, borderColor: isDark ? PALETTES[key].dark_accent : PALETTES[key].main }}></div>
                                                    <span className={`text-sm ${isDark ? 'text-gray-300' : 'text-gray-700'} whitespace-nowrap`}>{PALETTES[key].name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* 3. API Key Input (Protected) */}
                                    <div>
                                        <label className={`block text-xs font-bold mb-2 uppercase ${textSub}`}>Gemini API Key (優先使用)</label>
                                        <div className="relative">
                                            <input
                                                type={isKeyVisible ? "text" : "password"}
                                                placeholder="輸入您的 Gemini API Key"
                                                value={tempApiKey}
                                                onChange={(e) => setTempApiKey(e.target.value)}
                                                className={`w-full border rounded-lg p-3 pr-10 text-sm font-mono outline-none ${inputBg}`}
                                            />
                                            <button 
                                                onClick={() => setIsKeyVisible(!isKeyVisible)} 
                                                className={`absolute right-2 top-1/2 transform -translate-y-1/2 p-1 rounded-full ${isDark ? 'text-gray-400 hover:bg-gray-600' : 'text-gray-500 hover:bg-gray-200'}`}
                                                title={isKeyVisible ? "隱藏密鑰" : "顯示密鑰"}
                                            >
                                                <IconEyeOff />
                                            </button>
                                        </div>
                                        <p className={`mt-2 text-xs ${textSub}`}>
                                            留空則使用系統預設密鑰。<br/>
                                            <span className={userApiKey ? 'text-green-500 font-bold' : 'text-orange-500'}>目前狀態：{userApiKey ? '已覆寫系統密鑰' : '使用系統預設密鑰'}</span>
                                        </p>
                                    </div>

                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button onClick={() => setIsSettingsModalOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>關閉</button>
                                    <button onClick={handleSaveApiKey} className={`flex-1 py-2.5 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 ${accentBg}`}>儲存 Key / 清除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NEW: Add to Itinerary Modal (Shopping) */}
                    {isShoppingModalOpen && shoppingItemToAdd && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>將購物項目新增至行程</h3>
                                    <button onClick={() => setIsShoppingModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className={`p-3 rounded-lg border ${isDark ? 'bg-[#111827] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                                        <p className={`font-bold text-lg ${textMain}`}>{shoppingItemToAdd.name}</p>
                                        <p className={`text-sm ${textSub}`}>價格: ¥{shoppingItemToAdd.price.toLocaleString()}</p>
                                        <p className={`text-xs ${textSub}`}>地點: {shoppingItemToAdd.location}</p>
                                    </div>

                                    <div>
                                        <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>選擇加入哪一天</label>
                                        <select 
                                            value={shoppingDayTarget} 
                                            onChange={(e) => setShoppingDayTarget(e.target.value)} 
                                            className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`}
                                        >
                                            {appData.days.map(day => (
                                                <option key={day.id} value={day.id}>
                                                    {day.name} ({day.date}) - {day.themeCity}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <p className={`text-xs ${textSub}`}>*行程將被新增到該天末尾 (預設時間 18:00)，您可以在行程頁面修改。</p>
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button onClick={() => setIsShoppingModalOpen(false)} className={`flex-1 py-2.5 rounded-xl font-bold transition-colors ${isDark ? 'text-gray-400 hover:bg-[#374151]' : 'text-slate-500 hover:bg-slate-50'}`}>取消</button>
                                    <button onClick={handleSaveShoppingToItinerary} className={`flex-1 py-2.5 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 ${accentBg}`}>確認新增</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* NEW: Copy/Move Modal */}
                    {isCopyMoveModalOpen && itemToCopy && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                            <div className={`rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-slideUp ${modalBg}`}>
                                <div className={`px-6 py-4 border-b flex justify-between items-center ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <h3 className={`text-lg font-bold ${textMain}`}>複製 / 移動行程</h3>
                                    <button onClick={() => setIsCopyMoveModalOpen(false)} className={`${isDark ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><IconX /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className={`p-3 rounded-lg border ${isDark ? 'bg-[#111827] border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                                        <p className={`font-bold text-lg ${textMain}`}>移動/複製：{itemToCopy.title}</p>
                                        <p className={`text-sm ${textSub}`}>目前於：{appData.days.find(d => d.id === itemToCopy.dayId)?.name}</p>
                                    </div>
                                    
                                    <div>
                                        <label className={`block text-xs font-bold mb-1 uppercase ${textSub}`}>選擇目標日期</label>
                                        <select 
                                            value={targetDayId} 
                                            onChange={(e) => setTargetDayId(Number(e.target.value))} 
                                            className={`w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-[${currentPalette.main}] outline-none ${inputBg}`}
                                        >
                                            {appData.days.map(day => (
                                                <option key={day.id} value={day.id}>
                                                    {day.name} ({day.date}) - {day.themeCity}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className={`p-4 border-t flex gap-3 ${isDark ? 'border-gray-600' : 'border-slate-100'}`}>
                                    <button 
                                        onClick={() => handleExecuteCopyMove(false)} 
                                        className={`flex-1 py-2.5 text-white rounded-xl font-bold transition-all ${accentBg}`}
                                    >
                                        複製 (Copy)
                                    </button>
                                    <button 
                                        onClick={() => handleExecuteCopyMove(true)} 
                                        disabled={targetDayId === itemToCopy.dayId}
                                        className={`flex-1 py-2.5 rounded-xl font-bold transition-colors disabled:opacity-50 ${isDark ? 'bg-indigo-700 text-white hover:bg-indigo-600' : 'bg-indigo-400 text-white hover:bg-indigo-500'}`}
                                        title={targetDayId === itemToCopy.dayId ? '無法移動到同一天' : '移動到其他天'}
                                    >
                                        移動 (Move)
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>